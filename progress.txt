# Ralph Progress Log
Started: Mon Feb 16 2026

## Codebase Patterns
- UV workspace monorepo: 13 packages under `packages/`, root pyproject.toml has NO build-system
- Namespace packages: `orbiter-core/__init__.py` uses `pkgutil.extend_path()` so other packages add to the `orbiter` namespace
- Quality checks: `uv run ruff check packages/`, `uv run ruff format --check packages/`, `uv run pyright packages/orbiter-core/`, `uv run pytest`
- Test file names must be unique across all packages (pytest collects `tests/` from multiple packages into one `tests` module)
- pytest-asyncio `asyncio_mode = "auto"` configured in root pyproject.toml
- Use `StrEnum` (not `str, Enum`) for string enums — ruff UP042 enforces this
- pyright ignore comments: put `# pyright: ignore[reportMissingImports]` on the import line itself
- Use test prefix `test_obs_*.py` for orbiter-observability to avoid collision with orbiter-core test names
- OTel optional imports: use `try/except ImportError` pattern with `HAS_OTEL` flag
- OTel `trace.set_tracer_provider()` can only be called once — in tests, reset internal state before each test
- OTel metrics instruments created at module level bind to the no-op provider — create instruments inside recording functions
- Ruff B039: `ContextVar` default cannot be mutable — use `default=None` with `T | None` type
- `@asynccontextmanager` returns single-use CMs — when mocking, use `side_effect=lambda: factory()` not `return_value=cm`
- Don't use `# noqa: PLW0603` or `# noqa: S101` — those rules aren't enabled in ruff config (ruff RUF100 catches unused noqa)
- hatchling requires a README.md in each package directory (build fails without it)
- Ruff UP017: use `datetime.UTC` alias, not `datetime.timezone.utc`
---

## 2026-02-16 - US-001
- Created orbiter-observability package scaffold under packages/orbiter-observability/
- ObservabilityConfig pydantic model with log_level, log_format, trace_enabled, trace_backend, trace_endpoint, service_name, sample_rate, metrics_enabled, namespace
- TraceBackend StrEnum (otlp/memory/console)
- configure() function with idempotency, force=True, kwargs support
- get_config() and reset() helper functions
- 14 tests covering config validation, configure idempotency, kwargs override, frozen model, bounds
- Files changed: pyproject.toml (root), packages/orbiter-observability/{pyproject.toml, README.md, src/orbiter/observability/__init__.py, src/orbiter/observability/config.py, tests/test_obs_config.py}
- **Learnings for future iterations:**
  - hatchling requires README.md in each package dir — add it early
  - Ruff linting catches unused noqa directives — don't add PLW0603/S101 suppressions since those rules aren't enabled
  - ObservabilityConfig follows same frozen=True pattern as TraceConfig
---

## 2026-02-16 - US-002
- Implemented structured logging module at `packages/orbiter-observability/src/orbiter/observability/logging.py` (~170 lines)
- TextFormatter: compact single-line ANSI output ported from orbiter.log._Formatter, enhanced with LogContext support
- JsonFormatter: structured {timestamp, level, logger, message, extra} JSON output for production
- get_logger(name) with auto "orbiter." namespace prefixing
- configure_logging(level, fmt, force) with idempotency, text/json format selection
- LogContext context manager using contextvars for async-safe structured bindings
- reset_logging() for test cleanup
- 33 tests covering both formatters, namespace auto-prefixing, idempotency, LogContext binding/nesting/override
- Files changed: packages/orbiter-observability/src/orbiter/observability/logging.py, packages/orbiter-observability/tests/test_obs_logging.py
- **Learnings for future iterations:**
  - Ruff UP017: use `datetime.UTC` alias instead of `datetime.timezone.utc`
  - ContextVar with `default=None` and `T | None` type is the right pattern (confirmed from Codebase Patterns)
  - LogContext nesting works by merging parent context into child — child overrides take precedence
  - Text/JSON formatter tests should set `_log_context` directly for unit testing (no need to use LogContext CM in formatter tests)
---

## 2026-02-16 - US-003
- Created semantic conventions module at `packages/orbiter-observability/src/orbiter/observability/semconv.py` (~85 lines)
- Ported all constants from `packages/orbiter-trace/src/orbiter/trace/config.py` (lines 87-151)
- GenAI conventions: 18 constants (gen_ai.system, gen_ai.request.*, gen_ai.usage.*, etc.)
- Agent conventions: 7 constants (orbiter.agent.{id,name,type,model,step,max_steps,run.success})
- Tool conventions: 7 constants (orbiter.tool.{name,call_id,arguments,result,error,duration,step.success})
- Task/session/user: 5 constants (orbiter.task.id, orbiter.session.id, etc.)
- Cost conventions (new): 3 constants (orbiter.cost.{input_tokens,output_tokens,total_usd})
- Span name prefixes: 4 constants (agent., tool., llm., task.)
- 24 tests covering: strings check, no duplicates, naming pattern validation, completeness, exact value parity
- Files changed: packages/orbiter-observability/src/orbiter/observability/semconv.py, packages/orbiter-observability/tests/test_obs_semconv.py
- **Learnings for future iterations:**
  - Pure-data modules (constants only) are the simplest to implement — no dependencies, no logic
  - Test pattern for convention modules: check types, no dupes, naming patterns, group completeness, exact values
  - semconv.py has zero imports (except `__future__` annotations) — keeps it dependency-free
---

## 2026-02-16 - US-004
- Implemented distributed tracing module at `packages/orbiter-observability/src/orbiter/observability/tracing.py` (~280 lines)
- Ported from `packages/orbiter-trace/src/orbiter/trace/decorator.py` with key enhancement: optional OTel support
- `HAS_OTEL` flag via `try/except ImportError` pattern — when OTel absent, everything is no-op
- `NullSpan` stub class: `set_attribute()`, `record_exception()`, `set_status()` all no-ops, works as context manager
- `span()` sync context manager and `aspan()` async context manager — yield real OTel spans or NullSpan
- `@traced` decorator: supports sync, async, sync generators, async generators — passthrough when no OTel
- `extract_metadata()`: qualname, module, lineno, filepath, parameters extraction from callables
- `is_user_code()` / `get_user_frame()`: user-code frame filtering for call stack analysis
- `extract_args=True` option records call arguments as span attributes
- Exception recording on spans (record_exception)
- 50 tests covering: NullSpan, is_user_code, get_user_frame, extract_metadata, span/aspan with and without OTel, @traced for all 4 function types with and without OTel, edge cases (nested, list flattening, custom name+attrs)
- Files changed: packages/orbiter-observability/src/orbiter/observability/tracing.py, packages/orbiter-observability/tests/test_obs_tracing.py
- **Learnings for future iterations:**
  - Pyright requires `_otel_trace` to be narrowed from `None | module` — use a `_get_tracer()` helper with `assert _otel_trace is not None`
  - When `HAS_OTEL` is False, `@traced` returns the original function directly (no wrapper overhead)
  - OTel test fixture must reset `trace._TRACER_PROVIDER_SET_ONCE._done = False` and `trace._TRACER_PROVIDER = None` before each test
  - Use `unittest.mock.patch("orbiter.observability.tracing.HAS_OTEL", False)` to test no-OTel path
  - Ruff SIM117: combine nested `with` statements into single `with` using comma syntax
---
