# Ralph Progress Log
Started: Mon Feb 16 2026

## Codebase Patterns
- UV workspace monorepo: 13 packages under `packages/`, root pyproject.toml has NO build-system
- Namespace packages: `orbiter-core/__init__.py` uses `pkgutil.extend_path()` so other packages add to the `orbiter` namespace
- Quality checks: `uv run ruff check packages/`, `uv run ruff format --check packages/`, `uv run pyright packages/orbiter-core/`, `uv run pytest`
- Test file names must be unique across all packages (pytest collects `tests/` from multiple packages into one `tests` module)
- pytest-asyncio `asyncio_mode = "auto"` configured in root pyproject.toml
- Use `StrEnum` (not `str, Enum`) for string enums — ruff UP042 enforces this
- pyright ignore comments: put `# pyright: ignore[reportMissingImports]` on the import line itself
- Use test prefix `test_obs_*.py` for orbiter-observability to avoid collision with orbiter-core test names
- OTel optional imports: use `try/except ImportError` pattern with `HAS_OTEL` flag
- OTel `trace.set_tracer_provider()` can only be called once — in tests, reset internal state before each test
- OTel metrics instruments created at module level bind to the no-op provider — create instruments inside recording functions
- Cross-namespace-package imports within same package (e.g., metrics.py → semconv.py) also need `# pyright: ignore[reportMissingImports]`
- Ruff B039: `ContextVar` default cannot be mutable — use `default=None` with `T | None` type
- `@asynccontextmanager` returns single-use CMs — when mocking, use `side_effect=lambda: factory()` not `return_value=cm`
- Don't use `# noqa: PLW0603` or `# noqa: S101` — those rules aren't enabled in ruff config (ruff RUF100 catches unused noqa)
- RUF006: `loop.create_task()` must store return value — use `set.add(task)` + `task.add_done_callback(set.discard)`
- hatchling requires a README.md in each package directory (build fails without it)
- Ruff UP017: use `datetime.UTC` alias, not `datetime.timezone.utc`
---

## 2026-02-16 - US-001
- Created orbiter-observability package scaffold under packages/orbiter-observability/
- ObservabilityConfig pydantic model with log_level, log_format, trace_enabled, trace_backend, trace_endpoint, service_name, sample_rate, metrics_enabled, namespace
- TraceBackend StrEnum (otlp/memory/console)
- configure() function with idempotency, force=True, kwargs support
- get_config() and reset() helper functions
- 14 tests covering config validation, configure idempotency, kwargs override, frozen model, bounds
- Files changed: pyproject.toml (root), packages/orbiter-observability/{pyproject.toml, README.md, src/orbiter/observability/__init__.py, src/orbiter/observability/config.py, tests/test_obs_config.py}
- **Learnings for future iterations:**
  - hatchling requires README.md in each package dir — add it early
  - Ruff linting catches unused noqa directives — don't add PLW0603/S101 suppressions since those rules aren't enabled
  - ObservabilityConfig follows same frozen=True pattern as TraceConfig
---

## 2026-02-16 - US-002
- Implemented structured logging module at `packages/orbiter-observability/src/orbiter/observability/logging.py` (~170 lines)
- TextFormatter: compact single-line ANSI output ported from orbiter.log._Formatter, enhanced with LogContext support
- JsonFormatter: structured {timestamp, level, logger, message, extra} JSON output for production
- get_logger(name) with auto "orbiter." namespace prefixing
- configure_logging(level, fmt, force) with idempotency, text/json format selection
- LogContext context manager using contextvars for async-safe structured bindings
- reset_logging() for test cleanup
- 33 tests covering both formatters, namespace auto-prefixing, idempotency, LogContext binding/nesting/override
- Files changed: packages/orbiter-observability/src/orbiter/observability/logging.py, packages/orbiter-observability/tests/test_obs_logging.py
- **Learnings for future iterations:**
  - Ruff UP017: use `datetime.UTC` alias instead of `datetime.timezone.utc`
  - ContextVar with `default=None` and `T | None` type is the right pattern (confirmed from Codebase Patterns)
  - LogContext nesting works by merging parent context into child — child overrides take precedence
  - Text/JSON formatter tests should set `_log_context` directly for unit testing (no need to use LogContext CM in formatter tests)
---

## 2026-02-16 - US-003
- Created semantic conventions module at `packages/orbiter-observability/src/orbiter/observability/semconv.py` (~85 lines)
- Ported all constants from `packages/orbiter-trace/src/orbiter/trace/config.py` (lines 87-151)
- GenAI conventions: 18 constants (gen_ai.system, gen_ai.request.*, gen_ai.usage.*, etc.)
- Agent conventions: 7 constants (orbiter.agent.{id,name,type,model,step,max_steps,run.success})
- Tool conventions: 7 constants (orbiter.tool.{name,call_id,arguments,result,error,duration,step.success})
- Task/session/user: 5 constants (orbiter.task.id, orbiter.session.id, etc.)
- Cost conventions (new): 3 constants (orbiter.cost.{input_tokens,output_tokens,total_usd})
- Span name prefixes: 4 constants (agent., tool., llm., task.)
- 24 tests covering: strings check, no duplicates, naming pattern validation, completeness, exact value parity
- Files changed: packages/orbiter-observability/src/orbiter/observability/semconv.py, packages/orbiter-observability/tests/test_obs_semconv.py
- **Learnings for future iterations:**
  - Pure-data modules (constants only) are the simplest to implement — no dependencies, no logic
  - Test pattern for convention modules: check types, no dupes, naming patterns, group completeness, exact values
  - semconv.py has zero imports (except `__future__` annotations) — keeps it dependency-free
---

## 2026-02-16 - US-004
- Implemented distributed tracing module at `packages/orbiter-observability/src/orbiter/observability/tracing.py` (~280 lines)
- Ported from `packages/orbiter-trace/src/orbiter/trace/decorator.py` with key enhancement: optional OTel support
- `HAS_OTEL` flag via `try/except ImportError` pattern — when OTel absent, everything is no-op
- `NullSpan` stub class: `set_attribute()`, `record_exception()`, `set_status()` all no-ops, works as context manager
- `span()` sync context manager and `aspan()` async context manager — yield real OTel spans or NullSpan
- `@traced` decorator: supports sync, async, sync generators, async generators — passthrough when no OTel
- `extract_metadata()`: qualname, module, lineno, filepath, parameters extraction from callables
- `is_user_code()` / `get_user_frame()`: user-code frame filtering for call stack analysis
- `extract_args=True` option records call arguments as span attributes
- Exception recording on spans (record_exception)
- 50 tests covering: NullSpan, is_user_code, get_user_frame, extract_metadata, span/aspan with and without OTel, @traced for all 4 function types with and without OTel, edge cases (nested, list flattening, custom name+attrs)
- Files changed: packages/orbiter-observability/src/orbiter/observability/tracing.py, packages/orbiter-observability/tests/test_obs_tracing.py
- **Learnings for future iterations:**
  - Pyright requires `_otel_trace` to be narrowed from `None | module` — use a `_get_tracer()` helper with `assert _otel_trace is not None`
  - When `HAS_OTEL` is False, `@traced` returns the original function directly (no wrapper overhead)
  - OTel test fixture must reset `trace._TRACER_PROVIDER_SET_ONCE._done = False` and `trace._TRACER_PROVIDER = None` before each test
  - Use `unittest.mock.patch("orbiter.observability.tracing.HAS_OTEL", False)` to test no-OTel path
  - Ruff SIM117: combine nested `with` statements into single `with` using comma syntax
---

## 2026-02-16 - US-005
- Implemented metrics collection module at `packages/orbiter-observability/src/orbiter/observability/metrics.py` (~270 lines)
- Ported from `packages/orbiter-trace/src/orbiter/trace/instrumentation.py` with key enhancement: in-memory fallback when OTel absent
- `MetricsCollector` class: thread-safe in-memory storage for counters, histograms, gauges with `get_snapshot()` and `reset()`
- `HAS_OTEL` flag via `try/except ImportError` — when OTel is absent, all metrics go to `MetricsCollector`
- Instrument factories: `create_counter()`, `create_histogram()`, `create_gauge()` (OTel path)
- Attribute builders: `build_agent_attributes()`, `build_tool_attributes()` using semconv constants
- Recording helpers: `record_agent_run()` and `record_tool_step()` with dual OTel/in-memory paths
- `Timer` class with `start()`/`stop()`/`elapsed` + context manager support (`__enter__`/`__exit__`)
- `timer()` context manager function for convenience
- `get_metrics_snapshot()` and `reset_metrics()` global helpers
- 51 tests covering: metric name constants, MetricsCollector (add/record/set/reset/snapshot/singleton/thread-safety), attribute builders, in-memory recording (agent runs, tool steps, tokens, success/failure), OTel recording, instrument factories, Timer (basic/CM/function), integration (full flow, multiple recordings, reset)
- Files changed: packages/orbiter-observability/src/orbiter/observability/metrics.py, packages/orbiter-observability/tests/test_obs_metrics.py
- **Learnings for future iterations:**
  - Cross-namespace-package imports within orbiter-observability also need `# pyright: ignore[reportMissingImports]` (e.g., metrics.py importing from semconv.py)
  - OTel MeterProvider reset pattern: `metrics._internal._METER_PROVIDER_SET_ONCE._done = False` and `metrics._internal._METER_PROVIDER = None`
  - `unittest.mock.patch("orbiter.observability.metrics.HAS_OTEL", False)` to test in-memory path even when OTel is installed
  - Timer context manager (`with Timer() as t:`) is more ergonomic than manual start()/stop() for typical use
---

## 2026-02-16 - US-006
- Ported prompt execution logger from `packages/orbiter-trace/src/orbiter/trace/prompt_logger.py` to `packages/orbiter-observability/src/orbiter/observability/prompt_logger.py`
- Key change: uses `orbiter.observability.logging.get_logger("prompt")` instead of stdlib `logging.getLogger("orbiter.trace.prompt")`
- `estimate_tokens()` — heuristic char-to-token counting
- `TokenBreakdown` — frozen dataclass with per-role counts and percentage calculations
- `compute_token_breakdown()` — handles plain text, multi-modal (text/image_url/tool_use), and tool_calls
- `ExecutionLogEntry` — structured record with `format_summary()` for human-readable output
- `PromptLogger` — accepts OpenAI-style messages, computes breakdown, logs structured entry
- 35 tests covering: estimate_tokens, TokenBreakdown (total/percentages/frozen), compute_token_breakdown (all roles/tool_calls/none), multi-modal content, ExecutionLogEntry formatting, PromptLogger (init/log_execution/emits_log/custom_level/tools/empty), integration (full flow/multimodal/percentage sum)
- Files changed: packages/orbiter-observability/src/orbiter/observability/prompt_logger.py, packages/orbiter-observability/tests/test_obs_prompt_logger.py
- **Learnings for future iterations:**
  - Direct port modules need minimal changes — mainly update import paths and logger namespaces
  - Logger name updated from `orbiter.trace.prompt` to `orbiter.prompt` (via `get_logger("prompt")` auto-prefix)
  - caplog tests must use updated logger name (`orbiter.prompt` not `orbiter.trace.prompt`)
---

## 2026-02-16 - US-007
- Ported W3C Baggage propagation and span consumer system from `packages/orbiter-trace/src/orbiter/trace/propagation.py` to `packages/orbiter-observability/src/orbiter/observability/propagation.py` (~239 lines)
- `Carrier` protocol + `DictCarrier` implementation for header containers
- `BaggagePropagator` — W3C Baggage extract/inject with URL-encoding, size limits (RFC 9110)
- Baggage context functions: `set_baggage()`, `get_baggage()`, `get_baggage_value()`, `clear_baggage()` via `contextvars.ContextVar`
- `SpanConsumer` ABC with `register_span_consumer()` (direct + decorator), `dispatch_spans()`, `list_span_consumers()`, `clear_span_consumers()`, `get_span_consumer()`
- 52 tests covering: DictCarrier, baggage context (set/get/clear/copy), extract (single/multiple/URL-encoded/empty/whitespace/oversized/max-pairs/no-equals), inject (single/multiple/URL-encoded/empty/from-context/oversized), roundtrip (basic/special-chars), SpanConsumer ABC, consumer registration (direct/decorator/overwrite/clear), dispatch (single/multiple/empty/none), constants
- Files changed: packages/orbiter-observability/src/orbiter/observability/propagation.py, packages/orbiter-observability/tests/test_obs_propagation.py
- **Learnings for future iterations:**
  - Pure stdlib modules (no OTel) port cleanly with zero changes to logic — only import paths change
  - This module has no cross-namespace dependencies — it's self-contained with only stdlib imports
  - The `register_span_consumer` dual-use (direct call + decorator) pattern is worth preserving for future registry APIs
---

## 2026-02-16 - US-008
- Implemented health check system at `packages/orbiter-observability/src/orbiter/observability/health.py` (~210 lines)
- New module — no existing code to port, designed from scratch
- `HealthStatus` enum: HEALTHY, DEGRADED, UNHEALTHY
- `HealthResult` frozen dataclass with `to_dict()` for JSON-serializable output
- `HealthCheck` runtime-checkable Protocol: `name` property + `check()` method
- Built-in checks: `MemoryUsageCheck` (RSS threshold via `resource.getrusage`), `EventLoopCheck` (asyncio loop lag threshold)
- `HealthRegistry`: register/unregister, run/run_all, aggregate_status (worst-of), list_checks, clear
- Aggregate logic: UNHEALTHY if any check UNHEALTHY, DEGRADED if any DEGRADED, else HEALTHY
- Module-level convenience: `get_registry()`, `get_health_summary()` (JSON-serializable report), `reset()`
- 38 tests covering: HealthStatus values, HealthResult (creation/metadata/frozen/to_dict/utc), protocol compliance, MemoryUsageCheck (healthy/unhealthy/degraded with mocked thresholds), EventLoopCheck (no loop/with loop/custom threshold), HealthRegistry (register/unregister/run/run_all/clear/overwrite), aggregate status (all healthy/degraded/unhealthy/empty/explicit results), module functions (singleton/summary/reset/serializable)
- Files changed: packages/orbiter-observability/src/orbiter/observability/health.py, packages/orbiter-observability/tests/test_obs_health.py, prd.json
- **Learnings for future iterations:**
  - `resource.getrusage(RUSAGE_SELF).ru_maxrss` returns KB on Linux — divide by 1024 for MB
  - `runtime_checkable` Protocol allows `isinstance()` checks at runtime — useful for protocol conformance tests
  - MemoryUsageCheck uses 80% threshold for DEGRADED status as an early warning
  - `asyncio.get_running_loop()` raises `RuntimeError` when no loop running — handle gracefully
  - Aggregate status pattern: `max(results, key=lambda r: priority[r.status])` is clean for worst-of logic
---

## 2026-02-16 - US-009
- Implemented alerting hooks module at `packages/orbiter-observability/src/orbiter/observability/alerts.py` (~170 lines)
- New module — no existing code to port, designed from scratch
- `AlertSeverity` enum: INFO, WARNING, CRITICAL
- `Comparator` enum: GT, LT, GTE, LTE, EQ with corresponding lambda functions in `_COMPARATORS` dict
- `AlertRule` frozen dataclass: name, metric_name, threshold, comparator, severity, cooldown_seconds (default 300)
- `Alert` frozen dataclass: rule_name, metric_value, threshold, severity, timestamp (UTC), metadata
- `AlertManager`: register/unregister rules, register callbacks, evaluate(metric_name, value) with cooldown enforcement
- Cooldown via `time.monotonic()` per-rule tracking in `_last_fired` dict
- Both sync and async callback support via `inspect.iscoroutinefunction()` check
- Async callbacks: scheduled via `loop.create_task()` when event loop running, `asyncio.run()` otherwise
- Background task reference set prevents GC of fire-and-forget async tasks (RUF006 compliance)
- Module-level convenience: `get_manager()`, `reset()`
- 43 tests covering: AlertSeverity values, Comparator values, AlertRule (creation/custom/frozen), Alert (creation/metadata/frozen/utc), rule management (register/unregister/overwrite/clear), all 5 comparators, evaluation (no match/not breached/breached/severity/multiple rules), cooldown (prevents refiring/expiry/zero/per-rule/unregister clears), callbacks (sync/multiple/not invoked/cooldown/async/clear/correct alert), clear all, module functions (singleton/reset/full flow)
- Files changed: packages/orbiter-observability/src/orbiter/observability/alerts.py, packages/orbiter-observability/tests/test_obs_alerts.py, prd.json
- **Learnings for future iterations:**
  - RUF006: `loop.create_task()` return value must be stored — use a `set()` with `add_done_callback(set.discard)` pattern
  - `_invoke_callback` needs access to task set — make it a method on the manager class, not a standalone function
  - `time.monotonic()` for cooldown is clean — initial `_last_fired` value of 0.0 means first evaluation always passes cooldown
  - `cooldown_seconds=0` in tests is essential to allow repeated evaluations without waiting
---
