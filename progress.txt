## Codebase Patterns
- SQLiteMemoryStore: import from `orbiter.memory.backends.sqlite`, needs `await store.init()` before use
- `agent.run()` returns `AgentOutput(text, tool_calls, usage)` — NO `output` field; for structured output, use `parse_structured_output(result.text, MyModel)` from `orbiter._internal.output_parser`
- `output_type` on Agent is stored but NOT auto-applied; instruct LLM to return JSON in system prompt and parse manually
- Agent memory persistence: pass `memory=SQLiteMemoryStore(db_path=...)` directly (not AgentMemory) for simple per-store persistence; agent_id and task_id are auto-set; user_id is NOT auto-set
- For memory history reload: second agent MUST have same `name` as first agent AND same `conversation_id` for `load_history()` to find prior messages
- `MemoryMetadata(user_id=...)` scoping works in SQLiteMemoryStore via `json_extract(metadata, '$.user_id')`
- ChromaVectorMemoryStore: import from `orbiter.memory.backends.vector`, takes EmbeddingProvider, optional `path` for persistence
- SentenceTransformerEmbeddingProvider: local embeddings, no API key needed, import from `orbiter.memory.backends.vector`
- mcp_server decorator: import from `orbiter.mcp`, adds `run()` and `stop()` methods dynamically (type: ignore needed for pyright)
- MCPServerConfig stdio transport: `command=sys.executable, args=[script_path]` — client spawns subprocess per connection
- pyproject.toml testpaths uses glob pattern `"packages/*/tests"` for package tests
- `asyncio_mode = "auto"` in pytest config means all async test/fixture functions auto-detected
- Integration test branch: `ralph/orbiter-integration-tests`

---

# Ralph Progress Log
Started: Fri Feb 20 03:26:33 AM IST 2026
---

## 2026-02-20 - US-INT-001
- What was implemented: Full integration test infrastructure setup
- Files changed:
  - `tests/__init__.py` (new, empty)
  - `tests/integration/__init__.py` (new, empty)
  - `tests/integration/conftest.py` (new, all 8 fixtures)
  - `tests/integration/helpers/__init__.py` (new, empty)
  - `tests/integration/helpers/mcp_test_server.py` (new, @mcp_server class with get_capital + get_population)
  - `tests/integration/helpers/web_app.py` (new, minimal FastAPI app with /health)
  - `pyproject.toml` (updated testpaths, markers, added pytest-timeout/tenacity/docker/httpx/chromadb/sentence-transformers)
  - `uv.lock` (updated)
- **Learnings for future iterations:**
  - The orbiter-server app (`orbiter_server.app`) has NO `/health` endpoint — a separate `web_app.py` helper was created for uvicorn_server fixture
  - `pytest --collect-only` exits code 5 when no tests collected; that's expected for a new empty test directory
  - Lazy imports (inside fixture bodies) are the right pattern for optional heavy dependencies (chromadb, sentence-transformers)
  - `@mcp_server()` decorator adds `.run()` dynamically — pyright needs `# type: ignore[attr-defined]` at call site
  - `contextlib.suppress(FileNotFoundError)` preferred over try/except/pass (ruff SIM105)
  - After running `uv lock`, need `uv sync --dev` to install packages in the venv
  - Package runs via `uv run` use Python 3.11 venv, not system Python 3.14
---

## 2026-02-20 - US-INT-002
- What was implemented: Agent + memory persistence seam tests
- Files changed:
  - `tests/integration/test_agent_memory.py` (new)
- **Learnings for future iterations:**
  - `agent.run()` returns `AgentOutput` with `text`, `tool_calls`, `usage` — no `output` field for structured Pydantic models
  - For structured output from LLM, instruct in system prompt to return JSON and parse with `parse_structured_output(result.text, Model)` from `orbiter._internal.output_parser`
  - Two agents sharing a SQLiteMemoryStore with same `name` and `conversation_id` will load each other's history via `load_history()` in `MemoryPersistence`
  - `MemoryMetadata(user_id=...)` scoping works correctly in SQLiteMemoryStore; querying by user_id only returns items with that user_id
  - `test_memory_metadata_scoping` tests SQLiteMemoryStore metadata isolation directly (no LLM needed)
---
