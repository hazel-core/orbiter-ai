# Ralph Progress Log
Started: Thu Feb 19 11:52:28 PM IST 2026
---

## 2026-02-20 - US-019
- Added `add_usage(agent_id, usage)` method to `TokenTracker` in `orbiter-context/token_tracker.py` — accepts any object with `input_tokens`/`output_tokens` attributes (duck typing; works with `orbiter.types.Usage`)
- Added `_get_context_window_tokens(model_name)` helper to `agent.py` — looks up `MODEL_CONTEXT_WINDOWS` from orbiter-models (returns None if not installed/unknown)
- Added `_update_system_token_info(msg_list, used, total)` helper to `agent.py` — inserts/replaces `[Context: {used}/{total} tokens ({pct}% full)]` in the first SystemMessage (or inserts a new SystemMessage if none exists); idempotent (strips prior tag before adding new one)
- Added `force_summarize: bool = False` keyword parameter to `_apply_context_windowing()` — when True, bypasses `check_trigger()` and uses `keep_recent=max(2, msg_count//2)` for tighter compression; condition: `msg_count >= summary_threshold or (force_summarize and msg_count >= 2)`
- Wired token tracking into `Agent.run()` loop:
  - Initializes `_token_tracker` (TokenTracker) and `_context_window_tokens` before the loop (when `context is not None`)
  - At start of each step: calls `_update_system_token_info()` with last step's `prompt_tokens` (input_tokens from last call) if tracker has data
  - After `_call_llm()`: calls `_token_tracker.add_usage(self.name, output.usage)` when `total_tokens > 0`
  - After appending tool results: checks fill ratio `input_tokens / context_window_tokens > token_budget_trigger` → calls `_apply_context_windowing(..., force_summarize=True)` for next iteration
- Wired same token tracking into `runner.py _stream()` loop (uses local `_stream_token_tracker`, `_stream_context_window`, and `_update_system_token_info` imported from `orbiter.agent`)
- Added `TestTokenTrackerAddUsage` (4 tests) to `test_token_tracker.py`
- Added `TestTokenTrackingHelpers` (5 tests) and `TestTokenTrackingIntegration` (3 tests) to `test_context_integration.py`
- All 1304 orbiter-core + orbiter-context tests pass; only pre-existing pyright error at agent.py:831 (MCPToolWrapper.to_dict) unrelated to changes
- Files changed:
  - packages/orbiter-context/src/orbiter/context/token_tracker.py (added Any import, add_usage())
  - packages/orbiter-core/src/orbiter/agent.py (added _get_context_window_tokens, _update_system_token_info, force_summarize to _apply_context_windowing, token tracking in run() loop)
  - packages/orbiter-core/src/orbiter/runner.py (token tracking in _stream() loop)
  - packages/orbiter-context/tests/test_token_tracker.py (TestTokenTrackerAddUsage)
  - packages/orbiter-context/tests/test_context_integration.py (TestTokenTrackingHelpers, TestTokenTrackingIntegration)
- **Learnings for future iterations:**
  - `_get_context_window_tokens()` and `_update_system_token_info()` are in `agent.py` — import them lazily in `runner.py` inside the token-tracking init block to avoid circular imports
  - `force_summarize=True` must ALSO bypass `check_trigger()` (not just enter the elif block) — use a `should_summarize` variable: `should_summarize = force_summarize or check_trigger(...).triggered`
  - When `force_summarize=True`, use `keep_recent=max(2, msg_count//2)` (not `summary_threshold//2`) to ensure meaningful compression even with few messages
  - The `_ProviderSummarizer.summarize()` calls `provider.complete()` — in tests, this counts as an extra mock call BETWEEN the tool-call LLM step and the final step; use `all_call_args[-1]` to get the final LLM call's messages
  - `SystemMessage` objects are frozen Pydantic models — replacement requires `list(msg_list)` copy + index replacement (not in-place mutation)
---

## 2026-02-20 - US-017
- Added `_ProviderSummarizer` class to `agent.py` — wraps a model provider with `async summarize(prompt) -> str` for use with orbiter-memory's `generate_summary()`
- Added `_apply_context_windowing(msg_list, context, provider)` helper to `agent.py`:
  - Separates SystemMessage(s) from non-system messages
  - Step 1: when msg_count > offload_threshold, aggressively trims to summary_threshold messages
  - Step 2: when msg_count >= summary_threshold, converts messages to MemoryItems, calls `check_trigger()` + `generate_summary()` from orbiter-memory, replaces old messages with a summary SystemMessage + recent messages tail
  - Step 3: applies history_rounds windowing (keeps last history_rounds non-system messages)
  - Falls back gracefully when orbiter-memory is not installed (ImportError silently skips summarization)
- Wired `_apply_context_windowing()` into `Agent.run()` after `build_messages()` call (when `self.context is not None`)
- Wired `_apply_context_windowing()` into `runner.py _stream()` via lazy `from orbiter.agent import _apply_context_windowing` (same pattern as existing AgentError lazy import)
- Verified US-015 already handles all persistence (HumanMemory pre-run, AIMemory/ToolMemory via POST_LLM_CALL/POST_TOOL_CALL hooks) — no additional persistence added (no double-persist)
- Added `TestAgentContextWindowing` class (6 tests) to `test_context_integration.py`:
  - `test_windowing_trims_old_messages`: 20 history messages → trimmed to history_rounds=3
  - `test_windowing_does_not_trim_when_within_limit`: 4 history + 1 input = 5 messages preserved when within history_rounds=20
  - `test_no_windowing_when_context_none`: context=None → all 31 messages passed through
  - `test_summarization_triggered_when_threshold_hit`: summary_threshold=5, 10 messages → summarization fires
  - `test_offload_threshold_triggers_aggressive_trim`: 20 messages > offload_threshold=10 → trimmed to summary_threshold=5
  - `test_apply_context_windowing_unit`: direct unit test of helper with system message preservation
- Files changed:
  - packages/orbiter-core/src/orbiter/agent.py (added SystemMessage import, _ProviderSummarizer class, _apply_context_windowing(), wired in run())
  - packages/orbiter-core/src/orbiter/runner.py (wired _apply_context_windowing() in _stream())
  - packages/orbiter-context/tests/test_context_integration.py (added TestAgentContextWindowing with 6 tests)
- All 1288 orbiter-core + orbiter-context tests pass; pre-existing pyright error at agent.py (MCPToolWrapper.to_dict) unrelated to changes
- **Learnings for future iterations:**
  - `_apply_context_windowing()` is placed in `agent.py` (not a separate internal module) and lazy-imported in `runner.py` inside `_stream()` — avoids circular imports since agent.py doesn't import from runner.py at module level
  - Message → MemoryItem conversion: UserMessage→HumanMemory, AssistantMessage→AIMemory, ToolResult→ToolMemory (all have `content` attribute)
  - The windowing order matters: offload_threshold check first (most aggressive), then summarization, then history_rounds windowing last
  - US-015 already handles all persistence via hooks (POST_LLM_CALL saves AIMemory, POST_TOOL_CALL saves ToolMemory); HumanMemory saved pre-run in the memory block — no persistence needed in US-017
  - ContextConfig is a Pydantic model (not a Context object); use `getattr(context, "history_rounds", 20)` for robust attribute access
---

## 2026-02-20 - US-015
- Added `conversation_id: str | None = None` parameter to `Agent.run()` in `agent.py`
- Added pre-run memory block in `Agent.run()`: auto-assigns UUID4 `conversation_id` on first run (only updates `self.conversation_id` when no per-call override), updates `_memory_persistence.metadata` with `MemoryMetadata(agent_id=self.name, task_id=active_conv)`, calls `load_history()` and prepends DB history before explicit `messages`, saves `HumanMemory` to store before LLM call
- Added `conversation_id: str | None = None` parameter to `_stream()` in `runner.py`
- Added same pre-run memory block in `_stream()` using `getattr(agent, "_memory_persistence", None)` pattern; same UUID assignment, metadata update, history load, and HumanMemory save
- Added `TestAgentHistoryPersistence` class to `test_agent.py` with 5 tests: `test_second_run_picks_up_history` (main AC test), `test_conversation_id_auto_assigned_on_first_run`, `test_conversation_id_param_overrides_per_call_only`, `test_explicit_messages_merged_with_history`, `test_no_memory_no_history_loading`
- Files changed:
  - packages/orbiter-core/src/orbiter/agent.py (added `import uuid`, `conversation_id` param, pre-run memory block)
  - packages/orbiter-core/src/orbiter/runner.py (added `conversation_id` param to `_stream()`, pre-run memory block)
  - packages/orbiter-core/tests/test_agent.py (added `TestAgentHistoryPersistence` with 5 tests)
- All 1135 orbiter-core + orbiter-memory tests pass (6 skipped); pre-existing pyright error at agent.py (MCPToolWrapper.to_dict) unrelated to changes
- **Learnings for future iterations:**
  - `MemoryPersistence.metadata` is a regular instance attribute (not frozen); safe to replace with `new_metadata = MemoryMetadata(...)` before each run
  - Pattern for per-call conversation_id override: `active_conv = conversation_id or self.conversation_id`; only update `self.conversation_id` when `conversation_id is None` (no per-call override)
  - `HumanMemory` must be saved to the store BEFORE the LLM call; POST_LLM_CALL hook saves AIMemory, POST_TOOL_CALL saves ToolMemory — user input (HumanMemory) is the caller's responsibility
  - In `runner.py`'s `_stream()`, access memory via `getattr(agent, "_memory_persistence", None)` since runner.py doesn't import from agent.py directly
  - `ShortTermMemory._filter_incomplete_pairs()` removes trailing AI messages with unmatched tool_calls — important for load_history() correctness; keep tool loop complete before ending a run
---

## 2026-02-20 - US-014
- Added `_MEMORY_UNSET` sentinel + `_make_default_memory()` helper in `agent.py` to auto-create `AgentMemory(short_term=ShortTermMemory(), long_term=SQLiteMemoryStore())` when `memory` param is not supplied
- Changed `Agent.__init__` `memory` parameter from `Any = None` to `Any = _MEMORY_UNSET`; when sentinel, calls `_make_default_memory()`; when `None`, stores None (disables memory)
- Added `self._memory_is_auto: bool` flag to track auto-created memory vs explicitly provided
- Added `self._has_user_hooks: bool = bool(hooks)` to track explicitly-provided hooks (vs auto-attached memory hooks)
- Added `self.conversation_id: str | None = None` instance attribute
- Updated `_attach_memory_persistence()` to handle `AgentMemory` (uses `memory.short_term` as `MemoryPersistence` store) in addition to raw `MemoryStore`
- Updated `to_dict()` to skip ValueError for auto-created memory (`_memory_is_auto=True`) and to check `_has_user_hooks` instead of `hook_manager.has_hooks()` (avoids false positives from memory-auto-attached hooks)
- Updated `test_agent.py::TestAgentCreation::test_minimal` to check for `AgentMemory` (with ImportError fallback) + assert `conversation_id is None`
- Added `TestAgentMemoryDefaults` class (7 tests) covering: auto-created AgentMemory, short+long term types, `memory=None` disabled, explicit AgentMemory used, `conversation_id` initially None, persistence attached, `memory=None` still has `conversation_id=None`
- Added `TestSwarmMemoryDefaults` class to `test_swarm.py` (2 tests) verifying lead agent has auto-created memory + memory=None propagates
- Updated `test_memory_integration.py::test_agent_default_memory_none` → `test_agent_default_memory_auto_created` to match new behavior
- Updated `test_memory_persistence.py::_make_agent()` to use `memory=None` (isolation for persistence tests)
- Files changed:
  - packages/orbiter-core/src/orbiter/agent.py
  - packages/orbiter-core/tests/test_agent.py
  - packages/orbiter-core/tests/test_swarm.py
  - packages/orbiter-memory/tests/test_memory_integration.py
  - packages/orbiter-memory/tests/test_memory_persistence.py
- All 1130 orbiter-core + orbiter-memory tests pass (6 skipped); pre-existing pyright error at agent.py:524 unrelated to changes
- **Learnings for future iterations:**
  - Use `_MEMORY_UNSET = object()` sentinel to distinguish "not provided" from `None` in `__init__` kwargs; `memory: Any = _MEMORY_UNSET` in signature works cleanly
  - Auto-attached hooks (from memory persistence) must not be counted as "user hooks" in `to_dict()` checks; use `_has_user_hooks: bool` flag set at init time from explicit `hooks` parameter
  - `_memory_is_auto: bool` flag lets `to_dict()` silently skip auto-created memory (maintains serialization backward compatibility)
  - `test_memory_persistence.py::_make_agent()` should use `memory=None` — the helper is for testing MemoryPersistence in isolation, not agent memory
  - `_attach_memory_persistence()` checks `isinstance(memory, AgentMemory)` first, then `isinstance(memory, MemoryStore)` for legacy compatibility
---

## 2026-02-20 - US-013
- Added `load_history(agent_name: str, conversation_id: str, rounds: int) -> list[Message]` to `MemoryPersistence` in `orbiter-memory/src/orbiter/memory/persistence.py`
- `load_history` queries `self.store` scoped to `agent_id=agent_name` and `task_id=conversation_id`, sorts results chronologically, applies round windowing, then converts MemoryItems → `orbiter.types.Message` objects
- `HumanMemory` → `UserMessage`, `AIMemory` → `AssistantMessage` (with ToolCall list), `SystemMemory` → `SystemMessage`, `ToolMemory` → `ToolResult` (error field set from content when `is_error=True`)
- Changed `SQLiteMemoryStore.__init__` default from `":memory:"` to `None`; when `None`, calls `_default_db_path()` which reads `ORBITER_MEMORY_PATH` env var (default: `~/.orbiter/memory.db`, `os.path.expanduser` applied)
- Added `import os` and `_default_db_path()` helper function to `sqlite.py`
- Added 7 tests to `TestLoadHistory` in `test_memory_persistence.py` covering: empty store, human+AI conversion, system memory, tool result, error tool result, windowing, and scoping
- Added 5 tests to `TestDefaultPath` in `test_sqlite.py` covering: default home path, env var override, tilde expansion, store with no args uses env var, explicit path overrides env var
- Files changed:
  - packages/orbiter-memory/src/orbiter/memory/persistence.py
  - packages/orbiter-memory/src/orbiter/memory/backends/sqlite.py
  - packages/orbiter-memory/tests/test_memory_persistence.py
  - packages/orbiter-memory/tests/test_sqlite.py
- All 311 orbiter-memory tests pass (6 skipped); 0 new type errors in modified source files
- **Learnings for future iterations:**
  - `SQLiteMemoryStore.search()` returns items `ORDER BY created_at DESC` (newest-first); `ShortTermMemory.search()` returns items in insertion order (oldest-first); always `sorted(items, key=lambda x: x.created_at)` after fetching to normalise
  - `conversation_id` maps to `metadata.task_id`; `agent_name` maps to `metadata.agent_id` — this is the canonical scoping convention for per-agent, per-conversation filtering
  - `ToolMemory.is_error=True` means `content` holds the error message; convert to `ToolResult(content="", error=item.content)` when reconstructing
  - `_default_db_path()` is exported so tests can call it directly with `monkeypatch.setenv()` + `_default_db_path()` to verify env-var behaviour without instantiating a store
  - The pre-existing `len(rows)` type error in `sqlite.py:197` (Iterable[Row] vs Sized) is unrelated to US-013 changes
---

## 2026-02-20 - US-012
- Added `AgentMemory` dataclass to `orbiter-memory/src/orbiter/memory/base.py` with fields `short_term: MemoryStore` and `long_term: MemoryStore`; also imported `dataclass` and `field` from `dataclasses`
- Extended `MemoryStore` Protocol's `search()` from abstract (`...`) to a concrete default implementation that filters `self._items` by keyword, memory_type, status, and metadata fields
- Made `MemoryPersistence.attach()` idempotent: added `_attached_agent_ids: set[int]` tracking; second call for same agent object returns early; `detach()` removes agent from set via `discard()`
- Exported `AgentMemory` from `orbiter-memory/src/orbiter/memory/__init__.py` (import + `__all__` entry)
- Added `TestMemoryStoreDefaultSearch` (5 tests) and `TestAgentMemory` (4 tests) to `test_memory_base.py`
- Added `test_attach_idempotent` and `test_attach_idempotent_different_agents` to `test_memory_persistence.py::TestAttachDetach`
- Files changed:
  - packages/orbiter-memory/src/orbiter/memory/base.py
  - packages/orbiter-memory/src/orbiter/memory/persistence.py
  - packages/orbiter-memory/src/orbiter/memory/__init__.py
  - packages/orbiter-memory/tests/test_memory_base.py
  - packages/orbiter-memory/tests/test_memory_persistence.py
- All 299 orbiter-memory tests pass (6 skipped); 0 new type errors in modified source files
- **Learnings for future iterations:**
  - `MemoryStore` is a `@runtime_checkable Protocol`; concrete default methods in the Protocol body work but only apply when a class INHERITS from the Protocol (not structural subtypes)
  - To test the Protocol's default `search` from a structural subtype, call `MemoryStore.search(self, ...)` directly
  - `MemoryPersistence._attached_agent_ids` uses `id(agent)` (Python object identity); call `discard()` in `detach()` to avoid KeyError
  - `AgentMemory` uses `@dataclass` (not Pydantic) because `MemoryStore` is a Protocol (not a serializable type), and dataclass field ordering is straightforward
  - `ShortTermMemory.__slots__` is set, which means it can't be used as a keyword argument in `AgentMemory(short_term=X)` directly — but since `AgentMemory` is a `@dataclass`, positional OR keyword args both work fine
---

## 2026-02-20 - US-011
- orbiter-web/engine.py: added `import time`; removed `import contextlib` (no longer needed); added `_log.info("Workflow %s starting: ...")` at top of `execute_workflow()`; added `_log.debug("Executing node %s (type=%s)", ...)` before each node task creation; added `node_start_times` dict + `elapsed_ms` tracking per node; added `_log.info("Node %s completed in %.1fms", ...)` after task result; added `_log.error("Node %s failed: %s", ..., exc_info=True)` in exception handler; replaced all 5 `contextlib.suppress(Exception)` usages in emit() functions with `try/except + _log.warning("WebSocket send failed: %s", exc)` (fixes audit B-16)
- orbiter-web/services/agent_runtime.py: added `import logging` + `_log = logging.getLogger(__name__)`; added `_log.info("run_agent start: ...")` and `_log.error(..., exc_info=True)` on failure; added `_log.debug("run_agent tool calls: ...")` when tool_calls present; added `_log.info("stream_agent start: ...")` and `_log.error(..., exc_info=True)` on failure
- orbiter-web/services/scheduler.py: added `_log.debug("Next run for schedule %s: %s", ...)` after computing next_run
- orbiter-web/services/memory.py: added `import logging` + `_log = logging.getLogger(__name__)`; added `_log.debug("get_memory: agent=%s thread=%s type=%s", ...)` at start of get_memory()
- orbiter-web/services/sandbox.py: added `import logging` + `_log = logging.getLogger(__name__)`; added `_log.debug("execute_code: code_len=%d timeout=%ds", ...)` at start of execute_code(); added `_log.warning("execute_code: timed out after %ds", ...)` in TimeoutExpired handler
- Files changed: 5 files across orbiter-web package
- All 29 orbiter-web tests pass; 0 new type errors in modified files (pre-existing errors in orbiter-web are unrelated)
- **Learnings for future iterations:**
  - engine.py uses `contextlib.suppress(Exception)` for all 4 emit() functions + 1 inline event_callback call — all 5 replaced simultaneously
  - After removing all contextlib.suppress usages, `import contextlib` became unused and was removed
  - Track per-node start times with `node_start_times: dict[str, float]` before creating asyncio.Tasks; access in the gather loop
  - agent_runtime.py had no logging at all — needed full import + logger setup
  - scheduler.py already had good logging; only needed `logger.debug next_run` addition
---

## 2026-02-20 - US-010
- orbiter-eval/ralph/runner.py: added `import logging` + `logger`; added `logger.info` at start of `run()` with input_len/scorers count; replaced bare `except: pass` in `_analyze()` with `logger.warning("Scorer failed case=%s: %s", case_id, exc, exc_info=True)` (fixes audit C-10)
- orbiter-eval/trajectory_scorers.py: added `import logging` + `logger`; added `logger.debug` per-case score in `TrajectoryValidator.score()` and `TimeCostScorer.score()`
- orbiter-sandbox/base.py: already had logging; added `logger.info("Sandbox %s: starting/stopping", ...)` in `LocalSandbox.start()` and `stop()` (debug was on `_transition()` only)
- orbiter-sandbox/tools.py: already had logging; added `logger.warning("TerminalTool: blocked command %r", base)` before raising ToolError in `_check_command()`
- orbiter-server/app.py: added `import logging` + `logger`; added `serve(host, port)` function that calls `logger.info("Starting Orbiter Server on %s:%d", ...)` before uvicorn.run(); exported from `__init__.py`
- orbiter-train/train/verl.py: already had logging; added `logger.warning("VeRLTrainer.train: STUB — no real training performed")` in `_run_verl_training()` (flags C-3)
- orbiter-train/train/evolution.py: added `import logging` + `logger`; added `logger.info("Evolution epoch %d/%d starting/complete: ...")` per epoch + `logger.debug("Best epoch so far: ...")` after each epoch
- Files changed: 8 files across 4 packages
- All 705 tests pass (608 eval/sandbox/train + 97 server); 0 new type errors
- **Learnings for future iterations:**
  - orbiter-sandbox/base.py and tools.py already had full logging infrastructure — only needed targeted additions
  - orbiter-eval has two runner files: `ralph/runner.py` (RalphRunner iteration loop) and no top-level runner.py; the "runner.py" in US-010 refers to ralph/runner.py
  - orbiter-server has no `__main__.py` or CLI entry point; the "entry point" logging was added as a `serve()` helper function in app.py
  - orbiter-train/verl.py already had extensive logging from prior work; only needed the STUB warning
  - EvolutionPipeline epoch_idx is 0-based; log as epoch_idx+1 for human readability
---

## 2026-02-20 - US-016
- Added `token_budget_trigger: float = 0.8` field to `ContextConfig` in `orbiter-context/config.py` (Field ge=0, le=1)
- Added `_CONTEXT_UNSET` sentinel and `_make_default_context()` / `_make_context_from_mode()` helpers to `orbiter-core/agent.py`
- Added `context_mode: Any = _CONTEXT_UNSET` parameter to `Agent.__init__`; changed `context: Any = None` → `context: Any = _CONTEXT_UNSET`
- Resolution logic: explicit `context=` takes precedence; `context_mode=` sets mode; both unset → auto-create `ContextConfig(mode='copilot')`; either `=None` disables context engine
- Added `_context_is_auto: bool` flag; updated `to_dict()` to skip auto-created context (same pattern as `_memory_is_auto`)
- Added `_SWARM_CONTEXT_UNSET` sentinel and `context_mode: Any = _SWARM_CONTEXT_UNSET` to `Swarm.__init__`; propagates ContextConfig to all member agents when provided
- Updated `test_minimal` in `test_agent.py` to check for auto-created ContextConfig (with ImportError fallback)
- Updated `test_agent_context_default_none` → `test_agent_context_default_auto_created` in `test_context_integration.py`
- Added `TestAgentContextDefaults` (9 tests) to `test_agent.py`
- Added `TestSwarmContextMode` (3 tests) to `test_swarm.py`
- Added `token_budget_trigger` tests to `test_context_config.py`
- Files changed:
  - packages/orbiter-context/src/orbiter/context/config.py
  - packages/orbiter-core/src/orbiter/agent.py
  - packages/orbiter-core/src/orbiter/swarm.py
  - packages/orbiter-core/tests/test_agent.py
  - packages/orbiter-core/tests/test_swarm.py
  - packages/orbiter-context/tests/test_context_config.py
  - packages/orbiter-context/tests/test_context_integration.py
- All 1282 orbiter-core + orbiter-context tests pass; pre-existing pyright error at agent.py (MCPToolWrapper.to_dict) unrelated to changes
- **Learnings for future iterations:**
  - Use `_CONTEXT_UNSET = object()` sentinel (same pattern as `_MEMORY_UNSET`) to distinguish "not provided" from `None` (disable) in both `context_mode` and `context` params
  - Resolution order: `context` (explicit ContextConfig or None) > `context_mode` (str or None) > auto-create copilot
  - Swarm propagates context_mode by mutating `agent.context` and `agent._context_is_auto` in-place after agent dict is built (agents are pre-created before Swarm init)
  - Swarm imports `_make_context_from_mode` lazily from `orbiter.agent` (inside the `if context_mode is not _SWARM_CONTEXT_UNSET:` block) to avoid circular imports at module level
  - `token_budget_trigger` added with `ge=0.0, le=1.0` Pydantic validation — it does NOT participate in `_validate_thresholds()` which only checks summary vs offload
---

## 2026-02-20 - US-018
- Added `context_window_tokens: int | None = None` field to `ModelConfig` in `orbiter-core/src/orbiter/config.py` (not types.py — the AC referenced the wrong file; ModelConfig lives in config.py)
- Created `packages/orbiter-models/src/orbiter/models/context_windows.py` with `MODEL_CONTEXT_WINDOWS` dict covering 8 well-known models (gpt-4o: 128000, gpt-4o-mini: 128000, o1: 200000, claude-sonnet-4-6: 200000, claude-opus-4-6: 200000, claude-haiku-4-5-20251001: 200000, gemini-2.0-flash: 1048576, gemini-1.5-pro: 2097152)
- Updated `get_provider()` in `provider.py` to look up `model_name` in `MODEL_CONTEXT_WINDOWS` and pass `context_window_tokens` to `ModelConfig`; caller can explicitly override via `context_window_tokens=...` kwarg
- Exported `MODEL_CONTEXT_WINDOWS` from `orbiter-models/__init__.py` + updated `EXPECTED_ALL` in integration test
- Added `TestModelContextWindows` class (8 tests) to `test_models_integration.py`
- Added `test_context_window_tokens_field`, `test_context_window_tokens_none`, `test_roundtrip_with_context_window` to `test_config.py`; updated `test_defaults` to assert `context_window_tokens is None`
- All 1079 orbiter-models + orbiter-core tests pass; 0 new type errors
- Files changed:
  - packages/orbiter-core/src/orbiter/config.py (added context_window_tokens field)
  - packages/orbiter-models/src/orbiter/models/context_windows.py (new file)
  - packages/orbiter-models/src/orbiter/models/provider.py (import + ctx_tokens lookup in get_provider)
  - packages/orbiter-models/src/orbiter/models/__init__.py (export MODEL_CONTEXT_WINDOWS)
  - packages/orbiter-models/tests/test_models_integration.py (EXPECTED_ALL update + TestModelContextWindows)
  - packages/orbiter-core/tests/test_config.py (new tests for context_window_tokens)
- **Learnings for future iterations:**
  - `ModelConfig` is in `orbiter-core/src/orbiter/config.py`, NOT `orbiter-core/src/orbiter/types.py` — the PRD AC had the wrong file path
  - `MODEL_CONTEXT_WINDOWS` keys are model_name strings (after the colon in "provider:model_name") — lookup uses model_name from `parse_model_string()`, not the full model string
  - `kwargs.pop("context_window_tokens", ...)` pattern allows callers to explicitly override registry values while keeping the signature clean
  - `EXPECTED_ALL` in `test_models_integration.py` is sorted and checked with `sorted(models.__all__) == EXPECTED_ALL` — update alphabetically when adding exports
---

## Codebase Patterns
- Context windowing helper `_apply_context_windowing(msg_list, context, provider)` lives in `agent.py`; lazy-imported in `runner.py` — use same pattern for any future context-related helpers
- orbiter-web tests are in packages/orbiter-web/tests/ (not src/)
- subprocess.run(text=True) applies universal newline translation (\r → \n), so don't assert literal \r in captured stdout
- pyright has ~170 pre-existing errors in orbiter-web; check only modified files for new errors
- Use repr() (not json.dumps()) for embedding arbitrary strings in Python source code literals
- Route handlers that do `from module import func` inside the function body: patch at the source module (e.g., `orbiter_web.engine.execute_workflow`), not at the router module
- Use `starlette.testclient.TestClient` with a minimal FastAPI app for synchronous HTTP-level route tests; no pytest-asyncio marks needed
- `_make_get_db(*rows)` pattern: create an `@asynccontextmanager` that yields a mock db and returns rows sequentially for each `db.execute()` call
- orbiter-observability env-var config: expose `_configure_from_env()` as a callable so tests can use `monkeypatch.setenv()` + `reset_logging()` + `_configure_from_env()` to test env-var behavior without reimporting the module

---

## 2026-02-20 - US-009
- Added `import logging` and `logger = logging.getLogger(__name__)` to orbiter-a2a/server.py and client.py
- orbiter-a2a/server.py: added logger.info at run start and complete in execute_task() and _generate() stream, logger.error with exc_info=True on failure in both
- orbiter-a2a/client.py: added logger.debug in RemoteAgent.run() and RemoteAgent.describe()
- orbiter-cli/main.py: added `import logging` and logger; added logger.debug('CLI command=%s args=%r') at start of run, start_worker, task_status, task_cancel, task_list, worker_list
- orbiter-distributed/client.py: upgraded TaskHandle.result() completed path from logger.debug to logger.info (task result received)
- orbiter-distributed/worker.py: added exc_info=True to the _execute_task error log
- orbiter-distributed/broker.py: already had full logger.debug on enqueue (submit) and dequeue (claim) — no changes needed
- Files changed:
  - packages/orbiter-a2a/src/orbiter/a2a/server.py
  - packages/orbiter-a2a/src/orbiter/a2a/client.py
  - packages/orbiter-cli/src/orbiter_cli/main.py
  - packages/orbiter-distributed/src/orbiter/distributed/client.py
  - packages/orbiter-distributed/src/orbiter/distributed/worker.py
- All 373 orbiter-a2a + orbiter-distributed tests pass; 267 orbiter-cli tests pass; 0 new type errors
- **Learnings for future iterations:**
  - orbiter-distributed/broker.py, client.py, and worker.py already had extensive logging — only client.py "received" and worker.py exc_info needed updating
  - orbiter-a2a files had no logging at all — needed full import + logger setup
  - orbiter-cli commands are Typer decorated functions — logger.debug at top of each command body works fine
---

## 2026-02-20 - US-008
- Updated orbiter-context/config.py: changed make_config() log to include history_rounds: `ContextConfig created mode=%s history_rounds=%d`
- Updated orbiter-context/processor.py: changed fire() log to `Processing context with %d neurons`; updated ToolResultOffloader log to `ToolResultOffloader: offloading tool=%s size=%d bytes`
- Updated orbiter-context/token_tracker.py: added `TokenTracker: used=%d / total=%d (%.0f%%)` log after each add_step() call
- Updated orbiter-context/workspace.py: changed write() logs to `Artifact stored: id=%s size=%d bytes`; added read() log `Artifact retrieved: id=%s`
- Updated orbiter-memory/summary.py: changed check_trigger() logs from debug to info with format `Summarization triggered: threshold=%d messages=%d`; changed generate_summary() log to `Summary generated length=%d`
- Updated orbiter-memory/long_term.py: changed submit() log from debug to info: `long-term extraction triggered: items=%d types=%d`
- Files changed:
  - packages/orbiter-context/src/orbiter/context/config.py
  - packages/orbiter-context/src/orbiter/context/processor.py
  - packages/orbiter-context/src/orbiter/context/token_tracker.py
  - packages/orbiter-context/src/orbiter/context/workspace.py
  - packages/orbiter-memory/src/orbiter/memory/summary.py
  - packages/orbiter-memory/src/orbiter/memory/long_term.py
- All 731 tests pass (6 skipped); 0 new type errors in modified files
- **Learnings for future iterations:**
  - Most orbiter-context and orbiter-memory files already had `import logging` and `logger = logging.getLogger(__name__)` — only log message content/level needed updating
  - `orbiter-context/summary.py` does NOT exist — summary logic is in `orbiter-memory/summary.py`
  - The pre-existing sqlite.py type error (`len(rows)` on `Iterable[Row]`) is unrelated to logging changes; ignore for this story
  - "neurons" in processor.py context refers to the count of registered processors for the event
  - TokenTracker: used=%d is per-agent accumulated, total=%d is all-agent accumulated
---

## 2026-02-20 - US-007
- Added `import os` and `_ENV_FORMAT = '%(asctime)s %(levelname)-8s %(name)s  %(message)s'` to `logging.py`
- Added `_configure_from_env()` function that reads `ORBITER_DEBUG` and `ORBITER_LOG_LEVEL` env vars, sets root `orbiter` logger level, and adds a handler with the standard format when env vars are present
- Called `_configure_from_env()` at module import time so env vars take effect before any explicit `configure_logging()` call
- Added 12 new tests in `TestConfigureFromEnv` covering: DEBUG level, INFO/ERROR level, ORBITER_DEBUG precedence, invalid level fallback, no-env-vars case, handler format, idempotency, child logger inheritance, case-insensitive level
- Files changed:
  - packages/orbiter-observability/src/orbiter/observability/logging.py (added os import, _ENV_FORMAT, _VALID_ENV_LEVELS, _configure_from_env(), module-level call)
  - packages/orbiter-observability/tests/test_obs_logging.py (added _ENV_FORMAT and _configure_from_env imports, added TestConfigureFromEnv class)
- **Learnings for future iterations:**
  - To test env-var-driven module-level behavior without reimporting: expose the apply function as `_configure_from_env()`, call it after `reset_logging()` + `monkeypatch.setenv()` in tests
  - `_configured` global flag prevents double-handler-addition; `reset_logging()` clears it, so tests can re-trigger `_configure_from_env()` for each test case
  - `logger.getEffectiveLevel()` on a child logger returns the inherited level from the root (correct for testing propagation)
---

## 2026-02-20 - US-006
- Updated all 3 call sites that resolve callable instructions to use `asyncio.iscoroutinefunction(raw_instr)` instead of calling and checking `asyncio.iscoroutine(result)`
- Files changed:
  - packages/orbiter-core/src/orbiter/agent.py (agent.run(): changed to iscoroutinefunction pattern; updated instructions type annotation from `Callable[..., str]` to `Callable[..., Any]`)
  - packages/orbiter-core/src/orbiter/runner.py (stream() resolver: changed to iscoroutinefunction pattern)
  - packages/orbiter-core/src/orbiter/_internal/call_runner.py (call_runner result messages resolver: changed to iscoroutinefunction pattern)
  - packages/orbiter-core/tests/test_agent.py (added test_async_callable_instructions)
- **Learnings for future iterations:**
  - `asyncio.iscoroutinefunction(fn)` checks the function itself before calling it — cleaner than calling and checking `asyncio.iscoroutine(result)`; both work but the latter unnecessarily calls async functions in a fire-and-forget way
  - Agent `instructions` type annotation must be `Callable[..., Any]` (not `Callable[..., str]`) to accept async callables returning `Coroutine[Any, Any, str]`
  - There are 3 call sites for instruction resolution: agent.py `run()`, runner.py `stream()`, and _internal/call_runner.py result message building
---

## 2026-02-19 - US-002
- In `_validate_startup()` in `app.py`: added RuntimeError when `debug=False` and `secret_key == 'change-me-in-production'`; kept warning log when in debug mode
- Added inline comment to `config.py` on the `secret_key` field: `# Override via ORBITER_SECRET_KEY — MUST change in production`
- Files changed:
  - packages/orbiter-web/src/orbiter_web/app.py (_validate_startup: warning → RuntimeError in production)
  - packages/orbiter-web/src/orbiter_web/config.py (added inline comment on secret_key)
  - packages/orbiter-web/tests/test_startup.py (new file with 3 tests)
- **Learnings for future iterations:**
  - `_validate_startup()` is called from `lifespan()` at startup — mocking `settings` and `_DB_PATH` is the cleanest way to test it
  - The `or not settings.secret_key` branch was split out so empty-key stays as warning while default-key raises in production
  - `patch("orbiter_web.app.settings")` patches the settings object used inside app.py (not the one imported at test time)
---

## 2026-02-20 - US-003
- Added `hmac.compare_digest()` token validation to `trigger_webhook()` in `routes/webhooks.py`
- Added `url_token: str | None = Query(default=None)` parameter to the handler
- Token check runs after 404 check but before enabled check; returns 403 with `{"detail": "Invalid token"}` on mismatch or missing token
- Created `packages/orbiter-web/tests/test_webhooks.py` with 3 tests: missing token → 403, wrong token → 403, correct token → 200
- Files changed:
  - packages/orbiter-web/src/orbiter_web/routes/webhooks.py (added `import hmac`, `url_token` param, validation block)
  - packages/orbiter-web/tests/test_webhooks.py (new file)
- **Learnings for future iterations:**
  - `can_start_run` and `execute_workflow` are imported inside the function body in `trigger_webhook` — patch at source (`orbiter_web.services.run_queue.can_start_run`, `orbiter_web.engine.execute_workflow`)
  - `starlette.testclient.TestClient` with a minimal FastAPI app handles async route handlers synchronously — no asyncio setup needed
  - `_append_request_log` makes additional `get_db()` calls that need to be included in the mock row sequence
---

## 2026-02-20 - US-004
- Removed the log line that emitted the raw password reset token (`logger.info("Password reset token for %s: %s", body.email, token)`) from `forgot_password()` in `routes/auth.py:389`
- Replaced with `logger.debug("Password reset email sent to %s", body.email)` — email only, no token
- Grepped entire orbiter-web package for other logger calls emitting tokens, session IDs, or raw credentials — no others found
- Created `packages/orbiter-web/tests/test_auth_reset.py` with 2 tests: token absent from logs, email present in debug log
- Files changed:
  - packages/orbiter-web/src/orbiter_web/routes/auth.py (line 388-389: remove token log, add email-only debug)
  - packages/orbiter-web/tests/test_auth_reset.py (new file)
- **Learnings for future iterations:**
  - `caplog.at_level(logging.DEBUG, logger="orbiter_web")` captures debug logs for the `orbiter_web` logger in tests
  - Use `re.compile(UUID_PATTERN).search(record.message)` to assert no UUID token appears in any log record
  - The `forgot_password` route makes 2 `get_db()` calls: SELECT user by email, then INSERT password_resets
---

## 2026-02-20 - US-005
- Rewrote `AgentService.stream_agent()` in `orbiter-web/services/agent_runtime.py` to use `orbiter_run.stream()` (from `orbiter.runner`) instead of calling `provider.stream()` directly
- The full agent tool loop now runs during streaming: LLM tool calls are executed and results fed back before re-streaming
- Added `from orbiter.runner import run as orbiter_run` and `TextEvent, Usage, UsageEvent` imports at module level
- Yields `StreamChunk` objects for backward compat: `TextEvent` → `StreamChunk(delta=...)`, final chunk has `finish_reason="stop"` + accumulated usage
- Updated `test_stream_agent` to mock `orbiter_run.stream` via `patch("orbiter_web.services.agent_runtime.orbiter_run", mock_run)`
- Added `test_stream_agent_executes_tools`: real Agent with a real tool + mock provider that first returns tool_call_deltas, then text; asserts tool was invoked
- Files changed:
  - packages/orbiter-web/src/orbiter_web/services/agent_runtime.py (stream_agent rewrite + new imports)
  - packages/orbiter-web/tests/test_agent_runtime.py (updated test_stream_agent, added test_stream_agent_executes_tools)
- **Learnings for future iterations:**
  - `orbiter.runner.run.stream` is the high-level streaming API; it handles tool loop, hooks, and event emission
  - Patch `orbiter_web.services.agent_runtime.orbiter_run` to mock `run.stream` in tests (it's imported as `orbiter_run` at module level)
  - `run.stream(detailed=True)` emits `UsageEvent` — without `detailed=True`, no usage is available
  - `StreamChunk(tool_call_deltas=[...])` chunks accumulate in `_stream()`; absence of `tc_acc` entries means no tool loop iteration
---

## 2026-02-19 - US-001
- Replaced manual `.replace()`-based escaping in `_build_runner_script()` with `repr()` serialization of the user code string
- The repr() approach handles \r, \t, \0, null bytes, \u0041, embedded triple-quotes, and any other special characters safely
- Files changed:
  - packages/orbiter-web/src/orbiter_web/services/sandbox.py (line 87: escaped_code → code_repr = repr(code); line 152: f-string uses {code_repr})
  - packages/orbiter-web/tests/test_sandbox.py (new file with 6 tests)
- **Learnings for future iterations:**
  - The old code used single-quote embedding `_user_code = '{escaped_code}'` which was vulnerable to any char that breaks out of single-quote context
  - repr() produces a valid Python literal for any string (uses b-prefix or escape sequences as needed)
  - subprocess.run(text=True) normalizes \r to \n — don't test for literal \r in captured stdout
---
