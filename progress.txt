# Ralph Progress Log
Started: Mon Feb 16 08:13:35 PM IST 2026
---

## Codebase Patterns
- orbiter-web is a Node.js (Astro 5.x) package inside a UV Python workspace — it has its own package.json, not pyproject.toml for the frontend
- Astro 5.x defaults to strict TypeScript; extend `astro/tsconfigs/strict` in tsconfig.json
- Tailwind CSS v4 must be integrated via `@tailwindcss/vite`, NOT `@astrojs/tailwind`
- Astro typecheck: run `npx astro check` from the orbiter-web directory
- `.gitignore` in orbiter-web excludes `node_modules/`, `dist/`, `.astro/`
- Fonts: Bricolage Grotesque via @fontsource imports, Junicode via woff2 in `public/fonts/`; use `font-junicode` utility class for display headings
- cn() utility at `src/utils/merge.ts` — import via `import { cn } from "../utils/merge"` for class merging in components
- All pages should use `<BaseLayout>` wrapper — it provides theme detection, global styles, and animation support
- Use `is:inline` for Astro scripts that must block rendering (e.g., theme detection to prevent flash)
- Use `data-animate="zenReveal|zenFade|zenScale"` on elements for scroll-triggered animations
- Proxy API requests in dev: configure `vite.server.proxy` in astro.config.mjs (NOT Astro-specific proxy)
- Use `uv run` prefix in npm scripts that need the Python venv (e.g., `uv run uvicorn ...`)
- PageLayout.astro is the app shell with sidebar — use `activeSection` prop to highlight current nav item (e.g., `<PageLayout activeSection="projects">`)
- Inline SVG icons: store as HTML strings in frontmatter, render with `set:html` directive — no icon library needed
- orbiter-web has BOTH package.json (Astro frontend) AND pyproject.toml (FastAPI backend) — it's a dual Node+Python package
- PageLayout accepts `breadcrumbs` (array of {label, href}), `projectName`, and `activeSection` props
- Mobile breakpoint: `< md` uses bottom tab bar + hamburger slide-out; `md+` uses sidebar; `lg+` sidebar is expandable
- FastAPI app entry point: `orbiter_web.app:app` — run with `uvicorn orbiter_web.app:app`
- Settings via dataclass in `orbiter_web/config.py` — reads ORBITER_DATABASE_URL, ORBITER_SECRET_KEY, ORBITER_DEBUG env vars
- When adding a new Python package to UV workspace: update `members`, `dependency-groups.dev`, and `tool.uv.sources` in root pyproject.toml
- Database: `get_db()` async context manager in `orbiter_web/database.py` — sets WAL mode, foreign keys, Row factory
- Migrations: sequential .sql files in `orbiter_web/migrations/`, tracked in `_migrations` table; run automatically on app startup via FastAPI lifespan
- FastAPI lifespan: use `@asynccontextmanager` that yields once (replaces deprecated `on_event("startup")`)
- Routes: use `APIRouter(prefix="/api/...", tags=["..."])` in `routes/<module>.py`, register with `app.include_router()` in app.py
- Pydantic models: use `BaseModel` for request/response schemas, `Field(min_length=...)` for validation
- Row conversion: `dict(row)` converts `aiosqlite.Row` to a plain dict for Pydantic serialization
- Placeholder auth: `_DEFAULT_USER_ID = "default-user"` until US-018 is implemented — all queries filter by user_id
- Ruff: use `datetime.UTC` not `timezone.utc`, use `[*list(...), item]` instead of `list(...) + [item]`
- Dynamic routes: `[param].astro` files in `src/pages/` — access via `Astro.params.param`; use `define:vars={{ var }}` to pass to `is:inline` scripts
- Client-side data fetching: use `<template>` + `cloneNode(true)` for card rendering from API data; better than innerHTML string building
- Modal integration: reuse `Modal.astro` component, open with `.showModal()`, `data-modal-close` handles closing automatically
- App pages use `PageLayout` (not `BaseLayout`) for sidebar + top bar + breadcrumbs
- Ruff B008: use `# noqa: B008` for FastAPI `Depends()` in function defaults — it's the standard DI pattern
- Auth redirect lives in PageLayout — all app pages are protected automatically; standalone pages (login) use BaseLayout directly
- Login page uses BaseLayout, not PageLayout, since it doesn't need sidebar/topbar chrome
- Auth middleware: `get_current_user` from `routes/auth.py` is a FastAPI `Depends()` — use in any protected route
- API keys: encrypt with `encrypt_api_key()` on write, use `api_key_set: bool` in response models — never expose encrypted or plaintext keys in API responses
- Provider test endpoint: use httpx AsyncClient for lightweight API calls; lazy-import httpx to avoid overhead on CRUD routes
- Provider keys: multiple keys per provider in `provider_keys` table; load balance strategy on `providers.load_balance_strategy`
- Key selection: POST `/api/providers/:id/keys/select` returns decrypted key based on strategy; report usage via POST `/api/providers/:id/keys/:keyId/report`
- Applications: 5 types (chatbot, chatflow, workflow, agent, text_generator); duplicate endpoint copies with "(Copy)" suffix
- Application routes at `/api/applications` — use `project_id` query param for filtering by project
- tools_json and handoffs_json are JSON arrays stored as TEXT in agents table — parse on load, stringify on save
- /api/tools returns built-in tool catalog (static, no DB) — will be augmented with user-defined tools later
- Highlight-overlay pattern for textarea: use transparent text textarea (z-10) + backdrop div with styled HTML behind it; sync scroll and resize
- Agent meta config (variables, memory, context toggles) stored as `_` prefixed keys in `hooks_json` to avoid schema changes
- Version tracking pattern: auto-create version on template save via `_create_version()` helper; use COALESCE(MAX(version_number), 0) + 1 for auto-incrementing within a template
- Shared model API helper: `_send_prompt_to_model()` returns dict with optional `error` field (doesn't raise) — safe for asyncio.gather parallel calls
- React islands: use `client:only="react"` for DOM-heavy components (e.g., ReactFlow); requires @astrojs/react integration + tsconfig jsx settings
- Canvas island lives at `src/islands/Canvas/CanvasIsland.tsx`; sync theme via MutationObserver on `data-theme` attribute
- Workflows table stores canvas state as JSON TEXT columns: `nodes_json`, `edges_json`, `viewport_json`; workflow routes at `/api/workflows`
- CanvasIsland accepts optional `workflowId` prop — loads from GET /api/workflows/:id on mount, auto-saves with 500ms debounce via PUT
- Handle types defined in `handleTypes.ts` — `getHandlesForNodeType(nodeType)` returns HandleSpec[]; all nodes use `type: "workflow"` for custom rendering via WorkflowNode.tsx
- Custom nodeTypes/edgeTypes must be defined OUTSIDE the component (stable reference) — passed to `<ReactFlow nodeTypes={...} edgeTypes={...}>`
- Validation data on nodes: use `_` prefixed data props (_missingConfig, _unreachable, _disconnectedInputs) — injected via displayNodes useMemo
- `fitView({ nodes: [{ id }], padding: 0.5, duration: 400 })` centers viewport on a specific node — useful for navigate-to-node from panels
- WebSocket auth: extract session cookie manually via `websocket.cookies.get("orbiter_session")`, validate before `websocket.accept()`; no `Depends()` for WS
- Provider streaming: OpenAI/Anthropic use SSE (`data: ` prefix), Ollama uses NDJSON; use httpx `client.stream()` + `resp.aiter_lines()`
- Vite proxy needs `ws: true` for WebSocket forwarding — `/api` proxy only forwards HTTP by default
- WebSocket chat pattern: connect on agent select, send `{content: "..."}`, receive `{type: "token"|"done"|"error", ...}`; reconnect on clear to reset server-side history
- Conversation persistence: conversations + messages tables; WebSocket creates conversation lazily on first message; _TokenCollector wraps WS to capture streamed content for DB storage
- REST API for conversations at `/api/conversations` — list (with optional agent_id filter), get, delete, and `/api/conversations/:id/messages` for message history
- FastAPI route ordering: define `/search` or other static paths BEFORE `/{id}` param routes to prevent FastAPI matching "search" as an id
- Ruff B008: only `Depends()` triggers it — `Query(...)` with keyword args does NOT; don't add unnecessary noqa comments
- Confirmation dialogs: use native `<dialog>` with `.showModal()` and `backdrop:bg-dark/40` — no external modal library needed; close on backdrop click via `e.target === dialog`
- Workflow execution: `engine.py` has topological_sort (Kahn's) + execute_workflow; `routes/workflow_runs.py` has REST + WS endpoints; both share `/api/workflows` prefix
- Background asyncio tasks: store in a module-level `set()` and use `task.add_done_callback(set.discard)` to prevent GC (ruff RUF006)
- Ruff SIM105: use `contextlib.suppress(Exception)` instead of `try/except pass`

---

## 2026-02-16 21:00 - US-016
- What was implemented: Projects CRUD REST API with 5 endpoints (list, create, get, update, delete)
- Files changed:
  - packages/orbiter-web/src/orbiter_web/routes/__init__.py (new — route package init)
  - packages/orbiter-web/src/orbiter_web/routes/projects.py (new — APIRouter with ProjectCreate, ProjectUpdate, ProjectResponse Pydantic models, 5 endpoints)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — include projects_router)
- **Learnings for future iterations:**
  - APIRouter with prefix="/api/projects" keeps all project routes in one module, registered via app.include_router()
  - Pydantic's Field(min_length=1) provides automatic 422 validation for required string fields
  - aiosqlite.Row can be converted to dict via dict(row) for Pydantic model serialization
  - Dynamic UPDATE SET clause: build from model_dump(exclude_none=True) keys for partial updates
  - Placeholder _DEFAULT_USER_ID used until auth (US-018) is ready — easy to replace with a dependency later
  - DELETE returns 204 No Content with `status_code=204` and `-> None` return type
---

## 2026-02-16 20:16 - US-001
- What was implemented: Astro 5.x package scaffolding at packages/orbiter-web/
- Files changed:
  - packages/orbiter-web/package.json (astro@5.x, typescript, @astrojs/check)
  - packages/orbiter-web/tsconfig.json (extends astro/tsconfigs/strict)
  - packages/orbiter-web/astro.config.mjs (output: 'static')
  - packages/orbiter-web/src/pages/index.astro (placeholder page)
  - packages/orbiter-web/.gitignore (node_modules, dist, .astro)
- **Learnings for future iterations:**
  - Astro 5.x removed the `--typescript` flag from create-astro; strict is the default
  - tsconfig.json needs `"include": [".astro/types.d.ts", "**/*"], "exclude": ["dist"]` for Astro 5
  - `astro check` generates .astro/types.d.ts on first run — this is gitignored
  - npm install in orbiter-web is independent of the UV Python workspace
---

## 2026-02-16 20:20 - US-002
- What was implemented: Tailwind CSS v4 with design system color tokens
- Files changed:
  - packages/orbiter-web/package.json (added tailwindcss@4, @tailwindcss/vite)
  - packages/orbiter-web/astro.config.mjs (added @tailwindcss/vite plugin via vite.plugins)
  - packages/orbiter-web/src/styles/global.css (new — @import "tailwindcss", CSS custom properties for zen design tokens, @theme block mapping to Tailwind colors)
  - packages/orbiter-web/src/pages/index.astro (imports global.css, uses bg-paper text-dark)
- **Learnings for future iterations:**
  - Tailwind CSS v4 uses `@import "tailwindcss"` instead of `@tailwind base/components/utilities` directives
  - In Tailwind v4, `@theme {}` block defines custom design tokens that map directly to utility classes (e.g., `--color-coral` → `bg-coral`, `text-coral`)
  - CSS custom properties + @theme var() references allow theme switching via data attributes without JS runtime
  - Astro integrates Tailwind v4 via `vite.plugins` in astro.config.mjs, NOT via `@astrojs/tailwind`
---

## 2026-02-16 20:22 - US-003
- What was implemented: Font setup with Bricolage Grotesque (via @fontsource) and Junicode (variable woff2 files)
- Files changed:
  - packages/orbiter-web/package.json (added @fontsource/bricolage-grotesque)
  - packages/orbiter-web/package-lock.json (updated)
  - packages/orbiter-web/public/fonts/JunicodeVF-Roman.woff2 (new — variable font, Roman)
  - packages/orbiter-web/public/fonts/JunicodeVF-Italic.woff2 (new — variable font, Italic)
  - packages/orbiter-web/src/styles/global.css (added @fontsource imports, @font-face for Junicode, body font, font-junicode utility)
- **Learnings for future iterations:**
  - Use @fontsource for Google/open-source fonts — import individual weight CSS files (e.g., `@fontsource/bricolage-grotesque/400.css`)
  - Junicode v2.x ships as variable fonts (woff2) — use `font-weight: 100 900` in @font-face
  - Tailwind v4 @theme block supports `--font-*` custom properties that map to `font-*` utilities
  - `font-display: swap` prevents FOIT (flash of invisible text) during font loading
---

## 2026-02-16 20:25 - US-004
- What was implemented: cn() class merging utility using clsx + tailwind-merge
- Files changed:
  - packages/orbiter-web/package.json (added clsx, tailwind-merge)
  - packages/orbiter-web/package-lock.json (updated)
  - packages/orbiter-web/src/utils/merge.ts (new — exports cn() function)
- **Learnings for future iterations:**
  - cn() pattern: `twMerge(clsx(inputs))` — clsx handles conditional classes, twMerge resolves Tailwind conflicts
  - Import cn() via `import { cn } from "../utils/merge"` in Astro/TS components
  - tailwind-merge v3.x works with Tailwind v4 out of the box
---

## 2026-02-16 20:27 - US-005
- What was implemented: BaseLayout.astro with theme detection, animation support, and SEOHead component
- Files changed:
  - packages/orbiter-web/src/layouts/BaseLayout.astro (new — html/head/body shell with theme detection and IntersectionObserver)
  - packages/orbiter-web/src/components/SEOHead.astro (new — meta tags, OpenGraph, Twitter cards)
  - packages/orbiter-web/src/styles/global.css (added zenReveal, zenFade, zenScale keyframes)
  - packages/orbiter-web/src/pages/index.astro (updated to use BaseLayout)
- **Learnings for future iterations:**
  - Use `is:inline` on `<script>` tags in Astro for blocking scripts that must run before first paint (theme detection)
  - Theme detection pattern: localStorage → prefers-color-scheme → 'light' fallback, set on `document.documentElement`
  - `data-animate` attribute drives IntersectionObserver animations; value maps to keyframe name (zenReveal, zenFade, zenScale)
  - `prefers-reduced-motion: reduce` must be checked — skip animations and show elements immediately
  - SEOHead as a separate component allows pages to override title/description via props
  - BaseLayout uses `<slot />` for content projection — all pages should wrap content in `<BaseLayout>`
---

## 2026-02-16 20:30 - US-006
- What was implemented: Python FastAPI server foundation for orbiter-web
- Files changed:
  - packages/orbiter-web/pyproject.toml (new — fastapi, uvicorn, aiosqlite deps, hatchling build)
  - packages/orbiter-web/src/orbiter_web/__init__.py (new — package init with __version__)
  - packages/orbiter-web/src/orbiter_web/app.py (new — FastAPI app with GET /api/health endpoint)
  - packages/orbiter-web/src/orbiter_web/config.py (new — Settings dataclass with database_url, secret_key, debug)
  - pyproject.toml (added orbiter-web to workspace members, dev deps, uv.sources, ruff isort)
  - uv.lock (regenerated with orbiter-web + aiosqlite)
- **Learnings for future iterations:**
  - orbiter-web is a hybrid package: package.json for Astro frontend, pyproject.toml for FastAPI backend
  - When adding a workspace package: must update 3 sections in root pyproject.toml (members, dev deps, uv.sources)
  - Use `orbiter_web` (underscore) as Python package name since `orbiter-web` (hyphen) isn't valid Python
  - `hatch.build.targets.wheel.packages` must point to `["src/orbiter_web"]` for the wheel to include the code
  - Settings uses os.getenv in dataclass defaults — simple pattern, no pydantic-settings needed
---

## 2026-02-16 20:33 - US-007
- What was implemented: Dev server script using concurrently to run Astro + FastAPI together, with Vite proxy for /api/* requests
- Files changed:
  - packages/orbiter-web/astro.config.mjs (added vite.server.proxy for /api → http://127.0.0.1:8000)
  - packages/orbiter-web/package.json (added concurrently devDep, dev script uses concurrently, added dev:astro and dev:api scripts)
  - packages/orbiter-web/package-lock.json (updated with concurrently)
- **Learnings for future iterations:**
  - Astro uses Vite under the hood — configure proxies via `vite.server.proxy` in astro.config.mjs, NOT via Astro-specific config
  - Use `uv run uvicorn ...` in npm scripts to ensure the UV venv is active (avoids needing manual venv activation)
  - concurrently with `--names` and `--prefix-colors` makes dual-server output readable
  - uvicorn `--reload` watches Python files for changes; Astro has HMR built-in
---

## 2026-02-16 20:35 - US-008
- What was implemented: Reusable Button component with polymorphic rendering and three variants
- Files changed:
  - packages/orbiter-web/src/components/Button.astro (new — polymorphic button/link with primary, bordered, default variants)
- **Learnings for future iterations:**
  - Astro conditional rendering (`{href ? <a> : <button>}`) is cleaner than dynamic tag approach for polymorphic components
  - Use `[key: string]: any` in Astro Props interface to pass through arbitrary HTML attributes via `{...rest}`
  - Dark mode "just works" for Button because it uses design token colors (bg-dark/text-paper swap automatically)
  - Astro `check` reports unused variables as "hints" (not errors/warnings) — still worth cleaning up
---

## 2026-02-16 20:37 - US-009
- What was implemented: Reusable Card component with polymorphic element tag and hover lift effect
- Files changed:
  - packages/orbiter-web/src/components/Card.astro (new — polymorphic div/article/section with hover lift, border opacity increase, shadow)
- **Learnings for future iterations:**
  - Astro supports polymorphic elements by destructuring a tag prop (`as`) and using `<Tag>` in the template
  - Tailwind arbitrary opacity via bracket notation: `border-dark/[0.08]` for precise control
  - `hover:-translate-y-0.5` gives a subtle 2px lift effect; combine with `hover:shadow-lg` for depth
  - Dark mode works automatically because Card uses design token colors (bg-subtle, border-dark) that swap via CSS vars
---

## 2026-02-16 20:38 - US-010
- What was implemented: Input and Select form components with label, error state, required indicator, and design system styling
- Files changed:
  - packages/orbiter-web/src/components/Input.astro (new — text input with label, error, required, focus ring)
  - packages/orbiter-web/src/components/Select.astro (new — select dropdown with label, options, error, custom chevron)
- **Learnings for future iterations:**
  - Use `appearance-none` on `<select>` to remove browser default arrow, then add a custom SVG chevron via absolute positioning
  - Generate stable-ish IDs with `rest.id || rest.name || random` pattern to link `<label for>` to input
  - Error state uses `border-coral` + `focus:ring-coral/30`; normal state uses `border-dark/[0.08]` + `focus:ring-coral/20`
  - Dark mode works automatically via CSS custom properties (bg-paper, text-dark, border-dark swap)
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 20:40 - US-011
- What was implemented: Badge and Modal components for status indicators and dialogs
- Files changed:
  - packages/orbiter-web/src/components/Badge.astro (new — rounded-full pill with coral, zen-blue, zen-green, default color variants)
  - packages/orbiter-web/src/components/Modal.astro (new — native `<dialog>` overlay with backdrop blur, slide-in animation, close button, click-outside-to-close)
- **Learnings for future iterations:**
  - Use native `<dialog>` element for modals — gives free Escape key closing, focus trapping, and `::backdrop` pseudo-element support
  - `<dialog>` must be opened via `.showModal()` in JS (not just adding `open` attribute) to get overlay/backdrop behavior
  - Use `data-modal-close` attributes with event delegation for close button + backdrop click pattern
  - `backdrop:bg-dark/40 backdrop:backdrop-blur-sm` targets the native `::backdrop` pseudo-element via Tailwind
  - Scoped `<style>` block in Astro for the `@keyframes` keeps animation definition local to the component
  - Modal uses `animate-[modalSlideIn_200ms_ease-out]` Tailwind arbitrary animation syntax for inline keyframe reference
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 20:42 - US-012
- What was implemented: Tabs component with tab navigation and coral accent active indicator, Toast component with success/error/info variants and auto-dismiss, section-divider utility class in global.css
- Files changed:
  - packages/orbiter-web/src/components/Tabs.astro (new — tab navigation with `data-tab` attributes, ARIA roles, coral underline indicator, JS for switching)
  - packages/orbiter-web/src/components/Toast.astro (new — fixed-position alert with variant icons, auto-dismiss via configurable timeout, slide-in/out animations)
  - packages/orbiter-web/src/styles/global.css (added section-divider utility class with gradient border-top line and responsive padding)
- **Learnings for future iterations:**
  - Tabs use `data-tab` and `data-tab-panel` attributes for JS switching; ARIA `role="tab/tablist/tabpanel"` for accessibility
  - Tab active indicator uses `scale-x-0/scale-x-100` with `transition-all` for smooth underline animation
  - Tabs use named slots (`<slot name={tab.id} />`) so consumers pass content as `<div slot="tabId">...</div>`
  - Toast auto-dismiss uses `setTimeout` + slide-out animation via inline `style.animation` assignment, then removes on `animationend`
  - `@keyframes` in scoped `<style>` works for initial animation, but programmatic dismiss needs to reference the keyframe by name in JS
  - section-divider uses `border-image: linear-gradient(...)` for a gradient top-border effect
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 20:46 - US-013
- What was implemented: PageLayout.astro — application shell with collapsible left sidebar navigation
- Files changed:
  - packages/orbiter-web/src/layouts/PageLayout.astro (new — extends BaseLayout, 10 nav sections with inline SVG icons, collapse toggle, localStorage persistence, Cmd+B shortcut)
- **Learnings for future iterations:**
  - SVG icons as inline HTML strings in frontmatter + `set:html` directive avoids needing an icon library dependency
  - `sidebar-label` CSS class used as a JS hook to toggle label visibility; `hidden lg:block` for responsive default, `lg:hidden` added dynamically when collapsed
  - Sidebar collapse state toggled via classList manipulation (`lg:w-60` ↔ `lg:w-16`) rather than CSS custom properties — simpler for Tailwind
  - `data-collapsed` attribute on sidebar tracks state for JS; `localStorage` persists across page loads
  - Cmd+B / Ctrl+B keyboard shortcut dispatches click on toggle button — keeps logic centralized
  - On `< lg` screens, sidebar is always collapsed to icon-only (w-16); labels are `hidden lg:block` by default
  - `getIcon()` helper function must be in Astro frontmatter (between `---` fences), not in template — Astro doesn't support function definitions in template expressions
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 20:50 - US-014
- What was implemented: Top bar with project name, Cmd+K search trigger, theme toggle, and user menu; Breadcrumbs component; mobile bottom tab bar (< md) with 5 key sections; mobile hamburger slide-out menu with full navigation
- Files changed:
  - packages/orbiter-web/src/components/Breadcrumbs.astro (new — accepts items array of {label, href}, renders with chevron separators, last item is plain text)
  - packages/orbiter-web/src/layouts/PageLayout.astro (major update — added top bar header, mobile bottom tab bar, mobile slide-out menu overlay, theme toggle, search Cmd+K shortcut, breadcrumbs prop)
- **Learnings for future iterations:**
  - Desktop sidebar is `hidden md:flex` — hidden on mobile, where bottom tab bar + hamburger menu take over
  - Mobile bottom tab bar shows 5 key sections (projects, agents, workflows, playground, settings) — filtered from full navSections array
  - Mobile slide-out menu uses translateX(-100%) → translateX(0) animation with a backdrop overlay; `void panel.offsetWidth` triggers reflow before animation
  - Theme toggle syncs with BaseLayout's `data-theme` attribute on `<html>` and `localStorage.setItem("theme", ...)` — consistent with BaseLayout's blocking theme detection script
  - Breadcrumbs conditional rendering in Astro JSX needs Fragment wrapper (`<>...</>`) when rendering multiple sibling elements inside `&&`
  - Main content has `pb-16 md:pb-0` to prevent the mobile bottom tab bar from overlapping scrollable content
  - PageLayout now accepts `breadcrumbs` and `projectName` props for flexible usage by consumer pages
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 20:53 - US-015
- What was implemented: SQLite database foundation with aiosqlite connection management, migration system, and initial migrations
- Files changed:
  - packages/orbiter-web/src/orbiter_web/database.py (new — get_db async context manager, run_migrations with _migrations tracking table)
  - packages/orbiter-web/src/orbiter_web/migrations/001_create_users.sql (new — users table with id, email, password_hash, created_at)
  - packages/orbiter-web/src/orbiter_web/migrations/002_create_projects.sql (new — projects table with FK to users, index on user_id)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — added lifespan handler to run migrations on startup)
- **Learnings for future iterations:**
  - aiosqlite.Row row_factory lets you access columns by name — set it in get_db for all queries
  - Use PRAGMA journal_mode=WAL and foreign_keys=ON at connection time for concurrency and referential integrity
  - executescript() runs multiple SQL statements (needed for migration files with multiple statements like CREATE TABLE + CREATE INDEX)
  - Migration files are sorted by filename, so use zero-padded numbering (001_, 002_)
  - FastAPI lifespan context manager replaces deprecated on_event("startup") — use `@asynccontextmanager` that yields once
  - Database URL parsing: config stores SQLAlchemy-style URL (sqlite+aiosqlite:///path), but aiosqlite just needs the file path
---

## 2026-02-16 21:00 - US-017
- What was implemented: Projects UI pages — list page at /projects with card grid, empty state, and create dialog; detail page at /projects/:id with rename and delete actions (with confirmation modal)
- Files changed:
  - packages/orbiter-web/src/pages/projects/index.astro (new — projects list with card grid, empty state, create modal, fetches from /api/projects)
  - packages/orbiter-web/src/pages/projects/[id].astro (new — project detail with metadata, rename modal, delete confirmation modal)
- **Learnings for future iterations:**
  - Use `<template>` elements for client-side card rendering — cloneNode(true) is cleaner than string concatenation
  - `is:inline` scripts in Astro can use `define:vars={{ var: value }}` to pass server-side values to client JS (used for projectId in [id].astro)
  - Dynamic routes in Astro: `[id].astro` extracts `Astro.params.id` — works for SSR/SSG modes
  - Modal.astro's `data-modal-close` event delegation works out of the box for new modals — just pass the modal id
  - `line-clamp-2` Tailwind utility is great for truncating card descriptions to 2 lines
  - Breadcrumb text can be updated client-side by finding spans with "Loading..." text and replacing
  - Fetch API calls to `/api/projects` are proxied via Vite during dev (configured in astro.config.mjs)
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 21:10 - US-018
- What was implemented: Authentication backend — login, logout, me endpoints with bcrypt password hashing, HTTP-only session cookies, and protected route middleware
- Files changed:
  - packages/orbiter-web/pyproject.toml (added bcrypt>=4.0 dependency)
  - packages/orbiter-web/src/orbiter_web/config.py (added session_expiry_hours setting)
  - packages/orbiter-web/src/orbiter_web/migrations/003_create_sessions.sql (new — sessions table with user FK and expiry)
  - packages/orbiter-web/src/orbiter_web/routes/auth.py (new — login/logout/me endpoints, get_current_user dependency)
  - packages/orbiter-web/src/orbiter_web/app.py (registered auth_router)
- **Learnings for future iterations:**
  - bcrypt 5.x provides `hashpw`/`checkpw` directly — no need for passlib wrapper
  - FastAPI `Cookie(None)` parameter extracts named cookie from request; cookie name matches the parameter name
  - `get_current_user` as a FastAPI `Depends()` dependency — reuse across any protected route
  - Ruff B008 flags `Depends()` in function defaults — use `# noqa: B008` for standard FastAPI dependency injection pattern
  - Session expiry checked in SQL: `WHERE s.expires_at > datetime('now')` — no Python datetime comparison needed
  - `response.set_cookie(httponly=True, samesite="lax")` for secure session cookies
  - `_hash_password` and `_verify_password` helpers keep bcrypt encoding details in one place
---

## 2026-02-16 21:15 - US-019
- What was implemented: Login page at /login with email/password form; client-side auth redirect for protected pages; Settings page at /settings with Profile, Appearance, API Keys, and Workspace sections
- Files changed:
  - packages/orbiter-web/src/pages/login.astro (new — standalone login form using BaseLayout, calls POST /api/auth/login, redirects to /projects on success)
  - packages/orbiter-web/src/pages/settings.astro (new — tabbed settings page with Profile (user info + logout), Appearance (light/dark/system theme), API Keys (placeholder), Workspace (default provider + concurrent run limit))
  - packages/orbiter-web/src/layouts/PageLayout.astro (added auth check script — fetches /api/auth/me, redirects to /login on 401)
- **Learnings for future iterations:**
  - Login page uses BaseLayout (not PageLayout) since it's a standalone page without sidebar navigation
  - Auth redirect is in PageLayout so ALL app pages get protection automatically — no per-page auth code needed
  - `fetch("/api/auth/me", { credentials: "same-origin" })` is the client-side auth check pattern — include credentials for cookies
  - Settings tab switching uses `data-settings-tab` attributes + `classList` manipulation — same pattern as Tabs.astro but simpler inline
  - Theme "system" option removes localStorage key and applies `prefers-color-scheme` media query result
  - Workspace settings (default_provider, concurrent_limit) stored in localStorage for now — will migrate to server-side when provider API exists
  - Login form checks `GET /api/auth/me` on load — if already authenticated, redirects to /projects immediately
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 21:30 - US-020
- What was implemented: Provider database schema with encrypted API key storage using Fernet symmetric encryption
- Files changed:
  - packages/orbiter-web/pyproject.toml (added cryptography>=42.0 dependency)
  - packages/orbiter-web/src/orbiter_web/migrations/004_create_providers.sql (new — providers table with CHECK constraint on provider_type, FK to users, index on user_id)
  - packages/orbiter-web/src/orbiter_web/crypto.py (new — Fernet encrypt/decrypt helpers using SHA-256 key derivation from app secret_key)
  - uv.lock (updated with cryptography dependency)
- **Learnings for future iterations:**
  - Fernet requires a 32-byte URL-safe base64-encoded key — derive from secret_key using `hashlib.sha256().digest()` then `base64.urlsafe_b64encode()`
  - SQLite CHECK constraints enforce enum-like values: `CHECK (provider_type IN ('openai', 'anthropic', ...))`
  - `encrypt_api_key()` / `decrypt_api_key()` in `orbiter_web/crypto.py` — use for any sensitive field storage
  - cryptography package was already transitively installed; adding explicit dependency ensures it's always available
---

## 2026-02-16 22:00 - US-021
- What was implemented: Provider CRUD REST API with 6 endpoints (list, create, get, update, delete, test connection)
- Files changed:
  - packages/orbiter-web/src/orbiter_web/routes/providers.py (new — APIRouter with ProviderCreate, ProviderUpdate, ProviderResponse, TestResult Pydantic models, 6 endpoints)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — include providers_router)
  - packages/orbiter-web/pyproject.toml (added httpx>=0.27 dependency for provider connection testing)
  - uv.lock (updated with httpx)
- **Learnings for future iterations:**
  - API keys are encrypted at rest using crypto.py helpers — response model uses `api_key_set: bool` instead of exposing encrypted/plain key
  - `_row_to_response()` pops `encrypted_api_key` from the dict and replaces with `api_key_set` bool — keeps key out of API responses
  - Provider update accepts `api_key` in the body but maps it to `encrypted_api_key` column before building the SET clause
  - Test endpoint uses httpx for async HTTP calls — each provider type has a different lightweight test URL (models listing, tags, etc.)
  - Vertex requires base_url (service account auth), Ollama defaults to localhost:11434, custom providers also need base_url
  - httpx lazy-imported inside the test function to avoid import overhead for CRUD-only usage
  - All provider routes use `get_current_user` dependency for authentication — no more `_DEFAULT_USER_ID`
---

## 2026-02-16 22:30 - US-022
- What was implemented: Settings > Models page UI — replaced placeholder "API Keys" tab with full "Models" tab featuring provider management
- Files changed:
  - packages/orbiter-web/src/pages/settings.astro (major update — added Models tab with provider card list, add/edit/delete modals, test connection button, provider type icons, status indicators)
- **Learnings for future iterations:**
  - Replaced the "API Keys" placeholder tab with "Models" tab — panel ID changed from `panel-api-keys` to `panel-models`
  - Provider cards use `<template>` + `cloneNode(true)` pattern (consistent with projects page)
  - Providers are lazy-loaded: `fetchProviders()` only called when Models tab is first clicked (`providersLoaded` flag)
  - Provider type icons are stored as HTML strings in a JS object and injected via `innerHTML` — same pattern as sidebar icons
  - Status badge shows green dot ("Connected") when `api_key_set: true`, gray dot ("No Key") when false
  - Test connection result auto-hides after 8 seconds via `setTimeout`
  - Edit modal pre-fills all fields from provider data; API key field is blank with placeholder "Leave blank to keep current key"
  - Delete confirmation modal uses a `deleteTargetId` closure variable to track which provider to delete
  - Three modals (add, edit, delete) all use the existing Modal.astro component and `data-modal-close` pattern
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 23:00 - US-023
- What was implemented: Multi-key load balancing backend — provider_keys table, CRUD endpoints, load balancing strategies, auto-failover with cooldown
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/005_create_provider_keys.sql (new — provider_keys table with status, stats, cooldown; ALTER TABLE adds load_balance_strategy to providers)
  - packages/orbiter-web/src/orbiter_web/routes/provider_keys.py (new — APIRouter with key CRUD, strategy get/put, key selection with load balancing, usage reporting for failover)
  - packages/orbiter-web/src/orbiter_web/routes/providers.py (updated — added load_balance_strategy to ProviderResponse)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — registered provider_keys_router)
- **Learnings for future iterations:**
  - SQLite ALTER TABLE only supports ADD COLUMN (no DROP, RENAME, or modify constraints) — put ALTER in same migration as related CREATE TABLE
  - Load balancing key selection filters by status: active keys + rate_limited keys with expired cooldown
  - Round robin strategy: select key with lowest total_requests (natural rotation)
  - LRU strategy: select key with oldest last_used (NULL sorts first, so never-used keys get picked first)
  - Usage reporting endpoint (`POST /keys/:id/report`) updates stats and status: success resets errors, rate_limited sets cooldown, 5+ consecutive errors marks key as invalid
  - `datetime('now', '+' || ? || ' seconds')` for SQLite cooldown calculation
  - Provider keys router shares the `/api/providers` prefix with providers router — FastAPI handles sub-routes correctly
  - `_verify_provider_ownership()` helper avoids repeating the ownership check in every endpoint
---

## 2026-02-16 23:30 - US-024
- What was implemented: Multi-key management UI — expandable keys section on each provider card with key CRUD, health indicators, per-key stats, cooldown timers, and load balancing strategy selector
- Files changed:
  - packages/orbiter-web/src/pages/settings.astro (major update — added key row template, delete key modal, expandable keys section in provider card template with strategy selector + inline add form, JS for key CRUD/rendering/cooldown timers)
- **Learnings for future iterations:**
  - Keys section uses a toggle pattern: "Keys" button shows/hides `.provider-keys-section` inside each provider card
  - Key row template (`key-row-template`) is separate from provider card template — nested templates work with cloneNode(true)
  - Cooldown timers use `setInterval` keyed by key ID in a `cooldownIntervals` object — must clear all on re-render to prevent leaks
  - Strategy update is fire-and-forget (no UI feedback) since it's a lightweight PUT
  - Key stats use compact formatting: `formatTokens()` for 1.2K/1.5M, `formatRelativeTime()` for "5m ago" style
  - Delete key uses same modal pattern as delete provider but with separate state variables (deleteKeyTargetId, deleteKeyProviderId, deleteKeyCardEl)
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 24:00 - US-025
- What was implemented: Model catalog backend — migration for models table, REST API with list/create/discover endpoints
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/006_create_models.sql (new — models table with provider FK, unique constraint on provider_id+model_name, indexes)
  - packages/orbiter-web/src/orbiter_web/routes/models.py (new — APIRouter with GET /api/models (filter by provider_id, provider_type, capability, search), POST /api/models (manual entry), POST /api/providers/:id/discover (auto-discovery from provider API))
  - packages/orbiter-web/src/orbiter_web/app.py (updated — registered models_router)
- **Learnings for future iterations:**
  - Models router uses `/api` prefix (not `/api/models`) to support both `/api/models` and `/api/providers/:id/discover` under one router
  - capabilities stored as JSON string in SQLite, parsed to list in `_row_to_response()`
  - is_custom stored as INTEGER (0/1) in SQLite, converted to bool in response
  - Discover endpoint tries provider-level `encrypted_api_key` first, falls back to `provider_keys` table for active keys
  - Upsert pattern: check existence by (provider_id, model_name) unique constraint, UPDATE if exists else INSERT
  - Provider-specific model listing: OpenAI/Anthropic use `/v1/models` (data array), Gemini uses `/v1beta/models` (models array with "models/" prefix), Ollama uses `/api/tags`
  - httpx lazy-imported inside `_fetch_models_from_provider` (same pattern as provider test endpoint)
  - JOIN with providers table in queries to include provider_name and provider_type in model responses
---

## 2026-02-17 03:10 - US-026
- What was implemented: Model catalog page UI at /models — card grid of all models with provider icons, capability tags, context window, pricing; filters (search, provider dropdown, capability, context window range); per-provider Fetch buttons for model discovery; "Fetch All" button; manual model entry form modal
- Files changed:
  - packages/orbiter-web/src/pages/models.astro (new — full models catalog page with card grid, filters, discover bar, add custom model modal)
- **Learnings for future iterations:**
  - Models page follows same patterns as projects page: `<template>` + `cloneNode(true)` for card rendering, `is:inline` script
  - Provider icons use colored letter badges (O/A/G/V/L/C) with provider-specific bg/text colors
  - Capability tags use per-capability colors: zen-blue for chat, zen-green for embedding, coral for vision, purple for reasoning, amber for code
  - Filter bar uses debounced `onFilterChange` (150ms) to avoid re-rendering on every keystroke
  - Provider bar is populated from `/api/providers` — each provider gets a "Fetch" button that triggers POST `/api/providers/:id/discover`
  - "Fetch All" button iterates over all providers and calls discover in parallel, then refreshes the model list
  - Manual model entry uses checkboxes for capabilities (multi-select) — `formData.getAll("capabilities")` collects all checked values
  - Discover button shows inline success/error feedback with auto-reset after 3-4 seconds
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 03:45 - US-027
- What was implemented: Model comparison view with checkbox selection (2-3 models), floating compare bar, side-by-side comparison modal with difference highlighting; default model dropdown in workspace settings (localStorage) and project detail page (server-side via PUT /api/projects/:id)
- Files changed:
  - packages/orbiter-web/src/pages/models.astro (major update — added compare checkboxes on model cards, floating compare bar, comparison modal with table layout, difference highlighting, max 3 selection with card ring highlight)
  - packages/orbiter-web/src/pages/settings.astro (updated — added "Default Model" dropdown to workspace tab, fetches from /api/models, saved to localStorage as `orbiter_default_model`)
  - packages/orbiter-web/src/pages/projects/[id].astro (updated — replaced static "Default Model" text with dynamic select dropdown populated from /api/models, "Save" button calls PUT /api/projects/:id with default_model)
- **Learnings for future iterations:**
  - Comparison checkbox state must be synced during renderModels() since the grid is rebuilt on filter changes — track selectedForCompare by model ID separately from DOM
  - Max selection enforcement: disable unchecked checkboxes when 3 are already selected, re-enable when one is deselected
  - `data-model-card-id` attribute on card div enables ring highlight for selected cards without re-rendering
  - Difference highlighting in comparison table: collect formatted values, check if all same, apply `bg-coral/5` highlight when values differ
  - Projects table already has `default_model` and `default_provider` columns — no migration needed
  - ProjectUpdate Pydantic model already accepts `default_model` — no backend changes needed
  - Workspace default model uses localStorage (`orbiter_default_model`), project default model uses server-side storage via the projects API
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 04:30 - US-028
- What was implemented: Application schema (migration) and REST API with 7 endpoints (list, create, get, update, delete, duplicate)
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/007_create_applications.sql (new — applications table with type CHECK constraint, FK to projects and users, indexes)
  - packages/orbiter-web/src/orbiter_web/routes/applications.py (new — APIRouter with ApplicationCreate, ApplicationUpdate, ApplicationResponse, 7 endpoints including duplicate)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — registered applications_router)
- **Learnings for future iterations:**
  - Applications route follows same pattern as providers: `get_current_user` dependency, `_verify_ownership` helper for 404 checks
  - Duplicate endpoint copies name with "(Copy)" suffix, type, project_id, config_json — resets status to "draft" (default)
  - `config_json` stored as TEXT (not JSON type) in SQLite — no JSON validation at DB level, just Pydantic string field
  - GET /api/applications supports optional `project_id` query param via `Query(None)` — builds different SQL based on presence
  - Applications have both `project_id` FK (to projects) and `user_id` FK (to users) — ownership check is on user_id
---

## 2026-02-17 05:00 - US-029
- What was implemented: New Application dialog on the project detail page — modal with five type cards (Chatbot, Chatflow, Workflow, Agent, Text Generator), each with icon, description, and use case examples; two-step flow (select type → enter name → create)
- Files changed:
  - packages/orbiter-web/src/pages/projects/[id].astro (updated — added "New Application" button in actions row, New Application modal with 5 type cards grid, name input step, create logic calling POST /api/applications, navigation to builder on success)
- **Learnings for future iterations:**
  - Two-step dialog pattern: show type cards first, then slide to name input — avoids cluttering the type selection with a form
  - Type card selection hides the grid and shows a badge + "Change" link for the selected type — gives a clear undo path
  - Each type has a unique accent color (coral, zen-blue, zen-green, purple-500, amber-500) matching the capability tag colors used on models page
  - `sm:col-span-2` on the last card (Text Generator) makes it full-width in the 2-column grid — cleaner layout with odd number of items
  - Dialog reset function must clear both selectedAppType state and visual selection classes — call on both modal close and "Change" click
  - Enter key on name input delegates to create button click — keeps submit logic centralized
  - After successful creation, navigates to `/applications/{id}` — builder pages will be implemented in later stories
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 05:30 - US-030
- What was implemented: Application list page at /applications with grid/list view toggle, type badges (colored per type), status badges, search filter, type filter, duplicate action on each card, click-to-navigate to builder
- Files changed:
  - packages/orbiter-web/src/pages/applications.astro (new — full applications listing with grid/list views, filters, duplicate modal, type/status badges)
- **Learnings for future iterations:**
  - Grid/list view toggle persisted in localStorage (`orbiter_apps_view`) — set initial view before first render to avoid flash
  - Applications don't have their own sidebar nav entry — they are accessed globally or from project detail pages
  - Project names enriched via a second `/api/projects` fetch after loading apps — creates a projectMap lookup by ID
  - Duplicate button on cards needs `position: relative; z-index: 10` to sit above the full-card `<a>` link overlay
  - Type colors reuse the same scheme from US-029 New Application dialog: coral (chatbot), zen-blue (chatflow), zen-green (workflow), purple (agent), amber (text_generator)
  - `<template>` elements work for both grid cards and list rows — use separate templates for different layouts rather than trying to reuse one
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 06:00 - US-031
- What was implemented: Agent schema (migration) and REST API with 5 endpoints (list, create, get, update, delete)
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/008_create_agents.sql (new — agents table with all AgentConfig fields, FK to projects and users, indexes)
  - packages/orbiter-web/src/orbiter_web/routes/agents.py (new — APIRouter with AgentCreate, AgentUpdate, AgentResponse Pydantic models, 5 CRUD endpoints)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — registered agents_router)
- **Learnings for future iterations:**
  - Agents route follows identical pattern to applications: `get_current_user` dependency, `_verify_ownership` helper, `_row_to_dict` converter
  - AgentConfig fields stored as JSON TEXT columns: output_type_json, tools_json, handoffs_json, hooks_json — no DB-level JSON validation
  - temperature is REAL (float), max_tokens and max_steps are INTEGER — all nullable for optional config
  - Agent belongs to both a project (project_id FK) and a user (user_id FK) — same ownership pattern as applications
---

## 2026-02-17 06:30 - US-032
- What was implemented: Agent builder page at /agents/:id/edit with tabbed form (Basic + Model tabs)
- Files changed:
  - packages/orbiter-web/src/pages/agents/[id]/edit.astro (new — agent builder with tab switching, Basic tab for name/description/instructions, Model tab for provider/model selectors + temperature slider + max_tokens)
- **Learnings for future iterations:**
  - Agent builder uses dynamic route `[id]/edit.astro` — Astro supports nested dynamic segments
  - Provider selector populated from `/api/providers`, model selector from `/api/models?provider_id=X` — cascading dropdowns pattern
  - Agent stores `model_provider` as provider_type string (e.g., "openai"), not provider ID — need `findProviderIdByName()` to resolve on load
  - Model preview shows `providerName:modelName` format string below the selectors
  - Temperature slider uses native `<input type="range">` with `accent-coral` and live numeric display via `input` event
  - Ctrl/Cmd+S keyboard shortcut for save — `e.preventDefault()` blocks browser's default save dialog
  - Tab switching: toggle `hidden` class on panels, swap `border-coral`/`text-dark` on active tab button
  - Save sends only changed fields; PUT /api/agents/:id handles partial updates via `model_dump(exclude_none=True)`
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 07:00 - US-033
- What was implemented: Agent builder Tools and Handoffs tabs — Tools tab with assigned tool list, drag-to-reorder, add tool modal (fetches from /api/tools), remove button; Handoffs tab with assigned handoff list, add handoff modal (fetches project agents from /api/agents), remove button; both saved via PUT /api/agents/:id as tools_json and handoffs_json
- Files changed:
  - packages/orbiter-web/src/orbiter_web/routes/tools.py (new — /api/tools endpoint returning built-in tool catalog with 10 tools across 5 categories)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — registered tools_router)
  - packages/orbiter-web/src/pages/agents/[id]/edit.astro (major update — added Tools and Handoffs tab buttons, tab panels with tool/handoff lists, tool selector modal, handoff agent selector modal, drag-to-reorder for tools, save includes tools_json and handoffs_json)
- **Learnings for future iterations:**
  - Tools tab stores assigned tools as array of {id, name, description, category} objects in tools_json — parsed on load, serialized on save
  - Handoffs tab stores handoff targets as array of {id, name, description} objects in handoffs_json — same pattern
  - Drag-to-reorder uses native HTML5 drag and drop: `draggable="true"`, dragstart/dragover/drop events, splice to move items in the array, then re-render
  - Tool selector modal filters out already-assigned tools from the available tools list
  - Handoff selector modal filters out the current agent (self) and already-assigned handoffs
  - /api/tools returns a static built-in tool catalog (no DB table yet) — will be augmented with user-defined tools later
  - Category icons (retrieval, filesystem, execution, data, utility) stored as SVG HTML strings in a JS object, keyed by category name
  - Modal.astro can be reused for both tool and handoff selectors — just pass different id and title
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 07:45 - US-034
- What was implemented: Agent builder Hooks and Advanced tabs — Hooks tab with 5 HookPoint values (before_model_call, after_model_call, before_tool_call, after_tool_call, on_error) each with function name/path input; Advanced tab with max_steps slider (1-100), output_type JSON Schema textarea with on-blur validation, Memory toggle, Context Engine toggle
- Files changed:
  - packages/orbiter-web/src/pages/agents/[id]/edit.astro (major update — added Hooks and Advanced tab buttons + panels, hook input fields, max_steps slider, output_type textarea with JSON validation, toggle switches, save includes all new fields)
- **Learnings for future iterations:**
  - Hook points are stored as a flat object in hooks_json: `{"before_model_call": "module.func", ...}` — keys are hook point names, values are function references
  - Toggle state (memory, context) stored as meta flags (`_memory_enabled`, `_context_enabled`) inside hooks_json to avoid schema changes — these are not hook points but config flags
  - Toggle switch pattern: `role="switch"` + `aria-checked` + coral bg when on; `.toggle-dot` uses `translate-x-5` for the slide animation
  - JSON validation on blur: `JSON.parse()` in try/catch, show `border-coral` + error message on failure; validate again before save and switch to Advanced tab if invalid
  - Max steps slider uses same pattern as temperature: `input` event updates a `<span>` with current value, `accent-coral` for the range thumb
  - Output type textarea pretty-prints stored JSON on load with `JSON.stringify(JSON.parse(...), null, 2)` for readability
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 08:20 - US-035
- What was implemented: Enhanced system prompt editor on agent builder Basic tab — replaces plain textarea with highlight-overlay editor that colorizes `{{variable_name}}` patterns, a right-side variables panel showing detected variables with type selector (string/number/boolean) and default value input, and a token counter estimating input tokens
- Files changed:
  - packages/orbiter-web/src/pages/agents/[id]/edit.astro (major update — instructions section replaced with highlight-overlay editor, variables panel, token counter; JS added for highlighting, variable extraction, token estimation, scroll sync, resize observer; variable config stored/loaded via hooks_json `_variables` meta flag; scoped CSS for `.prompt-variable` styling)
- **Learnings for future iterations:**
  - Highlight-overlay pattern: transparent-text textarea on z-10 + backdrop div with styled HTML behind it; caret-dark ensures cursor visible while text is transparent
  - Sync backdrop scroll with textarea via `scrollTop`/`scrollLeft` on `scroll` event; use `ResizeObserver` to keep backdrop height in sync with textarea resize
  - `{{variable}}` detection via regex `\{\{(\w+)\}\}/g` — deduplicate names with a seen-set
  - Token estimation: rough ~4 chars/token for English text (Math.ceil(text.length / 4))
  - Variable config (type + defaultValue) stored as `_variables` object inside `hooks_json` meta flags — avoids new DB migration
  - Variables panel uses `lg:w-64 flex-shrink-0` alongside `flex-1 min-w-0` for the editor — responsive side-by-side on lg+, stacked below on mobile
  - Debounce variable panel rendering (200ms) to avoid excessive DOM rebuilds on fast typing; highlighting + token counter update immediately
  - Scoped `<style>` block in Astro for `.prompt-variable` keeps highlighting styles local to the editor page
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 09:00 - US-036
- What was implemented: Prompt template library with save/load/delete, test prompt against models, and import/export as JSON
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/009_create_prompt_templates.sql (new — prompt_templates table with name, content, variables_json, user_id, timestamps)
  - packages/orbiter-web/src/orbiter_web/routes/prompt_templates.py (new — CRUD endpoints + test prompt endpoint that sends to provider APIs)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — registered prompt_templates_router)
  - packages/orbiter-web/src/pages/agents/[id]/edit.astro (major update — added Save/Load/Test/Import/Export buttons above instructions editor, save template modal, load template modal with search+delete, test result panel below editor, import via file input, export as JSON download)
- **Learnings for future iterations:**
  - Template buttons row uses compact `text-[11px]` sizing with subtle bg to stay visually secondary to the main editor
  - Test prompt endpoint reuses provider key resolution pattern from provider test (try provider-level key, fall back to provider_keys table)
  - Test prompt fills `{{variable}}` with default values from detectedVariables, falling back to `[name]` placeholder
  - Import/Export uses FileReader + Blob/URL.createObjectURL for client-side file I/O — no server round-trip needed
  - Load template modal includes inline delete buttons (trash icon) with confirm() dialog — no separate delete modal needed for lightweight items
  - Test result panel sits between editor and variables panel, using `max-h-64 overflow-y-auto` for long outputs
  - Provider-specific API call patterns: OpenAI uses /v1/chat/completions, Anthropic uses /v1/messages with x-api-key header, Gemini uses generateContent with key param, Ollama uses /api/generate
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 10:00 - US-037
- What was implemented: Prompt model comparison and version history — multi-model comparison (send same prompt to 2-3 models in parallel, side-by-side output display with per-model metrics), prompt version history (every template save creates a version), side-by-side diff view between any two versions, restore previous version button
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/010_create_prompt_versions.sql (new — prompt_versions table with template FK, version_number, content, variables_json)
  - packages/orbiter-web/src/orbiter_web/routes/prompt_templates.py (major update — added VersionResponse, CompareRequest/Response Pydantic models, _create_version helper, _send_prompt_to_model shared helper, version CRUD endpoints: list/get/restore, POST /compare endpoint with asyncio.gather for parallel model calls; template create/update auto-creates versions; delete cascades to versions)
  - packages/orbiter-web/src/pages/agents/[id]/edit.astro (major update — added Compare and History buttons next to Test button, model comparison selector modal with 3 provider/model slots, comparison result grid panel, version history modal with checkbox-based diff selection, side-by-side diff view with change highlighting, restore version button, currentTemplateId tracking)
- **Learnings for future iterations:**
  - Refactored _send_prompt_to_model as a shared helper (returns dict with error field on failure instead of raising) — reused by both /test and /compare endpoints
  - asyncio.gather runs parallel API calls for comparison — each model gets its own httpx.AsyncClient
  - Version history diff uses simple line-by-line comparison: same lines plain, different lines highlighted with bg-coral/10 (removed) and bg-zen-green/10 (added)
  - Diff view requires exactly 2 checkboxes selected — when a 3rd is checked, the first selection is automatically unchecked (FIFO rotation)
  - currentTemplateId is set when saving or loading a template — tracked as a JS closure variable for version history API calls
  - Compare result grid uses CSS `grid-template-columns: repeat(N, minmax(0, 1fr))` dynamically set based on the number of models (2 or 3)
  - Restore creates a new version (recording the restore action) and updates the template content — ensures no version history is lost
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 11:10 - US-038
- What was implemented: Role-based agent persona section — collapsible persona panel in agent builder Basic tab with Role, Goal, and Backstory fields; 5 persona templates (Researcher, Writer, Coder, Reviewer, Planner); preview button showing full system prompt with persona injected; persona fields stored in DB via new migration
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/011_add_agent_persona.sql (new — ALTER TABLE adds persona_role, persona_goal, persona_backstory to agents)
  - packages/orbiter-web/src/orbiter_web/routes/agents.py (updated — added persona_role, persona_goal, persona_backstory to AgentCreate, AgentUpdate, AgentResponse models and INSERT query)
  - packages/orbiter-web/src/pages/agents/[id]/edit.astro (major update — added collapsible persona section with toggle, template dropdown, role/goal/backstory fields, preview modal, load/save integration)
- **Learnings for future iterations:**
  - Persona fields stored as top-level DB columns (not inside hooks_json) since they are primary agent config, not meta flags
  - Collapsible section pattern: button toggles `hidden` on content div + rotates chevron via `style.transform`
  - `personaBadge` shows "Set" pill when any persona field has content — gives visual indicator when section is collapsed
  - Persona template dropdown pre-fills all 3 fields at once; selecting "Custom..." doesn't clear fields (user can manually edit after template)
  - Preview builds full prompt with `## Persona` section (Role, Goal, Backstory) prepended before `## Instructions`
  - Auto-expand persona section on load if agent has any persona data (persona_role/goal/backstory non-empty)
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 12:00 - US-039
- What was implemented: AI-assisted agent builder backend — POST /api/agents/ai-generate endpoint that accepts a natural language description and generates agent configuration(s) using a configured LLM provider
- Files changed:
  - packages/orbiter-web/src/orbiter_web/routes/agents.py (major update — added AIGenerateRequest, GeneratedAgentConfig, AIGenerateResponse Pydantic models, _SYSTEM_PROMPT for agent generation, _call_model_for_generation helper with multi-provider support, _parse_generated_config JSON parser with markdown fence stripping and tool validation, POST /ai-generate endpoint with auto-provider discovery and per-type default models)
- **Learnings for future iterations:**
  - AI-generate endpoint placed BEFORE `/{agent_id}` catch-all routes in FastAPI — order matters for path parameter matching; "ai-generate" would be captured as an agent_id otherwise
  - `_call_model_for_generation` follows same pattern as `_send_prompt_to_model` in prompt_templates.py but uses system+user messages (not single user message) for structured output
  - Anthropic API uses separate `system` field (not in messages array) — different from OpenAI's system message format
  - Gemini and Ollama don't support system messages natively — concatenate system + user prompt as single user content
  - `_parse_generated_config` handles three JSON formats: `{"agents": [...]}`, `[...]`, and `{...}` (single agent) — covers common LLM output variations
  - Markdown code fence stripping: check for ``` prefix and strip to first newline (handles ```json), then strip trailing ```
  - Tool validation: filter suggested_tools against known BUILTIN_TOOLS IDs — prevents hallucinated tool names from passing through
  - Auto-provider discovery: query providers with encrypted_api_key or active provider_keys; per-type default models (gpt-4o for openai, claude-sonnet-4-5-20250514 for anthropic, etc.)
  - `model` field in request uses "provider_id:model_name" format for explicit selection, or just model_name for auto-provider resolution
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 13:00 - US-040
- What was implemented: AI-assisted agent builder UI — "AI Builder" button on project detail page, multi-step modal with natural language description input, loading state, review panel with editable fields (name, role, instructions, tools as removable pills, model), confirm button that creates agent via POST /api/agents
- Files changed:
  - packages/orbiter-web/src/pages/projects/[id].astro (major update — added AI Builder button, ai-builder-modal with 3 steps: describe, loading, review; JS for generate/review/create flow)
- **Learnings for future iterations:**
  - AI Builder added as a "bordered" variant button next to "New Application" on project detail page — keeps it visible but secondary
  - Multi-step modal pattern: hide/show step divs (ai-step-describe, ai-step-loading, ai-step-review) within a single Modal component
  - AI-generate API returns `{agents: [...]}` — take first agent for single-agent generation flow
  - Tool pills rendered as removable badges with `&times;` close button; tools stored as simple string array, mapped to `{id, name}` objects on creation
  - Enter key in textarea submits (Shift+Enter for newline) — same pattern as chat inputs
  - After agent creation, navigates to `/agents/:id/edit` so user can further customize
  - generatedTools tracked as a JS array alongside the DOM — re-render on every change (add/remove)
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 14:00 - US-041
- What was implemented: Xyflow React island setup — React 19 + @xyflow/react installed, @astrojs/react integration added, CanvasIsland.tsx component with ReactFlowProvider and dark mode sync, workflow canvas page
- Files changed:
  - packages/orbiter-web/package.json (added react@19, react-dom@19, @xyflow/react, @astrojs/react)
  - packages/orbiter-web/package-lock.json (updated)
  - packages/orbiter-web/astro.config.mjs (added @astrojs/react integration)
  - packages/orbiter-web/tsconfig.json (added jsx: react-jsx, jsxImportSource: react)
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (new — ReactFlowProvider wrapper, CanvasFlow with dark mode sync via MutationObserver on data-theme)
  - packages/orbiter-web/src/pages/workflows/canvas.astro (new — workflow canvas page using PageLayout + CanvasIsland with client:only="react")
- **Learnings for future iterations:**
  - React islands in Astro: use `client:only="react"` for components that need browser-only APIs (ReactFlow uses DOM extensively)
  - @astrojs/react integration: add to `integrations` array in astro.config.mjs, and set `jsx: "react-jsx"` + `jsxImportSource: "react"` in tsconfig.json
  - ReactFlow `colorMode` prop accepts "light", "dark", or "system" — sync with app theme via MutationObserver on `document.documentElement.dataset.theme`
  - Canvas needs full-height container: use `!overflow-hidden flex flex-col` on PageLayout's class + `flex-1 min-h-0` wrapper div
  - ReactFlow CSS must be imported in the component: `import "@xyflow/react/dist/style.css"`
  - `useThemeColorMode()` custom hook: watches `data-theme` attribute mutations to keep ReactFlow colorMode in sync with the app's theme toggle
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 14:30 - US-042
- What was implemented: Canvas pan, zoom, grid, and minimap — added MiniMap component (pannable + zoomable), dot-pattern Background, snap-to-grid with configurable 20px grid size
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (updated — added MiniMap, BackgroundVariant.Dots, snapToGrid/snapGrid props, GRID_SIZE constant)
- **Learnings for future iterations:**
  - ReactFlow pan (click-drag) and zoom (mouse wheel) work out of the box — no additional props needed
  - `BackgroundVariant.Dots` with matching `gap={GRID_SIZE}` aligns dot pattern with snap grid
  - MiniMap accepts `pannable` and `zoomable` props for interactive navigation; `position="bottom-right"` places it via ReactFlow's built-in positioning
  - `snapGrid` type is `[number, number]` tuple — explicit type annotation needed for TypeScript
  - Background `size` prop controls dot radius (1.5 is a subtle, non-intrusive dot size)
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 15:00 - US-043
- What was implemented: Canvas toolbar and keyboard shortcuts — replaced built-in `<Controls />` with custom `<Panel>` toolbar at top-center with zoom in/out, fit view, lock/unlock toggle, undo/redo buttons; implemented undo/redo history stack with ref-based past/future arrays (max 50 entries); keyboard shortcuts for Delete (remove selected), Cmd+Z (undo), Cmd+Shift+Z (redo), Cmd+A (select all); tooltips on all buttons showing keyboard shortcut hints with Mac/Windows detection
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (major rewrite — added Panel-based toolbar, useUndoRedo hook, ToolbarButton component, SVG icons, keyboard shortcut handler, lock/unlock state, platform-aware shortcut labels)
- **Learnings for future iterations:**
  - ReactFlow `<Panel position="top-center">` positions custom UI inside the flow viewport — use `className="nodrag nopan"` on interactive elements to prevent canvas drag/pan
  - Undo/redo uses ref-based history stacks (useRef) instead of state to avoid re-render loops; a `skipRecord` flag prevents recording when restoring state
  - `structuredClone()` for deep-copying nodes/edges in history snapshots — handles nested objects correctly
  - Record history before structural changes only (add/remove), not on position changes (drag) — check `change.type` in onNodesChange/onEdgesChange
  - Lock toggle disables `nodesDraggable`, `nodesConnectable`, `elementsSelectable`, `panOnDrag`, `zoomOnScroll`, `zoomOnPinch`, `zoomOnDoubleClick` all at once
  - `useReactFlow()` provides `zoomIn()`, `zoomOut()`, `fitView()` with optional `duration` param for smooth animation
  - Platform detection for shortcut labels: `navigator.userAgent` test for Mac → use ⌘ symbol, otherwise "Ctrl+"
  - Keyboard shortcuts must check `e.target.tagName` to avoid intercepting when user is typing in input/textarea
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 23:05 - US-044
- What was implemented: Canvas state persistence — workflows table, CRUD API, load/save in CanvasIsland
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/012_create_workflows.sql (new — workflows table with nodes_json, edges_json, viewport_json columns)
  - packages/orbiter-web/src/orbiter_web/routes/workflows.py (new — CRUD API: list, create, get, update, delete)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — registered workflows_router)
  - packages/orbiter-web/src/pages/workflows/[id].astro (new — dynamic route passing workflowId to CanvasIsland)
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (updated — added workflowId prop, useAutoSave hook, load on mount, debounced save, viewport tracking)
- **Learnings for future iterations:**
  - Canvas state stored as JSON TEXT columns: nodes_json, edges_json, viewport_json — parse on load, stringify on save
  - Workflow CRUD follows same pattern as applications route (APIRouter, Pydantic models, _verify_ownership helper)
  - CanvasIsland accepts optional workflowId prop — without it, works as standalone canvas (backwards compatible)
  - Use `useAutoSave` hook pattern: debounced save with `savingRef` to prevent concurrent saves
  - Track viewport via `onMoveEnd` callback from ReactFlow — stores {x, y, zoom} in ref
  - When loading saved viewport, use `setViewport()` from `useReactFlow()` and disable `fitView` prop
  - `loaded` state gate prevents auto-save from firing during initial load (avoids saving empty state)
  - React.MutableRefObject is deprecated in newer React types — use React.RefObject instead
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 23:30 - US-045
- What was implemented: Node sidebar with 9 categorized node types — collapsible left panel inside the canvas with drag-to-add support, search filter, per-category color accents, and distinct SVG icons for each of the 28 node types
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/NodeSidebar.tsx (new — sidebar component with NODE_CATEGORIES catalog, category expand/collapse, drag start handler, search filter)
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (updated — added NodeSidebar import, sidebar collapse state, onDragOver/onDrop handlers, screenToFlowPosition for accurate node placement)
- **Learnings for future iterations:**
  - NodeSidebar uses absolute positioning inside ReactFlow container (not a Panel) — gives more control over full-height layout
  - `className="nodrag nopan nowheel"` on sidebar root prevents ReactFlow from capturing drag/pan/scroll events on the sidebar
  - Drag-and-drop from sidebar to canvas: set `application/reactflow-type` and `application/reactflow-label` in dataTransfer, read in onDrop handler
  - `screenToFlowPosition()` from useReactFlow converts screen coordinates to flow coordinates — essential for accurate node drop placement
  - Category colors use CSS hex with alpha suffix for hover bg (e.g., `${color}18`) and icon bg (e.g., `${color}20`)
  - NODE_CATEGORIES exported for reuse (e.g., color lookup in CanvasIsland drop handler)
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 23:40 - US-046
- What was implemented: Node drag-and-drop and search — enhanced sidebar search to also match category names (not just node type labels). All other acceptance criteria (drag from sidebar, drop at position, search input, real-time filtering) were already implemented in US-045.
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/NodeSidebar.tsx (updated — filteredCategories now matches against cat.label in addition to node type t.label; if category matches, all its types are shown)
- **Learnings for future iterations:**
  - Category-level search match: if search term matches the category label, show ALL types in that category (don't filter individual types)
  - This is a one-line logic change: check `cat.label.toLowerCase().includes(q)` before filtering individual types
  - US-045 already implemented most of US-046's acceptance criteria (drag-to-add, search input, real-time filtering) — always check existing code before starting
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 04:45 - US-047
- What was implemented: Node configuration panel shell — right-side slide-in panel that opens when a node is clicked on the canvas, with editable node name, category/type display, node ID, and placeholder for type-specific config fields
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/NodeConfigPanel.tsx (new — slide-in panel with name editing, type info display, auto-save debounce, Escape/X close)
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (updated — added selectedNodeId state, onNodeClick/onPaneClick handlers, handleNodeDataUpdate callback, NodeConfigPanel integration, panel-aware delete)
- **Learnings for future iterations:**
  - NodeConfigPanel uses absolute positioning inside ReactFlow (same as NodeSidebar) with `className="nodrag nopan nowheel"` to prevent canvas interaction
  - Slide-in animation via inline `<style>` tag with `@keyframes slideInRight` — works in React islands
  - Config panel debounce (500ms) is separate from auto-save debounce — panel debounces calling onNodeUpdate, which then triggers the existing useAutoSave via nodes state change
  - When deleting nodes, must check if the deleted node is the one shown in the config panel and close it
  - `getNodeTypeInfo()` looks up NODE_CATEGORIES to display category color, icon, and label for any node type
  - Panel closes on: X button click, Escape key, clicking empty canvas (onPaneClick)
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 - US-048
- What was implemented: LLM Call and Agent node configuration panels in the workflow canvas — LlmCallConfig component with provider/model cascading dropdowns, prompt textarea with {{variable}} preview, temperature slider, max_tokens input, response format selector; AgentNodeConfig component with agent selector from /api/agents, "Create Inline" option with simplified inline agent form (name, provider, model, instructions, tool checkboxes); integrated into NodeConfigPanel via renderTypeConfig dispatcher
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/LlmCallConfig.tsx (new — LLM Call node config with provider/model selectors, prompt, temperature, max_tokens, response_format)
  - packages/orbiter-web/src/islands/Canvas/AgentNodeConfig.tsx (new — Agent node config with existing agent selector or inline agent form)
  - packages/orbiter-web/src/islands/Canvas/NodeConfigPanel.tsx (updated — added renderTypeConfig dispatcher, scheduleDataUpdate callback, imports for LlmCallConfig and AgentNodeConfig)
- **Learnings for future iterations:**
  - Type-specific configs rendered via a `renderTypeConfig()` dispatcher function that pattern-matches on `node.data.nodeType`
  - Config components receive `data` (extracted from node.data) and `onChange` (merges updates back) — keeps them decoupled from ReactFlow internals
  - `scheduleDataUpdate` is separate from `scheduleUpdate` (name-only) — both share the same `debounceRef` to avoid racing updates
  - Agent config uses a mode switch: `inline: false` shows agent dropdown, `inline: true` shows simplified inline form — "Create Inline" is a special option value `__create_inline__`
  - Provider→Model cascading: fetch models when provider changes via `useEffect` on selectedProvider; disable model dropdown when no provider selected
  - Prompt {{variable}} preview uses regex replace to inject styled spans, rendered via `dangerouslySetInnerHTML` in a preview div below the textarea
  - Both `agent_node` and `sub_agent` types share the same AgentNodeConfig component (via `AGENT_TYPES` Set)
  - Non-configured node types still show the gear icon placeholder with "coming soon" message
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 - US-049
- What was implemented: Conditional, Code, and HTTP Request node configuration panels for the workflow canvas
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/ConditionalConfig.tsx (new — condition expression editor with monospace textarea, true/false labeled output handle editors with colored T/F badges, handle guide info box)
  - packages/orbiter-web/src/islands/Canvas/CodeNodeConfig.tsx (new — Python/JavaScript language toggle, syntax-highlighted code editor with line numbers using highlight overlay pattern, Tab key indentation, entry function input, timeout setting)
  - packages/orbiter-web/src/islands/Canvas/HttpRequestConfig.tsx (new — method dropdown with colored method names, URL input, collapsible key-value headers editor with add/remove, body textarea for POST/PUT, auth selector with bearer/basic/api_key modes, timeout)
  - packages/orbiter-web/src/islands/Canvas/NodeConfigPanel.tsx (updated — added imports and renderTypeConfig dispatcher cases for conditional, code_python, code_javascript, http_request node types)
- **Learnings for future iterations:**
  - Node config components follow a consistent pattern: `data` prop (typed interface), `onChange` callback that merges updates; same shared style constants (labelStyle, inputStyle, selectStyle, focusHandlers)
  - `CODE_TYPES` Set pattern (like `AGENT_TYPES`) groups `code_python` and `code_javascript` into a single config component with `initialLanguage` prop
  - Syntax highlighting in code editor uses the same highlight-overlay pattern from the agent prompt editor (transparent textarea on top, styled HTML below)
  - Python/JS keyword highlighting via regex replacement chain: comments → strings → numbers → keywords; order matters to avoid double-highlighting
  - Tab key handling in textarea: `e.preventDefault()` + string splice + `requestAnimationFrame` to restore cursor position after React re-render
  - HTTP method colors (GET=green, POST=blue, PUT=amber, DELETE=red) follow REST API convention colors
  - Headers key-value editor uses indexed array manipulation — updateHeader/removeHeader take the array index
  - Auth type selector clears all auth fields on type change to avoid stale data leaking between auth modes
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 05:00 - US-050
- What was implemented: Knowledge Retrieval node configuration panel — select knowledge base dropdown (fetches from /api/knowledge-bases), top-k slider (1-20), similarity threshold slider (0.0-1.0), inline validation errors, required field asterisks, info box with dynamic parameter display
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/KnowledgeRetrievalConfig.tsx (new — KnowledgeRetrievalConfig component with KB dropdown, top-k and similarity sliders, validation, info box)
  - packages/orbiter-web/src/islands/Canvas/NodeConfigPanel.tsx (updated — added import and renderTypeConfig case for knowledge_retrieval node type)
- **Learnings for future iterations:**
  - Knowledge Retrieval config follows same pattern as other node configs: data prop + onChange callback, shared style constants
  - Knowledge base dropdown gracefully handles missing /api/knowledge-bases endpoint — shows "No knowledge bases available" with helpful hint
  - Validation uses `touched` state to avoid showing errors before user interaction — set on first dropdown change
  - Error state uses separate `errorSelectStyle` with `borderColor: coral` override on the select style object
  - Sliders use `accent-color` CSS property (via inline style `accentColor`) for the coral theme — works in modern browsers
  - Info box at the bottom shows dynamic parameter values (top-k count and threshold) to help users understand their config
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 - US-051
- What was implemented: Edge connections with typed, color-coded handles for workflow canvas nodes
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/handleTypes.ts (new — HandleDataType, HANDLE_COLORS, HandleSpec, getHandlesForNodeType with per-node-type handle maps)
  - packages/orbiter-web/src/islands/Canvas/WorkflowNode.tsx (new — custom React Flow node with color-coded input/output handles and labels)
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (updated — registered workflow nodeType, typed BezierEdge, handle color lookup, migration for saved workflows)
- **Learnings for future iterations:**
  - Custom node types in React Flow: define outside component, register via `nodeTypes` prop on `<ReactFlow>`; same for `edgeTypes`
  - BezierEdge from @xyflow/react can be wrapped to inject custom stroke color via style prop
  - Handle positioning: use percentage `top` values on the Handle `style` prop; distribute evenly from 45%-90% for multi-handle nodes
  - When loading saved workflows, migrate `type: "default"` nodes to `type: "workflow"` and add edge color data to avoid breaking older saves
  - Handle type definitions are static per nodeType — no need to store in DB; computed at render time from `getHandlesForNodeType()`
  - Conditional nodes have special handles: `output-true` and `output-false` with labels "True"/"False"
- Edge type validation: `areTypesCompatible()` in handleTypes.ts — "any" matches everything, otherwise types must match exactly
- Custom SVG edges: use `getBezierPath()` + `<path>` elements (not `<BezierEdge>`) when needing hover labels or animation overlays
- CSS injection pattern: `document.createElement('style')` with ID guard at module level for React island CSS that can't go through Astro's build
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 23:36 - US-052
- What was implemented: Edge type validation, animated edges, hover labels, and conditional branch colors
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/handleTypes.ts (added `areTypesCompatible()` function and `BRANCH_COLORS` constant)
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (replaced BezierEdge with custom SVG edge: type-aware `isValidConnection`, animated dashed overlay, hover label with data type, CSS keyframe injection)
  - packages/orbiter-web/src/islands/Canvas/WorkflowNode.tsx (added `getHandleColor()` helper for branch-colored conditional handles)
- **Learnings for future iterations:**
  - `getBezierPath()` from @xyflow/react returns `[edgePath, labelX, labelY]` — use for custom SVG edge rendering with hover labels
  - ReactFlow `isValidConnection` callback receives `Edge | Connection` — use it to prevent incompatible handle type connections
  - For edge hover detection, layer a transparent wide stroke (16px) path behind the visible edge
  - CSS keyframe animations can be injected via `document.createElement('style')` at module load time with an ID guard to prevent duplicates
  - Conditional node handles use `BRANCH_COLORS` (green/red) distinct from data-type colors — check `h.label` for "True"/"False" to select
  - `foreignObject` in SVG allows React-rendered HTML labels on edges; use `pointerEvents: "none"` to prevent blocking mouse events
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 - US-053
- What was implemented: Completed workflow REST API — added `version` column migration, export endpoint (POST /:id/export with Content-Disposition), and import endpoint (POST /import with JSON validation)
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/013_add_workflow_version.sql (new — ALTER TABLE adds version column)
  - packages/orbiter-web/src/orbiter_web/routes/workflows.py (added WorkflowImport model, version field to WorkflowResponse, export/import endpoints, moved /import before /{workflow_id} routes)
- **Learnings for future iterations:**
  - FastAPI route order matters: static paths like `/import` must be defined before parameterized paths like `/{workflow_id}` to avoid capture
  - Export endpoint uses JSONResponse with Content-Disposition header for downloadable JSON
  - Import endpoint validates JSON fields (nodes_json, edges_json, viewport_json) with json.loads before insertion
  - The existing CRUD (list, create, get, update, delete) was already in place from earlier canvas work — only export/import and version column were missing
---

## 2026-02-16 - US-054
- What was implemented: Workflow auto-save with 2s debounce, save status indicator (Saved/Saving.../Unsaved changes), manual save via Cmd+S shortcut and toolbar Save button, editable workflow metadata header (name + description)
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (updated — useAutoSave hook with SaveStatus tracking + saveNow(), save button + status indicator in toolbar, Cmd+S keyboard shortcut, metadata header with inline editing, saveMetadata debounced callback)
- **Learnings for future iterations:**
  - SaveStatus type tracks three states: "saved", "saving", "unsaved" — set "unsaved" on scheduleSave, "saving" on fetch start, "saved"/"unsaved" based on response
  - `saveNow()` flushes pending debounce timer and calls save immediately — used by Cmd+S and toolbar button
  - Metadata header sits above ReactFlow in a flex column layout — must wrap ReactFlow in a `flex: 1; min-height: 0` div to prevent overflow
  - Metadata editing uses click-to-toggle between display and input mode; saves with 800ms debounce separate from canvas auto-save
  - Save status color coding: green for saved, muted for saving, coral for unsaved — matches zen design tokens
  - Changed auto-save debounce from 500ms to 2000ms per acceptance criteria
---

## 2026-02-16 - US-055
- What was implemented: Workflow list page at /workflows with card grid, status badges, node counts, last run timestamps; export button on each workflow card (list page) and in canvas toolbar (detail page); import button with file picker, schema validation, and project selector modal; duplicate workflow action via POST /api/workflows/:id/duplicate endpoint
- Files changed:
  - packages/orbiter-web/src/pages/workflows/index.astro (new — workflow list page with grid/list views, search, status filter, import modal, duplicate modal, export action)
  - packages/orbiter-web/src/orbiter_web/routes/workflows.py (added POST /:id/duplicate endpoint with "(Copy)" suffix)
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (added export icon + export button in toolbar, exportWorkflow callback)
- **Learnings for future iterations:**
  - Workflow list follows same patterns as applications.astro: `<template>` + `cloneNode(true)`, view toggle persisted in localStorage, project name enrichment via second fetch
  - Node count parsed client-side from `nodes_json` via `JSON.parse()` — no need for a separate DB column
  - Export on list page uses POST /api/workflows/:id/export (returns JSON), then constructs Blob + download link client-side
  - Import flow: file picker → FileReader → validate JSON has nodes_json/edges_json → show preview → select project → POST /api/workflows/import
  - Duplicate endpoint follows applications pattern: copy all fields except id/timestamps, append "(Copy)" to name
  - Canvas toolbar export button added alongside save — uses same icons object pattern
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-16 - US-056
- What was implemented: Relationships mode for workflow canvas — Shift+click a node to highlight its data flow graph with upstream (zen-blue) and downstream (zen-green) tinting, coral accent on the selected root node, and 20% opacity fade on unrelated nodes/edges
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (added relationships-mode CSS, relationshipNodeId state, computeRelationships BFS helper, displayNodes/displayEdges memos with className injection, Shift+click handler, pane click exits mode)
  - packages/orbiter-web/src/islands/Canvas/WorkflowNode.tsx (added _relTint data prop, tint-aware border and box-shadow rendering for root/upstream/downstream nodes)
- **Learnings for future iterations:**
  - ReactFlow applies `className` from node/edge data to the wrapper DOM elements — use `.react-flow__node.rel-highlighted` CSS to override parent opacity
  - BFS traversal on edges needs two passes: one following edges backward (target→source) for upstream, one forward (source→target) for downstream
  - `useMemo` for displayNodes/displayEdges avoids re-computing on every render; depends on `[nodes, relationships, relationshipNodeId]`
  - Shift+click detection via `_event.shiftKey` in onNodeClick — toggling same node exits relationships mode
  - CSS `opacity` transitions on `.react-flow__node` and `.react-flow__edge` give smooth fade effect when entering/exiting relationships mode
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 00:00 - US-057
- What was implemented: Canvas real-time validation — validation engine (missing config, disconnected inputs, cycle detection, unreachable nodes), visual decorations on WorkflowNode (yellow warning badge, red dots on disconnected handles, dashed border for unreachable), validation summary panel with click-to-navigate, toolbar toggle button with issue count badge
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/validation.ts (new — validateWorkflow(), cycle detection via DFS, reachability from triggers via BFS, disconnected input detection, missing config checks)
  - packages/orbiter-web/src/islands/Canvas/ValidationPanel.tsx (new — collapsible bottom-left panel with issue list, severity icons, click-to-navigate via fitView)
  - packages/orbiter-web/src/islands/Canvas/WorkflowNode.tsx (updated — added _missingConfig, _unreachable, _disconnectedInputs data props; yellow "!" badge top-right, red dot + glow on disconnected handles, dashed border for unreachable)
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (updated — imported validation + panel, 1s debounced validation via useEffect, injected validation decorations into displayNodes/displayEdges, cycle-edge CSS class, validation toolbar button with count badge, navigateToNode callback)
- **Learnings for future iterations:**
  - Validation data injected into node.data via `_` prefixed props (_missingConfig, _unreachable, _disconnectedInputs) — same pattern as _relTint for relationships mode
  - Cycle detection uses DFS with white/gray/black coloring — gray → gray back edge means cycle; trace path edges for full cycle marking
  - Unreachable nodes determined by BFS forward from trigger types (chat_input, webhook, schedule, manual) — nodes not reached get dashed border
  - `fitView({ nodes: [{ id }], padding: 0.5, duration: 400 })` centers viewport on a specific node — used for click-to-navigate from validation panel
  - Validation result stored as React state and injected into displayNodes/displayEdges useMemo — no extra renders needed
  - CSS class `.cycle-edge` with `stroke: #ef4444 !important` overrides edge color for cycle edges
  - Validation panel uses absolute positioning inside ReactFlow (like NodeSidebar) with `className="nodrag nopan nowheel"`
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 01:00 - US-058
- What was implemented: Chat WebSocket endpoint at ws://api/playground/{agent_id}/chat with streaming token delivery for OpenAI, Anthropic, Gemini, and Ollama providers
- Files changed:
  - packages/orbiter-web/src/orbiter_web/routes/playground.py (new — WebSocket endpoint with auth via session cookie, agent loading, provider/key resolution, per-provider streaming functions)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — registered playground_router)
- **Learnings for future iterations:**
  - WebSocket auth: FastAPI WebSocket doesn't use `Depends()` — manually extract session cookie via `websocket.cookies.get("orbiter_session")` and validate before `websocket.accept()`
  - Close with custom codes (4001 for auth, 4004 for not found) before accept to cleanly reject unauthorized connections
  - httpx streaming: use `client.stream("POST", url, json=body)` + `resp.aiter_lines()` for SSE parsing from provider APIs
  - Ruff SIM117: combine nested `async with` statements into single `async with A as a, B as b:` form
  - OpenAI SSE: lines prefixed with `data: `, terminal `data: [DONE]`; chunks have `choices[0].delta.content`
  - Anthropic SSE: `content_block_delta` events with `delta.text`, `message_start` for input tokens, `message_delta` for output tokens
  - Gemini SSE: use `?alt=sse` query param for SSE mode; chunks have `candidates[0].content.parts[].text` and `usageMetadata`
  - Ollama streaming: NDJSON (not SSE) — parse each line as JSON, content in `message.content`, final chunk has `done: true` with eval counts
  - Conversation history maintained in-memory per WebSocket connection; future stories (US-061) will persist to DB
  - Provider lookup: agent stores `model_provider` as type string (e.g., "openai"), need `_find_provider_by_type()` to resolve to provider_id
---

## 2026-02-17 - US-059
- What was implemented: Full-screen chat playground interface at /playground — agent selector dropdown, streaming chat via WebSocket, message bubbles with user (right-aligned, bg-subtle) and agent (left-aligned with avatar), token-by-token display, auto-resize textarea, clear conversation button, connection status feedback
- Files changed:
  - packages/orbiter-web/src/pages/playground.astro (new — full chat playground page with agent selector, message rendering, WebSocket management, auto-resize input)
  - packages/orbiter-web/astro.config.mjs (added ws: true to Vite proxy config for WebSocket support)
- **Learnings for future iterations:**
  - Vite proxy needs `ws: true` to forward WebSocket connections — without it, only HTTP /api requests are proxied
  - WebSocket URL construction: use `location.protocol === "https:" ? "wss:" : "ws:"` + `location.host` for protocol-agnostic URLs
  - Streaming chat pattern: start agent message bubble on send, append tokens to it, finalize on "done" message; track state with `isStreaming` flag
  - Auto-resize textarea: set `height: auto` first, then `height = Math.min(scrollHeight, maxHeight)` on every input event
  - `is:inline` script with `define:vars` for passing icon HTML from frontmatter to JS (botIconHtml, userIconHtml)
  - Clear conversation reconnects WebSocket to reset server-side in-memory conversation history
  - Disable input + send button during streaming to prevent overlapping requests
  - Token usage displayed as small metadata below agent messages when provided by the "done" WebSocket event
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 - US-060
- What was implemented: Chat message features — markdown rendering in agent responses (via `marked` library), copy message button on hover for all messages, scroll-to-bottom button when user scrolls up, improved auto-scroll behavior
- Files changed:
  - packages/orbiter-web/src/pages/playground.astro (rewritten — switched from `is:inline` to module `<script>` for `marked` import, added markdown rendering on stream finish, copy buttons with clipboard API, scroll-to-bottom button, improved scroll tracking)
  - packages/orbiter-web/src/styles/global.css (added `.chat-prose` styles for markdown — headings, code blocks, lists, tables, blockquotes, links, hr)
  - packages/orbiter-web/package.json (added `marked` dependency)
- **Learnings for future iterations:**
  - Markdown rendered only on stream finish (not during streaming) for performance — `textContent` during streaming, `innerHTML` with `marked.parse()` on finishStream
  - Switched from `is:inline define:vars` to module `<script>` to enable npm imports — icons are now inline HTML strings in the script instead of passed via `define:vars`
  - `.chat-prose` class resets whitespace-pre-wrap and applies prose-like styles; Tailwind v4 doesn't include `@tailwindcss/typography`, so custom prose styles needed
  - Copy button uses `navigator.clipboard.writeText()` with check icon feedback; positioned absolute within `group` container for hover reveal
  - Scroll-to-bottom button: track `userScrolledUp` boolean, show button when not near bottom (80px threshold), reset on send/clear
  - Messages area wrapped in `relative flex-1` container with `absolute inset-0` inner div to properly contain overflow — fixes scroll area sizing
  - `marked` library is ~7KB gzipped, lightweight enough for playground use; configured with `breaks: true` and `gfm: true`
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 00:30 - US-061
- What was implemented: Conversation persistence — messages saved to DB after each exchange, conversations can be loaded to restore full chat history
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/014_create_conversations.sql (new — conversations + messages tables with indexes)
  - packages/orbiter-web/src/orbiter_web/routes/conversations.py (new — REST API for listing, getting, deleting conversations and listing messages)
  - packages/orbiter-web/src/orbiter_web/routes/playground.py (updated — persistence helpers, _TokenCollector wrapper, save messages during chat)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — register conversations_router)
  - packages/orbiter-web/src/pages/playground.astro (updated — handle conversation_created/loaded events, restoreMessages, addRestoredAgentMessage)
- **Learnings for future iterations:**
  - _TokenCollector pattern: wraps WebSocket to intercept send_json calls and collect streamed tokens without modifying all 4 provider streaming functions
  - Conversation is created lazily on first real message (not on WebSocket connect) to avoid empty conversations
  - System prompt is saved as first message in conversation to ensure full history reconstruction
  - `load_conversation` is sent as a special message type after WebSocket open, before regular chat messages
  - `conversation_loaded` response includes full messages array for client-side rendering
  - ruff format reformats `async with` statements to use parenthesized context managers
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 00:30 - US-062
- What was implemented: Collapsible trace panel shell in the playground page
- Files changed:
  - packages/orbiter-web/src/pages/playground.astro (added trace panel HTML, toggle logic, Cmd+I shortcut, expandable trace entries)
- **Learnings for future iterations:**
  - Trace panel uses flex layout alongside chat column — `flex flex-1 min-h-0` wrapper with `min-w-0` on chat column for proper flex shrinking
  - Panel toggle: `hidden` class + state variable; button highlights with `text-coral` when panel is open
  - Cmd+I / Ctrl+I shortcut: listen on `document`, use `e.metaKey || e.ctrlKey` for cross-platform
  - TraceEntry interface stores id, timestamp, usage, and contentPreview (truncated to 120 chars)
  - Chevron expand/collapse pattern: swap innerHTML between CHEVRON_RIGHT and CHEVRON_DOWN SVGs
  - Trace entries are cleared when chat is cleared (via `clearTraceEntries()` in `clearMessages()`)
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 00:31 - US-063
- What was implemented: Tool call, model call, and reasoning trace display in playground trace panel
- Files changed:
  - packages/orbiter-web/src/orbiter_web/routes/playground.py (enhanced all 4 streaming functions to send tool_call, reasoning events + enriched done event with model, finish_reason, latency_ms)
  - packages/orbiter-web/src/pages/playground.astro (revamped trace panel: collapsible model call section, tool calls with JSON args, reasoning section, finish reason badges, error display, latency tracking)
- **Learnings for future iterations:**
  - OpenAI tool call deltas accumulate across chunks — index-keyed dict pattern for reassembly
  - Anthropic content_block_start/stop lifecycle: tool_use blocks emit name on start, input_json_delta chunks accumulate, emit tool_call on block_stop
  - Anthropic thinking blocks: content_block_start type=thinking, thinking_delta deltas, emit reasoning event on block_stop
  - Gemini function calls arrive as `functionCall` parts within candidates
  - `stream_options: {"include_usage": true}` needed for OpenAI to send usage in streaming mode
  - `time.monotonic()` for latency — more reliable than `time.time()` for short durations
  - `makeCollapsibleSection()` helper creates reusable expand/collapse sections with icon + title + chevron toggle
  - Finish reason badge styles mapped via FINISH_REASON_STYLES dict — covers stop/end_turn/tool_calls/length/content_filter/SAFETY across providers
  - pendingToolCalls + pendingReasoning pattern: accumulate trace data from WS events between messages, consume on `done` event
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 01:00 - US-064
- What was implemented: Token usage and cost estimation in trace panel — per-message cost estimates, cumulative conversation token/cost summary, and /api/costs/pricing endpoint
- Files changed:
  - packages/orbiter-web/src/orbiter_web/routes/costs.py (new — GET /api/costs/pricing returns model pricing data from models+providers tables)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — registered costs_router)
  - packages/orbiter-web/src/pages/playground.astro (enhanced — added pricing fetch, calcCost() helper, cumulative summary bar in trace panel header, per-message cost display in trace entries and below chat messages)
- **Learnings for future iterations:**
  - Pricing lookup matches model_name from the `done` WebSocket event against models table pricing_input/pricing_output ($/1K tokens)
  - Cost formatting: use 4 decimal places for <$0.01, 2 decimal places otherwise
  - Cumulative summary in trace panel header uses a grid layout for clean alignment (Total Tokens, In/Out, Est. Cost)
  - Cost badge shown in trace entry header alongside finish_reason badge — small rounded pill with tabular-nums
  - `resetCumulativeSummary()` called from `clearTraceEntries()` ensures totals reset when conversation is cleared
  - `loadPricing()` is non-critical — wrapped in try/catch with empty fallback so missing pricing degrades gracefully
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 - US-065
- What was implemented: Multi-model comparison mode for the playground
  - Compare mode toggle button in playground header
  - Model picker bar with add/remove chip UI (2–4 models from /api/models)
  - New WebSocket endpoint `/api/playground/compare/chat` that accepts multiple model configs and streams responses in parallel via asyncio.gather, each tagged with `model_index`
  - Side-by-side response columns with per-column streaming, markdown rendering, and user/agent message bubbles
  - Per-model metrics footer: latency (ms), token counts (in/out), cost estimate
  - Thumbs up/down rating buttons per response column
  - JSON export button that downloads full comparison history with ratings
  - `_IndexedCollector` class wraps WebSocket to prefix all messages with `model_index`
  - `_stream_for_model()` helper dispatches to existing provider streaming functions
- Files changed:
  - packages/orbiter-web/src/orbiter_web/routes/playground.py (added compare endpoint + helpers)
  - packages/orbiter-web/src/pages/playground.astro (added compare mode UI + ~350 lines of JS)
- **Learnings for future iterations:**
  - Compare mode uses a separate WebSocket (`/api/playground/compare/chat`) rather than the agent-specific one — no agent required, models are passed directly in the message
  - `asyncio.gather(*tasks, return_exceptions=True)` streams all models in parallel through a single WebSocket; each message tagged with `model_index`
  - Astro frontmatter variables are NOT available inside `<script>` tags — need to re-declare SVG strings in the script section
  - Compare columns use `data-*` attributes for DOM queries (e.g., `data-response-area="0"`, `data-col-footer="1"`) — fast and clean for dynamic column management
  - Rating state stored in `compareHistory` array — persists across multiple prompt rounds within the same session
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 - US-066
- What was implemented: Voice input (SpeechRecognition) and text-to-speech (SpeechSynthesis) for playground chat
- Files changed:
  - packages/orbiter-web/src/pages/playground.astro (added mic button, TTS toggle, voice/TTS JS logic ~130 lines)
  - packages/orbiter-web/src/styles/global.css (added pulseDot animation keyframes)
- **Learnings for future iterations:**
  - Web Speech API types (SpeechRecognition, SpeechRecognitionEvent, SpeechRecognitionErrorEvent) are not in Astro's default TS lib — use `any` types for event params
  - Access SpeechRecognition via `(window as any).SpeechRecognition || (window as any).webkitSpeechRecognition` for cross-browser support
  - interimResults=true shows live transcription as user speaks; final results fire on recognition.onend
  - TTS: strip markdown before speaking — regex chain handles code blocks, links, bold/italic, headers
  - speechSynthesis.cancel() before speaking prevents overlapping utterances
  - Mic button enable/disable must be synced with WS open/close events (same as messageInput and sendBtn)
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 - US-067
- What was implemented: Thread schema and REST API with migration and 6 endpoints
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/015_create_threads.sql (new — threads + thread_messages tables)
  - packages/orbiter-web/src/orbiter_web/routes/threads.py (new — ThreadCreate, ThreadResponse, ThreadMessageResponse models, 6 endpoints)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — include threads_router)
- **Learnings for future iterations:**
  - Threads are separate from conversations — threads table has `first_message_preview`, `message_count`, `total_tokens`, `total_cost` metadata columns
  - Thread messages use `thread_messages` table (separate from conversations' `messages` table) — CASCADE delete on thread removal
  - Search endpoint (`/search`) must be defined BEFORE `/{thread_id}` route to avoid FastAPI matching "search" as a thread_id parameter
  - `Query(min_length=1)` and `Query(default=50, ge=1, le=200)` don't trigger ruff B008 (function call in default arg) — only `Depends()` does; don't add unnecessary `# noqa: B008` comments
  - Pagination pattern: use `limit` + `offset` query params with sensible defaults (50/0) and validation constraints
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 01:05 - US-068
- What was implemented: Thread sidebar UI for the playground page — toggleable left sidebar listing conversation threads, thread search, create/delete threads, thread metadata bar, delete confirmation dialog
- Files changed:
  - packages/orbiter-web/src/pages/playground.astro (updated — added thread sidebar HTML, thread toggle button, metadata bar, delete dialog, and ~270 lines of thread management JavaScript)
- **Learnings for future iterations:**
  - Thread sidebar integrates with existing thread REST API (GET /api/threads, POST /api/threads, DELETE /api/threads/:id, GET /api/threads/:id/messages, GET /api/threads/search)
  - Thread sidebar is toggled via "Threads" button in top bar — hidden by default, loads threads when opened
  - Thread list re-renders on agent change (when sidebar is open) and uses debounced search input (300ms)
  - Delete confirmation uses native `<dialog>` element with `.showModal()` — consistent with HTML5 dialog pattern, no external modal library needed
  - `formatRelativeTime()` handles UTC dates from server by appending "Z" to the date string
  - Thread items show hover-visible delete button using Tailwind group-hover pattern (`opacity-0 group-hover:opacity-100`)
  - When switching to a thread, messages are loaded via REST API and rendered using existing `addUserMessage`/`addRestoredAgentMessage` helpers
  - Manual browser verification needed (no browser testing tool available)
---

## 2026-02-17 01:15 - US-069
- What was implemented: Workflow execution engine backend with topological sort DAG runner, REST endpoints, and WebSocket streaming
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/016_create_workflow_runs.sql (new — workflow_runs + workflow_run_logs tables)
  - packages/orbiter-web/src/orbiter_web/engine.py (new — topological_sort, execute_workflow, cancel_run, _execute_node stub)
  - packages/orbiter-web/src/orbiter_web/routes/workflow_runs.py (new — POST /:id/run, DELETE /:id/runs/:runId, WS /:id/runs/:runId/stream)
  - packages/orbiter-web/src/orbiter_web/app.py (updated — registered workflow_runs_router)
- **Learnings for future iterations:**
  - Workflow execution uses Kahn's algorithm for topological sort, grouping nodes into layers for parallel execution within each layer
  - Engine uses `asyncio.Event` for cooperative cancellation — checked between layers
  - Background tasks from `asyncio.create_task` must be stored in a set to prevent garbage collection (ruff RUF006)
  - WebSocket endpoint has two modes: if run is "pending" it starts execution with a callback, if already "running" it falls back to DB polling (0.3s interval)
  - Node execution is stubbed (`_execute_node`) — returns simulated output; real implementations will be added in future stories
  - `contextlib.suppress(Exception)` is preferred over `try/except pass` (ruff SIM105)
  - `workflow_runs_router` registered before `workflows_router` in app.py since both share `/api/workflows` prefix — more specific paths matched first
---

## 2026-02-17 01:15 - US-070
- What was implemented: Workflow execution visualization — real-time canvas feedback during workflow runs
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (execution state hook, WebSocket connection, toolbar play/stop buttons, execution status bar, edge animation, CSS pulse animation)
  - packages/orbiter-web/src/islands/Canvas/WorkflowNode.tsx (execution status badges: green checkmark overlay for completed, red X for failed, coral pulsing border for running nodes)
- **Learnings for future iterations:**
  - `useWorkflowExecution` hook manages full lifecycle: POST to start run → WebSocket for live events → cancel via DELETE
  - Execution node statuses are injected via `_execStatus` data prop (same pattern as `_relTint`, `_missingConfig` etc.)
  - Edge animation between completed→running nodes uses the existing `animated` data prop on TypedBezierEdge
  - CSS `exec-running` class with `execPulse` keyframe animation is applied via `className` on the ReactFlow node wrapper (not inline styles)
  - Execution status bar uses ReactFlow `<Panel position="bottom-center">` — same pattern as toolbar and validation panel
  - WebSocket URL constructed from `window.location.protocol` + `window.location.host` to support both http/https
  - Elapsed timer uses `setInterval` with 1s tick — cleaned up on unmount and on run completion
  - Missing config badge is hidden during execution to avoid overlap with execution status badges
---

## 2026-02-17 - US-071
- What was implemented: Node inspection backend — per-node execution data storage and retrieval API
- Files changed:
  - packages/orbiter-web/src/orbiter_web/migrations/017_add_node_execution_fields.sql (new — adds input_json, logs_text, token_usage_json to workflow_run_logs)
  - packages/orbiter-web/src/orbiter_web/engine.py (updated — _execute_node captures type-specific logs/token_usage; engine stores input_json, logs_text, token_usage_json in DB)
  - packages/orbiter-web/src/orbiter_web/routes/workflow_runs.py (updated — new GET /{workflow_id}/runs/{run_id}/nodes/{node_id} endpoint)
  - prd.json (updated — US-071 passes: true)
- **Learnings for future iterations:**
  - workflow_run_logs table serves as the node_executions table — extended with ALTER TABLE rather than creating a new table
  - _execute_node returns optional `logs` and `token_usage` keys — engine pops these before storing output_json, stores them in separate columns
  - Node input is captured from node.data at execution start (input_json column)
  - JSON fields (input_json, output_json, token_usage_json) are parsed in the API response for convenience
  - LLM nodes store prompt+response in logs_text; Code nodes store stdout/stderr; API nodes store request/response
---

## 2026-02-17 01:30 - US-072
- What was implemented: Node inspection UI — clicking a node after workflow execution opens a tabbed inspection panel showing Input, Output, Logs, and Timing data
- Files changed:
  - packages/orbiter-web/src/islands/Canvas/NodeInspectionPanel.tsx (new — tabbed panel with Input, Output, Logs, Timing tabs; fetches from GET /api/workflows/:id/runs/:runId/nodes/:nodeId)
  - packages/orbiter-web/src/islands/Canvas/CanvasIsland.tsx (updated — imports NodeInspectionPanel, adds inspectedNodeId state, shows inspection panel when clicking executed nodes, hasExecutionData flag)
  - prd.json (updated — US-072 passes: true)
- **Learnings for future iterations:**
  - Post-execution node clicks use `exec.nodeStatuses[node.id]` to determine if a node has execution data — only executed nodes open the inspection panel
  - `hasExecutionData` flag = `exec.runId !== null && !isRunning` — ensures panel only shows after execution completes
  - Inspection panel is 340px wide (slightly wider than config panel's 300px) to accommodate JSON blocks
  - JsonBlock component includes copy-to-clipboard button and uses pre+monospace for formatted JSON display
  - Tabs use the node's category color for the active tab underline indicator
  - InputTab/OutputTab/LogsTab/TimingTab handle null data gracefully with italic placeholder text
  - For LLM nodes, LogsTab shows prompt and response separately extracted from input_json/output_json
  - inspectedNodeId and selectedNodeId are mutually exclusive — clicking an executed node sets inspected and clears selected, and vice versa
---
