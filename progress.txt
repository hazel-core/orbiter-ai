# Ralph Progress Log
Started: Thu Feb 19 11:52:28 PM IST 2026
---

## Codebase Patterns
- orbiter-web tests are in packages/orbiter-web/tests/ (not src/)
- subprocess.run(text=True) applies universal newline translation (\r → \n), so don't assert literal \r in captured stdout
- pyright has ~170 pre-existing errors in orbiter-web; check only modified files for new errors
- Use repr() (not json.dumps()) for embedding arbitrary strings in Python source code literals
- Route handlers that do `from module import func` inside the function body: patch at the source module (e.g., `orbiter_web.engine.execute_workflow`), not at the router module
- Use `starlette.testclient.TestClient` with a minimal FastAPI app for synchronous HTTP-level route tests; no pytest-asyncio marks needed
- `_make_get_db(*rows)` pattern: create an `@asynccontextmanager` that yields a mock db and returns rows sequentially for each `db.execute()` call

---

## 2026-02-20 - US-006
- Updated all 3 call sites that resolve callable instructions to use `asyncio.iscoroutinefunction(raw_instr)` instead of calling and checking `asyncio.iscoroutine(result)`
- Files changed:
  - packages/orbiter-core/src/orbiter/agent.py (agent.run(): changed to iscoroutinefunction pattern; updated instructions type annotation from `Callable[..., str]` to `Callable[..., Any]`)
  - packages/orbiter-core/src/orbiter/runner.py (stream() resolver: changed to iscoroutinefunction pattern)
  - packages/orbiter-core/src/orbiter/_internal/call_runner.py (call_runner result messages resolver: changed to iscoroutinefunction pattern)
  - packages/orbiter-core/tests/test_agent.py (added test_async_callable_instructions)
- **Learnings for future iterations:**
  - `asyncio.iscoroutinefunction(fn)` checks the function itself before calling it — cleaner than calling and checking `asyncio.iscoroutine(result)`; both work but the latter unnecessarily calls async functions in a fire-and-forget way
  - Agent `instructions` type annotation must be `Callable[..., Any]` (not `Callable[..., str]`) to accept async callables returning `Coroutine[Any, Any, str]`
  - There are 3 call sites for instruction resolution: agent.py `run()`, runner.py `stream()`, and _internal/call_runner.py result message building
---

## 2026-02-19 - US-002
- In `_validate_startup()` in `app.py`: added RuntimeError when `debug=False` and `secret_key == 'change-me-in-production'`; kept warning log when in debug mode
- Added inline comment to `config.py` on the `secret_key` field: `# Override via ORBITER_SECRET_KEY — MUST change in production`
- Files changed:
  - packages/orbiter-web/src/orbiter_web/app.py (_validate_startup: warning → RuntimeError in production)
  - packages/orbiter-web/src/orbiter_web/config.py (added inline comment on secret_key)
  - packages/orbiter-web/tests/test_startup.py (new file with 3 tests)
- **Learnings for future iterations:**
  - `_validate_startup()` is called from `lifespan()` at startup — mocking `settings` and `_DB_PATH` is the cleanest way to test it
  - The `or not settings.secret_key` branch was split out so empty-key stays as warning while default-key raises in production
  - `patch("orbiter_web.app.settings")` patches the settings object used inside app.py (not the one imported at test time)
---

## 2026-02-20 - US-003
- Added `hmac.compare_digest()` token validation to `trigger_webhook()` in `routes/webhooks.py`
- Added `url_token: str | None = Query(default=None)` parameter to the handler
- Token check runs after 404 check but before enabled check; returns 403 with `{"detail": "Invalid token"}` on mismatch or missing token
- Created `packages/orbiter-web/tests/test_webhooks.py` with 3 tests: missing token → 403, wrong token → 403, correct token → 200
- Files changed:
  - packages/orbiter-web/src/orbiter_web/routes/webhooks.py (added `import hmac`, `url_token` param, validation block)
  - packages/orbiter-web/tests/test_webhooks.py (new file)
- **Learnings for future iterations:**
  - `can_start_run` and `execute_workflow` are imported inside the function body in `trigger_webhook` — patch at source (`orbiter_web.services.run_queue.can_start_run`, `orbiter_web.engine.execute_workflow`)
  - `starlette.testclient.TestClient` with a minimal FastAPI app handles async route handlers synchronously — no asyncio setup needed
  - `_append_request_log` makes additional `get_db()` calls that need to be included in the mock row sequence
---

## 2026-02-20 - US-004
- Removed the log line that emitted the raw password reset token (`logger.info("Password reset token for %s: %s", body.email, token)`) from `forgot_password()` in `routes/auth.py:389`
- Replaced with `logger.debug("Password reset email sent to %s", body.email)` — email only, no token
- Grepped entire orbiter-web package for other logger calls emitting tokens, session IDs, or raw credentials — no others found
- Created `packages/orbiter-web/tests/test_auth_reset.py` with 2 tests: token absent from logs, email present in debug log
- Files changed:
  - packages/orbiter-web/src/orbiter_web/routes/auth.py (line 388-389: remove token log, add email-only debug)
  - packages/orbiter-web/tests/test_auth_reset.py (new file)
- **Learnings for future iterations:**
  - `caplog.at_level(logging.DEBUG, logger="orbiter_web")` captures debug logs for the `orbiter_web` logger in tests
  - Use `re.compile(UUID_PATTERN).search(record.message)` to assert no UUID token appears in any log record
  - The `forgot_password` route makes 2 `get_db()` calls: SELECT user by email, then INSERT password_resets
---

## 2026-02-20 - US-005
- Rewrote `AgentService.stream_agent()` in `orbiter-web/services/agent_runtime.py` to use `orbiter_run.stream()` (from `orbiter.runner`) instead of calling `provider.stream()` directly
- The full agent tool loop now runs during streaming: LLM tool calls are executed and results fed back before re-streaming
- Added `from orbiter.runner import run as orbiter_run` and `TextEvent, Usage, UsageEvent` imports at module level
- Yields `StreamChunk` objects for backward compat: `TextEvent` → `StreamChunk(delta=...)`, final chunk has `finish_reason="stop"` + accumulated usage
- Updated `test_stream_agent` to mock `orbiter_run.stream` via `patch("orbiter_web.services.agent_runtime.orbiter_run", mock_run)`
- Added `test_stream_agent_executes_tools`: real Agent with a real tool + mock provider that first returns tool_call_deltas, then text; asserts tool was invoked
- Files changed:
  - packages/orbiter-web/src/orbiter_web/services/agent_runtime.py (stream_agent rewrite + new imports)
  - packages/orbiter-web/tests/test_agent_runtime.py (updated test_stream_agent, added test_stream_agent_executes_tools)
- **Learnings for future iterations:**
  - `orbiter.runner.run.stream` is the high-level streaming API; it handles tool loop, hooks, and event emission
  - Patch `orbiter_web.services.agent_runtime.orbiter_run` to mock `run.stream` in tests (it's imported as `orbiter_run` at module level)
  - `run.stream(detailed=True)` emits `UsageEvent` — without `detailed=True`, no usage is available
  - `StreamChunk(tool_call_deltas=[...])` chunks accumulate in `_stream()`; absence of `tc_acc` entries means no tool loop iteration
---

## 2026-02-19 - US-001
- Replaced manual `.replace()`-based escaping in `_build_runner_script()` with `repr()` serialization of the user code string
- The repr() approach handles \r, \t, \0, null bytes, \u0041, embedded triple-quotes, and any other special characters safely
- Files changed:
  - packages/orbiter-web/src/orbiter_web/services/sandbox.py (line 87: escaped_code → code_repr = repr(code); line 152: f-string uses {code_repr})
  - packages/orbiter-web/tests/test_sandbox.py (new file with 6 tests)
- **Learnings for future iterations:**
  - The old code used single-quote embedding `_user_code = '{escaped_code}'` which was vulnerable to any char that breaks out of single-quote context
  - repr() produces a valid Python literal for any string (uses b-prefix or escape sequences as needed)
  - subprocess.run(text=True) normalizes \r to \n — don't test for literal \r in captured stdout
---
