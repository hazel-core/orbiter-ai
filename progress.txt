# Ralph Progress Log
Started: Thu Feb 19 11:52:28 PM IST 2026
---

## Codebase Patterns
- orbiter-web tests are in packages/orbiter-web/tests/ (not src/)
- subprocess.run(text=True) applies universal newline translation (\r → \n), so don't assert literal \r in captured stdout
- pyright has ~170 pre-existing errors in orbiter-web; check only modified files for new errors
- Use repr() (not json.dumps()) for embedding arbitrary strings in Python source code literals

---

## 2026-02-19 - US-002
- In `_validate_startup()` in `app.py`: added RuntimeError when `debug=False` and `secret_key == 'change-me-in-production'`; kept warning log when in debug mode
- Added inline comment to `config.py` on the `secret_key` field: `# Override via ORBITER_SECRET_KEY — MUST change in production`
- Files changed:
  - packages/orbiter-web/src/orbiter_web/app.py (_validate_startup: warning → RuntimeError in production)
  - packages/orbiter-web/src/orbiter_web/config.py (added inline comment on secret_key)
  - packages/orbiter-web/tests/test_startup.py (new file with 3 tests)
- **Learnings for future iterations:**
  - `_validate_startup()` is called from `lifespan()` at startup — mocking `settings` and `_DB_PATH` is the cleanest way to test it
  - The `or not settings.secret_key` branch was split out so empty-key stays as warning while default-key raises in production
  - `patch("orbiter_web.app.settings")` patches the settings object used inside app.py (not the one imported at test time)
---

## 2026-02-19 - US-001
- Replaced manual `.replace()`-based escaping in `_build_runner_script()` with `repr()` serialization of the user code string
- The repr() approach handles \r, \t, \0, null bytes, \u0041, embedded triple-quotes, and any other special characters safely
- Files changed:
  - packages/orbiter-web/src/orbiter_web/services/sandbox.py (line 87: escaped_code → code_repr = repr(code); line 152: f-string uses {code_repr})
  - packages/orbiter-web/tests/test_sandbox.py (new file with 6 tests)
- **Learnings for future iterations:**
  - The old code used single-quote embedding `_user_code = '{escaped_code}'` which was vulnerable to any char that breaks out of single-quote context
  - repr() produces a valid Python literal for any string (uses b-prefix or escape sequences as needed)
  - subprocess.run(text=True) normalizes \r to \n — don't test for literal \r in captured stdout
---
