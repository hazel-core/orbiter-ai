---
import PageLayout from "../../layouts/PageLayout.astro";

const breadcrumbs = [
  { label: "Settings", href: "/settings" },
  { label: "Audit Log" },
];

/* Icons */
const chevronRight = '<svg class="h-4 w-4 transition-transform duration-150" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>';
const filterIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>';
---

<PageLayout
  title="Audit Log"
  description="Track who did what on the platform"
  activeSection="settings"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-5xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Audit Log</h1>
        <p class="text-sm text-muted mt-1">Security event history — admin only</p>
      </div>
      <button
        type="button"
        id="toggle-filters"
        class="inline-flex items-center gap-2 text-sm px-3 py-2 rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/5 transition-colors cursor-pointer"
      >
        <span set:html={filterIcon} />
        Filters
      </button>
    </div>

    <!-- Filter bar -->
    <div id="filter-bar" class="hidden mb-6 rounded-xl bg-subtle/80 border border-dark/[0.08] p-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="flex flex-col gap-1.5">
          <label for="filter-user" class="text-xs font-medium text-muted uppercase tracking-wide">User</label>
          <select
            id="filter-user"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer"
          >
            <option value="">All users</option>
          </select>
        </div>
        <div class="flex flex-col gap-1.5">
          <label for="filter-action" class="text-xs font-medium text-muted uppercase tracking-wide">Action</label>
          <select
            id="filter-action"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer"
          >
            <option value="">All actions</option>
          </select>
        </div>
        <div class="flex flex-col gap-1.5">
          <label for="filter-entity-type" class="text-xs font-medium text-muted uppercase tracking-wide">Entity Type</label>
          <select
            id="filter-entity-type"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer"
          >
            <option value="">All types</option>
          </select>
        </div>
        <div class="flex flex-col gap-1.5">
          <label class="text-xs font-medium text-muted uppercase tracking-wide">Date Range</label>
          <div class="flex gap-2">
            <input
              type="date"
              id="filter-date-from"
              class="flex-1 bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="From"
            />
            <input
              type="date"
              id="filter-date-to"
              class="flex-1 bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="To"
            />
          </div>
        </div>
      </div>
      <div class="flex justify-end mt-4 gap-2">
        <button
          type="button"
          id="clear-filters"
          class="text-sm px-3 py-1.5 rounded-lg text-muted hover:text-dark hover:bg-dark/5 transition-colors cursor-pointer"
        >
          Clear
        </button>
        <button
          type="button"
          id="apply-filters"
          class="text-sm px-4 py-1.5 rounded-lg bg-dark text-paper hover:bg-dark/90 transition-colors cursor-pointer font-medium"
        >
          Apply
        </button>
      </div>
    </div>

    <!-- Loading state -->
    <div id="audit-loading" class="text-sm text-muted py-8 text-center">Loading audit log...</div>

    <!-- Table -->
    <div id="audit-table-wrap" class="hidden rounded-xl bg-subtle/80 border border-dark/[0.08] overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-dark/[0.08] bg-subtle">
              <th class="w-8 px-4 py-3"></th>
              <th class="text-left text-xs font-medium text-muted uppercase tracking-wide py-3 pr-4">Timestamp</th>
              <th class="text-left text-xs font-medium text-muted uppercase tracking-wide py-3 px-4">User</th>
              <th class="text-left text-xs font-medium text-muted uppercase tracking-wide py-3 px-4">Action</th>
              <th class="text-left text-xs font-medium text-muted uppercase tracking-wide py-3 px-4">Entity Type</th>
              <th class="text-left text-xs font-medium text-muted uppercase tracking-wide py-3 px-4">Entity ID</th>
              <th class="text-left text-xs font-medium text-muted uppercase tracking-wide py-3 pl-4">IP Address</th>
            </tr>
          </thead>
          <tbody id="audit-tbody" class="divide-y divide-dark/[0.04]"></tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div id="pagination-bar" class="hidden border-t border-dark/[0.08] px-4 py-3 flex items-center justify-between">
        <span id="pagination-info" class="text-xs text-muted"></span>
        <button
          type="button"
          id="load-more-btn"
          class="text-sm px-4 py-1.5 rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/5 transition-colors cursor-pointer"
        >
          Load more
        </button>
      </div>
    </div>

    <!-- Empty state -->
    <div id="audit-empty" class="hidden flex flex-col items-center py-12 text-center">
      <p class="text-sm text-muted">No audit log entries found.</p>
      <p class="text-xs text-muted/60 mt-1">Try adjusting your filters or check back later.</p>
    </div>
  </div>
</PageLayout>

<script is:inline>
  /** @type {{ id: string; email: string }[]} */
  let userMap = [];
  let nextCursor = null;
  let totalCount = 0;
  let loadedCount = 0;

  const tbody = document.getElementById("audit-tbody");
  const loading = document.getElementById("audit-loading");
  const tableWrap = document.getElementById("audit-table-wrap");
  const empty = document.getElementById("audit-empty");
  const paginationBar = document.getElementById("pagination-bar");
  const paginationInfo = document.getElementById("pagination-info");
  const loadMoreBtn = document.getElementById("load-more-btn");
  const toggleFiltersBtn = document.getElementById("toggle-filters");
  const filterBar = document.getElementById("filter-bar");
  const applyBtn = document.getElementById("apply-filters");
  const clearBtn = document.getElementById("clear-filters");

  const filterUser = document.getElementById("filter-user");
  const filterAction = document.getElementById("filter-action");
  const filterEntityType = document.getElementById("filter-entity-type");
  const filterDateFrom = document.getElementById("filter-date-from");
  const filterDateTo = document.getElementById("filter-date-to");

  /* -- Helpers -- */

  function formatTimestamp(iso) {
    try {
      const d = new Date(iso + "Z");
      return d.toLocaleString(undefined, {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
    } catch {
      return iso;
    }
  }

  function emailForUser(userId) {
    const found = userMap.find((u) => u.id === userId);
    return found ? found.email : userId;
  }

  function escapeHtml(str) {
    const d = document.createElement("div");
    d.textContent = str;
    return d.innerHTML;
  }

  /* -- Expandable row -- */

  function createRow(entry) {
    const tr = document.createElement("tr");
    tr.className = "hover:bg-dark/[0.02] cursor-pointer transition-colors";
    tr.innerHTML = `
      <td class="px-4 py-3 text-muted expand-chevron">${'<svg class="h-4 w-4 transition-transform duration-150" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>'}</td>
      <td class="py-3 pr-4 text-dark whitespace-nowrap">${escapeHtml(formatTimestamp(entry.created_at))}</td>
      <td class="py-3 px-4 text-dark">${escapeHtml(emailForUser(entry.user_id))}</td>
      <td class="py-3 px-4"><span class="inline-block px-2 py-0.5 text-xs font-medium rounded-full bg-dark/[0.06] text-dark">${escapeHtml(entry.action)}</span></td>
      <td class="py-3 px-4 text-muted">${entry.entity_type ? escapeHtml(entry.entity_type) : '<span class="text-muted/40">—</span>'}</td>
      <td class="py-3 px-4 text-muted font-mono text-xs">${entry.entity_id ? escapeHtml(entry.entity_id.slice(0, 8)) : '<span class="text-muted/40">—</span>'}</td>
      <td class="py-3 pl-4 text-muted font-mono text-xs">${entry.ip_address ? escapeHtml(entry.ip_address) : '<span class="text-muted/40">—</span>'}</td>
    `;

    // Detail row (hidden by default)
    const detailTr = document.createElement("tr");
    detailTr.className = "hidden";
    const detailTd = document.createElement("td");
    detailTd.colSpan = 7;
    detailTd.className = "px-4 py-4 bg-subtle/40";

    const detailContent = entry.details
      ? `<pre class="text-xs text-dark/80 bg-paper rounded-lg p-3 border border-dark/[0.06] overflow-x-auto max-h-64">${escapeHtml(JSON.stringify(entry.details, null, 2))}</pre>`
      : '<p class="text-xs text-muted">No additional details.</p>';

    detailTd.innerHTML = `
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-3 text-xs">
        <div><span class="text-muted">Full ID:</span> <span class="font-mono text-dark">${escapeHtml(entry.id)}</span></div>
        <div><span class="text-muted">User ID:</span> <span class="font-mono text-dark">${escapeHtml(entry.user_id)}</span></div>
        <div><span class="text-muted">Entity ID:</span> <span class="font-mono text-dark">${entry.entity_id || "—"}</span></div>
        <div><span class="text-muted">IP:</span> <span class="font-mono text-dark">${entry.ip_address || "—"}</span></div>
      </div>
      <p class="text-xs text-muted mb-2 font-medium">Details</p>
      ${detailContent}
    `;
    detailTr.appendChild(detailTd);

    tr.addEventListener("click", () => {
      const isOpen = !detailTr.classList.contains("hidden");
      detailTr.classList.toggle("hidden");
      const chevron = tr.querySelector(".expand-chevron svg");
      if (chevron) {
        chevron.style.transform = isOpen ? "" : "rotate(90deg)";
      }
    });

    return [tr, detailTr];
  }

  /* -- Fetch data -- */

  function buildQueryString(cursor) {
    const params = new URLSearchParams();
    if (filterUser.value) params.set("user_id", filterUser.value);
    if (filterAction.value) params.set("action", filterAction.value);
    if (filterEntityType.value) params.set("entity_type", filterEntityType.value);
    if (filterDateFrom.value) params.set("date_from", filterDateFrom.value);
    if (filterDateTo.value) params.set("date_to", filterDateTo.value);
    if (cursor) params.set("cursor", cursor);
    params.set("limit", "20");
    return params.toString();
  }

  async function fetchAuditLog(append) {
    if (!append) {
      nextCursor = null;
      loadedCount = 0;
      tbody.innerHTML = "";
    }

    const qs = buildQueryString(append ? nextCursor : null);
    try {
      const res = await fetch(`/api/v1/audit-log?${qs}`);
      if (!res.ok) throw new Error("Failed to load audit log");
      const body = await res.json();
      const entries = body.data || [];
      totalCount = body.pagination.total;
      nextCursor = body.pagination.next_cursor;

      entries.forEach((entry) => {
        const [row, detail] = createRow(entry);
        tbody.appendChild(row);
        tbody.appendChild(detail);
      });

      loadedCount += entries.length;

      loading.classList.add("hidden");

      if (loadedCount === 0) {
        tableWrap.classList.add("hidden");
        empty.classList.remove("hidden");
      } else {
        tableWrap.classList.remove("hidden");
        empty.classList.add("hidden");
      }

      // Pagination
      if (nextCursor) {
        paginationBar.classList.remove("hidden");
        loadMoreBtn.classList.remove("hidden");
      } else {
        loadMoreBtn.classList.add("hidden");
      }
      if (loadedCount > 0) {
        paginationBar.classList.remove("hidden");
        paginationInfo.textContent = `Showing ${loadedCount} of ${totalCount} entries`;
      }
    } catch (err) {
      loading.classList.add("hidden");
      empty.classList.remove("hidden");
      empty.querySelector("p").textContent = "Failed to load audit log.";
      console.error(err);
    }
  }

  /* -- Load filters -- */

  async function loadFilters() {
    try {
      const res = await fetch("/api/v1/audit-log/filters");
      if (!res.ok) return;
      const data = await res.json();

      userMap = data.users || [];
      userMap.forEach((u) => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.email;
        filterUser.appendChild(opt);
      });

      (data.actions || []).forEach((a) => {
        const opt = document.createElement("option");
        opt.value = a;
        opt.textContent = a;
        filterAction.appendChild(opt);
      });

      (data.entity_types || []).forEach((t) => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        filterEntityType.appendChild(opt);
      });
    } catch (err) {
      console.error("Failed to load filter options:", err);
    }
  }

  /* -- Event listeners -- */

  toggleFiltersBtn.addEventListener("click", () => {
    filterBar.classList.toggle("hidden");
  });

  applyBtn.addEventListener("click", () => {
    fetchAuditLog(false);
  });

  clearBtn.addEventListener("click", () => {
    filterUser.value = "";
    filterAction.value = "";
    filterEntityType.value = "";
    filterDateFrom.value = "";
    filterDateTo.value = "";
    fetchAuditLog(false);
  });

  loadMoreBtn.addEventListener("click", () => {
    fetchAuditLog(true);
  });

  /* -- Init -- */
  loadFilters();
  fetchAuditLog(false);
</script>
