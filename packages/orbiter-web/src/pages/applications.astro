---
import PageLayout from "../layouts/PageLayout.astro";
import Button from "../components/Button.astro";
import Modal from "../components/Modal.astro";

const breadcrumbs = [{ label: "Applications" }];

/* Icons */
const searchIcon = '<svg class="h-4 w-4 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
const gridIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>';
const listIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>';
const cubeIcon = '<svg class="h-12 w-12 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>';
const typeOptions = [
  { value: "", label: "All types" },
  { value: "chatbot", label: "Chatbot" },
  { value: "chatflow", label: "Chatflow" },
  { value: "workflow", label: "Workflow" },
  { value: "agent", label: "Agent" },
  { value: "text_generator", label: "Text Generator" },
];
---

<PageLayout
  title="Applications"
  description="Manage your AI applications"
  activeSection="projects"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Applications</h1>
        <p class="text-sm text-muted mt-1">All applications across your projects</p>
      </div>
      <div class="flex items-center gap-2">
        <!-- View toggle -->
        <div class="flex items-center border border-dark/[0.08] rounded-lg overflow-hidden">
          <button id="view-grid-btn" class="p-2 transition-colors bg-subtle text-dark" title="Grid view">
            <span set:html={gridIcon} />
          </button>
          <button id="view-list-btn" class="p-2 transition-colors text-muted hover:text-dark" title="List view">
            <span set:html={listIcon} />
          </button>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex items-center gap-3 mb-6 flex-wrap">
      <!-- Search -->
      <div class="relative flex-1 min-w-[200px] max-w-sm">
        <span class="absolute left-3 top-1/2 -translate-y-1/2" set:html={searchIcon} />
        <input
          type="text"
          id="app-search"
          placeholder="Search applications..."
          class="w-full bg-paper border border-dark/[0.08] rounded-lg pl-9 pr-3 py-2 text-sm text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        />
      </div>

      <!-- Type filter -->
      <select
        id="filter-type"
        class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer"
      >
        {typeOptions.map(opt => (
          <option value={opt.value}>{opt.label}</option>
        ))}
      </select>
    </div>

    <!-- Grid view container -->
    <div id="apps-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    </div>

    <!-- List view container (hidden by default) -->
    <div id="apps-list" class="hidden flex flex-col gap-2">
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <div class="mb-4" set:html={cubeIcon} />
      <h2 class="text-lg font-semibold text-dark mb-2">No applications yet</h2>
      <p class="text-sm text-muted mb-6 max-w-sm">
        Applications are created within projects. Go to a project to create your first application.
      </p>
      <Button href="/projects" variant="primary">
        Go to Projects
      </Button>
    </div>

    <!-- No results state -->
    <div id="no-results" class="hidden flex flex-col items-center justify-center py-16 text-center">
      <p class="text-sm text-muted">No applications match your filters. Try adjusting the search or type filter.</p>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading applications...</p>
    </div>
  </div>

  <!-- Duplicate confirmation modal -->
  <Modal id="duplicate-modal" title="Duplicate Application">
    <p class="text-sm text-muted mb-4">Create a copy of <span id="duplicate-name" class="font-semibold text-dark"></span>?</p>
    <div class="flex justify-end gap-3">
      <Button variant="default" data-modal-close="duplicate-modal">Cancel</Button>
      <Button variant="primary" id="confirm-duplicate-btn">Duplicate</Button>
    </div>
  </Modal>
</PageLayout>

<!-- App card template (grid view) -->
<template id="app-card-template">
  <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] transition-all duration-300 hover:-translate-y-0.5 hover:border-dark/20 hover:shadow-lg p-5 relative group">
    <div class="flex items-start justify-between mb-2">
      <div class="flex items-center gap-2 min-w-0">
        <span class="flex-shrink-0 w-7 h-7 rounded-lg flex items-center justify-center text-sm" data-field="type-icon"></span>
        <h3 class="font-semibold text-dark text-sm truncate" data-field="name"></h3>
      </div>
      <button
        class="flex-shrink-0 p-1.5 rounded-lg text-muted/40 hover:text-dark hover:bg-dark/[0.05] transition-colors opacity-0 group-hover:opacity-100 cursor-pointer"
        data-field="duplicate-btn"
        title="Duplicate"
      >
        <span class="block w-3.5 h-3.5" data-field="copy-icon"></span>
      </button>
    </div>
    <div class="flex items-center gap-2 mb-3">
      <span class="text-xs font-medium px-2 py-0.5 rounded-full" data-field="type-badge"></span>
      <span class="text-xs font-medium px-2 py-0.5 rounded-full" data-field="status-badge"></span>
    </div>
    <div class="flex items-center justify-between text-xs text-muted">
      <span data-field="project-name" class="truncate"></span>
      <span data-field="last-run" class="flex-shrink-0"></span>
    </div>
    <a class="absolute inset-0 rounded-xl" data-field="link"></a>
  </div>
</template>

<!-- App row template (list view) -->
<template id="app-row-template">
  <div class="flex items-center gap-4 rounded-xl bg-subtle/80 border border-dark/[0.08] transition-all duration-200 hover:border-dark/20 hover:shadow-sm px-5 py-3 relative group">
    <span class="flex-shrink-0 w-7 h-7 rounded-lg flex items-center justify-center text-sm" data-field="type-icon"></span>
    <div class="flex-1 min-w-0">
      <h3 class="font-semibold text-dark text-sm truncate" data-field="name"></h3>
      <span class="text-xs text-muted truncate block" data-field="project-name"></span>
    </div>
    <span class="text-xs font-medium px-2 py-0.5 rounded-full flex-shrink-0" data-field="type-badge"></span>
    <span class="text-xs font-medium px-2 py-0.5 rounded-full flex-shrink-0" data-field="status-badge"></span>
    <span class="text-xs text-muted flex-shrink-0 w-20 text-right" data-field="last-run"></span>
    <button
      class="flex-shrink-0 p-1.5 rounded-lg text-muted/40 hover:text-dark hover:bg-dark/[0.05] transition-colors opacity-0 group-hover:opacity-100 cursor-pointer"
      data-field="duplicate-btn"
      title="Duplicate"
    >
      <span class="block w-3.5 h-3.5" data-field="copy-icon"></span>
    </button>
    <a class="absolute inset-0 rounded-xl" data-field="link"></a>
  </div>
</template>

<script is:inline>
  (function () {
    /* ---------------------------------------------------------------
       DOM refs
    --------------------------------------------------------------- */
    var grid = document.getElementById("apps-grid");
    var list = document.getElementById("apps-list");
    var emptyState = document.getElementById("empty-state");
    var noResults = document.getElementById("no-results");
    var loadingState = document.getElementById("loading-state");
    var searchInput = document.getElementById("app-search");
    var filterType = document.getElementById("filter-type");
    var viewGridBtn = document.getElementById("view-grid-btn");
    var viewListBtn = document.getElementById("view-list-btn");
    var cardTemplate = document.getElementById("app-card-template");
    var rowTemplate = document.getElementById("app-row-template");
    var duplicateModal = document.getElementById("duplicate-modal");
    var duplicateNameEl = document.getElementById("duplicate-name");
    var confirmDuplicateBtn = document.getElementById("confirm-duplicate-btn");

    var allApps = [];
    var viewMode = localStorage.getItem("orbiter_apps_view") || "grid";
    var duplicateTargetId = null;

    var copyIconSvg = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';

    /* ---------------------------------------------------------------
       Type metadata (matching US-029 colors)
    --------------------------------------------------------------- */
    var typeColors = {
      chatbot: { bg: "bg-coral/10", text: "text-coral", label: "Chatbot", icon: "C" },
      chatflow: { bg: "bg-zen-blue/10", text: "text-zen-blue", label: "Chatflow", icon: "F" },
      workflow: { bg: "bg-zen-green/10", text: "text-zen-green", label: "Workflow", icon: "W" },
      agent: { bg: "bg-[#a855f7]/10", text: "text-[#a855f7]", label: "Agent", icon: "A" },
      text_generator: { bg: "bg-[#f59e0b]/10", text: "text-[#f59e0b]", label: "Text Generator", icon: "T" },
    };

    var statusColors = {
      draft: { bg: "bg-muted/10", text: "text-muted", label: "Draft" },
      active: { bg: "bg-zen-green/10", text: "text-zen-green", label: "Active" },
      paused: { bg: "bg-[#f59e0b]/10", text: "text-[#f59e0b]", label: "Paused" },
      archived: { bg: "bg-dark/10", text: "text-dark/60", label: "Archived" },
    };

    /* ---------------------------------------------------------------
       Helpers
    --------------------------------------------------------------- */
    function formatRelativeTime(dateStr) {
      if (!dateStr) return "Never run";
      try {
        var d = new Date(dateStr + "Z");
        var now = new Date();
        var diff = now - d;
        if (diff < 60000) return "Just now";
        if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
        if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
      } catch (_e) {
        return dateStr;
      }
    }

    function getBuilderUrl(app) {
      /* Canvas-based types go to canvas builder; form-based go to form builder */
      /* For now, all go to /applications/:id */
      return "/applications/" + app.id;
    }

    /* ---------------------------------------------------------------
       View toggle
    --------------------------------------------------------------- */
    function setView(mode) {
      viewMode = mode;
      localStorage.setItem("orbiter_apps_view", mode);

      if (mode === "grid") {
        viewGridBtn.classList.add("bg-subtle", "text-dark");
        viewGridBtn.classList.remove("text-muted", "hover:text-dark");
        viewListBtn.classList.remove("bg-subtle", "text-dark");
        viewListBtn.classList.add("text-muted", "hover:text-dark");
      } else {
        viewListBtn.classList.add("bg-subtle", "text-dark");
        viewListBtn.classList.remove("text-muted", "hover:text-dark");
        viewGridBtn.classList.remove("bg-subtle", "text-dark");
        viewGridBtn.classList.add("text-muted", "hover:text-dark");
      }

      renderApps();
    }

    if (viewGridBtn) viewGridBtn.addEventListener("click", function () { setView("grid"); });
    if (viewListBtn) viewListBtn.addEventListener("click", function () { setView("list"); });

    /* ---------------------------------------------------------------
       Filtering
    --------------------------------------------------------------- */
    function getFilteredApps() {
      var search = (searchInput.value || "").toLowerCase().trim();
      var typeFilter = filterType.value;

      return allApps.filter(function (app) {
        if (search && app.name.toLowerCase().indexOf(search) === -1) return false;
        if (typeFilter && app.type !== typeFilter) return false;
        return true;
      });
    }

    /* ---------------------------------------------------------------
       Render
    --------------------------------------------------------------- */
    function applyTypeBadge(el, type) {
      var tc = typeColors[type] || { bg: "bg-dark/10", text: "text-dark", label: type, icon: "?" };
      el.className = "text-xs font-medium px-2 py-0.5 rounded-full " + tc.bg + " " + tc.text;
      el.textContent = tc.label;
    }

    function applyStatusBadge(el, status) {
      var sc = statusColors[status] || statusColors.draft;
      el.className = "text-xs font-medium px-2 py-0.5 rounded-full " + sc.bg + " " + sc.text;
      el.textContent = sc.label;
    }

    function applyTypeIcon(el, type) {
      var tc = typeColors[type] || { bg: "bg-dark/10", text: "text-dark", icon: "?" };
      el.className = "flex-shrink-0 w-7 h-7 rounded-lg flex items-center justify-center text-sm font-bold " + tc.bg + " " + tc.text;
      el.textContent = tc.icon;
    }

    function renderApps() {
      if (loadingState) loadingState.classList.add("hidden");

      if (allApps.length === 0) {
        grid.classList.add("hidden");
        list.classList.add("hidden");
        noResults.classList.add("hidden");
        emptyState.classList.remove("hidden");
        return;
      }

      var filtered = getFilteredApps();

      if (filtered.length === 0) {
        grid.classList.add("hidden");
        list.classList.add("hidden");
        emptyState.classList.add("hidden");
        noResults.classList.remove("hidden");
        return;
      }

      noResults.classList.add("hidden");
      emptyState.classList.add("hidden");

      if (viewMode === "grid") {
        list.classList.add("hidden");
        grid.classList.remove("hidden");
        grid.innerHTML = "";

        filtered.forEach(function (app) {
          var card = cardTemplate.content.cloneNode(true);

          applyTypeIcon(card.querySelector('[data-field="type-icon"]'), app.type);
          card.querySelector('[data-field="name"]').textContent = app.name;
          applyTypeBadge(card.querySelector('[data-field="type-badge"]'), app.type);
          applyStatusBadge(card.querySelector('[data-field="status-badge"]'), app.status);
          card.querySelector('[data-field="project-name"]').textContent = app.project_name || "";
          card.querySelector('[data-field="last-run"]').textContent = formatRelativeTime(app.last_run_at);
          card.querySelector('[data-field="copy-icon"]').innerHTML = copyIconSvg;

          var link = card.querySelector('[data-field="link"]');
          link.href = getBuilderUrl(app);

          var dupBtn = card.querySelector('[data-field="duplicate-btn"]');
          dupBtn.style.position = "relative";
          dupBtn.style.zIndex = "10";
          dupBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            openDuplicate(app);
          });

          grid.appendChild(card);
        });
      } else {
        grid.classList.add("hidden");
        list.classList.remove("hidden");
        list.innerHTML = "";

        filtered.forEach(function (app) {
          var row = rowTemplate.content.cloneNode(true);

          applyTypeIcon(row.querySelector('[data-field="type-icon"]'), app.type);
          row.querySelector('[data-field="name"]').textContent = app.name;
          row.querySelector('[data-field="project-name"]').textContent = app.project_name || "";
          applyTypeBadge(row.querySelector('[data-field="type-badge"]'), app.type);
          applyStatusBadge(row.querySelector('[data-field="status-badge"]'), app.status);
          row.querySelector('[data-field="last-run"]').textContent = formatRelativeTime(app.last_run_at);
          row.querySelector('[data-field="copy-icon"]').innerHTML = copyIconSvg;

          var link = row.querySelector('[data-field="link"]');
          link.href = getBuilderUrl(app);

          var dupBtn = row.querySelector('[data-field="duplicate-btn"]');
          dupBtn.style.position = "relative";
          dupBtn.style.zIndex = "10";
          dupBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            openDuplicate(app);
          });

          list.appendChild(row);
        });
      }
    }

    /* ---------------------------------------------------------------
       Duplicate
    --------------------------------------------------------------- */
    function openDuplicate(app) {
      duplicateTargetId = app.id;
      duplicateNameEl.textContent = app.name;
      duplicateModal.showModal();
    }

    if (confirmDuplicateBtn) {
      confirmDuplicateBtn.addEventListener("click", function () {
        if (!duplicateTargetId) return;

        confirmDuplicateBtn.disabled = true;
        confirmDuplicateBtn.textContent = "Duplicating...";

        fetch("/api/applications/" + duplicateTargetId + "/duplicate", { method: "POST" })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to duplicate"); });
            return res.json();
          })
          .then(function (newApp) {
            duplicateModal.close();
            duplicateTargetId = null;
            allApps.unshift(newApp);
            renderApps();
          })
          .catch(function (err) {
            alert("Error: " + err.message);
          })
          .finally(function () {
            confirmDuplicateBtn.disabled = false;
            confirmDuplicateBtn.textContent = "Duplicate";
          });
      });
    }

    /* ---------------------------------------------------------------
       Data fetching
    --------------------------------------------------------------- */
    function fetchApps() {
      fetch("/api/applications")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load applications");
          return res.json();
        })
        .then(function (apps) {
          allApps = apps;
          /* Enrich with project names */
          fetchProjectNames(apps);
        })
        .catch(function () {
          if (loadingState) loadingState.classList.add("hidden");
          grid.innerHTML = '<p class="text-sm text-coral col-span-full text-center py-10">Failed to load applications. Is the API server running?</p>';
          grid.classList.remove("hidden");
        });
    }

    function fetchProjectNames(apps) {
      /* Get unique project_ids and fetch project names */
      var projectIds = [];
      apps.forEach(function (a) {
        if (a.project_id && projectIds.indexOf(a.project_id) === -1) {
          projectIds.push(a.project_id);
        }
      });

      if (projectIds.length === 0) {
        renderApps();
        return;
      }

      fetch("/api/projects")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed");
          return res.json();
        })
        .then(function (body) { return body.data || body; })
        .then(function (projects) {
          var projectMap = {};
          projects.forEach(function (p) { projectMap[p.id] = p.name; });
          allApps.forEach(function (app) {
            app.project_name = projectMap[app.project_id] || "";
          });
          renderApps();
        })
        .catch(function () {
          renderApps();
        });
    }

    /* ---------------------------------------------------------------
       Event listeners
    --------------------------------------------------------------- */
    var filterTimeout;
    function onFilterChange() {
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(renderApps, 150);
    }
    if (searchInput) searchInput.addEventListener("input", onFilterChange);
    if (filterType) filterType.addEventListener("change", onFilterChange);

    /* ---------------------------------------------------------------
       Initial load
    --------------------------------------------------------------- */
    setView(viewMode);
    fetchApps();
  })();
</script>
