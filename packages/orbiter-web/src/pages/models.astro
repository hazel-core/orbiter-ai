---
import PageLayout from "../layouts/PageLayout.astro";
import Button from "../components/Button.astro";
import Modal from "../components/Modal.astro";
import Input from "../components/Input.astro";

const breadcrumbs = [{ label: "Models" }];

const capabilityOptions = [
  { value: "", label: "All capabilities" },
  { value: "chat", label: "Chat" },
  { value: "embedding", label: "Embedding" },
  { value: "vision", label: "Vision" },
  { value: "reasoning", label: "Reasoning" },
  { value: "code", label: "Code" },
];

/* Icons */
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const cubeIcon = '<svg class="h-12 w-12 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>';
const downloadIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
const searchIcon = '<svg class="h-4 w-4 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
---

<PageLayout
  title="Models"
  description="Browse and manage AI models"
  activeSection="models"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Models</h1>
        <p class="text-sm text-muted mt-1">Browse available models across your configured providers</p>
      </div>
      <div class="flex items-center gap-2">
        <Button variant="default" id="discover-all-btn">
          <span set:html={downloadIcon} />
          Fetch All
        </Button>
        <Button variant="primary" id="add-model-btn">
          <span set:html={plusIcon} />
          Add Custom
        </Button>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex items-center gap-3 mb-6 flex-wrap">
      <!-- Search -->
      <div class="relative flex-1 min-w-[200px] max-w-sm">
        <span class="absolute left-3 top-1/2 -translate-y-1/2" set:html={searchIcon} />
        <input
          type="text"
          id="model-search"
          placeholder="Search models..."
          class="w-full bg-paper border border-dark/[0.08] rounded-lg pl-9 pr-3 py-2 text-sm text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        />
      </div>

      <!-- Provider filter -->
      <select
        id="filter-provider"
        class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer"
      >
        <option value="">All providers</option>
      </select>

      <!-- Capability filter -->
      <select
        id="filter-capability"
        class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer"
      >
        {capabilityOptions.map(opt => (
          <option value={opt.value}>{opt.label}</option>
        ))}
      </select>

      <!-- Context window filter -->
      <select
        id="filter-context"
        class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer"
      >
        <option value="">Any context size</option>
        <option value="8000">8K+</option>
        <option value="32000">32K+</option>
        <option value="128000">128K+</option>
        <option value="200000">200K+</option>
      </select>
    </div>

    <!-- Provider discover bar -->
    <div id="provider-bar" class="flex items-center gap-2 mb-6 flex-wrap hidden">
    </div>

    <!-- Models grid -->
    <div id="models-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <div class="mb-4" set:html={cubeIcon} />
      <h2 class="text-lg font-semibold text-dark mb-2">No models found</h2>
      <p class="text-sm text-muted mb-6 max-w-sm">
        Fetch models from your configured providers or add custom models manually.
      </p>
      <Button variant="primary" id="empty-add-btn">
        <span set:html={downloadIcon} />
        Fetch Models
      </Button>
    </div>

    <!-- No results state (when filters match nothing) -->
    <div id="no-results" class="hidden flex flex-col items-center justify-center py-16 text-center">
      <p class="text-sm text-muted">No models match your filters. Try adjusting the search or filters.</p>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading models...</p>
    </div>
  </div>

  <!-- Add Custom Model Modal -->
  <Modal id="add-model-modal" title="Add Custom Model">
    <form id="add-model-form" class="flex flex-col gap-4">
      <div class="flex flex-col gap-1.5">
        <label for="custom-provider" class="text-sm font-medium text-dark">Provider <span class="text-coral">*</span></label>
        <select
          id="custom-provider"
          name="provider_id"
          required
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer"
        >
          <option value="">Select a provider</option>
        </select>
      </div>
      <Input label="Model Name" name="model_name" placeholder="e.g., ft:gpt-4o:my-org:custom-model" required />
      <Input label="Context Window" name="context_window" type="number" placeholder="e.g., 128000" />
      <div class="flex flex-col gap-1.5">
        <label class="text-sm font-medium text-dark">Capabilities</label>
        <div class="flex flex-wrap gap-2">
          <label class="flex items-center gap-1.5 text-sm text-dark cursor-pointer">
            <input type="checkbox" name="capabilities" value="chat" class="accent-coral" /> Chat
          </label>
          <label class="flex items-center gap-1.5 text-sm text-dark cursor-pointer">
            <input type="checkbox" name="capabilities" value="embedding" class="accent-coral" /> Embedding
          </label>
          <label class="flex items-center gap-1.5 text-sm text-dark cursor-pointer">
            <input type="checkbox" name="capabilities" value="vision" class="accent-coral" /> Vision
          </label>
          <label class="flex items-center gap-1.5 text-sm text-dark cursor-pointer">
            <input type="checkbox" name="capabilities" value="reasoning" class="accent-coral" /> Reasoning
          </label>
          <label class="flex items-center gap-1.5 text-sm text-dark cursor-pointer">
            <input type="checkbox" name="capabilities" value="code" class="accent-coral" /> Code
          </label>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <Input label="Input Price ($/1M tokens)" name="pricing_input" type="number" step="0.01" placeholder="e.g., 2.50" />
        <Input label="Output Price ($/1M tokens)" name="pricing_output" type="number" step="0.01" placeholder="e.g., 10.00" />
      </div>
      <div id="add-model-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="add-model-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="add-model-submit">
          Add Model
        </Button>
      </div>
    </form>
  </Modal>
</PageLayout>

<!-- Model card template -->
<template id="model-card-template">
  <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] transition-all duration-300 hover:-translate-y-0.5 hover:border-dark/20 hover:shadow-lg p-5">
    <div class="flex items-start justify-between mb-2">
      <div class="flex items-center gap-2 min-w-0">
        <span class="flex-shrink-0 w-6 h-6 rounded-md flex items-center justify-center text-xs font-bold" data-field="provider-icon"></span>
        <h3 class="font-semibold text-dark text-sm truncate" data-field="model-name"></h3>
      </div>
      <span class="text-xs px-1.5 py-0.5 rounded bg-muted/10 text-muted flex-shrink-0" data-field="provider-name"></span>
    </div>
    <div class="flex items-center gap-2 mb-3 flex-wrap" data-field="capabilities"></div>
    <div class="grid grid-cols-2 gap-2 text-xs text-muted">
      <div data-field="context-row">
        <span class="text-muted/60">Context:</span>
        <span class="text-dark font-medium" data-field="context-window"></span>
      </div>
      <div data-field="pricing-row">
        <span class="text-muted/60">Pricing:</span>
        <span class="text-dark font-medium" data-field="pricing"></span>
      </div>
    </div>
    <div class="mt-2" data-field="custom-badge"></div>
  </div>
</template>

<!-- Provider discover button template -->
<template id="provider-btn-template">
  <button class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-dark/[0.08] bg-subtle/80 text-sm text-dark hover:bg-subtle hover:border-dark/20 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
    <span data-field="icon" class="w-4 h-4"></span>
    <span>Fetch</span>
    <span data-field="name" class="font-medium"></span>
  </button>
</template>

<script is:inline>
  (function () {
    /* ---------------------------------------------------------------
       DOM refs
    --------------------------------------------------------------- */
    var grid = document.getElementById("models-grid");
    var emptyState = document.getElementById("empty-state");
    var noResults = document.getElementById("no-results");
    var loadingState = document.getElementById("loading-state");
    var providerBar = document.getElementById("provider-bar");
    var addModelBtn = document.getElementById("add-model-btn");
    var emptyAddBtn = document.getElementById("empty-add-btn");
    var discoverAllBtn = document.getElementById("discover-all-btn");
    var modal = document.getElementById("add-model-modal");
    var form = document.getElementById("add-model-form");
    var addError = document.getElementById("add-model-error");
    var submitBtn = document.getElementById("add-model-submit");
    var providerSelect = document.getElementById("custom-provider");
    var searchInput = document.getElementById("model-search");
    var filterProvider = document.getElementById("filter-provider");
    var filterCapability = document.getElementById("filter-capability");
    var filterContext = document.getElementById("filter-context");
    var cardTemplate = document.getElementById("model-card-template");
    var providerBtnTemplate = document.getElementById("provider-btn-template");

    var allModels = [];
    var providers = [];

    /* ---------------------------------------------------------------
       Provider metadata
    --------------------------------------------------------------- */
    var providerIcons = {
      openai: { bg: "bg-[#10a37f]/10", text: "text-[#10a37f]", letter: "O" },
      anthropic: { bg: "bg-[#d97757]/10", text: "text-[#d97757]", letter: "A" },
      gemini: { bg: "bg-[#4285f4]/10", text: "text-[#4285f4]", letter: "G" },
      vertex: { bg: "bg-[#4285f4]/10", text: "text-[#4285f4]", letter: "V" },
      ollama: { bg: "bg-[#333]/10", text: "text-[#333]", letter: "L" },
      custom: { bg: "bg-muted/10", text: "text-muted", letter: "C" },
    };

    var capColors = {
      chat: "bg-zen-blue/10 text-zen-blue",
      embedding: "bg-zen-green/10 text-zen-green",
      vision: "bg-coral/10 text-coral",
      reasoning: "bg-[#a855f7]/10 text-[#a855f7]",
      code: "bg-[#f59e0b]/10 text-[#f59e0b]",
    };

    /* ---------------------------------------------------------------
       Formatting helpers
    --------------------------------------------------------------- */
    function formatTokens(n) {
      if (!n && n !== 0) return "—";
      if (n >= 1000000) return (n / 1000000).toFixed(n % 1000000 === 0 ? 0 : 1) + "M";
      if (n >= 1000) return (n / 1000).toFixed(n % 1000 === 0 ? 0 : 1) + "K";
      return String(n);
    }

    function formatPrice(input, output) {
      if (!input && !output) return null;
      var parts = [];
      if (input) parts.push("$" + Number(input).toFixed(2) + " in");
      if (output) parts.push("$" + Number(output).toFixed(2) + " out");
      return parts.join(" / ");
    }

    /* ---------------------------------------------------------------
       Render models
    --------------------------------------------------------------- */
    function getFilteredModels() {
      var search = (searchInput.value || "").toLowerCase().trim();
      var provId = filterProvider.value;
      var cap = filterCapability.value;
      var ctxMin = parseInt(filterContext.value, 10) || 0;

      return allModels.filter(function (m) {
        if (search && m.model_name.toLowerCase().indexOf(search) === -1) return false;
        if (provId && m.provider_id !== provId) return false;
        if (cap && (!m.capabilities || m.capabilities.indexOf(cap) === -1)) return false;
        if (ctxMin && (!m.context_window || m.context_window < ctxMin)) return false;
        return true;
      });
    }

    function renderModels() {
      if (loadingState) loadingState.classList.add("hidden");

      if (allModels.length === 0) {
        grid.classList.add("hidden");
        noResults.classList.add("hidden");
        emptyState.classList.remove("hidden");
        return;
      }

      var filtered = getFilteredModels();

      if (filtered.length === 0) {
        grid.classList.add("hidden");
        emptyState.classList.add("hidden");
        noResults.classList.remove("hidden");
        return;
      }

      noResults.classList.add("hidden");
      emptyState.classList.add("hidden");
      grid.classList.remove("hidden");
      grid.innerHTML = "";

      filtered.forEach(function (model) {
        var card = cardTemplate.content.cloneNode(true);

        // Provider icon
        var iconEl = card.querySelector('[data-field="provider-icon"]');
        var iconCfg = providerIcons[model.provider_type] || providerIcons.custom;
        iconEl.className = "flex-shrink-0 w-6 h-6 rounded-md flex items-center justify-center text-xs font-bold " + iconCfg.bg + " " + iconCfg.text;
        iconEl.textContent = iconCfg.letter;

        // Model name
        card.querySelector('[data-field="model-name"]').textContent = model.model_name;

        // Provider name
        card.querySelector('[data-field="provider-name"]').textContent = model.provider_name || model.provider_type;

        // Capabilities
        var capsEl = card.querySelector('[data-field="capabilities"]');
        if (model.capabilities && model.capabilities.length > 0) {
          model.capabilities.forEach(function (cap) {
            var tag = document.createElement("span");
            var colorClass = capColors[cap] || "bg-muted/10 text-muted";
            tag.className = "text-xs px-2 py-0.5 rounded-full font-medium " + colorClass;
            tag.textContent = cap;
            capsEl.appendChild(tag);
          });
        } else {
          capsEl.classList.add("hidden");
        }

        // Context window
        var ctxRow = card.querySelector('[data-field="context-row"]');
        if (model.context_window) {
          card.querySelector('[data-field="context-window"]').textContent = formatTokens(model.context_window);
        } else {
          ctxRow.classList.add("hidden");
        }

        // Pricing
        var pricingRow = card.querySelector('[data-field="pricing-row"]');
        var priceStr = formatPrice(model.pricing_input, model.pricing_output);
        if (priceStr) {
          card.querySelector('[data-field="pricing"]').textContent = priceStr;
        } else {
          pricingRow.classList.add("hidden");
        }

        // Custom badge
        var customBadge = card.querySelector('[data-field="custom-badge"]');
        if (model.is_custom) {
          var badge = document.createElement("span");
          badge.className = "text-xs px-2 py-0.5 rounded-full bg-muted/10 text-muted font-medium";
          badge.textContent = "Custom";
          customBadge.appendChild(badge);
        } else {
          customBadge.classList.add("hidden");
        }

        grid.appendChild(card);
      });
    }

    /* ---------------------------------------------------------------
       Provider bar — per-provider Fetch buttons
    --------------------------------------------------------------- */
    function renderProviderBar() {
      if (!providers || providers.length === 0) {
        providerBar.classList.add("hidden");
        return;
      }

      providerBar.classList.remove("hidden");
      providerBar.innerHTML = '<span class="text-xs text-muted mr-1">Fetch from:</span>';

      // Populate filter dropdown
      filterProvider.innerHTML = '<option value="">All providers</option>';

      providers.forEach(function (prov) {
        // Filter dropdown option
        var opt = document.createElement("option");
        opt.value = prov.id;
        opt.textContent = prov.name;
        filterProvider.appendChild(opt);

        // Discover button
        var btn = providerBtnTemplate.content.cloneNode(true);
        var button = btn.querySelector("button");
        var iconCfg = providerIcons[prov.provider_type] || providerIcons.custom;
        var iconSpan = btn.querySelector('[data-field="icon"]');
        iconSpan.className = "w-4 h-4 rounded flex items-center justify-center text-[10px] font-bold " + iconCfg.bg + " " + iconCfg.text;
        iconSpan.textContent = iconCfg.letter;
        btn.querySelector('[data-field="name"]').textContent = prov.name;

        button.addEventListener("click", function () {
          discoverFromProvider(prov.id, button);
        });

        providerBar.appendChild(btn);
      });

      // Also populate the modal's provider dropdown
      providerSelect.innerHTML = '<option value="">Select a provider</option>';
      providers.forEach(function (prov) {
        var opt = document.createElement("option");
        opt.value = prov.id;
        opt.textContent = prov.name + " (" + prov.provider_type + ")";
        providerSelect.appendChild(opt);
      });
    }

    /* ---------------------------------------------------------------
       Data fetching
    --------------------------------------------------------------- */
    function fetchModels() {
      fetch("/api/models")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load models");
          return res.json();
        })
        .then(function (models) {
          allModels = models;
          renderModels();
        })
        .catch(function () {
          if (loadingState) loadingState.classList.add("hidden");
          grid.innerHTML = '<p class="text-sm text-coral col-span-full text-center py-10">Failed to load models. Is the API server running?</p>';
          grid.classList.remove("hidden");
        });
    }

    function fetchProviders() {
      fetch("/api/providers")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load providers");
          return res.json();
        })
        .then(function (data) {
          providers = data;
          renderProviderBar();
        })
        .catch(function () {
          // Silently ignore — providers bar just won't show
        });
    }

    function discoverFromProvider(providerId, button) {
      var origText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<span class="animate-pulse">Fetching...</span>';

      fetch("/api/providers/" + providerId + "/discover", { method: "POST" })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Discovery failed"); });
          return res.json();
        })
        .then(function (result) {
          button.innerHTML = '<span class="text-zen-green">✓ ' + result.discovered + ' found</span>';
          setTimeout(function () { button.innerHTML = origText; button.disabled = false; }, 3000);
          fetchModels();
        })
        .catch(function (err) {
          button.innerHTML = '<span class="text-coral">✗ ' + err.message.substring(0, 30) + '</span>';
          setTimeout(function () { button.innerHTML = origText; button.disabled = false; }, 4000);
        });
    }

    function discoverAll() {
      if (!providers || providers.length === 0) return;
      discoverAllBtn.disabled = true;
      discoverAllBtn.querySelector("span:last-child") && (discoverAllBtn.querySelector("span:last-child").textContent = "Fetching...");

      var remaining = providers.length;
      var totalDiscovered = 0;

      providers.forEach(function (prov) {
        fetch("/api/providers/" + prov.id + "/discover", { method: "POST" })
          .then(function (res) {
            if (res.ok) return res.json();
            return null;
          })
          .then(function (result) {
            if (result) totalDiscovered += result.discovered;
          })
          .catch(function () {})
          .finally(function () {
            remaining--;
            if (remaining === 0) {
              discoverAllBtn.disabled = false;
              var lastSpan = discoverAllBtn.querySelector("span:last-child");
              if (lastSpan) lastSpan.textContent = "Fetch All";
              fetchModels();
            }
          });
      });
    }

    /* ---------------------------------------------------------------
       Event listeners
    --------------------------------------------------------------- */
    if (addModelBtn) addModelBtn.addEventListener("click", function () { modal.showModal(); });
    if (emptyAddBtn) emptyAddBtn.addEventListener("click", function () { discoverAll(); });
    if (discoverAllBtn) discoverAllBtn.addEventListener("click", function () { discoverAll(); });

    // Filters
    var filterTimeout;
    function onFilterChange() {
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(renderModels, 150);
    }
    if (searchInput) searchInput.addEventListener("input", onFilterChange);
    if (filterProvider) filterProvider.addEventListener("change", onFilterChange);
    if (filterCapability) filterCapability.addEventListener("change", onFilterChange);
    if (filterContext) filterContext.addEventListener("change", onFilterChange);

    // Add model form
    if (form) {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        addError.classList.add("hidden");

        var formData = new FormData(form);
        var providerId = formData.get("provider_id");
        var modelName = (formData.get("model_name") || "").toString().trim();

        if (!providerId) {
          addError.textContent = "Please select a provider";
          addError.classList.remove("hidden");
          return;
        }
        if (!modelName) {
          addError.textContent = "Model name is required";
          addError.classList.remove("hidden");
          return;
        }

        var capabilities = formData.getAll("capabilities");
        var contextWindow = formData.get("context_window") ? parseInt(formData.get("context_window"), 10) : null;
        var pricingInput = formData.get("pricing_input") ? parseFloat(formData.get("pricing_input")) : null;
        var pricingOutput = formData.get("pricing_output") ? parseFloat(formData.get("pricing_output")) : null;

        submitBtn.disabled = true;
        submitBtn.textContent = "Adding...";

        fetch("/api/models", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            provider_id: providerId,
            model_name: modelName,
            context_window: contextWindow,
            capabilities: capabilities,
            pricing_input: pricingInput,
            pricing_output: pricingOutput,
            is_custom: true,
          }),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to add model"); });
            return res.json();
          })
          .then(function (newModel) {
            form.reset();
            modal.close();
            allModels.unshift(newModel);
            renderModels();
          })
          .catch(function (err) {
            addError.textContent = err.message;
            addError.classList.remove("hidden");
          })
          .finally(function () {
            submitBtn.disabled = false;
            submitBtn.textContent = "Add Model";
          });
      });
    }

    /* ---------------------------------------------------------------
       Initial load
    --------------------------------------------------------------- */
    fetchProviders();
    fetchModels();
  })();
</script>
