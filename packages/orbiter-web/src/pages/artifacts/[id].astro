---
import PageLayout from "../../layouts/PageLayout.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Artifacts", href: "/artifacts" },
  { label: "Loading..." },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const saveIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>';
const downloadIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
const historyIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';
const refreshIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>';
const eyeIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
const editIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
const diffIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>';
---

<PageLayout
  title="Artifact Editor"
  description="Edit artifact content"
  activeSection="artifacts"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-7xl mx-auto">
    <!-- Loading -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <div class="animate-spin h-6 w-6 border-2 border-coral border-t-transparent rounded-full"></div>
    </div>

    <!-- Error -->
    <div id="error-state" class="hidden text-center py-20">
      <p class="text-muted mb-4">Artifact not found or not editable</p>
      <a href="/artifacts" class="text-coral hover:text-coral/80 text-sm">Back to artifacts</a>
    </div>

    <!-- Main content -->
    <div id="main-content" class="hidden">
      <!-- Header -->
      <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
        <div class="flex items-center gap-3">
          <a href="/artifacts" class="p-2 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors" title="Back to artifacts">
            <span set:html={backIcon} />
          </a>
          <div>
            <h1 id="artifact-name" class="text-xl font-semibold text-dark"></h1>
            <div class="flex items-center gap-2 mt-0.5">
              <span id="artifact-type-badge"></span>
              <span id="artifact-size" class="text-xs text-muted"></span>
              <span id="save-status" class="text-xs text-muted"></span>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <!-- Mode toggle (edit / preview / diff) -->
          <div class="flex items-center border border-dark/[0.08] rounded-lg overflow-hidden">
            <button id="mode-edit" class="flex items-center gap-1.5 px-3 py-1.5 text-sm bg-dark/[0.05] text-dark transition-colors cursor-pointer" title="Edit">
              <span set:html={editIcon} /> Edit
            </button>
            <button id="mode-preview" class="hidden flex items-center gap-1.5 px-3 py-1.5 text-sm text-muted hover:text-dark transition-colors cursor-pointer" title="Preview">
              <span set:html={eyeIcon} /> Preview
            </button>
            <button id="mode-diff" class="flex items-center gap-1.5 px-3 py-1.5 text-sm text-muted hover:text-dark transition-colors cursor-pointer" title="Diff">
              <span set:html={diffIcon} /> Diff
            </button>
          </div>

          <!-- Version history -->
          <button id="toggle-versions" class="flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-dark bg-paper border border-dark/[0.08] rounded-lg hover:bg-dark/[0.05] transition-colors cursor-pointer" title="Version history">
            <span set:html={historyIcon} />
            <span id="version-count" class="text-xs text-muted">0 versions</span>
          </button>

          <!-- Regenerate -->
          <button id="regenerate-btn" class="hidden items-center gap-1.5 px-3 py-2 text-sm font-medium text-dark bg-paper border border-dark/[0.08] rounded-lg hover:bg-dark/[0.05] transition-colors cursor-pointer" title="Regenerate with AI">
            <span set:html={refreshIcon} /> Regenerate
          </button>

          <!-- Download -->
          <a id="download-link" href="#" download class="p-2 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors" title="Download">
            <span set:html={downloadIcon} />
          </a>

          <!-- Save -->
          <button id="save-btn" class="flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-white bg-coral rounded-lg hover:bg-coral/90 transition-colors cursor-pointer" title="Save">
            <span set:html={saveIcon} /> Save
          </button>
        </div>
      </div>

      <!-- JSON validation warning -->
      <div id="json-warning" class="hidden mb-3 px-4 py-2 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700">
        Invalid JSON: <span id="json-error-msg"></span>
      </div>

      <!-- Content area -->
      <div class="flex gap-4">
        <!-- Editor pane -->
        <div id="editor-pane" class="flex-1 min-w-0">
          <!-- Edit mode: textarea -->
          <div id="edit-area" class="relative">
            <textarea
              id="editor"
              class="w-full font-mono text-sm bg-dark/[0.02] border border-dark/[0.08] rounded-lg p-4 text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all resize-y"
              style="min-height: 500px; tab-size: 2;"
              spellcheck="false"
            ></textarea>
            <div id="line-numbers" class="absolute left-0 top-0 w-12 text-right pr-2 pt-4 font-mono text-xs text-muted/50 select-none pointer-events-none overflow-hidden" style="line-height: 1.5;"></div>
          </div>

          <!-- Preview mode -->
          <div id="preview-area" class="hidden bg-white border border-dark/[0.08] rounded-lg p-6 prose prose-sm max-w-none" style="min-height: 500px;">
          </div>

          <!-- Diff mode -->
          <div id="diff-area" class="hidden bg-white border border-dark/[0.08] rounded-lg overflow-hidden" style="min-height: 500px;">
            <div class="flex items-center gap-3 px-4 py-2 bg-dark/[0.03] border-b border-dark/[0.06]">
              <select id="diff-version-a" class="bg-paper border border-dark/[0.08] rounded px-2 py-1 text-xs text-dark outline-none cursor-pointer"></select>
              <span class="text-xs text-muted">vs</span>
              <select id="diff-version-b" class="bg-paper border border-dark/[0.08] rounded px-2 py-1 text-xs text-dark outline-none cursor-pointer"></select>
            </div>
            <div id="diff-content" class="p-4 font-mono text-sm overflow-auto" style="max-height: 500px;"></div>
          </div>
        </div>

        <!-- Version history sidebar (hidden by default) -->
        <div id="versions-panel" class="hidden w-72 shrink-0">
          <div class="bg-white border border-dark/[0.06] rounded-xl shadow-sm overflow-hidden">
            <div class="px-4 py-3 border-b border-dark/[0.06] flex items-center justify-between">
              <h3 class="text-sm font-semibold text-dark">Version History</h3>
              <button id="close-versions" class="p-1 rounded hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors cursor-pointer">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>
            <div id="versions-list" class="max-h-96 overflow-y-auto divide-y divide-dark/[0.04]">
              <div class="px-4 py-6 text-center text-sm text-muted">No versions yet</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Regenerate dialog -->
  <dialog id="regenerate-dialog" class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-lg w-full">
    <div class="p-6">
      <h3 class="text-lg font-semibold text-dark mb-2">Regenerate with AI</h3>
      <p class="text-sm text-muted mb-4">Describe how you want to modify this artifact. The agent will apply your instructions.</p>
      <textarea id="regen-instructions" class="w-full border border-dark/[0.08] rounded-lg p-3 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all resize-y font-sans" rows="4" placeholder="e.g., Add error handling, convert to TypeScript, fix the formatting..."></textarea>
      <div id="regen-error" class="hidden mt-2 text-sm text-red-600"></div>
      <div class="flex justify-end gap-3 mt-4">
        <button id="regen-cancel" class="px-4 py-2 text-sm font-medium text-muted hover:text-dark border border-dark/[0.08] rounded-lg transition-colors cursor-pointer">Cancel</button>
        <button id="regen-submit" class="px-4 py-2 text-sm font-medium text-white bg-coral hover:bg-coral/90 rounded-lg transition-colors cursor-pointer">Regenerate</button>
      </div>
    </div>
  </dialog>
</PageLayout>

<script is:inline define:vars={{ id }}>
(function () {
  var artifactId = id;
  var artifact = null;
  var content = "";
  var originalContent = "";
  var versions = [];
  var currentMode = "edit"; // edit | preview | diff
  var autoSaveTimer = null;
  var saving = false;
  var dirty = false;

  // DOM refs
  var loadingState = document.getElementById("loading-state");
  var errorState = document.getElementById("error-state");
  var mainContent = document.getElementById("main-content");
  var artifactName = document.getElementById("artifact-name");
  var artifactTypeBadge = document.getElementById("artifact-type-badge");
  var artifactSize = document.getElementById("artifact-size");
  var saveStatus = document.getElementById("save-status");
  var editor = document.getElementById("editor");
  var editArea = document.getElementById("edit-area");
  var previewArea = document.getElementById("preview-area");
  var diffArea = document.getElementById("diff-area");
  var diffContent = document.getElementById("diff-content");
  var diffVersionA = document.getElementById("diff-version-a");
  var diffVersionB = document.getElementById("diff-version-b");
  var modeEditBtn = document.getElementById("mode-edit");
  var modePreviewBtn = document.getElementById("mode-preview");
  var modeDiffBtn = document.getElementById("mode-diff");
  var saveBtn = document.getElementById("save-btn");
  var downloadLink = document.getElementById("download-link");
  var toggleVersionsBtn = document.getElementById("toggle-versions");
  var versionCount = document.getElementById("version-count");
  var versionsPanel = document.getElementById("versions-panel");
  var versionsList = document.getElementById("versions-list");
  var closeVersionsBtn = document.getElementById("close-versions");
  var regenerateBtn = document.getElementById("regenerate-btn");
  var regenerateDialog = document.getElementById("regenerate-dialog");
  var regenInstructions = document.getElementById("regen-instructions");
  var regenCancel = document.getElementById("regen-cancel");
  var regenSubmit = document.getElementById("regen-submit");
  var regenError = document.getElementById("regen-error");
  var jsonWarning = document.getElementById("json-warning");
  var jsonErrorMsg = document.getElementById("json-error-msg");

  // ------ Helpers ------

  function escapeHtml(str) {
    var div = document.createElement("div");
    div.textContent = str || "";
    return div.innerHTML;
  }

  function fmtSize(bytes) {
    if (bytes == null || bytes === 0) return "0 B";
    if (bytes < 1024) return bytes + " B";
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
    if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + " MB";
    return (bytes / 1073741824).toFixed(1) + " GB";
  }

  function fmtTime(t) {
    if (!t) return "";
    var d = new Date(t + "Z");
    var now = new Date();
    var diff = now - d;
    if (diff < 60000) return "just now";
    if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
    if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
    return d.toLocaleDateString(undefined, { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
  }

  function getFileExt(filename) {
    return (filename || "").split(".").pop().toLowerCase();
  }

  function getFileCategory(filename) {
    var ext = getFileExt(filename);
    var IMAGE_EXTS = ["png", "jpg", "jpeg", "gif", "webp", "svg", "bmp", "ico"];
    var CODE_EXTS = ["py", "js", "ts", "jsx", "tsx", "html", "css", "scss", "sql", "sh", "bash", "go", "rs", "java", "c", "cpp", "h", "rb", "php"];
    if (IMAGE_EXTS.indexOf(ext) !== -1) return "image";
    if (ext === "pdf") return "pdf";
    if (CODE_EXTS.indexOf(ext) !== -1) return "code";
    if (ext === "json") return "json";
    if (ext === "md") return "markdown";
    if (ext === "csv") return "csv";
    return "text";
  }

  function typeBadge(filename) {
    var ext = getFileExt(filename);
    var colors = {
      image: "bg-blue-100 text-blue-700 border-blue-200",
      pdf: "bg-red-100 text-red-700 border-red-200",
      code: "bg-green-100 text-green-700 border-green-200",
      json: "bg-green-100 text-green-700 border-green-200",
      markdown: "bg-purple-100 text-purple-700 border-purple-200",
      text: "bg-gray-100 text-gray-600 border-gray-200",
      csv: "bg-yellow-100 text-yellow-700 border-yellow-200",
    };
    var cat = getFileCategory(filename);
    var cls = colors[cat] || colors.text;
    return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ' + cls + '">' + escapeHtml(ext.toUpperCase()) + '</span>';
  }

  // ------ Markdown rendering (simple) ------

  function renderMarkdown(md) {
    // Simple markdown to HTML for preview
    var html = escapeHtml(md);
    // Headers
    html = html.replace(/^######\s+(.+)$/gm, '<h6 class="text-sm font-semibold mt-4 mb-1">$1</h6>');
    html = html.replace(/^#####\s+(.+)$/gm, '<h5 class="text-sm font-bold mt-4 mb-1">$1</h5>');
    html = html.replace(/^####\s+(.+)$/gm, '<h4 class="text-base font-semibold mt-4 mb-2">$1</h4>');
    html = html.replace(/^###\s+(.+)$/gm, '<h3 class="text-lg font-semibold mt-5 mb-2">$1</h3>');
    html = html.replace(/^##\s+(.+)$/gm, '<h2 class="text-xl font-semibold mt-6 mb-2">$1</h2>');
    html = html.replace(/^#\s+(.+)$/gm, '<h1 class="text-2xl font-bold mt-6 mb-3">$1</h1>');
    // Bold
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    // Italic
    html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code class="bg-dark/[0.05] px-1.5 py-0.5 rounded text-sm font-mono">$1</code>');
    // Code blocks
    html = html.replace(/```[\w]*\n([\s\S]*?)```/g, '<pre class="bg-dark/[0.03] rounded-lg p-4 text-sm font-mono overflow-auto my-3"><code>$1</code></pre>');
    // Lists (unordered)
    html = html.replace(/^[-*]\s+(.+)$/gm, '<li class="ml-4">$1</li>');
    // Lists (ordered)
    html = html.replace(/^\d+\.\s+(.+)$/gm, '<li class="ml-4 list-decimal">$1</li>');
    // Horizontal rules
    html = html.replace(/^---+$/gm, '<hr class="my-4 border-dark/[0.08]" />');
    // Line breaks
    html = html.replace(/\n\n/g, '</p><p class="mb-3">');
    html = '<p class="mb-3">' + html + '</p>';
    return html;
  }

  // ------ Diff rendering ------

  function computeDiff(textA, textB) {
    var linesA = textA.split("\n");
    var linesB = textB.split("\n");
    var result = [];
    var maxLen = Math.max(linesA.length, linesB.length);

    // Simple line-by-line diff
    var i = 0, j = 0;
    while (i < linesA.length || j < linesB.length) {
      var a = i < linesA.length ? linesA[i] : undefined;
      var b = j < linesB.length ? linesB[j] : undefined;

      if (a === b) {
        result.push({ type: "same", line: a, numA: i + 1, numB: j + 1 });
        i++; j++;
      } else if (a !== undefined && (b === undefined || linesB.indexOf(a, j) === -1)) {
        result.push({ type: "removed", line: a, numA: i + 1, numB: null });
        i++;
      } else {
        result.push({ type: "added", line: b, numA: null, numB: j + 1 });
        j++;
      }
    }
    return result;
  }

  function renderDiff(diff) {
    if (!diff.length) {
      return '<div class="text-center py-8 text-muted text-sm">No differences</div>';
    }
    var html = '<table class="w-full text-sm font-mono">';
    diff.forEach(function (d) {
      var bgClass = "";
      var prefix = " ";
      if (d.type === "removed") { bgClass = "bg-red-50"; prefix = "-"; }
      if (d.type === "added") { bgClass = "bg-green-50"; prefix = "+"; }
      var numA = d.numA != null ? d.numA : "";
      var numB = d.numB != null ? d.numB : "";
      html += '<tr class="' + bgClass + ' hover:brightness-95">';
      html += '<td class="px-2 py-0 text-right text-muted/50 select-none w-10 border-r border-dark/[0.04]">' + numA + '</td>';
      html += '<td class="px-2 py-0 text-right text-muted/50 select-none w-10 border-r border-dark/[0.04]">' + numB + '</td>';
      html += '<td class="px-1 py-0 select-none w-4 ' + (d.type === "removed" ? "text-red-500" : d.type === "added" ? "text-green-600" : "text-muted/30") + '">' + prefix + '</td>';
      html += '<td class="px-2 py-0 whitespace-pre-wrap break-all">' + escapeHtml(d.line) + '</td>';
      html += '</tr>';
    });
    html += '</table>';
    return html;
  }

  // ------ JSON validation ------

  function validateJson(text) {
    try {
      JSON.parse(text);
      return null;
    } catch (e) {
      return e.message;
    }
  }

  function checkJsonValidation() {
    if (!artifact) return;
    var cat = getFileCategory(artifact.filename);
    if (cat !== "json") {
      jsonWarning.classList.add("hidden");
      editor.classList.remove("border-red-400", "focus:border-red-400", "focus:ring-red-200/30");
      return;
    }
    var err = validateJson(editor.value);
    if (err) {
      jsonWarning.classList.remove("hidden");
      jsonErrorMsg.textContent = err;
      editor.classList.add("border-red-400", "focus:border-red-400", "focus:ring-red-200/30");
      editor.classList.remove("focus:border-coral", "focus:ring-coral/20");
    } else {
      jsonWarning.classList.add("hidden");
      editor.classList.remove("border-red-400", "focus:border-red-400", "focus:ring-red-200/30");
      editor.classList.add("focus:border-coral", "focus:ring-coral/20");
    }
  }

  // ------ Mode switching ------

  function setMode(mode) {
    currentMode = mode;
    editArea.classList.add("hidden");
    previewArea.classList.add("hidden");
    diffArea.classList.add("hidden");

    [modeEditBtn, modePreviewBtn, modeDiffBtn].forEach(function (btn) {
      btn.classList.remove("bg-dark/[0.05]", "text-dark");
      btn.classList.add("text-muted");
    });

    if (mode === "edit") {
      editArea.classList.remove("hidden");
      modeEditBtn.classList.add("bg-dark/[0.05]", "text-dark");
      modeEditBtn.classList.remove("text-muted");
    } else if (mode === "preview") {
      previewArea.classList.remove("hidden");
      modePreviewBtn.classList.add("bg-dark/[0.05]", "text-dark");
      modePreviewBtn.classList.remove("text-muted");
      renderPreview();
    } else if (mode === "diff") {
      diffArea.classList.remove("hidden");
      modeDiffBtn.classList.add("bg-dark/[0.05]", "text-dark");
      modeDiffBtn.classList.remove("text-muted");
      renderDiffView();
    }
  }

  function renderPreview() {
    var cat = getFileCategory(artifact.filename);
    var text = editor.value;

    if (cat === "markdown") {
      previewArea.innerHTML = renderMarkdown(text);
    } else if (cat === "json") {
      try {
        var parsed = JSON.parse(text);
        previewArea.innerHTML = '<pre class="bg-dark/[0.03] rounded-lg p-4 text-sm font-mono overflow-auto whitespace-pre-wrap">' + escapeHtml(JSON.stringify(parsed, null, 2)) + '</pre>';
      } catch (e) {
        previewArea.innerHTML = '<div class="text-red-600 text-sm mb-3">Invalid JSON: ' + escapeHtml(e.message) + '</div><pre class="bg-dark/[0.03] rounded-lg p-4 text-sm font-mono overflow-auto whitespace-pre-wrap">' + escapeHtml(text) + '</pre>';
      }
    } else {
      previewArea.innerHTML = '<pre class="bg-dark/[0.03] rounded-lg p-4 text-sm font-mono overflow-auto whitespace-pre-wrap">' + escapeHtml(text) + '</pre>';
    }
  }

  function renderDiffView() {
    if (versions.length < 2) {
      diffContent.innerHTML = '<div class="text-center py-8 text-muted text-sm">Need at least 2 versions for diff comparison</div>';
      return;
    }
    var verA = parseInt(diffVersionA.value);
    var verB = parseInt(diffVersionB.value);
    if (!verA || !verB || verA === verB) {
      diffContent.innerHTML = '<div class="text-center py-8 text-muted text-sm">Select two different versions</div>';
      return;
    }

    diffContent.innerHTML = '<div class="text-center py-4 text-muted text-sm">Loading...</div>';

    Promise.all([
      fetch("/api/v1/artifacts/" + encodeURIComponent(artifactId) + "/versions/" + verA).then(function (r) { return r.json(); }),
      fetch("/api/v1/artifacts/" + encodeURIComponent(artifactId) + "/versions/" + verB).then(function (r) { return r.json(); }),
    ]).then(function (results) {
      var textA = results[0].content || "";
      var textB = results[1].content || "";
      var diff = computeDiff(textA, textB);
      diffContent.innerHTML = renderDiff(diff);
    }).catch(function () {
      diffContent.innerHTML = '<div class="text-center py-4 text-red-500 text-sm">Failed to load versions</div>';
    });
  }

  // ------ Auto-save ------

  function scheduleSave() {
    if (autoSaveTimer) clearTimeout(autoSaveTimer);
    dirty = true;
    saveStatus.textContent = "Unsaved changes";
    saveStatus.classList.remove("text-zen-green");
    saveStatus.classList.add("text-muted");
    autoSaveTimer = setTimeout(doSave, 2000);
  }

  async function doSave() {
    if (saving) return;
    saving = true;
    saveStatus.textContent = "Saving...";

    try {
      var res = await fetch("/api/v1/artifacts/" + encodeURIComponent(artifactId) + "/content", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: editor.value }),
      });
      if (!res.ok) throw new Error("Save failed");
      var data = await res.json();
      dirty = false;
      saveStatus.textContent = "Saved (v" + data.version_number + ")";
      saveStatus.classList.add("text-zen-green");
      saveStatus.classList.remove("text-muted");
      artifactSize.textContent = fmtSize(data.file_size);
      originalContent = editor.value;
      loadVersions();
    } catch (err) {
      saveStatus.textContent = "Save failed";
      saveStatus.classList.remove("text-zen-green");
      saveStatus.classList.add("text-muted");
    }
    saving = false;
  }

  // ------ Data loading ------

  async function loadArtifact() {
    try {
      var res = await fetch("/api/v1/artifacts/" + encodeURIComponent(artifactId));
      if (!res.ok) throw new Error("Not found");
      artifact = await res.json();

      // Update UI
      artifactName.textContent = artifact.filename;
      artifactTypeBadge.innerHTML = typeBadge(artifact.filename);
      artifactSize.textContent = fmtSize(artifact.file_size);
      downloadLink.href = "/api/v1/artifacts/" + encodeURIComponent(artifactId) + "/download";

      // Update breadcrumb
      var crumbs = document.querySelectorAll("[data-breadcrumb-item]");
      if (crumbs.length > 1) crumbs[crumbs.length - 1].textContent = artifact.filename;

      // Show preview button for markdown
      var cat = getFileCategory(artifact.filename);
      if (cat === "markdown") {
        modePreviewBtn.classList.remove("hidden");
        modePreviewBtn.classList.add("flex");
      }

      // Show regenerate if has agent
      if (artifact.agent_id) {
        regenerateBtn.classList.remove("hidden");
        regenerateBtn.classList.add("inline-flex");
      }

      // Load content
      var contentRes = await fetch("/api/v1/artifacts/" + encodeURIComponent(artifactId) + "/content");
      if (!contentRes.ok) throw new Error("Cannot read content");
      content = await contentRes.text();
      originalContent = content;
      editor.value = content;
      checkJsonValidation();

      // Format JSON on load
      if (cat === "json") {
        try {
          var parsed = JSON.parse(content);
          editor.value = JSON.stringify(parsed, null, 2);
          originalContent = editor.value;
        } catch (_) { /* keep raw */ }
      }

      loadingState.classList.add("hidden");
      mainContent.classList.remove("hidden");

      loadVersions();
    } catch (err) {
      loadingState.classList.add("hidden");
      errorState.classList.remove("hidden");
    }
  }

  async function loadVersions() {
    try {
      var res = await fetch("/api/v1/artifacts/" + encodeURIComponent(artifactId) + "/versions");
      if (!res.ok) return;
      versions = await res.json();
      versionCount.textContent = versions.length + " version" + (versions.length !== 1 ? "s" : "");
      renderVersionsList();
      populateDiffSelectors();
    } catch (_) { /* ignore */ }
  }

  function renderVersionsList() {
    if (!versions.length) {
      versionsList.innerHTML = '<div class="px-4 py-6 text-center text-sm text-muted">No versions yet</div>';
      return;
    }

    versionsList.innerHTML = versions.map(function (v) {
      return '<div class="px-4 py-3 hover:bg-dark/[0.02] cursor-pointer transition-colors" data-restore-version="' + v.version_number + '">'
        + '<div class="flex items-center justify-between">'
        + '<span class="text-sm font-medium text-dark">Version ' + v.version_number + '</span>'
        + '<span class="text-xs text-muted">' + fmtSize(v.file_size) + '</span>'
        + '</div>'
        + '<p class="text-xs text-muted mt-0.5">' + fmtTime(v.created_at) + '</p>'
        + '</div>';
    }).join("");

    // Attach restore listeners
    versionsList.querySelectorAll("[data-restore-version]").forEach(function (el) {
      el.addEventListener("click", function () {
        var verNum = parseInt(el.dataset.restoreVersion);
        restoreVersion(verNum);
      });
    });
  }

  function populateDiffSelectors() {
    var opts = versions.map(function (v) {
      return '<option value="' + v.version_number + '">Version ' + v.version_number + '</option>';
    }).join("");

    diffVersionA.innerHTML = opts;
    diffVersionB.innerHTML = opts;

    // Default: compare second-to-last vs last
    if (versions.length >= 2) {
      diffVersionA.value = versions[1].version_number;
      diffVersionB.value = versions[0].version_number;
    }
  }

  async function restoreVersion(versionNumber) {
    try {
      var res = await fetch("/api/v1/artifacts/" + encodeURIComponent(artifactId) + "/versions/" + versionNumber);
      if (!res.ok) throw new Error("Failed to load version");
      var data = await res.json();
      editor.value = data.content;
      checkJsonValidation();
      setMode("edit");
      scheduleSave();
    } catch (_) { /* ignore */ }
  }

  // ------ Regenerate ------

  function openRegenerateDialog() {
    regenInstructions.value = "";
    regenError.classList.add("hidden");
    regenerateDialog.showModal();
  }

  async function doRegenerate() {
    var instructions = regenInstructions.value.trim();
    if (!instructions) return;

    regenSubmit.disabled = true;
    regenSubmit.textContent = "Regenerating...";
    regenError.classList.add("hidden");

    try {
      var res = await fetch("/api/v1/artifacts/" + encodeURIComponent(artifactId) + "/regenerate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ instructions: instructions }),
      });
      if (!res.ok) {
        var err = await res.json().catch(function () { return {}; });
        throw new Error(err.detail || "Regeneration failed");
      }
      var data = await res.json();
      editor.value = data.content;
      originalContent = data.content;
      dirty = false;
      saveStatus.textContent = "Regenerated (v" + data.version_number + ")";
      saveStatus.classList.add("text-zen-green");
      artifactSize.textContent = fmtSize(data.file_size);
      checkJsonValidation();
      regenerateDialog.close();
      loadVersions();
    } catch (e) {
      regenError.textContent = e.message;
      regenError.classList.remove("hidden");
    }

    regenSubmit.disabled = false;
    regenSubmit.textContent = "Regenerate";
  }

  // ------ Tab key support ------

  editor.addEventListener("keydown", function (e) {
    if (e.key === "Tab") {
      e.preventDefault();
      var start = editor.selectionStart;
      var end = editor.selectionEnd;
      editor.value = editor.value.substring(0, start) + "  " + editor.value.substring(end);
      editor.selectionStart = editor.selectionEnd = start + 2;
      scheduleSave();
    }
    // Ctrl+S / Cmd+S to save immediately
    if ((e.ctrlKey || e.metaKey) && e.key === "s") {
      e.preventDefault();
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
      doSave();
    }
  });

  // ------ Events ------

  editor.addEventListener("input", function () {
    checkJsonValidation();
    scheduleSave();
  });

  saveBtn.addEventListener("click", function () {
    if (autoSaveTimer) clearTimeout(autoSaveTimer);
    doSave();
  });

  modeEditBtn.addEventListener("click", function () { setMode("edit"); });
  modePreviewBtn.addEventListener("click", function () { setMode("preview"); });
  modeDiffBtn.addEventListener("click", function () { setMode("diff"); });

  toggleVersionsBtn.addEventListener("click", function () {
    versionsPanel.classList.toggle("hidden");
  });
  closeVersionsBtn.addEventListener("click", function () {
    versionsPanel.classList.add("hidden");
  });

  regenerateBtn.addEventListener("click", openRegenerateDialog);
  regenCancel.addEventListener("click", function () { regenerateDialog.close(); });
  regenSubmit.addEventListener("click", doRegenerate);
  regenerateDialog.addEventListener("click", function (e) {
    if (e.target === regenerateDialog) regenerateDialog.close();
  });

  diffVersionA.addEventListener("change", function () {
    if (currentMode === "diff") renderDiffView();
  });
  diffVersionB.addEventListener("change", function () {
    if (currentMode === "diff") renderDiffView();
  });

  // Warn on unsaved changes when leaving
  window.addEventListener("beforeunload", function (e) {
    if (dirty) {
      e.preventDefault();
      e.returnValue = "";
    }
  });

  // ------ Init ------
  loadArtifact();
})();
</script>
