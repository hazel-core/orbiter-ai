---
import PageLayout from "../layouts/PageLayout.astro";

const breadcrumbs = [{ label: "Version History" }];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const historyIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';
const rollbackIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>';
const tagIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>';
const downloadIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
const diffIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>';
const checkIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
const editPenIcon = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
---

<PageLayout
  title="Version History"
  description="View and manage version history"
  activeSection="agents"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Loading -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <div class="animate-spin h-6 w-6 border-2 border-coral border-t-transparent rounded-full"></div>
    </div>

    <!-- Error -->
    <div id="error-state" class="hidden text-center py-20">
      <p class="text-muted mb-4">Could not load version history. Missing type or id parameter.</p>
      <a href="/agents" class="text-coral hover:text-coral/80 text-sm">Back to Agents</a>
    </div>

    <!-- Main content -->
    <div id="main-content" class="hidden">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
        <div class="flex items-center gap-3">
          <a id="back-link" href="/agents" class="p-2 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors" title="Back">
            <span set:html={backIcon} />
          </a>
          <div>
            <div class="flex items-center gap-2">
              <span class="text-muted" set:html={historyIcon} />
              <h1 id="entity-name" class="text-xl font-semibold text-dark">Version History</h1>
            </div>
            <p id="entity-meta" class="text-sm text-muted mt-0.5"></p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <!-- Diff toggle -->
          <button id="diff-toggle" class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-dark bg-paper border border-dark/[0.08] rounded-lg hover:bg-dark/[0.05] transition-colors cursor-pointer">
            <span set:html={diffIcon} />
            Compare Versions
          </button>
        </div>
      </div>

      <!-- Diff panel (hidden by default) -->
      <div id="diff-panel" class="hidden mb-6">
        <div class="bg-white border border-dark/[0.06] rounded-xl shadow-sm overflow-hidden">
          <div class="flex items-center gap-3 px-4 py-3 bg-dark/[0.02] border-b border-dark/[0.06]">
            <select id="diff-version-a" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-1.5 text-sm text-dark outline-none cursor-pointer"></select>
            <span class="text-sm text-muted font-medium">vs</span>
            <select id="diff-version-b" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-1.5 text-sm text-dark outline-none cursor-pointer"></select>
            <button id="run-diff" class="ml-auto px-3 py-1.5 text-sm font-medium text-white bg-coral rounded-lg hover:bg-coral/90 transition-colors cursor-pointer">
              Compare
            </button>
          </div>
          <div id="diff-content" class="p-4 font-mono text-sm overflow-auto" style="max-height: 600px;">
            <div class="text-center py-8 text-muted text-sm">Select two versions and click Compare</div>
          </div>
        </div>
      </div>

      <!-- Version list -->
      <div id="version-list" class="space-y-2"></div>

      <!-- Empty state -->
      <div id="empty-state" class="hidden text-center py-16">
        <span class="text-muted" set:html={historyIcon} />
        <p class="text-muted mt-3">No versions recorded yet</p>
      </div>
    </div>
  </div>

  <!-- Rollback confirmation dialog -->
  <dialog id="rollback-dialog" class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-md w-full">
    <div class="p-6">
      <h3 class="text-lg font-semibold text-dark mb-2">Rollback to Version <span id="rollback-version-num"></span>?</h3>
      <p class="text-sm text-muted mb-4">This will restore the configuration from version <span id="rollback-version-num2"></span>. A new version will be created recording this rollback.</p>
      <div class="flex justify-end gap-3">
        <button id="rollback-cancel" class="px-4 py-2 text-sm font-medium text-muted hover:text-dark border border-dark/[0.08] rounded-lg transition-colors cursor-pointer">Cancel</button>
        <button id="rollback-confirm" class="px-4 py-2 text-sm font-medium text-white bg-coral hover:bg-coral/90 rounded-lg transition-colors cursor-pointer">Rollback</button>
      </div>
    </div>
  </dialog>

  <!-- Tag edit dialog -->
  <dialog id="tag-dialog" class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-sm w-full">
    <div class="p-6">
      <h3 class="text-lg font-semibold text-dark mb-4">Edit Tag</h3>
      <input type="text" id="tag-input" class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all" placeholder="e.g., stable, production, v1.0" maxlength="100" />
      <div class="flex justify-end gap-3 mt-4">
        <button id="tag-cancel" class="px-4 py-2 text-sm font-medium text-muted hover:text-dark border border-dark/[0.08] rounded-lg transition-colors cursor-pointer">Cancel</button>
        <button id="tag-save" class="px-4 py-2 text-sm font-medium text-white bg-coral hover:bg-coral/90 rounded-lg transition-colors cursor-pointer">Save Tag</button>
      </div>
    </div>
  </dialog>
</PageLayout>

<script is:inline>
(function () {
  // Parse query params
  var params = new URLSearchParams(window.location.search);
  var entityType = params.get("type"); // "agent" or "workflow"
  var entityId = params.get("id");

  if (!entityType || !entityId || (entityType !== "agent" && entityType !== "workflow")) {
    document.getElementById("loading-state").classList.add("hidden");
    document.getElementById("error-state").classList.remove("hidden");
    return;
  }

  // State
  var versions = [];
  var entityName = "";
  var pendingRollbackVersionId = null;
  var pendingRollbackVersionNum = null;
  var pendingTagVersionId = null;
  var diffVisible = false;

  // DOM refs
  var loadingState = document.getElementById("loading-state");
  var errorState = document.getElementById("error-state");
  var mainContent = document.getElementById("main-content");
  var backLink = document.getElementById("back-link");
  var entityNameEl = document.getElementById("entity-name");
  var entityMeta = document.getElementById("entity-meta");
  var versionList = document.getElementById("version-list");
  var emptyState = document.getElementById("empty-state");
  var diffToggle = document.getElementById("diff-toggle");
  var diffPanel = document.getElementById("diff-panel");
  var diffVersionA = document.getElementById("diff-version-a");
  var diffVersionB = document.getElementById("diff-version-b");
  var diffContent = document.getElementById("diff-content");
  var runDiffBtn = document.getElementById("run-diff");

  // Rollback dialog
  var rollbackDialog = document.getElementById("rollback-dialog");
  var rollbackVersionNum = document.getElementById("rollback-version-num");
  var rollbackVersionNum2 = document.getElementById("rollback-version-num2");
  var rollbackCancel = document.getElementById("rollback-cancel");
  var rollbackConfirm = document.getElementById("rollback-confirm");

  // Tag dialog
  var tagDialog = document.getElementById("tag-dialog");
  var tagInput = document.getElementById("tag-input");
  var tagCancel = document.getElementById("tag-cancel");
  var tagSave = document.getElementById("tag-save");

  // Set back link
  if (entityType === "agent") {
    backLink.href = "/agents/" + entityId + "/edit";
    backLink.title = "Back to Agent";
  } else {
    backLink.href = "/workflows/" + entityId;
    backLink.title = "Back to Workflow";
  }

  // Helpers
  function escapeHtml(str) {
    var div = document.createElement("div");
    div.textContent = str || "";
    return div.innerHTML;
  }

  function fmtTime(t) {
    if (!t) return "";
    var d = new Date(t + "Z");
    return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
  }

  function fmtTimeAgo(t) {
    if (!t) return "";
    var d = new Date(t + "Z");
    var now = new Date();
    var diff = now - d;
    if (diff < 60000) return "just now";
    if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
    if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
    if (diff < 604800000) return Math.floor(diff / 86400000) + "d ago";
    return fmtTime(t);
  }

  function showToast(msg, type) {
    var existing = document.getElementById("version-toast");
    if (existing) existing.remove();
    var toast = document.createElement("div");
    toast.id = "version-toast";
    toast.className = "fixed bottom-6 right-6 z-50 px-4 py-3 rounded-lg shadow-lg text-sm font-medium transition-opacity " + (type === "error" ? "bg-red-600 text-white" : "bg-zen-green text-white");
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(function () { toast.style.opacity = "0"; }, 2500);
    setTimeout(function () { toast.remove(); }, 3000);
  }

  // Load entity info
  async function loadEntity() {
    try {
      var url = entityType === "agent"
        ? "/api/v1/agents/" + encodeURIComponent(entityId)
        : "/api/v1/workflows/" + encodeURIComponent(entityId);
      var res = await fetch(url);
      if (!res.ok) throw new Error("Not found");
      var data = await res.json();
      entityName = data.name || "Untitled";
      entityNameEl.textContent = "Version History: " + entityName;
      entityMeta.textContent = (entityType === "agent" ? "Agent" : "Workflow") + " \u00b7 " + versions.length + " version" + (versions.length !== 1 ? "s" : "");

      // Update breadcrumbs
      var crumbs = document.querySelectorAll("[data-breadcrumb-item]");
      if (crumbs.length > 0) crumbs[crumbs.length - 1].textContent = "Version History: " + entityName;
    } catch (_) {
      // Entity info is not critical
    }
  }

  // Load versions
  async function loadVersions() {
    try {
      var url = entityType === "agent"
        ? "/api/v1/agents/" + encodeURIComponent(entityId) + "/versions"
        : "/api/v1/workflows/" + encodeURIComponent(entityId) + "/versions";
      var res = await fetch(url);
      if (!res.ok) throw new Error("Failed");
      versions = await res.json();

      loadingState.classList.add("hidden");
      mainContent.classList.remove("hidden");

      if (versions.length === 0) {
        versionList.classList.add("hidden");
        emptyState.classList.remove("hidden");
      } else {
        versionList.classList.remove("hidden");
        emptyState.classList.add("hidden");
        renderVersions();
        populateDiffSelectors();
      }

      entityMeta.textContent = (entityType === "agent" ? "Agent" : "Workflow") + " \u00b7 " + versions.length + " version" + (versions.length !== 1 ? "s" : "");
    } catch (err) {
      loadingState.classList.add("hidden");
      errorState.classList.remove("hidden");
    }
  }

  function renderVersions() {
    versionList.innerHTML = versions.map(function (v, idx) {
      var isCurrent = idx === 0;
      var config = {};
      try { config = JSON.parse(v.config_json || "{}"); } catch (_) {}

      var changeSummary = v.summary || "";
      if (!changeSummary) {
        // Auto-generate summary from config
        var parts = [];
        if (config.name) parts.push("name: " + config.name);
        if (config.model_provider && config.model_name) parts.push("model: " + config.model_provider + "/" + config.model_name);
        if (config.status) parts.push("status: " + config.status);
        changeSummary = parts.length > 0 ? parts.join(", ") : "Configuration snapshot";
      }

      var tagHtml = "";
      if (v.tag) {
        tagHtml = '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-coral/10 text-coral border border-coral/20">'
          + escapeHtml(v.tag)
          + '</span>';
      }

      return '<div class="bg-white border border-dark/[0.06] rounded-xl shadow-sm overflow-hidden hover:border-dark/[0.12] transition-colors" data-version-id="' + v.id + '">'
        + '<div class="px-5 py-4">'
        + '  <div class="flex items-start justify-between gap-4">'
        + '    <div class="flex-1 min-w-0">'
        + '      <div class="flex items-center gap-2 flex-wrap">'
        + '        <span class="text-sm font-semibold text-dark">Version ' + v.version_num + '</span>'
        + (isCurrent ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-zen-green/10 text-zen-green border border-zen-green/20">Current</span>' : '')
        + tagHtml
        + '      </div>'
        + '      <p class="text-sm text-muted mt-1">' + escapeHtml(changeSummary) + '</p>'
        + '      <div class="flex items-center gap-3 mt-2 text-xs text-muted">'
        + '        <span>' + fmtTime(v.created_at) + '</span>'
        + '        <span>\u00b7</span>'
        + '        <span>' + fmtTimeAgo(v.created_at) + '</span>'
        + (v.author ? '<span>\u00b7</span><span>by ' + escapeHtml(v.author.substring(0, 8)) + '</span>' : '')
        + '      </div>'
        + '    </div>'
        + '    <div class="flex items-center gap-1 shrink-0">'
        + '      <button class="version-tag-btn p-2 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors cursor-pointer" title="Edit tag" data-vid="' + v.id + '" data-vtag="' + escapeHtml(v.tag || "") + '">'
        + '        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>'
        + '      </button>'
        + '      <button class="version-export-btn p-2 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors cursor-pointer" title="Export as JSON" data-vid="' + v.id + '" data-vnum="' + v.version_num + '">'
        + '        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>'
        + '      </button>'
        + (!isCurrent ? '<button class="version-rollback-btn p-2 rounded-lg hover:bg-coral/10 text-muted hover:text-coral transition-colors cursor-pointer" title="Rollback to this version" data-vid="' + v.id + '" data-vnum="' + v.version_num + '">'
          + '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>'
          + '</button>' : '')
        + '    </div>'
        + '  </div>'
        + '</div>'
        + '</div>';
    }).join("");

    // Attach event listeners
    versionList.querySelectorAll(".version-rollback-btn").forEach(function (btn) {
      btn.addEventListener("click", function () {
        pendingRollbackVersionId = btn.dataset.vid;
        pendingRollbackVersionNum = btn.dataset.vnum;
        rollbackVersionNum.textContent = btn.dataset.vnum;
        rollbackVersionNum2.textContent = btn.dataset.vnum;
        rollbackDialog.showModal();
      });
    });

    versionList.querySelectorAll(".version-tag-btn").forEach(function (btn) {
      btn.addEventListener("click", function () {
        pendingTagVersionId = btn.dataset.vid;
        tagInput.value = btn.dataset.vtag || "";
        tagDialog.showModal();
        tagInput.focus();
      });
    });

    versionList.querySelectorAll(".version-export-btn").forEach(function (btn) {
      btn.addEventListener("click", function () {
        exportVersion(btn.dataset.vid, btn.dataset.vnum);
      });
    });
  }

  function populateDiffSelectors() {
    var opts = versions.map(function (v) {
      return '<option value="' + v.version_num + '">Version ' + v.version_num + (v.tag ? " (" + escapeHtml(v.tag) + ")" : "") + '</option>';
    }).join("");
    diffVersionA.innerHTML = opts;
    diffVersionB.innerHTML = opts;
    if (versions.length >= 2) {
      diffVersionA.value = versions[1].version_num;
      diffVersionB.value = versions[0].version_num;
    }
  }

  // Diff
  function computeJsonDiff(objA, objB) {
    var keysA = Object.keys(objA);
    var keysB = Object.keys(objB);
    var allKeys = Array.from(new Set(keysA.concat(keysB))).sort();
    var lines = [];

    allKeys.forEach(function (key) {
      var valA = key in objA ? JSON.stringify(objA[key], null, 2) : undefined;
      var valB = key in objB ? JSON.stringify(objB[key], null, 2) : undefined;

      if (valA === valB) {
        // unchanged
        var display = '"' + key + '": ' + valA;
        display.split("\n").forEach(function (l) {
          lines.push({ type: "same", text: l });
        });
      } else {
        if (valA !== undefined) {
          var displayA = '"' + key + '": ' + valA;
          displayA.split("\n").forEach(function (l) {
            lines.push({ type: "removed", text: l });
          });
        }
        if (valB !== undefined) {
          var displayB = '"' + key + '": ' + valB;
          displayB.split("\n").forEach(function (l) {
            lines.push({ type: "added", text: l });
          });
        }
      }
    });

    return lines;
  }

  function renderDiffLines(lines) {
    if (!lines.length) {
      return '<div class="text-center py-8 text-muted text-sm">No differences found</div>';
    }

    var html = '<table class="w-full text-sm">';
    var numA = 0, numB = 0;
    lines.forEach(function (d) {
      var bgClass = "";
      var prefix = " ";
      if (d.type === "removed") { bgClass = "bg-red-50"; prefix = "\u2212"; numA++; }
      else if (d.type === "added") { bgClass = "bg-green-50"; prefix = "+"; numB++; }
      else { numA++; numB++; }

      html += '<tr class="' + bgClass + ' hover:brightness-95">';
      html += '<td class="px-2 py-0 text-right text-muted/50 select-none w-10 border-r border-dark/[0.04] font-mono text-xs">' + (d.type !== "added" ? numA : "") + '</td>';
      html += '<td class="px-2 py-0 text-right text-muted/50 select-none w-10 border-r border-dark/[0.04] font-mono text-xs">' + (d.type !== "removed" ? numB : "") + '</td>';
      html += '<td class="px-1 py-0 select-none w-4 font-mono ' + (d.type === "removed" ? "text-red-500" : d.type === "added" ? "text-green-600" : "text-muted/30") + '">' + prefix + '</td>';
      html += '<td class="px-2 py-0 whitespace-pre-wrap break-all font-mono">' + escapeHtml(d.text) + '</td>';
      html += '</tr>';
    });
    html += '</table>';
    return html;
  }

  async function runDiff() {
    var verA = parseInt(diffVersionA.value);
    var verB = parseInt(diffVersionB.value);
    if (!verA || !verB) {
      diffContent.innerHTML = '<div class="text-center py-8 text-muted text-sm">Select two versions</div>';
      return;
    }
    if (verA === verB) {
      diffContent.innerHTML = '<div class="text-center py-8 text-muted text-sm">Select two different versions</div>';
      return;
    }

    diffContent.innerHTML = '<div class="text-center py-4"><div class="animate-spin h-5 w-5 border-2 border-coral border-t-transparent rounded-full mx-auto"></div></div>';

    // Find config_json for both versions
    var vA = versions.find(function (v) { return v.version_num === verA; });
    var vB = versions.find(function (v) { return v.version_num === verB; });

    if (!vA || !vB) {
      diffContent.innerHTML = '<div class="text-center py-8 text-red-500 text-sm">Version not found</div>';
      return;
    }

    try {
      var configA = JSON.parse(vA.config_json || "{}");
      var configB = JSON.parse(vB.config_json || "{}");
      var lines = computeJsonDiff(configA, configB);
      diffContent.innerHTML = renderDiffLines(lines);
    } catch (e) {
      diffContent.innerHTML = '<div class="text-center py-8 text-red-500 text-sm">Failed to parse version configs</div>';
    }
  }

  // Rollback
  async function doRollback() {
    if (!pendingRollbackVersionId) return;
    rollbackConfirm.disabled = true;
    rollbackConfirm.textContent = "Rolling back...";

    try {
      var url = entityType === "agent"
        ? "/api/v1/agents/" + encodeURIComponent(entityId) + "/versions/" + encodeURIComponent(pendingRollbackVersionId) + "/rollback"
        : "/api/v1/workflows/" + encodeURIComponent(entityId) + "/versions/" + encodeURIComponent(pendingRollbackVersionId) + "/rollback";
      var res = await fetch(url, { method: "POST" });
      if (!res.ok) throw new Error("Rollback failed");
      rollbackDialog.close();
      showToast("Rolled back to version " + pendingRollbackVersionNum, "success");
      await loadVersions();
    } catch (e) {
      showToast("Rollback failed: " + e.message, "error");
    }

    rollbackConfirm.disabled = false;
    rollbackConfirm.textContent = "Rollback";
    pendingRollbackVersionId = null;
    pendingRollbackVersionNum = null;
  }

  // Tag
  async function doTagSave() {
    if (!pendingTagVersionId) return;
    var tag = tagInput.value.trim();
    if (!tag) return;

    tagSave.disabled = true;
    tagSave.textContent = "Saving...";

    try {
      var url = entityType === "agent"
        ? "/api/v1/agents/" + encodeURIComponent(entityId) + "/versions/" + encodeURIComponent(pendingTagVersionId) + "/tag"
        : "/api/v1/workflows/" + encodeURIComponent(entityId) + "/versions/" + encodeURIComponent(pendingTagVersionId) + "/tag";
      var res = await fetch(url, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tag: tag }),
      });
      if (!res.ok) throw new Error("Failed to save tag");
      tagDialog.close();
      showToast("Tag updated", "success");
      await loadVersions();
    } catch (e) {
      showToast("Failed to save tag: " + e.message, "error");
    }

    tagSave.disabled = false;
    tagSave.textContent = "Save Tag";
    pendingTagVersionId = null;
  }

  // Export
  function exportVersion(versionId, versionNum) {
    var version = versions.find(function (v) { return v.id === versionId; });
    if (!version) return;

    var config = {};
    try { config = JSON.parse(version.config_json || "{}"); } catch (_) {}

    var exportData = {
      entity_type: entityType,
      entity_id: entityId,
      entity_name: entityName,
      version_num: version.version_num,
      tag: version.tag,
      summary: version.summary,
      author: version.author,
      created_at: version.created_at,
      config: config,
    };

    var blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = entityType + "-" + entityId.substring(0, 8) + "-v" + versionNum + ".json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast("Exported version " + versionNum, "success");
  }

  // Events
  diffToggle.addEventListener("click", function () {
    diffVisible = !diffVisible;
    if (diffVisible) {
      diffPanel.classList.remove("hidden");
      diffToggle.classList.add("bg-dark/[0.05]");
    } else {
      diffPanel.classList.add("hidden");
      diffToggle.classList.remove("bg-dark/[0.05]");
    }
  });

  runDiffBtn.addEventListener("click", runDiff);
  diffVersionA.addEventListener("change", function () { if (diffVisible) runDiff(); });
  diffVersionB.addEventListener("change", function () { if (diffVisible) runDiff(); });

  rollbackCancel.addEventListener("click", function () { rollbackDialog.close(); });
  rollbackConfirm.addEventListener("click", doRollback);
  rollbackDialog.addEventListener("click", function (e) { if (e.target === rollbackDialog) rollbackDialog.close(); });

  tagCancel.addEventListener("click", function () { tagDialog.close(); });
  tagSave.addEventListener("click", doTagSave);
  tagInput.addEventListener("keydown", function (e) { if (e.key === "Enter") doTagSave(); });
  tagDialog.addEventListener("click", function (e) { if (e.target === tagDialog) tagDialog.close(); });

  // Init
  loadVersions().then(function () { loadEntity(); });
})();
</script>
