---
import PageLayout from "../layouts/PageLayout.astro";
import Modal from "../components/Modal.astro";

const breadcrumbs = [{ label: "Deployments" }];

/* Icons */
const rocketIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 4 0 4 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-4 0-4"/></svg>';
const searchIcon = '<svg class="h-4 w-4 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
const copyIcon = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
const trashIcon = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
const emptyIcon = '<svg class="h-12 w-12 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 4 0 4 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-4 0-4"/></svg>';
---

<PageLayout
  title="Deployments"
  description="Manage deployed API endpoints"
  activeSection="deployments"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Deployments</h1>
        <p class="text-sm text-muted mt-1">Manage your deployed agent and workflow API endpoints</p>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex items-center gap-3 mb-6 flex-wrap">
      <div class="relative flex-1 min-w-[200px] max-w-sm">
        <span class="absolute left-3 top-1/2 -translate-y-1/2" set:html={searchIcon} />
        <input
          type="text"
          id="dep-search"
          placeholder="Search deployments..."
          class="w-full bg-paper border border-dark/[0.08] rounded-lg pl-9 pr-3 py-2 text-sm text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        />
      </div>
      <select
        id="filter-status"
        class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer"
      >
        <option value="">All statuses</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
      <select
        id="filter-type"
        class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer"
      >
        <option value="">All types</option>
        <option value="agent">Agent</option>
        <option value="workflow">Workflow</option>
      </select>
    </div>

    <!-- Table -->
    <div id="dep-table-wrap" class="bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-subtle/50 border-b border-dark/[0.06]">
            <th class="text-left px-4 py-3 text-xs font-semibold text-muted uppercase tracking-wider">Name</th>
            <th class="text-left px-4 py-3 text-xs font-semibold text-muted uppercase tracking-wider">Entity</th>
            <th class="text-left px-4 py-3 text-xs font-semibold text-muted uppercase tracking-wider">Status</th>
            <th class="text-left px-4 py-3 text-xs font-semibold text-muted uppercase tracking-wider">Requests</th>
            <th class="text-left px-4 py-3 text-xs font-semibold text-muted uppercase tracking-wider">Rate Limit</th>
            <th class="text-left px-4 py-3 text-xs font-semibold text-muted uppercase tracking-wider">Created</th>
            <th class="text-right px-4 py-3 text-xs font-semibold text-muted uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="dep-tbody" class="divide-y divide-dark/[0.04]"></tbody>
      </table>
    </div>

    <!-- Empty state -->
    <div id="dep-empty" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <span set:html={emptyIcon} />
      <p class="text-lg font-semibold text-dark mt-4 mb-1">No deployments yet</p>
      <p class="text-sm text-muted mb-4">Deploy agents or workflows as API endpoints from their detail pages.</p>
    </div>

    <!-- Loading state -->
    <div id="dep-loading" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading deployments...</p>
    </div>
  </div>

  <!-- Deployment detail modal -->
  <Modal id="detail-modal" title="Deployment Details">
    <div class="flex flex-col gap-5">
      <!-- Endpoint URL -->
      <div class="flex flex-col gap-1.5">
        <label class="text-xs font-semibold text-muted uppercase tracking-wider">API Endpoint</label>
        <div class="flex items-center gap-2">
          <code id="detail-url" class="flex-1 bg-subtle/80 border border-dark/[0.06] rounded-lg px-3 py-2 text-sm font-mono text-dark break-all"></code>
          <button id="copy-url-btn" class="shrink-0 p-2 rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-subtle transition-colors cursor-pointer" title="Copy URL">
            <span set:html={copyIcon} />
          </button>
        </div>
      </div>

      <!-- Usage example -->
      <div class="flex flex-col gap-1.5">
        <div class="flex items-center justify-between">
          <label class="text-xs font-semibold text-muted uppercase tracking-wider">Usage Example (curl)</label>
          <button id="copy-curl-btn" class="text-[11px] text-coral hover:underline cursor-pointer">Copy</button>
        </div>
        <pre id="detail-curl" class="bg-dark text-paper rounded-lg px-4 py-3 text-xs font-mono overflow-x-auto whitespace-pre-wrap leading-relaxed"></pre>
      </div>

      <!-- OpenAPI spec link -->
      <div class="flex flex-col gap-1.5">
        <label class="text-xs font-semibold text-muted uppercase tracking-wider">API Documentation</label>
        <a id="detail-docs-link" href="/docs" target="_blank" class="text-sm text-coral hover:underline">
          View OpenAPI/Swagger documentation &rarr;
        </a>
        <p class="text-xs text-muted">Auto-generated API docs are available at the FastAPI /docs endpoint.</p>
      </div>

      <!-- Rate limiting -->
      <div class="flex flex-col gap-1.5">
        <label class="text-xs font-semibold text-muted uppercase tracking-wider">Rate Limit (requests/min)</label>
        <div class="flex items-center gap-2">
          <input
            type="number"
            id="detail-rate-limit"
            min="1"
            max="10000"
            class="w-32 bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
          />
          <button id="save-rate-limit-btn" class="px-3 py-2 text-xs font-medium bg-dark text-paper rounded-lg hover:bg-dark/80 transition-colors cursor-pointer">
            Save
          </button>
        </div>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-3 gap-3">
        <div class="bg-subtle/50 rounded-lg px-3 py-2 text-center">
          <p class="text-xs text-muted">Total Requests</p>
          <p id="detail-usage" class="text-lg font-semibold text-dark tabular-nums">0</p>
        </div>
        <div class="bg-subtle/50 rounded-lg px-3 py-2 text-center">
          <p class="text-xs text-muted">Status</p>
          <p id="detail-status" class="text-lg font-semibold text-dark">—</p>
        </div>
        <div class="bg-subtle/50 rounded-lg px-3 py-2 text-center">
          <p class="text-xs text-muted">Created</p>
          <p id="detail-created" class="text-sm font-medium text-dark mt-1">—</p>
        </div>
      </div>
    </div>
  </Modal>

  <!-- Delete confirmation modal -->
  <Modal id="delete-modal" title="Delete Deployment">
    <p class="text-sm text-dark mb-4">Are you sure you want to delete this deployment? The API key will be permanently revoked and any consumers will lose access.</p>
    <div class="flex items-center justify-end gap-3">
      <button data-modal-close class="px-4 py-2 text-sm text-muted hover:text-dark transition-colors cursor-pointer">Cancel</button>
      <button id="confirm-delete-btn" class="px-4 py-2 text-sm font-medium bg-coral text-white rounded-lg hover:bg-coral/80 transition-colors cursor-pointer">Delete</button>
    </div>
  </Modal>
</PageLayout>

<script is:inline>
  const tbody = document.getElementById("dep-tbody");
  const emptyEl = document.getElementById("dep-empty");
  const loadingEl = document.getElementById("dep-loading");
  const tableWrap = document.getElementById("dep-table-wrap");
  const searchInput = document.getElementById("dep-search");
  const filterStatus = document.getElementById("filter-status");
  const filterType = document.getElementById("filter-type");

  let deployments = [];
  let selectedId = null;
  let deleteId = null;

  /* ---- Fetch ---- */
  async function loadDeployments() {
    try {
      const resp = await fetch("/api/v1/deployments");
      if (!resp.ok) throw new Error("Failed");
      const body = await resp.json();
      deployments = body.data || body;
      render();
    } catch {
      loadingEl.classList.add("hidden");
      emptyEl.classList.remove("hidden");
      tableWrap.classList.add("hidden");
    }
  }

  /* ---- Render ---- */
  function render() {
    const q = (searchInput.value || "").toLowerCase();
    const st = filterStatus.value;
    const tp = filterType.value;

    const filtered = deployments.filter(function (d) {
      if (q && !d.name.toLowerCase().includes(q) && !(d.entity_name || "").toLowerCase().includes(q)) return false;
      if (st && d.status !== st) return false;
      if (tp && d.entity_type !== tp) return false;
      return true;
    });

    loadingEl.classList.add("hidden");
    if (filtered.length === 0) {
      tableWrap.classList.add("hidden");
      emptyEl.classList.remove("hidden");
      return;
    }
    tableWrap.classList.remove("hidden");
    emptyEl.classList.add("hidden");

    tbody.innerHTML = filtered.map(function (d) {
      var statusColor = d.status === "active"
        ? "bg-zen-green/20 text-zen-green"
        : "bg-muted/20 text-muted";
      var typeBadge = d.entity_type === "agent"
        ? '<span class="text-[10px] font-medium bg-coral/10 text-coral rounded-full px-2 py-0.5">Agent</span>'
        : '<span class="text-[10px] font-medium bg-zen-blue/10 text-zen-blue rounded-full px-2 py-0.5">Workflow</span>';
      var entityHref = d.entity_type === "agent"
        ? "/agents/" + d.entity_id + "/edit"
        : "/workflows/" + d.entity_id;
      var createdDate = d.created_at ? new Date(d.created_at + "Z").toLocaleDateString() : "—";
      return '<tr class="hover:bg-subtle/30 transition-colors">'
        + '<td class="px-4 py-3">'
        +   '<button class="text-sm font-medium text-dark hover:text-coral transition-colors cursor-pointer text-left" data-detail="' + d.id + '">' + escapeHtml(d.name) + '</button>'
        + '</td>'
        + '<td class="px-4 py-3">'
        +   '<div class="flex items-center gap-2">'
        +     typeBadge
        +     '<a href="' + entityHref + '" class="text-sm text-muted hover:text-dark transition-colors">' + escapeHtml(d.entity_name || d.entity_id) + '</a>'
        +   '</div>'
        + '</td>'
        + '<td class="px-4 py-3">'
        +   '<button class="toggle-status cursor-pointer" data-id="' + d.id + '" data-status="' + d.status + '" title="Click to toggle">'
        +     '<span class="inline-flex items-center gap-1 text-xs font-medium rounded-full px-2.5 py-1 ' + statusColor + '">'
        +       '<span class="w-1.5 h-1.5 rounded-full ' + (d.status === "active" ? "bg-zen-green" : "bg-muted") + '"></span>'
        +       d.status
        +     '</span>'
        +   '</button>'
        + '</td>'
        + '<td class="px-4 py-3 text-sm text-dark tabular-nums">' + (d.usage_count || 0).toLocaleString() + '</td>'
        + '<td class="px-4 py-3 text-sm text-muted tabular-nums">' + d.rate_limit + '/min</td>'
        + '<td class="px-4 py-3 text-sm text-muted">' + createdDate + '</td>'
        + '<td class="px-4 py-3 text-right">'
        +   '<div class="flex items-center justify-end gap-1">'
        +     '<a href="/deployments/' + d.id + '/widget" class="p-1.5 rounded text-muted hover:text-zen-blue transition-colors" title="Widget settings">'
        +       '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>'
        +     '</a>'
        +     '<button class="delete-dep p-1.5 rounded text-muted hover:text-coral transition-colors cursor-pointer" data-id="' + d.id + '" title="Delete">'
        +       '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>'
        +     '</button>'
        +   '</div>'
        + '</td>'
        + '</tr>';
    }).join("");
  }

  function escapeHtml(s) {
    var d = document.createElement("div");
    d.textContent = s || "";
    return d.innerHTML;
  }

  /* ---- Filters ---- */
  searchInput.addEventListener("input", render);
  filterStatus.addEventListener("change", render);
  filterType.addEventListener("change", render);

  /* ---- Toggle status ---- */
  tbody.addEventListener("click", async function (e) {
    var btn = e.target.closest(".toggle-status");
    if (btn) {
      var id = btn.dataset.id;
      var newStatus = btn.dataset.status === "active" ? "inactive" : "active";
      try {
        var resp = await fetch("/api/v1/deployments/" + id, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: newStatus }),
        });
        if (!resp.ok) throw new Error("Failed");
        var dep = deployments.find(function (d) { return d.id === id; });
        if (dep) dep.status = newStatus;
        render();
      } catch { /* noop */ }
      return;
    }

    /* Detail modal */
    var detailBtn = e.target.closest("[data-detail]");
    if (detailBtn) {
      showDetail(detailBtn.dataset.detail);
      return;
    }

    /* Delete */
    var delBtn = e.target.closest(".delete-dep");
    if (delBtn) {
      deleteId = delBtn.dataset.id;
      document.getElementById("delete-modal").showModal();
    }
  });

  /* ---- Detail modal ---- */
  function showDetail(id) {
    var d = deployments.find(function (dep) { return dep.id === id; });
    if (!d) return;
    selectedId = id;

    var baseUrl = window.location.origin;
    var url = baseUrl + "/api/v1/deployed/" + d.id + "/run";
    document.getElementById("detail-url").textContent = url;
    document.getElementById("detail-curl").textContent =
      'curl -X POST ' + url + ' \\\n  -H "Authorization: Bearer YOUR_API_KEY" \\\n  -H "Content-Type: application/json" \\\n  -d \'{"input": "Hello, world!"}\'';
    document.getElementById("detail-rate-limit").value = d.rate_limit;
    document.getElementById("detail-usage").textContent = (d.usage_count || 0).toLocaleString();
    document.getElementById("detail-status").textContent = d.status;
    document.getElementById("detail-created").textContent = d.created_at
      ? new Date(d.created_at + "Z").toLocaleString()
      : "—";

    document.getElementById("detail-modal").showModal();
  }

  /* ---- Copy helpers ---- */
  document.getElementById("copy-url-btn").addEventListener("click", function () {
    navigator.clipboard.writeText(document.getElementById("detail-url").textContent);
  });
  document.getElementById("copy-curl-btn").addEventListener("click", function () {
    navigator.clipboard.writeText(document.getElementById("detail-curl").textContent);
  });

  /* ---- Save rate limit ---- */
  document.getElementById("save-rate-limit-btn").addEventListener("click", async function () {
    if (!selectedId) return;
    var val = parseInt(document.getElementById("detail-rate-limit").value, 10);
    if (!val || val < 1) return;
    try {
      var resp = await fetch("/api/v1/deployments/" + selectedId, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rate_limit: val }),
      });
      if (resp.ok) {
        var dep = deployments.find(function (d) { return d.id === selectedId; });
        if (dep) dep.rate_limit = val;
        render();
      }
    } catch { /* noop */ }
  });

  /* ---- Delete ---- */
  document.getElementById("confirm-delete-btn").addEventListener("click", async function () {
    if (!deleteId) return;
    try {
      var resp = await fetch("/api/v1/deployments/" + deleteId, { method: "DELETE" });
      if (resp.ok || resp.status === 204) {
        deployments = deployments.filter(function (d) { return d.id !== deleteId; });
        render();
        document.getElementById("delete-modal").close();
      }
    } catch { /* noop */ }
  });

  /* ---- Init ---- */
  loadDeployments();
</script>
