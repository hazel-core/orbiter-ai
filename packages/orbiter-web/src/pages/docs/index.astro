---
import PageLayout from "../../layouts/PageLayout.astro";
import { getCollection } from "astro:content";

const breadcrumbs = [{ label: "Documentation" }];

const docs = await getCollection("docs");
const sorted = docs.sort((a, b) => a.data.order - b.data.order);

const sections: Record<string, { label: string; docs: typeof sorted }> = {
  "getting-started": { label: "Getting Started", docs: [] },
  guides: { label: "Guides", docs: [] },
  "api-reference": { label: "API Reference", docs: [] },
  concepts: { label: "Concepts", docs: [] },
};

for (const doc of sorted) {
  const sec = sections[doc.data.section];
  if (sec) sec.docs.push(doc);
}

/* Icons */
const bookIcon =
  '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>';
const rocketIcon =
  '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 4 0 4 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-4 0-4"/></svg>';
const codeIcon =
  '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>';

const sectionIcons: Record<string, string> = {
  "getting-started": rocketIcon,
  guides: bookIcon,
  "api-reference": codeIcon,
  concepts: bookIcon,
};
---

<PageLayout
  title="Documentation"
  description="Learn how to use Orbiter"
  activeSection="docs"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-4xl mx-auto">
    <div class="mb-8">
      <h1 class="text-2xl font-semibold text-dark mb-2">Documentation</h1>
      <p class="text-sm text-muted">
        Learn how to build, deploy, and monitor AI agents with Orbiter.
      </p>
    </div>

    <!-- Search bar -->
    <div class="mb-8">
      <div
        class="flex items-center gap-3 rounded-xl border border-dark/[0.08] bg-subtle/30 px-4 py-3"
      >
        <svg
          class="h-4 w-4 shrink-0 text-muted"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><circle cx="11" cy="11" r="8"></circle><line
            x1="21"
            y1="21"
            x2="16.65"
            y2="16.65"></line></svg
        >
        <input
          id="docs-search"
          type="text"
          placeholder="Search documentation..."
          class="flex-1 bg-transparent text-sm text-dark placeholder-muted/60 outline-none"
          autocomplete="off"
          spellcheck="false"
        />
      </div>
    </div>

    <!-- Sections grid -->
    <div id="docs-sections" class="space-y-8">
      {
        Object.entries(sections).map(([key, sec]) => {
          if (sec.docs.length === 0) return null;
          return (
            <section data-section={key}>
              <div class="flex items-center gap-2 mb-4">
                <span
                  class="text-coral"
                  set:html={sectionIcons[key] || bookIcon}
                />
                <h2 class="text-lg font-semibold text-dark">{sec.label}</h2>
              </div>
              <div class="grid gap-3 sm:grid-cols-2">
                {sec.docs.map((doc) => (
                  <a
                    href={`/docs/${doc.id}`}
                    class="docs-card group block rounded-xl border border-dark/[0.08] bg-paper p-4 hover:border-coral/30 hover:shadow-sm transition-all duration-150 no-underline"
                    data-title={doc.data.title.toLowerCase()}
                    data-desc={(doc.data.description || "").toLowerCase()}
                  >
                    <h3 class="text-sm font-semibold text-dark group-hover:text-coral transition-colors">
                      {doc.data.title}
                    </h3>
                    {doc.data.description && (
                      <p class="text-xs text-muted mt-1">
                        {doc.data.description}
                      </p>
                    )}
                  </a>
                ))}
              </div>
            </section>
          );
        })
      }
    </div>

    <!-- Empty search state -->
    <div id="docs-no-results" class="hidden py-12 text-center text-sm text-muted">
      No documentation found matching your search.
    </div>
  </div>
</PageLayout>

<script is:inline>
  (function () {
    var searchInput = document.getElementById("docs-search");
    var sections = document.getElementById("docs-sections");
    var noResults = document.getElementById("docs-no-results");
    if (!searchInput || !sections) return;

    var cards = sections.querySelectorAll(".docs-card");
    var sectionEls = sections.querySelectorAll("[data-section]");

    searchInput.addEventListener("input", function () {
      var q = searchInput.value.toLowerCase().trim();
      if (!q) {
        cards.forEach(function (c) {
          c.classList.remove("hidden");
        });
        sectionEls.forEach(function (s) {
          s.classList.remove("hidden");
        });
        if (noResults) noResults.classList.add("hidden");
        return;
      }

      var anyVisible = false;
      cards.forEach(function (card) {
        var title = card.getAttribute("data-title") || "";
        var desc = card.getAttribute("data-desc") || "";
        var matches = title.indexOf(q) !== -1 || desc.indexOf(q) !== -1;
        card.classList.toggle("hidden", !matches);
        if (matches) anyVisible = true;
      });

      // Hide empty sections
      sectionEls.forEach(function (sec) {
        var visibleCards = sec.querySelectorAll(".docs-card:not(.hidden)");
        sec.classList.toggle("hidden", visibleCards.length === 0);
      });

      if (noResults) noResults.classList.toggle("hidden", anyVisible);
    });
  })();
</script>
