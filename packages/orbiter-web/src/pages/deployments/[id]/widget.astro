---
import PageLayout from "../../../layouts/PageLayout.astro";
import Modal from "../../../components/Modal.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Deployments", href: "/deployments" },
  { label: "Widget Settings" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const saveIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>';
const copyIcon = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
---

<PageLayout
  title="Widget Settings"
  description="Configure embeddable chat widget"
  activeSection="deployments"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading widget settings...</p>
    </div>

    <!-- Main content (hidden until loaded) -->
    <div id="main-content" class="hidden">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
        <div class="flex items-center gap-3">
          <a href="/deployments" class="p-2 rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-subtle transition-colors" title="Back to deployments">
            <span set:html={backIcon} />
          </a>
          <div>
            <h1 class="text-2xl font-semibold text-dark">Widget Settings</h1>
            <p id="dep-name" class="text-sm text-muted mt-0.5"></p>
          </div>
        </div>
        <button id="save-btn" class="flex items-center gap-2 px-4 py-2 text-sm font-medium bg-dark text-paper rounded-lg hover:bg-dark/80 transition-colors cursor-pointer">
          <span set:html={saveIcon} /> Save
        </button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left column: Configuration form -->
        <div class="flex flex-col gap-5">
          <!-- Customization section -->
          <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm p-5">
            <h2 class="text-base font-semibold text-dark mb-4">Customization</h2>

            <!-- Primary color -->
            <div class="flex flex-col gap-1.5 mb-4">
              <label class="text-xs font-semibold text-muted uppercase tracking-wider">Primary Color</label>
              <div class="flex items-center gap-3">
                <input
                  type="color"
                  id="primary-color"
                  value="#F76F53"
                  class="w-10 h-10 border border-dark/[0.08] rounded-lg cursor-pointer p-1"
                />
                <input
                  type="text"
                  id="primary-color-text"
                  value="#F76F53"
                  maxlength="50"
                  class="flex-1 bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark font-mono outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
                />
              </div>
            </div>

            <!-- Position -->
            <div class="flex flex-col gap-1.5 mb-4">
              <label class="text-xs font-semibold text-muted uppercase tracking-wider">Position</label>
              <select
                id="widget-position"
                class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer"
              >
                <option value="bottom-right">Bottom Right</option>
                <option value="bottom-left">Bottom Left</option>
              </select>
            </div>

            <!-- Welcome message -->
            <div class="flex flex-col gap-1.5 mb-4">
              <label class="text-xs font-semibold text-muted uppercase tracking-wider">Welcome Message</label>
              <textarea
                id="welcome-message"
                rows="2"
                maxlength="500"
                class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-none"
                placeholder="Hi! How can I help you?"
              ></textarea>
            </div>

            <!-- Avatar URL -->
            <div class="flex flex-col gap-1.5">
              <label class="text-xs font-semibold text-muted uppercase tracking-wider">Avatar URL (optional)</label>
              <input
                type="url"
                id="avatar-url"
                maxlength="2000"
                placeholder="https://example.com/avatar.png"
                class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              />
            </div>
          </div>

          <!-- CORS configuration -->
          <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm p-5">
            <h2 class="text-base font-semibold text-dark mb-2">CORS Origins</h2>
            <p class="text-xs text-muted mb-3">Comma-separated list of allowed origins for cross-origin widget requests. Use <code class="bg-subtle/80 px-1 rounded">*</code> to allow all origins.</p>
            <input
              type="text"
              id="cors-origins"
              placeholder="https://example.com, https://app.example.com"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
            />
          </div>

          <!-- Embed code -->
          <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm p-5">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-base font-semibold text-dark">Embed Code</h2>
              <button id="copy-embed-btn" class="flex items-center gap-1.5 text-xs text-coral hover:underline cursor-pointer">
                <span set:html={copyIcon} /> Copy
              </button>
            </div>
            <pre id="embed-code" class="bg-dark text-paper rounded-lg px-4 py-3 text-xs font-mono overflow-x-auto whitespace-pre-wrap leading-relaxed"></pre>
          </div>
        </div>

        <!-- Right column: Widget preview -->
        <div class="flex flex-col gap-5">
          <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm p-5">
            <h2 class="text-base font-semibold text-dark mb-4">Preview</h2>
            <div id="preview-area" class="relative bg-subtle/30 rounded-lg border border-dark/[0.04] overflow-hidden" style="height: 500px;">
              <!-- Preview rendered by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</PageLayout>

<script is:inline define:vars={{ id }}>
  var deploymentId = id;
  var loadingState = document.getElementById("loading-state");
  var mainContent = document.getElementById("main-content");

  var colorInput = document.getElementById("primary-color");
  var colorText = document.getElementById("primary-color-text");
  var positionSelect = document.getElementById("widget-position");
  var welcomeTextarea = document.getElementById("welcome-message");
  var avatarInput = document.getElementById("avatar-url");
  var corsInput = document.getElementById("cors-origins");
  var embedCodeEl = document.getElementById("embed-code");
  var previewArea = document.getElementById("preview-area");

  /* ---- Sync color picker <-> text ---- */
  colorInput.addEventListener("input", function () {
    colorText.value = colorInput.value;
    updatePreview();
  });
  colorText.addEventListener("input", function () {
    if (/^#[0-9a-fA-F]{6}$/.test(colorText.value)) {
      colorInput.value = colorText.value;
    }
    updatePreview();
  });
  positionSelect.addEventListener("change", updatePreview);
  welcomeTextarea.addEventListener("input", updatePreview);
  avatarInput.addEventListener("input", updatePreview);

  /* ---- Load config ---- */
  async function loadConfig() {
    try {
      var [configResp, depResp] = await Promise.all([
        fetch("/api/v1/deployments/" + deploymentId + "/widget"),
        fetch("/api/v1/deployments/" + deploymentId),
      ]);
      if (!configResp.ok || !depResp.ok) throw new Error("Failed to load");

      var config = await configResp.json();
      var dep = await depResp.json();

      document.getElementById("dep-name").textContent = dep.name || "Deployment";

      colorInput.value = config.primary_color || "#F76F53";
      colorText.value = config.primary_color || "#F76F53";
      positionSelect.value = config.position || "bottom-right";
      welcomeTextarea.value = config.welcome_message || "";
      avatarInput.value = config.avatar_url || "";
      corsInput.value = config.cors_origins || "";

      loadingState.classList.add("hidden");
      mainContent.classList.remove("hidden");

      updatePreview();
      loadEmbedCode();
    } catch (err) {
      loadingState.innerHTML = '<p class="text-sm text-coral">Failed to load widget settings.</p>';
      console.error(err);
    }
  }

  /* ---- Save config ---- */
  document.getElementById("save-btn").addEventListener("click", async function () {
    var btn = this;
    btn.disabled = true;
    btn.style.opacity = "0.6";
    try {
      var resp = await fetch("/api/v1/deployments/" + deploymentId + "/widget", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          primary_color: colorText.value || "#F76F53",
          position: positionSelect.value,
          welcome_message: welcomeTextarea.value,
          avatar_url: avatarInput.value,
          cors_origins: corsInput.value,
        }),
      });
      if (!resp.ok) throw new Error("Save failed");
      loadEmbedCode();
      // Brief flash to confirm save
      btn.textContent = "Saved!";
      setTimeout(function () {
        btn.innerHTML = '<span class="flex items-center gap-2"><svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save</span>';
      }, 1500);
    } catch (err) {
      console.error(err);
    } finally {
      btn.disabled = false;
      btn.style.opacity = "1";
    }
  });

  /* ---- Load embed code ---- */
  async function loadEmbedCode() {
    try {
      var resp = await fetch("/api/v1/deployments/" + deploymentId + "/embed-code");
      if (!resp.ok) return;
      var data = await resp.json();
      embedCodeEl.textContent = data.embed_code;
    } catch { /* noop */ }
  }

  /* ---- Copy embed code ---- */
  document.getElementById("copy-embed-btn").addEventListener("click", function () {
    navigator.clipboard.writeText(embedCodeEl.textContent);
    this.innerHTML = '<span class="flex items-center gap-1.5">Copied!</span>';
    var btn = this;
    setTimeout(function () {
      btn.innerHTML = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy';
    }, 2000);
  });

  /* ---- Preview ---- */
  function updatePreview() {
    var color = colorText.value || "#F76F53";
    var pos = positionSelect.value;
    var welcome = welcomeTextarea.value || "Hi! How can I help you?";
    var avatar = avatarInput.value;
    var isRight = pos !== "bottom-left";

    var avatarHtml = avatar
      ? '<img src="' + escapeAttr(avatar) + '" style="width:28px;height:28px;border-radius:50%;object-fit:cover;background:rgba(255,255,255,.2)" alt="Avatar">'
      : '';

    previewArea.innerHTML = ''
      + '<div style="position:absolute;bottom:16px;' + (isRight ? 'right:16px' : 'left:16px') + ';width:46px;height:46px;border-radius:50%;background:' + escapeAttr(color) + ';display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,.15);cursor:pointer">'
      +   '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>'
      + '</div>'
      + '<div style="position:absolute;bottom:76px;' + (isRight ? 'right:16px' : 'left:16px') + ';width:280px;border-radius:12px;background:#fff;box-shadow:0 8px 30px rgba(0,0,0,.1);overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif">'
      +   '<div style="padding:12px 16px;background:' + escapeAttr(color) + ';color:#fff;display:flex;align-items:center;gap:8px">'
      +     avatarHtml
      +     '<span style="font-size:13px;font-weight:600">Chat</span>'
      +     '<span style="margin-left:auto;opacity:.8;font-size:16px;cursor:pointer">&times;</span>'
      +   '</div>'
      +   '<div style="padding:12px;min-height:120px">'
      +     '<div style="background:#f0f0f0;color:#333;padding:8px 12px;border-radius:12px;border-bottom-left-radius:3px;font-size:12px;line-height:1.4;max-width:85%">' + escapeHtml(welcome) + '</div>'
      +   '</div>'
      +   '<div style="padding:10px 12px;border-top:1px solid #eee;display:flex;gap:6px">'
      +     '<input disabled style="flex:1;border:1px solid #ddd;border-radius:20px;padding:8px 12px;font-size:12px;background:#fafafa" placeholder="Type a message...">'
      +     '<div style="width:30px;height:30px;border-radius:50%;background:' + escapeAttr(color) + ';display:flex;align-items:center;justify-content:center;opacity:.4">'
      +       '<svg width="14" height="14" viewBox="0 0 24 24" fill="#fff"><path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"/></svg>'
      +     '</div>'
      +   '</div>'
      + '</div>';
  }

  function escapeHtml(s) {
    var d = document.createElement("div");
    d.textContent = s || "";
    return d.innerHTML;
  }

  function escapeAttr(s) {
    return (s || "").replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }

  /* ---- Init ---- */
  loadConfig();
</script>
