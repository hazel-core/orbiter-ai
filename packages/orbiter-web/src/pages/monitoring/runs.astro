---
import PageLayout from "../../layouts/PageLayout.astro";

const breadcrumbs = [
  { label: "Monitoring", href: "/monitoring" },
  { label: "Runs" },
];

/* Icons */
const refreshIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>';
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const chevronLeft = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>';
const chevronRight = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>';
---

<PageLayout
  title="Runs"
  description="View all execution runs"
  activeSection="monitoring"
  breadcrumbs={breadcrumbs}
>
  <!-- Pull-to-refresh indicator -->
  <div id="ptr-indicator" class="md:hidden fixed top-0 left-0 right-0 z-50 flex items-center justify-center pointer-events-none transition-transform duration-200 -translate-y-full">
    <div class="bg-coral text-white text-xs font-medium px-4 py-2 rounded-b-lg shadow-lg flex items-center gap-2">
      <span id="ptr-spinner" set:html={refreshIcon} />
      <span id="ptr-text">Pull to refresh</span>
    </div>
  </div>

  <div id="runs-content" class="p-4 sm:p-6 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div class="flex items-center gap-3 sm:gap-4">
        <a href="/monitoring" class="inline-flex items-center gap-1.5 text-sm text-muted hover:text-dark transition-colors min-h-[44px] min-w-[44px] justify-center sm:justify-start">
          <span set:html={backIcon} />
          <span class="hidden sm:inline">Dashboard</span>
        </a>
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold text-dark">Runs</h1>
          <p class="text-sm text-muted mt-0.5 hidden sm:block">All agent and workflow execution traces</p>
        </div>
      </div>
      <button id="refresh-btn" class="min-h-[44px] min-w-[44px] flex items-center justify-center rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors cursor-pointer" title="Refresh">
        <span set:html={refreshIcon} />
      </button>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap items-center gap-3 mb-6">
      <!-- Status filter -->
      <select id="filter-status" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer min-h-[44px]">
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="running">Running</option>
        <option value="completed">Completed</option>
        <option value="failed">Failed</option>
        <option value="cancelled">Cancelled</option>
      </select>

      <!-- Sort -->
      <select id="sort-field" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer min-h-[44px]">
        <option value="time">Newest First</option>
        <option value="time-asc">Oldest First</option>
        <option value="cost">Highest Cost</option>
        <option value="tokens">Most Tokens</option>
      </select>

      <!-- Auto-refresh toggle -->
      <label class="flex items-center gap-2 text-sm text-muted cursor-pointer select-none ml-auto min-h-[44px]">
        <span class="relative inline-flex">
          <input type="checkbox" id="auto-refresh-toggle" class="sr-only peer" />
          <div class="w-9 h-5 bg-dark/10 peer-checked:bg-coral rounded-full transition-colors duration-200"></div>
          <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full shadow transition-transform duration-200 peer-checked:translate-x-4"></div>
        </span>
        <span class="hidden sm:inline">Auto-refresh</span>
      </label>
    </div>

    <!-- Runs table — desktop -->
    <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden mb-6 hidden sm:block">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-dark/[0.06] text-left">
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide">Status</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide">Agent / Workflow</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">Steps</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">Tokens</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">Cost</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">Duration</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide">Started</th>
            </tr>
          </thead>
          <tbody id="runs-tbody">
            <tr><td colspan="7" class="px-5 py-12 text-center text-muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Runs cards — mobile -->
    <div id="runs-cards" class="sm:hidden space-y-3 mb-6">
      <div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm text-center text-muted text-sm">Loading...</div>
    </div>

    <!-- Pagination -->
    <div class="flex items-center justify-between">
      <p id="pagination-info" class="text-sm text-muted"></p>
      <div class="flex items-center gap-2">
        <button id="prev-btn" disabled class="min-h-[44px] min-w-[44px] flex items-center justify-center rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors disabled:opacity-30 disabled:cursor-not-allowed cursor-pointer">
          <span set:html={chevronLeft} />
        </button>
        <button id="next-btn" disabled class="min-h-[44px] min-w-[44px] flex items-center justify-center rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors disabled:opacity-30 disabled:cursor-not-allowed cursor-pointer">
          <span set:html={chevronRight} />
        </button>
      </div>
    </div>
  </div>
</PageLayout>

<script is:inline>
(function () {
  // State
  let currentOffset = 0;
  const pageSize = 20;
  let totalRuns = 0;
  let autoRefreshInterval = null;

  // DOM refs
  const tbody = document.getElementById("runs-tbody");
  const runsCards = document.getElementById("runs-cards");
  const filterStatus = document.getElementById("filter-status");
  const sortField = document.getElementById("sort-field");
  const refreshBtn = document.getElementById("refresh-btn");
  const prevBtn = document.getElementById("prev-btn");
  const nextBtn = document.getElementById("next-btn");
  const paginationInfo = document.getElementById("pagination-info");
  const autoRefreshToggle = document.getElementById("auto-refresh-toggle");

  // Helpers
  function fmtNumber(n) {
    if (n == null) return "—";
    if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
    if (n >= 1000) return (n / 1000).toFixed(1) + "K";
    return n.toLocaleString();
  }

  function fmtCost(n) {
    if (n == null || n === 0) return "—";
    return "$" + n.toFixed(4);
  }

  function fmtDuration(start, end) {
    if (!start) return "—";
    var s = new Date(start + "Z");
    var e = end ? new Date(end + "Z") : new Date();
    var ms = e - s;
    if (ms < 1000) return ms + "ms";
    if (ms < 60000) return (ms / 1000).toFixed(1) + "s";
    return Math.floor(ms / 60000) + "m " + Math.round((ms % 60000) / 1000) + "s";
  }

  function fmtTime(t) {
    if (!t) return "—";
    var d = new Date(t + "Z");
    var now = new Date();
    var diff = now - d;
    if (diff < 60000) return "just now";
    if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
    if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
    return d.toLocaleDateString(undefined, { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
  }

  function statusBadge(status) {
    var colors = {
      pending: "bg-yellow-100 text-yellow-800 border-yellow-200",
      running: "bg-blue-100 text-blue-800 border-blue-200",
      completed: "bg-green-100 text-green-800 border-green-200",
      failed: "bg-red-100 text-red-800 border-red-200",
      cancelled: "bg-gray-100 text-gray-600 border-gray-200",
    };
    var dots = {
      running: '<span class="inline-block w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse mr-1.5"></span>',
    };
    var cls = colors[status] || colors.pending;
    var dot = dots[status] || "";
    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ' + cls + '">' + dot + status + '</span>';
  }

  function stepsCount(stepsJson) {
    if (!stepsJson || !Array.isArray(stepsJson)) return 0;
    return stepsJson.length;
  }

  // Data loading
  async function loadRuns() {
    var params = new URLSearchParams();
    params.set("limit", pageSize);
    params.set("offset", currentOffset);

    var status = filterStatus.value;
    if (status) params.set("status", status);

    // Sort is client-side for now since the API sorts by created_at DESC
    // The API already sorts by created_at DESC which matches "Newest First"

    try {
      var res = await fetch("/api/v1/runs?" + params.toString());
      if (!res.ok) throw new Error("API error " + res.status);
      var data = await res.json();

      totalRuns = data.total;
      renderRuns(data.runs);
      updatePagination();
    } catch (err) {
      tbody.innerHTML = '<tr><td colspan="7" class="px-5 py-12 text-center text-muted">Failed to load runs</td></tr>';
      runsCards.innerHTML = '<div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm text-center text-muted text-sm">Failed to load runs</div>';
    }
  }

  function renderRuns(runs) {
    if (!runs.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="px-5 py-12 text-center text-muted">No runs found</td></tr>';
      runsCards.innerHTML = '<div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm text-center text-muted text-sm">No runs found</div>';
      return;
    }

    // Client-side sort
    var sort = sortField.value;
    if (sort === "cost") {
      runs.sort(function (a, b) { return (b.total_cost || 0) - (a.total_cost || 0); });
    } else if (sort === "tokens") {
      runs.sort(function (a, b) { return (b.total_tokens || 0) - (a.total_tokens || 0); });
    } else if (sort === "time-asc") {
      runs.sort(function (a, b) { return (a.created_at || "").localeCompare(b.created_at || ""); });
    }
    // "time" (newest) is already the default API order

    // Desktop table
    tbody.innerHTML = runs.map(function (run) {
      var name = run.agent_name || run.workflow_name || "Unknown";
      var type = run.agent_id ? "Agent" : run.workflow_id ? "Workflow" : "";
      var steps = stepsCount(run.steps_json);
      var href = "/monitoring/runs/" + encodeURIComponent(run.id);

      return '<tr class="border-b border-dark/[0.04] hover:bg-dark/[0.02] transition-colors cursor-pointer" data-href="' + href + '">'
        + '<td class="px-5 py-3.5">' + statusBadge(run.status) + '</td>'
        + '<td class="px-5 py-3.5"><a href="' + href + '" class="text-dark hover:text-coral transition-colors font-medium">' + escapeHtml(name) + '</a>'
        + (type ? '<span class="text-muted text-xs ml-2">' + type + '</span>' : '')
        + '</td>'
        + '<td class="px-5 py-3.5 text-right tabular-nums text-dark">' + steps + '</td>'
        + '<td class="px-5 py-3.5 text-right tabular-nums text-dark">' + fmtNumber(run.total_tokens) + '</td>'
        + '<td class="px-5 py-3.5 text-right tabular-nums text-dark">' + fmtCost(run.total_cost) + '</td>'
        + '<td class="px-5 py-3.5 text-right tabular-nums text-dark">' + fmtDuration(run.start_time, run.end_time) + '</td>'
        + '<td class="px-5 py-3.5 text-muted">' + fmtTime(run.created_at) + '</td>'
        + '</tr>';
    }).join("");

    // Row click navigation (desktop)
    tbody.querySelectorAll("tr[data-href]").forEach(function (row) {
      row.addEventListener("click", function (e) {
        if (e.target.tagName === "A") return;
        window.location.href = row.dataset.href;
      });
    });

    // Mobile cards
    runsCards.innerHTML = runs.map(function (run) {
      var name = run.agent_name || run.workflow_name || "Unknown";
      var type = run.agent_id ? "Agent" : run.workflow_id ? "Workflow" : "";
      var steps = stepsCount(run.steps_json);
      var href = "/monitoring/runs/" + encodeURIComponent(run.id);

      return '<a href="' + href + '" class="block bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm active:bg-dark/[0.02] transition-colors min-h-[44px]">'
        + '<div class="flex items-center justify-between mb-2">'
        + '<span class="text-sm font-medium text-dark truncate mr-2">' + escapeHtml(name) + '</span>'
        + statusBadge(run.status)
        + '</div>'
        + '<div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">'
        + (type ? '<div class="col-span-2 text-muted mb-1">' + type + ' &middot; ' + fmtTime(run.created_at) + '</div>' : '<div class="col-span-2 text-muted mb-1">' + fmtTime(run.created_at) + '</div>')
        + '<div><span class="text-muted">Duration:</span> <span class="text-dark tabular-nums">' + fmtDuration(run.start_time, run.end_time) + '</span></div>'
        + '<div><span class="text-muted">Cost:</span> <span class="text-dark tabular-nums">' + fmtCost(run.total_cost) + '</span></div>'
        + '<div><span class="text-muted">Tokens:</span> <span class="text-dark tabular-nums">' + fmtNumber(run.total_tokens) + '</span></div>'
        + '<div><span class="text-muted">Steps:</span> <span class="text-dark tabular-nums">' + steps + '</span></div>'
        + '</div></a>';
    }).join("");
  }

  function escapeHtml(str) {
    var div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  function updatePagination() {
    var start = totalRuns === 0 ? 0 : currentOffset + 1;
    var end = Math.min(currentOffset + pageSize, totalRuns);
    paginationInfo.textContent = start + "–" + end + " of " + totalRuns + " runs";
    prevBtn.disabled = currentOffset === 0;
    nextBtn.disabled = currentOffset + pageSize >= totalRuns;
  }

  // Events
  filterStatus.addEventListener("change", function () {
    currentOffset = 0;
    loadRuns();
  });

  sortField.addEventListener("change", function () {
    loadRuns();
  });

  refreshBtn.addEventListener("click", function () {
    loadRuns();
  });

  prevBtn.addEventListener("click", function () {
    if (currentOffset > 0) {
      currentOffset -= pageSize;
      loadRuns();
    }
  });

  nextBtn.addEventListener("click", function () {
    if (currentOffset + pageSize < totalRuns) {
      currentOffset += pageSize;
      loadRuns();
    }
  });

  autoRefreshToggle.addEventListener("change", function () {
    if (autoRefreshToggle.checked) {
      autoRefreshInterval = setInterval(loadRuns, 5000);
    } else {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
  });

  // ---------------------------------------------------------------------------
  // Pull-to-refresh (mobile)
  // ---------------------------------------------------------------------------
  (function initPullToRefresh() {
    var ptrIndicator = document.getElementById("ptr-indicator");
    var ptrText = document.getElementById("ptr-text");
    var ptrSpinner = document.getElementById("ptr-spinner");
    var content = document.getElementById("runs-content");
    if (!ptrIndicator || !content) return;

    var startY = 0;
    var pulling = false;
    var threshold = 80;

    content.addEventListener("touchstart", function (e) {
      if (window.scrollY === 0 && e.touches.length === 1) {
        startY = e.touches[0].clientY;
        pulling = true;
      }
    }, { passive: true });

    content.addEventListener("touchmove", function (e) {
      if (!pulling) return;
      var dy = e.touches[0].clientY - startY;
      if (dy > 0 && window.scrollY === 0) {
        var progress = Math.min(dy / threshold, 1);
        ptrIndicator.style.transform = "translateY(" + (progress * 100 - 100) + "%)";
        ptrText.textContent = dy >= threshold ? "Release to refresh" : "Pull to refresh";
        ptrSpinner.style.transform = "rotate(" + (progress * 180) + "deg)";
      } else {
        ptrIndicator.style.transform = "translateY(-100%)";
      }
    }, { passive: true });

    content.addEventListener("touchend", function (e) {
      if (!pulling) return;
      pulling = false;
      var dy = e.changedTouches[0].clientY - startY;
      if (dy >= threshold && window.scrollY === 0) {
        ptrText.textContent = "Refreshing...";
        ptrSpinner.classList.add("animate-spin");
        ptrIndicator.style.transform = "translateY(0)";
        loadRuns();
        setTimeout(function () {
          ptrIndicator.style.transform = "translateY(-100%)";
          ptrSpinner.classList.remove("animate-spin");
        }, 1000);
      } else {
        ptrIndicator.style.transform = "translateY(-100%)";
      }
    }, { passive: true });
  })();

  // Init
  loadRuns();
})();
</script>
