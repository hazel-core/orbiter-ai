---
import PageLayout from "../../../layouts/PageLayout.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Monitoring", href: "/monitoring" },
  { label: "Runs", href: "/monitoring/runs" },
  { label: "Run Detail" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const liveIcon = '<svg class="h-3 w-3" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="6"/></svg>';
---

<PageLayout
  title="Run Detail"
  description="View execution trace detail"
  activeSection="monitoring"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-5xl mx-auto">
    <!-- Back link -->
    <a href="/monitoring/runs" class="inline-flex items-center gap-1.5 text-sm text-muted hover:text-dark transition-colors mb-6">
      <span set:html={backIcon} />
      Back to Runs
    </a>

    <!-- Run summary header -->
    <div id="run-header" class="bg-white rounded-xl border border-dark/[0.06] shadow-sm p-6 mb-6">
      <div class="flex items-start justify-between gap-4 mb-4">
        <div>
          <div class="flex items-center gap-3">
            <h1 id="run-name" class="text-xl font-semibold text-dark">Loading...</h1>
            <span id="run-status-badge"></span>
            <span id="live-indicator" class="hidden items-center gap-1.5 text-xs text-red-500 font-medium">
              <span set:html={liveIcon} class="animate-pulse" />
              LIVE
            </span>
          </div>
          <p id="run-id-label" class="text-xs text-muted mt-1 font-mono"></p>
        </div>
        <span id="run-type-badge" class="text-xs font-medium text-muted bg-dark/[0.05] px-2.5 py-1 rounded-full"></span>
      </div>

      <!-- Summary stats -->
      <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
        <div>
          <p class="text-xs text-muted font-medium uppercase tracking-wide mb-1">Steps</p>
          <p id="stat-steps" class="text-lg font-semibold text-dark tabular-nums">—</p>
        </div>
        <div>
          <p class="text-xs text-muted font-medium uppercase tracking-wide mb-1">Tokens</p>
          <p id="stat-tokens" class="text-lg font-semibold text-dark tabular-nums">—</p>
        </div>
        <div>
          <p class="text-xs text-muted font-medium uppercase tracking-wide mb-1">Cost</p>
          <p id="stat-cost" class="text-lg font-semibold text-dark tabular-nums">—</p>
        </div>
        <div>
          <p class="text-xs text-muted font-medium uppercase tracking-wide mb-1">Duration</p>
          <p id="stat-duration" class="text-lg font-semibold text-dark tabular-nums">—</p>
        </div>
        <div>
          <p class="text-xs text-muted font-medium uppercase tracking-wide mb-1">Finish Reason</p>
          <p id="stat-finish" class="text-lg font-semibold text-dark">—</p>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
      <div class="flex border-b border-dark/[0.08]" role="tablist">
        <button type="button" role="tab" aria-selected="true" data-tab-btn="timeline"
          class="relative px-4 py-2.5 text-sm font-medium transition-colors cursor-pointer text-dark hover:text-dark">
          Execution Timeline
          <span class="absolute bottom-0 left-0 right-0 h-0.5 rounded-full bg-coral transition-all duration-200"></span>
        </button>
        <button type="button" role="tab" aria-selected="false" data-tab-btn="sandbox"
          class="relative px-4 py-2.5 text-sm font-medium transition-colors cursor-pointer text-muted hover:text-dark">
          Sandbox View
          <span class="absolute bottom-0 left-0 right-0 h-0.5 rounded-full bg-transparent scale-x-0 transition-all duration-200"></span>
        </button>
      </div>
    </div>

    <!-- Tab: Execution Timeline -->
    <div id="panel-timeline" data-tab-panel="timeline">
      <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-dark/[0.06] flex items-center justify-between">
          <h2 class="text-sm font-semibold text-dark">Execution Timeline</h2>
          <button id="expand-all-btn" class="text-xs text-muted hover:text-dark transition-colors cursor-pointer">Expand All</button>
        </div>
        <div id="steps-container" class="divide-y divide-dark/[0.04]">
          <div class="px-6 py-12 text-center text-muted text-sm">Loading steps...</div>
        </div>
      </div>
    </div>

    <!-- Tab: Sandbox View -->
    <div id="panel-sandbox" data-tab-panel="sandbox" class="hidden">
      <!-- Sandbox stats bar -->
      <div id="sandbox-stats" class="flex items-center gap-4 mb-4 text-xs text-muted">
        <span id="sandbox-exec-count">0 executions</span>
        <span>·</span>
        <span id="sandbox-file-count">0 files generated</span>
        <span>·</span>
        <span id="sandbox-total-time">0ms total</span>
      </div>

      <!-- Two-column layout: file tree + terminal/preview -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- File tree panel -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden">
            <div class="px-4 py-3 border-b border-dark/[0.06]">
              <h3 class="text-xs font-semibold text-dark uppercase tracking-wide">Workspace Files</h3>
            </div>
            <div id="file-tree" class="p-2 max-h-[500px] overflow-y-auto">
              <div class="px-3 py-8 text-center text-muted text-xs">No sandbox files</div>
            </div>
          </div>

          <!-- Artifact collection -->
          <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden mt-4">
            <div class="px-4 py-3 border-b border-dark/[0.06]">
              <h3 class="text-xs font-semibold text-dark uppercase tracking-wide">Artifacts</h3>
            </div>
            <div id="artifact-list" class="p-2 max-h-[300px] overflow-y-auto">
              <div class="px-3 py-6 text-center text-muted text-xs">No artifacts</div>
            </div>
          </div>
        </div>

        <!-- Terminal + File preview -->
        <div class="lg:col-span-2 space-y-4">
          <!-- Terminal panel -->
          <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden">
            <div class="px-4 py-3 border-b border-dark/[0.06] flex items-center justify-between">
              <h3 class="text-xs font-semibold text-dark uppercase tracking-wide">Terminal Output</h3>
              <span id="terminal-live" class="hidden items-center gap-1 text-xs text-green-600">
                <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                streaming
              </span>
            </div>
            <div id="terminal-output" class="bg-[#1e1e1e] text-[#d4d4d4] p-4 font-mono text-xs leading-relaxed max-h-[350px] overflow-y-auto whitespace-pre-wrap">
              <span class="text-[#6a9955]"># Waiting for sandbox executions...</span>
            </div>
          </div>

          <!-- File preview panel -->
          <div id="file-preview-panel" class="bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden hidden">
            <div class="px-4 py-3 border-b border-dark/[0.06] flex items-center justify-between">
              <h3 id="preview-filename" class="text-xs font-semibold text-dark font-mono">file.txt</h3>
              <div class="flex items-center gap-2">
                <span id="preview-size" class="text-xs text-muted"></span>
                <button id="preview-download" class="text-xs text-coral hover:text-coral/80 transition-colors cursor-pointer font-medium">Download</button>
                <button id="preview-close" class="text-xs text-muted hover:text-dark transition-colors cursor-pointer">Close</button>
              </div>
            </div>
            <div id="file-preview-content" class="p-4 max-h-[400px] overflow-auto">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</PageLayout>

<script is:inline define:vars={{ id }}>
(function () {
  var runId = id;
  var ws = null;
  var allExpanded = false;

  // DOM refs — header
  var runName = document.getElementById("run-name");
  var runStatusBadge = document.getElementById("run-status-badge");
  var runIdLabel = document.getElementById("run-id-label");
  var runTypeBadge = document.getElementById("run-type-badge");
  var liveIndicator = document.getElementById("live-indicator");
  var statSteps = document.getElementById("stat-steps");
  var statTokens = document.getElementById("stat-tokens");
  var statCost = document.getElementById("stat-cost");
  var statDuration = document.getElementById("stat-duration");
  var statFinish = document.getElementById("stat-finish");

  // DOM refs — timeline
  var stepsContainer = document.getElementById("steps-container");
  var expandAllBtn = document.getElementById("expand-all-btn");

  // DOM refs — sandbox
  var sandboxExecCount = document.getElementById("sandbox-exec-count");
  var sandboxFileCount = document.getElementById("sandbox-file-count");
  var sandboxTotalTime = document.getElementById("sandbox-total-time");
  var fileTree = document.getElementById("file-tree");
  var artifactList = document.getElementById("artifact-list");
  var terminalOutput = document.getElementById("terminal-output");
  var terminalLive = document.getElementById("terminal-live");
  var filePreviewPanel = document.getElementById("file-preview-panel");
  var previewFilename = document.getElementById("preview-filename");
  var previewSize = document.getElementById("preview-size");
  var previewDownload = document.getElementById("preview-download");
  var previewClose = document.getElementById("preview-close");
  var filePreviewContent = document.getElementById("file-preview-content");

  // State
  var sandboxExecutions = [];
  var allFiles = [];
  var currentPreviewFile = null;

  // ---------------------------------------------------------------------------
  // Tab switching
  // ---------------------------------------------------------------------------
  var tabBtns = document.querySelectorAll("[data-tab-btn]");
  var tabPanels = document.querySelectorAll("[data-tab-panel]");

  tabBtns.forEach(function (btn) {
    btn.addEventListener("click", function () {
      var tabId = btn.getAttribute("data-tab-btn");
      tabBtns.forEach(function (b) {
        var active = b.getAttribute("data-tab-btn") === tabId;
        b.setAttribute("aria-selected", active ? "true" : "false");
        b.classList.toggle("text-dark", active);
        b.classList.toggle("text-muted", !active);
        var indicator = b.querySelector("span:last-child");
        if (indicator) {
          indicator.classList.toggle("bg-coral", active);
          indicator.classList.toggle("scale-x-100", active);
          indicator.classList.toggle("bg-transparent", !active);
          indicator.classList.toggle("scale-x-0", !active);
        }
      });
      tabPanels.forEach(function (p) {
        p.classList.toggle("hidden", p.getAttribute("data-tab-panel") !== tabId);
      });
    });
  });

  // ---------------------------------------------------------------------------
  // Helpers
  // ---------------------------------------------------------------------------
  function fmtNumber(n) {
    if (n == null) return "—";
    if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
    if (n >= 1000) return (n / 1000).toFixed(1) + "K";
    return n.toLocaleString();
  }

  function fmtCost(n) {
    if (n == null || n === 0) return "—";
    return "$" + n.toFixed(4);
  }

  function fmtDuration(start, end) {
    if (!start) return "—";
    var s = new Date(start + "Z");
    var e = end ? new Date(end + "Z") : new Date();
    var ms = e - s;
    if (ms < 1000) return ms + "ms";
    if (ms < 60000) return (ms / 1000).toFixed(1) + "s";
    return Math.floor(ms / 60000) + "m " + Math.round((ms % 60000) / 1000) + "s";
  }

  function fmtBytes(bytes) {
    if (bytes < 1024) return bytes + " B";
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
    return (bytes / 1048576).toFixed(1) + " MB";
  }

  function escapeHtml(str) {
    if (!str) return "";
    var div = document.createElement("div");
    div.textContent = typeof str === "string" ? str : JSON.stringify(str, null, 2);
    return div.innerHTML;
  }

  function statusBadge(status) {
    var colors = {
      pending: "bg-yellow-100 text-yellow-800 border-yellow-200",
      running: "bg-blue-100 text-blue-800 border-blue-200",
      completed: "bg-green-100 text-green-800 border-green-200",
      failed: "bg-red-100 text-red-800 border-red-200",
      cancelled: "bg-gray-100 text-gray-600 border-gray-200",
    };
    var dots = {
      running: '<span class="inline-block w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse mr-1.5"></span>',
    };
    var cls = colors[status] || colors.pending;
    var dot = dots[status] || "";
    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ' + cls + '">' + dot + status + '</span>';
  }

  function stepTypeIcon(type) {
    var icons = {
      llm: '<span class="w-7 h-7 rounded-lg bg-blue-100 text-blue-700 flex items-center justify-center text-xs font-bold">LLM</span>',
      tool: '<span class="w-7 h-7 rounded-lg bg-amber-100 text-amber-700 flex items-center justify-center"><svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></span>',
      handoff: '<span class="w-7 h-7 rounded-lg bg-purple-100 text-purple-700 flex items-center justify-center"><svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg></span>',
    };
    return icons[type] || '<span class="w-7 h-7 rounded-lg bg-gray-100 text-gray-600 flex items-center justify-center text-xs font-bold">?</span>';
  }

  function isImageFile(name) {
    return /\.(png|jpg|jpeg|gif|bmp|svg|webp)$/i.test(name);
  }

  function fileIcon(name) {
    if (isImageFile(name)) return '<svg class="h-3.5 w-3.5 text-purple-500 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>';
    if (/\.(csv|tsv)$/i.test(name)) return '<svg class="h-3.5 w-3.5 text-green-500 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>';
    if (/\.(json|txt|md|py|js|html|css)$/i.test(name)) return '<svg class="h-3.5 w-3.5 text-blue-500 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>';
    return '<svg class="h-3.5 w-3.5 text-muted shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>';
  }

  // ---------------------------------------------------------------------------
  // Render run data
  // ---------------------------------------------------------------------------
  function renderRun(run) {
    var name = run.agent_name || run.workflow_name || "Run";
    runName.textContent = name;
    runIdLabel.textContent = run.id;
    runStatusBadge.innerHTML = statusBadge(run.status);
    runTypeBadge.textContent = run.agent_id ? "Agent" : run.workflow_id ? "Workflow" : "";

    var steps = run.steps_json || [];
    statSteps.textContent = steps.length;
    statTokens.textContent = fmtNumber(run.total_tokens);
    statCost.textContent = fmtCost(run.total_cost);
    statDuration.textContent = fmtDuration(run.start_time, run.end_time);
    statFinish.textContent = run.finish_reason || "—";

    renderSteps(steps);
    renderSandboxView(steps, run.status);

    // Show live indicator and connect WS for running runs
    if (run.status === "running" || run.status === "pending") {
      liveIndicator.classList.remove("hidden");
      liveIndicator.classList.add("inline-flex");
      terminalLive.classList.remove("hidden");
      terminalLive.classList.add("inline-flex");
      connectWebSocket();
    } else {
      terminalLive.classList.add("hidden");
      terminalLive.classList.remove("inline-flex");
    }
  }

  // ---------------------------------------------------------------------------
  // Execution timeline
  // ---------------------------------------------------------------------------
  function renderSteps(steps) {
    if (!steps.length) {
      stepsContainer.innerHTML = '<div class="px-6 py-12 text-center text-muted text-sm">No steps recorded</div>';
      return;
    }

    stepsContainer.innerHTML = steps.map(function (step, i) {
      var stepNum = i + 1;
      var type = step.type || "unknown";
      var duration = step.duration ? (step.duration < 1000 ? step.duration + "ms" : (step.duration / 1000).toFixed(1) + "s") : "—";
      var tokens = step.tokens ? fmtNumber(step.tokens) : "—";
      var hasError = !!step.error;

      var toolCalls = step.tool_calls || [];
      var toolCallsHtml = "";
      if (toolCalls.length) {
        toolCallsHtml = '<div class="mt-3 space-y-2">'
          + '<p class="text-xs font-medium text-muted uppercase tracking-wide">Tool Calls</p>'
          + toolCalls.map(function (tc) {
            return '<div class="bg-amber-50 border border-amber-200/60 rounded-lg px-3 py-2">'
              + '<div class="flex items-center gap-2 text-xs">'
              + '<span class="font-mono font-medium text-amber-800">' + escapeHtml(tc.name || tc.function || "unknown") + '</span>'
              + (tc.duration ? '<span class="text-muted">' + tc.duration + 'ms</span>' : '')
              + '</div>'
              + (tc.arguments ? '<pre class="mt-1 text-xs text-dark/70 overflow-x-auto whitespace-pre-wrap break-all max-h-32 overflow-y-auto">' + escapeHtml(typeof tc.arguments === "string" ? tc.arguments : JSON.stringify(tc.arguments, null, 2)) + '</pre>' : '')
              + (tc.result ? '<pre class="mt-1 text-xs text-dark/70 overflow-x-auto whitespace-pre-wrap break-all max-h-32 overflow-y-auto border-t border-amber-200/40 pt-1">' + escapeHtml(typeof tc.result === "string" ? tc.result : JSON.stringify(tc.result, null, 2)) + '</pre>' : '')
              + '</div>';
          }).join("")
          + '</div>';
      }

      var detailHtml = '<div class="step-detail hidden mt-3 space-y-3">';
      if (step.input) {
        detailHtml += '<div>'
          + '<p class="text-xs font-medium text-muted uppercase tracking-wide mb-1">Input</p>'
          + '<pre class="bg-dark/[0.03] rounded-lg p-3 text-xs text-dark overflow-x-auto whitespace-pre-wrap break-all max-h-48 overflow-y-auto">' + escapeHtml(step.input) + '</pre>'
          + '</div>';
      }
      if (step.output) {
        detailHtml += '<div>'
          + '<p class="text-xs font-medium text-muted uppercase tracking-wide mb-1">Output</p>'
          + '<pre class="bg-dark/[0.03] rounded-lg p-3 text-xs text-dark overflow-x-auto whitespace-pre-wrap break-all max-h-48 overflow-y-auto">' + escapeHtml(step.output) + '</pre>'
          + '</div>';
      }
      if (step.error) {
        detailHtml += '<div>'
          + '<p class="text-xs font-medium text-red-600 uppercase tracking-wide mb-1">Error</p>'
          + '<pre class="bg-red-50 border border-red-200/60 rounded-lg p-3 text-xs text-red-800 overflow-x-auto whitespace-pre-wrap break-all max-h-48 overflow-y-auto">' + escapeHtml(step.error) + '</pre>'
          + '</div>';
      }
      detailHtml += toolCallsHtml;
      detailHtml += '</div>';

      return '<div class="step-row px-6 py-4 hover:bg-dark/[0.01] cursor-pointer transition-colors" data-step="' + i + '">'
        + '<div class="flex items-center gap-4">'
        + '<div class="flex items-center gap-3 min-w-0">'
        + '<span class="text-xs text-muted tabular-nums w-6 text-right shrink-0">#' + stepNum + '</span>'
        + stepTypeIcon(type)
        + '<div class="min-w-0">'
        + '<span class="text-sm font-medium text-dark capitalize">' + type + '</span>'
        + (step.model ? '<span class="text-xs text-muted ml-2">' + escapeHtml(step.model) + '</span>' : '')
        + (step.name ? '<span class="text-xs text-muted ml-2">— ' + escapeHtml(step.name) + '</span>' : '')
        + '</div>'
        + '</div>'
        + '<div class="flex items-center gap-6 ml-auto shrink-0">'
        + '<span class="text-xs tabular-nums text-dark w-16 text-right">' + tokens + ' tok</span>'
        + '<span class="text-xs tabular-nums text-dark w-16 text-right">' + (step.cost ? fmtCost(step.cost) : '—') + '</span>'
        + '<span class="text-xs tabular-nums text-muted w-16 text-right">' + duration + '</span>'
        + (hasError ? '<span class="w-2 h-2 rounded-full bg-red-500 shrink-0"></span>' : '<span class="w-2 shrink-0"></span>')
        + '<span class="step-chevron text-muted transition-transform">'
        + '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>'
        + '</span>'
        + '</div>'
        + '</div>'
        + detailHtml
        + '</div>';
    }).join("");

    stepsContainer.querySelectorAll(".step-row").forEach(function (row) {
      row.addEventListener("click", function () {
        var detail = row.querySelector(".step-detail");
        var chevron = row.querySelector(".step-chevron");
        if (detail) {
          detail.classList.toggle("hidden");
          if (chevron) chevron.classList.toggle("rotate-180");
        }
      });
    });
  }

  // Expand/Collapse all
  expandAllBtn.addEventListener("click", function () {
    allExpanded = !allExpanded;
    expandAllBtn.textContent = allExpanded ? "Collapse All" : "Expand All";
    stepsContainer.querySelectorAll(".step-detail").forEach(function (d) {
      if (allExpanded) d.classList.remove("hidden"); else d.classList.add("hidden");
    });
    stepsContainer.querySelectorAll(".step-chevron").forEach(function (c) {
      if (allExpanded) c.classList.add("rotate-180"); else c.classList.remove("rotate-180");
    });
  });

  // ---------------------------------------------------------------------------
  // Sandbox view
  // ---------------------------------------------------------------------------
  function extractSandboxExecutions(steps) {
    var executions = [];
    steps.forEach(function (step, stepIdx) {
      var toolCalls = step.tool_calls || [];
      toolCalls.forEach(function (tc) {
        var tcName = tc.name || tc.function || "";
        if (tcName !== "code_interpreter") return;

        var code = "";
        try {
          var args = typeof tc.arguments === "string" ? JSON.parse(tc.arguments) : tc.arguments;
          code = args.code || args.input || "";
        } catch (_) {
          code = typeof tc.arguments === "string" ? tc.arguments : "";
        }

        var result = null;
        try {
          result = typeof tc.result === "string" ? JSON.parse(tc.result) : tc.result;
        } catch (_) {
          result = { stdout: tc.result || "", stderr: "", success: true, generated_files: [] };
        }

        if (result) {
          executions.push({
            stepIndex: stepIdx,
            code: code,
            success: result.success !== false,
            stdout: result.stdout || "",
            stderr: result.stderr || "",
            error: result.error || null,
            generated_files: result.generated_files || [],
            execution_time_ms: result.execution_time_ms || 0,
          });
        }
      });
    });
    return executions;
  }

  function renderSandboxView(steps, runStatus) {
    sandboxExecutions = extractSandboxExecutions(steps);
    allFiles = [];
    sandboxExecutions.forEach(function (exec, idx) {
      exec.generated_files.forEach(function (f) {
        allFiles.push({ name: f.name, size_bytes: f.size_bytes, content_base64: f.content_base64, execIndex: idx });
      });
    });

    // Stats
    var totalTime = sandboxExecutions.reduce(function (sum, e) { return sum + e.execution_time_ms; }, 0);
    sandboxExecCount.textContent = sandboxExecutions.length + " execution" + (sandboxExecutions.length !== 1 ? "s" : "");
    sandboxFileCount.textContent = allFiles.length + " file" + (allFiles.length !== 1 ? "s" : "") + " generated";
    sandboxTotalTime.textContent = (totalTime < 1000 ? Math.round(totalTime) + "ms" : (totalTime / 1000).toFixed(1) + "s") + " total";

    renderFileTree();
    renderTerminal();
    renderArtifactList();
  }

  function renderFileTree() {
    if (!allFiles.length) {
      fileTree.innerHTML = '<div class="px-3 py-8 text-center text-muted text-xs">No sandbox files</div>';
      return;
    }

    // Group files by directory
    var dirs = {};
    allFiles.forEach(function (f, idx) {
      var parts = f.name.split("/");
      var dir = parts.length > 1 ? parts.slice(0, -1).join("/") : ".";
      if (!dirs[dir]) dirs[dir] = [];
      dirs[dir].push({ file: f, globalIdx: idx });
    });

    var html = "";
    Object.keys(dirs).sort().forEach(function (dir) {
      if (dir !== ".") {
        html += '<div class="px-2 py-1.5 text-xs font-medium text-muted flex items-center gap-1.5">'
          + '<svg class="h-3.5 w-3.5 text-muted shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>'
          + escapeHtml(dir) + '/</div>';
      }
      dirs[dir].forEach(function (entry) {
        var f = entry.file;
        var fileName = f.name.split("/").pop();
        html += '<button data-file-idx="' + entry.globalIdx + '" class="file-tree-item w-full text-left px-2 py-1.5 rounded-md hover:bg-dark/[0.04] flex items-center gap-2 cursor-pointer transition-colors group">'
          + fileIcon(fileName)
          + '<span class="text-xs text-dark truncate group-hover:text-coral transition-colors">' + escapeHtml(fileName) + '</span>'
          + '<span class="text-[10px] text-muted ml-auto shrink-0">' + fmtBytes(f.size_bytes) + '</span>'
          + '</button>';
      });
    });

    fileTree.innerHTML = html;

    // Click handlers
    fileTree.querySelectorAll(".file-tree-item").forEach(function (btn) {
      btn.addEventListener("click", function () {
        var idx = parseInt(btn.getAttribute("data-file-idx"), 10);
        showFilePreview(allFiles[idx]);
        // Highlight active
        fileTree.querySelectorAll(".file-tree-item").forEach(function (b) { b.classList.remove("bg-coral/[0.08]"); });
        btn.classList.add("bg-coral/[0.08]");
      });
    });
  }

  function renderTerminal() {
    if (!sandboxExecutions.length) {
      terminalOutput.innerHTML = '<span class="text-[#6a9955]"># No sandbox executions in this run</span>';
      return;
    }

    var lines = [];
    sandboxExecutions.forEach(function (exec, idx) {
      var statusColor = exec.success ? "#6a9955" : "#f44747";
      var statusLabel = exec.success ? "OK" : "FAILED";
      var timeStr = exec.execution_time_ms < 1000 ? Math.round(exec.execution_time_ms) + "ms" : (exec.execution_time_ms / 1000).toFixed(1) + "s";

      lines.push('<span class="text-[#569cd6]">━━━ Execution #' + (idx + 1) + ' (' + timeStr + ') [<span class="text-[' + statusColor + ']">' + statusLabel + '</span>] ━━━</span>');
      lines.push('<span class="text-[#6a9955]">$ python &lt;sandbox&gt;</span>');

      // Show the code that was executed
      if (exec.code) {
        var codeLines = exec.code.split("\n");
        var displayLines = codeLines.length > 10 ? codeLines.slice(0, 10) : codeLines;
        displayLines.forEach(function (line) {
          lines.push('<span class="text-[#808080]">  ' + escapeHtml(line) + '</span>');
        });
        if (codeLines.length > 10) {
          lines.push('<span class="text-[#808080]">  ... (' + (codeLines.length - 10) + ' more lines)</span>');
        }
      }

      // stdout
      if (exec.stdout) {
        lines.push("");
        exec.stdout.split("\n").forEach(function (line) {
          lines.push(escapeHtml(line));
        });
      }

      // stderr
      if (exec.stderr) {
        exec.stderr.split("\n").forEach(function (line) {
          if (line.trim()) lines.push('<span class="text-[#f44747]">' + escapeHtml(line) + '</span>');
        });
      }

      // error
      if (exec.error) {
        lines.push('<span class="text-[#f44747]">Error: ' + escapeHtml(exec.error) + '</span>');
      }

      // generated files summary
      if (exec.generated_files.length) {
        lines.push('<span class="text-[#6a9955]">Generated ' + exec.generated_files.length + ' file(s):</span>');
        exec.generated_files.forEach(function (f) {
          lines.push('<span class="text-[#dcdcaa]">  → ' + escapeHtml(f.name) + '</span> <span class="text-[#808080]">(' + fmtBytes(f.size_bytes) + ')</span>');
        });
      }

      lines.push("");
    });

    terminalOutput.innerHTML = lines.join("\n");
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
  }

  function renderArtifactList() {
    if (!allFiles.length) {
      artifactList.innerHTML = '<div class="px-3 py-6 text-center text-muted text-xs">No artifacts</div>';
      return;
    }

    artifactList.innerHTML = allFiles.map(function (f, idx) {
      var fileName = f.name.split("/").pop();
      return '<div class="flex items-center gap-2 px-2 py-2 rounded-md hover:bg-dark/[0.04] transition-colors">'
        + fileIcon(fileName)
        + '<div class="min-w-0 flex-1">'
        + '<p class="text-xs text-dark truncate">' + escapeHtml(fileName) + '</p>'
        + '<p class="text-[10px] text-muted">' + fmtBytes(f.size_bytes) + '</p>'
        + '</div>'
        + (f.content_base64
          ? '<button data-download-idx="' + idx + '" class="artifact-download text-[10px] text-coral hover:text-coral/80 font-medium cursor-pointer shrink-0">Download</button>'
          : '<span class="text-[10px] text-muted shrink-0">Too large</span>')
        + '</div>';
    }).join("");

    artifactList.querySelectorAll(".artifact-download").forEach(function (btn) {
      btn.addEventListener("click", function () {
        var idx = parseInt(btn.getAttribute("data-download-idx"), 10);
        downloadFile(allFiles[idx]);
      });
    });
  }

  // ---------------------------------------------------------------------------
  // File preview
  // ---------------------------------------------------------------------------
  function showFilePreview(file) {
    currentPreviewFile = file;
    var fileName = file.name.split("/").pop();
    previewFilename.textContent = fileName;
    previewSize.textContent = fmtBytes(file.size_bytes);
    filePreviewPanel.classList.remove("hidden");

    if (!file.content_base64) {
      filePreviewContent.innerHTML = '<div class="text-center text-muted text-sm py-8">File too large to preview (> 1 MB)</div>';
      return;
    }

    if (isImageFile(fileName)) {
      var mimeMap = { png: "image/png", jpg: "image/jpeg", jpeg: "image/jpeg", gif: "image/gif", svg: "image/svg+xml", webp: "image/webp", bmp: "image/bmp" };
      var ext = fileName.split(".").pop().toLowerCase();
      var mime = mimeMap[ext] || "image/png";
      filePreviewContent.innerHTML = '<img src="data:' + mime + ';base64,' + file.content_base64 + '" alt="' + escapeHtml(fileName) + '" class="max-w-full rounded-lg border border-dark/[0.06]" />';
    } else {
      // Decode base64 to text
      try {
        var text = atob(file.content_base64);
        filePreviewContent.innerHTML = '<pre class="text-xs text-dark font-mono whitespace-pre-wrap break-all overflow-x-auto">' + escapeHtml(text) + '</pre>';
      } catch (_) {
        filePreviewContent.innerHTML = '<div class="text-center text-muted text-sm py-8">Unable to decode file content</div>';
      }
    }
  }

  function downloadFile(file) {
    if (!file.content_base64) return;
    var fileName = file.name.split("/").pop();
    var binary = atob(file.content_base64);
    var bytes = new Uint8Array(binary.length);
    for (var i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    var blob = new Blob([bytes]);
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  previewClose.addEventListener("click", function () {
    filePreviewPanel.classList.add("hidden");
    currentPreviewFile = null;
    fileTree.querySelectorAll(".file-tree-item").forEach(function (b) { b.classList.remove("bg-coral/[0.08]"); });
  });

  previewDownload.addEventListener("click", function () {
    if (currentPreviewFile) downloadFile(currentPreviewFile);
  });

  // ---------------------------------------------------------------------------
  // WebSocket for live streaming
  // ---------------------------------------------------------------------------
  function connectWebSocket() {
    var proto = window.location.protocol === "https:" ? "wss:" : "ws:";
    var url = proto + "//" + window.location.host + "/api/v1/runs/" + encodeURIComponent(runId) + "/stream";
    ws = new WebSocket(url);

    ws.onmessage = function (e) {
      var event;
      try { event = JSON.parse(e.data); } catch (_) { return; }

      if (event.type === "run_completed") {
        liveIndicator.classList.add("hidden");
        liveIndicator.classList.remove("inline-flex");
        runStatusBadge.innerHTML = statusBadge(event.status || "completed");
        if (event.total_tokens) statTokens.textContent = fmtNumber(event.total_tokens);
        if (event.total_cost) statCost.textContent = fmtCost(event.total_cost);
        if (event.finish_reason) statFinish.textContent = event.finish_reason;
        loadRun();
      } else if (event.type === "step_completed" || event.type === "step_started") {
        loadRun();
      }
    };

    ws.onclose = function () {
      liveIndicator.classList.add("hidden");
      liveIndicator.classList.remove("inline-flex");
      terminalLive.classList.add("hidden");
      terminalLive.classList.remove("inline-flex");
    };
  }

  // ---------------------------------------------------------------------------
  // Load run data
  // ---------------------------------------------------------------------------
  async function loadRun() {
    try {
      var res = await fetch("/api/v1/runs/" + encodeURIComponent(runId));
      if (!res.ok) {
        if (res.status === 404) {
          stepsContainer.innerHTML = '<div class="px-6 py-12 text-center text-muted text-sm">Run not found</div>';
          runName.textContent = "Not Found";
          return;
        }
        throw new Error("API error " + res.status);
      }
      var run = await res.json();
      renderRun(run);
    } catch (err) {
      stepsContainer.innerHTML = '<div class="px-6 py-12 text-center text-red-500 text-sm">Failed to load run: ' + escapeHtml(err.message) + '</div>';
    }
  }

  // Cleanup on page leave
  window.addEventListener("beforeunload", function () {
    if (ws) ws.close();
  });

  // Init
  loadRun();
})();
</script>
