---
import PageLayout from "../../layouts/PageLayout.astro";

const breadcrumbs = [
  { label: "Monitoring", href: "/monitoring" },
  { label: "Logs" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const refreshIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>';
const downloadIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
const chevronDown = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';
const chevronRight = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>';
const searchIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
---

<PageLayout
  title="Logs"
  description="Structured log viewer"
  activeSection="monitoring"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div class="flex items-center gap-4">
        <a href="/monitoring" class="inline-flex items-center gap-1.5 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          Dashboard
        </a>
        <div>
          <h1 class="text-2xl font-semibold text-dark">Logs</h1>
          <p class="text-sm text-muted mt-0.5">Structured logs from agent executions</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <!-- Export buttons -->
        <button id="export-json-btn" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors cursor-pointer">
          <span set:html={downloadIcon} /> JSON
        </button>
        <button id="export-csv-btn" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors cursor-pointer">
          <span set:html={downloadIcon} /> CSV
        </button>
        <button id="refresh-btn" class="p-2 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors cursor-pointer" title="Refresh">
          <span set:html={refreshIcon} />
        </button>
      </div>
    </div>

    <!-- Filter bar -->
    <div class="flex flex-wrap items-center gap-3 mb-6">
      <!-- Level dropdown -->
      <select id="filter-level" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer">
        <option value="">All Levels</option>
        <option value="debug">Debug</option>
        <option value="info">Info</option>
        <option value="warn">Warn</option>
        <option value="error">Error</option>
      </select>

      <!-- Source dropdown -->
      <select id="filter-source" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer">
        <option value="">All Sources</option>
        <option value="agent">Agent</option>
        <option value="tool">Tool</option>
        <option value="model">Model</option>
        <option value="system">System</option>
      </select>

      <!-- Agent selector -->
      <select id="filter-agent" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer">
        <option value="">All Agents</option>
      </select>

      <!-- Time range picker -->
      <select id="filter-time" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer">
        <option value="">All Time</option>
        <option value="1h">Last 1 hour</option>
        <option value="24h">Last 24 hours</option>
        <option value="7d">Last 7 days</option>
        <option value="30d">Last 30 days</option>
      </select>

      <!-- Search input -->
      <div class="relative flex-1 min-w-[200px]">
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted pointer-events-none" set:html={searchIcon}></span>
        <input
          id="filter-search"
          type="text"
          placeholder="Search log messages…"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg pl-9 pr-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all placeholder:text-muted"
        />
      </div>

      <!-- Auto-scroll toggle -->
      <label class="flex items-center gap-2 text-sm text-muted cursor-pointer select-none ml-auto">
        <span class="relative inline-flex">
          <input type="checkbox" id="auto-scroll-toggle" class="sr-only peer" />
          <div class="w-9 h-5 bg-dark/10 peer-checked:bg-coral rounded-full transition-colors duration-200"></div>
          <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full shadow transition-transform duration-200 peer-checked:translate-x-4"></div>
        </span>
        <span>Auto-scroll</span>
      </label>
    </div>

    <!-- Streaming indicator -->
    <div id="stream-status" class="hidden items-center gap-2 mb-4 text-sm text-muted">
      <span class="inline-block w-2 h-2 rounded-full bg-zen-green animate-pulse"></span>
      <span>Streaming live logs…</span>
    </div>

    <!-- Log entries container -->
    <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden mb-6">
      <div id="logs-container" class="divide-y divide-dark/[0.04] max-h-[calc(100vh-340px)] overflow-y-auto">
        <div class="px-5 py-12 text-center text-muted">Loading…</div>
      </div>
    </div>

    <!-- Count and status -->
    <div class="flex items-center justify-between">
      <p id="log-count" class="text-sm text-muted"></p>
      <button id="load-more-btn" class="hidden px-4 py-2 text-sm font-medium rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors cursor-pointer">
        Load more
      </button>
    </div>
  </div>
</PageLayout>

<script is:inline>
(function () {
  // State
  var logs = [];
  var currentOffset = 0;
  var pageSize = 100;
  var autoScroll = false;
  var ws = null;
  var searchDebounce = null;
  var agents = [];

  // DOM refs
  var container = document.getElementById("logs-container");
  var filterLevel = document.getElementById("filter-level");
  var filterSource = document.getElementById("filter-source");
  var filterAgent = document.getElementById("filter-agent");
  var filterTime = document.getElementById("filter-time");
  var filterSearch = document.getElementById("filter-search");
  var refreshBtn = document.getElementById("refresh-btn");
  var autoScrollToggle = document.getElementById("auto-scroll-toggle");
  var streamStatus = document.getElementById("stream-status");
  var logCount = document.getElementById("log-count");
  var loadMoreBtn = document.getElementById("load-more-btn");
  var exportJsonBtn = document.getElementById("export-json-btn");
  var exportCsvBtn = document.getElementById("export-csv-btn");

  // Severity colors
  var levelColors = {
    debug: "bg-gray-100 text-gray-600 border-gray-200",
    info: "bg-blue-100 text-blue-700 border-blue-200",
    warn: "bg-yellow-100 text-yellow-800 border-yellow-200",
    error: "bg-red-100 text-red-700 border-red-200",
  };
  var levelDots = {
    debug: "bg-gray-400",
    info: "bg-blue-500",
    warn: "bg-yellow-500",
    error: "bg-red-500",
  };

  // Source colors
  var sourceColors = {
    agent: "bg-purple-100 text-purple-700 border-purple-200",
    tool: "bg-cyan-100 text-cyan-700 border-cyan-200",
    model: "bg-orange-100 text-orange-700 border-orange-200",
    system: "bg-gray-100 text-gray-600 border-gray-200",
  };

  // Helpers
  function escapeHtml(str) {
    var div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  function fmtTime(t) {
    if (!t) return "—";
    var d = new Date(t.endsWith("Z") ? t : t + "Z");
    return d.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit", second: "2-digit", fractionalSecondDigits: 3 });
  }

  function fmtDate(t) {
    if (!t) return "";
    var d = new Date(t.endsWith("Z") ? t : t + "Z");
    return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
  }

  function levelBadge(level) {
    var cls = levelColors[level] || levelColors.debug;
    var dot = levelDots[level] || levelDots.debug;
    return '<span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium border ' + cls + '">'
      + '<span class="inline-block w-1.5 h-1.5 rounded-full ' + dot + '"></span>'
      + escapeHtml(level)
      + '</span>';
  }

  function sourceBadge(source) {
    var cls = sourceColors[source] || sourceColors.system;
    return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border ' + cls + '">'
      + escapeHtml(source)
      + '</span>';
  }

  function formatMetadata(meta) {
    if (!meta || typeof meta !== "object") return "";
    var keys = Object.keys(meta);
    if (keys.length === 0) return "";
    var html = '<div class="mt-2 ml-8 bg-dark/[0.02] rounded-lg border border-dark/[0.04] p-3 text-xs font-mono">';
    for (var i = 0; i < keys.length; i++) {
      var key = keys[i];
      var val = meta[key];
      var valStr = typeof val === "object" ? JSON.stringify(val, null, 2) : String(val);
      html += '<div class="flex gap-2 ' + (i > 0 ? 'mt-1' : '') + '">'
        + '<span class="text-muted font-semibold flex-shrink-0">' + escapeHtml(key) + ':</span>'
        + '<span class="text-dark break-all whitespace-pre-wrap">' + escapeHtml(valStr) + '</span>'
        + '</div>';
    }
    html += '</div>';
    return html;
  }

  function renderLogEntry(entry) {
    var hasMeta = entry.metadata_json && typeof entry.metadata_json === "object" && Object.keys(entry.metadata_json).length > 0;
    var expandId = "log-meta-" + entry.id;
    var toggleId = "log-toggle-" + entry.id;

    var html = '<div class="px-5 py-3 hover:bg-dark/[0.01] transition-colors">'
      + '<div class="flex items-start gap-3">';

    // Expand toggle (only if metadata exists)
    if (hasMeta) {
      html += '<button data-toggle="' + expandId + '" id="' + toggleId + '" class="mt-0.5 p-0.5 text-muted hover:text-dark transition-colors cursor-pointer flex-shrink-0 log-expand-btn">'
        + '<svg class="h-3.5 w-3.5 transition-transform duration-200" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>'
        + '</button>';
    } else {
      html += '<span class="w-[18px] flex-shrink-0"></span>';
    }

    // Timestamp
    html += '<span class="text-xs text-muted tabular-nums whitespace-nowrap mt-0.5 flex-shrink-0" title="' + escapeHtml(fmtDate(entry.timestamp) + ' ' + fmtTime(entry.timestamp)) + '">'
      + fmtTime(entry.timestamp)
      + '</span>';

    // Level badge
    html += '<span class="flex-shrink-0 mt-0.5">' + levelBadge(entry.level) + '</span>';

    // Source badge
    html += '<span class="flex-shrink-0 mt-0.5">' + sourceBadge(entry.source) + '</span>';

    // Message text
    html += '<span class="text-sm text-dark break-words flex-1">' + escapeHtml(entry.message) + '</span>';

    html += '</div>';

    // Expandable metadata
    if (hasMeta) {
      html += '<div id="' + expandId + '" class="hidden">' + formatMetadata(entry.metadata_json) + '</div>';
    }

    html += '</div>';
    return html;
  }

  // Data loading
  async function loadLogs(append) {
    if (!append) {
      currentOffset = 0;
      logs = [];
    }

    var params = buildFilterParams();
    params.set("limit", pageSize);
    params.set("offset", currentOffset);

    try {
      var res = await fetch("/api/v1/logs?" + params.toString());
      if (!res.ok) throw new Error("API error " + res.status);
      var data = await res.json();

      if (append) {
        logs = logs.concat(data);
      } else {
        logs = data;
      }

      renderLogs();
      loadMoreBtn.classList.toggle("hidden", data.length < pageSize);
    } catch (err) {
      container.innerHTML = '<div class="px-5 py-12 text-center text-muted">Failed to load logs</div>';
    }
  }

  function buildFilterParams() {
    var params = new URLSearchParams();
    if (filterLevel.value) params.set("level", filterLevel.value);
    if (filterSource.value) params.set("source", filterSource.value);
    if (filterAgent.value) params.set("agent_id", filterAgent.value);
    if (filterSearch.value.trim()) params.set("search", filterSearch.value.trim());

    var timeRange = filterTime.value;
    if (timeRange) {
      var now = new Date();
      var start = new Date(now);
      if (timeRange === "1h") start.setHours(start.getHours() - 1);
      else if (timeRange === "24h") start.setDate(start.getDate() - 1);
      else if (timeRange === "7d") start.setDate(start.getDate() - 7);
      else if (timeRange === "30d") start.setDate(start.getDate() - 30);
      params.set("start_time", start.toISOString().replace("Z", ""));
    }

    return params;
  }

  function renderLogs() {
    if (!logs.length) {
      container.innerHTML = '<div class="px-5 py-12 text-center text-muted">No logs found</div>';
      logCount.textContent = "0 log entries";
      return;
    }

    container.innerHTML = logs.map(renderLogEntry).join("");
    logCount.textContent = logs.length + " log entries";

    // Attach expand handlers
    container.querySelectorAll(".log-expand-btn").forEach(function (btn) {
      btn.addEventListener("click", function () {
        var targetId = btn.getAttribute("data-toggle");
        var target = document.getElementById(targetId);
        if (!target) return;
        var isOpen = !target.classList.contains("hidden");
        target.classList.toggle("hidden");
        var svg = btn.querySelector("svg");
        if (svg) svg.style.transform = isOpen ? "" : "rotate(90deg)";
      });
    });

    if (autoScroll) {
      container.scrollTop = 0; // newest at top
    }
  }

  // Load agents for filter
  async function loadAgents() {
    try {
      var res = await fetch("/api/v1/agents");
      if (!res.ok) return;
      var data = await res.json();
      agents = Array.isArray(data) ? data : (data.data || data.agents || []);
      filterAgent.innerHTML = '<option value="">All Agents</option>';
      agents.forEach(function (a) {
        var opt = document.createElement("option");
        opt.value = a.id;
        opt.textContent = a.name || a.id;
        filterAgent.appendChild(opt);
      });
    } catch (e) {
      // Agents endpoint may not be available; leave default
    }
  }

  // WebSocket streaming
  function connectStream() {
    if (ws) {
      ws.close();
      ws = null;
    }

    var proto = location.protocol === "https:" ? "wss:" : "ws:";
    ws = new WebSocket(proto + "//" + location.host + "/api/v1/logs/stream");

    ws.onopen = function () {
      streamStatus.classList.remove("hidden");
      streamStatus.classList.add("flex");
      // Send current filters
      sendStreamFilters();
    };

    ws.onmessage = function (event) {
      try {
        var msg = JSON.parse(event.data);
        if (msg.type === "log" && msg.payload) {
          // Add to beginning (newest at top)
          logs.unshift(msg.payload);
          renderLogs();
        }
      } catch (e) {
        // ignore
      }
    };

    ws.onclose = function () {
      streamStatus.classList.add("hidden");
      streamStatus.classList.remove("flex");
      // Reconnect after 3s
      setTimeout(connectStream, 3000);
    };

    ws.onerror = function () {
      ws.close();
    };
  }

  function sendStreamFilters() {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    var filters = {};
    if (filterLevel.value) filters.level = filterLevel.value;
    if (filterSource.value) filters.source = filterSource.value;
    if (filterAgent.value) filters.agent_id = filterAgent.value;
    ws.send(JSON.stringify(filters));
  }

  // Export functions
  function exportJSON() {
    var blob = new Blob([JSON.stringify(logs, null, 2)], { type: "application/json" });
    downloadBlob(blob, "orbiter-logs.json");
  }

  function exportCSV() {
    var header = "id,timestamp,level,source,agent_id,message,metadata\n";
    var rows = logs.map(function (l) {
      return [
        csvEscape(l.id),
        csvEscape(l.timestamp),
        csvEscape(l.level),
        csvEscape(l.source),
        csvEscape(l.agent_id || ""),
        csvEscape(l.message),
        csvEscape(l.metadata_json ? JSON.stringify(l.metadata_json) : ""),
      ].join(",");
    });
    var blob = new Blob([header + rows.join("\n")], { type: "text/csv" });
    downloadBlob(blob, "orbiter-logs.csv");
  }

  function csvEscape(val) {
    if (val == null) return '""';
    var s = String(val);
    if (s.indexOf(",") >= 0 || s.indexOf('"') >= 0 || s.indexOf("\n") >= 0) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }

  function downloadBlob(blob, filename) {
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Events
  function onFilterChange() {
    loadLogs(false);
    sendStreamFilters();
  }

  filterLevel.addEventListener("change", onFilterChange);
  filterSource.addEventListener("change", onFilterChange);
  filterAgent.addEventListener("change", onFilterChange);
  filterTime.addEventListener("change", onFilterChange);

  filterSearch.addEventListener("input", function () {
    clearTimeout(searchDebounce);
    searchDebounce = setTimeout(function () {
      loadLogs(false);
    }, 300);
  });

  refreshBtn.addEventListener("click", function () {
    loadLogs(false);
  });

  autoScrollToggle.addEventListener("change", function () {
    autoScroll = autoScrollToggle.checked;
    if (autoScroll) container.scrollTop = 0;
  });

  loadMoreBtn.addEventListener("click", function () {
    currentOffset += pageSize;
    loadLogs(true);
  });

  exportJsonBtn.addEventListener("click", exportJSON);
  exportCsvBtn.addEventListener("click", exportCSV);

  // Init
  loadAgents();
  loadLogs(false);
  connectStream();
})();
</script>
