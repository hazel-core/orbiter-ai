---
import PageLayout from "../../layouts/PageLayout.astro";

const breadcrumbs = [
  { label: "Monitoring", href: "/monitoring" },
  { label: "Health" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const refreshIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>';
const heartIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>';
const serverIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>';
---

<PageLayout
  title="Health Status"
  description="Agent and provider health overview"
  activeSection="monitoring"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div class="flex items-center gap-4">
        <a href="/monitoring" class="inline-flex items-center gap-1.5 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          Dashboard
        </a>
        <div>
          <h1 class="text-2xl font-semibold text-dark">Health Status</h1>
          <p class="text-sm text-muted mt-0.5">Per-agent and per-provider health overview</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="overall-status" class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium"></span>
        <button id="refresh-btn" class="p-2 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors cursor-pointer" title="Refresh">
          <span set:html={refreshIcon} />
        </button>
      </div>
    </div>

    <!-- Agent Health -->
    <div class="mb-8">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-muted" set:html={heartIcon} />
        <h2 class="text-lg font-semibold text-dark">Agent Health</h2>
        <span id="agent-count" class="text-xs text-muted"></span>
      </div>

      <div id="agent-health-loading" class="text-sm text-muted">Loading agent health...</div>
      <div id="agent-health-empty" class="hidden flex flex-col items-center py-8 text-center">
        <p class="text-sm text-muted">No agents configured yet.</p>
      </div>

      <div id="agent-health-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden"></div>
    </div>

    <!-- Provider Health -->
    <div>
      <div class="flex items-center gap-2 mb-4">
        <span class="text-muted" set:html={serverIcon} />
        <h2 class="text-lg font-semibold text-dark">Provider Health</h2>
        <span id="provider-count" class="text-xs text-muted"></span>
      </div>

      <div id="provider-health-loading" class="text-sm text-muted">Loading provider health...</div>
      <div id="provider-health-empty" class="hidden flex flex-col items-center py-8 text-center">
        <p class="text-sm text-muted">No providers configured yet.</p>
      </div>

      <div id="provider-health-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden"></div>
    </div>
  </div>
</PageLayout>

<script is:inline>
(function () {
  // DOM refs
  var overallStatus = document.getElementById("overall-status");
  var agentGrid = document.getElementById("agent-health-grid");
  var agentLoading = document.getElementById("agent-health-loading");
  var agentEmpty = document.getElementById("agent-health-empty");
  var agentCount = document.getElementById("agent-count");
  var providerGrid = document.getElementById("provider-health-grid");
  var providerLoading = document.getElementById("provider-health-loading");
  var providerEmpty = document.getElementById("provider-health-empty");
  var providerCount = document.getElementById("provider-count");
  var refreshBtn = document.getElementById("refresh-btn");

  function escapeHtml(str) {
    var div = document.createElement("div");
    div.textContent = str || "";
    return div.innerHTML;
  }

  function fmtLatency(ms) {
    if (ms == null || ms === 0) return "—";
    if (ms < 1000) return Math.round(ms) + "ms";
    return (ms / 1000).toFixed(1) + "s";
  }

  function fmtPercent(n) {
    if (n == null) return "—";
    return n.toFixed(1) + "%";
  }

  function statusDot(status) {
    if (status === "healthy" || status === "configured") {
      return '<span class="inline-block w-2.5 h-2.5 rounded-full bg-zen-green"></span>';
    }
    if (status === "degraded") {
      return '<span class="inline-block w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse"></span>';
    }
    return '<span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500"></span>';
  }

  function statusBadge(status) {
    if (status === "healthy" || status === "configured") {
      return '<span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700 border border-green-200">' + statusDot(status) + ' ' + escapeHtml(status.charAt(0).toUpperCase() + status.slice(1)) + '</span>';
    }
    if (status === "degraded") {
      return '<span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">' + statusDot(status) + ' Degraded</span>';
    }
    return '<span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700 border border-red-200">' + statusDot(status) + ' ' + escapeHtml(status) + '</span>';
  }

  function loadHealth() {
    fetch("/api/health")
      .then(function (r) { return r.json(); })
      .then(function (data) {
        renderOverall(data.status);
        renderAgents(data.agents || []);
        renderProviders(data.providers || []);
      })
      .catch(function () {
        overallStatus.className = "inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700 border border-red-200";
        overallStatus.innerHTML = "Error loading health data";
        agentLoading.textContent = "Failed to load";
        providerLoading.textContent = "Failed to load";
      });
  }

  function renderOverall(status) {
    if (status === "ok") {
      overallStatus.className = "inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700 border border-green-200";
      overallStatus.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-zen-green"></span> All Systems Operational';
    } else {
      overallStatus.className = "inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200";
      overallStatus.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span> Degraded';
    }
  }

  function renderAgents(agents) {
    agentLoading.classList.add("hidden");

    if (agents.length === 0) {
      agentEmpty.classList.remove("hidden");
      agentGrid.classList.add("hidden");
      agentCount.textContent = "";
      return;
    }

    agentEmpty.classList.add("hidden");
    agentGrid.classList.remove("hidden");
    agentCount.textContent = "(" + agents.length + ")";

    var html = "";
    agents.forEach(function (agent) {
      var successRate = agent.recent_runs > 0 ? (100 - agent.error_rate) : null;
      var barWidth = successRate != null ? Math.max(successRate, 2) : 0;
      var barColor = successRate == null ? "bg-dark/10" : (successRate >= 90 ? "bg-zen-green" : (successRate >= 50 ? "bg-yellow-400" : "bg-red-400"));

      html += '<div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm">';
      html += '  <div class="flex items-center justify-between mb-3">';
      html += '    <div class="flex items-center gap-2 min-w-0">';
      html += '      ' + statusDot(agent.status);
      html += '      <p class="text-sm font-medium text-dark truncate">' + escapeHtml(agent.name) + '</p>';
      html += '    </div>';
      html += '    ' + statusBadge(agent.status);
      html += '  </div>';

      // Success rate bar
      html += '  <div class="mb-3">';
      html += '    <div class="flex items-center justify-between text-xs text-muted mb-1">';
      html += '      <span>Success Rate</span>';
      html += '      <span class="tabular-nums">' + (successRate != null ? fmtPercent(successRate) : "No runs") + '</span>';
      html += '    </div>';
      html += '    <div class="w-full h-1.5 bg-dark/[0.06] rounded-full overflow-hidden">';
      html += '      <div class="h-full rounded-full ' + barColor + ' transition-all duration-300" style="width: ' + barWidth + '%"></div>';
      html += '    </div>';
      html += '  </div>';

      // Stats row
      html += '  <div class="grid grid-cols-3 gap-3 text-center">';
      html += '    <div>';
      html += '      <p class="text-xs text-muted">Runs (1h)</p>';
      html += '      <p class="text-sm font-medium text-dark tabular-nums">' + (agent.recent_runs || 0) + '</p>';
      html += '    </div>';
      html += '    <div>';
      html += '      <p class="text-xs text-muted">Avg Latency</p>';
      html += '      <p class="text-sm font-medium text-dark tabular-nums">' + fmtLatency(agent.avg_latency_ms) + '</p>';
      html += '    </div>';
      html += '    <div>';
      html += '      <p class="text-xs text-muted">Error Rate</p>';
      html += '      <p class="text-sm font-medium ' + (agent.error_rate > 50 ? "text-red-600" : "text-dark") + ' tabular-nums">' + fmtPercent(agent.error_rate) + '</p>';
      html += '    </div>';
      html += '  </div>';
      html += '</div>';
    });
    agentGrid.innerHTML = html;
  }

  function renderProviders(providers) {
    providerLoading.classList.add("hidden");

    if (providers.length === 0) {
      providerEmpty.classList.remove("hidden");
      providerGrid.classList.add("hidden");
      providerCount.textContent = "";
      return;
    }

    providerEmpty.classList.add("hidden");
    providerGrid.classList.remove("hidden");
    providerCount.textContent = "(" + providers.length + ")";

    var html = "";
    providers.forEach(function (prov) {
      var keyLabel = prov.key_count === 1 ? "1 key" : prov.key_count + " keys";
      var keyStatusCls = prov.status === "configured"
        ? "text-zen-green"
        : "text-yellow-600";

      html += '<div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm">';
      html += '  <div class="flex items-center justify-between mb-3">';
      html += '    <div class="flex items-center gap-2 min-w-0">';
      html += '      ' + statusDot(prov.status);
      html += '      <p class="text-sm font-medium text-dark truncate">' + escapeHtml(prov.name) + '</p>';
      html += '    </div>';
      html += '    ' + statusBadge(prov.status);
      html += '  </div>';

      html += '  <div class="space-y-2">';
      html += '    <div class="flex items-center justify-between text-sm">';
      html += '      <span class="text-muted">Type</span>';
      html += '      <span class="text-dark font-medium">' + escapeHtml(prov.provider_type) + '</span>';
      html += '    </div>';
      html += '    <div class="flex items-center justify-between text-sm">';
      html += '      <span class="text-muted">API Keys</span>';
      html += '      <span class="' + keyStatusCls + ' font-medium">' + keyLabel + '</span>';
      html += '    </div>';
      if (prov.status === "no_keys") {
        html += '    <p class="text-xs text-yellow-600 mt-1">No API keys configured. <a href="/settings" class="text-coral hover:underline">Add keys &rarr;</a></p>';
      }
      html += '  </div>';
      html += '</div>';
    });
    providerGrid.innerHTML = html;
  }

  refreshBtn.addEventListener("click", loadHealth);

  // Init
  loadHealth();
})();
</script>
