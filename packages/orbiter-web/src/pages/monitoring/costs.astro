---
import PageLayout from "../../layouts/PageLayout.astro";
import Modal from "../../components/Modal.astro";

const breadcrumbs = [
  { label: "Monitoring", href: "/monitoring" },
  { label: "Costs" },
];

/* Icons */
const dollarIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>';
const activityIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>';
const hashIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></svg>';
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
---

<PageLayout
  title="Cost Tracking"
  description="Cost tracking, budgets, and breakdowns"
  activeSection="monitoring"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Cost Tracking</h1>
        <p class="text-sm text-muted mt-1">Monitor spending, configure budgets, and view cost breakdowns</p>
      </div>
      <div class="flex items-center gap-3">
        <!-- Time range selector -->
        <div class="flex bg-dark/[0.05] rounded-lg p-0.5 gap-0.5">
          <button data-range="1h" class="range-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors cursor-pointer text-muted hover:text-dark">1h</button>
          <button data-range="24h" class="range-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors cursor-pointer text-muted hover:text-dark">24h</button>
          <button data-range="7d" class="range-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors cursor-pointer text-muted hover:text-dark">7d</button>
          <button data-range="30d" class="range-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors cursor-pointer bg-white text-dark shadow-sm">30d</button>
        </div>
      </div>
    </div>

    <!-- Budget warning banner (hidden by default) -->
    <div id="budget-banner" class="hidden mb-6 rounded-xl border px-5 py-4">
      <div class="flex items-center gap-3">
        <svg class="h-5 w-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        <div class="flex-1">
          <p id="budget-banner-title" class="text-sm font-semibold"></p>
          <p id="budget-banner-detail" class="text-xs mt-0.5 opacity-80"></p>
        </div>
        <div id="budget-banner-progress" class="w-32 h-2 rounded-full bg-dark/10 overflow-hidden">
          <div id="budget-banner-bar" class="h-full rounded-full transition-all duration-500"></div>
        </div>
        <span id="budget-banner-percent" class="text-sm font-semibold tabular-nums"></span>
      </div>
    </div>

    <!-- Summary metric cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
      <div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-2 text-muted">
          <span set:html={dollarIcon} />
          <span class="text-xs font-medium uppercase tracking-wide">Total Cost</span>
        </div>
        <p id="metric-total-cost" class="text-2xl font-semibold text-dark tabular-nums">—</p>
      </div>
      <div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-2 text-muted">
          <span set:html={activityIcon} />
          <span class="text-xs font-medium uppercase tracking-wide">Total Runs</span>
        </div>
        <p id="metric-total-runs" class="text-2xl font-semibold text-dark tabular-nums">—</p>
      </div>
      <div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-2 text-muted">
          <span set:html={hashIcon} />
          <span class="text-xs font-medium uppercase tracking-wide">Total Tokens</span>
        </div>
        <p id="metric-total-tokens" class="text-2xl font-semibold text-dark tabular-nums">—</p>
      </div>
    </div>

    <!-- Charts grid: cost by agent (horizontal bar) + cost over time (line) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="bg-white rounded-xl border border-dark/[0.06] p-5 shadow-sm">
        <h3 class="text-sm font-semibold text-dark mb-4">Cost by Agent</h3>
        <div id="chart-by-agent" class="h-48 flex items-center justify-center">
          <p class="text-sm text-muted">Loading...</p>
        </div>
      </div>
      <div class="bg-white rounded-xl border border-dark/[0.06] p-5 shadow-sm">
        <h3 class="text-sm font-semibold text-dark mb-4">Cost Over Time</h3>
        <div id="chart-cost-time" class="h-48 flex items-center justify-center">
          <p class="text-sm text-muted">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Cost by agent table -->
    <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden mb-8">
      <div class="px-5 py-4 border-b border-dark/[0.06]">
        <h3 class="text-sm font-semibold text-dark">Cost Breakdown by Agent</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-dark/[0.06] text-left">
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide">Agent / Workflow</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">Runs</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">Total Cost</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">% of Total</th>
            </tr>
          </thead>
          <tbody id="agent-cost-tbody">
            <tr><td colspan="4" class="px-5 py-8 text-center text-muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Budgets section -->
    <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden">
      <div class="px-5 py-4 border-b border-dark/[0.06] flex items-center justify-between">
        <div>
          <h3 class="text-sm font-semibold text-dark">Budget Limits</h3>
          <p class="text-xs text-muted mt-0.5">Set spending caps with alert thresholds</p>
        </div>
        <button id="add-budget-btn" class="inline-flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-lg bg-coral text-white hover:bg-coral/90 transition-colors cursor-pointer font-medium">
          <span set:html={plusIcon} />
          Add Budget
        </button>
      </div>

      <div id="budgets-loading" class="px-5 py-8 text-center text-sm text-muted">Loading budgets...</div>
      <div id="budgets-empty" class="hidden px-5 py-8 text-center text-sm text-muted">No budgets configured. Add a budget to track spending limits.</div>
      <div id="budgets-list" class="hidden divide-y divide-dark/[0.04]"></div>
    </div>
  </div>

  <!-- Add/Edit Budget Modal -->
  <Modal id="budget-modal" title="Configure Budget">
    <form id="budget-form" class="flex flex-col gap-4">
      <div class="flex flex-col gap-1.5">
        <label for="budget-scope" class="text-sm font-medium text-dark">Scope</label>
        <select id="budget-scope" name="scope" class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 cursor-pointer">
          <option value="workspace">Workspace (all agents)</option>
          <option value="agent">Specific Agent</option>
        </select>
      </div>
      <div id="budget-agent-group" class="hidden flex flex-col gap-1.5">
        <label for="budget-agent" class="text-sm font-medium text-dark">Agent</label>
        <select id="budget-agent" name="scope_id" class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 cursor-pointer">
          <option value="">Select an agent...</option>
        </select>
      </div>
      <div class="flex flex-col gap-1.5">
        <label for="budget-amount" class="text-sm font-medium text-dark">Budget Amount ($)</label>
        <input id="budget-amount" name="budget_amount" type="number" step="0.01" min="0.01" required
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
          placeholder="10.00" />
      </div>
      <div class="flex flex-col gap-1.5">
        <label for="budget-period" class="text-sm font-medium text-dark">Period</label>
        <select id="budget-period" name="period" class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 cursor-pointer">
          <option value="monthly">Monthly</option>
          <option value="daily">Daily</option>
        </select>
      </div>
      <div class="flex flex-col gap-1.5">
        <label for="budget-threshold" class="text-sm font-medium text-dark">
          Alert Threshold: <span id="threshold-value" class="text-coral tabular-nums">80</span>%
        </label>
        <input id="budget-threshold" name="alert_threshold" type="range" min="10" max="100" step="5" value="80"
          class="w-full h-2 rounded-full appearance-none cursor-pointer accent-coral" />
        <p class="text-xs text-muted">You'll see a warning when spending reaches this percentage of the budget.</p>
      </div>
      <div id="budget-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <button type="button" data-modal-close="budget-modal" class="inline-flex items-center gap-1.5 text-sm px-4 py-2 rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/5 transition-colors cursor-pointer">Cancel</button>
        <button type="submit" class="inline-flex items-center gap-1.5 text-sm px-4 py-2 rounded-lg bg-coral text-white hover:bg-coral/90 transition-colors cursor-pointer font-medium">Save Budget</button>
      </div>
    </form>
  </Modal>
</PageLayout>

<script is:inline>
(function () {
  var currentRange = "30d";

  // Formatting helpers
  function fmtNumber(n) {
    if (n == null) return "—";
    if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
    if (n >= 1000) return (n / 1000).toFixed(1) + "K";
    return n.toLocaleString();
  }

  function fmtCost(n) {
    if (n == null || n === 0) return "$0.00";
    if (n < 0.01) return "$" + n.toFixed(4);
    return "$" + n.toFixed(2);
  }

  function escapeHtml(s) {
    var d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML;
  }

  // ---------------------------------------------------------------------------
  // Range selector
  // ---------------------------------------------------------------------------
  var rangeButtons = document.querySelectorAll(".range-btn");
  rangeButtons.forEach(function (btn) {
    btn.addEventListener("click", function () {
      rangeButtons.forEach(function (b) {
        b.classList.remove("bg-white", "text-dark", "shadow-sm");
        b.classList.add("text-muted");
      });
      btn.classList.add("bg-white", "text-dark", "shadow-sm");
      btn.classList.remove("text-muted");
      currentRange = btn.getAttribute("data-range");
      refreshAll();
    });
  });

  // ---------------------------------------------------------------------------
  // Data fetching
  // ---------------------------------------------------------------------------
  function fetchJSON(url) {
    return fetch(url, { credentials: "same-origin" }).then(function (res) {
      if (!res.ok) throw new Error("API error " + res.status);
      return res.json();
    });
  }

  function loadSummary() {
    fetchJSON("/api/v1/costs/summary?range=" + currentRange)
      .then(function (data) {
        document.getElementById("metric-total-cost").textContent = fmtCost(data.total_cost);
        document.getElementById("metric-total-runs").textContent = fmtNumber(data.total_runs);
        document.getElementById("metric-total-tokens").textContent = fmtNumber(data.total_tokens);

        // Render agent breakdown
        renderAgentTable(data.cost_by_agent, data.total_cost);
        renderAgentChart(data.cost_by_agent);
      })
      .catch(function () {
        document.getElementById("metric-total-cost").textContent = "—";
        document.getElementById("metric-total-runs").textContent = "—";
        document.getElementById("metric-total-tokens").textContent = "—";
      });
  }

  function loadCostTimeseries() {
    var container = document.getElementById("chart-cost-time");
    fetchJSON("/api/v1/metrics/timeseries?range=" + currentRange + "&metric=cost")
      .then(function (data) {
        if (!data.length) {
          container.innerHTML = '<p class="text-sm text-muted">No data for this time range</p>';
          return;
        }
        renderLineChart(container, data);
      })
      .catch(function () {
        container.innerHTML = '<p class="text-sm text-muted">Failed to load chart data</p>';
      });
  }

  function loadBudgetCheck() {
    fetchJSON("/api/v1/costs/budget-check")
      .then(function (data) {
        if (!data) return;
        var banner = document.getElementById("budget-banner");
        var title = document.getElementById("budget-banner-title");
        var detail = document.getElementById("budget-banner-detail");
        var bar = document.getElementById("budget-banner-bar");
        var pct = document.getElementById("budget-banner-percent");

        if (data.status === "exceeded") {
          banner.className = "mb-6 rounded-xl border border-coral/30 bg-coral/5 text-coral px-5 py-4";
          title.textContent = "Budget Exceeded";
          detail.textContent = "Spent " + fmtCost(data.spent) + " of " + fmtCost(data.budget_amount) + " " + data.scope + " budget";
          bar.style.width = "100%";
          bar.className = "h-full rounded-full transition-all duration-500 bg-coral";
          pct.textContent = data.percent_used.toFixed(0) + "%";
          banner.classList.remove("hidden");
        } else if (data.status === "warning") {
          banner.className = "mb-6 rounded-xl border border-amber-400/30 bg-amber-50 text-amber-800 px-5 py-4";
          title.textContent = "Approaching Budget Limit";
          detail.textContent = "Spent " + fmtCost(data.spent) + " of " + fmtCost(data.budget_amount) + " " + data.scope + " budget";
          bar.style.width = Math.min(data.percent_used, 100) + "%";
          bar.className = "h-full rounded-full transition-all duration-500 bg-amber-500";
          pct.textContent = data.percent_used.toFixed(0) + "%";
          banner.classList.remove("hidden");
        } else {
          banner.classList.add("hidden");
        }
      })
      .catch(function () {
        /* Budget check is non-critical */
      });
  }

  function loadBudgets() {
    var loading = document.getElementById("budgets-loading");
    var empty = document.getElementById("budgets-empty");
    var list = document.getElementById("budgets-list");

    fetchJSON("/api/v1/costs/budgets")
      .then(function (data) {
        if (loading) loading.classList.add("hidden");
        if (!data.length) {
          if (empty) empty.classList.remove("hidden");
          if (list) list.classList.add("hidden");
          return;
        }
        if (empty) empty.classList.add("hidden");
        if (list) {
          list.classList.remove("hidden");
          list.innerHTML = data.map(function (b) {
            var scopeLabel = b.scope === "workspace" ? "Workspace" : "Agent: " + (b.scope_id || "—");
            return '<div class="px-5 py-4 flex items-center justify-between">'
              + '<div class="flex items-center gap-4">'
              + '<div>'
              + '<p class="text-sm font-medium text-dark">' + escapeHtml(scopeLabel) + '</p>'
              + '<p class="text-xs text-muted">' + b.period.charAt(0).toUpperCase() + b.period.slice(1) + ' budget</p>'
              + '</div>'
              + '</div>'
              + '<div class="flex items-center gap-6">'
              + '<div class="text-right">'
              + '<p class="text-sm font-semibold text-dark tabular-nums">' + fmtCost(b.budget_amount) + '</p>'
              + '<p class="text-xs text-muted">Alert at ' + b.alert_threshold + '%</p>'
              + '</div>'
              + '<button class="budget-delete-btn text-xs text-muted hover:text-coral transition-colors cursor-pointer" data-budget-id="' + b.id + '">'
              + '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>'
              + '</button>'
              + '</div>'
              + '</div>';
          }).join("");

          // Delete handlers
          list.querySelectorAll(".budget-delete-btn").forEach(function (btn) {
            btn.addEventListener("click", function () {
              var budgetId = btn.getAttribute("data-budget-id");
              if (confirm("Delete this budget?")) {
                deleteBudget(budgetId);
              }
            });
          });
        }
      })
      .catch(function () {
        if (loading) loading.textContent = "Failed to load budgets.";
      });
  }

  function deleteBudget(budgetId) {
    fetch("/api/v1/costs/budgets/" + budgetId, { method: "DELETE", credentials: "same-origin" })
      .then(function (res) {
        if (res.ok || res.status === 204) {
          loadBudgets();
          loadBudgetCheck();
        }
      })
      .catch(function () {});
  }

  function refreshAll() {
    loadSummary();
    loadCostTimeseries();
    loadBudgetCheck();
    loadBudgets();
  }

  // ---------------------------------------------------------------------------
  // Chart: cost by agent (horizontal bar chart)
  // ---------------------------------------------------------------------------
  function renderAgentChart(agents) {
    var container = document.getElementById("chart-by-agent");
    if (!agents || !agents.length) {
      container.innerHTML = '<p class="text-sm text-muted">No cost data for this time range</p>';
      return;
    }

    var sorted = agents.slice().sort(function (a, b) { return (b.cost || 0) - (a.cost || 0); }).slice(0, 8);
    var maxCost = sorted[0].cost || 1;
    var colors = ["var(--zen-coral)", "var(--zen-blue)", "var(--zen-green)", "#a78bfa", "#f59e0b", "#ec4899", "#14b8a6", "#8b5cf6"];

    var html = '<div class="flex flex-col gap-2.5">';
    sorted.forEach(function (agent, i) {
      var pct = Math.max(2, ((agent.cost || 0) / maxCost) * 100);
      var color = colors[i % colors.length];
      html += '<div class="flex items-center gap-3">'
        + '<span class="text-xs text-dark w-24 truncate text-right flex-shrink-0">' + escapeHtml(agent.name || "Unknown") + '</span>'
        + '<div class="flex-1 h-5 bg-dark/[0.04] rounded-full overflow-hidden">'
        + '<div class="h-full rounded-full transition-all duration-500" style="width:' + pct + '%;background:' + color + '"></div>'
        + '</div>'
        + '<span class="text-xs text-dark tabular-nums w-16 text-right flex-shrink-0">' + fmtCost(agent.cost) + '</span>'
        + '</div>';
    });
    html += '</div>';
    container.innerHTML = html;
  }

  // ---------------------------------------------------------------------------
  // Chart: cost over time (line chart — same style as monitoring)
  // ---------------------------------------------------------------------------
  function renderLineChart(container, data) {
    var W = container.clientWidth || 400;
    var H = 192;
    var pad = { top: 10, right: 10, bottom: 24, left: 50 };
    var cW = W - pad.left - pad.right;
    var cH = H - pad.top - pad.bottom;
    var maxVal = Math.max.apply(null, data.map(function (d) { return d.value; })) || 1;

    var points = [];
    var circles = "";
    for (var i = 0; i < data.length; i++) {
      var x = pad.left + (i / Math.max(data.length - 1, 1)) * cW;
      var y = pad.top + cH - (data[i].value / maxVal) * cH;
      points.push(x + "," + y);
      circles += '<circle cx="' + x + '" cy="' + y + '" r="3" fill="var(--zen-coral)" stroke="white" stroke-width="1.5"><title>' + data[i].bucket + ": $" + data[i].value.toFixed(4) + "</title></circle>";
    }

    var areaPoints = pad.left + "," + (pad.top + cH) + " " + points.join(" ") + " " + (pad.left + cW) + "," + (pad.top + cH);

    var yLabels = "";
    for (var j = 0; j <= 4; j++) {
      var yVal = (maxVal / 4) * j;
      var yPos = pad.top + cH - (j / 4) * cH;
      yLabels += '<text x="' + (pad.left - 4) + '" y="' + (yPos + 3) + '" text-anchor="end" class="fill-muted" font-size="10">$' + yVal.toFixed(2) + "</text>";
      yLabels += '<line x1="' + pad.left + '" y1="' + yPos + '" x2="' + (W - pad.right) + '" y2="' + yPos + '" stroke="var(--zen-dark)" stroke-opacity="0.06" />';
    }

    container.innerHTML =
      '<svg width="100%" height="' + H + '" viewBox="0 0 ' + W + " " + H + '">' +
      yLabels +
      '<polygon points="' + areaPoints + '" fill="var(--zen-coral)" opacity="0.1" />' +
      '<polyline points="' + points.join(" ") + '" fill="none" stroke="var(--zen-coral)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" />' +
      circles +
      "</svg>";
  }

  // ---------------------------------------------------------------------------
  // Agent breakdown table
  // ---------------------------------------------------------------------------
  function renderAgentTable(agents, totalCost) {
    var tbody = document.getElementById("agent-cost-tbody");
    if (!agents || !agents.length) {
      tbody.innerHTML = '<tr><td colspan="4" class="px-5 py-8 text-center text-muted">No cost data for this time range</td></tr>';
      return;
    }

    var sorted = agents.slice().sort(function (a, b) { return (b.cost || 0) - (a.cost || 0); });
    tbody.innerHTML = sorted.map(function (a) {
      var pct = totalCost > 0 ? ((a.cost || 0) / totalCost * 100) : 0;
      return '<tr class="border-b border-dark/[0.04] hover:bg-dark/[0.02] transition-colors">'
        + '<td class="px-5 py-3 font-medium text-dark">' + escapeHtml(a.name || "Unknown") + '</td>'
        + '<td class="px-5 py-3 text-right tabular-nums">' + (a.runs || 0) + '</td>'
        + '<td class="px-5 py-3 text-right tabular-nums font-medium">' + fmtCost(a.cost) + '</td>'
        + '<td class="px-5 py-3 text-right tabular-nums text-muted">' + pct.toFixed(1) + '%</td>'
        + '</tr>';
    }).join("");
  }

  // ---------------------------------------------------------------------------
  // Budget modal
  // ---------------------------------------------------------------------------
  var addBudgetBtn = document.getElementById("add-budget-btn");
  var budgetModal = document.getElementById("budget-modal");
  var budgetForm = document.getElementById("budget-form");
  var budgetScope = document.getElementById("budget-scope");
  var budgetAgentGroup = document.getElementById("budget-agent-group");
  var budgetThreshold = document.getElementById("budget-threshold");
  var thresholdValue = document.getElementById("threshold-value");
  var budgetError = document.getElementById("budget-error");

  // Slider label
  if (budgetThreshold) {
    budgetThreshold.addEventListener("input", function () {
      if (thresholdValue) thresholdValue.textContent = budgetThreshold.value;
    });
  }

  // Show/hide agent select
  if (budgetScope) {
    budgetScope.addEventListener("change", function () {
      if (budgetScope.value === "agent") {
        if (budgetAgentGroup) budgetAgentGroup.classList.remove("hidden");
        loadAgentsForBudget();
      } else {
        if (budgetAgentGroup) budgetAgentGroup.classList.add("hidden");
      }
    });
  }

  function loadAgentsForBudget() {
    var agentSelect = document.getElementById("budget-agent");
    if (!agentSelect) return;
    fetchJSON("/api/v1/agents")
      .then(function (body) { return body.data || body; })
      .then(function (data) {
        agentSelect.innerHTML = '<option value="">Select an agent...</option>';
        data.forEach(function (a) {
          agentSelect.innerHTML += '<option value="' + a.id + '">' + escapeHtml(a.name) + '</option>';
        });
      })
      .catch(function () {});
  }

  if (addBudgetBtn && budgetModal) {
    addBudgetBtn.addEventListener("click", function () {
      budgetForm.reset();
      if (thresholdValue) thresholdValue.textContent = "80";
      if (budgetAgentGroup) budgetAgentGroup.classList.add("hidden");
      if (budgetError) budgetError.classList.add("hidden");
      budgetModal.showModal();
    });
  }

  if (budgetForm) {
    budgetForm.addEventListener("submit", function (e) {
      e.preventDefault();
      if (budgetError) budgetError.classList.add("hidden");

      var scope = budgetScope.value;
      var scopeId = scope === "agent" ? document.getElementById("budget-agent").value : "";
      var amount = parseFloat(document.getElementById("budget-amount").value);
      var period = document.getElementById("budget-period").value;
      var threshold = parseFloat(budgetThreshold.value);

      if (scope === "agent" && !scopeId) {
        if (budgetError) {
          budgetError.textContent = "Please select an agent.";
          budgetError.classList.remove("hidden");
        }
        return;
      }

      fetch("/api/v1/costs/budgets", {
        method: "PUT",
        credentials: "same-origin",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          scope: scope,
          scope_id: scopeId,
          budget_amount: amount,
          period: period,
          alert_threshold: threshold,
        }),
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed"); });
          budgetModal.close();
          loadBudgets();
          loadBudgetCheck();
        })
        .catch(function (err) {
          if (budgetError) {
            budgetError.textContent = err.message || "Failed to save budget.";
            budgetError.classList.remove("hidden");
          }
        });
    });
  }

  // ---------------------------------------------------------------------------
  // Initial load
  // ---------------------------------------------------------------------------
  refreshAll();
})();
</script>
