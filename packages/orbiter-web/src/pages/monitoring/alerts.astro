---
import PageLayout from "../../layouts/PageLayout.astro";

const breadcrumbs = [
  { label: "Monitoring", href: "/monitoring" },
  { label: "Alerts" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const bellIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>';
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const refreshIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>';
---

<PageLayout
  title="Alerts"
  description="Configure alert rules and view triggered alerts"
  activeSection="monitoring"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div class="flex items-center gap-4">
        <a href="/monitoring" class="inline-flex items-center gap-1.5 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          Dashboard
        </a>
        <div>
          <h1 class="text-2xl font-semibold text-dark">Alerts</h1>
          <p class="text-sm text-muted mt-0.5">Configure alert rules and review triggered alerts</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="refresh-btn" class="p-2 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors cursor-pointer" title="Refresh">
          <span set:html={refreshIcon} />
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex border-b border-dark/[0.08] mb-6 gap-1">
      <button role="tab" data-tab="rules" class="alert-tab px-4 py-2.5 text-sm font-medium text-coral border-b-2 border-coral transition-colors duration-150 cursor-pointer whitespace-nowrap">
        Alert Rules
      </button>
      <button role="tab" data-tab="triggered" class="alert-tab px-4 py-2.5 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors duration-150 cursor-pointer whitespace-nowrap">
        Triggered Alerts
      </button>
    </div>

    <!-- ============================================================ -->
    <!-- TAB: Alert Rules                                             -->
    <!-- ============================================================ -->
    <div id="panel-rules" class="alert-panel">
      <!-- Create rule button -->
      <div class="flex items-center justify-between mb-4">
        <p id="rules-count" class="text-sm text-muted">Loading rules...</p>
        <button id="create-rule-btn" class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium rounded-lg bg-dark text-paper hover:bg-dark/90 transition-colors cursor-pointer">
          <span set:html={plusIcon} />
          New Rule
        </button>
      </div>

      <!-- Rules list -->
      <div id="rules-list" class="space-y-3"></div>

      <!-- Empty state -->
      <div id="rules-empty" class="hidden flex flex-col items-center py-12 text-center">
        <span class="text-muted/40 mb-3" set:html={bellIcon} />
        <p class="text-sm text-muted max-w-xs">No alert rules configured yet. Create one to start monitoring.</p>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- TAB: Triggered Alerts                                        -->
    <!-- ============================================================ -->
    <div id="panel-triggered" class="alert-panel hidden">
      <!-- Filters -->
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <select id="filter-severity" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer">
          <option value="">All Severities</option>
          <option value="critical">Critical</option>
          <option value="warning">Warning</option>
          <option value="info">Info</option>
        </select>
        <select id="filter-ack" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer">
          <option value="">All Status</option>
          <option value="false">Unacknowledged</option>
          <option value="true">Acknowledged</option>
        </select>
        <p id="alerts-count" class="text-sm text-muted ml-auto">Loading...</p>
      </div>

      <!-- Alerts table -->
      <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-dark/[0.06] text-left">
                <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide">Severity</th>
                <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide">Message</th>
                <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide">Agent</th>
                <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide">Time</th>
                <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide">Status</th>
                <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="alerts-table-body">
              <tr><td colspan="6" class="px-5 py-8 text-center text-muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <div id="alerts-pagination" class="flex items-center justify-between mt-4 hidden">
        <p id="alerts-range" class="text-sm text-muted"></p>
        <div class="flex items-center gap-2">
          <button id="prev-page" class="p-2 rounded-lg border border-dark/[0.08] text-muted hover:text-dark disabled:opacity-30 cursor-pointer transition-colors">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <button id="next-page" class="p-2 rounded-lg border border-dark/[0.08] text-muted hover:text-dark disabled:opacity-30 cursor-pointer transition-colors">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
        </div>
      </div>

      <!-- Empty state -->
      <div id="alerts-empty" class="hidden flex flex-col items-center py-12 text-center">
        <span class="text-muted/40 mb-3" set:html={bellIcon} />
        <p class="text-sm text-muted max-w-xs">No triggered alerts match the current filters.</p>
      </div>
    </div>
  </div>

  <!-- ================================================================ -->
  <!-- Create / Edit Rule Modal                                         -->
  <!-- ================================================================ -->
  <dialog id="rule-modal" class="fixed inset-0 z-50 m-0 w-full h-full max-w-none max-h-none bg-transparent backdrop:bg-dark/40 backdrop:backdrop-blur-sm open:flex open:items-center open:justify-center">
    <div class="w-full max-w-lg rounded-xl bg-paper border border-dark/[0.08] shadow-xl mx-4 p-6 animate-[zenScale_200ms_ease-out]">
      <h2 id="rule-modal-title" class="text-lg font-semibold text-dark mb-4">New Alert Rule</h2>
      <form id="rule-form" class="space-y-4">
        <input type="hidden" id="rule-id" value="" />

        <!-- Name -->
        <div>
          <label for="rule-name" class="block text-sm font-medium text-dark mb-1">Rule Name</label>
          <input id="rule-name" name="name" type="text" required minlength="1" maxlength="200"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all placeholder:text-muted"
            placeholder="e.g. High error rate alert" />
        </div>

        <!-- Condition type -->
        <div>
          <label for="rule-condition-type" class="block text-sm font-medium text-dark mb-1">Condition Type</label>
          <select id="rule-condition-type" name="condition_type" required
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer">
            <option value="error_rate">Error Rate (%)</option>
            <option value="latency">Latency (ms)</option>
            <option value="cost">Cost ($)</option>
          </select>
        </div>

        <!-- Threshold -->
        <div>
          <label for="rule-threshold" class="block text-sm font-medium text-dark mb-1">Threshold</label>
          <div class="flex items-center gap-2">
            <span id="threshold-prefix" class="text-sm text-muted">Exceeds</span>
            <input id="rule-threshold" name="condition_threshold" type="number" step="any" min="0.01" required
              class="flex-1 bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all tabular-nums"
              placeholder="50" />
            <span id="threshold-suffix" class="text-sm text-muted">%</span>
          </div>
        </div>

        <!-- Action type -->
        <div>
          <label for="rule-action-type" class="block text-sm font-medium text-dark mb-1">Action</label>
          <select id="rule-action-type" name="action_type" required
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer">
            <option value="toast">In-app Notification</option>
            <option value="email">Email</option>
            <option value="webhook">Webhook</option>
          </select>
        </div>

        <!-- Webhook URL (conditional) -->
        <div id="webhook-config" class="hidden">
          <label for="rule-webhook-url" class="block text-sm font-medium text-dark mb-1">Webhook URL</label>
          <input id="rule-webhook-url" name="webhook_url" type="url"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all placeholder:text-muted"
            placeholder="https://hooks.example.com/alert" />
        </div>

        <!-- Email (conditional) -->
        <div id="email-config" class="hidden">
          <label for="rule-email" class="block text-sm font-medium text-dark mb-1">Email Address</label>
          <input id="rule-email" name="email" type="email"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all placeholder:text-muted"
            placeholder="alerts@example.com" />
        </div>

        <!-- Enabled toggle -->
        <label class="flex items-center gap-3 cursor-pointer select-none">
          <span class="relative inline-flex">
            <input type="checkbox" id="rule-enabled" checked class="sr-only peer" />
            <div class="w-9 h-5 bg-dark/10 peer-checked:bg-coral rounded-full transition-colors duration-200"></div>
            <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full shadow transition-transform duration-200 peer-checked:translate-x-4"></div>
          </span>
          <span class="text-sm text-dark">Enabled</span>
        </label>

        <!-- Form error -->
        <p id="rule-form-error" class="text-sm text-coral hidden"></p>

        <!-- Buttons -->
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="rule-cancel-btn" class="px-4 py-2 text-sm font-medium rounded-lg text-dark hover:bg-dark/[0.05] transition-colors cursor-pointer">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium rounded-lg bg-dark text-paper hover:bg-dark/90 transition-colors cursor-pointer">Save Rule</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- ================================================================ -->
  <!-- Confirm delete dialog                                            -->
  <!-- ================================================================ -->
  <dialog id="delete-confirm" class="fixed inset-0 z-50 m-0 w-full h-full max-w-none max-h-none bg-transparent backdrop:bg-dark/40 backdrop:backdrop-blur-sm open:flex open:items-center open:justify-center">
    <div class="w-full max-w-sm rounded-xl bg-paper border border-dark/[0.08] shadow-xl mx-4 p-6 animate-[zenScale_200ms_ease-out]">
      <h2 class="text-lg font-semibold text-dark mb-2">Delete Alert Rule</h2>
      <p class="text-sm text-muted mb-5">This will permanently delete the rule and all associated alerts. This cannot be undone.</p>
      <div class="flex justify-end gap-3">
        <button id="delete-cancel" class="px-4 py-2 text-sm font-medium rounded-lg text-dark hover:bg-dark/[0.05] transition-colors cursor-pointer">Cancel</button>
        <button id="delete-confirm-btn" class="px-4 py-2 text-sm font-medium rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors cursor-pointer">Delete</button>
      </div>
    </div>
  </dialog>
</PageLayout>

<script is:inline>
(function () {
  // -----------------------------------------------------------------------
  // State
  // -----------------------------------------------------------------------
  var rules = [];
  var alertsPage = 0;
  var alertsLimit = 20;
  var deleteTargetId = null;

  // Icons as strings (for dynamic rendering)
  var editSvg = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
  var trashSvg = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
  var checkSvg = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';

  // DOM refs
  var tabs = document.querySelectorAll(".alert-tab");
  var panels = document.querySelectorAll(".alert-panel");
  var rulesList = document.getElementById("rules-list");
  var rulesEmpty = document.getElementById("rules-empty");
  var rulesCount = document.getElementById("rules-count");
  var createBtn = document.getElementById("create-rule-btn");
  var refreshBtn = document.getElementById("refresh-btn");
  var ruleModal = document.getElementById("rule-modal");
  var ruleForm = document.getElementById("rule-form");
  var ruleModalTitle = document.getElementById("rule-modal-title");
  var ruleIdInput = document.getElementById("rule-id");
  var ruleName = document.getElementById("rule-name");
  var ruleCondType = document.getElementById("rule-condition-type");
  var ruleThreshold = document.getElementById("rule-threshold");
  var ruleActionType = document.getElementById("rule-action-type");
  var ruleEnabled = document.getElementById("rule-enabled");
  var ruleWebhookUrl = document.getElementById("rule-webhook-url");
  var ruleEmail = document.getElementById("rule-email");
  var webhookConfig = document.getElementById("webhook-config");
  var emailConfig = document.getElementById("email-config");
  var thresholdSuffix = document.getElementById("threshold-suffix");
  var formError = document.getElementById("rule-form-error");
  var cancelBtn = document.getElementById("rule-cancel-btn");
  var deleteDialog = document.getElementById("delete-confirm");
  var deleteCancelBtn = document.getElementById("delete-cancel");
  var deleteConfirmBtn = document.getElementById("delete-confirm-btn");
  var alertsBody = document.getElementById("alerts-table-body");
  var alertsCountEl = document.getElementById("alerts-count");
  var alertsEmpty = document.getElementById("alerts-empty");
  var alertsPagination = document.getElementById("alerts-pagination");
  var alertsRange = document.getElementById("alerts-range");
  var prevPage = document.getElementById("prev-page");
  var nextPage = document.getElementById("next-page");
  var filterSeverity = document.getElementById("filter-severity");
  var filterAck = document.getElementById("filter-ack");

  // -----------------------------------------------------------------------
  // Helpers
  // -----------------------------------------------------------------------
  function escapeHtml(str) {
    var div = document.createElement("div");
    div.textContent = str || "";
    return div.innerHTML;
  }

  function fmtTime(t) {
    if (!t) return "—";
    var d = new Date(t.endsWith("Z") ? t : t + "Z");
    var now = new Date();
    var diff = now - d;
    if (diff < 60000) return "just now";
    if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
    if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
    return d.toLocaleDateString();
  }

  function conditionLabel(type) {
    var map = { error_rate: "Error Rate", latency: "Latency", cost: "Cost" };
    return map[type] || type;
  }

  function conditionUnit(type) {
    var map = { error_rate: "%", latency: "ms", cost: "$" };
    return map[type] || "";
  }

  function actionLabel(type) {
    var map = { toast: "In-app", email: "Email", webhook: "Webhook" };
    return map[type] || type;
  }

  function severityBadge(severity) {
    var colors = {
      critical: "bg-red-100 text-red-700 border-red-200",
      warning: "bg-yellow-100 text-yellow-800 border-yellow-200",
      info: "bg-blue-100 text-blue-700 border-blue-200",
    };
    var dots = {
      critical: "bg-red-500",
      warning: "bg-yellow-500",
      info: "bg-blue-500",
    };
    var cls = colors[severity] || colors.info;
    var dot = dots[severity] || dots.info;
    return '<span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium border ' + cls + '">' +
      '<span class="inline-block w-1.5 h-1.5 rounded-full ' + dot + '"></span>' +
      escapeHtml(severity) + '</span>';
  }

  // -----------------------------------------------------------------------
  // Tab switching
  // -----------------------------------------------------------------------
  tabs.forEach(function (tab) {
    tab.addEventListener("click", function () {
      var target = tab.getAttribute("data-tab");
      tabs.forEach(function (t) {
        t.classList.remove("text-coral", "border-coral");
        t.classList.add("text-muted", "border-transparent");
      });
      tab.classList.remove("text-muted", "border-transparent");
      tab.classList.add("text-coral", "border-coral");

      panels.forEach(function (p) { p.classList.add("hidden"); });
      document.getElementById("panel-" + target).classList.remove("hidden");

      if (target === "triggered") loadAlerts();
    });
  });

  // -----------------------------------------------------------------------
  // Rules CRUD
  // -----------------------------------------------------------------------
  function loadRules() {
    fetch("/api/v1/alerts/rules")
      .then(function (r) { return r.json(); })
      .then(function (data) {
        rules = data;
        renderRules();
      })
      .catch(function () {
        rulesCount.textContent = "Failed to load rules";
      });
  }

  function renderRules() {
    if (rules.length === 0) {
      rulesList.innerHTML = "";
      rulesEmpty.classList.remove("hidden");
      rulesCount.textContent = "No rules";
      return;
    }
    rulesEmpty.classList.add("hidden");
    rulesCount.textContent = rules.length + " rule" + (rules.length !== 1 ? "s" : "");

    var html = "";
    rules.forEach(function (rule) {
      var enabledDot = rule.enabled
        ? '<span class="inline-block w-2 h-2 rounded-full bg-zen-green"></span>'
        : '<span class="inline-block w-2 h-2 rounded-full bg-dark/20"></span>';
      var enabledText = rule.enabled ? "Enabled" : "Disabled";
      var unit = conditionUnit(rule.condition_type);
      var prefix = rule.condition_type === "cost" ? "$" : "";
      var suffix = rule.condition_type === "cost" ? "" : unit;
      var thresholdDisplay = prefix + rule.condition_threshold + suffix;

      html += '<div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm flex items-center justify-between gap-4 flex-wrap">';
      html += '  <div class="flex items-center gap-3 min-w-0 flex-1">';
      html += '    ' + enabledDot;
      html += '    <div class="min-w-0">';
      html += '      <p class="text-sm font-medium text-dark truncate">' + escapeHtml(rule.name) + '</p>';
      html += '      <p class="text-xs text-muted mt-0.5">' + conditionLabel(rule.condition_type) + ' exceeds ' + thresholdDisplay + ' &middot; ' + actionLabel(rule.action_type) + ' &middot; ' + enabledText + '</p>';
      html += '    </div>';
      html += '  </div>';
      html += '  <div class="flex items-center gap-1.5">';
      html += '    <button data-edit="' + rule.id + '" class="p-1.5 rounded-md text-muted hover:text-dark hover:bg-dark/[0.05] transition-colors cursor-pointer" title="Edit">' + editSvg + '</button>';
      html += '    <button data-delete="' + rule.id + '" class="p-1.5 rounded-md text-muted hover:text-red-600 hover:bg-red-50 transition-colors cursor-pointer" title="Delete">' + trashSvg + '</button>';
      html += '  </div>';
      html += '</div>';
    });
    rulesList.innerHTML = html;

    // Bind edit buttons
    rulesList.querySelectorAll("[data-edit]").forEach(function (btn) {
      btn.addEventListener("click", function () {
        var id = btn.getAttribute("data-edit");
        var rule = rules.find(function (r) { return r.id === id; });
        if (rule) openEditModal(rule);
      });
    });

    // Bind delete buttons
    rulesList.querySelectorAll("[data-delete]").forEach(function (btn) {
      btn.addEventListener("click", function () {
        deleteTargetId = btn.getAttribute("data-delete");
        deleteDialog.showModal();
      });
    });
  }

  // -----------------------------------------------------------------------
  // Modal logic
  // -----------------------------------------------------------------------
  function openCreateModal() {
    ruleModalTitle.textContent = "New Alert Rule";
    ruleIdInput.value = "";
    ruleForm.reset();
    ruleEnabled.checked = true;
    updateThresholdSuffix();
    updateActionConfig();
    formError.classList.add("hidden");
    ruleModal.showModal();
  }

  function openEditModal(rule) {
    ruleModalTitle.textContent = "Edit Alert Rule";
    ruleIdInput.value = rule.id;
    ruleName.value = rule.name;
    ruleCondType.value = rule.condition_type;
    ruleThreshold.value = rule.condition_threshold;
    ruleActionType.value = rule.action_type;
    ruleEnabled.checked = rule.enabled;

    if (rule.action_config_json) {
      if (rule.action_type === "webhook" && rule.action_config_json.url) {
        ruleWebhookUrl.value = rule.action_config_json.url;
      }
      if (rule.action_type === "email" && rule.action_config_json.email) {
        ruleEmail.value = rule.action_config_json.email;
      }
    }

    updateThresholdSuffix();
    updateActionConfig();
    formError.classList.add("hidden");
    ruleModal.showModal();
  }

  function updateThresholdSuffix() {
    var type = ruleCondType.value;
    var map = { error_rate: "%", latency: "ms", cost: "$" };
    thresholdSuffix.textContent = map[type] || "";
  }

  function updateActionConfig() {
    var action = ruleActionType.value;
    webhookConfig.classList.toggle("hidden", action !== "webhook");
    emailConfig.classList.toggle("hidden", action !== "email");
  }

  ruleCondType.addEventListener("change", updateThresholdSuffix);
  ruleActionType.addEventListener("change", updateActionConfig);

  createBtn.addEventListener("click", openCreateModal);

  cancelBtn.addEventListener("click", function () {
    ruleModal.close();
  });

  // Close modal on backdrop click
  ruleModal.addEventListener("click", function (e) {
    if (e.target === ruleModal) ruleModal.close();
  });

  deleteDialog.addEventListener("click", function (e) {
    if (e.target === deleteDialog) deleteDialog.close();
  });

  deleteCancelBtn.addEventListener("click", function () {
    deleteDialog.close();
  });

  // -----------------------------------------------------------------------
  // Save rule
  // -----------------------------------------------------------------------
  ruleForm.addEventListener("submit", function (e) {
    e.preventDefault();
    formError.classList.add("hidden");

    var id = ruleIdInput.value;
    var actionConfig = null;
    if (ruleActionType.value === "webhook" && ruleWebhookUrl.value) {
      actionConfig = { url: ruleWebhookUrl.value };
    } else if (ruleActionType.value === "email" && ruleEmail.value) {
      actionConfig = { email: ruleEmail.value };
    }

    var body = {
      name: ruleName.value.trim(),
      condition_type: ruleCondType.value,
      condition_threshold: parseFloat(ruleThreshold.value),
      action_type: ruleActionType.value,
      action_config_json: actionConfig,
      enabled: ruleEnabled.checked,
    };

    var url = id ? "/api/v1/alerts/rules/" + id : "/api/v1/alerts/rules";
    var method = id ? "PUT" : "POST";

    fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    })
      .then(function (r) {
        if (!r.ok) return r.json().then(function (d) { throw new Error(d.detail || "Failed to save"); });
        return r.json();
      })
      .then(function () {
        ruleModal.close();
        loadRules();
      })
      .catch(function (err) {
        formError.textContent = err.message;
        formError.classList.remove("hidden");
      });
  });

  // -----------------------------------------------------------------------
  // Delete rule
  // -----------------------------------------------------------------------
  deleteConfirmBtn.addEventListener("click", function () {
    if (!deleteTargetId) return;
    fetch("/api/v1/alerts/rules/" + deleteTargetId, { method: "DELETE" })
      .then(function (r) {
        if (!r.ok) throw new Error("Failed to delete");
        deleteDialog.close();
        deleteTargetId = null;
        loadRules();
      })
      .catch(function () {
        deleteDialog.close();
      });
  });

  // -----------------------------------------------------------------------
  // Alerts list
  // -----------------------------------------------------------------------
  function loadAlerts() {
    var params = new URLSearchParams();
    params.set("limit", alertsLimit);
    params.set("offset", alertsPage * alertsLimit);
    if (filterSeverity.value) params.set("severity", filterSeverity.value);
    if (filterAck.value) params.set("acknowledged", filterAck.value);

    fetch("/api/v1/alerts?" + params.toString())
      .then(function (r) { return r.json(); })
      .then(function (data) { renderAlerts(data); })
      .catch(function () {
        alertsBody.innerHTML = '<tr><td colspan="6" class="px-5 py-8 text-center text-coral">Failed to load alerts</td></tr>';
      });
  }

  function renderAlerts(data) {
    if (data.length === 0) {
      alertsBody.innerHTML = "";
      alertsEmpty.classList.remove("hidden");
      alertsCountEl.textContent = "No alerts";
      alertsPagination.classList.add("hidden");
      // Hide the table wrapper
      alertsBody.closest(".bg-white").classList.add("hidden");
      return;
    }

    alertsEmpty.classList.add("hidden");
    alertsBody.closest(".bg-white").classList.remove("hidden");
    alertsCountEl.textContent = data.length + " alert" + (data.length !== 1 ? "s" : "");

    // Pagination
    var start = alertsPage * alertsLimit + 1;
    var end = start + data.length - 1;
    alertsRange.textContent = start + "–" + end;
    alertsPagination.classList.remove("hidden");
    prevPage.disabled = alertsPage === 0;
    nextPage.disabled = data.length < alertsLimit;

    var html = "";
    data.forEach(function (alert) {
      var ackBadge = alert.acknowledged
        ? '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700 border border-green-200">Acknowledged</span>'
        : '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">Open</span>';

      var ackBtn = !alert.acknowledged
        ? '<button data-ack="' + alert.id + '" class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors cursor-pointer" title="Acknowledge">' + checkSvg + ' Ack</button>'
        : '';

      html += '<tr class="border-b border-dark/[0.04] hover:bg-dark/[0.02] transition-colors">';
      html += '  <td class="px-5 py-3.5">' + severityBadge(alert.severity) + '</td>';
      html += '  <td class="px-5 py-3.5 text-sm text-dark max-w-xs truncate">' + escapeHtml(alert.message) + '</td>';
      html += '  <td class="px-5 py-3.5 text-sm text-muted">' + escapeHtml(alert.agent_id || "—") + '</td>';
      html += '  <td class="px-5 py-3.5 text-xs text-muted tabular-nums whitespace-nowrap">' + fmtTime(alert.created_at) + '</td>';
      html += '  <td class="px-5 py-3.5">' + ackBadge + '</td>';
      html += '  <td class="px-5 py-3.5 text-right">' + ackBtn + '</td>';
      html += '</tr>';
    });
    alertsBody.innerHTML = html;

    // Bind acknowledge buttons
    alertsBody.querySelectorAll("[data-ack]").forEach(function (btn) {
      btn.addEventListener("click", function () {
        var id = btn.getAttribute("data-ack");
        acknowledgeAlert(id);
      });
    });
  }

  function acknowledgeAlert(id) {
    fetch("/api/v1/alerts/" + id + "/acknowledge", { method: "PUT" })
      .then(function (r) {
        if (!r.ok) throw new Error("Failed");
        loadAlerts();
      })
      .catch(function () {});
  }

  // Filter listeners
  filterSeverity.addEventListener("change", function () { alertsPage = 0; loadAlerts(); });
  filterAck.addEventListener("change", function () { alertsPage = 0; loadAlerts(); });
  prevPage.addEventListener("click", function () { if (alertsPage > 0) { alertsPage--; loadAlerts(); } });
  nextPage.addEventListener("click", function () { alertsPage++; loadAlerts(); });

  // -----------------------------------------------------------------------
  // Refresh
  // -----------------------------------------------------------------------
  refreshBtn.addEventListener("click", function () {
    loadRules();
    // Only load alerts if visible
    if (!document.getElementById("panel-triggered").classList.contains("hidden")) {
      loadAlerts();
    }
  });

  // -----------------------------------------------------------------------
  // Init
  // -----------------------------------------------------------------------
  loadRules();
})();
</script>
