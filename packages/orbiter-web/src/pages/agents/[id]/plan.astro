---
import PageLayout from "../../../layouts/PageLayout.astro";
import PlanPanelIsland from "../../../islands/PlanPanel/PlanPanelIsland";

const { id } = Astro.params;

const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
---

<PageLayout
  title="Execution Plan"
  description="View and manage the agent's autonomous execution plan"
  activeSection="agents"
  breadcrumbs={[
    { label: "Agents", href: "/agents" },
    { label: "Loading..." },
    { label: "Plan" },
  ]}
>
  <div class="p-6 max-w-3xl mx-auto">
    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-10">
      <p class="text-sm text-muted">Loading agent...</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <p class="text-lg font-semibold text-dark mb-2">Agent not found</p>
      <p class="text-sm text-muted mb-6">This agent may have been deleted or you don't have access.</p>
      <a href="/agents" class="flex items-center gap-2 text-sm text-coral hover:underline">
        <span set:html={backIcon} />
        Back to Agents
      </a>
    </div>

    <!-- Plan content (hidden until loaded) -->
    <div id="plan-content" class="hidden">
      <!-- Back + agent name -->
      <div class="flex items-center gap-4 mb-6">
        <a id="back-link" href="/agents" class="flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          Back
        </a>
        <div class="flex-1">
          <h1 id="agent-name-heading" class="text-xl font-semibold text-dark"></h1>
          <p class="text-xs text-muted mt-0.5">Autonomous Execution Plan</p>
        </div>
        <a
          id="edit-link"
          href={`/agents/${id}/edit`}
          class="text-xs text-muted hover:text-coral transition-colors border border-dark/[0.08] rounded-lg px-3 py-1.5"
        >
          Edit Agent
        </a>
      </div>

      <!-- React island -->
      <PlanPanelIsland client:only="react" agentId={id!} />
    </div>
  </div>

  <script is:inline define:vars={{ agentId: id }}>
    (async function() {
      const loadingEl = document.getElementById("loading-state");
      const errorEl = document.getElementById("error-state");
      const contentEl = document.getElementById("plan-content");
      const nameEl = document.getElementById("agent-name-heading");
      const backLink = document.getElementById("back-link");

      try {
        const resp = await fetch(`/api/v1/agents/${agentId}`);
        if (!resp.ok) throw new Error("Not found");
        const agent = await resp.json();

        if (nameEl) nameEl.textContent = agent.name;
        if (backLink) {
          if (agent.project_id) {
            backLink.setAttribute("href", `/projects/${agent.project_id}`);
          }
        }

        // Update breadcrumb
        const breadcrumbEls = document.querySelectorAll("[data-breadcrumb-label]");
        if (breadcrumbEls.length >= 2) {
          breadcrumbEls[1].textContent = agent.name;
        }

        if (loadingEl) loadingEl.classList.add("hidden");
        if (contentEl) contentEl.classList.remove("hidden");
      } catch {
        if (loadingEl) loadingEl.classList.add("hidden");
        if (errorEl) errorEl.classList.remove("hidden");
      }
    })();
  </script>
</PageLayout>
