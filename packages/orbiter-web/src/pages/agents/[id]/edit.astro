---
import PageLayout from "../../../layouts/PageLayout.astro";
import Button from "../../../components/Button.astro";
import Modal from "../../../components/Modal.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Agents", href: "/agents" },
  { label: "Loading..." },
  { label: "Edit" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const saveIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>';
---

<PageLayout
  title="Edit Agent"
  description="Configure agent settings"
  activeSection="agents"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-3xl mx-auto">
    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading agent...</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <p class="text-lg font-semibold text-dark mb-2">Agent not found</p>
      <p class="text-sm text-muted mb-6">This agent may have been deleted.</p>
      <Button href="/agents" variant="bordered">
        <span set:html={backIcon} />
        Back to Agents
      </Button>
    </div>

    <!-- Agent editor (hidden until loaded) -->
    <div id="editor-content" class="hidden">
      <!-- Back + Save row -->
      <div class="flex items-center justify-between mb-6">
        <a id="back-link" href="/agents" class="flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          Back
        </a>
        <div class="flex items-center gap-3">
          <span id="save-status" class="text-xs text-muted hidden"></span>
          <Button variant="primary" id="save-btn" class="text-sm">
            <span set:html={saveIcon} />
            Save
          </Button>
        </div>
      </div>

      <!-- Agent name heading -->
      <h1 id="agent-name-heading" class="text-2xl font-semibold text-dark mb-6"></h1>

      <!-- Tabs -->
      <div class="border-b border-dark/[0.08] mb-6">
        <nav class="flex gap-6" role="tablist">
          <button
            type="button"
            role="tab"
            aria-selected="true"
            data-tab="basic"
            class="tab-btn relative pb-3 text-sm font-medium text-dark border-b-2 border-coral transition-colors"
          >
            Basic
          </button>
          <button
            type="button"
            role="tab"
            aria-selected="false"
            data-tab="model"
            class="tab-btn relative pb-3 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors"
          >
            Model
          </button>
          <button
            type="button"
            role="tab"
            aria-selected="false"
            data-tab="tools"
            class="tab-btn relative pb-3 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors"
          >
            Tools
          </button>
          <button
            type="button"
            role="tab"
            aria-selected="false"
            data-tab="handoffs"
            class="tab-btn relative pb-3 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors"
          >
            Handoffs
          </button>
          <button
            type="button"
            role="tab"
            aria-selected="false"
            data-tab="hooks"
            class="tab-btn relative pb-3 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors"
          >
            Hooks
          </button>
          <button
            type="button"
            role="tab"
            aria-selected="false"
            data-tab="advanced"
            class="tab-btn relative pb-3 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors"
          >
            Advanced
          </button>
        </nav>
      </div>

      <!-- Tab panels -->
      <!-- Basic tab -->
      <div id="panel-basic" class="tab-panel" role="tabpanel">
        <div class="flex flex-col gap-5">
          <!-- Name -->
          <div class="flex flex-col gap-1.5">
            <label for="agent-name" class="text-sm font-medium text-dark">
              Name <span class="text-coral">*</span>
            </label>
            <input
              type="text"
              id="agent-name"
              name="name"
              required
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="My Agent"
            />
            <p id="name-error" class="text-xs text-coral hidden">Name is required</p>
          </div>

          <!-- Description -->
          <div class="flex flex-col gap-1.5">
            <label for="agent-description" class="text-sm font-medium text-dark">Description</label>
            <input
              type="text"
              id="agent-description"
              name="description"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="A brief description of this agent"
            />
          </div>

          <!-- Persona section (collapsible) -->
          <div class="rounded-lg border border-dark/[0.08] bg-paper overflow-hidden">
            <button
              type="button"
              id="persona-toggle"
              class="flex w-full items-center justify-between px-4 py-3 text-left hover:bg-subtle/50 transition-colors cursor-pointer"
            >
              <div class="flex items-center gap-2">
                <span class="flex h-6 w-6 items-center justify-center rounded bg-coral/10 text-coral">
                  <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </span>
                <span class="text-sm font-medium text-dark">Persona</span>
                <span id="persona-badge" class="hidden text-[10px] font-medium text-coral bg-coral/10 rounded-full px-2 py-0.5">Set</span>
              </div>
              <svg id="persona-chevron" class="h-4 w-4 text-muted transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div id="persona-content" class="hidden border-t border-dark/[0.06] px-4 py-4">
              <div class="flex flex-col gap-4">
                <!-- Template dropdown -->
                <div class="flex items-center gap-2">
                  <label class="text-xs font-medium text-muted">Template:</label>
                  <select
                    id="persona-template"
                    class="bg-subtle/50 border border-dark/[0.06] rounded-md px-2 py-1 text-xs text-dark outline-none focus:border-coral transition-all cursor-pointer"
                  >
                    <option value="">Custom...</option>
                    <option value="researcher">Researcher</option>
                    <option value="writer">Writer</option>
                    <option value="coder">Coder</option>
                    <option value="reviewer">Reviewer</option>
                    <option value="planner">Planner</option>
                  </select>
                  <button
                    type="button"
                    id="persona-preview-btn"
                    class="ml-auto flex items-center gap-1 rounded-md bg-subtle px-2 py-1 text-[11px] font-medium text-muted hover:bg-dark/[0.08] hover:text-dark transition-colors cursor-pointer"
                    title="Preview full system prompt with persona"
                  >
                    <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    Preview
                  </button>
                </div>

                <!-- Role -->
                <div class="flex flex-col gap-1">
                  <label for="persona-role" class="text-xs font-medium text-dark">Role</label>
                  <input
                    type="text"
                    id="persona-role"
                    placeholder="e.g. Senior Research Analyst"
                    class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
                  />
                </div>

                <!-- Goal -->
                <div class="flex flex-col gap-1">
                  <label for="persona-goal" class="text-xs font-medium text-dark">Goal</label>
                  <input
                    type="text"
                    id="persona-goal"
                    placeholder="e.g. Provide accurate, well-researched analysis"
                    class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
                  />
                </div>

                <!-- Backstory -->
                <div class="flex flex-col gap-1">
                  <label for="persona-backstory" class="text-xs font-medium text-dark">Backstory</label>
                  <textarea
                    id="persona-backstory"
                    rows="3"
                    placeholder="e.g. You are an experienced analyst with decades of field research..."
                    class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all resize-y"
                  ></textarea>
                </div>

                <p class="text-xs text-muted">When set, persona fields are auto-injected into the system prompt before your instructions.</p>
              </div>
            </div>
          </div>

          <!-- Persona preview modal rendered below PageLayout -->

          <!-- Instructions / System Prompt (Enhanced Editor) -->
          <div class="flex flex-col lg:flex-row gap-4">
            <!-- Editor column -->
            <div class="flex-1 flex flex-col gap-1.5 min-w-0">
              <div class="flex items-center justify-between">
                <label for="agent-instructions" class="text-sm font-medium text-dark">Instructions (System Prompt)</label>
                <div class="flex items-center gap-2">
                  <button type="button" id="save-template-btn" class="flex items-center gap-1 rounded-md bg-subtle px-2 py-1 text-[11px] font-medium text-muted hover:bg-dark/[0.08] hover:text-dark transition-colors cursor-pointer" title="Save as template">
                    <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Save
                  </button>
                  <button type="button" id="load-template-btn" class="flex items-center gap-1 rounded-md bg-subtle px-2 py-1 text-[11px] font-medium text-muted hover:bg-dark/[0.08] hover:text-dark transition-colors cursor-pointer" title="Load template">
                    <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                    Load
                  </button>
                  <button type="button" id="test-prompt-btn" class="flex items-center gap-1 rounded-md bg-coral/10 px-2 py-1 text-[11px] font-medium text-coral hover:bg-coral/20 transition-colors cursor-pointer" title="Test prompt">
                    <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    Test
                  </button>
                  <button type="button" id="compare-models-btn" class="flex items-center gap-1 rounded-md bg-zen-blue/10 px-2 py-1 text-[11px] font-medium text-zen-blue hover:bg-zen-blue/20 transition-colors cursor-pointer" title="Compare across models">
                    <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                    Compare
                  </button>
                  <button type="button" id="version-history-btn" class="flex items-center gap-1 rounded-md bg-subtle px-2 py-1 text-[11px] font-medium text-muted hover:bg-dark/[0.08] hover:text-dark transition-colors cursor-pointer" title="Version history">
                    <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    History
                  </button>
                  <button type="button" id="import-prompt-btn" class="flex items-center gap-1 rounded-md bg-subtle px-2 py-1 text-[11px] font-medium text-muted hover:bg-dark/[0.08] hover:text-dark transition-colors cursor-pointer" title="Import JSON">
                    <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                  </button>
                  <button type="button" id="export-prompt-btn" class="flex items-center gap-1 rounded-md bg-subtle px-2 py-1 text-[11px] font-medium text-muted hover:bg-dark/[0.08] hover:text-dark transition-colors cursor-pointer" title="Export JSON">
                    <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                  </button>
                  <input type="file" id="import-file-input" accept=".json" class="hidden" />
                </div>
              </div>
              <div class="relative">
                <!-- Highlight backdrop -->
                <div
                  id="instructions-backdrop"
                  class="absolute inset-0 bg-paper border border-transparent rounded-lg px-3 py-2 font-mono text-sm leading-relaxed whitespace-pre-wrap break-words overflow-hidden pointer-events-none"
                  aria-hidden="true"
                ></div>
                <!-- Actual textarea (transparent text, on top) -->
                <textarea
                  id="agent-instructions"
                  name="instructions"
                  rows="12"
                  class="relative z-10 w-full bg-transparent border border-dark/[0.08] rounded-lg px-3 py-2 text-transparent caret-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-y font-mono text-sm leading-relaxed"
                  placeholder="You are a helpful assistant..."
                  spellcheck="false"
                ></textarea>
              </div>
              <!-- Token counter -->
              <div class="flex items-center justify-between">
                <p class="text-xs text-muted">Use <code class="bg-subtle/80 px-1 py-0.5 rounded text-[11px]">{"{{variable_name}}"}</code> for template variables.</p>
                <div id="token-counter" class="flex items-center gap-1.5 text-xs text-muted">
                  <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                  <span id="token-count-value">~0 tokens</span>
                </div>
              </div>

              <!-- Test prompt result panel -->
              <div id="test-result-panel" class="hidden rounded-lg border border-dark/[0.08] bg-subtle/50 overflow-hidden">
                <div class="flex items-center justify-between px-3 py-2 border-b border-dark/[0.06] bg-paper">
                  <div class="flex items-center gap-2">
                    <span class="text-xs font-semibold text-dark uppercase tracking-wider">Test Result</span>
                    <span id="test-result-model" class="text-[10px] font-medium text-muted font-mono"></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span id="test-result-meta" class="text-[10px] text-muted"></span>
                    <button type="button" id="close-test-result" class="flex h-5 w-5 items-center justify-center rounded text-muted hover:text-dark transition-colors cursor-pointer">
                      <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                  </div>
                </div>
                <div id="test-result-content" class="px-3 py-3 text-sm text-dark whitespace-pre-wrap font-mono leading-relaxed max-h-64 overflow-y-auto"></div>
              </div>

              <!-- Model comparison result panel -->
              <div id="compare-result-panel" class="hidden rounded-lg border border-zen-blue/20 bg-subtle/50 overflow-hidden">
                <div class="flex items-center justify-between px-3 py-2 border-b border-dark/[0.06] bg-paper">
                  <span class="text-xs font-semibold text-zen-blue uppercase tracking-wider">Model Comparison</span>
                  <button type="button" id="close-compare-result" class="flex h-5 w-5 items-center justify-center rounded text-muted hover:text-dark transition-colors cursor-pointer">
                    <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>
                <div id="compare-result-content" class="grid gap-0 max-h-96 overflow-y-auto"></div>
              </div>
            </div>

            <!-- Variables panel -->
            <div id="variables-panel" class="hidden lg:w-64 flex-shrink-0">
              <div class="rounded-lg border border-dark/[0.08] bg-paper">
                <div class="flex items-center justify-between px-3 py-2.5 border-b border-dark/[0.06]">
                  <h4 class="text-xs font-semibold text-dark uppercase tracking-wider">Variables</h4>
                  <span id="variable-count" class="text-[10px] font-medium text-muted bg-subtle rounded-full px-2 py-0.5">0</span>
                </div>
                <div id="variables-list" class="flex flex-col divide-y divide-dark/[0.06] max-h-80 overflow-y-auto">
                  <div class="px-3 py-4 text-center">
                    <p class="text-xs text-muted">No variables detected.</p>
                    <p class="text-[11px] text-muted/60 mt-0.5">Use {"{{name}}"} syntax in your prompt.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Model tab -->
      <div id="panel-model" class="tab-panel hidden" role="tabpanel">
        <div class="flex flex-col gap-5">
          <!-- Provider selector -->
          <div class="flex flex-col gap-1.5">
            <label for="model-provider" class="text-sm font-medium text-dark">Provider</label>
            <select
              id="model-provider"
              name="model_provider"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer"
            >
              <option value="">Select a provider...</option>
            </select>
            <p class="text-xs text-muted">Choose from your configured providers.</p>
          </div>

          <!-- Model selector -->
          <div class="flex flex-col gap-1.5">
            <label for="model-name" class="text-sm font-medium text-dark">Model</label>
            <select
              id="model-name"
              name="model_name"
              disabled
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <option value="">Select a provider first...</option>
            </select>
          </div>

          <!-- Model preview -->
          <div id="model-preview" class="hidden rounded-lg bg-subtle/80 border border-dark/[0.08] px-4 py-3">
            <span class="text-xs text-muted">Selected model</span>
            <p id="model-preview-text" class="text-sm font-medium text-dark mt-0.5 font-mono"></p>
          </div>

          <!-- Divider -->
          <hr class="border-dark/[0.06]" />

          <!-- Temperature slider -->
          <div class="flex flex-col gap-1.5">
            <div class="flex items-center justify-between">
              <label for="model-temperature" class="text-sm font-medium text-dark">Temperature</label>
              <span id="temperature-value" class="text-sm font-mono text-muted tabular-nums">0.7</span>
            </div>
            <input
              type="range"
              id="model-temperature"
              name="temperature"
              min="0"
              max="2"
              step="0.1"
              value="0.7"
              class="w-full h-2 bg-dark/[0.08] rounded-lg appearance-none cursor-pointer accent-coral"
            />
            <div class="flex justify-between text-xs text-muted/60">
              <span>Precise (0.0)</span>
              <span>Creative (2.0)</span>
            </div>
          </div>

          <!-- Max tokens -->
          <div class="flex flex-col gap-1.5">
            <label for="model-max-tokens" class="text-sm font-medium text-dark">Max Tokens</label>
            <input
              type="number"
              id="model-max-tokens"
              name="max_tokens"
              min="1"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="Leave blank for model default"
            />
            <p class="text-xs text-muted">Maximum number of tokens the model can generate.</p>
          </div>
        </div>
      </div>

      <!-- Tools tab -->
      <div id="panel-tools" class="tab-panel hidden" role="tabpanel">
        <div class="flex flex-col gap-5">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-medium text-dark">Assigned Tools</h3>
              <p class="text-xs text-muted mt-0.5">Tools this agent can use. Drag to reorder priority.</p>
            </div>
            <button
              type="button"
              id="add-tool-btn"
              class="flex items-center gap-1.5 rounded-lg bg-dark text-paper px-3 py-1.5 text-xs font-medium hover:bg-dark/80 transition-colors cursor-pointer"
            >
              <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Tool
            </button>
          </div>

          <!-- Tool list (populated by JS) -->
          <div id="tools-list" class="flex flex-col gap-2">
            <!-- Empty state -->
            <div id="tools-empty" class="rounded-lg border border-dashed border-dark/[0.12] bg-subtle/50 py-8 text-center">
              <p class="text-sm text-muted">No tools assigned yet.</p>
              <p class="text-xs text-muted/60 mt-1">Click "Add Tool" to assign tools to this agent.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Handoffs tab -->
      <div id="panel-handoffs" class="tab-panel hidden" role="tabpanel">
        <div class="flex flex-col gap-5">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-medium text-dark">Handoff Targets</h3>
              <p class="text-xs text-muted mt-0.5">Other agents this agent can hand off tasks to.</p>
            </div>
            <button
              type="button"
              id="add-handoff-btn"
              class="flex items-center gap-1.5 rounded-lg bg-dark text-paper px-3 py-1.5 text-xs font-medium hover:bg-dark/80 transition-colors cursor-pointer"
            >
              <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Handoff
            </button>
          </div>

          <!-- Handoff list (populated by JS) -->
          <div id="handoffs-list" class="flex flex-col gap-2">
            <!-- Empty state -->
            <div id="handoffs-empty" class="rounded-lg border border-dashed border-dark/[0.12] bg-subtle/50 py-8 text-center">
              <p class="text-sm text-muted">No handoff targets configured.</p>
              <p class="text-xs text-muted/60 mt-1">Click "Add Handoff" to allow this agent to delegate to others.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Hooks tab -->
      <div id="panel-hooks" class="tab-panel hidden" role="tabpanel">
        <div class="flex flex-col gap-5">
          <div>
            <h3 class="text-sm font-medium text-dark">Lifecycle Hooks</h3>
            <p class="text-xs text-muted mt-0.5">Attach functions to agent lifecycle events. Each hook point runs before or after a specific stage.</p>
          </div>

          <!-- Hook points (populated by JS with initial structure) -->
          <div id="hooks-list" class="flex flex-col gap-3">
            <!-- before_model_call -->
            <div class="hook-row rounded-lg border border-dark/[0.08] bg-paper px-4 py-3" data-hook="before_model_call">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="flex h-6 w-6 items-center justify-center rounded bg-zen-blue/10 text-zen-blue">
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
                  </span>
                  <span class="text-sm font-medium text-dark">before_model_call</span>
                </div>
                <span class="text-[10px] font-medium text-muted uppercase tracking-wider">Pre-LLM</span>
              </div>
              <input
                type="text"
                data-hook-input="before_model_call"
                placeholder="Function name or module path (e.g. my_hooks.log_prompt)"
                class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 font-mono outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
              />
            </div>

            <!-- after_model_call -->
            <div class="hook-row rounded-lg border border-dark/[0.08] bg-paper px-4 py-3" data-hook="after_model_call">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="flex h-6 w-6 items-center justify-center rounded bg-zen-green/10 text-zen-green">
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
                  </span>
                  <span class="text-sm font-medium text-dark">after_model_call</span>
                </div>
                <span class="text-[10px] font-medium text-muted uppercase tracking-wider">Post-LLM</span>
              </div>
              <input
                type="text"
                data-hook-input="after_model_call"
                placeholder="Function name or module path (e.g. my_hooks.validate_output)"
                class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 font-mono outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
              />
            </div>

            <!-- before_tool_call -->
            <div class="hook-row rounded-lg border border-dark/[0.08] bg-paper px-4 py-3" data-hook="before_tool_call">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="flex h-6 w-6 items-center justify-center rounded bg-coral/10 text-coral">
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                  </span>
                  <span class="text-sm font-medium text-dark">before_tool_call</span>
                </div>
                <span class="text-[10px] font-medium text-muted uppercase tracking-wider">Pre-Tool</span>
              </div>
              <input
                type="text"
                data-hook-input="before_tool_call"
                placeholder="Function name or module path (e.g. my_hooks.authorize_tool)"
                class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 font-mono outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
              />
            </div>

            <!-- after_tool_call -->
            <div class="hook-row rounded-lg border border-dark/[0.08] bg-paper px-4 py-3" data-hook="after_tool_call">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="flex h-6 w-6 items-center justify-center rounded bg-coral/10 text-coral">
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                  </span>
                  <span class="text-sm font-medium text-dark">after_tool_call</span>
                </div>
                <span class="text-[10px] font-medium text-muted uppercase tracking-wider">Post-Tool</span>
              </div>
              <input
                type="text"
                data-hook-input="after_tool_call"
                placeholder="Function name or module path (e.g. my_hooks.log_tool_result)"
                class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 font-mono outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
              />
            </div>

            <!-- on_error -->
            <div class="hook-row rounded-lg border border-dark/[0.08] bg-paper px-4 py-3" data-hook="on_error">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="flex h-6 w-6 items-center justify-center rounded bg-coral/10 text-coral">
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                  </span>
                  <span class="text-sm font-medium text-dark">on_error</span>
                </div>
                <span class="text-[10px] font-medium text-muted uppercase tracking-wider">Error</span>
              </div>
              <input
                type="text"
                data-hook-input="on_error"
                placeholder="Function name or module path (e.g. my_hooks.handle_error)"
                class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 font-mono outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced tab -->
      <div id="panel-advanced" class="tab-panel hidden" role="tabpanel">
        <div class="flex flex-col gap-6">
          <!-- Max Steps -->
          <div class="flex flex-col gap-1.5">
            <div class="flex items-center justify-between">
              <label for="advanced-max-steps" class="text-sm font-medium text-dark">Max Steps</label>
              <span id="max-steps-value" class="text-sm font-mono text-muted tabular-nums">10</span>
            </div>
            <input
              type="range"
              id="advanced-max-steps"
              name="max_steps"
              min="1"
              max="100"
              step="1"
              value="10"
              class="w-full h-2 bg-dark/[0.08] rounded-lg appearance-none cursor-pointer accent-coral"
            />
            <div class="flex justify-between text-xs text-muted/60">
              <span>1 step</span>
              <span>100 steps</span>
            </div>
            <p class="text-xs text-muted">Maximum number of tool-call loops the agent can execute.</p>
          </div>

          <hr class="border-dark/[0.06]" />

          <!-- Output Type (JSON Schema) -->
          <div class="flex flex-col gap-1.5">
            <label for="advanced-output-type" class="text-sm font-medium text-dark">Output Type (JSON Schema)</label>
            <textarea
              id="advanced-output-type"
              name="output_type_json"
              rows="8"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-y font-mono text-sm leading-relaxed"
              placeholder='{"type": "object", "properties": {...}}'
            ></textarea>
            <p id="output-type-error" class="text-xs text-coral hidden">Invalid JSON. Please check your syntax.</p>
            <p class="text-xs text-muted">Define a JSON Schema for structured agent output. Leave as <code class="bg-subtle/80 px-1 py-0.5 rounded text-[11px]">{}</code> for free-form text.</p>
          </div>

          <hr class="border-dark/[0.06]" />

          <!-- Toggles -->
          <div class="flex flex-col gap-4">
            <!-- Memory toggle -->
            <div class="flex items-center justify-between rounded-lg border border-dark/[0.08] bg-paper px-4 py-3">
              <div>
                <p class="text-sm font-medium text-dark">Memory</p>
                <p class="text-xs text-muted mt-0.5">Enable persistent memory across conversations.</p>
              </div>
              <button
                type="button"
                id="toggle-memory"
                role="switch"
                aria-checked="false"
                class="relative h-6 w-11 rounded-full bg-dark/[0.12] transition-colors cursor-pointer"
              >
                <span class="toggle-dot absolute left-0.5 top-0.5 h-5 w-5 rounded-full bg-white shadow transition-transform"></span>
              </button>
            </div>

            <!-- Context toggle -->
            <div class="flex items-center justify-between rounded-lg border border-dark/[0.08] bg-paper px-4 py-3">
              <div>
                <p class="text-sm font-medium text-dark">Context Engine</p>
                <p class="text-xs text-muted mt-0.5">Enable the context engine for RAG and artifact management.</p>
              </div>
              <button
                type="button"
                id="toggle-context"
                role="switch"
                aria-checked="false"
                class="relative h-6 w-11 rounded-full bg-dark/[0.12] transition-colors cursor-pointer"
              >
                <span class="toggle-dot absolute left-0.5 top-0.5 h-5 w-5 rounded-full bg-white shadow transition-transform"></span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tool selector modal -->
  <Modal id="tool-selector-modal" title="Add Tool">
    <div class="flex flex-col gap-4">
      <input
        type="text"
        id="tool-search"
        placeholder="Search tools..."
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
      />
      <div id="tool-selector-list" class="flex flex-col gap-1 max-h-64 overflow-y-auto">
        <p class="text-sm text-muted text-center py-4">Loading tools...</p>
      </div>
    </div>
  </Modal>

  <!-- Save template modal -->
  <Modal id="save-template-modal" title="Save as Template">
    <div class="flex flex-col gap-4">
      <div class="flex flex-col gap-1.5">
        <label for="template-name-input" class="text-sm font-medium text-dark">Template Name</label>
        <input
          type="text"
          id="template-name-input"
          placeholder="My prompt template"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        />
      </div>
      <p class="text-xs text-muted">The current prompt content and variables will be saved.</p>
      <div class="flex items-center justify-end gap-2">
        <button type="button" data-modal-close class="rounded-lg px-3 py-1.5 text-sm text-muted hover:text-dark transition-colors cursor-pointer">Cancel</button>
        <button type="button" id="confirm-save-template" class="rounded-lg bg-dark text-paper px-4 py-1.5 text-sm font-medium hover:bg-dark/80 transition-colors cursor-pointer">Save Template</button>
      </div>
    </div>
  </Modal>

  <!-- Load template modal -->
  <Modal id="load-template-modal" title="Load Template">
    <div class="flex flex-col gap-4">
      <input
        type="text"
        id="template-search"
        placeholder="Search templates..."
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
      />
      <div id="template-list" class="flex flex-col gap-1 max-h-64 overflow-y-auto">
        <p class="text-sm text-muted text-center py-4">Loading templates...</p>
      </div>
    </div>
  </Modal>

  <!-- Handoff agent selector modal -->
  <Modal id="handoff-selector-modal" title="Add Handoff Target">
    <div class="flex flex-col gap-4">
      <input
        type="text"
        id="handoff-search"
        placeholder="Search agents..."
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
      />
      <div id="handoff-selector-list" class="flex flex-col gap-1 max-h-64 overflow-y-auto">
        <p class="text-sm text-muted text-center py-4">Loading agents...</p>
      </div>
    </div>
  </Modal>

  <!-- Model comparison selector modal -->
  <Modal id="compare-selector-modal" title="Compare Across Models">
    <div class="flex flex-col gap-4">
      <p class="text-xs text-muted">Select 2-3 models to compare. The same prompt will be sent to each model in parallel.</p>
      <div id="compare-model-slots" class="flex flex-col gap-3">
        <!-- Slot 1 -->
        <div class="compare-slot rounded-lg border border-dark/[0.08] bg-paper px-3 py-2.5" data-slot="0">
          <div class="flex items-center gap-2 mb-2">
            <span class="flex h-5 w-5 items-center justify-center rounded-full bg-coral/10 text-coral text-[10px] font-bold">1</span>
            <span class="text-xs font-medium text-dark">Model 1</span>
          </div>
          <div class="flex gap-2">
            <select data-compare-provider="0" class="flex-1 bg-subtle/50 border border-dark/[0.06] rounded-md px-2 py-1.5 text-xs text-dark outline-none focus:border-coral transition-all cursor-pointer">
              <option value="">Provider...</option>
            </select>
            <select data-compare-model="0" disabled class="flex-1 bg-subtle/50 border border-dark/[0.06] rounded-md px-2 py-1.5 text-xs text-dark outline-none focus:border-coral transition-all cursor-pointer disabled:opacity-50">
              <option value="">Model...</option>
            </select>
          </div>
        </div>
        <!-- Slot 2 -->
        <div class="compare-slot rounded-lg border border-dark/[0.08] bg-paper px-3 py-2.5" data-slot="1">
          <div class="flex items-center gap-2 mb-2">
            <span class="flex h-5 w-5 items-center justify-center rounded-full bg-zen-blue/10 text-zen-blue text-[10px] font-bold">2</span>
            <span class="text-xs font-medium text-dark">Model 2</span>
          </div>
          <div class="flex gap-2">
            <select data-compare-provider="1" class="flex-1 bg-subtle/50 border border-dark/[0.06] rounded-md px-2 py-1.5 text-xs text-dark outline-none focus:border-coral transition-all cursor-pointer">
              <option value="">Provider...</option>
            </select>
            <select data-compare-model="1" disabled class="flex-1 bg-subtle/50 border border-dark/[0.06] rounded-md px-2 py-1.5 text-xs text-dark outline-none focus:border-coral transition-all cursor-pointer disabled:opacity-50">
              <option value="">Model...</option>
            </select>
          </div>
        </div>
        <!-- Slot 3 (optional) -->
        <div class="compare-slot rounded-lg border border-dashed border-dark/[0.08] bg-paper px-3 py-2.5" data-slot="2">
          <div class="flex items-center gap-2 mb-2">
            <span class="flex h-5 w-5 items-center justify-center rounded-full bg-zen-green/10 text-zen-green text-[10px] font-bold">3</span>
            <span class="text-xs font-medium text-dark">Model 3 <span class="text-muted font-normal">(optional)</span></span>
          </div>
          <div class="flex gap-2">
            <select data-compare-provider="2" class="flex-1 bg-subtle/50 border border-dark/[0.06] rounded-md px-2 py-1.5 text-xs text-dark outline-none focus:border-coral transition-all cursor-pointer">
              <option value="">Provider...</option>
            </select>
            <select data-compare-model="2" disabled class="flex-1 bg-subtle/50 border border-dark/[0.06] rounded-md px-2 py-1.5 text-xs text-dark outline-none focus:border-coral transition-all cursor-pointer disabled:opacity-50">
              <option value="">Model...</option>
            </select>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-end gap-2">
        <button type="button" data-modal-close class="rounded-lg px-3 py-1.5 text-sm text-muted hover:text-dark transition-colors cursor-pointer">Cancel</button>
        <button type="button" id="confirm-compare" class="rounded-lg bg-zen-blue text-white px-4 py-1.5 text-sm font-medium hover:bg-zen-blue/80 transition-colors cursor-pointer">Compare</button>
      </div>
    </div>
  </Modal>

  <!-- Version history modal -->
  <Modal id="version-history-modal" title="Prompt Version History">
    <div class="flex flex-col gap-4">
      <div id="version-list" class="flex flex-col gap-1 max-h-72 overflow-y-auto">
        <p class="text-sm text-muted text-center py-4">Loading versions...</p>
      </div>
      <!-- Diff view area (hidden until two versions selected) -->
      <div id="diff-view" class="hidden">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-semibold text-dark uppercase tracking-wider">Diff View</span>
          <button type="button" id="close-diff-view" class="text-xs text-muted hover:text-dark transition-colors cursor-pointer">Close diff</button>
        </div>
        <div id="diff-content" class="rounded-lg border border-dark/[0.08] bg-paper overflow-hidden max-h-64 overflow-y-auto">
          <div class="flex">
            <div id="diff-left" class="flex-1 border-r border-dark/[0.06] p-3 text-xs font-mono leading-relaxed whitespace-pre-wrap"></div>
            <div id="diff-right" class="flex-1 p-3 text-xs font-mono leading-relaxed whitespace-pre-wrap"></div>
          </div>
        </div>
        <div class="flex items-center justify-between mt-1.5">
          <span id="diff-left-label" class="text-[10px] text-muted"></span>
          <span id="diff-right-label" class="text-[10px] text-muted"></span>
        </div>
      </div>
    </div>
  </Modal>

  <!-- Persona preview modal -->
  <Modal id="persona-preview-modal" title="System Prompt Preview">
    <div class="flex flex-col gap-3">
      <p class="text-xs text-muted">This is the full system prompt that will be sent to the model, including persona fields.</p>
      <div id="persona-preview-content" class="rounded-lg border border-dark/[0.08] bg-subtle/50 p-4 text-sm text-dark whitespace-pre-wrap font-mono leading-relaxed max-h-96 overflow-y-auto"></div>
    </div>
  </Modal>
</PageLayout>

<style>
  .prompt-variable {
    color: #F76F53;
    background: rgba(247, 111, 83, 0.08);
    border-radius: 3px;
    padding: 0 2px;
  }
  #compare-result-content > div:last-child {
    border-right: none !important;
  }
</style>

<script is:inline define:vars={{ agentId: id }}>
  (function () {
    var loadingState = document.getElementById("loading-state");
    var errorState = document.getElementById("error-state");
    var editorContent = document.getElementById("editor-content");

    var agentNameHeading = document.getElementById("agent-name-heading");
    var saveBtn = document.getElementById("save-btn");
    var saveStatus = document.getElementById("save-status");

    /* Basic tab fields */
    var nameInput = document.getElementById("agent-name");
    var nameError = document.getElementById("name-error");
    var descriptionInput = document.getElementById("agent-description");
    var instructionsInput = document.getElementById("agent-instructions");
    var instructionsBackdrop = document.getElementById("instructions-backdrop");
    var tokenCountValue = document.getElementById("token-count-value");
    var variablesPanel = document.getElementById("variables-panel");
    var variablesList = document.getElementById("variables-list");
    var variableCount = document.getElementById("variable-count");

    /* Persona fields */
    var personaToggle = document.getElementById("persona-toggle");
    var personaContent = document.getElementById("persona-content");
    var personaChevron = document.getElementById("persona-chevron");
    var personaBadge = document.getElementById("persona-badge");
    var personaTemplate = document.getElementById("persona-template");
    var personaRole = document.getElementById("persona-role");
    var personaGoal = document.getElementById("persona-goal");
    var personaBackstory = document.getElementById("persona-backstory");
    var personaPreviewBtn = document.getElementById("persona-preview-btn");
    var personaPreviewModal = document.getElementById("persona-preview-modal");
    var personaPreviewContent = document.getElementById("persona-preview-content");

    /* Model tab fields */
    var providerSelect = document.getElementById("model-provider");
    var modelSelect = document.getElementById("model-name");
    var modelPreview = document.getElementById("model-preview");
    var modelPreviewText = document.getElementById("model-preview-text");
    var temperatureSlider = document.getElementById("model-temperature");
    var temperatureValue = document.getElementById("temperature-value");
    var maxTokensInput = document.getElementById("model-max-tokens");

    /* Tools tab */
    var toolsList = document.getElementById("tools-list");
    var toolsEmpty = document.getElementById("tools-empty");
    var addToolBtn = document.getElementById("add-tool-btn");
    var toolSelectorModal = document.getElementById("tool-selector-modal");
    var toolSelectorList = document.getElementById("tool-selector-list");
    var toolSearch = document.getElementById("tool-search");

    /* Handoffs tab */
    var handoffsList = document.getElementById("handoffs-list");
    var handoffsEmpty = document.getElementById("handoffs-empty");
    var addHandoffBtn = document.getElementById("add-handoff-btn");
    var handoffSelectorModal = document.getElementById("handoff-selector-modal");
    var handoffSelectorList = document.getElementById("handoff-selector-list");
    var handoffSearch = document.getElementById("handoff-search");

    /* Hooks tab */
    var hookPoints = ["before_model_call", "after_model_call", "before_tool_call", "after_tool_call", "on_error"];

    /* Advanced tab */
    var maxStepsSlider = document.getElementById("advanced-max-steps");
    var maxStepsValue = document.getElementById("max-steps-value");
    var outputTypeTextarea = document.getElementById("advanced-output-type");
    var outputTypeError = document.getElementById("output-type-error");
    var toggleMemory = document.getElementById("toggle-memory");
    var toggleContext = document.getElementById("toggle-context");

    /* Toggle state */
    var memoryEnabled = false;
    var contextEnabled = false;

    var currentAgent = null;
    var allProviders = [];
    var allModels = [];

    /* State: assigned tools as array of {id, name, description, category} */
    var assignedTools = [];
    /* State: handoff targets as array of {id, name, description} */
    var assignedHandoffs = [];
    /* Cached data from API */
    var availableTools = [];
    var projectAgents = [];

    /* Drag state */
    var dragIndex = null;

    /* ------------------------------------------------------------------ */
    /* Tab switching                                                       */
    /* ------------------------------------------------------------------ */
    var tabButtons = document.querySelectorAll(".tab-btn");
    var tabPanels = document.querySelectorAll(".tab-panel");

    tabButtons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        var tabId = btn.getAttribute("data-tab");

        tabButtons.forEach(function (b) {
          b.classList.remove("text-dark", "border-coral");
          b.classList.add("text-muted", "border-transparent");
          b.setAttribute("aria-selected", "false");
        });
        btn.classList.remove("text-muted", "border-transparent");
        btn.classList.add("text-dark", "border-coral");
        btn.setAttribute("aria-selected", "true");

        tabPanels.forEach(function (p) {
          p.classList.add("hidden");
        });
        var panel = document.getElementById("panel-" + tabId);
        if (panel) panel.classList.remove("hidden");
      });
    });

    /* ------------------------------------------------------------------ */
    /* Instructions editor: highlighting, variables, token counter         */
    /* ------------------------------------------------------------------ */

    /* Variable state: {name: {type: "string", defaultValue: ""}} */
    var detectedVariables = {};

    function escapeHtml(text) {
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function highlightInstructions() {
      var text = instructionsInput.value;
      /* Build highlighted HTML  color {{variable}} patterns */
      var html = escapeHtml(text).replace(
        /\{\{(\w+)\}\}/g,
        '<span class="prompt-variable">{{$1}}</span>'
      );
      /* Add a trailing newline so the backdrop height matches the textarea */
      instructionsBackdrop.innerHTML = html + "\n";
    }

    function syncBackdropScroll() {
      instructionsBackdrop.scrollTop = instructionsInput.scrollTop;
      instructionsBackdrop.scrollLeft = instructionsInput.scrollLeft;
    }

    function extractVariables(text) {
      var matches = text.match(/\{\{(\w+)\}\}/g);
      if (!matches) return [];
      var seen = {};
      var names = [];
      matches.forEach(function (m) {
        var name = m.slice(2, -2);
        if (!seen[name]) {
          seen[name] = true;
          names.push(name);
        }
      });
      return names;
    }

    function estimateTokens(text) {
      /* Rough estimate: ~4 chars per token for English text */
      if (!text || !text.trim()) return 0;
      return Math.ceil(text.length / 4);
    }

    function updateTokenCounter() {
      var count = estimateTokens(instructionsInput.value);
      tokenCountValue.textContent = "~" + count.toLocaleString() + " tokens";
    }

    function renderVariablesPanel() {
      var names = extractVariables(instructionsInput.value);

      if (names.length === 0) {
        variablesPanel.classList.add("hidden");
        variableCount.textContent = "0";
        variablesList.innerHTML =
          '<div class="px-3 py-4 text-center">' +
            '<p class="text-xs text-muted">No variables detected.</p>' +
            '<p class="text-[11px] text-muted/60 mt-0.5">Use {{name}} syntax in your prompt.</p>' +
          '</div>';
        return;
      }

      variablesPanel.classList.remove("hidden");
      variableCount.textContent = names.length;

      /* Preserve existing variable configs */
      var prev = detectedVariables;
      detectedVariables = {};
      names.forEach(function (name) {
        detectedVariables[name] = prev[name] || { type: "string", defaultValue: "" };
      });

      variablesList.innerHTML = "";
      names.forEach(function (name) {
        var v = detectedVariables[name];
        var item = document.createElement("div");
        item.className = "px-3 py-2.5 flex flex-col gap-1.5";
        item.innerHTML =
          '<div class="flex items-center gap-1.5">' +
            '<span class="flex h-5 w-5 items-center justify-center rounded bg-coral/10 text-coral text-[10px] font-bold">x</span>' +
            '<span class="text-xs font-medium text-dark font-mono truncate">' + escapeHtml(name) + '</span>' +
          '</div>' +
          '<select data-var-type="' + escapeHtml(name) + '" class="w-full bg-subtle/50 border border-dark/[0.06] rounded px-2 py-1 text-[11px] text-dark outline-none focus:border-coral transition-all cursor-pointer">' +
            '<option value="string"' + (v.type === "string" ? " selected" : "") + '>String</option>' +
            '<option value="number"' + (v.type === "number" ? " selected" : "") + '>Number</option>' +
            '<option value="boolean"' + (v.type === "boolean" ? " selected" : "") + '>Boolean</option>' +
          '</select>' +
          '<input type="text" data-var-default="' + escapeHtml(name) + '" value="' + escapeHtml(v.defaultValue) + '" placeholder="Default value" class="w-full bg-subtle/50 border border-dark/[0.06] rounded px-2 py-1 text-[11px] text-dark placeholder:text-muted/50 outline-none focus:border-coral transition-all" />';
        variablesList.appendChild(item);
      });

      /* Attach change listeners for type and default value */
      variablesList.querySelectorAll("[data-var-type]").forEach(function (sel) {
        sel.addEventListener("change", function () {
          var n = sel.getAttribute("data-var-type");
          if (detectedVariables[n]) detectedVariables[n].type = sel.value;
        });
      });
      variablesList.querySelectorAll("[data-var-default]").forEach(function (inp) {
        inp.addEventListener("input", function () {
          var n = inp.getAttribute("data-var-default");
          if (detectedVariables[n]) detectedVariables[n].defaultValue = inp.value;
        });
      });
    }

    var instructionsUpdateTimer = null;
    function onInstructionsChange() {
      highlightInstructions();
      updateTokenCounter();
      /* Debounce variable panel update */
      clearTimeout(instructionsUpdateTimer);
      instructionsUpdateTimer = setTimeout(renderVariablesPanel, 200);
    }

    if (instructionsInput) {
      instructionsInput.addEventListener("input", onInstructionsChange);
      instructionsInput.addEventListener("scroll", syncBackdropScroll);
      /* Handle resize  keep backdrop in sync */
      var resizeObserver = new ResizeObserver(function () {
        instructionsBackdrop.style.height = instructionsInput.offsetHeight + "px";
      });
      resizeObserver.observe(instructionsInput);
    }

    /* ------------------------------------------------------------------ */
    /* Persona section                                                     */
    /* ------------------------------------------------------------------ */

    var personaTemplates = {
      researcher: {
        role: "Senior Research Analyst",
        goal: "Provide accurate, well-researched analysis with citations and evidence-based conclusions",
        backstory: "You are an experienced research analyst with decades of expertise in data analysis, academic research, and investigative journalism. You approach every question with intellectual rigor, always seeking primary sources and cross-referencing claims before presenting findings."
      },
      writer: {
        role: "Creative Content Writer",
        goal: "Produce engaging, well-structured content that informs and captivates the audience",
        backstory: "You are a seasoned writer with experience across journalism, copywriting, and technical documentation. You have a keen eye for narrative flow, clarity, and audience engagement. You adapt your tone and style to match the context while maintaining authenticity."
      },
      coder: {
        role: "Senior Software Engineer",
        goal: "Write clean, efficient, well-tested code following best practices and modern patterns",
        backstory: "You are a principal engineer with deep expertise across multiple programming languages and frameworks. You prioritize code readability, maintainability, and performance. You follow SOLID principles, write comprehensive tests, and always consider edge cases."
      },
      reviewer: {
        role: "Quality Assurance Reviewer",
        goal: "Identify issues, suggest improvements, and ensure output meets high quality standards",
        backstory: "You are a meticulous reviewer with expertise in code review, content editing, and quality assurance. You have a sharp eye for errors, inconsistencies, and areas for improvement. You provide constructive, actionable feedback while acknowledging what works well."
      },
      planner: {
        role: "Strategic Project Planner",
        goal: "Create comprehensive, actionable plans with clear milestones and risk mitigation strategies",
        backstory: "You are an experienced project manager and strategic planner. You excel at breaking complex goals into manageable tasks, identifying dependencies and risks, and creating realistic timelines. You balance ambition with pragmatism and always account for contingencies."
      }
    };

    /* Collapse/expand toggle */
    if (personaToggle) {
      personaToggle.addEventListener("click", function () {
        var isHidden = personaContent.classList.contains("hidden");
        if (isHidden) {
          personaContent.classList.remove("hidden");
          personaChevron.style.transform = "rotate(180deg)";
        } else {
          personaContent.classList.add("hidden");
          personaChevron.style.transform = "";
        }
      });
    }

    function updatePersonaBadge() {
      var hasPersona = personaRole.value.trim() || personaGoal.value.trim() || personaBackstory.value.trim();
      if (hasPersona) {
        personaBadge.classList.remove("hidden");
      } else {
        personaBadge.classList.add("hidden");
      }
    }

    if (personaRole) personaRole.addEventListener("input", updatePersonaBadge);
    if (personaGoal) personaGoal.addEventListener("input", updatePersonaBadge);
    if (personaBackstory) personaBackstory.addEventListener("input", updatePersonaBadge);

    /* Template pre-fill */
    if (personaTemplate) {
      personaTemplate.addEventListener("change", function () {
        var key = personaTemplate.value;
        if (key && personaTemplates[key]) {
          var t = personaTemplates[key];
          personaRole.value = t.role;
          personaGoal.value = t.goal;
          personaBackstory.value = t.backstory;
          updatePersonaBadge();
        }
      });
    }

    /* Build the full system prompt with persona injected */
    function buildFullPromptWithPersona() {
      var role = personaRole.value.trim();
      var goal = personaGoal.value.trim();
      var backstory = personaBackstory.value.trim();
      var instructions = instructionsInput.value;

      var parts = [];

      if (role || goal || backstory) {
        parts.push("## Persona");
        if (role) parts.push("**Role:** " + role);
        if (goal) parts.push("**Goal:** " + goal);
        if (backstory) parts.push("**Backstory:** " + backstory);
        parts.push("");
      }

      if (instructions.trim()) {
        parts.push("## Instructions");
        parts.push(instructions);
      }

      return parts.join("\n");
    }

    /* Preview button */
    if (personaPreviewBtn && personaPreviewModal) {
      personaPreviewBtn.addEventListener("click", function () {
        var fullPrompt = buildFullPromptWithPersona();
        personaPreviewContent.textContent = fullPrompt || "(Empty  no persona or instructions set)";
        personaPreviewModal.showModal();
      });
    }

    /* ------------------------------------------------------------------ */
    /* Temperature slider                                                  */
    /* ------------------------------------------------------------------ */
    if (temperatureSlider) {
      temperatureSlider.addEventListener("input", function () {
        temperatureValue.textContent = parseFloat(temperatureSlider.value).toFixed(1);
      });
    }

    /* ------------------------------------------------------------------ */
    /* Max Steps slider                                                    */
    /* ------------------------------------------------------------------ */
    if (maxStepsSlider) {
      maxStepsSlider.addEventListener("input", function () {
        maxStepsValue.textContent = maxStepsSlider.value;
      });
    }

    /* ------------------------------------------------------------------ */
    /* Output type JSON validation                                         */
    /* ------------------------------------------------------------------ */
    if (outputTypeTextarea) {
      outputTypeTextarea.addEventListener("blur", function () {
        validateOutputTypeJson();
      });
    }

    function validateOutputTypeJson() {
      var val = outputTypeTextarea.value.trim();
      if (!val || val === "{}") {
        outputTypeError.classList.add("hidden");
        outputTypeTextarea.classList.remove("border-coral");
        return true;
      }
      try {
        JSON.parse(val);
        outputTypeError.classList.add("hidden");
        outputTypeTextarea.classList.remove("border-coral");
        return true;
      } catch (e) {
        outputTypeError.classList.remove("hidden");
        outputTypeTextarea.classList.add("border-coral");
        return false;
      }
    }

    /* ------------------------------------------------------------------ */
    /* Toggle switches                                                     */
    /* ------------------------------------------------------------------ */
    function setToggle(btn, on) {
      var dot = btn.querySelector(".toggle-dot");
      if (on) {
        btn.classList.remove("bg-dark/[0.12]");
        btn.classList.add("bg-coral");
        btn.setAttribute("aria-checked", "true");
        dot.classList.add("translate-x-5");
      } else {
        btn.classList.remove("bg-coral");
        btn.classList.add("bg-dark/[0.12]");
        btn.setAttribute("aria-checked", "false");
        dot.classList.remove("translate-x-5");
      }
    }

    if (toggleMemory) {
      toggleMemory.addEventListener("click", function () {
        memoryEnabled = !memoryEnabled;
        setToggle(toggleMemory, memoryEnabled);
      });
    }
    if (toggleContext) {
      toggleContext.addEventListener("click", function () {
        contextEnabled = !contextEnabled;
        setToggle(toggleContext, contextEnabled);
      });
    }

    /* ------------------------------------------------------------------ */
    /* Provider / Model selectors                                          */
    /* ------------------------------------------------------------------ */
    function updateModelPreview() {
      var provider = providerSelect.value;
      var model = modelSelect.value;

      if (provider && model) {
        modelPreview.classList.remove("hidden");
        var provName = provider;
        for (var i = 0; i < allProviders.length; i++) {
          if (allProviders[i].id === provider) {
            provName = allProviders[i].name || allProviders[i].provider_type;
            break;
          }
        }
        modelPreviewText.textContent = provName + ":" + model;
      } else {
        modelPreview.classList.add("hidden");
      }
    }

    function populateModels(providerId, selectedModelName) {
      if (!providerId) {
        modelSelect.innerHTML = '<option value="">Select a provider first...</option>';
        modelSelect.disabled = true;
        updateModelPreview();
        return;
      }

      modelSelect.innerHTML = '<option value="">Loading models...</option>';
      modelSelect.disabled = true;

      fetch("/api/models?provider_id=" + encodeURIComponent(providerId))
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (models) {
          allModels = models;
          modelSelect.innerHTML = '<option value="">Select a model...</option>';
          models.forEach(function (m) {
            var opt = document.createElement("option");
            opt.value = m.model_name;
            opt.textContent = m.model_name;
            modelSelect.appendChild(opt);
          });
          modelSelect.disabled = false;
          if (selectedModelName) {
            modelSelect.value = selectedModelName;
          }
          updateModelPreview();
        })
        .catch(function () {
          modelSelect.innerHTML = '<option value="">Failed to load models</option>';
          modelSelect.disabled = true;
        });
    }

    if (providerSelect) {
      providerSelect.addEventListener("change", function () {
        populateModels(providerSelect.value, "");
      });
    }

    if (modelSelect) {
      modelSelect.addEventListener("change", updateModelPreview);
    }

    /* ------------------------------------------------------------------ */
    /* Tools management                                                    */
    /* ------------------------------------------------------------------ */
    var categoryIcons = {
      retrieval: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
      filesystem: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>',
      execution: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
      data: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
      utility: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>'
    };

    function renderToolsList() {
      /* Clear everything except the empty state */
      var items = toolsList.querySelectorAll(".tool-item");
      items.forEach(function (el) { el.remove(); });

      if (assignedTools.length === 0) {
        toolsEmpty.classList.remove("hidden");
        return;
      }
      toolsEmpty.classList.add("hidden");

      assignedTools.forEach(function (tool, idx) {
        var row = document.createElement("div");
        row.className = "tool-item flex items-center gap-3 rounded-lg border border-dark/[0.08] bg-paper px-3 py-2.5 group transition-colors hover:border-dark/[0.15]";
        row.setAttribute("draggable", "true");
        row.setAttribute("data-tool-index", idx);

        var icon = categoryIcons[tool.category] || categoryIcons.utility;
        row.innerHTML =
          '<span class="cursor-grab text-muted/40 hover:text-muted transition-colors" title="Drag to reorder">' +
            '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="8" y2="6.01"/><line x1="16" y1="6" x2="16" y2="6.01"/><line x1="8" y1="12" x2="8" y2="12.01"/><line x1="16" y1="12" x2="16" y2="12.01"/><line x1="8" y1="18" x2="8" y2="18.01"/><line x1="16" y1="18" x2="16" y2="18.01"/></svg>' +
          '</span>' +
          '<span class="text-muted">' + icon + '</span>' +
          '<div class="flex-1 min-w-0">' +
            '<p class="text-sm font-medium text-dark">' + tool.name + '</p>' +
            '<p class="text-xs text-muted truncate">' + tool.description + '</p>' +
          '</div>' +
          '<span class="rounded-full bg-subtle px-2 py-0.5 text-[10px] font-medium text-muted uppercase tracking-wider">' + tool.category + '</span>' +
          '<button type="button" class="remove-tool-btn flex h-7 w-7 items-center justify-center rounded-md text-muted/40 hover:bg-coral/10 hover:text-coral transition-colors opacity-0 group-hover:opacity-100 cursor-pointer" title="Remove tool" data-tool-index="' + idx + '">' +
            '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
          '</button>';

        toolsList.appendChild(row);

        /* Drag events */
        row.addEventListener("dragstart", function (e) {
          dragIndex = idx;
          row.classList.add("opacity-50");
          e.dataTransfer.effectAllowed = "move";
        });
        row.addEventListener("dragend", function () {
          row.classList.remove("opacity-50");
          dragIndex = null;
          /* Remove all drag-over highlights */
          toolsList.querySelectorAll(".tool-item").forEach(function (el) {
            el.classList.remove("border-coral");
          });
        });
        row.addEventListener("dragover", function (e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
          row.classList.add("border-coral");
        });
        row.addEventListener("dragleave", function () {
          row.classList.remove("border-coral");
        });
        row.addEventListener("drop", function (e) {
          e.preventDefault();
          row.classList.remove("border-coral");
          var dropIdx = parseInt(row.getAttribute("data-tool-index"), 10);
          if (dragIndex !== null && dragIndex !== dropIdx) {
            var moved = assignedTools.splice(dragIndex, 1)[0];
            assignedTools.splice(dropIdx, 0, moved);
            renderToolsList();
          }
        });
      });

      /* Remove buttons */
      toolsList.querySelectorAll(".remove-tool-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          var idx = parseInt(btn.getAttribute("data-tool-index"), 10);
          assignedTools.splice(idx, 1);
          renderToolsList();
        });
      });
    }

    /* Fetch available tools and open modal */
    function openToolSelector() {
      toolSelectorModal.showModal();
      toolSearch.value = "";

      if (availableTools.length > 0) {
        renderToolSelectorItems("");
        return;
      }

      toolSelectorList.innerHTML = '<p class="text-sm text-muted text-center py-4">Loading tools...</p>';
      fetch("/api/tools")
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (tools) {
          availableTools = tools;
          renderToolSelectorItems("");
        })
        .catch(function () {
          toolSelectorList.innerHTML = '<p class="text-sm text-coral text-center py-4">Failed to load tools.</p>';
        });
    }

    function renderToolSelectorItems(query) {
      var q = query.toLowerCase();
      toolSelectorList.innerHTML = "";

      var filtered = availableTools.filter(function (t) {
        /* Exclude already-assigned tools */
        for (var i = 0; i < assignedTools.length; i++) {
          if (assignedTools[i].id === t.id) return false;
        }
        if (!q) return true;
        return t.name.toLowerCase().indexOf(q) !== -1 ||
               t.description.toLowerCase().indexOf(q) !== -1 ||
               t.category.toLowerCase().indexOf(q) !== -1;
      });

      if (filtered.length === 0) {
        toolSelectorList.innerHTML = '<p class="text-sm text-muted text-center py-4">No matching tools available.</p>';
        return;
      }

      filtered.forEach(function (tool) {
        var icon = categoryIcons[tool.category] || categoryIcons.utility;
        var item = document.createElement("button");
        item.type = "button";
        item.className = "flex items-center gap-3 w-full rounded-lg px-3 py-2.5 text-left hover:bg-subtle/80 transition-colors cursor-pointer";
        item.innerHTML =
          '<span class="text-muted">' + icon + '</span>' +
          '<div class="flex-1 min-w-0">' +
            '<p class="text-sm font-medium text-dark">' + tool.name + '</p>' +
            '<p class="text-xs text-muted truncate">' + tool.description + '</p>' +
          '</div>' +
          '<span class="rounded-full bg-subtle px-2 py-0.5 text-[10px] font-medium text-muted uppercase tracking-wider">' + tool.category + '</span>';

        item.addEventListener("click", function () {
          assignedTools.push({ id: tool.id, name: tool.name, description: tool.description, category: tool.category });
          renderToolsList();
          toolSelectorModal.close();
        });

        toolSelectorList.appendChild(item);
      });
    }

    if (addToolBtn) {
      addToolBtn.addEventListener("click", openToolSelector);
    }
    if (toolSearch) {
      toolSearch.addEventListener("input", function () {
        renderToolSelectorItems(toolSearch.value);
      });
    }

    /* ------------------------------------------------------------------ */
    /* Handoffs management                                                 */
    /* ------------------------------------------------------------------ */
    function renderHandoffsList() {
      var items = handoffsList.querySelectorAll(".handoff-item");
      items.forEach(function (el) { el.remove(); });

      if (assignedHandoffs.length === 0) {
        handoffsEmpty.classList.remove("hidden");
        return;
      }
      handoffsEmpty.classList.add("hidden");

      assignedHandoffs.forEach(function (agent, idx) {
        var row = document.createElement("div");
        row.className = "handoff-item flex items-center gap-3 rounded-lg border border-dark/[0.08] bg-paper px-3 py-2.5 group transition-colors hover:border-dark/[0.15]";
        row.innerHTML =
          '<span class="flex h-8 w-8 items-center justify-center rounded-full bg-zen-blue/10 text-zen-blue text-xs font-semibold">' +
            (agent.name ? agent.name.charAt(0).toUpperCase() : "A") +
          '</span>' +
          '<div class="flex-1 min-w-0">' +
            '<p class="text-sm font-medium text-dark">' + agent.name + '</p>' +
            '<p class="text-xs text-muted truncate">' + (agent.description || "No description") + '</p>' +
          '</div>' +
          '<button type="button" class="remove-handoff-btn flex h-7 w-7 items-center justify-center rounded-md text-muted/40 hover:bg-coral/10 hover:text-coral transition-colors opacity-0 group-hover:opacity-100 cursor-pointer" title="Remove handoff" data-handoff-index="' + idx + '">' +
            '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
          '</button>';

        handoffsList.appendChild(row);
      });

      handoffsList.querySelectorAll(".remove-handoff-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          var idx = parseInt(btn.getAttribute("data-handoff-index"), 10);
          assignedHandoffs.splice(idx, 1);
          renderHandoffsList();
        });
      });
    }

    function openHandoffSelector() {
      handoffSelectorModal.showModal();
      handoffSearch.value = "";

      if (projectAgents.length > 0) {
        renderHandoffSelectorItems("");
        return;
      }

      handoffSelectorList.innerHTML = '<p class="text-sm text-muted text-center py-4">Loading agents...</p>';
      var projectId = currentAgent ? currentAgent.project_id : "";
      var url = projectId ? "/api/agents?project_id=" + encodeURIComponent(projectId) : "/api/agents";
      fetch(url)
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (agents) {
          projectAgents = agents;
          renderHandoffSelectorItems("");
        })
        .catch(function () {
          handoffSelectorList.innerHTML = '<p class="text-sm text-coral text-center py-4">Failed to load agents.</p>';
        });
    }

    function renderHandoffSelectorItems(query) {
      var q = query.toLowerCase();
      handoffSelectorList.innerHTML = "";

      var filtered = projectAgents.filter(function (a) {
        /* Exclude self */
        if (a.id === agentId) return false;
        /* Exclude already-assigned handoffs */
        for (var i = 0; i < assignedHandoffs.length; i++) {
          if (assignedHandoffs[i].id === a.id) return false;
        }
        if (!q) return true;
        return a.name.toLowerCase().indexOf(q) !== -1 ||
               (a.description || "").toLowerCase().indexOf(q) !== -1;
      });

      if (filtered.length === 0) {
        handoffSelectorList.innerHTML = '<p class="text-sm text-muted text-center py-4">No matching agents available.</p>';
        return;
      }

      filtered.forEach(function (agent) {
        var item = document.createElement("button");
        item.type = "button";
        item.className = "flex items-center gap-3 w-full rounded-lg px-3 py-2.5 text-left hover:bg-subtle/80 transition-colors cursor-pointer";
        item.innerHTML =
          '<span class="flex h-8 w-8 items-center justify-center rounded-full bg-zen-blue/10 text-zen-blue text-xs font-semibold">' +
            (agent.name ? agent.name.charAt(0).toUpperCase() : "A") +
          '</span>' +
          '<div class="flex-1 min-w-0">' +
            '<p class="text-sm font-medium text-dark">' + agent.name + '</p>' +
            '<p class="text-xs text-muted truncate">' + (agent.description || "No description") + '</p>' +
          '</div>';

        item.addEventListener("click", function () {
          assignedHandoffs.push({ id: agent.id, name: agent.name, description: agent.description || "" });
          renderHandoffsList();
          handoffSelectorModal.close();
        });

        handoffSelectorList.appendChild(item);
      });
    }

    if (addHandoffBtn) {
      addHandoffBtn.addEventListener("click", openHandoffSelector);
    }
    if (handoffSearch) {
      handoffSearch.addEventListener("input", function () {
        renderHandoffSelectorItems(handoffSearch.value);
      });
    }

    /* ------------------------------------------------------------------ */
    /* Prompt Templates                                                    */
    /* ------------------------------------------------------------------ */
    var saveTemplateBtn = document.getElementById("save-template-btn");
    var loadTemplateBtn = document.getElementById("load-template-btn");
    var saveTemplateModal = document.getElementById("save-template-modal");
    var loadTemplateModal = document.getElementById("load-template-modal");
    var templateNameInput = document.getElementById("template-name-input");
    var confirmSaveTemplate = document.getElementById("confirm-save-template");
    var templateSearch = document.getElementById("template-search");
    var templateList = document.getElementById("template-list");

    var cachedTemplates = [];

    if (saveTemplateBtn) {
      saveTemplateBtn.addEventListener("click", function () {
        templateNameInput.value = "";
        saveTemplateModal.showModal();
        templateNameInput.focus();
      });
    }

    if (confirmSaveTemplate) {
      confirmSaveTemplate.addEventListener("click", function () {
        var name = templateNameInput.value.trim();
        if (!name) {
          templateNameInput.classList.add("border-coral");
          return;
        }
        templateNameInput.classList.remove("border-coral");

        confirmSaveTemplate.disabled = true;
        confirmSaveTemplate.textContent = "Saving...";

        fetch("/api/prompt-templates", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: name,
            content: instructionsInput.value,
            variables_json: JSON.stringify(detectedVariables),
          }),
        })
          .then(function (res) {
            if (!res.ok) throw new Error("Failed to save template");
            return res.json();
          })
          .then(function (tpl) {
            cachedTemplates = []; /* invalidate cache */
            currentTemplateId = tpl.id; /* track for version history */
            saveTemplateModal.close();
          })
          .catch(function (err) {
            alert(err.message);
          })
          .finally(function () {
            confirmSaveTemplate.disabled = false;
            confirmSaveTemplate.textContent = "Save Template";
          });
      });
    }

    if (loadTemplateBtn) {
      loadTemplateBtn.addEventListener("click", function () {
        loadTemplateModal.showModal();
        templateSearch.value = "";
        fetchTemplates();
      });
    }

    function fetchTemplates() {
      templateList.innerHTML = '<p class="text-sm text-muted text-center py-4">Loading templates...</p>';
      fetch("/api/prompt-templates")
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (templates) {
          cachedTemplates = templates;
          renderTemplateList("");
        })
        .catch(function () {
          templateList.innerHTML = '<p class="text-sm text-coral text-center py-4">Failed to load templates.</p>';
        });
    }

    function renderTemplateList(query) {
      var q = query.toLowerCase();
      templateList.innerHTML = "";

      var filtered = cachedTemplates.filter(function (t) {
        if (!q) return true;
        return t.name.toLowerCase().indexOf(q) !== -1 ||
               t.content.toLowerCase().indexOf(q) !== -1;
      });

      if (filtered.length === 0) {
        templateList.innerHTML = '<p class="text-sm text-muted text-center py-4">No templates found.</p>';
        return;
      }

      filtered.forEach(function (tpl) {
        var item = document.createElement("div");
        item.className = "flex items-center gap-3 rounded-lg px-3 py-2.5 hover:bg-subtle/80 transition-colors group";

        var preview = tpl.content.length > 80 ? tpl.content.substring(0, 80) + "..." : tpl.content;

        item.innerHTML =
          '<div class="flex-1 min-w-0 cursor-pointer" data-tpl-load>' +
            '<p class="text-sm font-medium text-dark">' + escapeHtml(tpl.name) + '</p>' +
            '<p class="text-xs text-muted truncate font-mono">' + escapeHtml(preview) + '</p>' +
          '</div>' +
          '<button type="button" class="tpl-delete-btn flex h-6 w-6 items-center justify-center rounded text-muted/40 hover:bg-coral/10 hover:text-coral transition-colors opacity-0 group-hover:opacity-100 cursor-pointer" title="Delete template" data-tpl-id="' + tpl.id + '">' +
            '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>' +
          '</button>';

        /* Load template on click */
        item.querySelector("[data-tpl-load]").addEventListener("click", function () {
          instructionsInput.value = tpl.content;
          currentTemplateId = tpl.id; /* track for version history */
          /* Restore variables if available */
          try {
            var vars = JSON.parse(tpl.variables_json || "{}");
            if (vars && typeof vars === "object") {
              detectedVariables = vars;
            }
          } catch (e) { /* ignore */ }
          onInstructionsChange();
          renderVariablesPanel();
          loadTemplateModal.close();
        });

        /* Delete template */
        item.querySelector(".tpl-delete-btn").addEventListener("click", function (e) {
          e.stopPropagation();
          var tplId = this.getAttribute("data-tpl-id");
          if (!confirm("Delete this template?")) return;
          fetch("/api/prompt-templates/" + tplId, { method: "DELETE" })
            .then(function () {
              cachedTemplates = cachedTemplates.filter(function (t) { return t.id !== tplId; });
              renderTemplateList(templateSearch.value);
            })
            .catch(function () { /* ignore */ });
        });

        templateList.appendChild(item);
      });
    }

    if (templateSearch) {
      templateSearch.addEventListener("input", function () {
        renderTemplateList(templateSearch.value);
      });
    }

    /* ------------------------------------------------------------------ */
    /* Test Prompt                                                          */
    /* ------------------------------------------------------------------ */
    var testPromptBtn = document.getElementById("test-prompt-btn");
    var testResultPanel = document.getElementById("test-result-panel");
    var testResultModel = document.getElementById("test-result-model");
    var testResultMeta = document.getElementById("test-result-meta");
    var testResultContent = document.getElementById("test-result-content");
    var closeTestResult = document.getElementById("close-test-result");

    if (closeTestResult) {
      closeTestResult.addEventListener("click", function () {
        testResultPanel.classList.add("hidden");
      });
    }

    if (testPromptBtn) {
      testPromptBtn.addEventListener("click", function () {
        var prompt = instructionsInput.value.trim();
        if (!prompt) return;

        var provId = providerSelect.value;
        var modelName = modelSelect.value;

        if (!provId || !modelName) {
          /* Show result panel with error */
          testResultPanel.classList.remove("hidden");
          testResultModel.textContent = "";
          testResultMeta.textContent = "";
          testResultContent.textContent = "Please select a provider and model in the Model tab first.";
          testResultContent.classList.add("text-coral");
          return;
        }

        /* Build variable values from defaults */
        var variables = {};
        var varNames = extractVariables(prompt);
        varNames.forEach(function (name) {
          if (detectedVariables[name] && detectedVariables[name].defaultValue) {
            variables[name] = detectedVariables[name].defaultValue;
          } else {
            variables[name] = "[" + name + "]";
          }
        });

        testPromptBtn.disabled = true;
        testPromptBtn.innerHTML =
          '<svg class="h-3 w-3 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-dasharray="31.4 31.4" stroke-dashoffset="10"/></svg>' +
          ' Testing...';

        testResultPanel.classList.remove("hidden");
        testResultContent.classList.remove("text-coral");
        testResultContent.textContent = "Sending prompt to model...";
        testResultModel.textContent = modelName;
        testResultMeta.textContent = "";

        fetch("/api/prompt-templates/test", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prompt: prompt,
            variables: variables,
            provider_id: provId,
            model_name: modelName,
          }),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Test failed"); });
            return res.json();
          })
          .then(function (result) {
            testResultContent.classList.remove("text-coral");
            testResultContent.textContent = result.output || "(empty response)";
            testResultModel.textContent = result.model;
            var metaParts = [];
            if (result.response_time_ms != null) metaParts.push(result.response_time_ms + "ms");
            if (result.tokens_used != null) metaParts.push(result.tokens_used + " tokens");
            testResultMeta.textContent = metaParts.join("  ");
          })
          .catch(function (err) {
            testResultContent.classList.add("text-coral");
            testResultContent.textContent = err.message;
          })
          .finally(function () {
            testPromptBtn.disabled = false;
            testPromptBtn.innerHTML =
              '<svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>' +
              ' Test';
          });
      });
    }

    /* ------------------------------------------------------------------ */
    /* Import / Export Prompt JSON                                          */
    /* ------------------------------------------------------------------ */
    var importPromptBtn = document.getElementById("import-prompt-btn");
    var exportPromptBtn = document.getElementById("export-prompt-btn");
    var importFileInput = document.getElementById("import-file-input");

    if (exportPromptBtn) {
      exportPromptBtn.addEventListener("click", function () {
        var data = {
          name: nameInput.value.trim() || "prompt",
          content: instructionsInput.value,
          variables: detectedVariables,
        };
        var blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = (data.name.replace(/[^a-zA-Z0-9_-]/g, "_") || "prompt") + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }

    if (importPromptBtn) {
      importPromptBtn.addEventListener("click", function () {
        importFileInput.click();
      });
    }

    if (importFileInput) {
      importFileInput.addEventListener("change", function () {
        var file = importFileInput.files[0];
        if (!file) return;

        var reader = new FileReader();
        reader.onload = function (e) {
          try {
            var data = JSON.parse(e.target.result);
            if (data.content != null) {
              instructionsInput.value = data.content;
            }
            if (data.variables && typeof data.variables === "object") {
              detectedVariables = data.variables;
            }
            onInstructionsChange();
            renderVariablesPanel();
          } catch (err) {
            alert("Invalid JSON file: " + err.message);
          }
        };
        reader.readAsText(file);
        /* Reset so the same file can be re-imported */
        importFileInput.value = "";
      });
    }

    /* ------------------------------------------------------------------ */
    /* Model Comparison                                                    */
    /* ------------------------------------------------------------------ */
    var compareModelsBtn = document.getElementById("compare-models-btn");
    var compareSelectorModal = document.getElementById("compare-selector-modal");
    var confirmCompare = document.getElementById("confirm-compare");
    var compareResultPanel = document.getElementById("compare-result-panel");
    var compareResultContent = document.getElementById("compare-result-content");
    var closeCompareResult = document.getElementById("close-compare-result");

    if (closeCompareResult) {
      closeCompareResult.addEventListener("click", function () {
        compareResultPanel.classList.add("hidden");
      });
    }

    function populateCompareProviders() {
      for (var s = 0; s < 3; s++) {
        var sel = document.querySelector('[data-compare-provider="' + s + '"]');
        if (!sel) continue;
        sel.innerHTML = '<option value="">Provider...</option>';
        allProviders.forEach(function (p) {
          var opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.name + " (" + p.provider_type + ")";
          sel.appendChild(opt);
        });
      }
    }

    function onCompareProviderChange(slotIdx) {
      var provSel = document.querySelector('[data-compare-provider="' + slotIdx + '"]');
      var modSel = document.querySelector('[data-compare-model="' + slotIdx + '"]');
      if (!provSel || !modSel) return;

      var provId = provSel.value;
      if (!provId) {
        modSel.innerHTML = '<option value="">Model...</option>';
        modSel.disabled = true;
        return;
      }

      modSel.innerHTML = '<option value="">Loading...</option>';
      modSel.disabled = true;

      fetch("/api/models?provider_id=" + encodeURIComponent(provId))
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (models) {
          modSel.innerHTML = '<option value="">Model...</option>';
          models.forEach(function (m) {
            var opt = document.createElement("option");
            opt.value = m.model_name;
            opt.textContent = m.model_name;
            modSel.appendChild(opt);
          });
          modSel.disabled = false;
        })
        .catch(function () {
          modSel.innerHTML = '<option value="">Failed</option>';
        });
    }

    /* Attach change listeners for compare selectors */
    for (var _s = 0; _s < 3; _s++) {
      (function (idx) {
        var provSel = document.querySelector('[data-compare-provider="' + idx + '"]');
        if (provSel) {
          provSel.addEventListener("change", function () { onCompareProviderChange(idx); });
        }
      })(_s);
    }

    if (compareModelsBtn) {
      compareModelsBtn.addEventListener("click", function () {
        var prompt = instructionsInput.value.trim();
        if (!prompt) return;

        populateCompareProviders();
        /* Pre-fill slot 1 with the currently selected provider/model */
        var curProv = providerSelect.value;
        var curModel = modelSelect.value;
        if (curProv) {
          var pSel = document.querySelector('[data-compare-provider="0"]');
          if (pSel) {
            pSel.value = curProv;
            onCompareProviderChange(0);
            /* Set model after models load */
            if (curModel) {
              setTimeout(function () {
                var mSel = document.querySelector('[data-compare-model="0"]');
                if (mSel) mSel.value = curModel;
              }, 500);
            }
          }
        }

        compareSelectorModal.showModal();
      });
    }

    if (confirmCompare) {
      confirmCompare.addEventListener("click", function () {
        var prompt = instructionsInput.value.trim();
        if (!prompt) return;

        /* Collect selected models */
        var models = [];
        for (var s = 0; s < 3; s++) {
          var pSel = document.querySelector('[data-compare-provider="' + s + '"]');
          var mSel = document.querySelector('[data-compare-model="' + s + '"]');
          if (pSel && mSel && pSel.value && mSel.value) {
            models.push({ provider_id: pSel.value, model_name: mSel.value });
          }
        }

        if (models.length < 2) {
          alert("Please select at least 2 models to compare.");
          return;
        }

        /* Build variable values from defaults */
        var variables = {};
        var varNames = extractVariables(prompt);
        varNames.forEach(function (name) {
          if (detectedVariables[name] && detectedVariables[name].defaultValue) {
            variables[name] = detectedVariables[name].defaultValue;
          } else {
            variables[name] = "[" + name + "]";
          }
        });

        compareSelectorModal.close();
        compareResultPanel.classList.remove("hidden");
        testResultPanel.classList.add("hidden");

        /* Show loading state */
        var cols = models.length;
        compareResultContent.style.gridTemplateColumns = "repeat(" + cols + ", minmax(0, 1fr))";
        compareResultContent.innerHTML = "";
        models.forEach(function (m) {
          var col = document.createElement("div");
          col.className = "p-3 border-r border-dark/[0.06] last:border-r-0";
          col.innerHTML =
            '<div class="flex items-center gap-1.5 mb-2">' +
              '<span class="text-[10px] font-semibold text-dark font-mono">' + escapeHtml(m.model_name) + '</span>' +
            '</div>' +
            '<p class="text-xs text-muted animate-pulse">Sending prompt...</p>';
          compareResultContent.appendChild(col);
        });

        confirmCompare.disabled = true;
        confirmCompare.textContent = "Comparing...";

        fetch("/api/prompt-templates/compare", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: prompt, variables: variables, models: models }),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Compare failed"); });
            return res.json();
          })
          .then(function (data) {
            compareResultContent.innerHTML = "";
            data.results.forEach(function (r) {
              var col = document.createElement("div");
              col.className = "p-3 border-r border-dark/[0.06] last:border-r-0";
              var metaParts = [];
              if (r.response_time_ms != null) metaParts.push(r.response_time_ms + "ms");
              if (r.tokens_used != null) metaParts.push(r.tokens_used + " tok");
              var metaStr = metaParts.length > 0 ? metaParts.join("  ") : "";

              if (r.error) {
                col.innerHTML =
                  '<div class="flex items-center justify-between mb-2">' +
                    '<span class="text-[10px] font-semibold text-dark font-mono">' + escapeHtml(r.model_name) + '</span>' +
                    '<span class="text-[9px] text-muted">' + metaStr + '</span>' +
                  '</div>' +
                  '<p class="text-xs text-coral">' + escapeHtml(r.error) + '</p>';
              } else {
                col.innerHTML =
                  '<div class="flex items-center justify-between mb-2">' +
                    '<span class="text-[10px] font-semibold text-dark font-mono">' + escapeHtml(r.model_name) + '</span>' +
                    '<span class="text-[9px] text-muted">' + metaStr + '</span>' +
                  '</div>' +
                  '<div class="text-xs text-dark font-mono whitespace-pre-wrap leading-relaxed max-h-48 overflow-y-auto">' + escapeHtml(r.output || "(empty)") + '</div>';
              }
              compareResultContent.appendChild(col);
            });
          })
          .catch(function (err) {
            compareResultContent.innerHTML =
              '<div class="p-3 text-xs text-coral">' + escapeHtml(err.message) + '</div>';
          })
          .finally(function () {
            confirmCompare.disabled = false;
            confirmCompare.textContent = "Compare";
          });
      });
    }

    /* ------------------------------------------------------------------ */
    /* Version History                                                      */
    /* ------------------------------------------------------------------ */
    var versionHistoryBtn = document.getElementById("version-history-btn");
    var versionHistoryModal = document.getElementById("version-history-modal");
    var versionList = document.getElementById("version-list");
    var diffView = document.getElementById("diff-view");
    var closeDiffView = document.getElementById("close-diff-view");
    var diffContent = document.getElementById("diff-content");
    var diffLeft = document.getElementById("diff-left");
    var diffRight = document.getElementById("diff-right");
    var diffLeftLabel = document.getElementById("diff-left-label");
    var diffRightLabel = document.getElementById("diff-right-label");

    var cachedVersions = [];
    var selectedDiffVersions = []; /* array of version objects for diff */

    /* Track current template ID for version API calls */
    var currentTemplateId = null;

    if (closeDiffView) {
      closeDiffView.addEventListener("click", function () {
        diffView.classList.add("hidden");
        selectedDiffVersions = [];
        /* Deselect all checkboxes */
        versionList.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
          cb.checked = false;
        });
      });
    }

    function diffLines(textA, textB) {
      /* Simple line-by-line diff with highlighting */
      var linesA = textA.split("\n");
      var linesB = textB.split("\n");
      var maxLen = Math.max(linesA.length, linesB.length);
      var leftHtml = "";
      var rightHtml = "";

      for (var i = 0; i < maxLen; i++) {
        var a = i < linesA.length ? linesA[i] : "";
        var b = i < linesB.length ? linesB[i] : "";
        if (a === b) {
          leftHtml += escapeHtml(a) + "\n";
          rightHtml += escapeHtml(b) + "\n";
        } else {
          leftHtml += '<span class="bg-coral/10 text-coral">' + escapeHtml(a) + '</span>\n';
          rightHtml += '<span class="bg-zen-green/10 text-zen-green">' + escapeHtml(b) + '</span>\n';
        }
      }
      return { left: leftHtml, right: rightHtml };
    }

    function updateDiffView() {
      if (selectedDiffVersions.length !== 2) {
        diffView.classList.add("hidden");
        return;
      }

      /* Sort by version_number so older is on the left */
      var sorted = selectedDiffVersions.slice().sort(function (a, b) {
        return a.version_number - b.version_number;
      });

      var result = diffLines(sorted[0].content, sorted[1].content);
      diffLeft.innerHTML = result.left;
      diffRight.innerHTML = result.right;
      diffLeftLabel.textContent = "v" + sorted[0].version_number + "  " + sorted[0].created_at;
      diffRightLabel.textContent = "v" + sorted[1].version_number + "  " + sorted[1].created_at;
      diffView.classList.remove("hidden");
    }

    function renderVersionList() {
      versionList.innerHTML = "";
      selectedDiffVersions = [];
      diffView.classList.add("hidden");

      if (cachedVersions.length === 0) {
        versionList.innerHTML = '<p class="text-sm text-muted text-center py-4">No versions yet. Save a template to start tracking versions.</p>';
        return;
      }

      cachedVersions.forEach(function (ver) {
        var item = document.createElement("div");
        item.className = "flex items-center gap-3 rounded-lg px-3 py-2.5 hover:bg-subtle/80 transition-colors group";

        var preview = ver.content.length > 60 ? ver.content.substring(0, 60) + "..." : ver.content;

        item.innerHTML =
          '<input type="checkbox" data-version-id="' + ver.id + '" class="h-3.5 w-3.5 rounded border-dark/20 accent-zen-blue cursor-pointer" title="Select for diff" />' +
          '<div class="flex-1 min-w-0">' +
            '<div class="flex items-center gap-2">' +
              '<span class="text-xs font-semibold text-dark">v' + ver.version_number + '</span>' +
              '<span class="text-[10px] text-muted">' + escapeHtml(ver.created_at) + '</span>' +
            '</div>' +
            '<p class="text-[11px] text-muted truncate font-mono mt-0.5">' + escapeHtml(preview) + '</p>' +
          '</div>' +
          '<button type="button" class="version-restore-btn flex items-center gap-1 rounded-md bg-subtle px-2 py-1 text-[10px] font-medium text-muted hover:bg-coral/10 hover:text-coral transition-colors opacity-0 group-hover:opacity-100 cursor-pointer" data-version-id="' + ver.id + '" data-template-id="' + ver.template_id + '" title="Restore this version">' +
            '<svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>' +
            'Restore' +
          '</button>';

        /* Checkbox for diff selection */
        var cb = item.querySelector('input[type="checkbox"]');
        cb.addEventListener("change", function () {
          if (cb.checked) {
            if (selectedDiffVersions.length >= 2) {
              /* Uncheck the first selected to make room */
              var firstCb = versionList.querySelector('input[data-version-id="' + selectedDiffVersions[0].id + '"]');
              if (firstCb) firstCb.checked = false;
              selectedDiffVersions.shift();
            }
            selectedDiffVersions.push(ver);
          } else {
            selectedDiffVersions = selectedDiffVersions.filter(function (v) { return v.id !== ver.id; });
          }
          updateDiffView();
        });

        /* Restore button */
        item.querySelector(".version-restore-btn").addEventListener("click", function (e) {
          e.stopPropagation();
          var vId = this.getAttribute("data-version-id");
          var tId = this.getAttribute("data-template-id");
          if (!confirm("Restore this version? This will update the template content.")) return;

          fetch("/api/prompt-templates/" + tId + "/versions/" + vId + "/restore", { method: "POST" })
            .then(function (res) {
              if (!res.ok) throw new Error("Failed to restore");
              return res.json();
            })
            .then(function (tpl) {
              /* Update the editor with the restored content */
              instructionsInput.value = tpl.content;
              try {
                var vars = JSON.parse(tpl.variables_json || "{}");
                if (vars && typeof vars === "object") detectedVariables = vars;
              } catch (ex) { /* ignore */ }
              onInstructionsChange();
              renderVariablesPanel();
              versionHistoryModal.close();
            })
            .catch(function (err) {
              alert(err.message);
            });
        });

        versionList.appendChild(item);
      });
    }

    if (versionHistoryBtn) {
      versionHistoryBtn.addEventListener("click", function () {
        if (!currentTemplateId) {
          /* No template ID means the prompt hasn't been saved as a template yet */
          versionList.innerHTML = '<p class="text-sm text-muted text-center py-4">Save your prompt as a template first to enable version history.</p>';
          versionHistoryModal.showModal();
          return;
        }

        versionList.innerHTML = '<p class="text-sm text-muted text-center py-4">Loading versions...</p>';
        diffView.classList.add("hidden");
        versionHistoryModal.showModal();

        fetch("/api/prompt-templates/" + currentTemplateId + "/versions")
          .then(function (res) { return res.ok ? res.json() : []; })
          .then(function (versions) {
            cachedVersions = versions;
            renderVersionList();
          })
          .catch(function () {
            versionList.innerHTML = '<p class="text-sm text-coral text-center py-4">Failed to load versions.</p>';
          });
      });
    }

    /* ------------------------------------------------------------------ */
    /* Load agent data                                                     */
    /* ------------------------------------------------------------------ */
    function findProviderIdByName(providerName) {
      if (!providerName) return "";
      for (var i = 0; i < allProviders.length; i++) {
        if (allProviders[i].provider_type === providerName ||
            allProviders[i].name === providerName ||
            allProviders[i].id === providerName) {
          return allProviders[i].id;
        }
      }
      return "";
    }

    function showAgent(agent) {
      currentAgent = agent;
      loadingState.classList.add("hidden");
      editorContent.classList.remove("hidden");

      agentNameHeading.textContent = agent.name;

      /* Basic tab */
      nameInput.value = agent.name;
      descriptionInput.value = agent.description || "";
      instructionsInput.value = agent.instructions || "";

      /* Trigger highlighting, variable detection, and token counter for loaded instructions */
      highlightInstructions();
      updateTokenCounter();
      renderVariablesPanel();

      /* Persona fields */
      personaRole.value = agent.persona_role || "";
      personaGoal.value = agent.persona_goal || "";
      personaBackstory.value = agent.persona_backstory || "";
      updatePersonaBadge();
      /* If persona has data, auto-expand the section */
      if (agent.persona_role || agent.persona_goal || agent.persona_backstory) {
        personaContent.classList.remove("hidden");
        personaChevron.style.transform = "rotate(180deg)";
      }

      /* Model tab */
      if (agent.temperature != null) {
        temperatureSlider.value = agent.temperature;
        temperatureValue.textContent = parseFloat(agent.temperature).toFixed(1);
      }
      if (agent.max_tokens != null) {
        maxTokensInput.value = agent.max_tokens;
      }

      /* Tools tab  parse tools_json */
      try {
        var tools = JSON.parse(agent.tools_json || "[]");
        assignedTools = Array.isArray(tools) ? tools : [];
      } catch (e) {
        assignedTools = [];
      }
      renderToolsList();

      /* Handoffs tab  parse handoffs_json */
      try {
        var handoffs = JSON.parse(agent.handoffs_json || "[]");
        assignedHandoffs = Array.isArray(handoffs) ? handoffs : [];
      } catch (e) {
        assignedHandoffs = [];
      }
      renderHandoffsList();

      /* Hooks tab  parse hooks_json */
      try {
        var hooks = JSON.parse(agent.hooks_json || "{}");
        if (hooks && typeof hooks === "object") {
          hookPoints.forEach(function (hp) {
            var input = document.querySelector('[data-hook-input="' + hp + '"]');
            if (input && hooks[hp]) {
              input.value = hooks[hp];
            }
          });
        }
      } catch (e) {
        /* ignore parse errors */
      }

      /* Advanced tab */
      if (agent.max_steps != null) {
        maxStepsSlider.value = agent.max_steps;
        maxStepsValue.textContent = agent.max_steps;
      }

      if (agent.output_type_json && agent.output_type_json !== "{}") {
        try {
          outputTypeTextarea.value = JSON.stringify(JSON.parse(agent.output_type_json), null, 2);
        } catch (e) {
          outputTypeTextarea.value = agent.output_type_json;
        }
      }

      /* Memory, context, and variable config  stored in hooks_json as meta flags */
      try {
        var hooksData = JSON.parse(agent.hooks_json || "{}");
        if (hooksData._memory_enabled) {
          memoryEnabled = true;
          setToggle(toggleMemory, true);
        }
        if (hooksData._context_enabled) {
          contextEnabled = true;
          setToggle(toggleContext, true);
        }
        if (hooksData._variables && typeof hooksData._variables === "object") {
          detectedVariables = hooksData._variables;
        }
      } catch (e) {
        /* ignore */
      }

      /* Populate providers, then models. */
      fetch("/api/providers")
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (providers) {
          allProviders = providers;
          providerSelect.innerHTML = '<option value="">Select a provider...</option>';
          providers.forEach(function (p) {
            var opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = p.name + " (" + p.provider_type + ")";
            providerSelect.appendChild(opt);
          });

          var matchedId = findProviderIdByName(agent.model_provider);
          if (matchedId) {
            providerSelect.value = matchedId;
            populateModels(matchedId, agent.model_name);
          }
        })
        .catch(function () {});

      /* Update breadcrumb */
      var allSpans = document.querySelectorAll("nav span");
      allSpans.forEach(function (span) {
        if (span.textContent.trim() === "Loading...") {
          span.textContent = agent.name;
        }
      });
    }

    function showError() {
      loadingState.classList.add("hidden");
      errorState.classList.remove("hidden");
    }

    function fetchAgent() {
      fetch("/api/agents/" + agentId)
        .then(function (res) {
          if (!res.ok) throw new Error("Not found");
          return res.json();
        })
        .then(showAgent)
        .catch(showError);
    }

    /* ------------------------------------------------------------------ */
    /* Save agent                                                          */
    /* ------------------------------------------------------------------ */
    if (saveBtn) {
      saveBtn.addEventListener("click", function () {
        nameError.classList.add("hidden");

        var name = nameInput.value.trim();
        if (!name) {
          nameError.classList.remove("hidden");
          document.querySelector('[data-tab="basic"]').click();
          nameInput.focus();
          return;
        }

        /* Resolve provider ID back to provider_type for storage */
        var provId = providerSelect.value;
        var modelProvider = "";
        for (var i = 0; i < allProviders.length; i++) {
          if (allProviders[i].id === provId) {
            modelProvider = allProviders[i].provider_type;
            break;
          }
        }

        /* Validate output_type JSON before saving */
        if (!validateOutputTypeJson()) {
          document.querySelector('[data-tab="advanced"]').click();
          outputTypeTextarea.focus();
          return;
        }

        /* Build hooks_json from hook inputs */
        var hooksObj = {};
        hookPoints.forEach(function (hp) {
          var input = document.querySelector('[data-hook-input="' + hp + '"]');
          if (input && input.value.trim()) {
            hooksObj[hp] = input.value.trim();
          }
        });
        /* Store toggle state as meta flags */
        if (memoryEnabled) hooksObj._memory_enabled = true;
        if (contextEnabled) hooksObj._context_enabled = true;
        /* Store variable config */
        if (Object.keys(detectedVariables).length > 0) {
          hooksObj._variables = detectedVariables;
        }

        var outputTypeVal = outputTypeTextarea.value.trim() || "{}";

        var body = {
          name: name,
          description: descriptionInput.value.trim(),
          instructions: instructionsInput.value,
          model_provider: modelProvider,
          model_name: modelSelect.value || "",
          temperature: parseFloat(temperatureSlider.value),
          max_steps: parseInt(maxStepsSlider.value, 10),
          tools_json: JSON.stringify(assignedTools),
          handoffs_json: JSON.stringify(assignedHandoffs),
          hooks_json: JSON.stringify(hooksObj),
          output_type_json: outputTypeVal,
          persona_role: personaRole.value.trim(),
          persona_goal: personaGoal.value.trim(),
          persona_backstory: personaBackstory.value.trim(),
        };

        var maxTokens = maxTokensInput.value.trim();
        if (maxTokens !== "") {
          body.max_tokens = parseInt(maxTokens, 10);
        }

        saveBtn.disabled = true;
        saveStatus.textContent = "Saving...";
        saveStatus.classList.remove("hidden", "text-zen-green", "text-coral");
        saveStatus.classList.add("text-muted");

        fetch("/api/agents/" + agentId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to save"); });
            return res.json();
          })
          .then(function (agent) {
            currentAgent = agent;
            agentNameHeading.textContent = agent.name;

            saveStatus.textContent = "Saved";
            saveStatus.classList.remove("text-muted", "text-coral");
            saveStatus.classList.add("text-zen-green");
            setTimeout(function () { saveStatus.classList.add("hidden"); }, 2000);

            /* Update breadcrumb */
            var allSpans = document.querySelectorAll("nav span");
            allSpans.forEach(function (span) {
              if (span.textContent.trim() === currentAgent.name || span.textContent.trim() === "Loading...") {
                span.textContent = agent.name;
              }
            });
          })
          .catch(function (err) {
            saveStatus.textContent = err.message;
            saveStatus.classList.remove("text-muted", "text-zen-green");
            saveStatus.classList.add("text-coral");
          })
          .finally(function () {
            saveBtn.disabled = false;
          });
      });
    }

    /* ------------------------------------------------------------------ */
    /* Keyboard shortcut: Ctrl/Cmd + S to save                             */
    /* ------------------------------------------------------------------ */
    document.addEventListener("keydown", function (e) {
      if ((e.ctrlKey || e.metaKey) && e.key === "s") {
        e.preventDefault();
        if (saveBtn && !saveBtn.disabled) saveBtn.click();
      }
    });

    /* ------------------------------------------------------------------ */
    /* Init                                                                */
    /* ------------------------------------------------------------------ */
    fetchAgent();
  })();
</script>
