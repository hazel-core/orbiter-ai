---
import PageLayout from "../../../layouts/PageLayout.astro";
import Button from "../../../components/Button.astro";
import Modal from "../../../components/Modal.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Agents", href: "/agents" },
  { label: "Loading..." },
  { label: "Edit" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const saveIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>';
---

<PageLayout
  title="Edit Agent"
  description="Configure agent settings"
  activeSection="agents"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-3xl mx-auto">
    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading agent...</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <p class="text-lg font-semibold text-dark mb-2">Agent not found</p>
      <p class="text-sm text-muted mb-6">This agent may have been deleted.</p>
      <Button href="/agents" variant="bordered">
        <span set:html={backIcon} />
        Back to Agents
      </Button>
    </div>

    <!-- Agent editor (hidden until loaded) -->
    <div id="editor-content" class="hidden">
      <!-- Back + Save row -->
      <div class="flex items-center justify-between mb-6">
        <a id="back-link" href="/agents" class="flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          Back
        </a>
        <div class="flex items-center gap-3">
          <span id="save-status" class="text-xs text-muted hidden"></span>
          <Button variant="primary" id="save-btn" class="text-sm">
            <span set:html={saveIcon} />
            Save
          </Button>
        </div>
      </div>

      <!-- Agent name heading -->
      <h1 id="agent-name-heading" class="text-2xl font-semibold text-dark mb-6"></h1>

      <!-- Tabs -->
      <div class="border-b border-dark/[0.08] mb-6">
        <nav class="flex gap-6" role="tablist">
          <button
            type="button"
            role="tab"
            aria-selected="true"
            data-tab="basic"
            class="tab-btn relative pb-3 text-sm font-medium text-dark border-b-2 border-coral transition-colors"
          >
            Basic
          </button>
          <button
            type="button"
            role="tab"
            aria-selected="false"
            data-tab="model"
            class="tab-btn relative pb-3 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors"
          >
            Model
          </button>
          <button
            type="button"
            role="tab"
            aria-selected="false"
            data-tab="tools"
            class="tab-btn relative pb-3 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors"
          >
            Tools
          </button>
          <button
            type="button"
            role="tab"
            aria-selected="false"
            data-tab="handoffs"
            class="tab-btn relative pb-3 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors"
          >
            Handoffs
          </button>
          <button
            type="button"
            role="tab"
            aria-selected="false"
            data-tab="hooks"
            class="tab-btn relative pb-3 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors"
          >
            Hooks
          </button>
          <button
            type="button"
            role="tab"
            aria-selected="false"
            data-tab="advanced"
            class="tab-btn relative pb-3 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors"
          >
            Advanced
          </button>
        </nav>
      </div>

      <!-- Tab panels -->
      <!-- Basic tab -->
      <div id="panel-basic" class="tab-panel" role="tabpanel">
        <div class="flex flex-col gap-5">
          <!-- Name -->
          <div class="flex flex-col gap-1.5">
            <label for="agent-name" class="text-sm font-medium text-dark">
              Name <span class="text-coral">*</span>
            </label>
            <input
              type="text"
              id="agent-name"
              name="name"
              required
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="My Agent"
            />
            <p id="name-error" class="text-xs text-coral hidden">Name is required</p>
          </div>

          <!-- Description -->
          <div class="flex flex-col gap-1.5">
            <label for="agent-description" class="text-sm font-medium text-dark">Description</label>
            <input
              type="text"
              id="agent-description"
              name="description"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="A brief description of this agent"
            />
          </div>

          <!-- Instructions / System Prompt -->
          <div class="flex flex-col gap-1.5">
            <label for="agent-instructions" class="text-sm font-medium text-dark">Instructions (System Prompt)</label>
            <textarea
              id="agent-instructions"
              name="instructions"
              rows="12"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-y font-mono text-sm leading-relaxed"
              placeholder="You are a helpful assistant..."
            ></textarea>
            <p class="text-xs text-muted">The system prompt that guides the agent's behavior.</p>
          </div>
        </div>
      </div>

      <!-- Model tab -->
      <div id="panel-model" class="tab-panel hidden" role="tabpanel">
        <div class="flex flex-col gap-5">
          <!-- Provider selector -->
          <div class="flex flex-col gap-1.5">
            <label for="model-provider" class="text-sm font-medium text-dark">Provider</label>
            <select
              id="model-provider"
              name="model_provider"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer"
            >
              <option value="">Select a provider...</option>
            </select>
            <p class="text-xs text-muted">Choose from your configured providers.</p>
          </div>

          <!-- Model selector -->
          <div class="flex flex-col gap-1.5">
            <label for="model-name" class="text-sm font-medium text-dark">Model</label>
            <select
              id="model-name"
              name="model_name"
              disabled
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <option value="">Select a provider first...</option>
            </select>
          </div>

          <!-- Model preview -->
          <div id="model-preview" class="hidden rounded-lg bg-subtle/80 border border-dark/[0.08] px-4 py-3">
            <span class="text-xs text-muted">Selected model</span>
            <p id="model-preview-text" class="text-sm font-medium text-dark mt-0.5 font-mono"></p>
          </div>

          <!-- Divider -->
          <hr class="border-dark/[0.06]" />

          <!-- Temperature slider -->
          <div class="flex flex-col gap-1.5">
            <div class="flex items-center justify-between">
              <label for="model-temperature" class="text-sm font-medium text-dark">Temperature</label>
              <span id="temperature-value" class="text-sm font-mono text-muted tabular-nums">0.7</span>
            </div>
            <input
              type="range"
              id="model-temperature"
              name="temperature"
              min="0"
              max="2"
              step="0.1"
              value="0.7"
              class="w-full h-2 bg-dark/[0.08] rounded-lg appearance-none cursor-pointer accent-coral"
            />
            <div class="flex justify-between text-xs text-muted/60">
              <span>Precise (0.0)</span>
              <span>Creative (2.0)</span>
            </div>
          </div>

          <!-- Max tokens -->
          <div class="flex flex-col gap-1.5">
            <label for="model-max-tokens" class="text-sm font-medium text-dark">Max Tokens</label>
            <input
              type="number"
              id="model-max-tokens"
              name="max_tokens"
              min="1"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="Leave blank for model default"
            />
            <p class="text-xs text-muted">Maximum number of tokens the model can generate.</p>
          </div>
        </div>
      </div>

      <!-- Tools tab -->
      <div id="panel-tools" class="tab-panel hidden" role="tabpanel">
        <div class="flex flex-col gap-5">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-medium text-dark">Assigned Tools</h3>
              <p class="text-xs text-muted mt-0.5">Tools this agent can use. Drag to reorder priority.</p>
            </div>
            <button
              type="button"
              id="add-tool-btn"
              class="flex items-center gap-1.5 rounded-lg bg-dark text-paper px-3 py-1.5 text-xs font-medium hover:bg-dark/80 transition-colors cursor-pointer"
            >
              <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Tool
            </button>
          </div>

          <!-- Tool list (populated by JS) -->
          <div id="tools-list" class="flex flex-col gap-2">
            <!-- Empty state -->
            <div id="tools-empty" class="rounded-lg border border-dashed border-dark/[0.12] bg-subtle/50 py-8 text-center">
              <p class="text-sm text-muted">No tools assigned yet.</p>
              <p class="text-xs text-muted/60 mt-1">Click "Add Tool" to assign tools to this agent.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Handoffs tab -->
      <div id="panel-handoffs" class="tab-panel hidden" role="tabpanel">
        <div class="flex flex-col gap-5">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-medium text-dark">Handoff Targets</h3>
              <p class="text-xs text-muted mt-0.5">Other agents this agent can hand off tasks to.</p>
            </div>
            <button
              type="button"
              id="add-handoff-btn"
              class="flex items-center gap-1.5 rounded-lg bg-dark text-paper px-3 py-1.5 text-xs font-medium hover:bg-dark/80 transition-colors cursor-pointer"
            >
              <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Handoff
            </button>
          </div>

          <!-- Handoff list (populated by JS) -->
          <div id="handoffs-list" class="flex flex-col gap-2">
            <!-- Empty state -->
            <div id="handoffs-empty" class="rounded-lg border border-dashed border-dark/[0.12] bg-subtle/50 py-8 text-center">
              <p class="text-sm text-muted">No handoff targets configured.</p>
              <p class="text-xs text-muted/60 mt-1">Click "Add Handoff" to allow this agent to delegate to others.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Hooks tab -->
      <div id="panel-hooks" class="tab-panel hidden" role="tabpanel">
        <div class="flex flex-col gap-5">
          <div>
            <h3 class="text-sm font-medium text-dark">Lifecycle Hooks</h3>
            <p class="text-xs text-muted mt-0.5">Attach functions to agent lifecycle events. Each hook point runs before or after a specific stage.</p>
          </div>

          <!-- Hook points (populated by JS with initial structure) -->
          <div id="hooks-list" class="flex flex-col gap-3">
            <!-- before_model_call -->
            <div class="hook-row rounded-lg border border-dark/[0.08] bg-paper px-4 py-3" data-hook="before_model_call">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="flex h-6 w-6 items-center justify-center rounded bg-zen-blue/10 text-zen-blue">
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
                  </span>
                  <span class="text-sm font-medium text-dark">before_model_call</span>
                </div>
                <span class="text-[10px] font-medium text-muted uppercase tracking-wider">Pre-LLM</span>
              </div>
              <input
                type="text"
                data-hook-input="before_model_call"
                placeholder="Function name or module path (e.g. my_hooks.log_prompt)"
                class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 font-mono outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
              />
            </div>

            <!-- after_model_call -->
            <div class="hook-row rounded-lg border border-dark/[0.08] bg-paper px-4 py-3" data-hook="after_model_call">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="flex h-6 w-6 items-center justify-center rounded bg-zen-green/10 text-zen-green">
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
                  </span>
                  <span class="text-sm font-medium text-dark">after_model_call</span>
                </div>
                <span class="text-[10px] font-medium text-muted uppercase tracking-wider">Post-LLM</span>
              </div>
              <input
                type="text"
                data-hook-input="after_model_call"
                placeholder="Function name or module path (e.g. my_hooks.validate_output)"
                class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 font-mono outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
              />
            </div>

            <!-- before_tool_call -->
            <div class="hook-row rounded-lg border border-dark/[0.08] bg-paper px-4 py-3" data-hook="before_tool_call">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="flex h-6 w-6 items-center justify-center rounded bg-coral/10 text-coral">
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                  </span>
                  <span class="text-sm font-medium text-dark">before_tool_call</span>
                </div>
                <span class="text-[10px] font-medium text-muted uppercase tracking-wider">Pre-Tool</span>
              </div>
              <input
                type="text"
                data-hook-input="before_tool_call"
                placeholder="Function name or module path (e.g. my_hooks.authorize_tool)"
                class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 font-mono outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
              />
            </div>

            <!-- after_tool_call -->
            <div class="hook-row rounded-lg border border-dark/[0.08] bg-paper px-4 py-3" data-hook="after_tool_call">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="flex h-6 w-6 items-center justify-center rounded bg-coral/10 text-coral">
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                  </span>
                  <span class="text-sm font-medium text-dark">after_tool_call</span>
                </div>
                <span class="text-[10px] font-medium text-muted uppercase tracking-wider">Post-Tool</span>
              </div>
              <input
                type="text"
                data-hook-input="after_tool_call"
                placeholder="Function name or module path (e.g. my_hooks.log_tool_result)"
                class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 font-mono outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
              />
            </div>

            <!-- on_error -->
            <div class="hook-row rounded-lg border border-dark/[0.08] bg-paper px-4 py-3" data-hook="on_error">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="flex h-6 w-6 items-center justify-center rounded bg-coral/10 text-coral">
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                  </span>
                  <span class="text-sm font-medium text-dark">on_error</span>
                </div>
                <span class="text-[10px] font-medium text-muted uppercase tracking-wider">Error</span>
              </div>
              <input
                type="text"
                data-hook-input="on_error"
                placeholder="Function name or module path (e.g. my_hooks.handle_error)"
                class="w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 font-mono outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced tab -->
      <div id="panel-advanced" class="tab-panel hidden" role="tabpanel">
        <div class="flex flex-col gap-6">
          <!-- Max Steps -->
          <div class="flex flex-col gap-1.5">
            <div class="flex items-center justify-between">
              <label for="advanced-max-steps" class="text-sm font-medium text-dark">Max Steps</label>
              <span id="max-steps-value" class="text-sm font-mono text-muted tabular-nums">10</span>
            </div>
            <input
              type="range"
              id="advanced-max-steps"
              name="max_steps"
              min="1"
              max="100"
              step="1"
              value="10"
              class="w-full h-2 bg-dark/[0.08] rounded-lg appearance-none cursor-pointer accent-coral"
            />
            <div class="flex justify-between text-xs text-muted/60">
              <span>1 step</span>
              <span>100 steps</span>
            </div>
            <p class="text-xs text-muted">Maximum number of tool-call loops the agent can execute.</p>
          </div>

          <hr class="border-dark/[0.06]" />

          <!-- Output Type (JSON Schema) -->
          <div class="flex flex-col gap-1.5">
            <label for="advanced-output-type" class="text-sm font-medium text-dark">Output Type (JSON Schema)</label>
            <textarea
              id="advanced-output-type"
              name="output_type_json"
              rows="8"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-y font-mono text-sm leading-relaxed"
              placeholder='{"type": "object", "properties": {...}}'
            ></textarea>
            <p id="output-type-error" class="text-xs text-coral hidden">Invalid JSON. Please check your syntax.</p>
            <p class="text-xs text-muted">Define a JSON Schema for structured agent output. Leave as <code class="bg-subtle/80 px-1 py-0.5 rounded text-[11px]">{}</code> for free-form text.</p>
          </div>

          <hr class="border-dark/[0.06]" />

          <!-- Toggles -->
          <div class="flex flex-col gap-4">
            <!-- Memory toggle -->
            <div class="flex items-center justify-between rounded-lg border border-dark/[0.08] bg-paper px-4 py-3">
              <div>
                <p class="text-sm font-medium text-dark">Memory</p>
                <p class="text-xs text-muted mt-0.5">Enable persistent memory across conversations.</p>
              </div>
              <button
                type="button"
                id="toggle-memory"
                role="switch"
                aria-checked="false"
                class="relative h-6 w-11 rounded-full bg-dark/[0.12] transition-colors cursor-pointer"
              >
                <span class="toggle-dot absolute left-0.5 top-0.5 h-5 w-5 rounded-full bg-white shadow transition-transform"></span>
              </button>
            </div>

            <!-- Context toggle -->
            <div class="flex items-center justify-between rounded-lg border border-dark/[0.08] bg-paper px-4 py-3">
              <div>
                <p class="text-sm font-medium text-dark">Context Engine</p>
                <p class="text-xs text-muted mt-0.5">Enable the context engine for RAG and artifact management.</p>
              </div>
              <button
                type="button"
                id="toggle-context"
                role="switch"
                aria-checked="false"
                class="relative h-6 w-11 rounded-full bg-dark/[0.12] transition-colors cursor-pointer"
              >
                <span class="toggle-dot absolute left-0.5 top-0.5 h-5 w-5 rounded-full bg-white shadow transition-transform"></span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tool selector modal -->
  <Modal id="tool-selector-modal" title="Add Tool">
    <div class="flex flex-col gap-4">
      <input
        type="text"
        id="tool-search"
        placeholder="Search tools..."
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
      />
      <div id="tool-selector-list" class="flex flex-col gap-1 max-h-64 overflow-y-auto">
        <p class="text-sm text-muted text-center py-4">Loading tools...</p>
      </div>
    </div>
  </Modal>

  <!-- Handoff agent selector modal -->
  <Modal id="handoff-selector-modal" title="Add Handoff Target">
    <div class="flex flex-col gap-4">
      <input
        type="text"
        id="handoff-search"
        placeholder="Search agents..."
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
      />
      <div id="handoff-selector-list" class="flex flex-col gap-1 max-h-64 overflow-y-auto">
        <p class="text-sm text-muted text-center py-4">Loading agents...</p>
      </div>
    </div>
  </Modal>
</PageLayout>

<script is:inline define:vars={{ agentId: id }}>
  (function () {
    var loadingState = document.getElementById("loading-state");
    var errorState = document.getElementById("error-state");
    var editorContent = document.getElementById("editor-content");

    var agentNameHeading = document.getElementById("agent-name-heading");
    var saveBtn = document.getElementById("save-btn");
    var saveStatus = document.getElementById("save-status");

    /* Basic tab fields */
    var nameInput = document.getElementById("agent-name");
    var nameError = document.getElementById("name-error");
    var descriptionInput = document.getElementById("agent-description");
    var instructionsInput = document.getElementById("agent-instructions");

    /* Model tab fields */
    var providerSelect = document.getElementById("model-provider");
    var modelSelect = document.getElementById("model-name");
    var modelPreview = document.getElementById("model-preview");
    var modelPreviewText = document.getElementById("model-preview-text");
    var temperatureSlider = document.getElementById("model-temperature");
    var temperatureValue = document.getElementById("temperature-value");
    var maxTokensInput = document.getElementById("model-max-tokens");

    /* Tools tab */
    var toolsList = document.getElementById("tools-list");
    var toolsEmpty = document.getElementById("tools-empty");
    var addToolBtn = document.getElementById("add-tool-btn");
    var toolSelectorModal = document.getElementById("tool-selector-modal");
    var toolSelectorList = document.getElementById("tool-selector-list");
    var toolSearch = document.getElementById("tool-search");

    /* Handoffs tab */
    var handoffsList = document.getElementById("handoffs-list");
    var handoffsEmpty = document.getElementById("handoffs-empty");
    var addHandoffBtn = document.getElementById("add-handoff-btn");
    var handoffSelectorModal = document.getElementById("handoff-selector-modal");
    var handoffSelectorList = document.getElementById("handoff-selector-list");
    var handoffSearch = document.getElementById("handoff-search");

    /* Hooks tab */
    var hookPoints = ["before_model_call", "after_model_call", "before_tool_call", "after_tool_call", "on_error"];

    /* Advanced tab */
    var maxStepsSlider = document.getElementById("advanced-max-steps");
    var maxStepsValue = document.getElementById("max-steps-value");
    var outputTypeTextarea = document.getElementById("advanced-output-type");
    var outputTypeError = document.getElementById("output-type-error");
    var toggleMemory = document.getElementById("toggle-memory");
    var toggleContext = document.getElementById("toggle-context");

    /* Toggle state */
    var memoryEnabled = false;
    var contextEnabled = false;

    var currentAgent = null;
    var allProviders = [];
    var allModels = [];

    /* State: assigned tools as array of {id, name, description, category} */
    var assignedTools = [];
    /* State: handoff targets as array of {id, name, description} */
    var assignedHandoffs = [];
    /* Cached data from API */
    var availableTools = [];
    var projectAgents = [];

    /* Drag state */
    var dragIndex = null;

    /* ------------------------------------------------------------------ */
    /* Tab switching                                                       */
    /* ------------------------------------------------------------------ */
    var tabButtons = document.querySelectorAll(".tab-btn");
    var tabPanels = document.querySelectorAll(".tab-panel");

    tabButtons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        var tabId = btn.getAttribute("data-tab");

        tabButtons.forEach(function (b) {
          b.classList.remove("text-dark", "border-coral");
          b.classList.add("text-muted", "border-transparent");
          b.setAttribute("aria-selected", "false");
        });
        btn.classList.remove("text-muted", "border-transparent");
        btn.classList.add("text-dark", "border-coral");
        btn.setAttribute("aria-selected", "true");

        tabPanels.forEach(function (p) {
          p.classList.add("hidden");
        });
        var panel = document.getElementById("panel-" + tabId);
        if (panel) panel.classList.remove("hidden");
      });
    });

    /* ------------------------------------------------------------------ */
    /* Temperature slider                                                  */
    /* ------------------------------------------------------------------ */
    if (temperatureSlider) {
      temperatureSlider.addEventListener("input", function () {
        temperatureValue.textContent = parseFloat(temperatureSlider.value).toFixed(1);
      });
    }

    /* ------------------------------------------------------------------ */
    /* Max Steps slider                                                    */
    /* ------------------------------------------------------------------ */
    if (maxStepsSlider) {
      maxStepsSlider.addEventListener("input", function () {
        maxStepsValue.textContent = maxStepsSlider.value;
      });
    }

    /* ------------------------------------------------------------------ */
    /* Output type JSON validation                                         */
    /* ------------------------------------------------------------------ */
    if (outputTypeTextarea) {
      outputTypeTextarea.addEventListener("blur", function () {
        validateOutputTypeJson();
      });
    }

    function validateOutputTypeJson() {
      var val = outputTypeTextarea.value.trim();
      if (!val || val === "{}") {
        outputTypeError.classList.add("hidden");
        outputTypeTextarea.classList.remove("border-coral");
        return true;
      }
      try {
        JSON.parse(val);
        outputTypeError.classList.add("hidden");
        outputTypeTextarea.classList.remove("border-coral");
        return true;
      } catch (e) {
        outputTypeError.classList.remove("hidden");
        outputTypeTextarea.classList.add("border-coral");
        return false;
      }
    }

    /* ------------------------------------------------------------------ */
    /* Toggle switches                                                     */
    /* ------------------------------------------------------------------ */
    function setToggle(btn, on) {
      var dot = btn.querySelector(".toggle-dot");
      if (on) {
        btn.classList.remove("bg-dark/[0.12]");
        btn.classList.add("bg-coral");
        btn.setAttribute("aria-checked", "true");
        dot.classList.add("translate-x-5");
      } else {
        btn.classList.remove("bg-coral");
        btn.classList.add("bg-dark/[0.12]");
        btn.setAttribute("aria-checked", "false");
        dot.classList.remove("translate-x-5");
      }
    }

    if (toggleMemory) {
      toggleMemory.addEventListener("click", function () {
        memoryEnabled = !memoryEnabled;
        setToggle(toggleMemory, memoryEnabled);
      });
    }
    if (toggleContext) {
      toggleContext.addEventListener("click", function () {
        contextEnabled = !contextEnabled;
        setToggle(toggleContext, contextEnabled);
      });
    }

    /* ------------------------------------------------------------------ */
    /* Provider / Model selectors                                          */
    /* ------------------------------------------------------------------ */
    function updateModelPreview() {
      var provider = providerSelect.value;
      var model = modelSelect.value;

      if (provider && model) {
        modelPreview.classList.remove("hidden");
        var provName = provider;
        for (var i = 0; i < allProviders.length; i++) {
          if (allProviders[i].id === provider) {
            provName = allProviders[i].name || allProviders[i].provider_type;
            break;
          }
        }
        modelPreviewText.textContent = provName + ":" + model;
      } else {
        modelPreview.classList.add("hidden");
      }
    }

    function populateModels(providerId, selectedModelName) {
      if (!providerId) {
        modelSelect.innerHTML = '<option value="">Select a provider first...</option>';
        modelSelect.disabled = true;
        updateModelPreview();
        return;
      }

      modelSelect.innerHTML = '<option value="">Loading models...</option>';
      modelSelect.disabled = true;

      fetch("/api/models?provider_id=" + encodeURIComponent(providerId))
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (models) {
          allModels = models;
          modelSelect.innerHTML = '<option value="">Select a model...</option>';
          models.forEach(function (m) {
            var opt = document.createElement("option");
            opt.value = m.model_name;
            opt.textContent = m.model_name;
            modelSelect.appendChild(opt);
          });
          modelSelect.disabled = false;
          if (selectedModelName) {
            modelSelect.value = selectedModelName;
          }
          updateModelPreview();
        })
        .catch(function () {
          modelSelect.innerHTML = '<option value="">Failed to load models</option>';
          modelSelect.disabled = true;
        });
    }

    if (providerSelect) {
      providerSelect.addEventListener("change", function () {
        populateModels(providerSelect.value, "");
      });
    }

    if (modelSelect) {
      modelSelect.addEventListener("change", updateModelPreview);
    }

    /* ------------------------------------------------------------------ */
    /* Tools management                                                    */
    /* ------------------------------------------------------------------ */
    var categoryIcons = {
      retrieval: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
      filesystem: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>',
      execution: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
      data: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
      utility: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>'
    };

    function renderToolsList() {
      /* Clear everything except the empty state */
      var items = toolsList.querySelectorAll(".tool-item");
      items.forEach(function (el) { el.remove(); });

      if (assignedTools.length === 0) {
        toolsEmpty.classList.remove("hidden");
        return;
      }
      toolsEmpty.classList.add("hidden");

      assignedTools.forEach(function (tool, idx) {
        var row = document.createElement("div");
        row.className = "tool-item flex items-center gap-3 rounded-lg border border-dark/[0.08] bg-paper px-3 py-2.5 group transition-colors hover:border-dark/[0.15]";
        row.setAttribute("draggable", "true");
        row.setAttribute("data-tool-index", idx);

        var icon = categoryIcons[tool.category] || categoryIcons.utility;
        row.innerHTML =
          '<span class="cursor-grab text-muted/40 hover:text-muted transition-colors" title="Drag to reorder">' +
            '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="8" y2="6.01"/><line x1="16" y1="6" x2="16" y2="6.01"/><line x1="8" y1="12" x2="8" y2="12.01"/><line x1="16" y1="12" x2="16" y2="12.01"/><line x1="8" y1="18" x2="8" y2="18.01"/><line x1="16" y1="18" x2="16" y2="18.01"/></svg>' +
          '</span>' +
          '<span class="text-muted">' + icon + '</span>' +
          '<div class="flex-1 min-w-0">' +
            '<p class="text-sm font-medium text-dark">' + tool.name + '</p>' +
            '<p class="text-xs text-muted truncate">' + tool.description + '</p>' +
          '</div>' +
          '<span class="rounded-full bg-subtle px-2 py-0.5 text-[10px] font-medium text-muted uppercase tracking-wider">' + tool.category + '</span>' +
          '<button type="button" class="remove-tool-btn flex h-7 w-7 items-center justify-center rounded-md text-muted/40 hover:bg-coral/10 hover:text-coral transition-colors opacity-0 group-hover:opacity-100 cursor-pointer" title="Remove tool" data-tool-index="' + idx + '">' +
            '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
          '</button>';

        toolsList.appendChild(row);

        /* Drag events */
        row.addEventListener("dragstart", function (e) {
          dragIndex = idx;
          row.classList.add("opacity-50");
          e.dataTransfer.effectAllowed = "move";
        });
        row.addEventListener("dragend", function () {
          row.classList.remove("opacity-50");
          dragIndex = null;
          /* Remove all drag-over highlights */
          toolsList.querySelectorAll(".tool-item").forEach(function (el) {
            el.classList.remove("border-coral");
          });
        });
        row.addEventListener("dragover", function (e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
          row.classList.add("border-coral");
        });
        row.addEventListener("dragleave", function () {
          row.classList.remove("border-coral");
        });
        row.addEventListener("drop", function (e) {
          e.preventDefault();
          row.classList.remove("border-coral");
          var dropIdx = parseInt(row.getAttribute("data-tool-index"), 10);
          if (dragIndex !== null && dragIndex !== dropIdx) {
            var moved = assignedTools.splice(dragIndex, 1)[0];
            assignedTools.splice(dropIdx, 0, moved);
            renderToolsList();
          }
        });
      });

      /* Remove buttons */
      toolsList.querySelectorAll(".remove-tool-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          var idx = parseInt(btn.getAttribute("data-tool-index"), 10);
          assignedTools.splice(idx, 1);
          renderToolsList();
        });
      });
    }

    /* Fetch available tools and open modal */
    function openToolSelector() {
      toolSelectorModal.showModal();
      toolSearch.value = "";

      if (availableTools.length > 0) {
        renderToolSelectorItems("");
        return;
      }

      toolSelectorList.innerHTML = '<p class="text-sm text-muted text-center py-4">Loading tools...</p>';
      fetch("/api/tools")
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (tools) {
          availableTools = tools;
          renderToolSelectorItems("");
        })
        .catch(function () {
          toolSelectorList.innerHTML = '<p class="text-sm text-coral text-center py-4">Failed to load tools.</p>';
        });
    }

    function renderToolSelectorItems(query) {
      var q = query.toLowerCase();
      toolSelectorList.innerHTML = "";

      var filtered = availableTools.filter(function (t) {
        /* Exclude already-assigned tools */
        for (var i = 0; i < assignedTools.length; i++) {
          if (assignedTools[i].id === t.id) return false;
        }
        if (!q) return true;
        return t.name.toLowerCase().indexOf(q) !== -1 ||
               t.description.toLowerCase().indexOf(q) !== -1 ||
               t.category.toLowerCase().indexOf(q) !== -1;
      });

      if (filtered.length === 0) {
        toolSelectorList.innerHTML = '<p class="text-sm text-muted text-center py-4">No matching tools available.</p>';
        return;
      }

      filtered.forEach(function (tool) {
        var icon = categoryIcons[tool.category] || categoryIcons.utility;
        var item = document.createElement("button");
        item.type = "button";
        item.className = "flex items-center gap-3 w-full rounded-lg px-3 py-2.5 text-left hover:bg-subtle/80 transition-colors cursor-pointer";
        item.innerHTML =
          '<span class="text-muted">' + icon + '</span>' +
          '<div class="flex-1 min-w-0">' +
            '<p class="text-sm font-medium text-dark">' + tool.name + '</p>' +
            '<p class="text-xs text-muted truncate">' + tool.description + '</p>' +
          '</div>' +
          '<span class="rounded-full bg-subtle px-2 py-0.5 text-[10px] font-medium text-muted uppercase tracking-wider">' + tool.category + '</span>';

        item.addEventListener("click", function () {
          assignedTools.push({ id: tool.id, name: tool.name, description: tool.description, category: tool.category });
          renderToolsList();
          toolSelectorModal.close();
        });

        toolSelectorList.appendChild(item);
      });
    }

    if (addToolBtn) {
      addToolBtn.addEventListener("click", openToolSelector);
    }
    if (toolSearch) {
      toolSearch.addEventListener("input", function () {
        renderToolSelectorItems(toolSearch.value);
      });
    }

    /* ------------------------------------------------------------------ */
    /* Handoffs management                                                 */
    /* ------------------------------------------------------------------ */
    function renderHandoffsList() {
      var items = handoffsList.querySelectorAll(".handoff-item");
      items.forEach(function (el) { el.remove(); });

      if (assignedHandoffs.length === 0) {
        handoffsEmpty.classList.remove("hidden");
        return;
      }
      handoffsEmpty.classList.add("hidden");

      assignedHandoffs.forEach(function (agent, idx) {
        var row = document.createElement("div");
        row.className = "handoff-item flex items-center gap-3 rounded-lg border border-dark/[0.08] bg-paper px-3 py-2.5 group transition-colors hover:border-dark/[0.15]";
        row.innerHTML =
          '<span class="flex h-8 w-8 items-center justify-center rounded-full bg-zen-blue/10 text-zen-blue text-xs font-semibold">' +
            (agent.name ? agent.name.charAt(0).toUpperCase() : "A") +
          '</span>' +
          '<div class="flex-1 min-w-0">' +
            '<p class="text-sm font-medium text-dark">' + agent.name + '</p>' +
            '<p class="text-xs text-muted truncate">' + (agent.description || "No description") + '</p>' +
          '</div>' +
          '<button type="button" class="remove-handoff-btn flex h-7 w-7 items-center justify-center rounded-md text-muted/40 hover:bg-coral/10 hover:text-coral transition-colors opacity-0 group-hover:opacity-100 cursor-pointer" title="Remove handoff" data-handoff-index="' + idx + '">' +
            '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
          '</button>';

        handoffsList.appendChild(row);
      });

      handoffsList.querySelectorAll(".remove-handoff-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          var idx = parseInt(btn.getAttribute("data-handoff-index"), 10);
          assignedHandoffs.splice(idx, 1);
          renderHandoffsList();
        });
      });
    }

    function openHandoffSelector() {
      handoffSelectorModal.showModal();
      handoffSearch.value = "";

      if (projectAgents.length > 0) {
        renderHandoffSelectorItems("");
        return;
      }

      handoffSelectorList.innerHTML = '<p class="text-sm text-muted text-center py-4">Loading agents...</p>';
      var projectId = currentAgent ? currentAgent.project_id : "";
      var url = projectId ? "/api/agents?project_id=" + encodeURIComponent(projectId) : "/api/agents";
      fetch(url)
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (agents) {
          projectAgents = agents;
          renderHandoffSelectorItems("");
        })
        .catch(function () {
          handoffSelectorList.innerHTML = '<p class="text-sm text-coral text-center py-4">Failed to load agents.</p>';
        });
    }

    function renderHandoffSelectorItems(query) {
      var q = query.toLowerCase();
      handoffSelectorList.innerHTML = "";

      var filtered = projectAgents.filter(function (a) {
        /* Exclude self */
        if (a.id === agentId) return false;
        /* Exclude already-assigned handoffs */
        for (var i = 0; i < assignedHandoffs.length; i++) {
          if (assignedHandoffs[i].id === a.id) return false;
        }
        if (!q) return true;
        return a.name.toLowerCase().indexOf(q) !== -1 ||
               (a.description || "").toLowerCase().indexOf(q) !== -1;
      });

      if (filtered.length === 0) {
        handoffSelectorList.innerHTML = '<p class="text-sm text-muted text-center py-4">No matching agents available.</p>';
        return;
      }

      filtered.forEach(function (agent) {
        var item = document.createElement("button");
        item.type = "button";
        item.className = "flex items-center gap-3 w-full rounded-lg px-3 py-2.5 text-left hover:bg-subtle/80 transition-colors cursor-pointer";
        item.innerHTML =
          '<span class="flex h-8 w-8 items-center justify-center rounded-full bg-zen-blue/10 text-zen-blue text-xs font-semibold">' +
            (agent.name ? agent.name.charAt(0).toUpperCase() : "A") +
          '</span>' +
          '<div class="flex-1 min-w-0">' +
            '<p class="text-sm font-medium text-dark">' + agent.name + '</p>' +
            '<p class="text-xs text-muted truncate">' + (agent.description || "No description") + '</p>' +
          '</div>';

        item.addEventListener("click", function () {
          assignedHandoffs.push({ id: agent.id, name: agent.name, description: agent.description || "" });
          renderHandoffsList();
          handoffSelectorModal.close();
        });

        handoffSelectorList.appendChild(item);
      });
    }

    if (addHandoffBtn) {
      addHandoffBtn.addEventListener("click", openHandoffSelector);
    }
    if (handoffSearch) {
      handoffSearch.addEventListener("input", function () {
        renderHandoffSelectorItems(handoffSearch.value);
      });
    }

    /* ------------------------------------------------------------------ */
    /* Load agent data                                                     */
    /* ------------------------------------------------------------------ */
    function findProviderIdByName(providerName) {
      if (!providerName) return "";
      for (var i = 0; i < allProviders.length; i++) {
        if (allProviders[i].provider_type === providerName ||
            allProviders[i].name === providerName ||
            allProviders[i].id === providerName) {
          return allProviders[i].id;
        }
      }
      return "";
    }

    function showAgent(agent) {
      currentAgent = agent;
      loadingState.classList.add("hidden");
      editorContent.classList.remove("hidden");

      agentNameHeading.textContent = agent.name;

      /* Basic tab */
      nameInput.value = agent.name;
      descriptionInput.value = agent.description || "";
      instructionsInput.value = agent.instructions || "";

      /* Model tab */
      if (agent.temperature != null) {
        temperatureSlider.value = agent.temperature;
        temperatureValue.textContent = parseFloat(agent.temperature).toFixed(1);
      }
      if (agent.max_tokens != null) {
        maxTokensInput.value = agent.max_tokens;
      }

      /* Tools tab  parse tools_json */
      try {
        var tools = JSON.parse(agent.tools_json || "[]");
        assignedTools = Array.isArray(tools) ? tools : [];
      } catch (e) {
        assignedTools = [];
      }
      renderToolsList();

      /* Handoffs tab  parse handoffs_json */
      try {
        var handoffs = JSON.parse(agent.handoffs_json || "[]");
        assignedHandoffs = Array.isArray(handoffs) ? handoffs : [];
      } catch (e) {
        assignedHandoffs = [];
      }
      renderHandoffsList();

      /* Hooks tab  parse hooks_json */
      try {
        var hooks = JSON.parse(agent.hooks_json || "{}");
        if (hooks && typeof hooks === "object") {
          hookPoints.forEach(function (hp) {
            var input = document.querySelector('[data-hook-input="' + hp + '"]');
            if (input && hooks[hp]) {
              input.value = hooks[hp];
            }
          });
        }
      } catch (e) {
        /* ignore parse errors */
      }

      /* Advanced tab */
      if (agent.max_steps != null) {
        maxStepsSlider.value = agent.max_steps;
        maxStepsValue.textContent = agent.max_steps;
      }

      if (agent.output_type_json && agent.output_type_json !== "{}") {
        try {
          outputTypeTextarea.value = JSON.stringify(JSON.parse(agent.output_type_json), null, 2);
        } catch (e) {
          outputTypeTextarea.value = agent.output_type_json;
        }
      }

      /* Memory and context toggles  stored in hooks_json as meta flags */
      try {
        var hooksData = JSON.parse(agent.hooks_json || "{}");
        if (hooksData._memory_enabled) {
          memoryEnabled = true;
          setToggle(toggleMemory, true);
        }
        if (hooksData._context_enabled) {
          contextEnabled = true;
          setToggle(toggleContext, true);
        }
      } catch (e) {
        /* ignore */
      }

      /* Populate providers, then models. */
      fetch("/api/providers")
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (providers) {
          allProviders = providers;
          providerSelect.innerHTML = '<option value="">Select a provider...</option>';
          providers.forEach(function (p) {
            var opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = p.name + " (" + p.provider_type + ")";
            providerSelect.appendChild(opt);
          });

          var matchedId = findProviderIdByName(agent.model_provider);
          if (matchedId) {
            providerSelect.value = matchedId;
            populateModels(matchedId, agent.model_name);
          }
        })
        .catch(function () {});

      /* Update breadcrumb */
      var allSpans = document.querySelectorAll("nav span");
      allSpans.forEach(function (span) {
        if (span.textContent.trim() === "Loading...") {
          span.textContent = agent.name;
        }
      });
    }

    function showError() {
      loadingState.classList.add("hidden");
      errorState.classList.remove("hidden");
    }

    function fetchAgent() {
      fetch("/api/agents/" + agentId)
        .then(function (res) {
          if (!res.ok) throw new Error("Not found");
          return res.json();
        })
        .then(showAgent)
        .catch(showError);
    }

    /* ------------------------------------------------------------------ */
    /* Save agent                                                          */
    /* ------------------------------------------------------------------ */
    if (saveBtn) {
      saveBtn.addEventListener("click", function () {
        nameError.classList.add("hidden");

        var name = nameInput.value.trim();
        if (!name) {
          nameError.classList.remove("hidden");
          document.querySelector('[data-tab="basic"]').click();
          nameInput.focus();
          return;
        }

        /* Resolve provider ID back to provider_type for storage */
        var provId = providerSelect.value;
        var modelProvider = "";
        for (var i = 0; i < allProviders.length; i++) {
          if (allProviders[i].id === provId) {
            modelProvider = allProviders[i].provider_type;
            break;
          }
        }

        /* Validate output_type JSON before saving */
        if (!validateOutputTypeJson()) {
          document.querySelector('[data-tab="advanced"]').click();
          outputTypeTextarea.focus();
          return;
        }

        /* Build hooks_json from hook inputs */
        var hooksObj = {};
        hookPoints.forEach(function (hp) {
          var input = document.querySelector('[data-hook-input="' + hp + '"]');
          if (input && input.value.trim()) {
            hooksObj[hp] = input.value.trim();
          }
        });
        /* Store toggle state as meta flags */
        if (memoryEnabled) hooksObj._memory_enabled = true;
        if (contextEnabled) hooksObj._context_enabled = true;

        var outputTypeVal = outputTypeTextarea.value.trim() || "{}";

        var body = {
          name: name,
          description: descriptionInput.value.trim(),
          instructions: instructionsInput.value,
          model_provider: modelProvider,
          model_name: modelSelect.value || "",
          temperature: parseFloat(temperatureSlider.value),
          max_steps: parseInt(maxStepsSlider.value, 10),
          tools_json: JSON.stringify(assignedTools),
          handoffs_json: JSON.stringify(assignedHandoffs),
          hooks_json: JSON.stringify(hooksObj),
          output_type_json: outputTypeVal,
        };

        var maxTokens = maxTokensInput.value.trim();
        if (maxTokens !== "") {
          body.max_tokens = parseInt(maxTokens, 10);
        }

        saveBtn.disabled = true;
        saveStatus.textContent = "Saving...";
        saveStatus.classList.remove("hidden", "text-zen-green", "text-coral");
        saveStatus.classList.add("text-muted");

        fetch("/api/agents/" + agentId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to save"); });
            return res.json();
          })
          .then(function (agent) {
            currentAgent = agent;
            agentNameHeading.textContent = agent.name;

            saveStatus.textContent = "Saved";
            saveStatus.classList.remove("text-muted", "text-coral");
            saveStatus.classList.add("text-zen-green");
            setTimeout(function () { saveStatus.classList.add("hidden"); }, 2000);

            /* Update breadcrumb */
            var allSpans = document.querySelectorAll("nav span");
            allSpans.forEach(function (span) {
              if (span.textContent.trim() === currentAgent.name || span.textContent.trim() === "Loading...") {
                span.textContent = agent.name;
              }
            });
          })
          .catch(function (err) {
            saveStatus.textContent = err.message;
            saveStatus.classList.remove("text-muted", "text-zen-green");
            saveStatus.classList.add("text-coral");
          })
          .finally(function () {
            saveBtn.disabled = false;
          });
      });
    }

    /* ------------------------------------------------------------------ */
    /* Keyboard shortcut: Ctrl/Cmd + S to save                             */
    /* ------------------------------------------------------------------ */
    document.addEventListener("keydown", function (e) {
      if ((e.ctrlKey || e.metaKey) && e.key === "s") {
        e.preventDefault();
        if (saveBtn && !saveBtn.disabled) saveBtn.click();
      }
    });

    /* ------------------------------------------------------------------ */
    /* Init                                                                */
    /* ------------------------------------------------------------------ */
    fetchAgent();
  })();
</script>
