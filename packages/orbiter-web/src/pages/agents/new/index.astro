---
import PageLayout from "../../../layouts/PageLayout.astro";
import Button from "../../../components/Button.astro";

const breadcrumbs = [
  { label: "Agents", href: "/agents" },
  { label: "New Agent" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const saveIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>';
---

<PageLayout
  title="New Agent"
  description="Create a new AI agent"
  activeSection="agents"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-3xl mx-auto">
    <!-- Back link -->
    <a href="/agents" class="inline-flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors mb-6">
      <span set:html={backIcon} />
      Back to Agents
    </a>

    <h1 class="text-2xl font-semibold text-dark mb-2">Create Agent</h1>
    <p class="text-sm text-muted mb-8">Configure a new AI agent with instructions, model, and tools.</p>

    <form id="create-agent-form" class="flex flex-col gap-6">
      <!-- Project -->
      <div class="flex flex-col gap-1.5">
        <label for="agent-project" class="text-sm font-medium text-dark">
          Project <span class="text-coral">*</span>
        </label>
        <select
          id="agent-project"
          name="project_id"
          required
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer"
        >
          <option value="">Loading projects...</option>
        </select>
        <p class="text-xs text-muted">Agents must belong to a project. <a href="/projects" class="text-coral hover:underline">Create a project</a> first if needed.</p>
      </div>

      <!-- Name -->
      <div class="flex flex-col gap-1.5">
        <label for="agent-name" class="text-sm font-medium text-dark">
          Name <span class="text-coral">*</span>
        </label>
        <input
          type="text"
          id="agent-name"
          name="name"
          required
          placeholder="My Agent"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        />
      </div>

      <!-- Description -->
      <div class="flex flex-col gap-1.5">
        <label for="agent-description" class="text-sm font-medium text-dark">Description</label>
        <input
          type="text"
          id="agent-description"
          name="description"
          placeholder="A brief description of what this agent does"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        />
      </div>

      <!-- Instructions -->
      <div class="flex flex-col gap-1.5">
        <label for="agent-instructions" class="text-sm font-medium text-dark">Instructions (System Prompt)</label>
        <textarea
          id="agent-instructions"
          name="instructions"
          rows="6"
          placeholder="You are a helpful assistant that..."
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-y font-mono"
        ></textarea>
        <p class="text-xs text-muted">Define the agent's behavior and constraints. You can refine this later in the editor.</p>
      </div>

      <!-- Model -->
      <div class="rounded-xl border border-dark/[0.08] bg-paper p-5">
        <h2 class="text-sm font-semibold text-dark mb-4">Model Configuration</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="flex flex-col gap-1.5">
            <label for="model-provider" class="text-xs font-medium text-dark">Provider</label>
            <select
              id="model-provider"
              name="model_provider"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer"
            >
              <option value="">Select provider...</option>
              <option value="openai">OpenAI</option>
              <option value="anthropic">Anthropic</option>
              <option value="google">Google</option>
              <option value="ollama">Ollama</option>
            </select>
          </div>
          <div class="flex flex-col gap-1.5">
            <label for="model-name" class="text-xs font-medium text-dark">Model</label>
            <input
              type="text"
              id="model-name"
              name="model_name"
              placeholder="e.g. gpt-4o, claude-sonnet-4-20250514"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
            />
          </div>
        </div>
      </div>

      <!-- Error display -->
      <div id="create-error" class="text-sm text-coral hidden"></div>

      <!-- Actions -->
      <div class="flex items-center justify-end gap-3 pt-2">
        <Button href="/agents" variant="default">Cancel</Button>
        <Button variant="primary" type="submit" id="submit-btn">
          <span set:html={saveIcon} />
          Create Agent
        </Button>
      </div>
    </form>
  </div>
</PageLayout>

<script is:inline>
  (function () {
    var form = document.getElementById("create-agent-form");
    var projectSelect = document.getElementById("agent-project");
    var createError = document.getElementById("create-error");
    var submitBtn = document.getElementById("submit-btn");

    /* Load projects for the dropdown */
    fetch("/api/v1/projects")
      .then(function (res) {
        if (!res.ok) throw new Error("Failed to load projects");
        return res.json();
      })
      .then(function (body) {
        var projects = body.data || body;
        projectSelect.innerHTML = '<option value="">Select a project...</option>';
        if (!projects || projects.length === 0) {
          projectSelect.innerHTML = '<option value="">No projects â€” create one first</option>';
          return;
        }
        projects.forEach(function (p) {
          var opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.name;
          projectSelect.appendChild(opt);
        });
      })
      .catch(function () {
        projectSelect.innerHTML = '<option value="">Failed to load projects</option>';
      });

    /* Form submit */
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      createError.classList.add("hidden");

      var formData = new FormData(form);
      var name = (formData.get("name") || "").toString().trim();
      var projectId = (formData.get("project_id") || "").toString().trim();
      var description = (formData.get("description") || "").toString().trim();
      var instructions = (formData.get("instructions") || "").toString().trim();
      var modelProvider = (formData.get("model_provider") || "").toString().trim();
      var modelName = (formData.get("model_name") || "").toString().trim();

      if (!name) {
        createError.textContent = "Agent name is required";
        createError.classList.remove("hidden");
        return;
      }
      if (!projectId) {
        createError.textContent = "Please select a project";
        createError.classList.remove("hidden");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Creating...";

      fetch("/api/v1/agents", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: name,
          project_id: projectId,
          description: description,
          instructions: instructions,
          model_provider: modelProvider,
          model_name: modelName,
        }),
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to create agent"); });
          return res.json();
        })
        .then(function (agent) {
          window.location.href = "/agents/" + agent.id + "/edit";
        })
        .catch(function (err) {
          createError.textContent = err.message;
          createError.classList.remove("hidden");
        })
        .finally(function () {
          submitBtn.disabled = false;
          submitBtn.textContent = "Create Agent";
        });
    });
  })();
</script>
