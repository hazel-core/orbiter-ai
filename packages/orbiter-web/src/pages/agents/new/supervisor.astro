---
import PageLayout from "../../../layouts/PageLayout.astro";
import Button from "../../../components/Button.astro";

const breadcrumbs = [
  { label: "Agents", href: "/agents" },
  { label: "New Supervisor" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const checkIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
const removeIcon = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
const arrowRightIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>';
const arrowLeftIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const searchIcon = '<svg class="h-4 w-4 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
const settingsIcon = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>';
const playIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
---

<PageLayout
  title="Create Supervisor"
  description="Build a supervisor agent with sub-agent delegation"
  activeSection="agents"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Back link -->
    <a href="/agents" class="inline-flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors mb-6">
      <span set:html={backIcon} />
      Back to Agents
    </a>

    <h1 class="text-2xl font-semibold text-dark mb-2">Create Supervisor Agent</h1>
    <p class="text-sm text-muted mb-8">Build a supervisor that delegates tasks to sub-agents.</p>

    <!-- Step indicator -->
    <div class="flex items-center gap-2 mb-8">
      <div id="step-1-indicator" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-coral/10 text-coral text-xs font-medium transition-all">
        <span class="flex h-5 w-5 items-center justify-center rounded-full bg-coral text-paper text-[10px] font-bold">1</span>
        Supervisor
      </div>
      <div class="h-px w-6 bg-dark/[0.12]"></div>
      <div id="step-2-indicator" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-subtle text-muted text-xs font-medium transition-all">
        <span class="flex h-5 w-5 items-center justify-center rounded-full bg-dark/[0.12] text-muted text-[10px] font-bold">2</span>
        Sub-Agents
      </div>
      <div class="h-px w-6 bg-dark/[0.12]"></div>
      <div id="step-3-indicator" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-subtle text-muted text-xs font-medium transition-all">
        <span class="flex h-5 w-5 items-center justify-center rounded-full bg-dark/[0.12] text-muted text-[10px] font-bold">3</span>
        Review
      </div>
    </div>

    <!-- ============================================== -->
    <!-- STEP 1: Select or Create Supervisor Agent      -->
    <!-- ============================================== -->
    <div id="step-1" class="step-panel">
      <div class="rounded-xl border border-dark/[0.08] bg-paper p-6">
        <h2 class="text-lg font-semibold text-dark mb-1">Choose Supervisor Agent</h2>
        <p class="text-sm text-muted mb-6">Select an existing agent or create a new one to act as the supervisor.</p>

        <!-- Toggle: existing vs new -->
        <div class="flex gap-2 mb-6">
          <button type="button" id="mode-existing" class="px-4 py-2 rounded-lg text-sm font-medium bg-coral/10 text-coral border border-coral/20 transition-all cursor-pointer">
            Select Existing
          </button>
          <button type="button" id="mode-new" class="px-4 py-2 rounded-lg text-sm font-medium bg-subtle text-muted border border-transparent hover:border-dark/[0.08] transition-all cursor-pointer">
            Create New
          </button>
        </div>

        <!-- Existing agent selection -->
        <div id="existing-agent-section">
          <div class="relative mb-4">
            <span class="absolute left-3 top-1/2 -translate-y-1/2" set:html={searchIcon}></span>
            <input
              type="text"
              id="supervisor-search"
              placeholder="Search agents..."
              class="w-full bg-paper border border-dark/[0.08] rounded-lg pl-10 pr-3 py-2 text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
            />
          </div>
          <div id="supervisor-list" class="space-y-2 max-h-64 overflow-y-auto">
            <p class="text-sm text-muted py-4 text-center">Loading agents...</p>
          </div>
        </div>

        <!-- New agent form -->
        <div id="new-agent-section" class="hidden space-y-4">
          <div class="flex flex-col gap-1.5">
            <label for="new-agent-name" class="text-sm font-medium text-dark">
              Name <span class="text-coral">*</span>
            </label>
            <input
              type="text"
              id="new-agent-name"
              placeholder="e.g. Task Coordinator"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
            />
          </div>
          <div class="flex flex-col gap-1.5">
            <label for="new-agent-description" class="text-sm font-medium text-dark">Description</label>
            <input
              type="text"
              id="new-agent-description"
              placeholder="Coordinates work across sub-agents"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
            />
          </div>
          <div class="flex flex-col gap-1.5">
            <label for="new-agent-instructions" class="text-sm font-medium text-dark">Instructions</label>
            <textarea
              id="new-agent-instructions"
              rows="4"
              placeholder="You are a supervisor agent that coordinates tasks across your sub-agents..."
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all resize-y"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Step 1 navigation -->
      <div class="flex justify-end mt-6">
        <Button variant="primary" id="step-1-next" class="text-sm opacity-50 pointer-events-none">
          Next: Sub-Agents
          <span set:html={arrowRightIcon} />
        </Button>
      </div>
    </div>

    <!-- ============================================== -->
    <!-- STEP 2: Select Sub-Agents                      -->
    <!-- ============================================== -->
    <div id="step-2" class="step-panel hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left: Available agents -->
        <div class="rounded-xl border border-dark/[0.08] bg-paper p-6">
          <h2 class="text-lg font-semibold text-dark mb-1">Available Agents</h2>
          <p class="text-sm text-muted mb-4">Select agents to delegate tasks to.</p>

          <div class="relative mb-4">
            <span class="absolute left-3 top-1/2 -translate-y-1/2" set:html={searchIcon}></span>
            <input
              type="text"
              id="sub-agent-search"
              placeholder="Search agents..."
              class="w-full bg-paper border border-dark/[0.08] rounded-lg pl-10 pr-3 py-2 text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
            />
          </div>
          <div id="available-agents-list" class="space-y-2 max-h-80 overflow-y-auto">
            <p class="text-sm text-muted py-4 text-center">Loading agents...</p>
          </div>
        </div>

        <!-- Right: Selected sub-agents + preview -->
        <div class="space-y-6">
          <!-- Selected list -->
          <div class="rounded-xl border border-dark/[0.08] bg-paper p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-dark">Selected Sub-Agents</h2>
              <span id="selected-count" class="text-xs font-medium text-muted bg-subtle rounded-full px-2 py-0.5">0</span>
            </div>
            <div id="selected-agents-list" class="space-y-2 max-h-48 overflow-y-auto">
              <div id="no-sub-agents-msg" class="rounded-lg border border-dashed border-dark/[0.12] bg-subtle/50 py-6 text-center">
                <p class="text-sm text-muted">No sub-agents selected.</p>
                <p class="text-xs text-muted/60 mt-1">Click agents on the left to add them.</p>
              </div>
            </div>
          </div>

          <!-- Visual preview -->
          <div class="rounded-xl border border-dark/[0.08] bg-subtle/30 p-6">
            <h3 class="text-sm font-medium text-dark mb-4">Hierarchy Preview</h3>
            <div id="hierarchy-preview" class="flex flex-col items-center gap-0">
              <p class="text-xs text-muted text-center py-4">Select a supervisor and sub-agents to see the preview.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2 navigation -->
      <div class="flex justify-between mt-6">
        <Button variant="bordered" id="step-2-back" class="text-sm">
          <span set:html={arrowLeftIcon} />
          Back
        </Button>
        <Button variant="primary" id="step-2-next" class="text-sm opacity-50 pointer-events-none">
          Next: Review
          <span set:html={arrowRightIcon} />
        </Button>
      </div>
    </div>

    <!-- ============================================== -->
    <!-- STEP 3: Review & Configure Routing Rules       -->
    <!-- ============================================== -->
    <div id="step-3" class="step-panel hidden">
      <div class="space-y-6">
        <!-- Summary card -->
        <div class="rounded-xl border border-dark/[0.08] bg-paper p-6">
          <h2 class="text-lg font-semibold text-dark mb-4">Review Configuration</h2>

          <!-- Supervisor info -->
          <div class="mb-6">
            <h3 class="text-sm font-medium text-muted mb-2">Supervisor</h3>
            <div id="review-supervisor" class="flex items-center gap-3 rounded-lg bg-coral/5 border border-coral/20 p-3">
              <span class="flex h-8 w-8 items-center justify-center rounded-lg bg-coral/10 text-coral text-sm font-bold">S</span>
              <div>
                <p id="review-supervisor-name" class="text-sm font-semibold text-dark"></p>
                <p id="review-supervisor-desc" class="text-xs text-muted"></p>
              </div>
            </div>
          </div>

          <!-- Sub-agents with routing rules -->
          <div>
            <h3 class="text-sm font-medium text-muted mb-2">Sub-Agents &amp; Routing Rules</h3>
            <div id="review-sub-agents" class="space-y-3"></div>
          </div>
        </div>

        <!-- Final hierarchy preview (larger) -->
        <div class="rounded-xl border border-dark/[0.08] bg-subtle/30 p-6">
          <h3 class="text-sm font-medium text-dark mb-4">Delegation Hierarchy</h3>
          <div id="final-preview" class="flex flex-col items-center"></div>
        </div>
      </div>

      <!-- Step 3 navigation -->
      <div class="flex justify-between mt-6">
        <Button variant="bordered" id="step-3-back" class="text-sm">
          <span set:html={arrowLeftIcon} />
          Back
        </Button>
        <div class="flex gap-3">
          <Button variant="bordered" id="test-btn" class="text-sm">
            <span set:html={playIcon} />
            Test in Playground
          </Button>
          <Button variant="primary" id="create-btn" class="text-sm">
            <span set:html={checkIcon} />
            Create Supervisor
          </Button>
        </div>
      </div>
    </div>

    <!-- Status toast -->
    <div id="status-toast" class="fixed bottom-6 right-6 z-50 hidden">
      <div class="rounded-lg border border-dark/[0.08] bg-paper shadow-lg px-4 py-3 flex items-center gap-3">
        <span id="toast-icon"></span>
        <span id="toast-message" class="text-sm text-dark"></span>
      </div>
    </div>
  </div>
</PageLayout>

<style>
  .step-panel { transition: opacity 200ms ease; }
  .agent-card { @apply flex items-center gap-3 rounded-lg border border-dark/[0.08] bg-paper p-3 cursor-pointer transition-all duration-200 hover:border-coral/30 hover:bg-coral/[0.02]; }
  .agent-card.selected { @apply border-coral/40 bg-coral/5; }
  .agent-card.disabled { @apply opacity-40 pointer-events-none; }

  /* Hierarchy preview lines */
  .hierarchy-line {
    width: 2px;
    height: 24px;
    background: var(--zen-blue, #6287f5);
    opacity: 0.6;
  }
  .hierarchy-branch {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 12px;
    padding-top: 8px;
  }
  .hierarchy-branch::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 2px;
    height: 8px;
    background: var(--zen-blue, #6287f5);
    opacity: 0.6;
  }
  .hierarchy-connector {
    position: absolute;
    top: 8px;
    height: 2px;
    background: var(--zen-blue, #6287f5);
    opacity: 0.6;
  }
  .sub-agent-branch {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
  }
  .sub-agent-branch .branch-line {
    width: 2px;
    height: 16px;
    background: var(--zen-blue, #6287f5);
    opacity: 0.6;
  }
</style>

<script is:inline>
  /* ================================================================ */
  /* State                                                              */
  /* ================================================================ */
  let allAgents = [];
  let supervisorId = null;
  let supervisorData = null;   // { id, name, description, isNew }
  let selectedSubAgents = [];  // [{ id, name, description, routing_rule }]
  let currentStep = 1;
  let creationMode = "existing"; // "existing" | "new"

  /* ================================================================ */
  /* DOM refs                                                           */
  /* ================================================================ */
  const step1 = document.getElementById("step-1");
  const step2 = document.getElementById("step-2");
  const step3 = document.getElementById("step-3");
  const step1Ind = document.getElementById("step-1-indicator");
  const step2Ind = document.getElementById("step-2-indicator");
  const step3Ind = document.getElementById("step-3-indicator");
  const step1Next = document.getElementById("step-1-next");
  const step2Next = document.getElementById("step-2-next");
  const step2Back = document.getElementById("step-2-back");
  const step3Back = document.getElementById("step-3-back");
  const modeExisting = document.getElementById("mode-existing");
  const modeNew = document.getElementById("mode-new");
  const existingSection = document.getElementById("existing-agent-section");
  const newSection = document.getElementById("new-agent-section");
  const supervisorSearch = document.getElementById("supervisor-search");
  const supervisorList = document.getElementById("supervisor-list");
  const subAgentSearch = document.getElementById("sub-agent-search");
  const availableAgentsList = document.getElementById("available-agents-list");
  const selectedAgentsList = document.getElementById("selected-agents-list");
  const selectedCount = document.getElementById("selected-count");
  const hierarchyPreview = document.getElementById("hierarchy-preview");
  const finalPreview = document.getElementById("final-preview");
  const createBtn = document.getElementById("create-btn");
  const testBtn = document.getElementById("test-btn");

  /* ================================================================ */
  /* Init                                                               */
  /* ================================================================ */
  loadAgents();

  /* ================================================================ */
  /* Load agents from API                                               */
  /* ================================================================ */
  async function loadAgents() {
    try {
      const resp = await fetch("/api/v1/agents");
      if (!resp.ok) throw new Error("Failed to load agents");
      const body = await resp.json();
      allAgents = body.data ?? body;
      renderSupervisorList();
    } catch (err) {
      supervisorList.innerHTML = '<p class="text-sm text-coral py-4 text-center">Failed to load agents.</p>';
    }
  }

  /* ================================================================ */
  /* Step 1: Supervisor selection                                       */
  /* ================================================================ */
  function renderSupervisorList(filter = "") {
    const filtered = allAgents.filter(function(a) {
      return a.name.toLowerCase().includes(filter.toLowerCase()) ||
             a.description.toLowerCase().includes(filter.toLowerCase());
    });

    if (filtered.length === 0) {
      supervisorList.innerHTML = '<p class="text-sm text-muted py-4 text-center">No agents found.</p>';
      return;
    }

    supervisorList.innerHTML = "";
    filtered.forEach(function(agent) {
      const card = document.createElement("div");
      card.className = "agent-card" + (supervisorId === agent.id ? " selected" : "");
      card.innerHTML =
        '<span class="flex h-8 w-8 items-center justify-center rounded-lg bg-coral/10 text-coral text-sm font-bold flex-shrink-0">' +
          agent.name.charAt(0).toUpperCase() +
        '</span>' +
        '<div class="min-w-0 flex-1">' +
          '<p class="text-sm font-medium text-dark truncate">' + escapeHtml(agent.name) + '</p>' +
          '<p class="text-xs text-muted truncate">' + escapeHtml(agent.description || "No description") + '</p>' +
        '</div>' +
        (supervisorId === agent.id
          ? '<span class="flex h-5 w-5 items-center justify-center rounded-full bg-coral text-paper">' +
              '<svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>' +
            '</span>'
          : '');
      card.addEventListener("click", function() {
        supervisorId = agent.id;
        supervisorData = { id: agent.id, name: agent.name, description: agent.description || "", isNew: false };
        renderSupervisorList(supervisorSearch.value);
        updateStep1Next();
      });
      supervisorList.appendChild(card);
    });
  }

  supervisorSearch.addEventListener("input", function() {
    renderSupervisorList(this.value);
  });

  /* Mode toggle: existing vs new */
  modeExisting.addEventListener("click", function() {
    creationMode = "existing";
    modeExisting.className = "px-4 py-2 rounded-lg text-sm font-medium bg-coral/10 text-coral border border-coral/20 transition-all cursor-pointer";
    modeNew.className = "px-4 py-2 rounded-lg text-sm font-medium bg-subtle text-muted border border-transparent hover:border-dark/[0.08] transition-all cursor-pointer";
    existingSection.classList.remove("hidden");
    newSection.classList.add("hidden");
    /* Reset new agent state */
    supervisorData = supervisorId ? { id: supervisorId, name: allAgents.find(function(a) { return a.id === supervisorId; })?.name || "", description: "", isNew: false } : null;
    updateStep1Next();
  });

  modeNew.addEventListener("click", function() {
    creationMode = "new";
    modeNew.className = "px-4 py-2 rounded-lg text-sm font-medium bg-coral/10 text-coral border border-coral/20 transition-all cursor-pointer";
    modeExisting.className = "px-4 py-2 rounded-lg text-sm font-medium bg-subtle text-muted border border-transparent hover:border-dark/[0.08] transition-all cursor-pointer";
    existingSection.classList.add("hidden");
    newSection.classList.remove("hidden");
    supervisorId = null;
    supervisorData = null;
    updateStep1Next();
  });

  /* New agent name input */
  document.getElementById("new-agent-name").addEventListener("input", function() {
    if (creationMode === "new" && this.value.trim()) {
      supervisorData = {
        id: null,
        name: this.value.trim(),
        description: document.getElementById("new-agent-description").value.trim(),
        instructions: document.getElementById("new-agent-instructions").value.trim(),
        isNew: true,
      };
    } else if (creationMode === "new") {
      supervisorData = null;
    }
    updateStep1Next();
  });
  document.getElementById("new-agent-description").addEventListener("input", function() {
    if (supervisorData && supervisorData.isNew) {
      supervisorData.description = this.value.trim();
    }
  });
  document.getElementById("new-agent-instructions").addEventListener("input", function() {
    if (supervisorData && supervisorData.isNew) {
      supervisorData.instructions = this.value.trim();
    }
  });

  function updateStep1Next() {
    if (supervisorData) {
      step1Next.classList.remove("opacity-50", "pointer-events-none");
    } else {
      step1Next.classList.add("opacity-50", "pointer-events-none");
    }
  }

  /* ================================================================ */
  /* Step 2: Sub-agent selection                                        */
  /* ================================================================ */
  function renderAvailableAgents(filter = "") {
    const filtered = allAgents.filter(function(a) {
      /* Exclude supervisor from available list */
      if (supervisorData && !supervisorData.isNew && a.id === supervisorData.id) return false;
      return a.name.toLowerCase().includes(filter.toLowerCase()) ||
             a.description.toLowerCase().includes(filter.toLowerCase());
    });

    if (filtered.length === 0) {
      availableAgentsList.innerHTML = '<p class="text-sm text-muted py-4 text-center">No agents available.</p>';
      return;
    }

    availableAgentsList.innerHTML = "";
    filtered.forEach(function(agent) {
      const isSelected = selectedSubAgents.some(function(sa) { return sa.id === agent.id; });
      const card = document.createElement("div");
      card.className = "agent-card" + (isSelected ? " selected" : "");
      card.innerHTML =
        '<span class="flex h-8 w-8 items-center justify-center rounded-lg bg-zen-blue/10 text-zen-blue text-sm font-bold flex-shrink-0">' +
          agent.name.charAt(0).toUpperCase() +
        '</span>' +
        '<div class="min-w-0 flex-1">' +
          '<p class="text-sm font-medium text-dark truncate">' + escapeHtml(agent.name) + '</p>' +
          '<p class="text-xs text-muted truncate">' + escapeHtml(agent.description || "No description") + '</p>' +
        '</div>' +
        (isSelected
          ? '<span class="flex h-5 w-5 items-center justify-center rounded-full bg-zen-blue text-paper">' +
              '<svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>' +
            '</span>'
          : '<span class="flex h-5 w-5 items-center justify-center rounded-full border border-dark/[0.12]"></span>');
      card.addEventListener("click", function() {
        toggleSubAgent(agent);
      });
      availableAgentsList.appendChild(card);
    });
  }

  function toggleSubAgent(agent) {
    const idx = selectedSubAgents.findIndex(function(sa) { return sa.id === agent.id; });
    if (idx >= 0) {
      selectedSubAgents.splice(idx, 1);
    } else {
      selectedSubAgents.push({
        id: agent.id,
        name: agent.name,
        description: agent.description || "",
        routing_rule: "",
      });
    }
    renderAvailableAgents(subAgentSearch.value);
    renderSelectedAgents();
    renderHierarchyPreview();
    updateStep2Next();
  }

  function renderSelectedAgents() {
    selectedCount.textContent = selectedSubAgents.length;

    if (selectedSubAgents.length === 0) {
      selectedAgentsList.innerHTML =
        '<div id="no-sub-agents-msg" class="rounded-lg border border-dashed border-dark/[0.12] bg-subtle/50 py-6 text-center">' +
          '<p class="text-sm text-muted">No sub-agents selected.</p>' +
          '<p class="text-xs text-muted/60 mt-1">Click agents on the left to add them.</p>' +
        '</div>';
      return;
    }

    selectedAgentsList.innerHTML = "";
    selectedSubAgents.forEach(function(sa) {
      const item = document.createElement("div");
      item.className = "flex items-center gap-3 rounded-lg border border-zen-blue/20 bg-zen-blue/5 p-2.5";
      item.innerHTML =
        '<span class="flex h-6 w-6 items-center justify-center rounded bg-zen-blue/10 text-zen-blue text-xs font-bold flex-shrink-0">' +
          sa.name.charAt(0).toUpperCase() +
        '</span>' +
        '<span class="text-sm font-medium text-dark truncate flex-1">' + escapeHtml(sa.name) + '</span>' +
        '<button type="button" class="remove-sub-agent flex h-5 w-5 items-center justify-center rounded-full hover:bg-dark/[0.08] text-muted hover:text-coral transition-colors cursor-pointer" data-id="' + sa.id + '">' +
          '<svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
        '</button>';
      const removeBtn = item.querySelector(".remove-sub-agent");
      removeBtn.addEventListener("click", function(e) {
        e.stopPropagation();
        const removeId = this.getAttribute("data-id");
        selectedSubAgents = selectedSubAgents.filter(function(s) { return s.id !== removeId; });
        renderAvailableAgents(subAgentSearch.value);
        renderSelectedAgents();
        renderHierarchyPreview();
        updateStep2Next();
      });
      selectedAgentsList.appendChild(item);
    });
  }

  subAgentSearch.addEventListener("input", function() {
    renderAvailableAgents(this.value);
  });

  function updateStep2Next() {
    if (selectedSubAgents.length > 0) {
      step2Next.classList.remove("opacity-50", "pointer-events-none");
    } else {
      step2Next.classList.add("opacity-50", "pointer-events-none");
    }
  }

  /* ================================================================ */
  /* Hierarchy preview (SVG-free â€” uses CSS boxes + lines)              */
  /* ================================================================ */
  function renderHierarchyPreview() {
    const target = hierarchyPreview;
    if (!supervisorData || selectedSubAgents.length === 0) {
      target.innerHTML = '<p class="text-xs text-muted text-center py-4">Select a supervisor and sub-agents to see the preview.</p>';
      return;
    }

    target.innerHTML = "";

    /* Supervisor node */
    const supNode = document.createElement("div");
    supNode.className = "inline-flex items-center gap-2 rounded-lg border-2 border-coral/40 bg-coral/5 px-3 py-2";
    supNode.innerHTML =
      '<span class="flex h-6 w-6 items-center justify-center rounded bg-coral/10 text-coral text-xs font-bold">S</span>' +
      '<span class="text-sm font-semibold text-dark">' + escapeHtml(supervisorData.name) + '</span>';
    target.appendChild(supNode);

    /* Vertical line */
    const line = document.createElement("div");
    line.className = "hierarchy-line";
    target.appendChild(line);

    /* Branch container */
    const branch = document.createElement("div");
    branch.className = "hierarchy-branch flex-wrap justify-center";
    branch.style.position = "relative";

    selectedSubAgents.forEach(function(sa) {
      const subBranch = document.createElement("div");
      subBranch.className = "sub-agent-branch";
      const subLine = document.createElement("div");
      subLine.className = "branch-line";
      subBranch.appendChild(subLine);
      const subNode = document.createElement("div");
      subNode.className = "inline-flex items-center gap-2 rounded-lg border border-zen-blue/30 bg-zen-blue/5 px-2.5 py-1.5";
      subNode.innerHTML =
        '<span class="flex h-5 w-5 items-center justify-center rounded bg-zen-blue/10 text-zen-blue text-[10px] font-bold">' +
          sa.name.charAt(0).toUpperCase() +
        '</span>' +
        '<span class="text-xs font-medium text-dark whitespace-nowrap">' + escapeHtml(sa.name) + '</span>';
      subBranch.appendChild(subNode);
      branch.appendChild(subBranch);
    });

    target.appendChild(branch);

    /* Draw horizontal connector line using pseudo-elements (already in CSS) */
    if (selectedSubAgents.length > 1) {
      const connector = document.createElement("div");
      connector.className = "hierarchy-connector";
      /* Compute width based on number of sub-agents */
      const totalWidth = (selectedSubAgents.length - 1) * 112; /* approximate gap between items */
      connector.style.width = totalWidth + "px";
      connector.style.left = "calc(50% - " + (totalWidth / 2) + "px)";
      branch.appendChild(connector);
    }
  }

  /* ================================================================ */
  /* Step 3: Review + routing rules                                     */
  /* ================================================================ */
  function renderReview() {
    /* Supervisor info */
    document.getElementById("review-supervisor-name").textContent = supervisorData.name;
    document.getElementById("review-supervisor-desc").textContent = supervisorData.description || "No description";

    /* Sub-agents with routing rules */
    const container = document.getElementById("review-sub-agents");
    container.innerHTML = "";
    selectedSubAgents.forEach(function(sa, idx) {
      const card = document.createElement("div");
      card.className = "rounded-lg border border-dark/[0.08] bg-paper p-4 space-y-3";
      card.innerHTML =
        '<div class="flex items-center gap-3">' +
          '<span class="flex h-7 w-7 items-center justify-center rounded-lg bg-zen-blue/10 text-zen-blue text-xs font-bold">' +
            sa.name.charAt(0).toUpperCase() +
          '</span>' +
          '<div class="flex-1 min-w-0">' +
            '<p class="text-sm font-medium text-dark">' + escapeHtml(sa.name) + '</p>' +
            '<p class="text-xs text-muted truncate">' + escapeHtml(sa.description || "No description") + '</p>' +
          '</div>' +
          '<span class="text-[10px] font-medium text-zen-blue bg-zen-blue/10 rounded-full px-2 py-0.5">delegate_to_' +
            escapeHtml(sa.name.toLowerCase().replace(/\s+/g, "_")) + '</span>' +
        '</div>' +
        '<div class="flex flex-col gap-1.5">' +
          '<label class="text-xs font-medium text-muted flex items-center gap-1.5">' +
            '<svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>' +
            'Routing Rule (optional)' +
          '</label>' +
          '<input type="text" data-idx="' + idx + '" class="routing-rule-input w-full bg-subtle/50 border border-dark/[0.06] rounded-md px-3 py-1.5 text-sm text-dark placeholder:text-muted/50 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all" ' +
            'placeholder="e.g. Handle all research tasks" value="' + escapeHtml(sa.routing_rule || "") + '">' +
        '</div>';
      container.appendChild(card);

      /* Bind routing rule input */
      const input = card.querySelector(".routing-rule-input");
      input.addEventListener("input", function() {
        selectedSubAgents[parseInt(this.getAttribute("data-idx"))].routing_rule = this.value.trim();
      });
    });

    /* Final preview (reuse same renderer) */
    renderFinalPreview();
  }

  function renderFinalPreview() {
    const target = finalPreview;
    target.innerHTML = "";

    /* Supervisor node */
    const supNode = document.createElement("div");
    supNode.className = "inline-flex items-center gap-2 rounded-xl border-2 border-coral/40 bg-coral/5 px-4 py-3";
    supNode.innerHTML =
      '<span class="flex h-8 w-8 items-center justify-center rounded-lg bg-coral/10 text-coral text-sm font-bold">S</span>' +
      '<div>' +
        '<p class="text-sm font-semibold text-dark">' + escapeHtml(supervisorData.name) + '</p>' +
        '<p class="text-[11px] text-muted">Supervisor</p>' +
      '</div>';
    target.appendChild(supNode);

    /* Line */
    const line = document.createElement("div");
    line.className = "hierarchy-line";
    line.style.height = "32px";
    target.appendChild(line);

    /* Branch */
    const branch = document.createElement("div");
    branch.className = "hierarchy-branch flex-wrap justify-center";
    branch.style.position = "relative";
    branch.style.gap = "16px";
    branch.style.paddingTop = "12px";
    branch.style.paddingBottom = "4px";

    selectedSubAgents.forEach(function(sa) {
      const subBranch = document.createElement("div");
      subBranch.className = "sub-agent-branch";
      const subLine = document.createElement("div");
      subLine.className = "branch-line";
      subLine.style.height = "20px";
      subBranch.appendChild(subLine);
      const subNode = document.createElement("div");
      subNode.className = "inline-flex flex-col items-center gap-1 rounded-xl border border-zen-blue/30 bg-zen-blue/5 px-3 py-2";
      subNode.innerHTML =
        '<div class="flex items-center gap-2">' +
          '<span class="flex h-6 w-6 items-center justify-center rounded bg-zen-blue/10 text-zen-blue text-[10px] font-bold">' +
            sa.name.charAt(0).toUpperCase() +
          '</span>' +
          '<span class="text-xs font-medium text-dark whitespace-nowrap">' + escapeHtml(sa.name) + '</span>' +
        '</div>' +
        (sa.routing_rule
          ? '<span class="text-[10px] text-muted text-center max-w-[120px] truncate">' + escapeHtml(sa.routing_rule) + '</span>'
          : '');
      subBranch.appendChild(subNode);
      branch.appendChild(subBranch);
    });

    target.appendChild(branch);

    /* Horizontal connector */
    if (selectedSubAgents.length > 1) {
      const connector = document.createElement("div");
      connector.className = "hierarchy-connector";
      connector.style.top = "12px";
      const totalWidth = (selectedSubAgents.length - 1) * 128;
      connector.style.width = totalWidth + "px";
      connector.style.left = "calc(50% - " + (totalWidth / 2) + "px)";
      branch.appendChild(connector);
    }
  }

  /* ================================================================ */
  /* Step navigation                                                    */
  /* ================================================================ */
  function goToStep(step) {
    currentStep = step;
    [step1, step2, step3].forEach(function(el) { el.classList.add("hidden"); });
    [step1Ind, step2Ind, step3Ind].forEach(function(ind) {
      ind.className = "flex items-center gap-2 px-3 py-1.5 rounded-full bg-subtle text-muted text-xs font-medium transition-all";
      ind.querySelector("span").className = "flex h-5 w-5 items-center justify-center rounded-full bg-dark/[0.12] text-muted text-[10px] font-bold";
    });

    /* Activate current step */
    var stepEl = [step1, step2, step3][step - 1];
    stepEl.classList.remove("hidden");

    var ind = [step1Ind, step2Ind, step3Ind][step - 1];
    ind.className = "flex items-center gap-2 px-3 py-1.5 rounded-full bg-coral/10 text-coral text-xs font-medium transition-all";
    ind.querySelector("span").className = "flex h-5 w-5 items-center justify-center rounded-full bg-coral text-paper text-[10px] font-bold";

    /* Mark completed steps */
    for (var i = 0; i < step - 1; i++) {
      var prevInd = [step1Ind, step2Ind, step3Ind][i];
      prevInd.className = "flex items-center gap-2 px-3 py-1.5 rounded-full bg-zen-green/10 text-zen-green text-xs font-medium transition-all";
      prevInd.querySelector("span").className = "flex h-5 w-5 items-center justify-center rounded-full bg-zen-green text-paper text-[10px] font-bold";
    }

    if (step === 2) {
      renderAvailableAgents();
      renderSelectedAgents();
      renderHierarchyPreview();
    } else if (step === 3) {
      renderReview();
    }
  }

  step1Next.addEventListener("click", function() { if (supervisorData) goToStep(2); });
  step2Next.addEventListener("click", function() { if (selectedSubAgents.length > 0) goToStep(3); });
  step2Back.addEventListener("click", function() { goToStep(1); });
  step3Back.addEventListener("click", function() { goToStep(2); });

  /* ================================================================ */
  /* Create supervisor                                                  */
  /* ================================================================ */
  createBtn.addEventListener("click", async function() {
    createBtn.classList.add("opacity-50", "pointer-events-none");
    createBtn.querySelector("span")?.classList.add("animate-pulse");

    try {
      var agentId = supervisorData.id;

      /* Create new agent if needed */
      if (supervisorData.isNew) {
        /* Get first project for placement */
        var projResp = await fetch("/api/v1/projects");
        var projBody = await projResp.json();
        var projects = projBody.data || projBody;
        var projectId = projects.length > 0 ? projects[0].id : null;
        if (!projectId) {
          showToast("error", "No project found. Create a project first.");
          createBtn.classList.remove("opacity-50", "pointer-events-none");
          return;
        }

        var createResp = await fetch("/api/v1/agents", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: supervisorData.name,
            description: supervisorData.description || "",
            instructions: supervisorData.instructions || "",
            project_id: projectId,
          }),
        });
        if (!createResp.ok) throw new Error("Failed to create agent");
        var newAgent = await createResp.json();
        agentId = newAgent.id;
      }

      /* Add each sub-agent relationship */
      var errors = [];
      for (var i = 0; i < selectedSubAgents.length; i++) {
        var sa = selectedSubAgents[i];
        var routingRule = sa.routing_rule ? JSON.stringify({ description: sa.routing_rule }) : "{}";
        var addResp = await fetch("/api/v1/agents/" + agentId + "/sub-agents", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sub_agent_id: sa.id,
            relationship_type: "delegation",
            routing_rule_json: routingRule,
          }),
        });
        if (!addResp.ok) {
          var errData = await addResp.json().catch(function() { return { detail: "Failed" }; });
          errors.push(sa.name + ": " + (errData.detail || "Error"));
        }
      }

      /* Update hooks_json to track delegates for graph view */
      var delegateIds = selectedSubAgents.map(function(sa) { return sa.id; });
      var agentResp = await fetch("/api/v1/agents/" + agentId);
      if (agentResp.ok) {
        var agentData = await agentResp.json();
        var hooks = {};
        try { hooks = JSON.parse(agentData.hooks_json || "{}"); } catch(e) {}
        hooks._delegates_to = delegateIds;
        await fetch("/api/v1/agents/" + agentId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ hooks_json: JSON.stringify(hooks) }),
        });
      }

      if (errors.length > 0) {
        showToast("warning", "Created with warnings: " + errors.join("; "));
      } else {
        showToast("success", "Supervisor created successfully!");
      }

      /* Redirect to agent edit page after brief delay */
      setTimeout(function() {
        window.location.href = "/agents/" + agentId + "/edit";
      }, 1200);

    } catch (err) {
      showToast("error", "Error: " + err.message);
      createBtn.classList.remove("opacity-50", "pointer-events-none");
    }
  });

  /* Test in playground */
  testBtn.addEventListener("click", function() {
    if (supervisorData && supervisorData.id) {
      window.open("/playground?agent=" + supervisorData.id, "_blank");
    } else {
      showToast("info", "Create the supervisor first to test in playground.");
    }
  });

  /* ================================================================ */
  /* Helpers                                                            */
  /* ================================================================ */
  function escapeHtml(str) {
    var div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  function showToast(type, message) {
    var toast = document.getElementById("status-toast");
    var icon = document.getElementById("toast-icon");
    var msg = document.getElementById("toast-message");

    var icons = {
      success: '<svg class="h-5 w-5 text-zen-green" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
      error: '<svg class="h-5 w-5 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
      warning: '<svg class="h-5 w-5 text-yellow-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
      info: '<svg class="h-5 w-5 text-zen-blue" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
    };

    icon.innerHTML = icons[type] || icons.info;
    msg.textContent = message;
    toast.classList.remove("hidden");

    setTimeout(function() {
      toast.classList.add("hidden");
    }, 4000);
  }
</script>
