---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";

const breadcrumbs = [{ label: "Agents" }];

/* Icons */
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const botIcon = '<svg class="h-12 w-12 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>';
const searchIcon = '<svg class="h-4 w-4 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
---

<PageLayout
  title="Agents"
  description="Manage your AI agents"
  activeSection="agents"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Agents</h1>
        <p class="text-sm text-muted mt-1">Create and manage your AI agents</p>
      </div>
      <Button href="/agents/new" variant="primary">
        <span set:html={plusIcon} />
        New Agent
      </Button>
    </div>

    <!-- Search -->
    <div class="mb-6">
      <div class="relative max-w-sm">
        <span class="absolute left-3 top-1/2 -translate-y-1/2" set:html={searchIcon} />
        <input
          type="text"
          id="agent-search"
          placeholder="Search agents..."
          class="w-full bg-paper border border-dark/[0.08] rounded-lg pl-9 pr-3 py-2 text-sm text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        />
      </div>
    </div>

    <!-- Agents grid (populated by JS) -->
    <div id="agents-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <div class="mb-4" set:html={botIcon} />
      <h2 class="text-lg font-semibold text-dark mb-2">No agents yet</h2>
      <p class="text-sm text-muted mb-6 max-w-sm">
        Agents are autonomous AI workers that can use tools, follow instructions, and complete tasks.
      </p>
      <Button href="/agents/new" variant="primary">
        <span set:html={plusIcon} />
        Create your first agent
      </Button>
    </div>

    <!-- No results state -->
    <div id="no-results" class="hidden flex flex-col items-center justify-center py-16 text-center">
      <p class="text-sm text-muted">No agents match your search.</p>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading agents...</p>
    </div>
  </div>
</PageLayout>

<!-- Agent card template -->
<template id="agent-card-template">
  <a class="block rounded-xl bg-subtle/80 border border-dark/[0.08] transition-all duration-300 hover:-translate-y-0.5 hover:border-dark/20 hover:shadow-lg p-5 no-underline">
    <div class="flex items-start justify-between mb-3">
      <h3 class="font-semibold text-dark text-base truncate pr-2" data-field="name"></h3>
      <span class="flex-shrink-0 text-xs px-2 py-0.5 rounded-full font-medium" data-field="status"></span>
    </div>
    <p class="text-sm text-muted line-clamp-2 mb-4 min-h-[2.5rem]" data-field="description"></p>
    <div class="flex items-center gap-3 text-xs text-muted">
      <span data-field="model"></span>
      <span data-field="tools"></span>
      <span data-field="date"></span>
    </div>
  </a>
</template>

<script is:inline>
  (function () {
    var grid = document.getElementById("agents-grid");
    var emptyState = document.getElementById("empty-state");
    var noResults = document.getElementById("no-results");
    var loadingState = document.getElementById("loading-state");
    var searchInput = document.getElementById("agent-search");
    var template = document.getElementById("agent-card-template");

    var allAgents = [];

    var clockSvg = '<svg class="h-3.5 w-3.5 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';

    function formatDate(dateStr) {
      try {
        var d = new Date(dateStr + "Z");
        var now = new Date();
        var diff = now - d;
        if (diff < 60000) return "Just now";
        if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
        if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
      } catch (_e) {
        return dateStr;
      }
    }

    function getStatusStyle(status) {
      if (status === "active") return { bg: "bg-zen-green/10", text: "text-zen-green", label: "Active" };
      if (status === "paused") return { bg: "bg-[#f59e0b]/10", text: "text-[#f59e0b]", label: "Paused" };
      return { bg: "bg-muted/10", text: "text-muted", label: status || "Draft" };
    }

    function renderAgents() {
      if (loadingState) loadingState.classList.add("hidden");

      if (allAgents.length === 0) {
        grid.classList.add("hidden");
        noResults.classList.add("hidden");
        emptyState.classList.remove("hidden");
        return;
      }

      var search = (searchInput.value || "").toLowerCase().trim();
      var filtered = allAgents;
      if (search) {
        filtered = allAgents.filter(function (a) {
          return (a.name || "").toLowerCase().indexOf(search) !== -1 ||
                 (a.description || "").toLowerCase().indexOf(search) !== -1;
        });
      }

      if (filtered.length === 0) {
        grid.classList.add("hidden");
        emptyState.classList.add("hidden");
        noResults.classList.remove("hidden");
        return;
      }

      noResults.classList.add("hidden");
      emptyState.classList.add("hidden");
      grid.classList.remove("hidden");
      grid.innerHTML = "";

      filtered.forEach(function (agent) {
        var card = template.content.cloneNode(true);
        var link = card.querySelector("a");
        link.href = "/agents/" + agent.id + "/edit";

        card.querySelector('[data-field="name"]').textContent = agent.name;

        var statusInfo = getStatusStyle(agent.status);
        var statusEl = card.querySelector('[data-field="status"]');
        statusEl.className = "flex-shrink-0 text-xs px-2 py-0.5 rounded-full font-medium " + statusInfo.bg + " " + statusInfo.text;
        statusEl.textContent = statusInfo.label;

        var descEl = card.querySelector('[data-field="description"]');
        descEl.textContent = agent.description || "No description";
        if (!agent.description) descEl.classList.add("italic", "text-muted/50");

        var modelEl = card.querySelector('[data-field="model"]');
        modelEl.textContent = agent.model || "";

        var toolsEl = card.querySelector('[data-field="tools"]');
        var toolCount = (agent.tools && agent.tools.length) || 0;
        toolsEl.textContent = toolCount + " tool" + (toolCount !== 1 ? "s" : "");

        var dateEl = card.querySelector('[data-field="date"]');
        if (agent.updated_at) {
          dateEl.innerHTML = clockSvg + " " + formatDate(agent.updated_at);
        }

        grid.appendChild(card);
      });
    }

    function fetchAgents() {
      fetch("/api/v1/agents")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load agents");
          return res.json();
        })
        .then(function (body) {
          allAgents = body.data || body;
          renderAgents();
        })
        .catch(function () {
          if (loadingState) loadingState.classList.add("hidden");
          grid.innerHTML = '<p class="text-sm text-coral col-span-full text-center py-10">Failed to load agents. Is the API server running?</p>';
          grid.classList.remove("hidden");
        });
    }

    var filterTimeout;
    searchInput.addEventListener("input", function () {
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(renderAgents, 150);
    });

    fetchAgents();
  })();
</script>
