---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";
import Modal from "../../components/Modal.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Templates", href: "/templates" },
  { label: "Loading..." },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const downloadIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
const deleteIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
const useIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
---

<PageLayout
  title="Template Detail"
  description="View template configuration"
  activeSection="templates"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading template...</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <p class="text-lg font-semibold text-dark mb-2">Template not found</p>
      <p class="text-sm text-muted mb-6">This template may have been deleted.</p>
      <Button href="/templates" variant="bordered">
        <span set:html={backIcon} />
        Back to Templates
      </Button>
    </div>

    <!-- Detail content (hidden until loaded) -->
    <div id="detail-content" class="hidden">
      <!-- Back + Actions row -->
      <div class="flex items-center justify-between mb-6">
        <a href="/templates" class="flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          Back to Templates
        </a>
        <div class="flex items-center gap-2">
          <button type="button" id="delete-btn"
            class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium border border-coral/30 text-coral bg-coral/5 rounded-lg hover:bg-coral/10 transition-colors cursor-pointer">
            <span set:html={deleteIcon} />
            Delete
          </button>
          <button type="button" id="export-btn"
            class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium border border-dark/[0.08] text-dark rounded-lg hover:bg-dark/5 transition-colors cursor-pointer">
            <span set:html={downloadIcon} />
            Export JSON
          </button>
          <Button variant="primary" id="use-template-btn">
            <span set:html={useIcon} />
            Use Template
          </Button>
        </div>
      </div>

      <!-- Template header -->
      <div class="mb-8">
        <div class="flex items-center gap-3 mb-2">
          <h1 id="detail-name" class="text-2xl font-semibold text-dark"></h1>
          <span id="detail-version" class="text-xs px-2 py-0.5 rounded-full font-medium bg-coral/10 text-coral"></span>
        </div>
        <p id="detail-description" class="text-sm text-muted mt-2 leading-relaxed"></p>
        <p id="detail-date" class="text-xs text-muted mt-2"></p>
      </div>

      <!-- Models required -->
      <div class="mb-6">
        <h2 class="text-sm font-semibold text-dark mb-3">Required Models</h2>
        <div id="models-list" class="flex flex-wrap gap-2">
          <span class="text-xs text-muted">None specified</span>
        </div>
      </div>

      <!-- Tools required -->
      <div class="mb-6">
        <h2 class="text-sm font-semibold text-dark mb-3">Required Tools</h2>
        <div id="tools-list" class="flex flex-wrap gap-2">
          <span class="text-xs text-muted">None specified</span>
        </div>
      </div>

      <!-- Config preview -->
      <div class="mb-8">
        <h2 class="text-sm font-semibold text-dark mb-3">Configuration</h2>
        <pre id="config-preview" class="bg-subtle/80 border border-dark/[0.08] rounded-xl p-4 text-xs font-mono text-dark overflow-x-auto max-h-96 overflow-y-auto"></pre>
      </div>
    </div>
  </div>
</PageLayout>

<!-- Use Template modal -->
<Modal id="use-template-modal" title="Create Agent from Template">
  <div class="flex flex-col gap-4">
    <div class="flex flex-col gap-1.5">
      <label for="agent-name-input" class="text-sm font-medium text-dark">Agent Name</label>
      <input type="text" id="agent-name-input" placeholder="My new agent"
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20" />
    </div>
    <div class="flex flex-col gap-1.5">
      <label for="project-select" class="text-sm font-medium text-dark">Project</label>
      <select id="project-select"
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 cursor-pointer">
        <option value="">Loading projects...</option>
      </select>
    </div>
    <div class="flex items-center justify-end gap-2">
      <button type="button" data-modal-close="use-template-modal" class="rounded-lg px-3 py-1.5 text-sm text-muted hover:text-dark transition-colors cursor-pointer">Cancel</button>
      <button type="button" id="confirm-use" class="rounded-lg bg-dark text-paper px-4 py-1.5 text-sm font-medium hover:bg-dark/80 transition-colors cursor-pointer">Create Agent</button>
    </div>
  </div>
</Modal>

<script is:inline define:vars={{ id }}>
  (function () {
    var loadingState = document.getElementById("loading-state");
    var errorState = document.getElementById("error-state");
    var detailContent = document.getElementById("detail-content");
    var deleteBtn = document.getElementById("delete-btn");
    var exportBtn = document.getElementById("export-btn");
    var useTemplateBtn = document.getElementById("use-template-btn");
    var useModal = document.getElementById("use-template-modal");
    var agentNameInput = document.getElementById("agent-name-input");
    var projectSelect = document.getElementById("project-select");
    var confirmUse = document.getElementById("confirm-use");

    var template = null;

    function escapeHtml(str) {
      var div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      try {
        var d = new Date(dateStr + "Z");
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric", hour: "2-digit", minute: "2-digit" });
      } catch (e) { return dateStr; }
    }

    function parseJsonArray(str) {
      try { return JSON.parse(str || "[]"); } catch (e) { return []; }
    }

    function renderBadges(container, items) {
      container.innerHTML = "";
      if (items.length === 0) {
        container.innerHTML = '<span class="text-xs text-muted">None specified</span>';
        return;
      }
      items.forEach(function (item) {
        var badge = document.createElement("span");
        badge.className = "text-xs px-2 py-1 rounded-lg bg-subtle/80 border border-dark/[0.08] text-dark font-mono";
        badge.textContent = item;
        container.appendChild(badge);
      });
    }

    function renderDetail(tpl) {
      template = tpl;
      loadingState.classList.add("hidden");
      detailContent.classList.remove("hidden");

      document.getElementById("detail-name").textContent = tpl.name;
      document.getElementById("detail-version").textContent = "v" + tpl.version;
      document.getElementById("detail-description").textContent = tpl.description || "No description";
      document.getElementById("detail-date").textContent = "Created " + formatDate(tpl.created_at) + " · Updated " + formatDate(tpl.updated_at);

      renderBadges(document.getElementById("models-list"), parseJsonArray(tpl.models_required));
      renderBadges(document.getElementById("tools-list"), parseJsonArray(tpl.tools_required));

      /* Config preview */
      try {
        var config = JSON.parse(tpl.config_json || "{}");
        document.getElementById("config-preview").textContent = JSON.stringify(config, null, 2);
      } catch (e) {
        document.getElementById("config-preview").textContent = tpl.config_json || "{}";
      }

      /* Pre-fill agent name */
      agentNameInput.value = tpl.name;
    }

    /* Fetch template */
    fetch("/api/v1/templates/" + id)
      .then(function (res) {
        if (!res.ok) throw new Error("Not found");
        return res.json();
      })
      .then(renderDetail)
      .catch(function () {
        loadingState.classList.add("hidden");
        errorState.classList.remove("hidden");
      });

    /* Export */
    exportBtn.addEventListener("click", function () {
      window.location.href = "/api/v1/templates/export/" + id;
    });

    /* Delete */
    deleteBtn.addEventListener("click", function () {
      if (!confirm("Delete this template? This cannot be undone.")) return;
      fetch("/api/v1/templates/" + id, { method: "DELETE" })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to delete");
          window.location.href = "/templates";
        })
        .catch(function (err) { alert(err.message); });
    });

    /* Use Template */
    var projectsLoaded = false;

    useTemplateBtn.addEventListener("click", function () {
      useModal.showModal();
      agentNameInput.focus();

      if (!projectsLoaded) {
        projectsLoaded = true;
        fetch("/api/v1/projects?limit=100")
          .then(function (res) { return res.ok ? res.json() : { data: [] }; })
          .then(function (body) {
            var projects = body.data || [];
            projectSelect.innerHTML = "";
            if (projects.length === 0) {
              projectSelect.innerHTML = '<option value="">No projects — create one first</option>';
              return;
            }
            projects.forEach(function (p) {
              var opt = document.createElement("option");
              opt.value = p.id;
              opt.textContent = p.name;
              projectSelect.appendChild(opt);
            });
          })
          .catch(function () {
            projectSelect.innerHTML = '<option value="">Failed to load projects</option>';
          });
      }
    });

    confirmUse.addEventListener("click", function () {
      var projectId = projectSelect.value;
      if (!projectId) {
        alert("Please select a project");
        return;
      }

      confirmUse.disabled = true;
      confirmUse.textContent = "Creating...";

      var name = agentNameInput.value.trim() || undefined;

      fetch("/api/v1/templates/" + id + "/instantiate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ project_id: projectId, name: name }),
      })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to create agent");
          return res.json();
        })
        .then(function (agent) {
          useModal.close();
          window.location.href = "/agents/" + agent.id + "/edit";
        })
        .catch(function (err) {
          alert(err.message);
        })
        .finally(function () {
          confirmUse.disabled = false;
          confirmUse.textContent = "Create Agent";
        });
    });
  })();
</script>
