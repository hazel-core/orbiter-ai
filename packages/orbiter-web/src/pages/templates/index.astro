---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";
import Modal from "../../components/Modal.astro";

const breadcrumbs = [{ label: "Templates" }];

/* Icons */
const searchIcon = '<svg class="h-4 w-4 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
const templateEmptyIcon = '<svg class="h-12 w-12 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>';
const uploadIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>';
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
---

<PageLayout
  title="Templates"
  description="Agent template library"
  activeSection="templates"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Templates</h1>
        <p class="text-sm text-muted mt-1">Save, share, and reuse agent configurations</p>
      </div>
      <div class="flex items-center gap-2">
        <Button variant="bordered" id="import-btn">
          <span set:html={uploadIcon} />
          Import JSON
        </Button>
        <Button variant="primary" id="create-btn">
          <span set:html={plusIcon} />
          Create Template
        </Button>
      </div>
    </div>

    <!-- Search -->
    <div class="flex items-center gap-3 mb-6 flex-wrap">
      <div class="relative flex-1 min-w-[200px] max-w-sm">
        <span class="absolute left-3 top-1/2 -translate-y-1/2" set:html={searchIcon} />
        <input
          type="text"
          id="template-search"
          placeholder="Search templates..."
          class="w-full bg-paper border border-dark/[0.08] rounded-lg pl-9 pr-3 py-2 text-sm text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        />
      </div>
    </div>

    <!-- Templates grid -->
    <div id="templates-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <div class="mb-4" set:html={templateEmptyIcon} />
      <h2 class="text-lg font-semibold text-dark mb-2">No templates yet</h2>
      <p class="text-sm text-muted mb-6 max-w-sm">
        Save agent configurations as templates to reuse them across projects. Go to an agent's edit page and click "Save as Agent Template".
      </p>
    </div>

    <!-- No results state -->
    <div id="no-results" class="hidden flex flex-col items-center justify-center py-16 text-center">
      <p class="text-sm text-muted">No templates match your search. Try a different query.</p>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading templates...</p>
    </div>
  </div>
</PageLayout>

<!-- Hidden file input for JSON import -->
<input type="file" id="import-file-input" accept=".json" class="hidden" />

<!-- Template card template -->
<template id="tpl-card-template">
  <a class="block rounded-xl bg-subtle/80 border border-dark/[0.08] transition-all duration-300 hover:-translate-y-0.5 hover:border-dark/20 hover:shadow-lg p-5 no-underline" data-field="card-link">
    <div class="flex items-start justify-between mb-2">
      <h3 class="font-semibold text-dark text-sm truncate flex-1 mr-2" data-field="tpl-name"></h3>
      <span class="flex-shrink-0 text-xs px-2 py-0.5 rounded-full font-medium bg-coral/10 text-coral" data-field="tpl-version"></span>
    </div>
    <p class="text-xs text-muted line-clamp-2 mb-3 min-h-[2rem]" data-field="tpl-description"></p>
    <div class="flex items-center gap-3 text-xs text-muted">
      <span data-field="tpl-models"></span>
      <span data-field="tpl-tools"></span>
      <span data-field="tpl-date"></span>
    </div>
  </a>
</template>

<!-- Create template modal -->
<Modal id="create-modal" title="Create Template">
  <div class="flex flex-col gap-4">
    <div class="flex flex-col gap-1.5">
      <label for="create-name" class="text-sm font-medium text-dark">Name</label>
      <input type="text" id="create-name" placeholder="My agent template"
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20" />
    </div>
    <div class="flex flex-col gap-1.5">
      <label for="create-description" class="text-sm font-medium text-dark">Description</label>
      <textarea id="create-description" rows="2" placeholder="What this template does..."
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-none"></textarea>
    </div>
    <div class="flex items-center justify-end gap-2">
      <button type="button" data-modal-close="create-modal" class="rounded-lg px-3 py-1.5 text-sm text-muted hover:text-dark transition-colors cursor-pointer">Cancel</button>
      <button type="button" id="confirm-create" class="rounded-lg bg-dark text-paper px-4 py-1.5 text-sm font-medium hover:bg-dark/80 transition-colors cursor-pointer">Create</button>
    </div>
  </div>
</Modal>

<script is:inline>
  (function () {
    /* DOM refs */
    var gridContainer = document.getElementById("templates-grid");
    var emptyState = document.getElementById("empty-state");
    var noResults = document.getElementById("no-results");
    var loadingState = document.getElementById("loading-state");
    var searchInput = document.getElementById("template-search");
    var cardTemplate = document.getElementById("tpl-card-template");
    var importBtn = document.getElementById("import-btn");
    var importFileInput = document.getElementById("import-file-input");
    var createBtn = document.getElementById("create-btn");
    var createModal = document.getElementById("create-modal");
    var createNameInput = document.getElementById("create-name");
    var createDescInput = document.getElementById("create-description");
    var confirmCreate = document.getElementById("confirm-create");

    var allTemplates = [];

    /* Helpers */
    function escapeHtml(str) {
      var div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      try {
        var d = new Date(dateStr + "Z");
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
      } catch (e) { return dateStr; }
    }

    function parseJsonArray(str) {
      try { return JSON.parse(str || "[]"); } catch (e) { return []; }
    }

    /* Render */
    function renderTemplates() {
      if (loadingState) loadingState.classList.add("hidden");

      var query = (searchInput.value || "").toLowerCase().trim();
      var filtered = allTemplates;
      if (query) {
        filtered = allTemplates.filter(function (t) {
          return t.name.toLowerCase().indexOf(query) !== -1 || (t.description || "").toLowerCase().indexOf(query) !== -1;
        });
      }

      if (allTemplates.length === 0) {
        gridContainer.classList.add("hidden");
        noResults.classList.add("hidden");
        emptyState.classList.remove("hidden");
        return;
      }

      if (filtered.length === 0) {
        gridContainer.classList.add("hidden");
        emptyState.classList.add("hidden");
        noResults.classList.remove("hidden");
        return;
      }

      noResults.classList.add("hidden");
      emptyState.classList.add("hidden");
      gridContainer.classList.remove("hidden");
      gridContainer.innerHTML = "";

      filtered.forEach(function (tpl) {
        var card = cardTemplate.content.cloneNode(true);

        card.querySelector('[data-field="card-link"]').href = "/templates/" + tpl.id;
        card.querySelector('[data-field="tpl-name"]').textContent = tpl.name;
        card.querySelector('[data-field="tpl-version"]').textContent = "v" + tpl.version;
        card.querySelector('[data-field="tpl-description"]').textContent = tpl.description || "No description";

        var models = parseJsonArray(tpl.models_required);
        card.querySelector('[data-field="tpl-models"]').textContent = models.length ? models.length + " model" + (models.length !== 1 ? "s" : "") : "No models";

        var tools = parseJsonArray(tpl.tools_required);
        card.querySelector('[data-field="tpl-tools"]').textContent = tools.length ? tools.length + " tool" + (tools.length !== 1 ? "s" : "") : "No tools";

        card.querySelector('[data-field="tpl-date"]').textContent = formatDate(tpl.created_at);

        gridContainer.appendChild(card);
      });
    }

    /* Fetch */
    function fetchTemplates() {
      fetch("/api/v1/templates?limit=100")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load templates");
          return res.json();
        })
        .then(function (body) {
          allTemplates = body.data || [];
          renderTemplates();
        })
        .catch(function () {
          if (loadingState) loadingState.classList.add("hidden");
          gridContainer.innerHTML = '<p class="text-sm text-coral col-span-full text-center py-10">Failed to load templates. Is the API server running?</p>';
          gridContainer.classList.remove("hidden");
        });
    }

    /* Search */
    var filterTimeout;
    searchInput.addEventListener("input", function () {
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(renderTemplates, 150);
    });

    /* Import JSON */
    importBtn.addEventListener("click", function () {
      importFileInput.click();
    });

    importFileInput.addEventListener("change", function () {
      var file = importFileInput.files[0];
      if (!file) return;

      var formData = new FormData();
      formData.append("file", file);

      fetch("/api/v1/templates/import", {
        method: "POST",
        body: formData,
      })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to import template");
          return res.json();
        })
        .then(function (tpl) {
          window.location.href = "/templates/" + tpl.id;
        })
        .catch(function (err) {
          alert(err.message);
        })
        .finally(function () {
          importFileInput.value = "";
        });
    });

    /* Create template */
    createBtn.addEventListener("click", function () {
      createNameInput.value = "";
      createDescInput.value = "";
      createModal.showModal();
      createNameInput.focus();
    });

    confirmCreate.addEventListener("click", function () {
      var name = createNameInput.value.trim();
      if (!name) {
        createNameInput.classList.add("border-coral");
        return;
      }
      createNameInput.classList.remove("border-coral");
      confirmCreate.disabled = true;
      confirmCreate.textContent = "Creating...";

      fetch("/api/v1/templates", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: name,
          description: createDescInput.value.trim(),
          config_json: "{}",
          tools_required: "[]",
          models_required: "[]",
        }),
      })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to create template");
          return res.json();
        })
        .then(function (tpl) {
          createModal.close();
          window.location.href = "/templates/" + tpl.id;
        })
        .catch(function (err) {
          alert(err.message);
        })
        .finally(function () {
          confirmCreate.disabled = false;
          confirmCreate.textContent = "Create";
        });
    });

    /* Initial load */
    fetchTemplates();
  })();
</script>
