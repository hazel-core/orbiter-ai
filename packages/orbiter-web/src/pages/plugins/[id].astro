---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Plugins", href: "/plugins" },
  { label: "Loading..." },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const downloadIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
---

<PageLayout
  title="Plugin Detail"
  description="View plugin details"
  activeSection="plugins"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading plugin...</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <p class="text-lg font-semibold text-dark mb-2">Plugin not found</p>
      <p class="text-sm text-muted mb-6">This plugin may have been removed from the marketplace.</p>
      <Button href="/plugins" variant="bordered">
        <span set:html={backIcon} />
        Back to Marketplace
      </Button>
    </div>

    <!-- Plugin detail (hidden until loaded) -->
    <div id="detail-content" class="hidden">
      <!-- Back + Actions row -->
      <div class="flex items-center justify-between mb-6">
        <a href="/plugins" class="flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          Back to Marketplace
        </a>
        <div class="flex items-center gap-2">
          <button id="install-btn" class="inline-flex items-center gap-2 bg-dark text-paper px-5 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-dark/90 cursor-pointer">
            <span set:html={downloadIcon} />
            <span id="install-btn-text">Install</span>
          </button>
        </div>
      </div>

      <!-- Plugin header -->
      <div class="mb-8">
        <div class="flex items-center gap-3 mb-2">
          <span id="detail-category-icon" class="flex-shrink-0 w-10 h-10 rounded-xl flex items-center justify-center text-lg"></span>
          <div>
            <h1 id="detail-name" class="text-2xl font-semibold text-dark"></h1>
            <div class="flex items-center gap-2 mt-1">
              <span id="detail-category-badge" class="text-xs px-2 py-0.5 rounded-full font-medium"></span>
              <span id="detail-version" class="text-xs px-1.5 py-0.5 rounded bg-muted/10 text-muted"></span>
              <span id="detail-author" class="text-xs text-muted"></span>
            </div>
          </div>
        </div>
        <p id="detail-description" class="text-sm text-muted mt-3 leading-relaxed"></p>
      </div>

      <!-- Stats row -->
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
        <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-4 text-center">
          <p class="text-2xl font-semibold text-dark" id="detail-installs"></p>
          <p class="text-xs text-muted mt-1">Installs</p>
        </div>
        <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-4 text-center">
          <p class="text-2xl font-semibold text-dark" id="detail-rating"></p>
          <p class="text-xs text-muted mt-1">Rating</p>
        </div>
        <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-4 text-center hidden md:block">
          <p class="text-2xl font-semibold text-dark" id="detail-type"></p>
          <p class="text-xs text-muted mt-1">Type</p>
        </div>
      </div>

      <!-- Screenshots placeholder -->
      <div class="mb-8">
        <h2 class="text-lg font-semibold text-dark mb-4">Screenshots</h2>
        <div class="grid grid-cols-2 gap-4">
          <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] aspect-video flex items-center justify-center">
            <p class="text-sm text-muted/60">Screenshot placeholder</p>
          </div>
          <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] aspect-video flex items-center justify-center">
            <p class="text-sm text-muted/60">Screenshot placeholder</p>
          </div>
        </div>
      </div>

      <!-- Changelog -->
      <div class="mb-8">
        <h2 class="text-lg font-semibold text-dark mb-4">Changelog</h2>
        <div id="detail-changelog" class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-4">
        </div>
      </div>

      <!-- Permissions -->
      <div class="mb-8">
        <h2 class="text-lg font-semibold text-dark mb-4">Permissions Required</h2>
        <div id="detail-permissions" class="flex flex-wrap gap-2">
        </div>
        <div id="no-permissions" class="hidden text-sm text-muted py-2">
          This plugin requires no special permissions.
        </div>
      </div>

      <!-- Install status message -->
      <div id="install-status" class="hidden rounded-lg p-3 text-sm mb-4"></div>
    </div>
  </div>
</PageLayout>

<script is:inline define:vars={{ id }}>
  (function () {
    /* ---------------------------------------------------------------
       DOM refs
    --------------------------------------------------------------- */
    var loadingState = document.getElementById("loading-state");
    var errorState = document.getElementById("error-state");
    var detailContent = document.getElementById("detail-content");
    var installBtn = document.getElementById("install-btn");
    var installBtnText = document.getElementById("install-btn-text");
    var installStatus = document.getElementById("install-status");

    var currentPlugin = null;

    /* ---------------------------------------------------------------
       Category metadata
    --------------------------------------------------------------- */
    var categoryMeta = {
      "Models": { icon: "üß†", bg: "bg-zen-blue/10", text: "text-zen-blue", label: "Models" },
      "Tools": { icon: "üîß", bg: "bg-[#f59e0b]/10", text: "text-[#f59e0b]", label: "Tools" },
      "Agent Strategies": { icon: "üéØ", bg: "bg-zen-green/10", text: "text-zen-green", label: "Strategy" },
      "Extensions": { icon: "üîå", bg: "bg-[#a855f7]/10", text: "text-[#a855f7]", label: "Extension" },
      "Bundles": { icon: "üì¶", bg: "bg-coral/10", text: "text-coral", label: "Bundle" },
    };

    var permissionLabels = {
      network: { label: "Network Access", icon: "üåê" },
      api_keys: { label: "API Keys", icon: "üîë" },
      file_system: { label: "File System", icon: "üìÅ" },
      sandbox: { label: "Sandbox Execution", icon: "üèóÔ∏è" },
    };

    function getCategoryInfo(cat) {
      return categoryMeta[cat] || { icon: "üîå", bg: "bg-muted/10", text: "text-muted", label: cat };
    }

    function formatCount(n) {
      if (n >= 1000) return (n / 1000).toFixed(1).replace(/\.0$/, "") + "k";
      return String(n);
    }

    /* ---------------------------------------------------------------
       Render plugin detail
    --------------------------------------------------------------- */
    function renderDetail(plugin) {
      currentPlugin = plugin;
      var catInfo = getCategoryInfo(plugin.category);

      // Header
      var iconEl = document.getElementById("detail-category-icon");
      iconEl.className = "flex-shrink-0 w-10 h-10 rounded-xl flex items-center justify-center text-lg " + catInfo.bg;
      iconEl.textContent = catInfo.icon;

      document.getElementById("detail-name").textContent = plugin.name;

      var badge = document.getElementById("detail-category-badge");
      badge.className = "text-xs px-2 py-0.5 rounded-full font-medium " + catInfo.bg + " " + catInfo.text;
      badge.textContent = catInfo.label;

      document.getElementById("detail-version").textContent = "v" + plugin.version;
      document.getElementById("detail-author").textContent = "by " + plugin.author;
      document.getElementById("detail-description").textContent = plugin.description || "No description provided.";

      // Stats
      document.getElementById("detail-installs").textContent = formatCount(plugin.install_count);
      document.getElementById("detail-rating").textContent = "‚òÖ " + plugin.rating.toFixed(1);
      document.getElementById("detail-type").textContent = plugin.type;

      // Changelog
      var changelogEl = document.getElementById("detail-changelog");
      var changelogLines = (plugin.changelog || "No changelog available.").split("\n");
      changelogEl.innerHTML = changelogLines.map(function (line) {
        return '<p class="text-sm text-muted py-1">' + line.replace(/</g, "&lt;").replace(/>/g, "&gt;") + '</p>';
      }).join("");

      // Permissions
      var permsContainer = document.getElementById("detail-permissions");
      var noPerms = document.getElementById("no-permissions");
      var perms = plugin.permissions || [];

      if (perms.length > 0) {
        noPerms.classList.add("hidden");
        permsContainer.innerHTML = "";
        perms.forEach(function (perm) {
          var info = permissionLabels[perm] || { label: perm, icon: "‚öôÔ∏è" };
          var el = document.createElement("span");
          el.className = "inline-flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-lg bg-subtle/80 border border-dark/[0.08] text-dark";
          el.textContent = info.icon + " " + info.label;
          permsContainer.appendChild(el);
        });
      } else {
        permsContainer.innerHTML = "";
        noPerms.classList.remove("hidden");
      }

      // Update breadcrumb
      var allBreadcrumbs = document.querySelectorAll("nav li span, nav li a");
      allBreadcrumbs.forEach(function (el) {
        if (el.textContent === "Loading...") {
          el.textContent = plugin.name;
        }
      });

      loadingState.classList.add("hidden");
      detailContent.classList.remove("hidden");
    }

    /* ---------------------------------------------------------------
       Fetch plugin
    --------------------------------------------------------------- */
    fetch("/api/v1/plugins/marketplace/" + id)
      .then(function (res) {
        if (!res.ok) throw new Error("Not found");
        return res.json();
      })
      .then(function (plugin) {
        renderDetail(plugin);
      })
      .catch(function () {
        loadingState.classList.add("hidden");
        errorState.classList.remove("hidden");
      });

    /* ---------------------------------------------------------------
       Install button
    --------------------------------------------------------------- */
    installBtn.addEventListener("click", function () {
      if (!currentPlugin || installBtn.disabled) return;

      installBtn.disabled = true;
      installBtnText.textContent = "Installing...";

      fetch("/api/v1/plugins/install", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          manifest: {
            name: currentPlugin.name,
            version: currentPlugin.version,
            type: currentPlugin.type,
            permissions: currentPlugin.permissions || [],
            entry_point: "main.py",
            description: currentPlugin.description || "",
            author: currentPlugin.author || "",
          },
          directory: "",
        }),
      })
        .then(function (res) {
          if (res.status === 409) {
            installBtnText.textContent = "Already Installed";
            installBtn.classList.add("opacity-50");
            return;
          }
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Install failed"); });
          return res.json();
        })
        .then(function (result) {
          if (result) {
            installBtnText.textContent = "Installed";
            installBtn.classList.add("opacity-50");
            showStatus("Plugin installed successfully!", "bg-zen-green/10 text-zen-green border border-zen-green/20");
          }
        })
        .catch(function (err) {
          installBtnText.textContent = "Install";
          installBtn.disabled = false;
          showStatus("Error: " + err.message, "bg-coral/10 text-coral border border-coral/20");
        });
    });

    function showStatus(msg, classes) {
      installStatus.textContent = msg;
      installStatus.className = "rounded-lg p-3 text-sm mb-4 " + classes;
      installStatus.classList.remove("hidden");
      setTimeout(function () {
        installStatus.classList.add("hidden");
      }, 5000);
    }
  })();
</script>
