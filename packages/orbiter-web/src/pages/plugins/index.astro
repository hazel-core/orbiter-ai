---
import PageLayout from "../../layouts/PageLayout.astro";
import Modal from "../../components/Modal.astro";
const breadcrumbs = [{ label: "Plugins" }];

const categoryOptions = [
  { value: "", label: "All categories" },
  { value: "Models", label: "Models" },
  { value: "Tools", label: "Tools" },
  { value: "Agent Strategies", label: "Agent Strategies" },
  { value: "Extensions", label: "Extensions" },
  { value: "Bundles", label: "Bundles" },
];

/* Icons */
const searchIcon = '<svg class="h-4 w-4 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
const pluginIcon = '<svg class="h-12 w-12 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v6m0 0a3 3 0 1 0 0 6m0-6a3 3 0 1 1 0 6m0 0v4m-5-7H2m20 0h-5"/></svg>';
const folderIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>';
---

<PageLayout
  title="Plugins"
  description="Browse and install plugins"
  activeSection="plugins"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Plugins</h1>
        <p class="text-sm text-muted mt-1">Browse marketplace and manage installed plugins</p>
      </div>
      <button
        id="load-dir-btn"
        class="hidden items-center gap-2 bg-dark text-paper px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-dark/90 cursor-pointer"
      >
        <span set:html={folderIcon} />
        Load from Directory
      </button>
    </div>

    <!-- Tab bar -->
    <div class="flex items-center gap-1 mb-6 border-b border-dark/[0.08]">
      <button
        id="tab-marketplace"
        class="tab-btn relative px-4 py-2.5 text-sm font-medium text-dark transition-colors cursor-pointer bg-transparent border-none"
        data-tab="marketplace"
      >
        Marketplace
        <span class="absolute bottom-0 left-0 right-0 h-0.5 bg-coral rounded-t transition-opacity"></span>
      </button>
      <button
        id="tab-installed"
        class="tab-btn relative px-4 py-2.5 text-sm font-medium text-muted transition-colors cursor-pointer bg-transparent border-none"
        data-tab="installed"
      >
        Installed
        <span id="installed-count-badge" class="hidden ml-1.5 text-xs px-1.5 py-0.5 rounded-full bg-dark/10 text-muted"></span>
        <span class="absolute bottom-0 left-0 right-0 h-0.5 bg-coral rounded-t transition-opacity opacity-0"></span>
      </button>
    </div>

    <!-- Filters (shared search + category for marketplace, search-only for installed) -->
    <div class="flex items-center gap-3 mb-6 flex-wrap">
      <!-- Search -->
      <div class="relative flex-1 min-w-[200px] max-w-sm">
        <span class="absolute left-3 top-1/2 -translate-y-1/2" set:html={searchIcon} />
        <input
          type="text"
          id="plugin-search"
          placeholder="Search plugins..."
          class="w-full bg-paper border border-dark/[0.08] rounded-lg pl-9 pr-3 py-2 text-sm text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        />
      </div>

      <!-- Category filter (marketplace only) -->
      <select
        id="filter-category"
        class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer"
      >
        {categoryOptions.map(opt => (
          <option value={opt.value}>{opt.label}</option>
        ))}
      </select>
    </div>

    <!-- ============= MARKETPLACE TAB ============= -->
    <div id="panel-marketplace">
      <!-- Plugin grid -->
      <div id="plugins-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      </div>

      <!-- Empty state -->
      <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
        <div class="mb-4" set:html={pluginIcon} />
        <h2 class="text-lg font-semibold text-dark mb-2">No plugins available</h2>
        <p class="text-sm text-muted mb-6 max-w-sm">
          The plugin marketplace is empty. Check back later for new plugins.
        </p>
      </div>

      <!-- No results state -->
      <div id="no-results" class="hidden flex flex-col items-center justify-center py-16 text-center">
        <p class="text-sm text-muted">No plugins match your filters. Try adjusting the search or category.</p>
      </div>

      <!-- Loading state -->
      <div id="loading-state" class="flex items-center justify-center py-20">
        <p class="text-sm text-muted">Loading marketplace...</p>
      </div>
    </div>

    <!-- ============= INSTALLED TAB ============= -->
    <div id="panel-installed" class="hidden">
      <!-- Installed plugins list -->
      <div id="installed-list" class="space-y-3">
      </div>

      <!-- Installed empty state -->
      <div id="installed-empty" class="hidden flex flex-col items-center justify-center py-20 text-center">
        <div class="mb-4" set:html={pluginIcon} />
        <h2 class="text-lg font-semibold text-dark mb-2">No plugins installed</h2>
        <p class="text-sm text-muted mb-6 max-w-sm">
          Browse the marketplace to discover and install plugins, or load one from a local directory.
        </p>
        <button id="go-marketplace-btn" class="inline-flex items-center gap-2 bg-dark text-paper px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-dark/90 cursor-pointer">
          Browse Marketplace
        </button>
      </div>

      <!-- Installed no results -->
      <div id="installed-no-results" class="hidden flex flex-col items-center justify-center py-16 text-center">
        <p class="text-sm text-muted">No installed plugins match your search.</p>
      </div>

      <!-- Installed loading state -->
      <div id="installed-loading" class="hidden flex items-center justify-center py-20">
        <p class="text-sm text-muted">Loading installed plugins...</p>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed bottom-6 right-6 z-50 rounded-lg px-4 py-3 text-sm shadow-lg transition-all duration-300"></div>
  </div>

  <!-- Uninstall confirmation modal -->
  <Modal id="uninstall-modal" title="Uninstall Plugin">
    <p class="text-sm text-muted mb-4">
      Are you sure you want to uninstall <strong id="uninstall-plugin-name" class="text-dark"></strong>? This action cannot be undone.
    </p>
    <div class="flex justify-end gap-3">
      <button
        type="button"
        class="px-4 py-2 text-sm rounded-lg border border-dark/[0.08] text-dark hover:bg-dark/5 transition-colors cursor-pointer"
        data-modal-close="uninstall-modal"
      >
        Cancel
      </button>
      <button
        id="confirm-uninstall-btn"
        type="button"
        class="px-4 py-2 text-sm rounded-lg bg-coral text-white font-medium hover:bg-coral/90 transition-colors cursor-pointer"
      >
        Uninstall
      </button>
    </div>
  </Modal>

  <!-- Load from Directory modal -->
  <Modal id="load-dir-modal" title="Load Plugin from Directory">
    <p class="text-sm text-muted mb-4">
      Enter the path to a local directory containing a <code class="text-xs bg-dark/5 px-1 py-0.5 rounded">plugin.json</code> manifest.
    </p>
    <input
      type="text"
      id="dir-path-input"
      placeholder="/path/to/plugin"
      class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 mb-4 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
    />
    <div id="load-dir-error" class="hidden text-sm text-coral mb-3"></div>
    <div class="flex justify-end gap-3">
      <button
        type="button"
        class="px-4 py-2 text-sm rounded-lg border border-dark/[0.08] text-dark hover:bg-dark/5 transition-colors cursor-pointer"
        data-modal-close="load-dir-modal"
      >
        Cancel
      </button>
      <button
        id="confirm-load-dir-btn"
        type="button"
        class="px-4 py-2 text-sm rounded-lg bg-dark text-paper font-medium hover:bg-dark/90 transition-colors cursor-pointer"
      >
        Load Plugin
      </button>
    </div>
  </Modal>
</PageLayout>

<!-- Marketplace card template -->
<template id="plugin-card-template">
  <a class="block rounded-xl bg-subtle/80 border border-dark/[0.08] transition-all duration-300 hover:-translate-y-0.5 hover:border-dark/20 hover:shadow-lg p-5 no-underline" data-field="card-link">
    <div class="flex items-start justify-between mb-2">
      <div class="flex items-center gap-2.5 min-w-0">
        <span class="flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center text-sm" data-field="category-icon"></span>
        <div class="min-w-0">
          <h3 class="font-semibold text-dark text-sm truncate" data-field="plugin-name"></h3>
          <p class="text-xs text-muted truncate" data-field="plugin-author"></p>
        </div>
      </div>
      <span class="flex-shrink-0 text-xs px-2 py-0.5 rounded-full font-medium" data-field="category-badge"></span>
    </div>
    <p class="text-xs text-muted line-clamp-2 mb-3 min-h-[2rem]" data-field="plugin-description"></p>
    <div class="flex items-center justify-between text-xs text-muted">
      <div class="flex items-center gap-3">
        <span data-field="install-count"></span>
        <span data-field="rating"></span>
      </div>
      <span class="text-xs px-1.5 py-0.5 rounded bg-muted/10 text-muted" data-field="plugin-version"></span>
    </div>
  </a>
</template>

<!-- Installed plugin card template -->
<template id="installed-card-template">
  <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5 transition-all duration-200" data-field="installed-card">
    <div class="flex items-center justify-between gap-4">
      <!-- Left: icon + info -->
      <div class="flex items-center gap-3 min-w-0 flex-1">
        <span class="flex-shrink-0 w-10 h-10 rounded-xl flex items-center justify-center text-base" data-field="inst-icon"></span>
        <div class="min-w-0 flex-1">
          <div class="flex items-center gap-2 mb-0.5">
            <h3 class="font-semibold text-dark text-sm truncate" data-field="inst-name"></h3>
            <span class="flex-shrink-0 text-xs px-1.5 py-0.5 rounded bg-muted/10 text-muted" data-field="inst-version"></span>
            <span class="flex-shrink-0 w-2 h-2 rounded-full" data-field="inst-status-dot"></span>
            <span class="flex-shrink-0 text-xs" data-field="inst-status-text"></span>
          </div>
          <p class="text-xs text-muted truncate" data-field="inst-description"></p>
        </div>
      </div>
      <!-- Right: toggle + uninstall -->
      <div class="flex items-center gap-3 flex-shrink-0">
        <!-- Enable/Disable toggle -->
        <button
          class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 cursor-pointer"
          data-field="inst-toggle"
          title="Enable/Disable"
        >
          <span class="inline-block h-4 w-4 rounded-full bg-white shadow-sm transition-transform duration-200" data-field="inst-toggle-dot"></span>
        </button>
        <!-- Uninstall -->
        <button
          class="flex items-center justify-center h-8 w-8 rounded-lg text-muted hover:text-coral hover:bg-coral/10 transition-colors cursor-pointer"
          data-field="inst-uninstall"
          title="Uninstall"
        >
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</template>

<script is:inline>
  (function () {
    /* ---------------------------------------------------------------
       DOM refs
    --------------------------------------------------------------- */
    var gridContainer = document.getElementById("plugins-grid");
    var emptyState = document.getElementById("empty-state");
    var noResults = document.getElementById("no-results");
    var loadingState = document.getElementById("loading-state");
    var searchInput = document.getElementById("plugin-search");
    var filterCategory = document.getElementById("filter-category");
    var cardTemplate = document.getElementById("plugin-card-template");
    var installedTemplate = document.getElementById("installed-card-template");

    var panelMarketplace = document.getElementById("panel-marketplace");
    var panelInstalled = document.getElementById("panel-installed");
    var tabMarketplace = document.getElementById("tab-marketplace");
    var tabInstalled = document.getElementById("tab-installed");
    var installedList = document.getElementById("installed-list");
    var installedEmpty = document.getElementById("installed-empty");
    var installedNoResults = document.getElementById("installed-no-results");
    var installedLoading = document.getElementById("installed-loading");
    var installedCountBadge = document.getElementById("installed-count-badge");
    var loadDirBtn = document.getElementById("load-dir-btn");
    var goMarketplaceBtn = document.getElementById("go-marketplace-btn");
    var toastEl = document.getElementById("toast");

    // Modals
    var uninstallModal = document.getElementById("uninstall-modal");
    var uninstallPluginName = document.getElementById("uninstall-plugin-name");
    var confirmUninstallBtn = document.getElementById("confirm-uninstall-btn");
    var loadDirModal = document.getElementById("load-dir-modal");
    var dirPathInput = document.getElementById("dir-path-input");
    var loadDirError = document.getElementById("load-dir-error");
    var confirmLoadDirBtn = document.getElementById("confirm-load-dir-btn");

    var allMarketplacePlugins = [];
    var allInstalledPlugins = [];
    var activeTab = "marketplace";
    var pendingUninstallId = null;

    /* ---------------------------------------------------------------
       Category metadata
    --------------------------------------------------------------- */
    var categoryMeta = {
      "Models": { icon: "\u{1F9E0}", bg: "bg-zen-blue/10", text: "text-zen-blue", label: "Models" },
      "Tools": { icon: "\u{1F527}", bg: "bg-[#f59e0b]/10", text: "text-[#f59e0b]", label: "Tools" },
      "Agent Strategies": { icon: "\u{1F3AF}", bg: "bg-zen-green/10", text: "text-zen-green", label: "Strategy" },
      "Extensions": { icon: "\u{1F50C}", bg: "bg-[#a855f7]/10", text: "text-[#a855f7]", label: "Extension" },
      "Bundles": { icon: "\u{1F4E6}", bg: "bg-coral/10", text: "text-coral", label: "Bundle" },
    };

    var typeToCategoryMap = {
      model: "Models",
      tool: "Tools",
      strategy: "Agent Strategies",
      extension: "Extensions",
      bundle: "Bundles",
    };

    function getCategoryInfo(cat) {
      return categoryMeta[cat] || { icon: "\u{1F50C}", bg: "bg-muted/10", text: "text-muted", label: cat };
    }

    /* ---------------------------------------------------------------
       Helpers
    --------------------------------------------------------------- */
    function formatCount(n) {
      if (n >= 1000) return (n / 1000).toFixed(1).replace(/\.0$/, "") + "k";
      return String(n);
    }

    function renderStars(rating) {
      var full = Math.floor(rating);
      var half = rating - full >= 0.5;
      var stars = "";
      for (var i = 0; i < full; i++) stars += "\u2605";
      if (half) stars += "\u00BD";
      return stars + " " + rating.toFixed(1);
    }

    function showToast(msg, type) {
      var cls = type === "error"
        ? "bg-coral text-white"
        : "bg-zen-green/90 text-white";
      toastEl.textContent = msg;
      toastEl.className = "fixed bottom-6 right-6 z-50 rounded-lg px-4 py-3 text-sm shadow-lg transition-all duration-300 " + cls;
      toastEl.classList.remove("hidden");
      setTimeout(function () {
        toastEl.classList.add("hidden");
      }, 4000);
    }

    /* ---------------------------------------------------------------
       Status helpers
    --------------------------------------------------------------- */
    var statusMeta = {
      enabled: { dot: "bg-zen-green", text: "text-zen-green", label: "Active" },
      disabled: { dot: "bg-muted/40", text: "text-muted", label: "Disabled" },
      error: { dot: "bg-coral", text: "text-coral", label: "Error" },
      installed: { dot: "bg-zen-blue", text: "text-zen-blue", label: "Installed" },
    };

    function getStatusInfo(status) {
      return statusMeta[status] || statusMeta.installed;
    }

    /* ---------------------------------------------------------------
       Tab switching
    --------------------------------------------------------------- */
    function switchTab(tab) {
      activeTab = tab;
      var isMarketplace = tab === "marketplace";

      // Tab styles
      tabMarketplace.classList.toggle("text-dark", isMarketplace);
      tabMarketplace.classList.toggle("text-muted", !isMarketplace);
      tabMarketplace.querySelector("span:last-child").classList.toggle("opacity-0", !isMarketplace);

      tabInstalled.classList.toggle("text-dark", !isMarketplace);
      tabInstalled.classList.toggle("text-muted", isMarketplace);
      tabInstalled.querySelector("span:last-child").classList.toggle("opacity-0", isMarketplace);

      // Panel visibility
      panelMarketplace.classList.toggle("hidden", !isMarketplace);
      panelInstalled.classList.toggle("hidden", isMarketplace);

      // Show/hide category filter and load-dir button
      filterCategory.classList.toggle("hidden", !isMarketplace);
      loadDirBtn.classList.toggle("hidden", isMarketplace);
      if (!isMarketplace) loadDirBtn.classList.add("flex");

      // Reset search
      searchInput.value = "";
      if (isMarketplace) {
        searchInput.placeholder = "Search plugins...";
        renderMarketplace();
      } else {
        searchInput.placeholder = "Search installed plugins...";
        renderInstalled();
      }
    }

    tabMarketplace.addEventListener("click", function () { switchTab("marketplace"); });
    tabInstalled.addEventListener("click", function () { switchTab("installed"); });
    if (goMarketplaceBtn) {
      goMarketplaceBtn.addEventListener("click", function () { switchTab("marketplace"); });
    }

    /* ---------------------------------------------------------------
       Marketplace filtering & rendering
    --------------------------------------------------------------- */
    function getFilteredMarketplace() {
      var search = (searchInput.value || "").toLowerCase().trim();
      var cat = filterCategory.value;

      return allMarketplacePlugins.filter(function (p) {
        if (search) {
          var nameMatch = p.name.toLowerCase().indexOf(search) !== -1;
          var descMatch = p.description.toLowerCase().indexOf(search) !== -1;
          var authorMatch = p.author.toLowerCase().indexOf(search) !== -1;
          if (!nameMatch && !descMatch && !authorMatch) return false;
        }
        if (cat && p.category !== cat) return false;
        return true;
      });
    }

    function renderMarketplace() {
      if (loadingState) loadingState.classList.add("hidden");

      if (allMarketplacePlugins.length === 0) {
        gridContainer.classList.add("hidden");
        noResults.classList.add("hidden");
        emptyState.classList.remove("hidden");
        return;
      }

      var filtered = getFilteredMarketplace();

      if (filtered.length === 0) {
        gridContainer.classList.add("hidden");
        emptyState.classList.add("hidden");
        noResults.classList.remove("hidden");
        return;
      }

      noResults.classList.add("hidden");
      emptyState.classList.add("hidden");
      gridContainer.classList.remove("hidden");
      gridContainer.innerHTML = "";
      filtered.forEach(function (plugin) { renderGridCard(plugin); });
    }

    function renderGridCard(plugin) {
      var card = cardTemplate.content.cloneNode(true);
      var catInfo = getCategoryInfo(plugin.category);

      card.querySelector('[data-field="card-link"]').href = "/plugins/" + plugin.id;

      var iconEl = card.querySelector('[data-field="category-icon"]');
      iconEl.className = "flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center text-sm " + catInfo.bg;
      iconEl.textContent = catInfo.icon;

      card.querySelector('[data-field="plugin-name"]').textContent = plugin.name;
      card.querySelector('[data-field="plugin-author"]').textContent = "by " + plugin.author;

      var badge = card.querySelector('[data-field="category-badge"]');
      badge.className = "flex-shrink-0 text-xs px-2 py-0.5 rounded-full font-medium " + catInfo.bg + " " + catInfo.text;
      badge.textContent = catInfo.label;

      card.querySelector('[data-field="plugin-description"]').textContent = plugin.description || "No description";

      card.querySelector('[data-field="install-count"]').textContent = formatCount(plugin.install_count) + " installs";
      card.querySelector('[data-field="rating"]').textContent = renderStars(plugin.rating);
      card.querySelector('[data-field="plugin-version"]').textContent = "v" + plugin.version;

      gridContainer.appendChild(card);
    }

    /* ---------------------------------------------------------------
       Installed filtering & rendering
    --------------------------------------------------------------- */
    function getFilteredInstalled() {
      var search = (searchInput.value || "").toLowerCase().trim();
      if (!search) return allInstalledPlugins;

      return allInstalledPlugins.filter(function (p) {
        var nameMatch = p.name.toLowerCase().indexOf(search) !== -1;
        var descMatch = (p.description || "").toLowerCase().indexOf(search) !== -1;
        var authorMatch = (p.author || "").toLowerCase().indexOf(search) !== -1;
        return nameMatch || descMatch || authorMatch;
      });
    }

    function renderInstalled() {
      installedLoading.classList.add("hidden");

      // Update badge count
      if (allInstalledPlugins.length > 0) {
        installedCountBadge.textContent = String(allInstalledPlugins.length);
        installedCountBadge.classList.remove("hidden");
      } else {
        installedCountBadge.classList.add("hidden");
      }

      if (allInstalledPlugins.length === 0) {
        installedList.classList.add("hidden");
        installedNoResults.classList.add("hidden");
        installedEmpty.classList.remove("hidden");
        return;
      }

      var filtered = getFilteredInstalled();

      if (filtered.length === 0) {
        installedList.classList.add("hidden");
        installedEmpty.classList.add("hidden");
        installedNoResults.classList.remove("hidden");
        return;
      }

      installedEmpty.classList.add("hidden");
      installedNoResults.classList.add("hidden");
      installedList.classList.remove("hidden");
      installedList.innerHTML = "";
      filtered.forEach(function (plugin) { renderInstalledCard(plugin); });
    }

    function renderInstalledCard(plugin) {
      var card = installedTemplate.content.cloneNode(true);
      var category = typeToCategoryMap[plugin.type] || "Extensions";
      var catInfo = getCategoryInfo(category);
      var sInfo = getStatusInfo(plugin.status);
      var isEnabled = plugin.status === "enabled";

      // Icon
      var iconEl = card.querySelector('[data-field="inst-icon"]');
      iconEl.className = "flex-shrink-0 w-10 h-10 rounded-xl flex items-center justify-center text-base " + catInfo.bg;
      iconEl.textContent = catInfo.icon;

      // Name & version
      card.querySelector('[data-field="inst-name"]').textContent = plugin.name;
      card.querySelector('[data-field="inst-version"]').textContent = "v" + plugin.version;

      // Status dot + text
      var dotEl = card.querySelector('[data-field="inst-status-dot"]');
      dotEl.className = "flex-shrink-0 w-2 h-2 rounded-full " + sInfo.dot;
      var textEl = card.querySelector('[data-field="inst-status-text"]');
      textEl.className = "flex-shrink-0 text-xs " + sInfo.text;
      textEl.textContent = sInfo.label;

      // Description
      card.querySelector('[data-field="inst-description"]').textContent = plugin.description || "No description";

      // Toggle
      var toggleBtn = card.querySelector('[data-field="inst-toggle"]');
      var toggleDot = card.querySelector('[data-field="inst-toggle-dot"]');

      if (isEnabled) {
        toggleBtn.className = "relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 cursor-pointer bg-zen-green";
        toggleDot.className = "inline-block h-4 w-4 rounded-full bg-white shadow-sm transition-transform duration-200 translate-x-5.5";
      } else {
        toggleBtn.className = "relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 cursor-pointer bg-dark/20";
        toggleDot.className = "inline-block h-4 w-4 rounded-full bg-white shadow-sm transition-transform duration-200 translate-x-0.5";
      }

      toggleBtn.addEventListener("click", function () {
        var newStatus = isEnabled ? "disabled" : "enabled";
        updatePluginStatus(plugin.id, newStatus);
      });

      // Uninstall
      card.querySelector('[data-field="inst-uninstall"]').addEventListener("click", function () {
        openUninstallModal(plugin.id, plugin.name);
      });

      installedList.appendChild(card);
    }

    /* ---------------------------------------------------------------
       API helpers
    --------------------------------------------------------------- */
    function fetchMarketplace() {
      fetch("/api/v1/plugins/marketplace")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load marketplace");
          return res.json();
        })
        .then(function (plugins) {
          allMarketplacePlugins = plugins;
          if (activeTab === "marketplace") renderMarketplace();
        })
        .catch(function () {
          if (loadingState) loadingState.classList.add("hidden");
          gridContainer.innerHTML = '<p class="text-sm text-coral col-span-full text-center py-10">Failed to load marketplace. Is the API server running?</p>';
          gridContainer.classList.remove("hidden");
        });
    }

    function fetchInstalled() {
      fetch("/api/v1/plugins")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load plugins");
          return res.json();
        })
        .then(function (plugins) {
          allInstalledPlugins = plugins;
          // Always update badge
          if (allInstalledPlugins.length > 0) {
            installedCountBadge.textContent = String(allInstalledPlugins.length);
            installedCountBadge.classList.remove("hidden");
          } else {
            installedCountBadge.classList.add("hidden");
          }
          if (activeTab === "installed") renderInstalled();
        })
        .catch(function () {
          installedLoading.classList.add("hidden");
          if (activeTab === "installed") {
            installedList.innerHTML = '<p class="text-sm text-coral text-center py-10">Failed to load installed plugins.</p>';
            installedList.classList.remove("hidden");
          }
        });
    }

    function updatePluginStatus(pluginId, newStatus) {
      fetch("/api/v1/plugins/" + pluginId + "/status?status=" + newStatus, { method: "PUT" })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to update status");
          return res.json();
        })
        .then(function () {
          showToast("Plugin " + (newStatus === "enabled" ? "enabled" : "disabled"), "success");
          fetchInstalled();
        })
        .catch(function (err) {
          showToast("Error: " + err.message, "error");
        });
    }

    function uninstallPlugin(pluginId) {
      fetch("/api/v1/plugins/" + pluginId, { method: "DELETE" })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to uninstall");
          showToast("Plugin uninstalled", "success");
          fetchInstalled();
        })
        .catch(function (err) {
          showToast("Error: " + err.message, "error");
        });
    }

    function loadFromDirectory(directory) {
      return fetch("/api/v1/plugins/load-directory", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ directory: directory }),
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Load failed"); });
          return res.json();
        });
    }

    /* ---------------------------------------------------------------
       Uninstall modal
    --------------------------------------------------------------- */
    function openUninstallModal(pluginId, name) {
      pendingUninstallId = pluginId;
      uninstallPluginName.textContent = name;
      uninstallModal.showModal();
    }

    confirmUninstallBtn.addEventListener("click", function () {
      if (!pendingUninstallId) return;
      uninstallModal.close();
      uninstallPlugin(pendingUninstallId);
      pendingUninstallId = null;
    });

    /* ---------------------------------------------------------------
       Load from Directory modal
    --------------------------------------------------------------- */
    loadDirBtn.addEventListener("click", function () {
      dirPathInput.value = "";
      loadDirError.classList.add("hidden");
      loadDirModal.showModal();
    });

    confirmLoadDirBtn.addEventListener("click", function () {
      var dir = dirPathInput.value.trim();
      if (!dir) {
        loadDirError.textContent = "Please enter a directory path.";
        loadDirError.classList.remove("hidden");
        return;
      }

      confirmLoadDirBtn.disabled = true;
      confirmLoadDirBtn.textContent = "Loading...";
      loadDirError.classList.add("hidden");

      loadFromDirectory(dir)
        .then(function () {
          loadDirModal.close();
          showToast("Plugin loaded from directory", "success");
          fetchInstalled();
          // Auto-switch to installed tab
          switchTab("installed");
        })
        .catch(function (err) {
          loadDirError.textContent = err.message;
          loadDirError.classList.remove("hidden");
        })
        .finally(function () {
          confirmLoadDirBtn.disabled = false;
          confirmLoadDirBtn.textContent = "Load Plugin";
        });
    });

    /* ---------------------------------------------------------------
       Event listeners
    --------------------------------------------------------------- */
    var filterTimeout;
    function onFilterChange() {
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(function () {
        if (activeTab === "marketplace") renderMarketplace();
        else renderInstalled();
      }, 150);
    }
    searchInput.addEventListener("input", onFilterChange);
    filterCategory.addEventListener("change", onFilterChange);

    /* ---------------------------------------------------------------
       Initial load
    --------------------------------------------------------------- */
    fetchMarketplace();
    fetchInstalled();
  })();
</script>
