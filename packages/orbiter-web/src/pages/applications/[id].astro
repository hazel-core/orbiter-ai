---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";
import Modal from "../../components/Modal.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Applications", href: "/applications" },
  { label: "Loading..." },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const saveIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>';
const editIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
const trashIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';
const playIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
const duplicateIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';

const typeColors: Record<string, { bg: string; text: string; label: string; icon: string }> = {
  chatbot: { bg: "bg-coral/10", text: "text-coral", label: "Chatbot", icon: "C" },
  chatflow: { bg: "bg-zen-blue/10", text: "text-zen-blue", label: "Chatflow", icon: "F" },
  workflow: { bg: "bg-zen-green/10", text: "text-zen-green", label: "Workflow", icon: "W" },
  agent: { bg: "bg-[#a855f7]/10", text: "text-[#a855f7]", label: "Agent", icon: "A" },
  text_generator: { bg: "bg-[#f59e0b]/10", text: "text-[#f59e0b]", label: "Text Generator", icon: "T" },
};
---

<PageLayout
  title="Application"
  description="Application details"
  activeSection="projects"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading application...</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <p class="text-lg font-semibold text-dark mb-2">Application not found</p>
      <p class="text-sm text-muted mb-6">This application may have been deleted.</p>
      <Button href="/applications" variant="bordered">
        <span set:html={backIcon} />
        Back to Applications
      </Button>
    </div>

    <!-- Application content (hidden until loaded) -->
    <div id="app-content" class="hidden">
      <!-- Back + Actions row -->
      <div class="flex items-center justify-between mb-6">
        <a id="back-link" href="/applications" class="flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          Back to Applications
        </a>
        <div class="flex items-center gap-2">
          <span id="save-status" class="text-xs text-muted hidden"></span>
          <Button variant="primary" id="save-btn">
            <span set:html={saveIcon} />
            Save
          </Button>
          <Button variant="default" id="duplicate-btn">
            <span set:html={duplicateIcon} />
            Duplicate
          </Button>
          <Button variant="default" id="delete-btn" class="text-coral hover:bg-coral/5">
            <span set:html={trashIcon} />
            Delete
          </Button>
        </div>
      </div>

      <!-- App header -->
      <div class="mb-6">
        <div class="flex items-center gap-3 mb-2">
          <span id="app-type-icon" class="flex-shrink-0 w-10 h-10 rounded-xl flex items-center justify-center text-lg font-bold"></span>
          <div class="flex-1 min-w-0">
            <h1 id="app-name" class="text-2xl font-semibold text-dark"></h1>
            <div class="flex items-center gap-2 mt-1">
              <span id="app-type-badge" class="text-xs font-medium px-2 py-0.5 rounded-full"></span>
              <span id="app-status-badge" class="text-xs font-medium px-2 py-0.5 rounded-full"></span>
              <a id="app-project-link" href="#" class="text-xs text-muted hover:text-coral transition-colors"></a>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="border-b border-dark/[0.08] mb-6">
        <nav class="flex gap-6" role="tablist">
          <button role="tab" data-tab="settings" aria-selected="true" class="tab-btn pb-3 text-sm font-medium text-dark border-b-2 border-coral -mb-px">Settings</button>
          <button role="tab" data-tab="config" aria-selected="false" class="tab-btn pb-3 text-sm font-medium text-muted hover:text-dark border-b-2 border-transparent -mb-px transition-colors">Configuration</button>
          <button role="tab" data-tab="runs" aria-selected="false" class="tab-btn pb-3 text-sm font-medium text-muted hover:text-dark border-b-2 border-transparent -mb-px transition-colors">Run History</button>
        </nav>
      </div>

      <!-- Settings tab -->
      <div id="panel-settings" class="tab-panel" role="tabpanel">
        <div class="flex flex-col gap-5">
          <!-- Name -->
          <div class="flex flex-col gap-1.5">
            <label for="app-name-input" class="text-sm font-medium text-dark">Name</label>
            <input
              type="text"
              id="app-name-input"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="Application name"
            />
          </div>

          <!-- Status -->
          <div class="flex flex-col gap-1.5">
            <label for="app-status-select" class="text-sm font-medium text-dark">Status</label>
            <select
              id="app-status-select"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer"
            >
              <option value="draft">Draft</option>
              <option value="active">Active</option>
              <option value="paused">Paused</option>
              <option value="archived">Archived</option>
            </select>
          </div>

          <!-- Metadata -->
          <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5">
            <h2 class="text-sm font-semibold text-dark mb-3">Details</h2>
            <div class="grid grid-cols-2 gap-y-3 gap-x-8 text-sm">
              <div>
                <span class="text-muted">Type</span>
                <p id="detail-type" class="text-dark font-medium mt-0.5"></p>
              </div>
              <div>
                <span class="text-muted">Project</span>
                <p id="detail-project" class="text-dark font-medium mt-0.5"></p>
              </div>
              <div>
                <span class="text-muted">Created</span>
                <p id="detail-created" class="text-dark mt-0.5"></p>
              </div>
              <div>
                <span class="text-muted">Updated</span>
                <p id="detail-updated" class="text-dark mt-0.5"></p>
              </div>
              <div>
                <span class="text-muted">Last Run</span>
                <p id="detail-last-run" class="text-dark mt-0.5"></p>
              </div>
              <div>
                <span class="text-muted">ID</span>
                <p id="detail-id" class="text-dark mt-0.5 font-mono text-xs"></p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuration tab -->
      <div id="panel-config" class="tab-panel hidden" role="tabpanel">
        <div class="flex flex-col gap-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-medium text-dark">Configuration JSON</h3>
              <p class="text-xs text-muted mt-0.5">Edit the raw JSON configuration for this application.</p>
            </div>
            <button
              type="button"
              id="format-json-btn"
              class="text-xs text-muted hover:text-dark transition-colors cursor-pointer"
            >
              Format JSON
            </button>
          </div>
          <textarea
            id="config-editor"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-4 py-3 text-dark font-mono text-sm transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-y"
            rows="20"
            spellcheck="false"
          ></textarea>
          <p id="config-error" class="text-xs text-coral hidden"></p>
        </div>
      </div>

      <!-- Run History tab -->
      <div id="panel-runs" class="tab-panel hidden" role="tabpanel">
        <div id="runs-empty" class="flex flex-col items-center justify-center py-16 text-center">
          <span set:html={playIcon} class="text-muted/40 mb-3 [&>svg]:h-8 [&>svg]:w-8" />
          <p class="text-sm text-muted">No runs yet.</p>
          <p class="text-xs text-muted/60 mt-1">This application hasn't been executed.</p>
        </div>
        <div id="runs-list" class="hidden flex flex-col gap-2"></div>
      </div>
    </div>
  </div>

  <!-- Delete confirmation modal -->
  <Modal id="delete-modal" title="Delete Application">
    <p class="text-sm text-muted mb-4">Are you sure you want to delete <span id="delete-name" class="font-semibold text-dark"></span>? This action cannot be undone.</p>
    <div class="flex justify-end gap-3">
      <Button variant="default" data-modal-close="delete-modal">Cancel</Button>
      <Button variant="primary" id="confirm-delete-btn" class="!bg-coral !text-white hover:!bg-coral/90">Delete</Button>
    </div>
  </Modal>

  <!-- Rename modal -->
  <Modal id="rename-modal" title="Rename Application">
    <div class="flex flex-col gap-3 mb-4">
      <input
        type="text"
        id="rename-input"
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        placeholder="New name"
      />
    </div>
    <div class="flex justify-end gap-3">
      <Button variant="default" data-modal-close="rename-modal">Cancel</Button>
      <Button variant="primary" id="confirm-rename-btn">Rename</Button>
    </div>
  </Modal>
</PageLayout>

<script is:inline define:vars={{ id }}>
  (function () {
    /* ---------------------------------------------------------------
       DOM refs
    --------------------------------------------------------------- */
    var loadingState = document.getElementById("loading-state");
    var errorState = document.getElementById("error-state");
    var appContent = document.getElementById("app-content");
    var appName = document.getElementById("app-name");
    var appTypeIcon = document.getElementById("app-type-icon");
    var appTypeBadge = document.getElementById("app-type-badge");
    var appStatusBadge = document.getElementById("app-status-badge");
    var appProjectLink = document.getElementById("app-project-link");
    var appNameInput = document.getElementById("app-name-input");
    var appStatusSelect = document.getElementById("app-status-select");
    var configEditor = document.getElementById("config-editor");
    var configError = document.getElementById("config-error");
    var formatJsonBtn = document.getElementById("format-json-btn");
    var saveBtn = document.getElementById("save-btn");
    var saveStatus = document.getElementById("save-status");
    var duplicateBtn = document.getElementById("duplicate-btn");
    var deleteBtn = document.getElementById("delete-btn");
    var deleteModal = document.getElementById("delete-modal");
    var deleteNameEl = document.getElementById("delete-name");
    var confirmDeleteBtn = document.getElementById("confirm-delete-btn");
    var backLink = document.getElementById("back-link");

    var app = null;
    var projectName = "";

    /* ---------------------------------------------------------------
       Type & Status display helpers
    --------------------------------------------------------------- */
    var typeColors = {
      chatbot: { bg: "bg-coral/10", text: "text-coral", label: "Chatbot", icon: "C" },
      chatflow: { bg: "bg-zen-blue/10", text: "text-zen-blue", label: "Chatflow", icon: "F" },
      workflow: { bg: "bg-zen-green/10", text: "text-zen-green", label: "Workflow", icon: "W" },
      agent: { bg: "bg-[#a855f7]/10", text: "text-[#a855f7]", label: "Agent", icon: "A" },
      text_generator: { bg: "bg-[#f59e0b]/10", text: "text-[#f59e0b]", label: "Text Generator", icon: "T" },
    };
    var statusColors = {
      draft: { bg: "bg-muted/10", text: "text-muted", label: "Draft" },
      active: { bg: "bg-zen-green/10", text: "text-zen-green", label: "Active" },
      paused: { bg: "bg-[#f59e0b]/10", text: "text-[#f59e0b]", label: "Paused" },
      archived: { bg: "bg-dark/10", text: "text-dark/60", label: "Archived" },
    };

    function applyTypeIcon(el, type) {
      var tc = typeColors[type] || { bg: "bg-dark/10", text: "text-dark", icon: "?" };
      el.className = "flex-shrink-0 w-10 h-10 rounded-xl flex items-center justify-center text-lg font-bold " + tc.bg + " " + tc.text;
      el.textContent = tc.icon;
    }

    function applyTypeBadge(el, type) {
      var tc = typeColors[type] || { bg: "bg-dark/10", text: "text-dark", label: type };
      el.className = "text-xs font-medium px-2 py-0.5 rounded-full " + tc.bg + " " + tc.text;
      el.textContent = tc.label;
    }

    function applyStatusBadge(el, status) {
      var sc = statusColors[status] || statusColors.draft;
      el.className = "text-xs font-medium px-2 py-0.5 rounded-full " + sc.bg + " " + sc.text;
      el.textContent = sc.label;
    }

    function formatDate(dateStr) {
      if (!dateStr) return "Never";
      try {
        return new Date(dateStr + "Z").toLocaleDateString(undefined, {
          year: "numeric", month: "short", day: "numeric",
          hour: "2-digit", minute: "2-digit",
        });
      } catch (_e) {
        return dateStr;
      }
    }

    /* ---------------------------------------------------------------
       Tabs
    --------------------------------------------------------------- */
    var tabBtns = document.querySelectorAll(".tab-btn");
    tabBtns.forEach(function (btn) {
      btn.addEventListener("click", function () {
        var tabId = btn.getAttribute("data-tab");

        tabBtns.forEach(function (b) {
          b.setAttribute("aria-selected", "false");
          b.classList.remove("text-dark", "border-coral");
          b.classList.add("text-muted", "border-transparent");
        });
        btn.setAttribute("aria-selected", "true");
        btn.classList.add("text-dark", "border-coral");
        btn.classList.remove("text-muted", "border-transparent");

        document.querySelectorAll(".tab-panel").forEach(function (p) {
          p.classList.add("hidden");
        });
        var panel = document.getElementById("panel-" + tabId);
        if (panel) panel.classList.remove("hidden");
      });
    });

    /* ---------------------------------------------------------------
       Breadcrumb update
    --------------------------------------------------------------- */
    function updateBreadcrumb(name) {
      var crumbs = document.querySelectorAll("[data-breadcrumb]");
      if (crumbs.length >= 2) {
        crumbs[1].textContent = name;
      }
      /* Also try the simpler approach â€” find the "Loading..." text */
      var nav = document.querySelector("nav[aria-label='breadcrumb'], .breadcrumbs");
      if (nav) {
        var items = nav.querySelectorAll("span, a, li");
        items.forEach(function (item) {
          if (item.textContent.trim() === "Loading...") {
            item.textContent = name;
          }
        });
      }
    }

    /* ---------------------------------------------------------------
       Populate page
    --------------------------------------------------------------- */
    function populatePage(data) {
      app = data;

      appName.textContent = data.name;
      applyTypeIcon(appTypeIcon, data.type);
      applyTypeBadge(appTypeBadge, data.type);
      applyStatusBadge(appStatusBadge, data.status);

      appNameInput.value = data.name;
      appStatusSelect.value = data.status || "draft";

      /* Config editor */
      try {
        var parsed = JSON.parse(data.config_json || "{}");
        configEditor.value = JSON.stringify(parsed, null, 2);
      } catch (_e) {
        configEditor.value = data.config_json || "{}";
      }

      /* Metadata */
      var tc = typeColors[data.type];
      document.getElementById("detail-type").textContent = tc ? tc.label : data.type;
      document.getElementById("detail-created").textContent = formatDate(data.created_at);
      document.getElementById("detail-updated").textContent = formatDate(data.updated_at);
      document.getElementById("detail-last-run").textContent = data.last_run_at ? formatDate(data.last_run_at) : "Never";
      document.getElementById("detail-id").textContent = data.id;

      deleteNameEl.textContent = data.name;
      updateBreadcrumb(data.name);

      /* Update back link to project if we have project context */
      if (data.project_id) {
        backLink.href = "/projects/" + data.project_id;
        backLink.querySelector("span").nextSibling.textContent = " Back to Project";
      }
    }

    /* ---------------------------------------------------------------
       Fetch application
    --------------------------------------------------------------- */
    function fetchApp(retries) {
      if (retries === undefined) retries = 3;

      fetch("/api/v1/applications/" + id)
        .then(function (res) {
          if (res.status === 429 && retries > 0) {
            var retryAfter = parseInt(res.headers.get("Retry-After") || "2", 10);
            var delay = Math.max(retryAfter, 1) * 1000;
            loadingState.querySelector("p").textContent = "Rate limited, retrying...";
            setTimeout(function () { fetchApp(retries - 1); }, delay);
            return null;
          }
          if (!res.ok) throw new Error("Not found");
          return res.json();
        })
        .then(function (data) {
          if (!data) return; /* retry in progress */
          populatePage(data);
          loadingState.classList.add("hidden");
          appContent.classList.remove("hidden");

          /* Fetch project name */
          if (data.project_id) {
            fetch("/api/v1/projects/" + data.project_id)
              .then(function (r) { return r.ok ? r.json() : null; })
              .then(function (proj) {
                if (proj) {
                  projectName = proj.name;
                  appProjectLink.textContent = proj.name;
                  appProjectLink.href = "/projects/" + data.project_id;
                  document.getElementById("detail-project").textContent = proj.name;
                }
              })
              .catch(function () {});
          }
        })
        .catch(function () {
          loadingState.classList.add("hidden");
          errorState.classList.remove("hidden");
        });
    }

    /* ---------------------------------------------------------------
       Save
    --------------------------------------------------------------- */
    function showSaveStatus(text, isError) {
      saveStatus.textContent = text;
      saveStatus.className = "text-xs " + (isError ? "text-coral" : "text-zen-green");
      saveStatus.classList.remove("hidden");
      setTimeout(function () { saveStatus.classList.add("hidden"); }, 3000);
    }

    if (saveBtn) {
      saveBtn.addEventListener("click", function () {
        if (!app) return;

        /* Validate config JSON */
        var configVal = configEditor.value.trim();
        try {
          JSON.parse(configVal);
          configError.classList.add("hidden");
        } catch (e) {
          configError.textContent = "Invalid JSON: " + e.message;
          configError.classList.remove("hidden");
          showSaveStatus("Fix JSON errors first", true);
          return;
        }

        var updates = {};
        var newName = appNameInput.value.trim();
        var newStatus = appStatusSelect.value;

        if (newName && newName !== app.name) updates.name = newName;
        if (newStatus !== app.status) updates.status = newStatus;
        if (configVal !== app.config_json) updates.config_json = configVal;

        if (Object.keys(updates).length === 0) {
          showSaveStatus("No changes", false);
          return;
        }

        saveBtn.disabled = true;

        fetch("/api/v1/applications/" + id, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updates),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Save failed"); });
            return res.json();
          })
          .then(function (data) {
            populatePage(data);
            showSaveStatus("Saved", false);
          })
          .catch(function (err) {
            showSaveStatus("Error: " + err.message, true);
          })
          .finally(function () {
            saveBtn.disabled = false;
          });
      });
    }

    /* ---------------------------------------------------------------
       Format JSON button
    --------------------------------------------------------------- */
    if (formatJsonBtn) {
      formatJsonBtn.addEventListener("click", function () {
        try {
          var parsed = JSON.parse(configEditor.value);
          configEditor.value = JSON.stringify(parsed, null, 2);
          configError.classList.add("hidden");
        } catch (e) {
          configError.textContent = "Invalid JSON: " + e.message;
          configError.classList.remove("hidden");
        }
      });
    }

    /* ---------------------------------------------------------------
       Duplicate
    --------------------------------------------------------------- */
    if (duplicateBtn) {
      duplicateBtn.addEventListener("click", function () {
        if (!app) return;
        duplicateBtn.disabled = true;

        fetch("/api/v1/applications/" + id + "/duplicate", { method: "POST" })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed"); });
            return res.json();
          })
          .then(function (newApp) {
            window.location.href = "/applications/" + newApp.id;
          })
          .catch(function (err) {
            alert("Error: " + err.message);
          })
          .finally(function () {
            duplicateBtn.disabled = false;
          });
      });
    }

    /* ---------------------------------------------------------------
       Delete
    --------------------------------------------------------------- */
    if (deleteBtn) {
      deleteBtn.addEventListener("click", function () {
        if (deleteModal) deleteModal.showModal();
      });
    }

    if (confirmDeleteBtn) {
      confirmDeleteBtn.addEventListener("click", function () {
        if (!app) return;
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.textContent = "Deleting...";

        fetch("/api/v1/applications/" + id, { method: "DELETE" })
          .then(function (res) {
            if (!res.ok) throw new Error("Delete failed");
            window.location.href = app.project_id ? "/projects/" + app.project_id : "/applications";
          })
          .catch(function (err) {
            alert("Error: " + err.message);
            confirmDeleteBtn.disabled = false;
            confirmDeleteBtn.textContent = "Delete";
          });
      });
    }

    /* ---------------------------------------------------------------
       Initial load
    --------------------------------------------------------------- */
    fetchApp();
  })();
</script>
