---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";
import Modal from "../../components/Modal.astro";

const breadcrumbs = [{ label: "Workflows" }];

/* Icons */
const searchIcon = '<svg class="h-4 w-4 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
const gridIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>';
const listIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>';
const workflowEmptyIcon = '<svg class="h-12 w-12 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>';
const importIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>';
---

<PageLayout
  title="Workflows"
  description="Manage your visual workflows"
  activeSection="workflows"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Workflows</h1>
        <p class="text-sm text-muted mt-1">Visual workflow canvas for multi-step agent pipelines</p>
      </div>
      <div class="flex items-center gap-2">
        <!-- Import button -->
        <label
          id="import-btn"
          class="inline-flex items-center gap-1.5 px-3 py-2 text-sm border border-dark/[0.08] rounded-lg text-dark hover:bg-dark/[0.03] transition-colors cursor-pointer"
          title="Import workflow from JSON"
        >
          <span set:html={importIcon} />
          <span>Import</span>
          <input type="file" accept=".json" id="import-file-input" class="hidden" />
        </label>

        <!-- View toggle -->
        <div class="flex items-center border border-dark/[0.08] rounded-lg overflow-hidden">
          <button id="view-grid-btn" class="p-2 transition-colors bg-subtle text-dark" title="Grid view">
            <span set:html={gridIcon} />
          </button>
          <button id="view-list-btn" class="p-2 transition-colors text-muted hover:text-dark" title="List view">
            <span set:html={listIcon} />
          </button>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex items-center gap-3 mb-6 flex-wrap">
      <!-- Search -->
      <div class="relative flex-1 min-w-[200px] max-w-sm">
        <span class="absolute left-3 top-1/2 -translate-y-1/2" set:html={searchIcon} />
        <input
          type="text"
          id="wf-search"
          placeholder="Search workflows..."
          class="w-full bg-paper border border-dark/[0.08] rounded-lg pl-9 pr-3 py-2 text-sm text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        />
      </div>

      <!-- Status filter -->
      <select
        id="filter-status"
        class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer"
      >
        <option value="">All statuses</option>
        <option value="draft">Draft</option>
        <option value="active">Active</option>
        <option value="paused">Paused</option>
        <option value="archived">Archived</option>
      </select>
    </div>

    <!-- Grid view container -->
    <div id="wf-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

    <!-- List view container -->
    <div id="wf-list" class="hidden flex flex-col gap-2"></div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <div class="mb-4" set:html={workflowEmptyIcon} />
      <h2 class="text-lg font-semibold text-dark mb-2">No workflows yet</h2>
      <p class="text-sm text-muted mb-6 max-w-sm">
        Workflows are created within projects. Go to a project to create your first workflow.
      </p>
      <Button href="/projects" variant="primary">Go to Projects</Button>
    </div>

    <!-- No results state -->
    <div id="no-results" class="hidden flex flex-col items-center justify-center py-16 text-center">
      <p class="text-sm text-muted">No workflows match your filters. Try adjusting the search or status filter.</p>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading workflows...</p>
    </div>
  </div>

  <!-- Duplicate confirmation modal -->
  <Modal id="duplicate-modal" title="Duplicate Workflow">
    <p class="text-sm text-muted mb-4">Create a copy of <span id="duplicate-name" class="font-semibold text-dark"></span>?</p>
    <div class="flex justify-end gap-3">
      <Button variant="default" data-modal-close="duplicate-modal">Cancel</Button>
      <Button variant="primary" id="confirm-duplicate-btn">Duplicate</Button>
    </div>
  </Modal>

  <!-- Import workflow modal -->
  <Modal id="import-modal" title="Import Workflow">
    <div class="mb-4">
      <p class="text-sm text-muted mb-3">Select a project to import the workflow into:</p>
      <select
        id="import-project-select"
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
      >
        <option value="">Loading projects...</option>
      </select>
    </div>
    <div id="import-preview" class="hidden mb-4 p-3 rounded-lg bg-dark/[0.03] border border-dark/[0.05]">
      <p class="text-xs font-semibold text-dark mb-1" id="import-preview-name"></p>
      <p class="text-xs text-muted" id="import-preview-desc"></p>
      <p class="text-xs text-muted mt-1" id="import-preview-nodes"></p>
    </div>
    <div id="import-error" class="hidden text-sm text-coral mb-4"></div>
    <div class="flex justify-end gap-3">
      <Button variant="default" data-modal-close="import-modal">Cancel</Button>
      <Button variant="primary" id="confirm-import-btn" disabled>Import</Button>
    </div>
  </Modal>
</PageLayout>

<!-- Workflow card template (grid view) -->
<template id="wf-card-template">
  <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] transition-all duration-300 hover:-translate-y-0.5 hover:border-dark/20 hover:shadow-lg p-5 relative group">
    <div class="flex items-start justify-between mb-2">
      <div class="flex items-center gap-2 min-w-0">
        <span class="flex-shrink-0 w-7 h-7 rounded-lg flex items-center justify-center text-sm font-bold bg-zen-green/10 text-zen-green">W</span>
        <h3 class="font-semibold text-dark text-sm truncate" data-field="name"></h3>
      </div>
      <div class="flex items-center gap-1">
        <button
          class="flex-shrink-0 p-1.5 rounded-lg text-muted/40 hover:text-dark hover:bg-dark/[0.05] transition-colors opacity-0 group-hover:opacity-100 cursor-pointer"
          data-field="export-btn"
          title="Export JSON"
        >
          <span class="block w-3.5 h-3.5" data-field="export-icon"></span>
        </button>
        <button
          class="flex-shrink-0 p-1.5 rounded-lg text-muted/40 hover:text-dark hover:bg-dark/[0.05] transition-colors opacity-0 group-hover:opacity-100 cursor-pointer"
          data-field="duplicate-btn"
          title="Duplicate"
        >
          <span class="block w-3.5 h-3.5" data-field="copy-icon"></span>
        </button>
      </div>
    </div>
    <div class="flex items-center gap-2 mb-3">
      <span class="text-xs font-medium px-2 py-0.5 rounded-full" data-field="status-badge"></span>
      <span class="text-xs text-muted" data-field="node-count"></span>
    </div>
    <div class="flex items-center justify-between text-xs text-muted">
      <span data-field="project-name" class="truncate"></span>
      <span data-field="last-run" class="flex-shrink-0"></span>
    </div>
    <a class="absolute inset-0 rounded-xl" data-field="link"></a>
  </div>
</template>

<!-- Workflow row template (list view) -->
<template id="wf-row-template">
  <div class="flex items-center gap-4 rounded-xl bg-subtle/80 border border-dark/[0.08] transition-all duration-200 hover:border-dark/20 hover:shadow-sm px-5 py-3 relative group">
    <span class="flex-shrink-0 w-7 h-7 rounded-lg flex items-center justify-center text-sm font-bold bg-zen-green/10 text-zen-green">W</span>
    <div class="flex-1 min-w-0">
      <h3 class="font-semibold text-dark text-sm truncate" data-field="name"></h3>
      <span class="text-xs text-muted truncate block" data-field="project-name"></span>
    </div>
    <span class="text-xs font-medium px-2 py-0.5 rounded-full flex-shrink-0" data-field="status-badge"></span>
    <span class="text-xs text-muted flex-shrink-0" data-field="node-count"></span>
    <span class="text-xs text-muted flex-shrink-0 w-20 text-right" data-field="last-run"></span>
    <button
      class="flex-shrink-0 p-1.5 rounded-lg text-muted/40 hover:text-dark hover:bg-dark/[0.05] transition-colors opacity-0 group-hover:opacity-100 cursor-pointer"
      data-field="export-btn"
      title="Export JSON"
    >
      <span class="block w-3.5 h-3.5" data-field="export-icon"></span>
    </button>
    <button
      class="flex-shrink-0 p-1.5 rounded-lg text-muted/40 hover:text-dark hover:bg-dark/[0.05] transition-colors opacity-0 group-hover:opacity-100 cursor-pointer"
      data-field="duplicate-btn"
      title="Duplicate"
    >
      <span class="block w-3.5 h-3.5" data-field="copy-icon"></span>
    </button>
    <a class="absolute inset-0 rounded-xl" data-field="link"></a>
  </div>
</template>

<script is:inline>
  (function () {
    /* ---------------------------------------------------------------
       DOM refs
    --------------------------------------------------------------- */
    var grid = document.getElementById("wf-grid");
    var list = document.getElementById("wf-list");
    var emptyState = document.getElementById("empty-state");
    var noResults = document.getElementById("no-results");
    var loadingState = document.getElementById("loading-state");
    var searchInput = document.getElementById("wf-search");
    var filterStatus = document.getElementById("filter-status");
    var viewGridBtn = document.getElementById("view-grid-btn");
    var viewListBtn = document.getElementById("view-list-btn");
    var cardTemplate = document.getElementById("wf-card-template");
    var rowTemplate = document.getElementById("wf-row-template");
    var duplicateModal = document.getElementById("duplicate-modal");
    var duplicateNameEl = document.getElementById("duplicate-name");
    var confirmDuplicateBtn = document.getElementById("confirm-duplicate-btn");
    var importFileInput = document.getElementById("import-file-input");
    var importModal = document.getElementById("import-modal");
    var importProjectSelect = document.getElementById("import-project-select");
    var importPreview = document.getElementById("import-preview");
    var importPreviewName = document.getElementById("import-preview-name");
    var importPreviewDesc = document.getElementById("import-preview-desc");
    var importPreviewNodes = document.getElementById("import-preview-nodes");
    var importError = document.getElementById("import-error");
    var confirmImportBtn = document.getElementById("confirm-import-btn");

    var allWorkflows = [];
    var projectMap = {};
    var viewMode = localStorage.getItem("orbiter_wf_view") || "grid";
    var duplicateTargetId = null;
    var importData = null;

    var copyIconSvg = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
    var exportIconSvg = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';

    /* ---------------------------------------------------------------
       Status metadata
    --------------------------------------------------------------- */
    var statusColors = {
      draft: { bg: "bg-muted/10", text: "text-muted", label: "Draft" },
      active: { bg: "bg-zen-green/10", text: "text-zen-green", label: "Active" },
      paused: { bg: "bg-[#f59e0b]/10", text: "text-[#f59e0b]", label: "Paused" },
      archived: { bg: "bg-dark/10", text: "text-dark/60", label: "Archived" },
    };

    /* ---------------------------------------------------------------
       Helpers
    --------------------------------------------------------------- */
    function formatRelativeTime(dateStr) {
      if (!dateStr) return "Never run";
      try {
        var d = new Date(dateStr + "Z");
        var now = new Date();
        var diff = now - d;
        if (diff < 60000) return "Just now";
        if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
        if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
      } catch (_e) {
        return dateStr;
      }
    }

    function getNodeCount(wf) {
      try {
        var nodes = JSON.parse(wf.nodes_json || "[]");
        return nodes.length;
      } catch (_e) {
        return 0;
      }
    }

    /* ---------------------------------------------------------------
       View toggle
    --------------------------------------------------------------- */
    function setView(mode) {
      viewMode = mode;
      localStorage.setItem("orbiter_wf_view", mode);

      if (mode === "grid") {
        viewGridBtn.classList.add("bg-subtle", "text-dark");
        viewGridBtn.classList.remove("text-muted", "hover:text-dark");
        viewListBtn.classList.remove("bg-subtle", "text-dark");
        viewListBtn.classList.add("text-muted", "hover:text-dark");
      } else {
        viewListBtn.classList.add("bg-subtle", "text-dark");
        viewListBtn.classList.remove("text-muted", "hover:text-dark");
        viewGridBtn.classList.remove("bg-subtle", "text-dark");
        viewGridBtn.classList.add("text-muted", "hover:text-dark");
      }

      renderWorkflows();
    }

    if (viewGridBtn) viewGridBtn.addEventListener("click", function () { setView("grid"); });
    if (viewListBtn) viewListBtn.addEventListener("click", function () { setView("list"); });

    /* ---------------------------------------------------------------
       Filtering
    --------------------------------------------------------------- */
    function getFilteredWorkflows() {
      var search = (searchInput.value || "").toLowerCase().trim();
      var statusFilter = filterStatus.value;

      return allWorkflows.filter(function (wf) {
        if (search && wf.name.toLowerCase().indexOf(search) === -1) return false;
        if (statusFilter && wf.status !== statusFilter) return false;
        return true;
      });
    }

    /* ---------------------------------------------------------------
       Render
    --------------------------------------------------------------- */
    function applyStatusBadge(el, status) {
      var sc = statusColors[status] || statusColors.draft;
      el.className = "text-xs font-medium px-2 py-0.5 rounded-full " + sc.bg + " " + sc.text;
      el.textContent = sc.label;
    }

    function renderWorkflows() {
      if (loadingState) loadingState.classList.add("hidden");

      if (allWorkflows.length === 0) {
        grid.classList.add("hidden");
        list.classList.add("hidden");
        noResults.classList.add("hidden");
        emptyState.classList.remove("hidden");
        return;
      }

      var filtered = getFilteredWorkflows();

      if (filtered.length === 0) {
        grid.classList.add("hidden");
        list.classList.add("hidden");
        emptyState.classList.add("hidden");
        noResults.classList.remove("hidden");
        return;
      }

      noResults.classList.add("hidden");
      emptyState.classList.add("hidden");

      if (viewMode === "grid") {
        list.classList.add("hidden");
        grid.classList.remove("hidden");
        grid.innerHTML = "";

        filtered.forEach(function (wf) {
          var card = cardTemplate.content.cloneNode(true);
          var nodeCount = getNodeCount(wf);

          card.querySelector('[data-field="name"]').textContent = wf.name;
          applyStatusBadge(card.querySelector('[data-field="status-badge"]'), wf.status);
          card.querySelector('[data-field="node-count"]').textContent = nodeCount + " node" + (nodeCount !== 1 ? "s" : "");
          card.querySelector('[data-field="project-name"]').textContent = projectMap[wf.project_id] || "";
          card.querySelector('[data-field="last-run"]').textContent = formatRelativeTime(wf.last_run_at);
          card.querySelector('[data-field="copy-icon"]').innerHTML = copyIconSvg;
          card.querySelector('[data-field="export-icon"]').innerHTML = exportIconSvg;

          var link = card.querySelector('[data-field="link"]');
          link.href = "/workflows/" + wf.id;

          var dupBtn = card.querySelector('[data-field="duplicate-btn"]');
          dupBtn.style.position = "relative";
          dupBtn.style.zIndex = "10";
          dupBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            openDuplicate(wf);
          });

          var expBtn = card.querySelector('[data-field="export-btn"]');
          expBtn.style.position = "relative";
          expBtn.style.zIndex = "10";
          expBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            exportWorkflow(wf);
          });

          grid.appendChild(card);
        });
      } else {
        grid.classList.add("hidden");
        list.classList.remove("hidden");
        list.innerHTML = "";

        filtered.forEach(function (wf) {
          var row = rowTemplate.content.cloneNode(true);
          var nodeCount = getNodeCount(wf);

          row.querySelector('[data-field="name"]').textContent = wf.name;
          row.querySelector('[data-field="project-name"]').textContent = projectMap[wf.project_id] || "";
          applyStatusBadge(row.querySelector('[data-field="status-badge"]'), wf.status);
          row.querySelector('[data-field="node-count"]').textContent = nodeCount + " nodes";
          row.querySelector('[data-field="last-run"]').textContent = formatRelativeTime(wf.last_run_at);
          row.querySelector('[data-field="copy-icon"]').innerHTML = copyIconSvg;
          row.querySelector('[data-field="export-icon"]').innerHTML = exportIconSvg;

          var link = row.querySelector('[data-field="link"]');
          link.href = "/workflows/" + wf.id;

          var dupBtn = row.querySelector('[data-field="duplicate-btn"]');
          dupBtn.style.position = "relative";
          dupBtn.style.zIndex = "10";
          dupBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            openDuplicate(wf);
          });

          var expBtn = row.querySelector('[data-field="export-btn"]');
          expBtn.style.position = "relative";
          expBtn.style.zIndex = "10";
          expBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            exportWorkflow(wf);
          });

          list.appendChild(row);
        });
      }
    }

    /* ---------------------------------------------------------------
       Export
    --------------------------------------------------------------- */
    function exportWorkflow(wf) {
      fetch("/api/v1/workflows/" + wf.id + "/export", { method: "POST" })
        .then(function (res) {
          if (!res.ok) throw new Error("Export failed");
          return res.json();
        })
        .then(function (data) {
          var blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          var url = URL.createObjectURL(blob);
          var a = document.createElement("a");
          a.href = url;
          a.download = (wf.name || "workflow").replace(/\s+/g, "_").toLowerCase() + ".json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        })
        .catch(function (err) {
          alert("Export error: " + err.message);
        });
    }

    /* ---------------------------------------------------------------
       Import
    --------------------------------------------------------------- */
    if (importFileInput) {
      importFileInput.addEventListener("change", function (e) {
        var file = e.target.files[0];
        if (!file) return;

        var reader = new FileReader();
        reader.onload = function (ev) {
          try {
            var data = JSON.parse(ev.target.result);
            /* Validate required fields */
            if (!data.nodes_json && !data.edges_json) {
              showImportError("Invalid workflow file: missing nodes_json or edges_json fields.");
              importFileInput.value = "";
              return;
            }
            importData = data;
            showImportPreview(data);
            loadProjectsForImport();
            importModal.showModal();
          } catch (_err) {
            showImportError("Invalid JSON file.");
          }
          importFileInput.value = "";
        };
        reader.readAsText(file);
      });
    }

    function showImportPreview(data) {
      importPreview.classList.remove("hidden");
      importError.classList.add("hidden");
      importPreviewName.textContent = data.name || "Untitled Workflow";
      importPreviewDesc.textContent = data.description || "No description";
      try {
        var nodes = JSON.parse(data.nodes_json || "[]");
        importPreviewNodes.textContent = nodes.length + " node" + (nodes.length !== 1 ? "s" : "");
      } catch (_e) {
        importPreviewNodes.textContent = "";
      }
    }

    function showImportError(msg) {
      importError.textContent = msg;
      importError.classList.remove("hidden");
      importPreview.classList.add("hidden");
    }

    function loadProjectsForImport() {
      fetch("/api/v1/projects")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed");
          return res.json();
        })
        .then(function (body) { return body.data || body; })
        .then(function (projects) {
          importProjectSelect.innerHTML = "";
          if (projects.length === 0) {
            var opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "No projects available";
            importProjectSelect.appendChild(opt);
            return;
          }
          projects.forEach(function (p) {
            var opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = p.name;
            importProjectSelect.appendChild(opt);
          });
          confirmImportBtn.disabled = false;
        })
        .catch(function () {
          importProjectSelect.innerHTML = '<option value="">Failed to load projects</option>';
        });
    }

    if (confirmImportBtn) {
      confirmImportBtn.addEventListener("click", function () {
        if (!importData || !importProjectSelect.value) return;

        confirmImportBtn.disabled = true;
        confirmImportBtn.textContent = "Importing...";

        var body = {
          name: importData.name || "Imported Workflow",
          project_id: importProjectSelect.value,
          description: importData.description || "",
          nodes_json: typeof importData.nodes_json === "string" ? importData.nodes_json : JSON.stringify(importData.nodes_json || []),
          edges_json: typeof importData.edges_json === "string" ? importData.edges_json : JSON.stringify(importData.edges_json || []),
          viewport_json: typeof importData.viewport_json === "string" ? importData.viewport_json : JSON.stringify(importData.viewport_json || { x: 0, y: 0, zoom: 1 }),
        };

        fetch("/api/v1/workflows/import", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Import failed"); });
            return res.json();
          })
          .then(function (newWf) {
            importModal.close();
            importData = null;
            allWorkflows.unshift(newWf);
            allWorkflows.forEach(function (wf) {
              wf._nodeCount = getNodeCount(wf);
            });
            renderWorkflows();
          })
          .catch(function (err) {
            showImportError("Error: " + err.message);
          })
          .finally(function () {
            confirmImportBtn.disabled = false;
            confirmImportBtn.textContent = "Import";
          });
      });
    }

    /* ---------------------------------------------------------------
       Duplicate
    --------------------------------------------------------------- */
    function openDuplicate(wf) {
      duplicateTargetId = wf.id;
      duplicateNameEl.textContent = wf.name;
      duplicateModal.showModal();
    }

    if (confirmDuplicateBtn) {
      confirmDuplicateBtn.addEventListener("click", function () {
        if (!duplicateTargetId) return;

        confirmDuplicateBtn.disabled = true;
        confirmDuplicateBtn.textContent = "Duplicating...";

        fetch("/api/v1/workflows/" + duplicateTargetId + "/duplicate", { method: "POST" })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to duplicate"); });
            return res.json();
          })
          .then(function (newWf) {
            duplicateModal.close();
            duplicateTargetId = null;
            allWorkflows.unshift(newWf);
            renderWorkflows();
          })
          .catch(function (err) {
            alert("Error: " + err.message);
          })
          .finally(function () {
            confirmDuplicateBtn.disabled = false;
            confirmDuplicateBtn.textContent = "Duplicate";
          });
      });
    }

    /* ---------------------------------------------------------------
       Data fetching
    --------------------------------------------------------------- */
    function fetchWorkflows() {
      fetch("/api/v1/workflows")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load workflows");
          return res.json();
        })
        .then(function (body) { return body.data || body; })
        .then(function (workflows) {
          allWorkflows = workflows;
          fetchProjectNames();
        })
        .catch(function () {
          if (loadingState) loadingState.classList.add("hidden");
          grid.innerHTML = '<p class="text-sm text-coral col-span-full text-center py-10">Failed to load workflows. Is the API server running?</p>';
          grid.classList.remove("hidden");
        });
    }

    function fetchProjectNames() {
      var projectIds = [];
      allWorkflows.forEach(function (wf) {
        if (wf.project_id && projectIds.indexOf(wf.project_id) === -1) {
          projectIds.push(wf.project_id);
        }
      });

      if (projectIds.length === 0) {
        renderWorkflows();
        return;
      }

      fetch("/api/v1/projects")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed");
          return res.json();
        })
        .then(function (body) { return body.data || body; })
        .then(function (projects) {
          projects.forEach(function (p) { projectMap[p.id] = p.name; });
          renderWorkflows();
        })
        .catch(function () {
          renderWorkflows();
        });
    }

    /* ---------------------------------------------------------------
       Event listeners
    --------------------------------------------------------------- */
    var filterTimeout;
    function onFilterChange() {
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(renderWorkflows, 150);
    }
    if (searchInput) searchInput.addEventListener("input", onFilterChange);
    if (filterStatus) filterStatus.addEventListener("change", onFilterChange);

    /* ---------------------------------------------------------------
       Initial load
    --------------------------------------------------------------- */
    setView(viewMode);
    fetchWorkflows();
  })();
</script>
