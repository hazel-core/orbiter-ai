---
import PageLayout from "../../layouts/PageLayout.astro";
import Modal from "../../components/Modal.astro";
import CanvasIsland from "../../islands/Canvas/CanvasIsland";

const { id } = Astro.params;

const copyIcon = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
---

<PageLayout
  title="Workflow Canvas"
  activeSection="workflows"
  breadcrumbs={[
    { label: "Workflows", href: "/workflows" },
    { label: "Canvas" },
  ]}
  class="!p-0 !overflow-hidden flex flex-col"
>
  <div class="flex-1 min-h-0 relative">
    <CanvasIsland client:only="react" workflowId={id} />

    <!-- Floating Deploy button -->
    <button
      id="deploy-api-btn"
      class="absolute top-3 right-3 z-20 inline-flex items-center gap-1.5 px-3 py-2 text-xs font-medium border border-coral/30 text-coral bg-paper/90 backdrop-blur-sm rounded-lg hover:bg-coral/10 transition-colors cursor-pointer shadow-sm"
      title="Deploy as API endpoint"
    >
      <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 4 0 4 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-4 0-4"/></svg>
      Deploy as API
    </button>
  </div>

  <!-- Deploy as API modal -->
  <Modal id="deploy-modal" title="Deploy as API">
    <div id="deploy-form-content" class="flex flex-col gap-4">
      <p class="text-sm text-muted">Deploy this workflow as an API endpoint. You'll receive a one-time API key.</p>
      <div class="flex flex-col gap-1.5">
        <label for="deploy-name" class="text-xs font-medium text-dark">Deployment Name</label>
        <input
          type="text"
          id="deploy-name"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
          placeholder="My Workflow API"
        />
      </div>
      <div class="flex flex-col gap-1.5">
        <label for="deploy-rate-limit" class="text-xs font-medium text-dark">Rate Limit (requests/min)</label>
        <input
          type="number"
          id="deploy-rate-limit"
          min="1"
          max="10000"
          value="60"
          class="w-32 bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        />
      </div>
      <div class="flex justify-end">
        <button id="deploy-submit-btn" class="px-4 py-2 text-sm font-medium bg-coral text-white rounded-lg hover:bg-coral/80 transition-colors cursor-pointer">
          Deploy
        </button>
      </div>
    </div>
    <!-- Success view -->
    <div id="deploy-success-content" class="hidden flex flex-col gap-4">
      <div class="flex items-center gap-2 text-zen-green">
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        <span class="text-sm font-semibold">Deployed successfully!</span>
      </div>
      <div class="flex flex-col gap-1.5">
        <label class="text-xs font-semibold text-muted uppercase tracking-wider">API Key (shown once)</label>
        <div class="flex items-center gap-2">
          <code id="deploy-api-key" class="flex-1 bg-dark text-paper rounded-lg px-3 py-2 text-xs font-mono break-all"></code>
          <button id="copy-api-key-btn" class="shrink-0 p-2 rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-subtle transition-colors cursor-pointer" title="Copy">
            <span set:html={copyIcon} />
          </button>
        </div>
        <p class="text-xs text-coral font-medium">Save this key now â€” it won't be shown again.</p>
      </div>
      <div class="flex flex-col gap-1.5">
        <label class="text-xs font-semibold text-muted uppercase tracking-wider">Endpoint URL</label>
        <div class="flex items-center gap-2">
          <code id="deploy-endpoint-url" class="flex-1 bg-subtle/80 border border-dark/[0.06] rounded-lg px-3 py-2 text-xs font-mono break-all"></code>
          <button id="copy-endpoint-btn" class="shrink-0 p-2 rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-subtle transition-colors cursor-pointer" title="Copy">
            <span set:html={copyIcon} />
          </button>
        </div>
      </div>
      <div class="flex flex-col gap-1.5">
        <label class="text-xs font-semibold text-muted uppercase tracking-wider">Usage Example</label>
        <pre id="deploy-curl-example" class="bg-dark text-paper rounded-lg px-4 py-3 text-xs font-mono overflow-x-auto whitespace-pre-wrap leading-relaxed"></pre>
      </div>
      <div class="flex justify-end">
        <a href="/deployments" class="text-sm text-coral hover:underline">View all deployments &rarr;</a>
      </div>
    </div>
  </Modal>
</PageLayout>

<script is:inline define:vars={{ workflowId: id }}>
  (function () {
    var deployBtn = document.getElementById("deploy-api-btn");
    var deployModal = document.getElementById("deploy-modal");
    var deployNameInput = document.getElementById("deploy-name");
    var deployRateLimitInput = document.getElementById("deploy-rate-limit");
    var deploySubmitBtn = document.getElementById("deploy-submit-btn");
    var deployFormContent = document.getElementById("deploy-form-content");
    var deploySuccessContent = document.getElementById("deploy-success-content");

    deployBtn.addEventListener("click", function () {
      deployFormContent.classList.remove("hidden");
      deploySuccessContent.classList.add("hidden");
      deployNameInput.value = "Workflow API";
      deployRateLimitInput.value = "60";
      deployModal.showModal();
    });

    deploySubmitBtn.addEventListener("click", async function () {
      var name = deployNameInput.value.trim();
      if (!name) { deployNameInput.focus(); return; }
      deploySubmitBtn.disabled = true;
      deploySubmitBtn.textContent = "Deploying...";
      try {
        var resp = await fetch("/api/deployments", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: name,
            entity_type: "workflow",
            entity_id: workflowId,
            rate_limit: parseInt(deployRateLimitInput.value, 10) || 60,
          }),
        });
        if (!resp.ok) {
          var err = await resp.json().catch(function () { return {}; });
          throw new Error(err.detail || "Deployment failed");
        }
        var data = await resp.json();
        var baseUrl = window.location.origin;
        var endpointUrl = baseUrl + "/api/deployed/" + data.id + "/run";

        document.getElementById("deploy-api-key").textContent = data.api_key;
        document.getElementById("deploy-endpoint-url").textContent = endpointUrl;
        document.getElementById("deploy-curl-example").textContent =
          "curl -X POST " + endpointUrl + " \\\n  -H \"Authorization: Bearer " + data.api_key + "\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"input\": \"Hello!\"}'";

        deployFormContent.classList.add("hidden");
        deploySuccessContent.classList.remove("hidden");
      } catch (ex) {
        alert(ex.message || "Failed to deploy");
      } finally {
        deploySubmitBtn.disabled = false;
        deploySubmitBtn.textContent = "Deploy";
      }
    });

    document.getElementById("copy-api-key-btn").addEventListener("click", function () {
      navigator.clipboard.writeText(document.getElementById("deploy-api-key").textContent);
    });
    document.getElementById("copy-endpoint-btn").addEventListener("click", function () {
      navigator.clipboard.writeText(document.getElementById("deploy-endpoint-url").textContent);
    });
  })();
</script>
