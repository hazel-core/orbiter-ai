---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";
import Modal from "../../components/Modal.astro";
import Input from "../../components/Input.astro";

const breadcrumbs = [{ label: "Knowledge Base" }];

/* Icons */
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const bookIcon = '<svg class="h-12 w-12 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>';
---

<PageLayout
  title="Knowledge Base"
  description="Manage your knowledge bases for RAG"
  activeSection="knowledge"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Knowledge Base</h1>
        <p class="text-sm text-muted mt-1">Create and manage knowledge bases for retrieval-augmented generation</p>
      </div>
      <Button variant="primary" id="create-kb-btn">
        <span set:html={plusIcon} />
        New Knowledge Base
      </Button>
    </div>

    <!-- KB grid (populated by JS) -->
    <div id="kb-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <div class="mb-4" set:html={bookIcon} />
      <h2 class="text-lg font-semibold text-dark mb-2">No knowledge bases yet</h2>
      <p class="text-sm text-muted mb-6 max-w-sm">
        Knowledge bases let you upload documents and use them for retrieval-augmented generation in your agents.
      </p>
      <Button variant="primary" id="create-kb-cta">
        <span set:html={plusIcon} />
        Create your first knowledge base
      </Button>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading knowledge bases...</p>
    </div>
  </div>

  <!-- Create KB Modal -->
  <Modal id="create-kb-modal" title="Create Knowledge Base">
    <form id="create-kb-form" class="flex flex-col gap-4">
      <Input
        label="Name"
        name="name"
        placeholder="My Knowledge Base"
        required
      />
      <div class="flex flex-col gap-1.5">
        <label for="kb-description" class="text-sm font-medium text-dark">Description</label>
        <textarea
          id="kb-description"
          name="description"
          rows="3"
          placeholder="What documents will this knowledge base contain?"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-none"
        ></textarea>
      </div>
      <div class="flex flex-col gap-1.5">
        <label for="kb-embedding-model" class="text-sm font-medium text-dark">Embedding Model</label>
        <select
          id="kb-embedding-model"
          name="embedding_model"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer"
        >
          <option value="text-embedding-3-small">text-embedding-3-small</option>
          <option value="text-embedding-3-large">text-embedding-3-large</option>
          <option value="text-embedding-ada-002">text-embedding-ada-002</option>
        </select>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <Input
          label="Chunk Size"
          name="chunk_size"
          type="number"
          value="512"
          min="64"
          max="8192"
        />
        <Input
          label="Chunk Overlap"
          name="chunk_overlap"
          type="number"
          value="50"
          min="0"
          max="4096"
        />
      </div>
      <div id="create-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="create-kb-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="create-submit-btn">
          Create Knowledge Base
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Delete Confirmation Modal -->
  <Modal id="delete-kb-modal" title="Delete Knowledge Base">
    <div class="flex flex-col gap-4">
      <p class="text-sm text-muted">
        Are you sure you want to delete <strong id="delete-kb-name" class="text-dark"></strong>?
        All documents and chunks will be permanently removed. This action cannot be undone.
      </p>
      <div id="delete-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="delete-kb-modal">
          Cancel
        </Button>
        <Button variant="primary" id="delete-confirm-btn" class="bg-coral hover:bg-coral/90 text-paper">
          Delete Knowledge Base
        </Button>
      </div>
    </div>
  </Modal>
</PageLayout>

<!-- KB card template -->
<template id="kb-card-template">
  <div class="group relative rounded-xl bg-subtle/80 border border-dark/[0.08] transition-all duration-300 hover:-translate-y-0.5 hover:border-dark/20 hover:shadow-lg p-5">
    <a class="block" data-field="link">
      <h3 class="font-semibold text-dark text-base truncate pr-8 mb-1" data-field="name"></h3>
      <p class="text-sm text-muted line-clamp-2 mb-4 min-h-[2.5rem]" data-field="description"></p>
      <div class="flex items-center gap-4 text-xs text-muted">
        <span class="flex items-center gap-1" data-field="docs"></span>
        <span class="flex items-center gap-1" data-field="chunks"></span>
        <span class="flex items-center gap-1" data-field="model"></span>
      </div>
    </a>
    <button
      type="button"
      data-action="delete"
      class="absolute top-4 right-4 flex h-7 w-7 items-center justify-center rounded-lg text-muted/50 opacity-0 group-hover:opacity-100 hover:bg-coral/10 hover:text-coral transition-all cursor-pointer"
      title="Delete"
    >
      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
    </button>
  </div>
</template>

<script is:inline>
  (function () {
    var grid = document.getElementById("kb-grid");
    var emptyState = document.getElementById("empty-state");
    var loadingState = document.getElementById("loading-state");
    var createBtn = document.getElementById("create-kb-btn");
    var createCta = document.getElementById("create-kb-cta");
    var modal = document.getElementById("create-kb-modal");
    var form = document.getElementById("create-kb-form");
    var createError = document.getElementById("create-error");
    var submitBtn = document.getElementById("create-submit-btn");
    var template = document.getElementById("kb-card-template");

    var deleteModal = document.getElementById("delete-kb-modal");
    var deleteKbName = document.getElementById("delete-kb-name");
    var deleteError = document.getElementById("delete-error");
    var deleteConfirmBtn = document.getElementById("delete-confirm-btn");

    var pendingDeleteId = null;

    var docSvg = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>';
    var chunkSvg = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>';
    var modelSvg = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>';

    function renderKbs(kbs) {
      if (loadingState) loadingState.classList.add("hidden");

      if (!kbs || kbs.length === 0) {
        grid.classList.add("hidden");
        emptyState.classList.remove("hidden");
        return;
      }

      grid.classList.remove("hidden");
      emptyState.classList.add("hidden");
      grid.innerHTML = "";

      kbs.forEach(function (kb) {
        var card = template.content.cloneNode(true);
        var link = card.querySelector('[data-field="link"]');
        link.href = "/knowledge/" + kb.id;

        card.querySelector('[data-field="name"]').textContent = kb.name;

        var descEl = card.querySelector('[data-field="description"]');
        descEl.textContent = kb.description || "No description";
        if (!kb.description) descEl.classList.add("italic", "text-muted/50");

        card.querySelector('[data-field="docs"]').innerHTML = docSvg + " " + kb.doc_count + " docs";
        card.querySelector('[data-field="chunks"]').innerHTML = chunkSvg + " " + kb.chunk_count + " chunks";
        card.querySelector('[data-field="model"]').innerHTML = modelSvg + " " + kb.embedding_model;

        var deleteBtn = card.querySelector('[data-action="delete"]');
        deleteBtn.setAttribute("data-kb-id", kb.id);
        deleteBtn.setAttribute("data-kb-name", kb.name);

        grid.appendChild(card);
      });
    }

    function fetchKbs() {
      fetch("/api/knowledge-bases")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load knowledge bases");
          return res.json();
        })
        .then(renderKbs)
        .catch(function () {
          if (loadingState) loadingState.classList.add("hidden");
          grid.innerHTML = '<p class="text-sm text-coral col-span-full text-center py-10">Failed to load knowledge bases. Is the API server running?</p>';
          grid.classList.remove("hidden");
        });
    }

    function openCreateModal() {
      if (modal) modal.showModal();
    }

    if (createBtn) createBtn.addEventListener("click", openCreateModal);
    if (createCta) createCta.addEventListener("click", openCreateModal);

    if (form) {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        createError.classList.add("hidden");

        var formData = new FormData(form);
        var name = (formData.get("name") || "").toString().trim();
        var description = (formData.get("description") || "").toString().trim();
        var embedding_model = (formData.get("embedding_model") || "text-embedding-3-small").toString();
        var chunk_size = parseInt(formData.get("chunk_size") || "512", 10);
        var chunk_overlap = parseInt(formData.get("chunk_overlap") || "50", 10);

        if (!name) {
          createError.textContent = "Knowledge base name is required";
          createError.classList.remove("hidden");
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "Creating...";

        fetch("/api/knowledge-bases", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: name,
            description: description,
            embedding_model: embedding_model,
            chunk_size: chunk_size,
            chunk_overlap: chunk_overlap,
          }),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to create knowledge base"); });
            return res.json();
          })
          .then(function (kb) {
            form.reset();
            modal.close();
            window.location.href = "/knowledge/" + kb.id;
          })
          .catch(function (err) {
            createError.textContent = err.message;
            createError.classList.remove("hidden");
          })
          .finally(function () {
            submitBtn.disabled = false;
            submitBtn.textContent = "Create Knowledge Base";
          });
      });
    }

    /* Delete */
    if (grid) {
      grid.addEventListener("click", function (e) {
        var btn = e.target.closest('[data-action="delete"]');
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();
        pendingDeleteId = btn.getAttribute("data-kb-id");
        deleteKbName.textContent = btn.getAttribute("data-kb-name");
        deleteError.classList.add("hidden");
        deleteModal.showModal();
      });
    }

    if (deleteConfirmBtn) {
      deleteConfirmBtn.addEventListener("click", function () {
        if (!pendingDeleteId) return;
        deleteError.classList.add("hidden");
        deleteConfirmBtn.disabled = true;
        deleteConfirmBtn.textContent = "Deleting...";

        fetch("/api/knowledge-bases/" + pendingDeleteId, { method: "DELETE" })
          .then(function (res) {
            if (!res.ok && res.status !== 204)
              throw new Error("Failed to delete knowledge base");
            deleteModal.close();
            pendingDeleteId = null;
            fetchKbs();
          })
          .catch(function (err) {
            deleteError.textContent = err.message;
            deleteError.classList.remove("hidden");
          })
          .finally(function () {
            deleteConfirmBtn.disabled = false;
            deleteConfirmBtn.textContent = "Delete Knowledge Base";
          });
      });
    }

    // Initial load
    fetchKbs();
  })();
</script>
