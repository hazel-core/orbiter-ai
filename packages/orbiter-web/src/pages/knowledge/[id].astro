---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";
import Modal from "../../components/Modal.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Knowledge Base", href: "/knowledge" },
  { label: "Loading..." },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const trashIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';
---

<PageLayout
  title="Knowledge Base"
  description="Knowledge base details"
  activeSection="knowledge"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading knowledge base...</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <p class="text-lg font-semibold text-dark mb-2">Knowledge base not found</p>
      <p class="text-sm text-muted mb-6">This knowledge base may have been deleted.</p>
      <Button href="/knowledge" variant="bordered">
        <span set:html={backIcon} />
        Back to Knowledge Bases
      </Button>
    </div>

    <!-- KB content (hidden until loaded) -->
    <div id="kb-content" class="hidden">
      <!-- Back link + actions row -->
      <div class="flex items-center justify-between mb-6">
        <a href="/knowledge" class="flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          All Knowledge Bases
        </a>
        <div class="flex items-center gap-2">
          <Button variant="default" id="delete-btn" class="text-sm text-coral hover:bg-coral/5">
            <span set:html={trashIcon} />
            Delete
          </Button>
        </div>
      </div>

      <!-- KB header -->
      <div class="mb-8">
        <h1 id="kb-name" class="text-2xl font-semibold text-dark mb-2"></h1>
        <p id="kb-description" class="text-sm text-muted"></p>
      </div>

      <!-- Stats cards -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5">
          <p class="text-xs font-medium text-muted uppercase tracking-wide mb-1">Documents</p>
          <p id="stat-docs" class="text-2xl font-semibold text-dark">0</p>
        </div>
        <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5">
          <p class="text-xs font-medium text-muted uppercase tracking-wide mb-1">Chunks</p>
          <p id="stat-chunks" class="text-2xl font-semibold text-dark">0</p>
        </div>
        <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5">
          <p class="text-xs font-medium text-muted uppercase tracking-wide mb-1">Index Size</p>
          <p id="stat-index-size" class="text-2xl font-semibold text-dark">0 B</p>
        </div>
      </div>

      <!-- Configuration -->
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5 mb-8">
        <h2 class="text-sm font-semibold text-dark mb-4">Configuration</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
          <div>
            <span class="text-muted">Embedding Model</span>
            <p id="kb-embedding-model" class="text-dark font-medium mt-0.5"></p>
          </div>
          <div>
            <span class="text-muted">Chunk Size</span>
            <p id="kb-chunk-size" class="text-dark font-medium mt-0.5"></p>
          </div>
          <div>
            <span class="text-muted">Chunk Overlap</span>
            <p id="kb-chunk-overlap" class="text-dark font-medium mt-0.5"></p>
          </div>
        </div>
      </div>

      <!-- Document list -->
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5">
        <h2 class="text-sm font-semibold text-dark mb-4">Documents</h2>
        <div id="doc-list">
          <p class="text-sm text-muted italic">No documents uploaded yet. Document upload will be available in a future update.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <Modal id="delete-modal" title="Delete Knowledge Base">
    <div class="flex flex-col gap-4">
      <p class="text-sm text-muted">
        Are you sure you want to delete <strong id="delete-kb-name" class="text-dark"></strong>?
        All documents and chunks will be permanently removed. This action cannot be undone.
      </p>
      <div id="delete-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="delete-modal">
          Cancel
        </Button>
        <Button variant="primary" id="delete-confirm-btn" class="bg-coral hover:bg-coral/90 text-paper">
          Delete Knowledge Base
        </Button>
      </div>
    </div>
  </Modal>
</PageLayout>

<script is:inline define:vars={{ kbId: id }}>
  (function () {
    var loadingState = document.getElementById("loading-state");
    var errorState = document.getElementById("error-state");
    var content = document.getElementById("kb-content");
    var nameEl = document.getElementById("kb-name");
    var descEl = document.getElementById("kb-description");
    var statDocs = document.getElementById("stat-docs");
    var statChunks = document.getElementById("stat-chunks");
    var statIndexSize = document.getElementById("stat-index-size");
    var embeddingModelEl = document.getElementById("kb-embedding-model");
    var chunkSizeEl = document.getElementById("kb-chunk-size");
    var chunkOverlapEl = document.getElementById("kb-chunk-overlap");

    var deleteBtn = document.getElementById("delete-btn");
    var deleteModal = document.getElementById("delete-modal");
    var deleteKbName = document.getElementById("delete-kb-name");
    var deleteError = document.getElementById("delete-error");
    var deleteConfirmBtn = document.getElementById("delete-confirm-btn");

    var currentKb = null;

    function formatSize(chunks) {
      /* Estimate: ~500 bytes per chunk embedding (1536 dims * float16 ~ 3KB, but stored sparse) */
      var bytes = chunks * 3072;
      if (bytes === 0) return "0 B";
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
      return (bytes / 1048576).toFixed(1) + " MB";
    }

    function showKb(kb) {
      currentKb = kb;
      loadingState.classList.add("hidden");
      content.classList.remove("hidden");

      nameEl.textContent = kb.name;
      descEl.textContent = kb.description || "No description";
      if (!kb.description) descEl.classList.add("italic", "text-muted/50");

      statDocs.textContent = kb.doc_count;
      statChunks.textContent = kb.chunk_count;
      statIndexSize.textContent = formatSize(kb.chunk_count);

      embeddingModelEl.textContent = kb.embedding_model;
      chunkSizeEl.textContent = kb.chunk_size + " tokens";
      chunkOverlapEl.textContent = kb.chunk_overlap + " tokens";

      /* Update breadcrumb */
      var allSpans = document.querySelectorAll("nav span");
      allSpans.forEach(function (span) {
        if (span.textContent.trim() === "Loading...") {
          span.textContent = kb.name;
        }
      });
    }

    function showError() {
      loadingState.classList.add("hidden");
      errorState.classList.remove("hidden");
    }

    function fetchKb() {
      fetch("/api/knowledge-bases/" + kbId)
        .then(function (res) {
          if (!res.ok) throw new Error("Not found");
          return res.json();
        })
        .then(showKb)
        .catch(showError);
    }

    /* Delete */
    if (deleteBtn) {
      deleteBtn.addEventListener("click", function () {
        if (!currentKb) return;
        deleteKbName.textContent = currentKb.name;
        deleteError.classList.add("hidden");
        deleteModal.showModal();
      });
    }

    if (deleteConfirmBtn) {
      deleteConfirmBtn.addEventListener("click", function () {
        deleteError.classList.add("hidden");
        deleteConfirmBtn.disabled = true;
        deleteConfirmBtn.textContent = "Deleting...";

        fetch("/api/knowledge-bases/" + kbId, { method: "DELETE" })
          .then(function (res) {
            if (!res.ok && res.status !== 204)
              throw new Error("Failed to delete knowledge base");
            window.location.href = "/knowledge";
          })
          .catch(function (err) {
            deleteError.textContent = err.message;
            deleteError.classList.remove("hidden");
            deleteConfirmBtn.disabled = false;
            deleteConfirmBtn.textContent = "Delete Knowledge Base";
          });
      });
    }

    // Initial load
    fetchKb();
  })();
</script>
