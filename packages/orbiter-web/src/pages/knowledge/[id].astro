---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";
import Modal from "../../components/Modal.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Knowledge Base", href: "/knowledge" },
  { label: "Loading..." },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const trashIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';
const uploadIcon = '<svg class="h-8 w-8 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>';
const fileIcon = '<svg class="h-4 w-4 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>';
const trashSmallIcon = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
const chevronIcon = '<svg class="h-3.5 w-3.5 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';

/* File type icons */
const typeIcons: Record<string, string> = {
  pdf: '<svg class="h-4 w-4 text-coral shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
  docx: '<svg class="h-4 w-4 text-zen-blue shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>',
  txt: '<svg class="h-4 w-4 text-muted shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
  md: '<svg class="h-4 w-4 text-muted shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
  csv: '<svg class="h-4 w-4 text-zen-green shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><line x1="12" y1="9" x2="12" y2="21"/></svg>',
  html: '<svg class="h-4 w-4 text-coral shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
};
---

<PageLayout
  title="Knowledge Base"
  description="Knowledge base details"
  activeSection="knowledge"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading knowledge base...</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <p class="text-lg font-semibold text-dark mb-2">Knowledge base not found</p>
      <p class="text-sm text-muted mb-6">This knowledge base may have been deleted.</p>
      <Button href="/knowledge" variant="bordered">
        <span set:html={backIcon} />
        Back to Knowledge Bases
      </Button>
    </div>

    <!-- KB content (hidden until loaded) -->
    <div id="kb-content" class="hidden">
      <!-- Back link + actions row -->
      <div class="flex items-center justify-between mb-6">
        <a href="/knowledge" class="flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          All Knowledge Bases
        </a>
        <div class="flex items-center gap-2">
          <Button variant="default" id="delete-btn" class="text-sm text-coral hover:bg-coral/5">
            <span set:html={trashIcon} />
            Delete
          </Button>
        </div>
      </div>

      <!-- KB header -->
      <div class="mb-8">
        <h1 id="kb-name" class="text-2xl font-semibold text-dark mb-2"></h1>
        <p id="kb-description" class="text-sm text-muted"></p>
      </div>

      <!-- Stats cards -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5">
          <p class="text-xs font-medium text-muted uppercase tracking-wide mb-1">Documents</p>
          <p id="stat-docs" class="text-2xl font-semibold text-dark">0</p>
        </div>
        <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5">
          <p class="text-xs font-medium text-muted uppercase tracking-wide mb-1">Chunks</p>
          <p id="stat-chunks" class="text-2xl font-semibold text-dark">0</p>
        </div>
        <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5">
          <p class="text-xs font-medium text-muted uppercase tracking-wide mb-1">Index Size</p>
          <p id="stat-index-size" class="text-2xl font-semibold text-dark">0 B</p>
        </div>
      </div>

      <!-- Configuration -->
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5 mb-8">
        <h2 class="text-sm font-semibold text-dark mb-4">Configuration</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
          <div>
            <span class="text-muted">Embedding Model</span>
            <p id="kb-embedding-model" class="text-dark font-medium mt-0.5"></p>
          </div>
          <div>
            <span class="text-muted">Chunk Size</span>
            <p id="kb-chunk-size" class="text-dark font-medium mt-0.5"></p>
          </div>
          <div>
            <span class="text-muted">Chunk Overlap</span>
            <p id="kb-chunk-overlap" class="text-dark font-medium mt-0.5"></p>
          </div>
        </div>
      </div>

      <!-- Retrieval Settings -->
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5 mb-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-semibold text-dark">Retrieval Settings</h2>
          <button id="save-retrieval-btn" class="hidden px-3 py-1.5 text-xs font-medium text-paper bg-zen-blue rounded-md hover:bg-zen-blue/90 transition-colors cursor-pointer">Save Changes</button>
        </div>
        <div id="retrieval-saved-msg" class="hidden text-xs text-zen-green mb-3">Settings saved.</div>
        <div id="retrieval-error-msg" class="hidden text-xs text-coral mb-3"></div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
          <!-- Search type -->
          <div>
            <label class="text-[10px] font-medium text-muted uppercase tracking-wide">Search Type</label>
            <div class="mt-1.5 flex gap-1">
              <button class="search-type-btn flex-1 px-3 py-1.5 text-xs font-medium rounded-md border transition-colors cursor-pointer" data-value="keyword">Keyword</button>
              <button class="search-type-btn flex-1 px-3 py-1.5 text-xs font-medium rounded-md border transition-colors cursor-pointer" data-value="semantic">Semantic</button>
              <button class="search-type-btn flex-1 px-3 py-1.5 text-xs font-medium rounded-md border transition-colors cursor-pointer" data-value="hybrid">Hybrid</button>
            </div>
          </div>

          <!-- Reranker toggle -->
          <div>
            <label class="text-[10px] font-medium text-muted uppercase tracking-wide">Reranking</label>
            <div class="mt-1.5 flex items-center gap-3">
              <button id="reranker-toggle" class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors cursor-pointer bg-dark/15" role="switch" aria-checked="false">
                <span class="reranker-dot inline-block h-3.5 w-3.5 rounded-full bg-paper shadow-sm transition-transform translate-x-0.5"></span>
              </button>
              <span id="reranker-label" class="text-xs text-muted">Disabled</span>
            </div>
          </div>

          <!-- Top-K slider -->
          <div>
            <label class="text-[10px] font-medium text-muted uppercase tracking-wide">Top K Results</label>
            <div class="mt-1.5 flex items-center gap-3">
              <input type="range" id="topk-slider" min="1" max="20" value="5" class="flex-1 h-1.5 accent-zen-blue cursor-pointer" />
              <span id="topk-value" class="text-xs font-medium text-dark w-6 text-right">5</span>
            </div>
          </div>

          <!-- Similarity threshold slider -->
          <div>
            <label class="text-[10px] font-medium text-muted uppercase tracking-wide">Similarity Threshold</label>
            <div class="mt-1.5 flex items-center gap-3">
              <input type="range" id="threshold-slider" min="0" max="100" value="0" class="flex-1 h-1.5 accent-zen-blue cursor-pointer" />
              <span id="threshold-value" class="text-xs font-medium text-dark w-8 text-right">0.00</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Retrieval -->
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5 mb-8">
        <h2 class="text-sm font-semibold text-dark mb-4">Test Retrieval</h2>
        <div class="flex gap-2">
          <input type="text" id="test-query-input" placeholder="Enter a search query..." class="flex-1 rounded-md border border-dark/[0.12] bg-paper px-3 py-2 text-sm text-dark placeholder:text-muted/50 focus:outline-none focus:border-dark/30" />
          <button id="test-query-btn" class="px-4 py-2 text-sm font-medium text-paper bg-zen-blue rounded-md hover:bg-zen-blue/90 transition-colors cursor-pointer">Search</button>
        </div>
        <div id="test-results" class="hidden mt-4">
          <p id="test-results-count" class="text-xs font-medium text-muted uppercase tracking-wide mb-3"></p>
          <div id="test-results-list" class="space-y-2"></div>
        </div>
        <div id="test-no-results" class="hidden mt-4">
          <p class="text-sm text-muted italic">No matching chunks found.</p>
        </div>
        <div id="test-error" class="hidden mt-4">
          <p class="text-sm text-coral" id="test-error-msg"></p>
        </div>
      </div>

      <!-- Upload section -->
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5 mb-8">
        <h2 class="text-sm font-semibold text-dark mb-4">Upload Documents</h2>
        <div
          id="drop-zone"
          class="border-2 border-dashed border-dark/20 rounded-xl p-8 text-center transition-colors cursor-pointer hover:border-dark/40"
        >
          <div class="flex flex-col items-center gap-3">
            <span id="upload-icon" set:html={uploadIcon} />
            <div>
              <p class="text-sm font-medium text-dark">Drop files here or click to browse</p>
              <p class="text-xs text-muted mt-1">PDF, DOCX, TXT, MD, CSV, HTML &mdash; up to 50 MB each</p>
            </div>
          </div>
          <input
            type="file"
            id="file-input"
            class="hidden"
            multiple
            accept=".pdf,.docx,.txt,.md,.csv,.html"
          />
        </div>

        <!-- Per-file upload settings (shown after files are selected) -->
        <div id="upload-settings" class="hidden mt-4">
          <div class="flex items-center justify-between mb-3">
            <p class="text-xs font-medium text-muted uppercase tracking-wide">Selected Files</p>
            <button id="clear-files-btn" class="text-xs text-muted hover:text-dark transition-colors cursor-pointer">Clear all</button>
          </div>
          <div id="upload-file-list" class="space-y-2"></div>
          <div class="mt-4 flex justify-end">
            <Button variant="primary" id="upload-btn" class="text-sm">
              Upload Files
            </Button>
          </div>
        </div>

        <!-- Upload progress (shown during upload) -->
        <div id="upload-progress" class="hidden mt-4 space-y-3"></div>
      </div>

      <!-- Document list -->
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5">
        <h2 class="text-sm font-semibold text-dark mb-4">Documents</h2>
        <div id="doc-list">
          <p id="doc-empty" class="text-sm text-muted italic">No documents uploaded yet.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete KB Confirmation Modal -->
  <Modal id="delete-modal" title="Delete Knowledge Base">
    <div class="flex flex-col gap-4">
      <p class="text-sm text-muted">
        Are you sure you want to delete <strong id="delete-kb-name" class="text-dark"></strong>?
        All documents and chunks will be permanently removed. This action cannot be undone.
      </p>
      <div id="delete-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="delete-modal">
          Cancel
        </Button>
        <Button variant="primary" id="delete-confirm-btn" class="bg-coral hover:bg-coral/90 text-paper">
          Delete Knowledge Base
        </Button>
      </div>
    </div>
  </Modal>

  <!-- Delete Document Confirmation Modal -->
  <Modal id="delete-doc-modal" title="Delete Document">
    <div class="flex flex-col gap-4">
      <p class="text-sm text-muted">
        Are you sure you want to delete <strong id="delete-doc-name" class="text-dark"></strong>?
        All chunks will be permanently removed.
      </p>
      <div id="delete-doc-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="delete-doc-modal">
          Cancel
        </Button>
        <Button variant="primary" id="delete-doc-confirm-btn" class="bg-coral hover:bg-coral/90 text-paper">
          Delete Document
        </Button>
      </div>
    </div>
  </Modal>

  <!-- Chunk preview modal -->
  <Modal id="chunk-preview-modal" title="Chunk Preview" class="max-w-2xl">
    <div id="chunk-preview-content" class="space-y-3 max-h-96 overflow-y-auto"></div>
  </Modal>
</PageLayout>

<script is:inline define:vars={{ kbId: id, typeIcons }}>
  (function () {
    /* ---------- DOM refs ---------- */
    var loadingState = document.getElementById("loading-state");
    var errorState = document.getElementById("error-state");
    var content = document.getElementById("kb-content");
    var nameEl = document.getElementById("kb-name");
    var descEl = document.getElementById("kb-description");
    var statDocs = document.getElementById("stat-docs");
    var statChunks = document.getElementById("stat-chunks");
    var statIndexSize = document.getElementById("stat-index-size");
    var embeddingModelEl = document.getElementById("kb-embedding-model");
    var chunkSizeEl = document.getElementById("kb-chunk-size");
    var chunkOverlapEl = document.getElementById("kb-chunk-overlap");

    var deleteBtn = document.getElementById("delete-btn");
    var deleteModal = document.getElementById("delete-modal");
    var deleteKbName = document.getElementById("delete-kb-name");
    var deleteError = document.getElementById("delete-error");
    var deleteConfirmBtn = document.getElementById("delete-confirm-btn");

    var dropZone = document.getElementById("drop-zone");
    var fileInput = document.getElementById("file-input");
    var uploadSettings = document.getElementById("upload-settings");
    var uploadFileList = document.getElementById("upload-file-list");
    var clearFilesBtn = document.getElementById("clear-files-btn");
    var uploadBtn = document.getElementById("upload-btn");
    var uploadProgress = document.getElementById("upload-progress");

    var docList = document.getElementById("doc-list");
    var docEmpty = document.getElementById("doc-empty");

    var deleteDocModal = document.getElementById("delete-doc-modal");
    var deleteDocName = document.getElementById("delete-doc-name");
    var deleteDocError = document.getElementById("delete-doc-error");
    var deleteDocConfirmBtn = document.getElementById("delete-doc-confirm-btn");

    var chunkPreviewModal = document.getElementById("chunk-preview-modal");
    var chunkPreviewContent = document.getElementById("chunk-preview-content");

    /* Retrieval settings DOM refs */
    var saveRetrievalBtn = document.getElementById("save-retrieval-btn");
    var retrievalSavedMsg = document.getElementById("retrieval-saved-msg");
    var retrievalErrorMsg = document.getElementById("retrieval-error-msg");
    var searchTypeBtns = document.querySelectorAll(".search-type-btn");
    var rerankerToggle = document.getElementById("reranker-toggle");
    var rerankerLabel = document.getElementById("reranker-label");
    var topkSlider = document.getElementById("topk-slider");
    var topkValue = document.getElementById("topk-value");
    var thresholdSlider = document.getElementById("threshold-slider");
    var thresholdValue = document.getElementById("threshold-value");

    /* Test retrieval DOM refs */
    var testQueryInput = document.getElementById("test-query-input");
    var testQueryBtn = document.getElementById("test-query-btn");
    var testResults = document.getElementById("test-results");
    var testResultsCount = document.getElementById("test-results-count");
    var testResultsList = document.getElementById("test-results-list");
    var testNoResults = document.getElementById("test-no-results");
    var testError = document.getElementById("test-error");
    var testErrorMsg = document.getElementById("test-error-msg");

    var currentKb = null;
    var selectedFiles = [];
    var fileSettings = {}; /* keyed by file name+size for uniqueness */
    var pendingDeleteDocId = null;
    var retrievalDirty = false;

    /* ---------- Helpers ---------- */
    function formatSize(chunks) {
      var bytes = chunks * 3072;
      if (bytes === 0) return "0 B";
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
      return (bytes / 1048576).toFixed(1) + " MB";
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
      return (bytes / 1048576).toFixed(1) + " MB";
    }

    function formatDate(dateStr) {
      try {
        var d = new Date(dateStr + "Z");
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
      } catch (e) {
        return dateStr;
      }
    }

    function fileKey(f) {
      return f.name + ":" + f.size;
    }

    function getTypeIcon(ext) {
      return typeIcons[ext] || typeIcons["txt"];
    }

    function statusBadge(status) {
      var colors = {
        completed: "bg-zen-green/15 text-zen-green",
        pending: "bg-zen-blue/15 text-zen-blue",
        failed: "bg-coral/15 text-coral",
      };
      var cls = colors[status] || colors["pending"];
      return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium ' + cls + '">' + status + '</span>';
    }

    /* ---------- Show KB ---------- */
    function showKb(kb) {
      currentKb = kb;
      loadingState.classList.add("hidden");
      content.classList.remove("hidden");

      nameEl.textContent = kb.name;
      descEl.textContent = kb.description || "No description";
      if (!kb.description) descEl.classList.add("italic", "text-muted/50");

      statDocs.textContent = kb.doc_count;
      statChunks.textContent = kb.chunk_count;
      statIndexSize.textContent = formatSize(kb.chunk_count);

      embeddingModelEl.textContent = kb.embedding_model;
      chunkSizeEl.textContent = kb.chunk_size + " tokens";
      chunkOverlapEl.textContent = kb.chunk_overlap + " tokens";

      /* Populate retrieval settings */
      setSearchType(kb.search_type || "keyword");
      setReranker(!!kb.reranker_enabled);
      topkSlider.value = kb.top_k || 5;
      topkValue.textContent = topkSlider.value;
      thresholdSlider.value = Math.round((kb.similarity_threshold || 0) * 100);
      thresholdValue.textContent = (parseFloat(thresholdSlider.value) / 100).toFixed(2);
      retrievalDirty = false;
      saveRetrievalBtn.classList.add("hidden");

      /* Update breadcrumb */
      var allSpans = document.querySelectorAll("nav span");
      allSpans.forEach(function (span) {
        if (span.textContent.trim() === "Loading...") {
          span.textContent = kb.name;
        }
      });

      fetchDocuments();
    }

    function showError() {
      loadingState.classList.add("hidden");
      errorState.classList.remove("hidden");
    }

    function fetchKb() {
      fetch("/api/knowledge-bases/" + kbId)
        .then(function (res) {
          if (!res.ok) throw new Error("Not found");
          return res.json();
        })
        .then(showKb)
        .catch(showError);
    }

    /* ---------- Documents list ---------- */
    function fetchDocuments() {
      fetch("/api/knowledge-bases/" + kbId + "/documents")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed");
          return res.json();
        })
        .then(renderDocuments)
        .catch(function () {
          /* silent */
        });
    }

    function renderDocuments(docs) {
      if (docs.length === 0) {
        docEmpty.classList.remove("hidden");
        /* Remove any existing doc rows */
        var rows = docList.querySelectorAll(".doc-row");
        rows.forEach(function (r) { r.remove(); });
        return;
      }

      docEmpty.classList.add("hidden");
      /* Remove old rows */
      var oldRows = docList.querySelectorAll(".doc-row");
      oldRows.forEach(function (r) { r.remove(); });

      docs.forEach(function (doc) {
        var row = document.createElement("div");
        row.className = "doc-row flex items-center gap-3 py-3 border-b border-dark/[0.06] last:border-0";
        row.innerHTML =
          '<span class="doc-type-icon">' + getTypeIcon(doc.file_type) + '</span>' +
          '<div class="flex-1 min-w-0">' +
            '<div class="flex items-center gap-2">' +
              '<p class="text-sm font-medium text-dark truncate">' + escapeHtml(doc.filename) + '</p>' +
              statusBadge(doc.status) +
            '</div>' +
            '<p class="text-xs text-muted mt-0.5">' +
              doc.chunk_count + ' chunks &middot; ' + formatFileSize(doc.file_size) + ' &middot; ' + formatDate(doc.created_at) +
            '</p>' +
          '</div>' +
          '<div class="flex items-center gap-1 shrink-0">' +
            '<button class="chunk-preview-btn flex items-center gap-1 px-2 py-1 text-xs text-muted hover:text-dark hover:bg-dark/5 rounded-md transition-colors cursor-pointer" data-doc-id="' + doc.id + '">' +
              'Chunks' +
            '</button>' +
            '<button class="doc-delete-btn flex items-center justify-center h-7 w-7 rounded-md text-muted hover:text-coral hover:bg-coral/5 transition-colors cursor-pointer" data-doc-id="' + doc.id + '" data-doc-name="' + escapeAttr(doc.filename) + '">' +
              '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>' +
            '</button>' +
          '</div>';
        docList.appendChild(row);
      });

      /* Bind chunk preview buttons */
      docList.querySelectorAll(".chunk-preview-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          var docId = btn.getAttribute("data-doc-id");
          showChunkPreview(docId);
        });
      });

      /* Bind delete buttons */
      docList.querySelectorAll(".doc-delete-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          pendingDeleteDocId = btn.getAttribute("data-doc-id");
          deleteDocName.textContent = btn.getAttribute("data-doc-name");
          deleteDocError.classList.add("hidden");
          deleteDocModal.showModal();
        });
      });
    }

    function escapeHtml(str) {
      var div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    function escapeAttr(str) {
      return str.replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/'/g, "&#39;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    /* ---------- Chunk Preview ---------- */
    function showChunkPreview(docId) {
      chunkPreviewContent.innerHTML = '<p class="text-xs text-muted">Loading chunks...</p>';
      chunkPreviewModal.showModal();

      fetch("/api/knowledge-bases/" + kbId + "/documents/" + docId + "/chunks?limit=3")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load chunks");
          return res.json();
        })
        .then(function (chunks) {
          if (chunks.length === 0) {
            chunkPreviewContent.innerHTML = '<p class="text-xs text-muted italic">No chunks found.</p>';
            return;
          }
          var html = "";
          chunks.forEach(function (chunk) {
            html +=
              '<div class="rounded-lg bg-subtle/80 border border-dark/[0.06] p-3">' +
                '<div class="flex items-center justify-between mb-2">' +
                  '<span class="text-[10px] font-medium text-muted uppercase tracking-wide">Chunk ' + chunk.chunk_index + '</span>' +
                  '<span class="text-[10px] text-muted">' + chunk.char_count + ' chars</span>' +
                '</div>' +
                '<p class="text-xs text-dark leading-relaxed whitespace-pre-wrap break-words">' + escapeHtml(chunk.content) + '</p>' +
              '</div>';
          });
          chunkPreviewContent.innerHTML = html;
        })
        .catch(function (err) {
          chunkPreviewContent.innerHTML = '<p class="text-xs text-coral">' + escapeHtml(err.message) + '</p>';
        });
    }

    /* ---------- Delete KB ---------- */
    if (deleteBtn) {
      deleteBtn.addEventListener("click", function () {
        if (!currentKb) return;
        deleteKbName.textContent = currentKb.name;
        deleteError.classList.add("hidden");
        deleteModal.showModal();
      });
    }

    if (deleteConfirmBtn) {
      deleteConfirmBtn.addEventListener("click", function () {
        deleteError.classList.add("hidden");
        deleteConfirmBtn.disabled = true;
        deleteConfirmBtn.textContent = "Deleting...";

        fetch("/api/knowledge-bases/" + kbId, { method: "DELETE" })
          .then(function (res) {
            if (!res.ok && res.status !== 204)
              throw new Error("Failed to delete knowledge base");
            window.location.href = "/knowledge";
          })
          .catch(function (err) {
            deleteError.textContent = err.message;
            deleteError.classList.remove("hidden");
            deleteConfirmBtn.disabled = false;
            deleteConfirmBtn.textContent = "Delete Knowledge Base";
          });
      });
    }

    /* ---------- Delete Document ---------- */
    if (deleteDocConfirmBtn) {
      deleteDocConfirmBtn.addEventListener("click", function () {
        if (!pendingDeleteDocId) return;
        deleteDocError.classList.add("hidden");
        deleteDocConfirmBtn.disabled = true;
        deleteDocConfirmBtn.textContent = "Deleting...";

        fetch("/api/knowledge-bases/" + kbId + "/documents/" + pendingDeleteDocId, { method: "DELETE" })
          .then(function (res) {
            if (!res.ok && res.status !== 204)
              throw new Error("Failed to delete document");
            deleteDocModal.close();
            /* Refresh KB + doc list */
            fetchKb();
          })
          .catch(function (err) {
            deleteDocError.textContent = err.message;
            deleteDocError.classList.remove("hidden");
          })
          .finally(function () {
            deleteDocConfirmBtn.disabled = false;
            deleteDocConfirmBtn.textContent = "Delete Document";
            pendingDeleteDocId = null;
          });
      });
    }

    /* ---------- Drag-and-drop ---------- */
    dropZone.addEventListener("click", function () {
      fileInput.click();
    });

    dropZone.addEventListener("dragover", function (e) {
      e.preventDefault();
      dropZone.classList.add("border-dark/60", "bg-dark/5");
    });

    dropZone.addEventListener("dragleave", function (e) {
      e.preventDefault();
      dropZone.classList.remove("border-dark/60", "bg-dark/5");
    });

    dropZone.addEventListener("drop", function (e) {
      e.preventDefault();
      dropZone.classList.remove("border-dark/60", "bg-dark/5");
      var files = Array.from(e.dataTransfer.files);
      addFiles(files);
    });

    fileInput.addEventListener("change", function () {
      var files = Array.from(fileInput.files);
      addFiles(files);
      fileInput.value = "";
    });

    /* ---------- File selection ---------- */
    function addFiles(files) {
      var supportedExts = ["pdf", "docx", "txt", "md", "csv", "html"];
      files.forEach(function (f) {
        var ext = f.name.split(".").pop().toLowerCase();
        if (supportedExts.indexOf(ext) === -1) return;
        /* Avoid duplicates */
        var key = fileKey(f);
        var exists = selectedFiles.some(function (sf) { return fileKey(sf) === key; });
        if (!exists) {
          selectedFiles.push(f);
          fileSettings[key] = { chunkSize: "", tags: "" }; /* empty = use KB default */
        }
      });
      renderSelectedFiles();
    }

    function renderSelectedFiles() {
      if (selectedFiles.length === 0) {
        uploadSettings.classList.add("hidden");
        return;
      }
      uploadSettings.classList.remove("hidden");
      uploadFileList.innerHTML = "";

      selectedFiles.forEach(function (f, idx) {
        var key = fileKey(f);
        var settings = fileSettings[key];
        var ext = f.name.split(".").pop().toLowerCase();
        var row = document.createElement("div");
        row.className = "rounded-lg bg-paper border border-dark/[0.06] p-3";
        row.innerHTML =
          '<div class="flex items-center gap-3">' +
            '<span>' + getTypeIcon(ext) + '</span>' +
            '<div class="flex-1 min-w-0">' +
              '<p class="text-sm font-medium text-dark truncate">' + escapeHtml(f.name) + '</p>' +
              '<p class="text-xs text-muted">' + formatFileSize(f.size) + '</p>' +
            '</div>' +
            '<button class="file-settings-toggle flex items-center gap-1 px-2 py-1 text-xs text-muted hover:text-dark hover:bg-dark/5 rounded-md transition-colors cursor-pointer" data-idx="' + idx + '">' +
              'Settings <span class="toggle-chevron">' + '<svg class="h-3 w-3 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>' + '</span>' +
            '</button>' +
            '<button class="remove-file-btn flex items-center justify-center h-7 w-7 rounded-md text-muted hover:text-coral hover:bg-coral/5 transition-colors cursor-pointer" data-idx="' + idx + '">' +
              '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
            '</button>' +
          '</div>' +
          '<div class="file-settings-panel hidden mt-3 pt-3 border-t border-dark/[0.06]" data-idx="' + idx + '">' +
            '<div class="grid grid-cols-2 gap-3">' +
              '<div>' +
                '<label class="text-[10px] font-medium text-muted uppercase tracking-wide">Custom Chunk Size</label>' +
                '<input type="number" class="chunk-size-input mt-1 w-full rounded-md border border-dark/[0.12] bg-paper px-2.5 py-1.5 text-xs text-dark placeholder:text-muted/50 focus:outline-none focus:border-dark/30" placeholder="Use KB default" min="64" max="8192" value="' + (settings.chunkSize || "") + '" data-key="' + escapeAttr(key) + '">' +
              '</div>' +
              '<div>' +
                '<label class="text-[10px] font-medium text-muted uppercase tracking-wide">Metadata Tags</label>' +
                '<input type="text" class="tags-input mt-1 w-full rounded-md border border-dark/[0.12] bg-paper px-2.5 py-1.5 text-xs text-dark placeholder:text-muted/50 focus:outline-none focus:border-dark/30" placeholder="tag1, tag2, ..." value="' + escapeAttr(settings.tags || "") + '" data-key="' + escapeAttr(key) + '">' +
              '</div>' +
            '</div>' +
          '</div>';
        uploadFileList.appendChild(row);
      });

      /* Bind settings toggles */
      uploadFileList.querySelectorAll(".file-settings-toggle").forEach(function (btn) {
        btn.addEventListener("click", function () {
          var idx = btn.getAttribute("data-idx");
          var panel = uploadFileList.querySelector('.file-settings-panel[data-idx="' + idx + '"]');
          var chevron = btn.querySelector(".toggle-chevron svg");
          if (panel.classList.contains("hidden")) {
            panel.classList.remove("hidden");
            if (chevron) chevron.style.transform = "rotate(180deg)";
          } else {
            panel.classList.add("hidden");
            if (chevron) chevron.style.transform = "";
          }
        });
      });

      /* Bind remove buttons */
      uploadFileList.querySelectorAll(".remove-file-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          var idx = parseInt(btn.getAttribute("data-idx"), 10);
          var key = fileKey(selectedFiles[idx]);
          delete fileSettings[key];
          selectedFiles.splice(idx, 1);
          renderSelectedFiles();
        });
      });

      /* Bind settings inputs */
      uploadFileList.querySelectorAll(".chunk-size-input").forEach(function (inp) {
        inp.addEventListener("change", function () {
          var key = inp.getAttribute("data-key");
          if (fileSettings[key]) fileSettings[key].chunkSize = inp.value;
        });
      });

      uploadFileList.querySelectorAll(".tags-input").forEach(function (inp) {
        inp.addEventListener("change", function () {
          var key = inp.getAttribute("data-key");
          if (fileSettings[key]) fileSettings[key].tags = inp.value;
        });
      });
    }

    clearFilesBtn.addEventListener("click", function () {
      selectedFiles = [];
      fileSettings = {};
      renderSelectedFiles();
    });

    /* ---------- Upload ---------- */
    uploadBtn.addEventListener("click", function () {
      if (selectedFiles.length === 0) return;

      uploadBtn.disabled = true;
      uploadBtn.textContent = "Uploading...";
      uploadSettings.classList.add("hidden");
      uploadProgress.classList.remove("hidden");
      uploadProgress.innerHTML = "";

      /* Create progress items for each file */
      var items = selectedFiles.map(function (f, idx) {
        var key = fileKey(f);
        var settings = fileSettings[key] || {};
        var el = document.createElement("div");
        el.className = "rounded-lg bg-paper border border-dark/[0.06] p-3";
        el.innerHTML =
          '<div class="flex items-center gap-3 mb-2">' +
            '<span>' + getTypeIcon(f.name.split(".").pop().toLowerCase()) + '</span>' +
            '<p class="text-sm font-medium text-dark truncate flex-1">' + escapeHtml(f.name) + '</p>' +
            '<span class="upload-status text-xs text-muted">Uploading...</span>' +
          '</div>' +
          '<div class="w-full bg-dark/10 rounded-full h-1.5">' +
            '<div class="upload-bar bg-zen-blue h-1.5 rounded-full transition-all duration-300" style="width: 10%"></div>' +
          '</div>' +
          '<div class="chunk-preview-area hidden mt-2"></div>';
        uploadProgress.appendChild(el);
        return { file: f, settings: settings, el: el };
      });

      /* Upload files sequentially */
      var chain = Promise.resolve();
      items.forEach(function (item) {
        chain = chain.then(function () {
          return uploadFile(item);
        });
      });

      chain.then(function () {
        /* All done - refresh */
        selectedFiles = [];
        fileSettings = {};
        uploadProgress.classList.add("hidden");
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Upload Files";
        fetchKb();
      });
    });

    function uploadFile(item) {
      var bar = item.el.querySelector(".upload-bar");
      var status = item.el.querySelector(".upload-status");
      var previewArea = item.el.querySelector(".chunk-preview-area");

      bar.style.width = "30%";
      status.textContent = "Uploading...";

      var formData = new FormData();
      formData.append("file", item.file);

      return fetch("/api/knowledge-bases/" + kbId + "/documents", {
        method: "POST",
        body: formData,
      })
        .then(function (res) {
          bar.style.width = "60%";
          status.textContent = "Processing...";
          if (!res.ok) {
            return res.json().then(function (body) {
              throw new Error(body.detail || "Upload failed");
            });
          }
          return res.json();
        })
        .then(function (doc) {
          bar.style.width = "80%";
          status.textContent = "Chunking...";

          /* Fetch first 2-3 chunks for preview */
          return fetch("/api/knowledge-bases/" + kbId + "/documents/" + doc.id + "/chunks?limit=3")
            .then(function (res) { return res.ok ? res.json() : []; })
            .then(function (chunks) {
              bar.style.width = "100%";
              bar.classList.remove("bg-zen-blue");
              bar.classList.add("bg-zen-green");
              status.textContent = "Complete";
              status.classList.remove("text-muted");
              status.classList.add("text-zen-green");

              /* Show chunk preview */
              if (chunks.length > 0) {
                previewArea.classList.remove("hidden");
                var html = '<p class="text-[10px] font-medium text-muted uppercase tracking-wide mb-1">First ' + chunks.length + ' chunks:</p>';
                chunks.forEach(function (c) {
                  var text = c.content.length > 150 ? c.content.substring(0, 150) + "..." : c.content;
                  html += '<div class="rounded bg-subtle/80 border border-dark/[0.04] px-2 py-1.5 mb-1 text-[11px] text-dark leading-relaxed">' + escapeHtml(text) + '</div>';
                });
                previewArea.innerHTML = html;
              }
            });
        })
        .catch(function (err) {
          bar.style.width = "100%";
          bar.classList.remove("bg-zen-blue");
          bar.classList.add("bg-coral");
          status.textContent = "Failed: " + err.message;
          status.classList.remove("text-muted");
          status.classList.add("text-coral");
        });
    }

    /* ---------- Retrieval Settings ---------- */
    function setSearchType(type) {
      searchTypeBtns.forEach(function (btn) {
        if (btn.getAttribute("data-value") === type) {
          btn.classList.add("bg-zen-blue", "text-paper", "border-zen-blue");
          btn.classList.remove("text-muted", "border-dark/[0.12]", "hover:bg-dark/5");
        } else {
          btn.classList.remove("bg-zen-blue", "text-paper", "border-zen-blue");
          btn.classList.add("text-muted", "border-dark/[0.12]", "hover:bg-dark/5");
        }
      });
    }

    function getSearchType() {
      var active = document.querySelector(".search-type-btn.bg-zen-blue");
      return active ? active.getAttribute("data-value") : "keyword";
    }

    function setReranker(enabled) {
      if (enabled) {
        rerankerToggle.classList.remove("bg-dark/15");
        rerankerToggle.classList.add("bg-zen-blue");
        rerankerToggle.setAttribute("aria-checked", "true");
        rerankerToggle.querySelector(".reranker-dot").classList.remove("translate-x-0.5");
        rerankerToggle.querySelector(".reranker-dot").classList.add("translate-x-[18px]");
        rerankerLabel.textContent = "Enabled";
      } else {
        rerankerToggle.classList.add("bg-dark/15");
        rerankerToggle.classList.remove("bg-zen-blue");
        rerankerToggle.setAttribute("aria-checked", "false");
        rerankerToggle.querySelector(".reranker-dot").classList.add("translate-x-0.5");
        rerankerToggle.querySelector(".reranker-dot").classList.remove("translate-x-[18px]");
        rerankerLabel.textContent = "Disabled";
      }
    }

    function markRetrievalDirty() {
      retrievalDirty = true;
      saveRetrievalBtn.classList.remove("hidden");
      retrievalSavedMsg.classList.add("hidden");
      retrievalErrorMsg.classList.add("hidden");
    }

    searchTypeBtns.forEach(function (btn) {
      btn.addEventListener("click", function () {
        setSearchType(btn.getAttribute("data-value"));
        markRetrievalDirty();
      });
    });

    rerankerToggle.addEventListener("click", function () {
      var isEnabled = rerankerToggle.getAttribute("aria-checked") === "true";
      setReranker(!isEnabled);
      markRetrievalDirty();
    });

    topkSlider.addEventListener("input", function () {
      topkValue.textContent = topkSlider.value;
      markRetrievalDirty();
    });

    thresholdSlider.addEventListener("input", function () {
      thresholdValue.textContent = (parseFloat(thresholdSlider.value) / 100).toFixed(2);
      markRetrievalDirty();
    });

    saveRetrievalBtn.addEventListener("click", function () {
      saveRetrievalBtn.disabled = true;
      saveRetrievalBtn.textContent = "Saving...";
      retrievalSavedMsg.classList.add("hidden");
      retrievalErrorMsg.classList.add("hidden");

      var payload = {
        search_type: getSearchType(),
        top_k: parseInt(topkSlider.value, 10),
        similarity_threshold: parseFloat(thresholdSlider.value) / 100,
        reranker_enabled: rerankerToggle.getAttribute("aria-checked") === "true",
      };

      fetch("/api/knowledge-bases/" + kbId, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (b) { throw new Error(b.detail || "Save failed"); });
          return res.json();
        })
        .then(function (kb) {
          currentKb = kb;
          retrievalDirty = false;
          saveRetrievalBtn.classList.add("hidden");
          retrievalSavedMsg.classList.remove("hidden");
          setTimeout(function () { retrievalSavedMsg.classList.add("hidden"); }, 3000);
        })
        .catch(function (err) {
          retrievalErrorMsg.textContent = err.message;
          retrievalErrorMsg.classList.remove("hidden");
        })
        .finally(function () {
          saveRetrievalBtn.disabled = false;
          saveRetrievalBtn.textContent = "Save Changes";
        });
    });

    /* ---------- Test Retrieval ---------- */
    function runTestQuery() {
      var query = testQueryInput.value.trim();
      if (!query) return;

      testQueryBtn.disabled = true;
      testQueryBtn.textContent = "Searching...";
      testResults.classList.add("hidden");
      testNoResults.classList.add("hidden");
      testError.classList.add("hidden");

      fetch("/api/knowledge-bases/" + kbId + "/search", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: query }),
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (b) { throw new Error(b.detail || "Search failed"); });
          return res.json();
        })
        .then(function (results) {
          if (results.length === 0) {
            testNoResults.classList.remove("hidden");
            return;
          }

          testResults.classList.remove("hidden");
          testResultsCount.textContent = results.length + " result" + (results.length === 1 ? "" : "s");
          testResultsList.innerHTML = "";

          results.forEach(function (r) {
            var el = document.createElement("div");
            el.className = "test-result-item rounded-lg bg-paper border border-dark/[0.06] p-3 cursor-pointer transition-colors hover:border-dark/15";
            el.innerHTML =
              '<div class="flex items-center justify-between mb-2">' +
                '<div class="flex items-center gap-2">' +
                  '<span class="text-xs font-medium text-dark">' + escapeHtml(r.filename) + '</span>' +
                  '<span class="text-[10px] text-muted">Chunk ' + r.chunk_index + '</span>' +
                '</div>' +
                '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-zen-blue/15 text-zen-blue">' + (r.score * 100).toFixed(0) + '%</span>' +
              '</div>' +
              '<p class="test-result-preview text-xs text-dark/80 leading-relaxed">' + escapeHtml(r.content.length > 200 ? r.content.substring(0, 200) + "..." : r.content) + '</p>' +
              '<div class="test-result-full hidden mt-2 pt-2 border-t border-dark/[0.06]">' +
                '<div class="flex items-center gap-1 mb-1.5">' +
                  '<span class="text-[10px] font-medium text-muted uppercase tracking-wide">Full text</span>' +
                  '<span class="text-[10px] text-zen-blue font-medium">' + escapeHtml(r.filename) + '</span>' +
                '</div>' +
                '<p class="text-xs text-dark leading-relaxed whitespace-pre-wrap break-words">' + escapeHtml(r.content) + '</p>' +
              '</div>';
            testResultsList.appendChild(el);

            /* Click to expand/collapse full text */
            el.addEventListener("click", function () {
              var full = el.querySelector(".test-result-full");
              var preview = el.querySelector(".test-result-preview");
              if (full.classList.contains("hidden")) {
                full.classList.remove("hidden");
                preview.classList.add("hidden");
              } else {
                full.classList.add("hidden");
                preview.classList.remove("hidden");
              }
            });
          });
        })
        .catch(function (err) {
          testErrorMsg.textContent = err.message;
          testError.classList.remove("hidden");
        })
        .finally(function () {
          testQueryBtn.disabled = false;
          testQueryBtn.textContent = "Search";
        });
    }

    testQueryBtn.addEventListener("click", runTestQuery);
    testQueryInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") runTestQuery();
    });

    /* ---------- Init ---------- */
    fetchKb();
  })();
</script>
