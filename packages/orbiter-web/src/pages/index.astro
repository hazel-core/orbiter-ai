---
import PageLayout from "../layouts/PageLayout.astro";

const breadcrumbs = [{ label: "Dashboard" }];

/* Icons for quick-action cards */
const botIcon = '<svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>';
const workflowIcon = '<svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>';
const playIcon = '<svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
const wrenchIcon = '<svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>';
const clockIcon = '<svg class="h-3.5 w-3.5 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';

const quickActions = [
  { label: "Agents", description: "Create and manage AI agents", href: "/agents", icon: botIcon, color: "coral" },
  { label: "Workflows", description: "Build multi-step workflows", href: "/workflows", icon: workflowIcon, color: "zen-blue" },
  { label: "Playground", description: "Test agents interactively", href: "/playground", icon: playIcon, color: "zen-green" },
  { label: "Tools", description: "Browse and configure tools", href: "/tools", icon: wrenchIcon, color: "[#a855f7]" },
];
---

<PageLayout
  title="Dashboard"
  description="Orbiter overview"
  activeSection="dashboard"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Welcome header -->
    <div class="mb-8">
      <h1 class="text-2xl font-semibold text-dark">Welcome to Orbiter</h1>
      <p class="text-sm text-muted mt-1">Your AI agent platform at a glance</p>
    </div>

    <!-- Stats row -->
    <div id="stats-row" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
      <div class="rounded-xl border border-dark/[0.08] bg-paper p-4">
        <p class="text-xs text-muted mb-1">Agents</p>
        <p class="text-2xl font-semibold text-dark" id="stat-agents">-</p>
      </div>
      <div class="rounded-xl border border-dark/[0.08] bg-paper p-4">
        <p class="text-xs text-muted mb-1">Workflows</p>
        <p class="text-2xl font-semibold text-dark" id="stat-workflows">-</p>
      </div>
      <div class="rounded-xl border border-dark/[0.08] bg-paper p-4">
        <p class="text-xs text-muted mb-1">Tools</p>
        <p class="text-2xl font-semibold text-dark" id="stat-tools">-</p>
      </div>
      <div class="rounded-xl border border-dark/[0.08] bg-paper p-4">
        <p class="text-xs text-muted mb-1">Recent Runs</p>
        <p class="text-2xl font-semibold text-dark" id="stat-runs">-</p>
      </div>
    </div>

    <!-- Quick actions -->
    <div class="mb-8">
      <h2 class="text-sm font-semibold text-dark mb-4">Quick Actions</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        {quickActions.map((action) => (
          <a
            href={action.href}
            class="group block rounded-xl border border-dark/[0.08] bg-paper p-5 hover:border-dark/20 hover:shadow-lg transition-all duration-300 hover:-translate-y-0.5 no-underline"
          >
            <div class={`text-${action.color} mb-3`} set:html={action.icon} />
            <h3 class="text-sm font-semibold text-dark group-hover:text-coral transition-colors">{action.label}</h3>
            <p class="text-xs text-muted mt-1">{action.description}</p>
          </a>
        ))}
      </div>
    </div>

    <!-- Recent activity -->
    <div>
      <h2 class="text-sm font-semibold text-dark mb-4">Recent Activity</h2>
      <div id="recent-runs" class="space-y-2">
      </div>
      <div id="recent-empty" class="hidden rounded-xl border border-dark/[0.08] bg-paper p-8 text-center">
        <p class="text-sm text-muted">No recent activity yet. Run an agent or workflow to see activity here.</p>
      </div>
      <div id="recent-loading" class="rounded-xl border border-dark/[0.08] bg-paper p-8 text-center">
        <p class="text-sm text-muted">Loading recent activity...</p>
      </div>
    </div>
  </div>
</PageLayout>

<script is:inline>
  (function () {
    var statAgents = document.getElementById("stat-agents");
    var statWorkflows = document.getElementById("stat-workflows");
    var statTools = document.getElementById("stat-tools");
    var statRuns = document.getElementById("stat-runs");
    var recentRuns = document.getElementById("recent-runs");
    var recentEmpty = document.getElementById("recent-empty");
    var recentLoading = document.getElementById("recent-loading");

    var clockSvg = '<svg class="h-3.5 w-3.5 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';

    function formatDate(dateStr) {
      try {
        var d = new Date(dateStr + "Z");
        var now = new Date();
        var diff = now - d;
        if (diff < 60000) return "Just now";
        if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
        if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
      } catch (_e) { return dateStr; }
    }

    function getStatusStyle(status) {
      if (status === "completed" || status === "success") return "bg-zen-green/10 text-zen-green";
      if (status === "running" || status === "in_progress") return "bg-zen-blue/10 text-zen-blue";
      if (status === "failed" || status === "error") return "bg-coral/10 text-coral";
      return "bg-muted/10 text-muted";
    }

    function fetchCount(url, el) {
      fetch(url)
        .then(function (res) { return res.ok ? res.json() : Promise.reject(); })
        .then(function (body) {
          var data = body.data || body;
          el.textContent = Array.isArray(data) ? data.length : (body.total || body.count || 0);
        })
        .catch(function () { el.textContent = "0"; });
    }

    fetchCount("/api/v1/agents", statAgents);
    fetchCount("/api/v1/workflows", statWorkflows);
    fetchCount("/api/v1/tools", statTools);

    // Fetch recent runs
    fetch("/api/v1/runs?limit=5")
      .then(function (res) { return res.ok ? res.json() : Promise.reject(); })
      .then(function (body) {
        var runs = body.data || body;
        if (recentLoading) recentLoading.classList.add("hidden");

        if (!Array.isArray(runs) || runs.length === 0) {
          recentEmpty.classList.remove("hidden");
          statRuns.textContent = "0";
          return;
        }

        statRuns.textContent = runs.length;
        runs.forEach(function (run) {
          var div = document.createElement("div");
          div.className = "flex items-center gap-4 rounded-xl border border-dark/[0.08] bg-paper px-5 py-3.5 transition-all duration-200 hover:border-dark/20";

          var statusCls = getStatusStyle(run.status);
          div.innerHTML =
            '<div class="flex-1 min-w-0">' +
              '<div class="flex items-center gap-2">' +
                '<span class="text-sm font-medium text-dark truncate">' + (run.agent_name || run.workflow_name || "Run " + run.id) + '</span>' +
                '<span class="text-xs px-2 py-0.5 rounded-full font-medium ' + statusCls + '">' + (run.status || "unknown") + '</span>' +
              '</div>' +
              '<p class="text-xs text-muted mt-0.5">' + (run.type || "agent") + ' run</p>' +
            '</div>' +
            '<span class="text-xs text-muted shrink-0">' + (run.created_at ? clockSvg + " " + formatDate(run.created_at) : "") + '</span>';

          recentRuns.appendChild(div);
        });
      })
      .catch(function () {
        if (recentLoading) recentLoading.classList.add("hidden");
        recentEmpty.classList.remove("hidden");
        statRuns.textContent = "0";
      });
  })();
</script>
