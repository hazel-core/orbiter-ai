---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";

const breadcrumbs = [
  { label: "Tools", href: "/tools" },
  { label: "Create Tool" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const playIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
const saveIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>';
const copyIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
---

<PageLayout
  title="Create Tool"
  description="Create a custom tool with Python code"
  activeSection="tools"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Back link -->
    <a href="/tools" class="inline-flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors mb-6">
      <span set:html={backIcon} />
      Back to Tools
    </a>

    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Create Custom Tool</h1>
        <p class="text-sm text-muted mt-1">Write a Python function and it will be auto-converted to a tool with JSON schema</p>
      </div>
    </div>

    <!-- Tool name + project row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div>
        <label for="tool-name" class="block text-sm font-medium text-dark mb-1.5">Tool Name</label>
        <input
          type="text"
          id="tool-name"
          placeholder="e.g. web_search"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
        />
      </div>
      <div>
        <label for="tool-project" class="block text-sm font-medium text-dark mb-1.5">Project</label>
        <select
          id="tool-project"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer transition-all"
        >
          <option value="">Loading projects...</option>
        </select>
      </div>
    </div>

    <!-- Description -->
    <div class="mb-6">
      <label for="tool-description" class="block text-sm font-medium text-dark mb-1.5">Description <span class="text-muted font-normal">(optional)</span></label>
      <input
        type="text"
        id="tool-description"
        placeholder="Brief description of what this tool does"
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
      />
    </div>

    <!-- Main content: editor + side panels -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left: Code editor -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-dark">Python Code</h2>
          <button id="analyze-btn" class="text-xs text-zen-blue hover:text-zen-blue/80 font-medium cursor-pointer transition-colors">
            Analyze Schema
          </button>
        </div>
        <div class="rounded-xl bg-[#1e1e1e] border border-dark/[0.08] overflow-hidden">
          <!-- Line numbers + editor -->
          <div class="flex">
            <div id="line-numbers" class="select-none text-right pr-3 pl-3 py-4 text-xs font-mono text-[#606060] leading-[1.65] bg-[#1a1a1a] border-r border-[#333] min-w-[3rem]">1</div>
            <textarea
              id="code-editor"
              spellcheck="false"
              class="flex-1 bg-[#1e1e1e] text-[#d4d4d4] font-mono text-sm leading-[1.65] p-4 resize-none outline-none border-none min-h-[400px] w-full"
            ></textarea>
          </div>
        </div>

        <!-- Test section -->
        <div class="mt-6">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-semibold text-dark">Test Tool</h2>
            <button id="test-btn" class="inline-flex items-center gap-1.5 text-xs font-medium text-zen-green hover:text-zen-green/80 cursor-pointer transition-colors">
              <span set:html={playIcon} />
              Run Test
            </button>
          </div>

          <!-- Test inputs (populated after schema analysis) -->
          <div id="test-inputs" class="space-y-3 mb-4">
            <p class="text-xs text-muted italic">Analyze the code first to see test inputs.</p>
          </div>

          <!-- Test result -->
          <div id="test-result" class="hidden rounded-xl border border-dark/[0.08] overflow-hidden">
            <div class="flex items-center justify-between px-4 py-2 bg-subtle/80 border-b border-dark/[0.08]">
              <span class="text-xs font-medium text-dark">Result</span>
              <span id="test-status" class="text-xs font-medium"></span>
            </div>
            <pre id="test-output" class="p-4 text-sm font-mono text-dark bg-paper overflow-x-auto leading-relaxed whitespace-pre-wrap"></pre>
          </div>
        </div>
      </div>

      <!-- Right: Parameters + Schema -->
      <div>
        <!-- Parameters table -->
        <div class="mb-6">
          <h2 class="text-sm font-semibold text-dark mb-3">Parameters</h2>
          <div id="params-table" class="space-y-2">
            <p class="text-xs text-muted italic py-4">Parameters will appear after code analysis.</p>
          </div>
        </div>

        <!-- JSON Schema preview -->
        <div>
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-semibold text-dark">JSON Schema</h2>
            <button id="copy-schema-btn" class="flex items-center gap-1.5 text-xs text-muted hover:text-dark transition-colors cursor-pointer">
              <span set:html={copyIcon} />
              <span id="copy-label">Copy</span>
            </button>
          </div>
          <div class="rounded-xl bg-[#1e1e1e] border border-dark/[0.08] overflow-hidden">
            <pre id="schema-viewer" class="p-4 text-sm font-mono text-[#d4d4d4] overflow-x-auto leading-relaxed max-h-[400px] overflow-y-auto">{}</pre>
          </div>
        </div>

        <!-- Save button area -->
        <div class="mt-6 flex items-center gap-3">
          <Button variant="primary" id="save-btn">
            <span set:html={saveIcon} />
            Save Tool
          </Button>
          <span id="save-status" class="text-sm hidden"></span>
        </div>
      </div>
    </div>
  </div>
</PageLayout>

<script is:inline>
  (function () {
    /* ---------------------------------------------------------------
       Default template
    --------------------------------------------------------------- */
    var DEFAULT_CODE =
      'from orbiter.tool import tool\n' +
      '\n' +
      '\n' +
      '@tool\n' +
      'def my_tool(query: str, max_results: int = 10) -> str:\n' +
      '    """Search for information.\n' +
      '\n' +
      '    Args:\n' +
      '        query: The search query string\n' +
      '        max_results: Maximum number of results to return\n' +
      '\n' +
      '    Returns:\n' +
      '        Search results as formatted text\n' +
      '    """\n' +
      '    # Your tool logic here\n' +
      '    return f"Results for: {query} (max {max_results})"\n';

    /* ---------------------------------------------------------------
       DOM refs
    --------------------------------------------------------------- */
    var nameInput = document.getElementById("tool-name");
    var projectSelect = document.getElementById("tool-project");
    var descriptionInput = document.getElementById("tool-description");
    var codeEditor = document.getElementById("code-editor");
    var lineNumbers = document.getElementById("line-numbers");
    var analyzeBtn = document.getElementById("analyze-btn");
    var testBtn = document.getElementById("test-btn");
    var testInputs = document.getElementById("test-inputs");
    var testResult = document.getElementById("test-result");
    var testStatus = document.getElementById("test-status");
    var testOutput = document.getElementById("test-output");
    var paramsTable = document.getElementById("params-table");
    var schemaViewer = document.getElementById("schema-viewer");
    var copySchemaBtn = document.getElementById("copy-schema-btn");
    var copyLabel = document.getElementById("copy-label");
    var saveBtn = document.getElementById("save-btn");
    var saveStatus = document.getElementById("save-status");

    var currentSchema = null;
    var currentParams = [];
    var savedToolId = null;

    /* ---------------------------------------------------------------
       Initialize editor
    --------------------------------------------------------------- */
    codeEditor.value = DEFAULT_CODE;
    updateLineNumbers();

    /* ---------------------------------------------------------------
       Line numbers
    --------------------------------------------------------------- */
    function updateLineNumbers() {
      var lines = codeEditor.value.split("\n").length;
      var nums = [];
      for (var i = 1; i <= lines; i++) nums.push(i);
      lineNumbers.textContent = nums.join("\n");
    }

    codeEditor.addEventListener("input", updateLineNumbers);
    codeEditor.addEventListener("scroll", function () {
      lineNumbers.style.transform = "translateY(-" + codeEditor.scrollTop + "px)";
    });

    /* Tab key support */
    codeEditor.addEventListener("keydown", function (e) {
      if (e.key === "Tab") {
        e.preventDefault();
        var start = codeEditor.selectionStart;
        var end = codeEditor.selectionEnd;
        codeEditor.value = codeEditor.value.substring(0, start) + "    " + codeEditor.value.substring(end);
        codeEditor.selectionStart = codeEditor.selectionEnd = start + 4;
        updateLineNumbers();
      }
    });

    /* ---------------------------------------------------------------
       Load projects
    --------------------------------------------------------------- */
    fetch("/api/projects")
      .then(function (res) {
        if (!res.ok) throw new Error("Failed");
        return res.json();
      })
      .then(function (body) { return body.data || body; })
      .then(function (projects) {
        projectSelect.innerHTML = "";
        if (projects.length === 0) {
          projectSelect.innerHTML = '<option value="">No projects â€” create one first</option>';
          return;
        }
        projects.forEach(function (p) {
          var opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.name;
          projectSelect.appendChild(opt);
        });
      })
      .catch(function () {
        projectSelect.innerHTML = '<option value="">Failed to load projects</option>';
      });

    /* ---------------------------------------------------------------
       JSON highlighting
    --------------------------------------------------------------- */
    function highlightJSON(obj) {
      var str = JSON.stringify(obj, null, 2);
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"([^"]+)":/g, '<span style="color:#9cdcfe">"$1"</span>:')
        .replace(/: "(.*?)"/g, ': <span style="color:#ce9178">"$1"</span>')
        .replace(/: (\d+)/g, ': <span style="color:#b5cea8">$1</span>')
        .replace(/: (true|false)/g, ': <span style="color:#569cd6">$1</span>')
        .replace(/: (null)/g, ': <span style="color:#569cd6">$1</span>');
    }

    /* ---------------------------------------------------------------
       Analyze schema (preview)
    --------------------------------------------------------------- */
    function analyzeCode() {
      var code = codeEditor.value.trim();
      if (!code) return;

      analyzeBtn.textContent = "Analyzing...";

      fetch("/api/tools/schema", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: code }),
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Analysis failed"); });
          return res.json();
        })
        .then(function (data) {
          currentSchema = data.schema;
          currentParams = data.parameters || [];

          renderParams(currentParams);
          schemaViewer.innerHTML = highlightJSON(currentSchema);
          renderTestInputs(currentParams);

          analyzeBtn.textContent = "Analyze Schema";
        })
        .catch(function (err) {
          analyzeBtn.textContent = "Analyze Schema";
          showSaveStatus("Analysis error: " + err.message, "coral");
        });
    }

    analyzeBtn.addEventListener("click", analyzeCode);

    /* Auto-analyze on code change (debounced) */
    var analyzeTimeout;
    codeEditor.addEventListener("input", function () {
      clearTimeout(analyzeTimeout);
      analyzeTimeout = setTimeout(function () {
        if (codeEditor.value.trim().length > 20) analyzeCode();
      }, 1000);
    });

    /* ---------------------------------------------------------------
       Render parameters table
    --------------------------------------------------------------- */
    function renderParams(params) {
      if (!params || params.length === 0) {
        paramsTable.innerHTML = '<p class="text-xs text-muted italic py-4">No parameters detected.</p>';
        return;
      }

      paramsTable.innerHTML = "";
      params.forEach(function (p) {
        var div = document.createElement("div");
        div.className = "rounded-lg border border-dark/[0.08] p-3 bg-subtle/50";

        var required = p.default === null || p.default === undefined;
        var hasDefault = p.default !== null && p.default !== undefined;

        div.innerHTML =
          '<div class="flex items-center gap-2">' +
            '<code class="text-sm font-mono font-semibold text-dark">' + escapeHtml(p.name) + '</code>' +
            '<span class="text-xs px-1.5 py-0.5 rounded bg-muted/10 text-muted">' + escapeHtml(p.type || "any") + '</span>' +
            (required ? '<span class="text-xs px-1.5 py-0.5 rounded bg-coral/10 text-coral font-medium">required</span>' : '') +
          '</div>' +
          (p.description ? '<p class="text-xs text-muted mt-1">' + escapeHtml(p.description) + '</p>' : '') +
          (hasDefault ? '<p class="text-xs text-muted/60 mt-1">Default: <code class="font-mono">' + escapeHtml(String(p.default)) + '</code></p>' : '');

        paramsTable.appendChild(div);
      });
    }

    /* ---------------------------------------------------------------
       Render test inputs
    --------------------------------------------------------------- */
    function renderTestInputs(params) {
      if (!params || params.length === 0) {
        testInputs.innerHTML = '<p class="text-xs text-muted italic">No parameters to test.</p>';
        return;
      }

      testInputs.innerHTML = "";
      params.forEach(function (p) {
        var wrapper = document.createElement("div");
        var hasDefault = p.default !== null && p.default !== undefined;

        wrapper.innerHTML =
          '<label class="block text-xs font-medium text-dark mb-1">' +
            escapeHtml(p.name) +
            '<span class="text-muted font-normal ml-1">(' + escapeHtml(p.type || "any") + ')</span>' +
          '</label>' +
          '<input type="text" ' +
            'data-param="' + escapeHtml(p.name) + '" ' +
            'data-type="' + escapeHtml(p.type || "string") + '" ' +
            'placeholder="' + (hasDefault ? "Default: " + escapeHtml(String(p.default)) : "required") + '" ' +
            'class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all" ' +
          '/>';

        testInputs.appendChild(wrapper);
      });
    }

    /* ---------------------------------------------------------------
       Test tool
    --------------------------------------------------------------- */
    function testTool() {
      if (!savedToolId) {
        showSaveStatus("Save the tool first before testing.", "coral");
        return;
      }

      var inputs = {};
      var paramEls = testInputs.querySelectorAll("input[data-param]");
      paramEls.forEach(function (el) {
        var val = el.value.trim();
        if (!val) return;
        var typ = el.getAttribute("data-type");
        if (typ === "integer" || typ === "number") {
          inputs[el.getAttribute("data-param")] = Number(val);
        } else if (typ === "boolean") {
          inputs[el.getAttribute("data-param")] = val === "true";
        } else {
          inputs[el.getAttribute("data-param")] = val;
        }
      });

      testBtn.querySelector("svg").nextElementSibling && (testBtn.lastChild.textContent = " Running...");
      testResult.classList.remove("hidden");
      testOutput.textContent = "Running...";
      testStatus.textContent = "";
      testStatus.className = "text-xs font-medium";

      fetch("/api/tools/custom/" + savedToolId + "/test", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ inputs: inputs }),
      })
        .then(function (res) {
          return res.json();
        })
        .then(function (data) {
          testBtn.lastChild.textContent = " Run Test";
          if (data.success) {
            testStatus.textContent = "Success";
            testStatus.classList.add("text-zen-green");
            testOutput.textContent = typeof data.output === "string" ? data.output : JSON.stringify(data.output, null, 2);
          } else {
            testStatus.textContent = "Error";
            testStatus.classList.add("text-coral");
            testOutput.textContent = data.traceback || data.error || "Unknown error";
          }
        })
        .catch(function (err) {
          testBtn.lastChild.textContent = " Run Test";
          testStatus.textContent = "Error";
          testStatus.classList.add("text-coral");
          testOutput.textContent = err.message;
        });
    }

    testBtn.addEventListener("click", testTool);

    /* ---------------------------------------------------------------
       Save tool
    --------------------------------------------------------------- */
    function saveTool() {
      var name = nameInput.value.trim();
      var projectId = projectSelect.value;
      var code = codeEditor.value.trim();
      var description = descriptionInput.value.trim();

      if (!name) { showSaveStatus("Tool name is required.", "coral"); return; }
      if (!projectId) { showSaveStatus("Select a project.", "coral"); return; }
      if (!code) { showSaveStatus("Code is required.", "coral"); return; }

      saveBtn.querySelector("span:last-child") && (saveBtn.lastChild.textContent = " Saving...");

      if (savedToolId) {
        /* Update existing */
        fetch("/api/tools/custom/" + savedToolId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            code: code,
            name: name,
            description: description || undefined,
          }),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Update failed"); });
            return res.json();
          })
          .then(function (data) {
            saveBtn.lastChild.textContent = " Save Tool";
            currentSchema = data.schema;
            currentParams = data.parameters || [];
            renderParams(currentParams);
            schemaViewer.innerHTML = highlightJSON(currentSchema);
            renderTestInputs(currentParams);
            showSaveStatus("Tool updated!", "zen-green");
          })
          .catch(function (err) {
            saveBtn.lastChild.textContent = " Save Tool";
            showSaveStatus("Error: " + err.message, "coral");
          });
      } else {
        /* Create new */
        fetch("/api/tools/custom", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: name,
            project_id: projectId,
            code: code,
            description: description,
          }),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Create failed"); });
            return res.json();
          })
          .then(function (data) {
            saveBtn.lastChild.textContent = " Save Tool";
            savedToolId = data.tool.id;
            currentSchema = data.schema;
            currentParams = data.parameters || [];
            renderParams(currentParams);
            schemaViewer.innerHTML = highlightJSON(currentSchema);
            renderTestInputs(currentParams);
            showSaveStatus("Tool saved! You can now test it.", "zen-green");
          })
          .catch(function (err) {
            saveBtn.lastChild.textContent = " Save Tool";
            showSaveStatus("Error: " + err.message, "coral");
          });
      }
    }

    saveBtn.addEventListener("click", saveTool);

    /* ---------------------------------------------------------------
       Copy schema
    --------------------------------------------------------------- */
    copySchemaBtn.addEventListener("click", function () {
      if (!currentSchema) return;
      var formatted = JSON.stringify(currentSchema, null, 2);
      navigator.clipboard.writeText(formatted).then(function () {
        copyLabel.textContent = "Copied!";
        setTimeout(function () { copyLabel.textContent = "Copy"; }, 2000);
      });
    });

    /* ---------------------------------------------------------------
       Status helper
    --------------------------------------------------------------- */
    function showSaveStatus(msg, color) {
      saveStatus.textContent = msg;
      saveStatus.className = "text-sm text-" + color;
      saveStatus.classList.remove("hidden");
      setTimeout(function () { saveStatus.classList.add("hidden"); }, 4000);
    }

    /* ---------------------------------------------------------------
       Escape HTML
    --------------------------------------------------------------- */
    function escapeHtml(str) {
      var div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    /* ---------------------------------------------------------------
       Initial analysis
    --------------------------------------------------------------- */
    setTimeout(analyzeCode, 300);
  })();
</script>
