---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";

const breadcrumbs = [
  { label: "Tools", href: "/tools" },
  { label: "Schema Editor" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const plusIcon = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const trashIcon = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
const copyIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
const saveIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>';
const importIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
const chevronIcon = '<svg class="h-4 w-4 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';
---

<PageLayout
  title="Schema Editor"
  description="Build tool schemas visually"
  activeSection="tools"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-7xl mx-auto">
    <!-- Back link -->
    <a href="/tools" class="inline-flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors mb-6">
      <span set:html={backIcon} />
      Back to Tools
    </a>

    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Visual Schema Editor</h1>
        <p class="text-sm text-muted mt-1">Define tools by building their schema visually — no code needed</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="import-openapi-btn" class="inline-flex items-center gap-1.5 text-sm text-zen-blue hover:text-zen-blue/80 font-medium cursor-pointer transition-colors">
          <span set:html={importIcon} />
          Import OpenAPI
        </button>
      </div>
    </div>

    <!-- Tool name + project + type row -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div>
        <label for="tool-name" class="block text-sm font-medium text-dark mb-1.5">Tool Name</label>
        <input
          type="text"
          id="tool-name"
          placeholder="e.g. fetch_weather"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
        />
      </div>
      <div>
        <label for="tool-project" class="block text-sm font-medium text-dark mb-1.5">Project</label>
        <select
          id="tool-project"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer transition-all"
        >
          <option value="">Loading projects...</option>
        </select>
      </div>
      <div>
        <label for="tool-type" class="block text-sm font-medium text-dark mb-1.5">Tool Type</label>
        <select
          id="tool-type"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer transition-all"
        >
          <option value="schema">Schema (generic)</option>
          <option value="http">HTTP (API call)</option>
        </select>
      </div>
    </div>

    <!-- Description -->
    <div class="mb-6">
      <label for="tool-description" class="block text-sm font-medium text-dark mb-1.5">Description</label>
      <input
        type="text"
        id="tool-description"
        placeholder="Brief description of what this tool does"
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
      />
    </div>

    <!-- HTTP config (hidden by default) -->
    <div id="http-config" class="hidden mb-6 rounded-xl border border-dark/[0.08] p-5 bg-subtle/30">
      <h2 class="text-sm font-semibold text-dark mb-4">HTTP Configuration</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="http-method" class="block text-xs font-medium text-dark mb-1.5">Method</label>
          <select
            id="http-method"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer transition-all"
          >
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="PATCH">PATCH</option>
            <option value="DELETE">DELETE</option>
          </select>
        </div>
        <div>
          <label for="http-url" class="block text-xs font-medium text-dark mb-1.5">URL Template</label>
          <input
            type="text"
            id="http-url"
            placeholder="https://api.example.com/v1/{endpoint}"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all font-mono"
          />
        </div>
      </div>
      <!-- Headers -->
      <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
          <label class="text-xs font-medium text-dark">Headers</label>
          <button id="add-header-btn" class="text-xs text-zen-blue hover:text-zen-blue/80 font-medium cursor-pointer transition-colors">+ Add Header</button>
        </div>
        <div id="headers-list" class="space-y-2"></div>
      </div>
      <!-- Body template -->
      <div>
        <label for="http-body" class="block text-xs font-medium text-dark mb-1.5">Body Template <span class="text-muted font-normal">(JSON, use {"{"}<span>param</span>{"}"} for substitution)</span></label>
        <textarea
          id="http-body"
          rows="4"
          placeholder='{"query": "{search_query}", "limit": {max_results}}'
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark font-mono placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all resize-y"
        ></textarea>
      </div>
    </div>

    <!-- Main content: Parameters + Schema preview -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left: Parameters -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-dark">Parameters</h2>
          <button id="add-param-btn" class="inline-flex items-center gap-1.5 text-xs text-zen-blue hover:text-zen-blue/80 font-medium cursor-pointer transition-colors">
            <span set:html={plusIcon} />
            Add Parameter
          </button>
        </div>

        <div id="params-list" class="space-y-3">
          <p id="empty-params" class="text-xs text-muted italic py-8 text-center">No parameters yet. Click "Add Parameter" to define inputs.</p>
        </div>
      </div>

      <!-- Right: JSON Schema preview -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-dark">JSON Schema Preview</h2>
          <button id="copy-schema-btn" class="flex items-center gap-1.5 text-xs text-muted hover:text-dark transition-colors cursor-pointer">
            <span set:html={copyIcon} />
            <span id="copy-label">Copy</span>
          </button>
        </div>
        <div class="rounded-xl bg-[#1e1e1e] border border-dark/[0.08] overflow-hidden sticky top-6">
          <pre id="schema-viewer" class="p-4 text-sm font-mono text-[#d4d4d4] overflow-x-auto leading-relaxed max-h-[600px] overflow-y-auto">{}</pre>
        </div>

        <!-- Save button area -->
        <div class="mt-6 flex items-center gap-3">
          <Button variant="primary" id="save-btn">
            <span set:html={saveIcon} />
            Save Tool
          </Button>
          <span id="save-status" class="text-sm hidden"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- OpenAPI Import Modal -->
  <dialog id="openapi-modal" class="rounded-xl border border-dark/[0.08] shadow-lg p-0 w-full max-w-lg backdrop:bg-dark/40">
    <div class="p-6">
      <h3 class="text-lg font-semibold text-dark mb-2">Import from OpenAPI</h3>
      <p class="text-sm text-muted mb-4">Paste an OpenAPI/Swagger JSON specification or a URL to auto-generate tool definitions.</p>
      <div class="mb-4">
        <label for="openapi-input" class="block text-xs font-medium text-dark mb-1.5">OpenAPI JSON or URL</label>
        <textarea
          id="openapi-input"
          rows="10"
          placeholder='Paste OpenAPI JSON here, or enter a URL like https://api.example.com/openapi.json'
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark font-mono placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all resize-y"
        ></textarea>
      </div>
      <div id="openapi-error" class="hidden text-sm text-coral mb-4"></div>
      <div class="flex items-center justify-end gap-3">
        <button id="openapi-cancel" class="px-4 py-2 text-sm text-muted hover:text-dark transition-colors cursor-pointer">Cancel</button>
        <Button variant="primary" id="openapi-import">
          <span set:html={importIcon} />
          Import
        </Button>
      </div>
    </div>
  </dialog>

  <!-- Parameter template (cloned for each parameter) -->
  <template id="param-template">
    <div class="param-card rounded-xl border border-dark/[0.08] bg-paper overflow-hidden" data-param-id="">
      <!-- Param header -->
      <div class="flex items-center gap-3 px-4 py-3 bg-subtle/40 border-b border-dark/[0.06]">
        <button class="param-toggle cursor-pointer text-muted hover:text-dark transition-colors" title="Expand/collapse">
          <span set:html={chevronIcon} />
        </button>
        <input
          type="text"
          class="param-name flex-1 bg-transparent text-sm font-mono font-semibold text-dark outline-none placeholder:text-muted/60"
          placeholder="parameter_name"
        />
        <select class="param-type bg-paper border border-dark/[0.08] rounded px-2 py-1 text-xs text-dark outline-none cursor-pointer">
          <option value="string">string</option>
          <option value="integer">integer</option>
          <option value="number">number</option>
          <option value="boolean">boolean</option>
          <option value="array">array</option>
          <option value="object">object</option>
        </select>
        <label class="inline-flex items-center gap-1.5 text-xs cursor-pointer select-none">
          <input type="checkbox" class="param-required accent-coral" checked />
          <span class="text-muted">Required</span>
        </label>
        <button class="param-delete text-muted hover:text-coral transition-colors cursor-pointer" title="Remove parameter">
          <span set:html={trashIcon} />
        </button>
      </div>
      <!-- Param body (collapsible) -->
      <div class="param-body px-4 py-3 space-y-3">
        <div>
          <label class="block text-xs font-medium text-muted mb-1">Description</label>
          <input
            type="text"
            class="param-description w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-1.5 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
            placeholder="What this parameter does"
          />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-muted mb-1">Default Value</label>
            <input
              type="text"
              class="param-default w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-1.5 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
              placeholder="none"
            />
          </div>
          <div class="param-enum-section">
            <label class="block text-xs font-medium text-muted mb-1">Enum Values <span class="font-normal">(comma-separated)</span></label>
            <input
              type="text"
              class="param-enum w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-1.5 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
              placeholder="e.g. low, medium, high"
            />
          </div>
        </div>
        <!-- Nested object params (shown when type=object) -->
        <div class="param-nested hidden">
          <div class="flex items-center justify-between mb-2">
            <label class="text-xs font-medium text-muted">Nested Properties</label>
            <button class="add-nested-btn text-xs text-zen-blue hover:text-zen-blue/80 font-medium cursor-pointer transition-colors">+ Add Property</button>
          </div>
          <div class="nested-params-list space-y-2 pl-4 border-l-2 border-dark/[0.06]"></div>
        </div>
      </div>
    </div>
  </template>

  <!-- Nested parameter template -->
  <template id="nested-param-template">
    <div class="nested-param-card rounded-lg border border-dark/[0.06] bg-subtle/30 p-3" data-nested-id="">
      <div class="flex items-center gap-2 mb-2">
        <input
          type="text"
          class="nested-name flex-1 bg-paper border border-dark/[0.08] rounded px-2 py-1 text-xs font-mono text-dark outline-none placeholder:text-muted/60"
          placeholder="property_name"
        />
        <select class="nested-type bg-paper border border-dark/[0.08] rounded px-2 py-1 text-xs text-dark outline-none cursor-pointer">
          <option value="string">string</option>
          <option value="integer">integer</option>
          <option value="number">number</option>
          <option value="boolean">boolean</option>
          <option value="array">array</option>
        </select>
        <label class="inline-flex items-center gap-1 text-xs cursor-pointer select-none">
          <input type="checkbox" class="nested-required accent-coral" checked />
          <span class="text-muted">Req</span>
        </label>
        <button class="nested-delete text-muted hover:text-coral transition-colors cursor-pointer" title="Remove">
          <span set:html={trashIcon} />
        </button>
      </div>
      <input
        type="text"
        class="nested-description w-full bg-paper border border-dark/[0.08] rounded px-2 py-1 text-xs text-dark placeholder:text-muted/60 outline-none"
        placeholder="Description"
      />
    </div>
  </template>

  <!-- Header key-value template -->
  <template id="header-template">
    <div class="header-row flex items-center gap-2">
      <input
        type="text"
        class="header-key flex-1 bg-paper border border-dark/[0.08] rounded-lg px-3 py-1.5 text-sm text-dark font-mono placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
        placeholder="Header-Name"
      />
      <input
        type="text"
        class="header-value flex-1 bg-paper border border-dark/[0.08] rounded-lg px-3 py-1.5 text-sm text-dark font-mono placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
        placeholder="value"
      />
      <button class="header-delete text-muted hover:text-coral transition-colors cursor-pointer" title="Remove header">
        <span set:html={trashIcon} />
      </button>
    </div>
  </template>
</PageLayout>

<script is:inline>
  (function () {
    /* ---------------------------------------------------------------
       DOM refs
    --------------------------------------------------------------- */
    var nameInput = document.getElementById("tool-name");
    var projectSelect = document.getElementById("tool-project");
    var typeSelect = document.getElementById("tool-type");
    var descriptionInput = document.getElementById("tool-description");
    var httpConfig = document.getElementById("http-config");
    var httpMethod = document.getElementById("http-method");
    var httpUrl = document.getElementById("http-url");
    var httpBody = document.getElementById("http-body");
    var headersList = document.getElementById("headers-list");
    var addHeaderBtn = document.getElementById("add-header-btn");
    var paramsList = document.getElementById("params-list");
    var emptyParams = document.getElementById("empty-params");
    var addParamBtn = document.getElementById("add-param-btn");
    var schemaViewer = document.getElementById("schema-viewer");
    var copySchemaBtn = document.getElementById("copy-schema-btn");
    var copyLabel = document.getElementById("copy-label");
    var saveBtn = document.getElementById("save-btn");
    var saveStatus = document.getElementById("save-status");
    var openapiModal = document.getElementById("openapi-modal");
    var openapiInput = document.getElementById("openapi-input");
    var openapiError = document.getElementById("openapi-error");
    var openapiImportBtn = document.getElementById("openapi-import");
    var openapiCancelBtn = document.getElementById("openapi-cancel");
    var importOpenapiBtn = document.getElementById("import-openapi-btn");

    var paramTemplate = document.getElementById("param-template");
    var nestedTemplate = document.getElementById("nested-param-template");
    var headerTemplate = document.getElementById("header-template");

    var paramCounter = 0;
    var nestedCounter = 0;
    var savedToolId = null;

    /* ---------------------------------------------------------------
       Load projects
    --------------------------------------------------------------- */
    fetch("/api/projects")
      .then(function (res) {
        if (!res.ok) throw new Error("Failed");
        return res.json();
      })
      .then(function (body) { return body.data || body; })
      .then(function (projects) {
        projectSelect.innerHTML = "";
        if (projects.length === 0) {
          projectSelect.innerHTML = '<option value="">No projects — create one first</option>';
          return;
        }
        projects.forEach(function (p) {
          var opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.name;
          projectSelect.appendChild(opt);
        });
      })
      .catch(function () {
        projectSelect.innerHTML = '<option value="">Failed to load projects</option>';
      });

    /* ---------------------------------------------------------------
       Tool type toggle (show/hide HTTP config)
    --------------------------------------------------------------- */
    typeSelect.addEventListener("change", function () {
      if (typeSelect.value === "http") {
        httpConfig.classList.remove("hidden");
      } else {
        httpConfig.classList.add("hidden");
      }
      updateSchema();
    });

    /* ---------------------------------------------------------------
       Add header row
    --------------------------------------------------------------- */
    addHeaderBtn.addEventListener("click", function () {
      var clone = headerTemplate.content.cloneNode(true);
      var row = clone.querySelector(".header-row");
      row.querySelector(".header-delete").addEventListener("click", function () {
        row.remove();
        updateSchema();
      });
      row.querySelector(".header-key").addEventListener("input", updateSchema);
      row.querySelector(".header-value").addEventListener("input", updateSchema);
      headersList.appendChild(clone);
    });

    /* ---------------------------------------------------------------
       Add parameter
    --------------------------------------------------------------- */
    function addParameter(opts) {
      opts = opts || {};
      paramCounter++;
      var id = "param-" + paramCounter;

      var clone = paramTemplate.content.cloneNode(true);
      var card = clone.querySelector(".param-card");
      card.setAttribute("data-param-id", id);

      var nameEl = card.querySelector(".param-name");
      var typeEl = card.querySelector(".param-type");
      var requiredEl = card.querySelector(".param-required");
      var descEl = card.querySelector(".param-description");
      var defaultEl = card.querySelector(".param-default");
      var enumEl = card.querySelector(".param-enum");
      var enumSection = card.querySelector(".param-enum-section");
      var nestedSection = card.querySelector(".param-nested");
      var nestedList = card.querySelector(".nested-params-list");
      var addNestedBtn = card.querySelector(".add-nested-btn");
      var deleteBtn = card.querySelector(".param-delete");
      var toggleBtn = card.querySelector(".param-toggle");
      var body = card.querySelector(".param-body");

      // Pre-fill values
      if (opts.name) nameEl.value = opts.name;
      if (opts.type) typeEl.value = opts.type;
      if (opts.required === false) requiredEl.checked = false;
      if (opts.description) descEl.value = opts.description;
      if (opts.defaultValue) defaultEl.value = opts.defaultValue;
      if (opts.enumValues) enumEl.value = opts.enumValues;

      // Show/hide enum based on type
      function updateTypeVisibility() {
        var t = typeEl.value;
        if (t === "string") {
          enumSection.classList.remove("hidden");
        } else {
          enumSection.classList.add("hidden");
        }
        if (t === "object") {
          nestedSection.classList.remove("hidden");
        } else {
          nestedSection.classList.add("hidden");
        }
        updateSchema();
      }

      typeEl.addEventListener("change", updateTypeVisibility);
      updateTypeVisibility();

      // Collapse/expand
      toggleBtn.addEventListener("click", function () {
        body.classList.toggle("hidden");
        var svg = toggleBtn.querySelector("svg");
        if (body.classList.contains("hidden")) {
          svg.style.transform = "rotate(-90deg)";
        } else {
          svg.style.transform = "";
        }
      });

      // Delete
      deleteBtn.addEventListener("click", function () {
        card.remove();
        updateEmptyState();
        updateSchema();
      });

      // Add nested property
      addNestedBtn.addEventListener("click", function () {
        addNestedParam(nestedList);
      });

      // Pre-add nested params
      if (opts.nested && opts.nested.length > 0) {
        opts.nested.forEach(function (np) {
          addNestedParam(nestedList, np);
        });
      }

      // Listen for changes
      [nameEl, descEl, defaultEl, enumEl, requiredEl].forEach(function (el) {
        el.addEventListener("input", updateSchema);
        el.addEventListener("change", updateSchema);
      });

      paramsList.appendChild(clone);
      updateEmptyState();
      updateSchema();

      return card;
    }

    addParamBtn.addEventListener("click", function () {
      addParameter();
    });

    /* ---------------------------------------------------------------
       Add nested parameter
    --------------------------------------------------------------- */
    function addNestedParam(container, opts) {
      opts = opts || {};
      nestedCounter++;
      var id = "nested-" + nestedCounter;

      var clone = nestedTemplate.content.cloneNode(true);
      var card = clone.querySelector(".nested-param-card");
      card.setAttribute("data-nested-id", id);

      var nameEl = card.querySelector(".nested-name");
      var typeEl = card.querySelector(".nested-type");
      var requiredEl = card.querySelector(".nested-required");
      var descEl = card.querySelector(".nested-description");
      var deleteBtn = card.querySelector(".nested-delete");

      if (opts.name) nameEl.value = opts.name;
      if (opts.type) typeEl.value = opts.type;
      if (opts.required === false) requiredEl.checked = false;
      if (opts.description) descEl.value = opts.description;

      deleteBtn.addEventListener("click", function () {
        card.remove();
        updateSchema();
      });

      [nameEl, typeEl, requiredEl, descEl].forEach(function (el) {
        el.addEventListener("input", updateSchema);
        el.addEventListener("change", updateSchema);
      });

      container.appendChild(clone);
      updateSchema();
    }

    /* ---------------------------------------------------------------
       Empty state
    --------------------------------------------------------------- */
    function updateEmptyState() {
      var cards = paramsList.querySelectorAll(".param-card");
      if (cards.length === 0) {
        emptyParams.classList.remove("hidden");
      } else {
        emptyParams.classList.add("hidden");
      }
    }

    /* ---------------------------------------------------------------
       Build schema from visual state
    --------------------------------------------------------------- */
    function buildSchema() {
      var properties = {};
      var required = [];
      var description = descriptionInput.value.trim();

      var cards = paramsList.querySelectorAll(".param-card");
      cards.forEach(function (card) {
        var name = card.querySelector(".param-name").value.trim();
        if (!name) return;

        var type = card.querySelector(".param-type").value;
        var isRequired = card.querySelector(".param-required").checked;
        var desc = card.querySelector(".param-description").value.trim();
        var defaultVal = card.querySelector(".param-default").value.trim();
        var enumVal = card.querySelector(".param-enum").value.trim();

        var prop = { type: type };
        if (desc) prop.description = desc;

        // Default value — parse based on type
        if (defaultVal) {
          if (type === "integer") prop.default = parseInt(defaultVal, 10) || 0;
          else if (type === "number") prop.default = parseFloat(defaultVal) || 0;
          else if (type === "boolean") prop.default = defaultVal === "true";
          else prop.default = defaultVal;
        }

        // Enum for strings
        if (type === "string" && enumVal) {
          prop.enum = enumVal.split(",").map(function (v) { return v.trim(); }).filter(Boolean);
        }

        // Nested object properties
        if (type === "object") {
          var nestedProps = {};
          var nestedRequired = [];
          var nestedCards = card.querySelectorAll(".nested-param-card");
          nestedCards.forEach(function (nc) {
            var nName = nc.querySelector(".nested-name").value.trim();
            if (!nName) return;
            var nType = nc.querySelector(".nested-type").value;
            var nReq = nc.querySelector(".nested-required").checked;
            var nDesc = nc.querySelector(".nested-description").value.trim();

            var nProp = { type: nType };
            if (nDesc) nProp.description = nDesc;
            nestedProps[nName] = nProp;
            if (nReq) nestedRequired.push(nName);
          });
          if (Object.keys(nestedProps).length > 0) {
            prop.properties = nestedProps;
            if (nestedRequired.length > 0) prop.required = nestedRequired;
          }
        }

        properties[name] = prop;
        if (isRequired) required.push(name);
      });

      var schema = { type: "object", properties: properties };
      if (required.length > 0) schema.required = required;
      if (description) schema.description = description;

      return schema;
    }

    /* ---------------------------------------------------------------
       Update schema preview (debounced)
    --------------------------------------------------------------- */
    var schemaTimeout;
    function updateSchema() {
      clearTimeout(schemaTimeout);
      schemaTimeout = setTimeout(function () {
        var schema = buildSchema();
        schemaViewer.innerHTML = highlightJSON(schema);
      }, 150);
    }

    // Also listen for top-level field changes
    [nameInput, descriptionInput, httpMethod, httpUrl, httpBody].forEach(function (el) {
      if (el) el.addEventListener("input", updateSchema);
    });

    /* ---------------------------------------------------------------
       JSON highlighting
    --------------------------------------------------------------- */
    function highlightJSON(obj) {
      var str = JSON.stringify(obj, null, 2);
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"([^"]+)":/g, '<span style="color:#9cdcfe">"$1"</span>:')
        .replace(/: "(.*?)"/g, ': <span style="color:#ce9178">"$1"</span>')
        .replace(/: (\d+)/g, ': <span style="color:#b5cea8">$1</span>')
        .replace(/: (true|false)/g, ': <span style="color:#569cd6">$1</span>')
        .replace(/: (null)/g, ': <span style="color:#569cd6">$1</span>');
    }

    /* ---------------------------------------------------------------
       Copy schema
    --------------------------------------------------------------- */
    copySchemaBtn.addEventListener("click", function () {
      var schema = buildSchema();
      var formatted = JSON.stringify(schema, null, 2);
      navigator.clipboard.writeText(formatted).then(function () {
        copyLabel.textContent = "Copied!";
        setTimeout(function () { copyLabel.textContent = "Copy"; }, 2000);
      });
    });

    /* ---------------------------------------------------------------
       Save tool
    --------------------------------------------------------------- */
    function saveTool() {
      var name = nameInput.value.trim();
      var projectId = projectSelect.value;
      var description = descriptionInput.value.trim();
      var toolType = typeSelect.value;

      if (!name) { showStatus("Tool name is required.", "coral"); return; }
      if (!projectId) { showStatus("Select a project.", "coral"); return; }

      var schema = buildSchema();

      // Check at least one parameter
      var paramCount = Object.keys(schema.properties || {}).length;
      if (paramCount === 0) { showStatus("Add at least one parameter.", "coral"); return; }

      // Build HTTP config if applicable
      var httpConfigData = null;
      if (toolType === "http") {
        httpConfigData = {
          method: httpMethod.value,
          url: httpUrl.value.trim(),
          headers: getHeaders(),
          body_template: httpBody.value.trim(),
        };
        if (!httpConfigData.url) { showStatus("HTTP URL is required.", "coral"); return; }
      }

      saveBtn.lastChild.textContent = " Saving...";

      fetch("/api/tools/schema/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: name,
          project_id: projectId,
          description: description,
          schema: schema,
          tool_type: toolType,
          http_config: httpConfigData,
        }),
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Save failed"); });
          return res.json();
        })
        .then(function (data) {
          saveBtn.lastChild.textContent = " Save Tool";
          savedToolId = data.id;
          showStatus("Tool saved! Redirecting...", "zen-green");
          setTimeout(function () {
            window.location.href = "/tools/" + data.id;
          }, 1000);
        })
        .catch(function (err) {
          saveBtn.lastChild.textContent = " Save Tool";
          showStatus("Error: " + err.message, "coral");
        });
    }

    saveBtn.addEventListener("click", saveTool);

    /* ---------------------------------------------------------------
       Get headers as object
    --------------------------------------------------------------- */
    function getHeaders() {
      var headers = {};
      var rows = headersList.querySelectorAll(".header-row");
      rows.forEach(function (row) {
        var key = row.querySelector(".header-key").value.trim();
        var val = row.querySelector(".header-value").value.trim();
        if (key) headers[key] = val;
      });
      return headers;
    }

    /* ---------------------------------------------------------------
       Status helper
    --------------------------------------------------------------- */
    function showStatus(msg, color) {
      saveStatus.textContent = msg;
      saveStatus.className = "text-sm text-" + color;
      saveStatus.classList.remove("hidden");
      setTimeout(function () { saveStatus.classList.add("hidden"); }, 4000);
    }

    /* ---------------------------------------------------------------
       OpenAPI Import
    --------------------------------------------------------------- */
    importOpenapiBtn.addEventListener("click", function () {
      openapiError.classList.add("hidden");
      openapiInput.value = "";
      openapiModal.showModal();
    });

    openapiCancelBtn.addEventListener("click", function () {
      openapiModal.close();
    });

    openapiModal.addEventListener("click", function (e) {
      if (e.target === openapiModal) openapiModal.close();
    });

    openapiImportBtn.addEventListener("click", function () {
      var input = openapiInput.value.trim();
      if (!input) {
        openapiError.textContent = "Please paste OpenAPI JSON or enter a URL.";
        openapiError.classList.remove("hidden");
        return;
      }

      // Try to parse as JSON first
      try {
        var spec = JSON.parse(input);
        importOpenAPISpec(spec);
        return;
      } catch (_e) {
        // Not JSON — might be a URL
      }

      // Try as URL
      if (input.startsWith("http://") || input.startsWith("https://")) {
        openapiError.textContent = "Fetching...";
        openapiError.classList.remove("hidden");
        openapiError.className = "text-sm text-muted mb-4";

        fetch(input)
          .then(function (res) {
            if (!res.ok) throw new Error("HTTP " + res.status);
            return res.json();
          })
          .then(function (spec) {
            importOpenAPISpec(spec);
          })
          .catch(function (err) {
            openapiError.textContent = "Failed to fetch: " + err.message;
            openapiError.className = "text-sm text-coral mb-4";
            openapiError.classList.remove("hidden");
          });
        return;
      }

      openapiError.textContent = "Input must be valid JSON or a URL starting with http(s)://.";
      openapiError.classList.remove("hidden");
    });

    function importOpenAPISpec(spec) {
      // Extract from OpenAPI 3.x or Swagger 2.x
      var paths = spec.paths;
      if (!paths) {
        openapiError.textContent = "No 'paths' found in the specification.";
        openapiError.className = "text-sm text-coral mb-4";
        openapiError.classList.remove("hidden");
        return;
      }

      // Find the first operation with a requestBody or parameters
      var imported = false;
      var pathKeys = Object.keys(paths);

      for (var pi = 0; pi < pathKeys.length && !imported; pi++) {
        var pathKey = pathKeys[pi];
        var methods = paths[pathKey];
        var methodNames = ["post", "get", "put", "patch", "delete"];

        for (var mi = 0; mi < methodNames.length && !imported; mi++) {
          var method = methodNames[mi];
          var op = methods[method];
          if (!op) continue;

          // Set tool name and description
          nameInput.value = op.operationId || op.summary || pathKey.replace(/\//g, "_").replace(/^_/, "");
          descriptionInput.value = op.description || op.summary || "";

          // Switch to HTTP type
          typeSelect.value = "http";
          httpConfig.classList.remove("hidden");
          httpMethod.value = method.toUpperCase();

          // Build URL from servers + path
          var baseUrl = "";
          if (spec.servers && spec.servers.length > 0) {
            baseUrl = spec.servers[0].url;
          } else if (spec.host) {
            var scheme = (spec.schemes && spec.schemes[0]) || "https";
            baseUrl = scheme + "://" + spec.host + (spec.basePath || "");
          }
          httpUrl.value = baseUrl + pathKey;

          // Clear existing params
          var existingCards = paramsList.querySelectorAll(".param-card");
          existingCards.forEach(function (c) { c.remove(); });

          // Extract parameters from query/path params
          var opParams = op.parameters || [];
          opParams.forEach(function (p) {
            addParameter({
              name: p.name,
              type: mapOpenAPIType(p.schema ? p.schema.type : p.type),
              required: p.required || false,
              description: p.description || "",
            });
          });

          // Extract from requestBody (OpenAPI 3.x)
          if (op.requestBody && op.requestBody.content) {
            var content = op.requestBody.content;
            var jsonContent = content["application/json"];
            if (jsonContent && jsonContent.schema) {
              var bodySchema = resolveRef(spec, jsonContent.schema);
              if (bodySchema.properties) {
                var bodyRequired = bodySchema.required || [];
                Object.keys(bodySchema.properties).forEach(function (propName) {
                  var propDef = bodySchema.properties[propName];
                  var nested = null;
                  if (propDef.type === "object" && propDef.properties) {
                    nested = Object.keys(propDef.properties).map(function (npName) {
                      return {
                        name: npName,
                        type: mapOpenAPIType(propDef.properties[npName].type),
                        description: propDef.properties[npName].description || "",
                        required: (propDef.required || []).indexOf(npName) !== -1,
                      };
                    });
                  }
                  addParameter({
                    name: propName,
                    type: mapOpenAPIType(propDef.type),
                    required: bodyRequired.indexOf(propName) !== -1,
                    description: propDef.description || "",
                    nested: nested,
                  });
                });
              }
            }
          }

          imported = true;
        }
      }

      if (imported) {
        openapiModal.close();
        updateEmptyState();
        updateSchema();
      } else {
        openapiError.textContent = "No usable operations found in the specification.";
        openapiError.className = "text-sm text-coral mb-4";
        openapiError.classList.remove("hidden");
      }
    }

    function mapOpenAPIType(t) {
      if (!t) return "string";
      var map = { string: "string", integer: "integer", number: "number", boolean: "boolean", array: "array", object: "object" };
      return map[t] || "string";
    }

    function resolveRef(spec, schema) {
      if (!schema || !schema["$ref"]) return schema || {};
      var ref = schema["$ref"];
      // Handle #/components/schemas/Name or #/definitions/Name
      var parts = ref.replace("#/", "").split("/");
      var resolved = spec;
      for (var i = 0; i < parts.length; i++) {
        resolved = resolved[parts[i]];
        if (!resolved) return {};
      }
      return resolved;
    }

    /* ---------------------------------------------------------------
       Initial state
    --------------------------------------------------------------- */
    updateSchema();
  })();
</script>
