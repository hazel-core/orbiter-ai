---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";
import Modal from "../../components/Modal.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Tools", href: "/tools" },
  { label: "Loading..." },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const copyIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
---

<PageLayout
  title="Tool Detail"
  description="View tool details"
  activeSection="tools"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading tool...</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <p class="text-lg font-semibold text-dark mb-2">Tool not found</p>
      <p class="text-sm text-muted mb-6">This tool may have been deleted.</p>
      <Button href="/tools" variant="bordered">
        <span set:html={backIcon} />
        Back to Tools
      </Button>
    </div>

    <!-- Tool detail (hidden until loaded) -->
    <div id="detail-content" class="hidden">
      <!-- Back + Actions row -->
      <div class="flex items-center justify-between mb-6">
        <a href="/tools" class="flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          Back to Tools
        </a>
        <div class="flex items-center gap-2">
          <Button variant="primary" id="add-to-agent-btn">
            <span set:html={plusIcon} />
            Add to Agent
          </Button>
        </div>
      </div>

      <!-- Tool header -->
      <div class="mb-8">
        <div class="flex items-center gap-3 mb-2">
          <span id="detail-category-icon" class="flex-shrink-0 w-10 h-10 rounded-xl flex items-center justify-center text-lg"></span>
          <div>
            <h1 id="detail-name" class="text-2xl font-semibold text-dark"></h1>
            <div class="flex items-center gap-2 mt-1">
              <span id="detail-category-badge" class="text-xs px-2 py-0.5 rounded-full font-medium"></span>
              <span id="detail-tool-type" class="text-xs px-1.5 py-0.5 rounded bg-muted/10 text-muted"></span>
              <span id="detail-usage" class="text-xs text-muted"></span>
            </div>
          </div>
        </div>
        <p id="detail-description" class="text-sm text-muted mt-3 leading-relaxed"></p>
      </div>

      <!-- Parameters section -->
      <div class="mb-8">
        <h2 class="text-lg font-semibold text-dark mb-4">Parameters</h2>
        <div id="params-container" class="space-y-3">
        </div>
        <div id="no-params" class="hidden text-sm text-muted py-4">
          This tool has no parameters defined.
        </div>
      </div>

      <!-- JSON Schema section -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-dark">JSON Schema</h2>
          <button id="copy-schema-btn" class="flex items-center gap-1.5 text-xs text-muted hover:text-dark transition-colors cursor-pointer">
            <span set:html={copyIcon} />
            Copy
          </button>
        </div>
        <div class="rounded-xl bg-[#1e1e1e] border border-dark/[0.08] overflow-hidden">
          <pre id="schema-viewer" class="p-4 text-sm font-mono text-[#d4d4d4] overflow-x-auto leading-relaxed"></pre>
        </div>
      </div>

      <!-- Example Usage section -->
      <div id="code-section" class="mb-8">
        <h2 class="text-lg font-semibold text-dark mb-4">Code</h2>
        <div class="rounded-xl bg-[#1e1e1e] border border-dark/[0.08] overflow-hidden">
          <pre id="code-viewer" class="p-4 text-sm font-mono text-[#d4d4d4] overflow-x-auto leading-relaxed"></pre>
        </div>
      </div>

      <!-- Metadata -->
      <div class="border-t border-dark/[0.08] pt-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
          <div>
            <span class="text-muted text-xs">Created</span>
            <p id="detail-created" class="text-dark font-medium"></p>
          </div>
          <div>
            <span class="text-muted text-xs">Tool ID</span>
            <p id="detail-id" class="text-dark font-medium font-mono text-xs"></p>
          </div>
          <div>
            <span class="text-muted text-xs">Project ID</span>
            <p id="detail-project" class="text-dark font-medium font-mono text-xs"></p>
          </div>
          <div>
            <span class="text-muted text-xs">Usage Count</span>
            <p id="detail-usage-count" class="text-dark font-medium"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add to Agent Modal -->
  <Modal id="agent-selector-modal" title="Add Tool to Agent">
    <div class="flex flex-col gap-4">
      <p class="text-sm text-muted">Select an agent to add this tool to:</p>
      <div id="agent-list-loading" class="text-sm text-muted py-4 text-center">Loading agents...</div>
      <div id="agent-list" class="hidden flex flex-col gap-2 max-h-80 overflow-y-auto">
      </div>
      <div id="agent-list-empty" class="hidden text-sm text-muted py-4 text-center">
        No agents found. Create an agent first.
      </div>
      <div id="agent-add-status" class="text-sm hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="agent-selector-modal">
          Close
        </Button>
      </div>
    </div>
  </Modal>
</PageLayout>

<!-- Agent row template -->
<template id="agent-row-template">
  <div class="flex items-center justify-between p-3 rounded-lg border border-dark/[0.08] hover:border-dark/20 transition-colors">
    <div class="min-w-0 flex-1">
      <p class="text-sm font-medium text-dark truncate" data-field="agent-name"></p>
      <p class="text-xs text-muted truncate" data-field="agent-desc"></p>
    </div>
    <button class="flex-shrink-0 text-xs font-medium text-zen-blue hover:text-zen-blue/80 transition-colors cursor-pointer px-3 py-1.5 rounded-lg border border-zen-blue/20 hover:bg-zen-blue/5" data-field="add-btn">
      Add
    </button>
  </div>
</template>

<script is:inline define:vars={{ id }}>
  (function () {
    /* ---------------------------------------------------------------
       DOM refs
    --------------------------------------------------------------- */
    var loadingState = document.getElementById("loading-state");
    var errorState = document.getElementById("error-state");
    var detailContent = document.getElementById("detail-content");
    var addToAgentBtn = document.getElementById("add-to-agent-btn");
    var agentModal = document.getElementById("agent-selector-modal");
    var agentListLoading = document.getElementById("agent-list-loading");
    var agentList = document.getElementById("agent-list");
    var agentListEmpty = document.getElementById("agent-list-empty");
    var agentAddStatus = document.getElementById("agent-add-status");
    var agentRowTemplate = document.getElementById("agent-row-template");
    var copySchemaBtn = document.getElementById("copy-schema-btn");
    var codeSection = document.getElementById("code-section");

    var currentTool = null;

    /* ---------------------------------------------------------------
       Category metadata
    --------------------------------------------------------------- */
    var categoryMeta = {
      search: { icon: "üîç", bg: "bg-zen-blue/10", text: "text-zen-blue", label: "Search" },
      code: { icon: "üíª", bg: "bg-[#f59e0b]/10", text: "text-[#f59e0b]", label: "Code" },
      file: { icon: "üìÅ", bg: "bg-zen-green/10", text: "text-zen-green", label: "File" },
      data: { icon: "üìä", bg: "bg-[#a855f7]/10", text: "text-[#a855f7]", label: "Data" },
      communication: { icon: "üí¨", bg: "bg-coral/10", text: "text-coral", label: "Comms" },
      custom: { icon: "‚öôÔ∏è", bg: "bg-muted/10", text: "text-muted", label: "Custom" },
    };

    function getCategoryInfo(cat) {
      return categoryMeta[cat] || categoryMeta.custom;
    }

    /* ---------------------------------------------------------------
       JSON syntax highlighting (simple)
    --------------------------------------------------------------- */
    function highlightJSON(json) {
      var str = JSON.stringify(json, null, 2);
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"([^"]+)":/g, '<span style="color:#9cdcfe">"$1"</span>:')
        .replace(/: "(.*?)"/g, ': <span style="color:#ce9178">"$1"</span>')
        .replace(/: (\d+)/g, ': <span style="color:#b5cea8">$1</span>')
        .replace(/: (true|false)/g, ': <span style="color:#569cd6">$1</span>')
        .replace(/: (null)/g, ': <span style="color:#569cd6">$1</span>');
    }

    /* ---------------------------------------------------------------
       Render tool detail
    --------------------------------------------------------------- */
    function renderDetail(tool) {
      currentTool = tool;
      var catInfo = getCategoryInfo(tool.category);

      // Header
      var iconEl = document.getElementById("detail-category-icon");
      iconEl.className = "flex-shrink-0 w-10 h-10 rounded-xl flex items-center justify-center text-lg " + catInfo.bg;
      iconEl.textContent = catInfo.icon;

      document.getElementById("detail-name").textContent = tool.name;

      var badge = document.getElementById("detail-category-badge");
      badge.className = "text-xs px-2 py-0.5 rounded-full font-medium " + catInfo.bg + " " + catInfo.text;
      badge.textContent = catInfo.label;

      var detailTypeEl = document.getElementById("detail-tool-type");
      detailTypeEl.textContent = tool.tool_type;
      if (tool.tool_type === "mcp") {
        detailTypeEl.className = detailTypeEl.className.replace("bg-muted/10 text-muted", "bg-zen-blue/10 text-zen-blue font-semibold uppercase tracking-wide");
        detailTypeEl.textContent = "MCP";
      }
      document.getElementById("detail-usage").textContent = tool.usage_count + " uses";
      document.getElementById("detail-description").textContent = tool.description || "No description provided.";

      // Parameters
      var paramsContainer = document.getElementById("params-container");
      var noParams = document.getElementById("no-params");
      paramsContainer.innerHTML = "";

      try {
        var schema = JSON.parse(tool.schema_json || "{}");
        var props = schema.properties || (schema.parameters && schema.parameters.properties) || {};
        var required = schema.required || (schema.parameters && schema.parameters.required) || [];
        var keys = Object.keys(props);

        if (keys.length > 0) {
          noParams.classList.add("hidden");
          keys.forEach(function (key) {
            var prop = props[key];
            var isRequired = required.indexOf(key) !== -1;
            var div = document.createElement("div");
            div.className = "rounded-lg border border-dark/[0.08] p-4 bg-subtle/50";
            div.innerHTML =
              '<div class="flex items-center gap-2 mb-1">' +
                '<code class="text-sm font-mono font-semibold text-dark">' + key + '</code>' +
                '<span class="text-xs px-1.5 py-0.5 rounded bg-muted/10 text-muted">' + (prop.type || "any") + '</span>' +
                (isRequired ? '<span class="text-xs px-1.5 py-0.5 rounded bg-coral/10 text-coral font-medium">required</span>' : '') +
              '</div>' +
              (prop.description ? '<p class="text-xs text-muted mt-1">' + prop.description + '</p>' : '') +
              (prop.default !== undefined ? '<p class="text-xs text-muted/60 mt-1">Default: <code class="font-mono">' + JSON.stringify(prop.default) + '</code></p>' : '') +
              (prop.enum ? '<p class="text-xs text-muted/60 mt-1">Values: ' + prop.enum.map(function(v) { return '<code class="font-mono">' + v + '</code>'; }).join(', ') + '</p>' : '');
            paramsContainer.appendChild(div);
          });
        } else {
          noParams.classList.remove("hidden");
        }
      } catch (e) {
        noParams.classList.remove("hidden");
      }

      // Schema viewer
      try {
        var schemaObj = JSON.parse(tool.schema_json || "{}");
        document.getElementById("schema-viewer").innerHTML = highlightJSON(schemaObj);
      } catch (e) {
        document.getElementById("schema-viewer").textContent = tool.schema_json || "{}";
      }

      // Code section
      if (tool.code && tool.code.trim()) {
        codeSection.classList.remove("hidden");
        document.getElementById("code-viewer").textContent = tool.code;
      } else {
        codeSection.classList.add("hidden");
      }

      // Metadata
      document.getElementById("detail-created").textContent = tool.created_at;
      document.getElementById("detail-id").textContent = tool.id;
      document.getElementById("detail-project").textContent = tool.project_id;
      document.getElementById("detail-usage-count").textContent = String(tool.usage_count);

      // Update breadcrumb
      var allBreadcrumbs = document.querySelectorAll("nav li span, nav li a");
      allBreadcrumbs.forEach(function (el) {
        if (el.textContent === "Loading...") {
          el.textContent = tool.name;
        }
      });

      loadingState.classList.add("hidden");
      detailContent.classList.remove("hidden");
    }

    /* ---------------------------------------------------------------
       Fetch tool
    --------------------------------------------------------------- */
    fetch("/api/v1/tools/" + id)
      .then(function (res) {
        if (!res.ok) throw new Error("Not found");
        return res.json();
      })
      .then(function (tool) {
        renderDetail(tool);
      })
      .catch(function () {
        loadingState.classList.add("hidden");
        errorState.classList.remove("hidden");
      });

    /* ---------------------------------------------------------------
       Copy schema
    --------------------------------------------------------------- */
    if (copySchemaBtn) {
      copySchemaBtn.addEventListener("click", function () {
        if (!currentTool) return;
        try {
          var formatted = JSON.stringify(JSON.parse(currentTool.schema_json || "{}"), null, 2);
          navigator.clipboard.writeText(formatted).then(function () {
            copySchemaBtn.querySelector("svg").nextSibling && (copySchemaBtn.lastChild.textContent = " Copied!");
            setTimeout(function () {
              if (copySchemaBtn.lastChild) copySchemaBtn.lastChild.textContent = " Copy";
            }, 2000);
          });
        } catch (e) { /* ignore */ }
      });
    }

    /* ---------------------------------------------------------------
       Add to Agent modal
    --------------------------------------------------------------- */
    if (addToAgentBtn) {
      addToAgentBtn.addEventListener("click", function () {
        agentListLoading.classList.remove("hidden");
        agentList.classList.add("hidden");
        agentListEmpty.classList.add("hidden");
        agentAddStatus.classList.add("hidden");
        agentModal.showModal();
        fetchAgents();
      });
    }

    function fetchAgents() {
      fetch("/api/v1/agents")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed");
          return res.json();
        })
        .then(function (body) { return body.data || body; })
        .then(function (agents) {
          agentListLoading.classList.add("hidden");
          if (agents.length === 0) {
            agentListEmpty.classList.remove("hidden");
            return;
          }
          agentList.classList.remove("hidden");
          agentList.innerHTML = "";
          agents.forEach(function (agent) {
            renderAgentRow(agent);
          });
        })
        .catch(function () {
          agentListLoading.classList.add("hidden");
          agentListEmpty.classList.remove("hidden");
          agentListEmpty.textContent = "Failed to load agents.";
        });
    }

    function renderAgentRow(agent) {
      var row = agentRowTemplate.content.cloneNode(true);
      row.querySelector('[data-field="agent-name"]').textContent = agent.name;
      row.querySelector('[data-field="agent-desc"]').textContent = agent.description || "No description";

      var addBtn = row.querySelector('[data-field="add-btn"]');

      // Check if tool is already in agent's tools_json
      var existingTools = [];
      try { existingTools = JSON.parse(agent.tools_json || "[]"); } catch (e) { /* ignore */ }
      if (existingTools.indexOf(currentTool.id) !== -1) {
        addBtn.textContent = "Added";
        addBtn.disabled = true;
        addBtn.classList.add("opacity-50", "cursor-not-allowed");
        addBtn.classList.remove("cursor-pointer", "hover:text-zen-blue/80", "hover:bg-zen-blue/5");
      }

      addBtn.addEventListener("click", function () {
        addToolToAgent(agent, addBtn);
      });

      agentList.appendChild(row);
    }

    function addToolToAgent(agent, btn) {
      var existingTools = [];
      try { existingTools = JSON.parse(agent.tools_json || "[]"); } catch (e) { /* ignore */ }

      if (existingTools.indexOf(currentTool.id) !== -1) {
        showStatus("Tool already added to this agent.", "muted");
        return;
      }

      existingTools.push(currentTool.id);
      btn.textContent = "Adding...";
      btn.disabled = true;

      fetch("/api/v1/agents/" + agent.id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tools_json: JSON.stringify(existingTools) }),
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed"); });
          return res.json();
        })
        .then(function () {
          btn.textContent = "Added";
          btn.classList.add("opacity-50", "cursor-not-allowed");
          btn.classList.remove("cursor-pointer");
          showStatus('Tool added to "' + agent.name + '"!', "zen-green");
        })
        .catch(function (err) {
          btn.textContent = "Add";
          btn.disabled = false;
          showStatus("Error: " + err.message, "coral");
        });
    }

    function showStatus(msg, color) {
      agentAddStatus.textContent = msg;
      agentAddStatus.className = "text-sm text-" + color;
      agentAddStatus.classList.remove("hidden");
      setTimeout(function () {
        agentAddStatus.classList.add("hidden");
      }, 3000);
    }
  })();
</script>
