---
import PageLayout from "../layouts/PageLayout.astro";

const breadcrumbs = [{ label: "Monitoring" }];

/* Icons */
const refreshIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>';
const activityIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>';
const checkCircleIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';
const clockIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';
const hashIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></svg>';
const dollarIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>';
---

<PageLayout
  title="Monitoring"
  description="Monitor agent performance and metrics"
  activeSection="monitoring"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Monitoring</h1>
        <p class="text-sm text-muted mt-1">Aggregate metrics across all agent and workflow runs &middot; <a href="/monitoring/runs" class="text-coral hover:underline">View all runs &rarr;</a></p>
      </div>
      <div class="flex items-center gap-3">
        <!-- Auto-refresh toggle -->
        <label class="flex items-center gap-2 text-sm text-muted cursor-pointer select-none">
          <span class="relative inline-flex">
            <input type="checkbox" id="auto-refresh-toggle" class="sr-only peer" />
            <div class="w-9 h-5 bg-dark/10 peer-checked:bg-coral rounded-full transition-colors duration-200"></div>
            <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full shadow transition-transform duration-200 peer-checked:translate-x-4"></div>
          </span>
          <span id="auto-refresh-label">Auto-refresh</span>
        </label>

        <!-- Time range selector -->
        <div class="flex bg-dark/[0.05] rounded-lg p-0.5 gap-0.5">
          <button data-range="1h" class="range-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors cursor-pointer text-muted hover:text-dark">1h</button>
          <button data-range="24h" class="range-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors cursor-pointer text-muted hover:text-dark">24h</button>
          <button data-range="7d" class="range-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors cursor-pointer bg-white text-dark shadow-sm">7d</button>
          <button data-range="30d" class="range-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors cursor-pointer text-muted hover:text-dark">30d</button>
        </div>

        <!-- Manual refresh -->
        <button id="refresh-btn" class="p-2 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors cursor-pointer" title="Refresh now">
          <span set:html={refreshIcon} />
        </button>
      </div>
    </div>

    <!-- Metric cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
      <div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-2 text-muted">
          <span set:html={activityIcon} />
          <span class="text-xs font-medium uppercase tracking-wide">Total Runs</span>
        </div>
        <p id="metric-total-runs" class="text-2xl font-semibold text-dark tabular-nums">—</p>
      </div>
      <div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-2 text-muted">
          <span set:html={checkCircleIcon} />
          <span class="text-xs font-medium uppercase tracking-wide">Success Rate</span>
        </div>
        <p id="metric-success-rate" class="text-2xl font-semibold text-dark tabular-nums">—</p>
      </div>
      <div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-2 text-muted">
          <span set:html={clockIcon} />
          <span class="text-xs font-medium uppercase tracking-wide">Avg Latency</span>
        </div>
        <p id="metric-avg-latency" class="text-2xl font-semibold text-dark tabular-nums">—</p>
      </div>
      <div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-2 text-muted">
          <span set:html={hashIcon} />
          <span class="text-xs font-medium uppercase tracking-wide">Total Tokens</span>
        </div>
        <p id="metric-total-tokens" class="text-2xl font-semibold text-dark tabular-nums">—</p>
      </div>
      <div class="bg-white rounded-xl border border-dark/[0.06] p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-2 text-muted">
          <span set:html={dollarIcon} />
          <span class="text-xs font-medium uppercase tracking-wide">Total Cost</span>
        </div>
        <p id="metric-total-cost" class="text-2xl font-semibold text-dark tabular-nums">—</p>
      </div>
    </div>

    <!-- Charts grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Runs over time (bar chart) -->
      <div class="bg-white rounded-xl border border-dark/[0.06] p-5 shadow-sm">
        <h3 class="text-sm font-semibold text-dark mb-4">Runs Over Time</h3>
        <div id="chart-runs" class="h-48 flex items-end justify-center">
          <p class="text-sm text-muted">Loading...</p>
        </div>
      </div>
      <!-- Tokens over time (line chart) -->
      <div class="bg-white rounded-xl border border-dark/[0.06] p-5 shadow-sm">
        <h3 class="text-sm font-semibold text-dark mb-4">Tokens Over Time</h3>
        <div id="chart-tokens" class="h-48 flex items-center justify-center">
          <p class="text-sm text-muted">Loading...</p>
        </div>
      </div>
      <!-- Cost over time (line chart) -->
      <div class="bg-white rounded-xl border border-dark/[0.06] p-5 shadow-sm">
        <h3 class="text-sm font-semibold text-dark mb-4">Cost Over Time</h3>
        <div id="chart-cost" class="h-48 flex items-center justify-center">
          <p class="text-sm text-muted">Loading...</p>
        </div>
      </div>
      <!-- Success/failure ratio (donut chart) -->
      <div class="bg-white rounded-xl border border-dark/[0.06] p-5 shadow-sm">
        <h3 class="text-sm font-semibold text-dark mb-4">Success / Failure Ratio</h3>
        <div id="chart-donut" class="h-48 flex items-center justify-center">
          <p class="text-sm text-muted">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Latency distribution (histogram) — full width -->
    <div class="bg-white rounded-xl border border-dark/[0.06] p-5 shadow-sm mb-8">
      <h3 class="text-sm font-semibold text-dark mb-4">Latency Distribution</h3>
      <div id="chart-latency" class="h-48 flex items-end justify-center">
        <p class="text-sm text-muted">Loading...</p>
      </div>
    </div>

    <!-- Per-agent breakdown table -->
    <div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden">
      <div class="px-5 py-4 border-b border-dark/[0.06]">
        <h3 class="text-sm font-semibold text-dark">Per-Agent Breakdown</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-dark/[0.06] text-left">
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide">Agent / Workflow</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">Runs</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">Success Rate</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">Avg Tokens</th>
              <th class="px-5 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">Avg Cost</th>
            </tr>
          </thead>
          <tbody id="agents-table-body">
            <tr><td colspan="5" class="px-5 py-8 text-center text-muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</PageLayout>

<script is:inline>
(function () {
  // ---------------------------------------------------------------------------
  // State
  // ---------------------------------------------------------------------------
  let currentRange = "7d";
  let autoRefreshInterval = null;

  // DOM refs
  const rangeButtons = document.querySelectorAll(".range-btn");
  const refreshBtn = document.getElementById("refresh-btn");
  const autoRefreshToggle = document.getElementById("auto-refresh-toggle");
  const autoRefreshLabel = document.getElementById("auto-refresh-label");

  // ---------------------------------------------------------------------------
  // Formatting helpers
  // ---------------------------------------------------------------------------
  function fmtNumber(n) {
    if (n == null) return "—";
    if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + "M";
    if (n >= 1_000) return (n / 1_000).toFixed(1) + "K";
    return n.toLocaleString();
  }

  function fmtCost(n) {
    if (n == null) return "—";
    return "$" + n.toFixed(4);
  }

  function fmtLatency(ms) {
    if (ms == null || ms === 0) return "—";
    if (ms < 1000) return Math.round(ms) + "ms";
    return (ms / 1000).toFixed(1) + "s";
  }

  function fmtPercent(n) {
    if (n == null) return "—";
    return n.toFixed(1) + "%";
  }

  // ---------------------------------------------------------------------------
  // Data fetching
  // ---------------------------------------------------------------------------
  async function fetchJSON(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error("API error " + res.status);
    return res.json();
  }

  async function loadDashboard() {
    try {
      const data = await fetchJSON("/api/metrics/dashboard?range=" + currentRange);
      document.getElementById("metric-total-runs").textContent = fmtNumber(data.total_runs);
      document.getElementById("metric-success-rate").textContent = fmtPercent(data.success_rate);
      document.getElementById("metric-avg-latency").textContent = fmtLatency(data.avg_latency_ms);
      document.getElementById("metric-total-tokens").textContent = fmtNumber(data.total_tokens);
      document.getElementById("metric-total-cost").textContent = fmtCost(data.total_cost);

      // Donut chart from dashboard success rate
      renderDonut(data.success_rate, data.total_runs);
    } catch (_) {
      document.getElementById("metric-total-runs").textContent = "—";
      document.getElementById("metric-success-rate").textContent = "—";
      document.getElementById("metric-avg-latency").textContent = "—";
      document.getElementById("metric-total-tokens").textContent = "—";
      document.getElementById("metric-total-cost").textContent = "—";
    }
  }

  async function loadAgents() {
    const tbody = document.getElementById("agents-table-body");
    try {
      const data = await fetchJSON("/api/metrics/agents?range=" + currentRange);
      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-5 py-8 text-center text-muted">No data for this time range</td></tr>';
        return;
      }
      tbody.innerHTML = data
        .map(function (a) {
          const href = a.agent_id ? "/workflows/" + encodeURIComponent(a.agent_id) : "#";
          return (
            '<tr class="border-b border-dark/[0.04] hover:bg-dark/[0.02] transition-colors">' +
            '<td class="px-5 py-3"><a href="' + href + '" class="text-coral hover:underline font-medium">' + escapeHtml(a.agent_name) + "</a></td>" +
            '<td class="px-5 py-3 text-right tabular-nums">' + a.run_count + "</td>" +
            '<td class="px-5 py-3 text-right tabular-nums">' + fmtPercent(a.success_rate) + "</td>" +
            '<td class="px-5 py-3 text-right tabular-nums">' + fmtNumber(Math.round(a.avg_tokens)) + "</td>" +
            '<td class="px-5 py-3 text-right tabular-nums">' + fmtCost(a.avg_cost) + "</td>" +
            "</tr>"
          );
        })
        .join("");
    } catch (_) {
      tbody.innerHTML = '<tr><td colspan="5" class="px-5 py-8 text-center text-muted">Failed to load agent data</td></tr>';
    }
  }

  async function loadTimeseries(metric, containerId, chartType) {
    const container = document.getElementById(containerId);
    try {
      const data = await fetchJSON("/api/metrics/timeseries?range=" + currentRange + "&metric=" + metric);
      if (!data.length) {
        container.innerHTML = '<p class="text-sm text-muted">No data for this time range</p>';
        return;
      }
      if (chartType === "bar") {
        renderBarChart(container, data);
      } else if (chartType === "line") {
        renderLineChart(container, data);
      } else if (chartType === "histogram") {
        renderHistogram(container, data);
      }
    } catch (_) {
      container.innerHTML = '<p class="text-sm text-muted">Failed to load chart data</p>';
    }
  }

  function refreshAll() {
    loadDashboard();
    loadAgents();
    loadTimeseries("runs", "chart-runs", "bar");
    loadTimeseries("tokens", "chart-tokens", "line");
    loadTimeseries("cost", "chart-cost", "line");
    loadTimeseries("latency", "chart-latency", "histogram");
  }

  // ---------------------------------------------------------------------------
  // SVG Chart renderers
  // ---------------------------------------------------------------------------
  function escapeHtml(s) {
    var d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML;
  }

  function renderBarChart(container, data) {
    var W = container.clientWidth || 400;
    var H = 192;
    var pad = { top: 10, right: 10, bottom: 24, left: 40 };
    var cW = W - pad.left - pad.right;
    var cH = H - pad.top - pad.bottom;
    var maxVal = Math.max.apply(null, data.map(function (d) { return d.value; })) || 1;
    var barW = Math.max(2, Math.min(24, (cW / data.length) - 2));
    var gap = (cW - barW * data.length) / (data.length + 1);

    var bars = "";
    for (var i = 0; i < data.length; i++) {
      var x = pad.left + gap + i * (barW + gap);
      var h = (data[i].value / maxVal) * cH;
      var y = pad.top + cH - h;
      bars += '<rect x="' + x + '" y="' + y + '" width="' + barW + '" height="' + h + '" rx="2" fill="var(--zen-coral)" opacity="0.85"><title>' + data[i].bucket + ": " + data[i].value + "</title></rect>";
    }

    // Y-axis labels
    var yLabels = "";
    for (var j = 0; j <= 4; j++) {
      var yVal = Math.round((maxVal / 4) * j);
      var yPos = pad.top + cH - (j / 4) * cH;
      yLabels += '<text x="' + (pad.left - 4) + '" y="' + (yPos + 3) + '" text-anchor="end" class="fill-muted" font-size="10">' + fmtNumber(yVal) + "</text>";
      yLabels += '<line x1="' + pad.left + '" y1="' + yPos + '" x2="' + (W - pad.right) + '" y2="' + yPos + '" stroke="var(--zen-dark)" stroke-opacity="0.06" />';
    }

    container.innerHTML = '<svg width="100%" height="' + H + '" viewBox="0 0 ' + W + " " + H + '">' + yLabels + bars + "</svg>";
  }

  function renderLineChart(container, data) {
    var W = container.clientWidth || 400;
    var H = 192;
    var pad = { top: 10, right: 10, bottom: 24, left: 50 };
    var cW = W - pad.left - pad.right;
    var cH = H - pad.top - pad.bottom;
    var maxVal = Math.max.apply(null, data.map(function (d) { return d.value; })) || 1;

    var points = [];
    var circles = "";
    for (var i = 0; i < data.length; i++) {
      var x = pad.left + (i / Math.max(data.length - 1, 1)) * cW;
      var y = pad.top + cH - (data[i].value / maxVal) * cH;
      points.push(x + "," + y);
      circles += '<circle cx="' + x + '" cy="' + y + '" r="3" fill="var(--zen-coral)" stroke="white" stroke-width="1.5"><title>' + data[i].bucket + ": " + data[i].value + "</title></circle>";
    }

    // Fill area
    var areaPoints = pad.left + "," + (pad.top + cH) + " " + points.join(" ") + " " + (pad.left + cW) + "," + (pad.top + cH);

    // Y-axis labels
    var yLabels = "";
    for (var j = 0; j <= 4; j++) {
      var yVal = (maxVal / 4) * j;
      var yPos = pad.top + cH - (j / 4) * cH;
      yLabels += '<text x="' + (pad.left - 4) + '" y="' + (yPos + 3) + '" text-anchor="end" class="fill-muted" font-size="10">' + fmtNumber(Math.round(yVal * 10000) / 10000) + "</text>";
      yLabels += '<line x1="' + pad.left + '" y1="' + yPos + '" x2="' + (W - pad.right) + '" y2="' + yPos + '" stroke="var(--zen-dark)" stroke-opacity="0.06" />';
    }

    container.innerHTML =
      '<svg width="100%" height="' + H + '" viewBox="0 0 ' + W + " " + H + '">' +
      yLabels +
      '<polygon points="' + areaPoints + '" fill="var(--zen-coral)" opacity="0.1" />' +
      '<polyline points="' + points.join(" ") + '" fill="none" stroke="var(--zen-coral)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" />' +
      circles +
      "</svg>";
  }

  function renderHistogram(container, data) {
    // Group latency timeseries into distribution buckets
    var values = data.map(function (d) { return d.value; }).filter(function (v) { return v > 0; });
    if (!values.length) {
      container.innerHTML = '<p class="text-sm text-muted">No latency data</p>';
      return;
    }

    var minV = Math.min.apply(null, values);
    var maxV = Math.max.apply(null, values);
    var bucketCount = Math.min(12, Math.max(4, values.length));
    var step = (maxV - minV) / bucketCount || 1;
    var buckets = [];
    for (var b = 0; b < bucketCount; b++) {
      buckets.push({ lo: minV + b * step, hi: minV + (b + 1) * step, count: 0 });
    }
    for (var i = 0; i < values.length; i++) {
      var idx = Math.min(Math.floor((values[i] - minV) / step), bucketCount - 1);
      buckets[idx].count++;
    }

    var W = container.clientWidth || 600;
    var H = 192;
    var pad = { top: 10, right: 10, bottom: 28, left: 40 };
    var cW = W - pad.left - pad.right;
    var cH = H - pad.top - pad.bottom;
    var maxCount = Math.max.apply(null, buckets.map(function (b) { return b.count; })) || 1;
    var barW = Math.max(4, (cW / buckets.length) - 2);
    var gap = (cW - barW * buckets.length) / (buckets.length + 1);

    var bars = "";
    var xLabels = "";
    for (var j = 0; j < buckets.length; j++) {
      var x = pad.left + gap + j * (barW + gap);
      var h = (buckets[j].count / maxCount) * cH;
      var y = pad.top + cH - h;
      bars += '<rect x="' + x + '" y="' + y + '" width="' + barW + '" height="' + h + '" rx="1" fill="var(--zen-blue)" opacity="0.75"><title>' + fmtLatency(buckets[j].lo) + " – " + fmtLatency(buckets[j].hi) + ": " + buckets[j].count + " runs</title></rect>";
      if (j % 2 === 0 || buckets.length <= 8) {
        xLabels += '<text x="' + (x + barW / 2) + '" y="' + (H - 4) + '" text-anchor="middle" class="fill-muted" font-size="9">' + fmtLatency(buckets[j].lo) + "</text>";
      }
    }

    // Y-axis
    var yLabels = "";
    for (var k = 0; k <= 4; k++) {
      var yVal = Math.round((maxCount / 4) * k);
      var yPos = pad.top + cH - (k / 4) * cH;
      yLabels += '<text x="' + (pad.left - 4) + '" y="' + (yPos + 3) + '" text-anchor="end" class="fill-muted" font-size="10">' + yVal + "</text>";
      yLabels += '<line x1="' + pad.left + '" y1="' + yPos + '" x2="' + (W - pad.right) + '" y2="' + yPos + '" stroke="var(--zen-dark)" stroke-opacity="0.06" />';
    }

    container.innerHTML = '<svg width="100%" height="' + H + '" viewBox="0 0 ' + W + " " + H + '">' + yLabels + bars + xLabels + "</svg>";
  }

  function renderDonut(successRate, totalRuns) {
    var container = document.getElementById("chart-donut");
    if (totalRuns === 0) {
      container.innerHTML = '<p class="text-sm text-muted">No runs in this time range</p>';
      return;
    }

    var R = 70;
    var r = 50;
    var cx = 90;
    var cy = 90;
    var successFrac = successRate / 100;
    var failFrac = 1 - successFrac;

    // SVG arc helper
    function arc(startAngle, endAngle, radius) {
      var s = startAngle - Math.PI / 2;
      var e = endAngle - Math.PI / 2;
      var x1 = cx + radius * Math.cos(s);
      var y1 = cy + radius * Math.sin(s);
      var x2 = cx + radius * Math.cos(e);
      var y2 = cy + radius * Math.sin(e);
      var largeArc = endAngle - startAngle > Math.PI ? 1 : 0;
      return "M " + x1 + " " + y1 + " A " + radius + " " + radius + " 0 " + largeArc + " 1 " + x2 + " " + y2;
    }

    function donutSlice(startAngle, endAngle, outerR, innerR) {
      var s = startAngle - Math.PI / 2;
      var e = endAngle - Math.PI / 2;
      var x1 = cx + outerR * Math.cos(s);
      var y1 = cy + outerR * Math.sin(s);
      var x2 = cx + outerR * Math.cos(e);
      var y2 = cy + outerR * Math.sin(e);
      var x3 = cx + innerR * Math.cos(e);
      var y3 = cy + innerR * Math.sin(e);
      var x4 = cx + innerR * Math.cos(s);
      var y4 = cy + innerR * Math.sin(s);
      var largeArc = endAngle - startAngle > Math.PI ? 1 : 0;
      return (
        "M " + x1 + " " + y1 +
        " A " + outerR + " " + outerR + " 0 " + largeArc + " 1 " + x2 + " " + y2 +
        " L " + x3 + " " + y3 +
        " A " + innerR + " " + innerR + " 0 " + largeArc + " 0 " + x4 + " " + y4 +
        " Z"
      );
    }

    var paths = "";
    if (successFrac >= 1) {
      paths = '<circle cx="' + cx + '" cy="' + cy + '" r="' + R + '" fill="none" stroke="var(--zen-green)" stroke-width="' + (R - r) + '" />';
    } else if (successFrac <= 0) {
      paths = '<circle cx="' + cx + '" cy="' + cy + '" r="' + R + '" fill="none" stroke="var(--zen-coral)" stroke-width="' + (R - r) + '" />';
    } else {
      var successEnd = successFrac * 2 * Math.PI;
      paths =
        '<path d="' + donutSlice(0, successEnd, R, r) + '" fill="var(--zen-green)" opacity="0.85"><title>Success: ' + fmtPercent(successRate) + "</title></path>" +
        '<path d="' + donutSlice(successEnd, 2 * Math.PI, R, r) + '" fill="var(--zen-coral)" opacity="0.7"><title>Failure: ' + fmtPercent(100 - successRate) + "</title></path>";
    }

    // Center text
    var centerText =
      '<text x="' + cx + '" y="' + (cy - 4) + '" text-anchor="middle" class="fill-dark" font-size="18" font-weight="600">' + fmtPercent(successRate) + "</text>" +
      '<text x="' + cx + '" y="' + (cy + 14) + '" text-anchor="middle" class="fill-muted" font-size="11">success</text>';

    // Legend
    var legend =
      '<g transform="translate(190, 60)">' +
      '<rect x="0" y="0" width="10" height="10" rx="2" fill="var(--zen-green)" opacity="0.85" />' +
      '<text x="16" y="9" class="fill-dark" font-size="12">Success (' + Math.round(totalRuns * successFrac) + ")</text>" +
      '<rect x="0" y="20" width="10" height="10" rx="2" fill="var(--zen-coral)" opacity="0.7" />' +
      '<text x="16" y="29" class="fill-dark" font-size="12">Failure (' + Math.round(totalRuns * failFrac) + ")</text>" +
      "</g>";

    container.innerHTML = '<svg width="100%" height="180" viewBox="0 0 320 180">' + paths + centerText + legend + "</svg>";
  }

  // ---------------------------------------------------------------------------
  // Event handlers
  // ---------------------------------------------------------------------------
  rangeButtons.forEach(function (btn) {
    btn.addEventListener("click", function () {
      currentRange = btn.getAttribute("data-range");
      rangeButtons.forEach(function (b) {
        b.classList.remove("bg-white", "text-dark", "shadow-sm");
        b.classList.add("text-muted");
      });
      btn.classList.add("bg-white", "text-dark", "shadow-sm");
      btn.classList.remove("text-muted");
      refreshAll();
    });
  });

  refreshBtn.addEventListener("click", function () {
    refreshBtn.classList.add("animate-spin");
    refreshAll();
    setTimeout(function () { refreshBtn.classList.remove("animate-spin"); }, 600);
  });

  autoRefreshToggle.addEventListener("change", function () {
    if (autoRefreshToggle.checked) {
      autoRefreshLabel.textContent = "Auto-refresh (30s)";
      autoRefreshInterval = setInterval(refreshAll, 30000);
    } else {
      autoRefreshLabel.textContent = "Auto-refresh";
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }
  });

  // Initial load
  refreshAll();
})();
</script>
