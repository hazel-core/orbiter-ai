---
import PageLayout from "../layouts/PageLayout.astro";

const breadcrumbs = [{ label: "Benchmarks" }];

/* Icons */
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const playIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
const trashIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
const emptyIcon = '<svg class="h-12 w-12 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>';
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const downloadIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
---

<PageLayout
  title="Benchmarks"
  description="Compare agents against the same evaluation suite"
  activeSection="benchmarks"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-7xl mx-auto">
    <!-- ============= LIST VIEW ============= -->
    <div id="list-view">
      <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
        <div>
          <h1 class="text-2xl font-semibold text-dark">Benchmarks</h1>
          <p class="text-sm text-muted mt-1">Compare multiple agents against the same evaluation suite</p>
        </div>
        <button id="create-btn" class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg bg-coral text-white hover:bg-coral/90 transition-colors cursor-pointer">
          <span set:html={plusIcon} />
          New Benchmark
        </button>
      </div>

      <div id="bench-list" class="flex flex-col gap-3"></div>

      <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
        <div class="mb-4" set:html={emptyIcon} />
        <h2 class="text-lg font-semibold text-dark mb-2">No benchmarks yet</h2>
        <p class="text-sm text-muted mb-6 max-w-sm">
          Create a benchmark to compare multiple agents against the same evaluation suite.
        </p>
        <button id="empty-create-btn" class="inline-flex items-center gap-1.5 px-4 py-2.5 text-sm font-medium rounded-lg bg-coral text-white hover:bg-coral/90 transition-colors cursor-pointer">
          <span set:html={plusIcon} />
          Create your first benchmark
        </button>
      </div>
    </div>

    <!-- ============= DETAIL VIEW ============= -->
    <div id="detail-view" class="hidden">
      <div class="flex items-center gap-3 mb-6 flex-wrap">
        <button id="back-btn" class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors cursor-pointer">
          <span set:html={backIcon} />
          Back
        </button>
        <div class="flex-1 min-w-0">
          <h1 id="detail-name" class="text-xl font-semibold text-dark truncate"></h1>
          <p id="detail-desc" class="text-sm text-muted truncate"></p>
        </div>
        <button id="run-btn" class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium rounded-lg bg-zen-green text-dark hover:bg-zen-green/80 transition-colors cursor-pointer">
          <span set:html={playIcon} />
          Run Benchmark
        </button>
        <button id="delete-bench-btn" class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg border border-coral/30 text-coral hover:bg-coral/5 transition-colors cursor-pointer">
          <span set:html={trashIcon} />
          Delete
        </button>
      </div>

      <!-- Running indicator -->
      <div id="running-indicator" class="hidden mb-4 rounded-xl border border-zen-blue/20 bg-zen-blue/5 px-5 py-3">
        <div class="flex items-center gap-3">
          <div class="h-4 w-4 border-2 border-zen-blue border-t-transparent rounded-full animate-spin"></div>
          <p class="text-sm font-medium text-zen-blue">Running benchmark... This may take a while.</p>
        </div>
      </div>

      <!-- Tab switcher -->
      <div class="flex gap-1 mb-6 bg-dark/[0.03] rounded-lg p-1 w-fit">
        <button class="tab-btn px-4 py-1.5 text-sm font-medium rounded-md transition-colors" data-tab="leaderboard">Leaderboard</button>
        <button class="tab-btn px-4 py-1.5 text-sm font-medium rounded-md transition-colors" data-tab="comparison">Comparison</button>
        <button class="tab-btn px-4 py-1.5 text-sm font-medium rounded-md transition-colors" data-tab="charts">Charts</button>
      </div>

      <!-- Leaderboard tab -->
      <div id="tab-leaderboard" class="tab-content">
        <div id="leaderboard-empty" class="hidden text-center py-12 text-muted text-sm">
          Run a benchmark to see the leaderboard.
        </div>
        <div id="leaderboard-table-wrap" class="hidden overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-dark/[0.08]">
                <th class="text-left py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Rank</th>
                <th class="text-left py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Agent</th>
                <th class="text-center py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Best Score</th>
                <th class="text-center py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Avg Score</th>
                <th class="text-center py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Pass Rate</th>
                <th class="text-center py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Avg Latency</th>
                <th class="text-center py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Runs</th>
              </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Comparison tab -->
      <div id="tab-comparison" class="tab-content hidden">
        <div id="comparison-empty" class="hidden text-center py-12 text-muted text-sm">
          Run a benchmark to see the comparison table.
        </div>
        <div id="comparison-controls" class="hidden flex items-center gap-3 mb-4">
          <label class="text-sm text-muted">Run:</label>
          <select id="run-select" class="text-sm border border-dark/[0.08] rounded-lg px-3 py-1.5 bg-paper text-dark"></select>
          <div class="flex-1"></div>
          <button id="export-csv-btn" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors cursor-pointer">
            <span set:html={downloadIcon} />
            CSV
          </button>
          <button id="export-json-btn" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors cursor-pointer">
            <span set:html={downloadIcon} />
            JSON
          </button>
        </div>
        <div id="comparison-table-wrap" class="hidden overflow-x-auto">
          <table id="comparison-table" class="w-full text-sm">
            <thead id="comparison-head"></thead>
            <tbody id="comparison-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Charts tab -->
      <div id="tab-charts" class="tab-content hidden">
        <div id="charts-empty" class="hidden text-center py-12 text-muted text-sm">
          Run a benchmark to see charts.
        </div>
        <div id="charts-content" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-paper border border-dark/[0.08] rounded-xl p-4">
            <h3 class="text-sm font-semibold text-dark mb-3">Score Comparison</h3>
            <div id="score-chart" class="w-full" style="height: 260px;"></div>
          </div>
          <div class="bg-paper border border-dark/[0.08] rounded-xl p-4">
            <h3 class="text-sm font-semibold text-dark mb-3">Latency Comparison</h3>
            <div id="latency-chart" class="w-full" style="height: 260px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============= CREATE DIALOG ============= -->
  <dialog
    id="create-dialog"
    class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-lg w-full"
  >
    <form method="dialog" class="p-6">
      <h2 class="text-lg font-semibold text-dark mb-4">New Benchmark</h2>
      <div class="flex flex-col gap-4">
        <div>
          <label class="block text-sm font-medium text-dark mb-1">Name</label>
          <input id="create-name" type="text" placeholder="e.g. GPT vs Claude comparison" required
            class="w-full px-3 py-2 text-sm border border-dark/[0.08] rounded-lg bg-paper text-dark placeholder:text-muted/50 focus:outline-none focus:ring-2 focus:ring-coral/30" />
        </div>
        <div>
          <label class="block text-sm font-medium text-dark mb-1">Description</label>
          <input id="create-desc" type="text" placeholder="Optional description"
            class="w-full px-3 py-2 text-sm border border-dark/[0.08] rounded-lg bg-paper text-dark placeholder:text-muted/50 focus:outline-none focus:ring-2 focus:ring-coral/30" />
        </div>
        <div>
          <label class="block text-sm font-medium text-dark mb-1">Evaluation Suite</label>
          <select id="create-eval" required
            class="w-full px-3 py-2 text-sm border border-dark/[0.08] rounded-lg bg-paper text-dark focus:outline-none focus:ring-2 focus:ring-coral/30">
            <option value="">Select an evaluation...</option>
          </select>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-6">
        <button type="button" id="cancel-create-btn" class="px-4 py-2 text-sm font-medium text-muted hover:text-dark transition-colors cursor-pointer">Cancel</button>
        <button type="submit" id="submit-create-btn" class="px-4 py-2 text-sm font-medium rounded-lg bg-coral text-white hover:bg-coral/90 transition-colors cursor-pointer">Create</button>
      </div>
    </form>
  </dialog>

  <!-- ============= RUN DIALOG (select agents) ============= -->
  <dialog
    id="run-dialog"
    class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-lg w-full"
  >
    <form method="dialog" class="p-6">
      <h2 class="text-lg font-semibold text-dark mb-2">Select Agents to Benchmark</h2>
      <p class="text-sm text-muted mb-4">Choose 2 or more agents to compare.</p>
      <div id="agent-checkboxes" class="flex flex-col gap-2 max-h-60 overflow-y-auto mb-4"></div>
      <div class="flex justify-end gap-3">
        <button type="button" id="cancel-run-btn" class="px-4 py-2 text-sm font-medium text-muted hover:text-dark transition-colors cursor-pointer">Cancel</button>
        <button type="submit" id="submit-run-btn" class="px-4 py-2 text-sm font-medium rounded-lg bg-zen-green text-dark hover:bg-zen-green/80 transition-colors cursor-pointer">Run Benchmark</button>
      </div>
    </form>
  </dialog>

  <!-- ============= DELETE DIALOG ============= -->
  <dialog
    id="delete-dialog"
    class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-sm w-full"
  >
    <div class="p-6">
      <h2 class="text-lg font-semibold text-dark mb-2">Delete Benchmark</h2>
      <p class="text-sm text-muted mb-6">This will permanently delete this benchmark and all its runs. This action cannot be undone.</p>
      <div class="flex justify-end gap-3">
        <button id="cancel-delete-btn" class="px-4 py-2 text-sm font-medium text-muted hover:text-dark transition-colors cursor-pointer">Cancel</button>
        <button id="confirm-delete-btn" class="px-4 py-2 text-sm font-medium rounded-lg bg-coral text-white hover:bg-coral/90 transition-colors cursor-pointer">Delete</button>
      </div>
    </div>
  </dialog>

  <script is:inline>
    /* ------- State ------- */
    var benchmarks = [];
    var currentBench = null;
    var currentRuns = [];
    var currentResults = []; // results for selected run
    var leaderboard = [];
    var agents = {};
    var evaluations = {};
    var activeTab = "leaderboard";

    /* Chart colors */
    var COLORS = [
      "#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4",
      "#FFEAA7", "#DDA0DD", "#98D8C8", "#F7DC6F",
    ];

    /* ------- DOM refs ------- */
    var listView = document.getElementById("list-view");
    var detailView = document.getElementById("detail-view");
    var benchList = document.getElementById("bench-list");
    var emptyState = document.getElementById("empty-state");
    var createDialog = document.getElementById("create-dialog");
    var runDialog = document.getElementById("run-dialog");
    var deleteDialog = document.getElementById("delete-dialog");
    var runningIndicator = document.getElementById("running-indicator");

    /* ------- API helpers ------- */
    function api(url, opts) {
      return fetch(url, opts).then(function (r) {
        if (!r.ok) throw new Error("API error " + r.status);
        if (r.status === 204) return null;
        return r.json();
      });
    }

    /* ------- Init ------- */
    async function init() {
      var [agentBody, evalBody] = await Promise.all([
        api("/api/agents?limit=100"),
        api("/api/evaluations?limit=100"),
      ]);
      (agentBody.data || []).forEach(function (a) { agents[a.id] = a.name; });
      (evalBody.data || []).forEach(function (e) { evaluations[e.id] = e.name; });
      await loadBenchmarks();
    }

    async function loadBenchmarks() {
      var body = await api("/api/benchmarks?limit=100");
      benchmarks = body.data || [];
      renderList();
    }

    /* ------- List rendering ------- */
    function renderList() {
      benchList.innerHTML = "";
      if (!benchmarks.length) {
        emptyState.classList.remove("hidden");
        return;
      }
      emptyState.classList.add("hidden");
      benchmarks.forEach(function (b) {
        var card = document.createElement("div");
        card.className = "bg-paper border border-dark/[0.08] rounded-xl p-4 hover:border-dark/[0.16] transition-colors cursor-pointer";
        card.innerHTML =
          '<div class="flex items-center justify-between">' +
            '<div class="min-w-0">' +
              '<h3 class="text-sm font-semibold text-dark truncate">' + esc(b.name) + '</h3>' +
              '<p class="text-xs text-muted mt-0.5">' + esc(evaluations[b.evaluation_id] || "Unknown evaluation") + '</p>' +
            '</div>' +
            '<span class="text-xs text-muted shrink-0 ml-3">' + timeAgo(b.created_at) + '</span>' +
          '</div>';
        card.addEventListener("click", function () { openDetail(b); });
        benchList.appendChild(card);
      });
    }

    /* ------- Detail view ------- */
    async function openDetail(bench) {
      currentBench = bench;
      listView.classList.add("hidden");
      detailView.classList.remove("hidden");
      document.getElementById("detail-name").textContent = bench.name;
      document.getElementById("detail-desc").textContent = bench.description || "No description";

      // Load runs + leaderboard
      var [runs, lb] = await Promise.all([
        api("/api/benchmarks/" + bench.id + "/runs"),
        api("/api/benchmarks/" + bench.id + "/leaderboard"),
      ]);
      currentRuns = runs;
      leaderboard = lb;

      // Populate run selector
      var sel = document.getElementById("run-select");
      sel.innerHTML = "";
      currentRuns.forEach(function (r) {
        var opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = r.completed_at || r.created_at;
        sel.appendChild(opt);
      });

      // Load results for latest run
      if (currentRuns.length > 0) {
        await loadRunResults(currentRuns[0].id);
      } else {
        currentResults = [];
      }

      switchTab(activeTab);
    }

    async function loadRunResults(runId) {
      if (!currentBench) return;
      currentResults = await api("/api/benchmarks/" + currentBench.id + "/runs/" + runId + "/results");
    }

    function closeDetail() {
      detailView.classList.add("hidden");
      listView.classList.remove("hidden");
      currentBench = null;
      currentRuns = [];
      currentResults = [];
      leaderboard = [];
    }

    /* ------- Tabs ------- */
    function switchTab(tab) {
      activeTab = tab;
      document.querySelectorAll(".tab-btn").forEach(function (btn) {
        var isActive = btn.getAttribute("data-tab") === tab;
        btn.classList.toggle("bg-paper", isActive);
        btn.classList.toggle("shadow-sm", isActive);
        btn.classList.toggle("text-dark", isActive);
        btn.classList.toggle("text-muted", !isActive);
      });
      document.querySelectorAll(".tab-content").forEach(function (el) {
        el.classList.add("hidden");
      });
      document.getElementById("tab-" + tab).classList.remove("hidden");

      if (tab === "leaderboard") renderLeaderboard();
      else if (tab === "comparison") renderComparison();
      else if (tab === "charts") renderCharts();
    }

    /* ------- Leaderboard ------- */
    function renderLeaderboard() {
      var empty = document.getElementById("leaderboard-empty");
      var wrap = document.getElementById("leaderboard-table-wrap");
      if (!leaderboard.length) {
        empty.classList.remove("hidden");
        wrap.classList.add("hidden");
        return;
      }
      empty.classList.add("hidden");
      wrap.classList.remove("hidden");

      var body = document.getElementById("leaderboard-body");
      body.innerHTML = "";
      leaderboard.forEach(function (entry) {
        var tr = document.createElement("tr");
        tr.className = "border-b border-dark/[0.06]";
        var rankBadge = entry.rank === 1
          ? '<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-amber-100 text-amber-700 text-xs font-bold">1</span>'
          : entry.rank === 2
          ? '<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 text-slate-600 text-xs font-bold">2</span>'
          : entry.rank === 3
          ? '<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-orange-100 text-orange-600 text-xs font-bold">3</span>'
          : '<span class="text-xs text-muted">' + entry.rank + '</span>';

        tr.innerHTML =
          '<td class="py-2.5 px-3">' + rankBadge + '</td>' +
          '<td class="py-2.5 px-3 font-medium text-dark">' + esc(entry.agent_name) + '</td>' +
          '<td class="py-2.5 px-3 text-center">' + scoreBadge(entry.best_score) + '</td>' +
          '<td class="py-2.5 px-3 text-center text-muted">' + pct(entry.avg_score) + '</td>' +
          '<td class="py-2.5 px-3 text-center text-muted">' + pct(entry.best_pass_rate) + '</td>' +
          '<td class="py-2.5 px-3 text-center text-muted">' + Math.round(entry.avg_latency_ms) + 'ms</td>' +
          '<td class="py-2.5 px-3 text-center text-muted">' + entry.run_count + '</td>';
        body.appendChild(tr);
      });
    }

    /* ------- Comparison table ------- */
    function renderComparison() {
      var empty = document.getElementById("comparison-empty");
      var controls = document.getElementById("comparison-controls");
      var wrap = document.getElementById("comparison-table-wrap");

      if (!currentResults.length) {
        empty.classList.remove("hidden");
        controls.classList.add("hidden");
        wrap.classList.add("hidden");
        return;
      }
      empty.classList.add("hidden");
      controls.classList.remove("hidden");
      wrap.classList.remove("hidden");

      // Build header: Test Case | Agent1 | Agent2 | ...
      var head = document.getElementById("comparison-head");
      var hRow = '<tr class="border-b border-dark/[0.08]">';
      hRow += '<th class="text-left py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Test Case</th>';
      currentResults.forEach(function (r) {
        hRow += '<th class="text-center py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">' + esc(r.agent_name) + '</th>';
      });
      hRow += '</tr>';
      head.innerHTML = hRow;

      // Parse results per agent
      var agentResults = currentResults.map(function (r) {
        return JSON.parse(r.results_json || "[]");
      });

      // Build rows (one per test case)
      var body = document.getElementById("comparison-body");
      body.innerHTML = "";
      var numCases = agentResults.length > 0 ? agentResults[0].length : 0;

      for (var i = 0; i < numCases; i++) {
        var tr = document.createElement("tr");
        tr.className = "border-b border-dark/[0.06]";
        var input = agentResults[0][i] ? agentResults[0][i].input : "";
        var rowHtml = '<td class="py-2 px-3 text-dark max-w-[200px] truncate" title="' + esc(input) + '">' + esc(truncate(input, 60)) + '</td>';

        for (var j = 0; j < agentResults.length; j++) {
          var tc = agentResults[j][i];
          if (tc) {
            rowHtml += '<td class="py-2 px-3 text-center">' + scoreBadge(tc.score) + '</td>';
          } else {
            rowHtml += '<td class="py-2 px-3 text-center text-muted">-</td>';
          }
        }
        tr.innerHTML = rowHtml;
        body.appendChild(tr);
      }

      // Summary row
      var sumTr = document.createElement("tr");
      sumTr.className = "border-t-2 border-dark/[0.12] font-semibold";
      var sumHtml = '<td class="py-2.5 px-3 text-dark">Overall</td>';
      currentResults.forEach(function (r) {
        sumHtml += '<td class="py-2.5 px-3 text-center">' + scoreBadge(r.overall_score) + '</td>';
      });
      sumTr.innerHTML = sumHtml;
      body.appendChild(sumTr);
    }

    /* ------- Charts (SVG) ------- */
    function renderCharts() {
      var empty = document.getElementById("charts-empty");
      var content = document.getElementById("charts-content");

      if (!currentResults.length) {
        empty.classList.remove("hidden");
        content.classList.add("hidden");
        return;
      }
      empty.classList.add("hidden");
      content.classList.remove("hidden");

      renderBarChart("score-chart", currentResults.map(function (r) {
        return { label: r.agent_name, value: r.overall_score };
      }), "Score", 1.0);

      renderBarChart("latency-chart", currentResults.map(function (r) {
        return { label: r.agent_name, value: r.avg_latency_ms };
      }), "ms", null);
    }

    function renderBarChart(containerId, data, unit, maxOverride) {
      var container = document.getElementById(containerId);
      var W = container.clientWidth || 500;
      var H = 260;
      var pad = { top: 20, right: 20, bottom: 50, left: 50 };
      var chartW = W - pad.left - pad.right;
      var chartH = H - pad.top - pad.bottom;

      var maxVal = maxOverride || Math.max.apply(null, data.map(function (d) { return d.value; })) * 1.1;
      if (maxVal === 0) maxVal = 1;

      var barW = Math.min(60, (chartW / data.length) * 0.6);
      var gap = (chartW - barW * data.length) / (data.length + 1);

      var svg = '<svg viewBox="0 0 ' + W + ' ' + H + '" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">';

      // Grid lines
      for (var i = 0; i <= 4; i++) {
        var y = pad.top + chartH - (chartH * i / 4);
        var val = (maxVal * i / 4);
        svg += '<line x1="' + pad.left + '" y1="' + y + '" x2="' + (W - pad.right) + '" y2="' + y + '" stroke="currentColor" stroke-opacity="0.08" />';
        svg += '<text x="' + (pad.left - 8) + '" y="' + (y + 4) + '" text-anchor="end" fill="currentColor" opacity="0.4" font-size="10">';
        if (unit === "Score") svg += pct(val);
        else svg += Math.round(val);
        svg += '</text>';
      }

      // Bars
      data.forEach(function (d, idx) {
        var x = pad.left + gap + idx * (barW + gap);
        var barH = (d.value / maxVal) * chartH;
        var y = pad.top + chartH - barH;
        var color = COLORS[idx % COLORS.length];

        svg += '<rect x="' + x + '" y="' + y + '" width="' + barW + '" height="' + barH + '" rx="4" fill="' + color + '" opacity="0.85" />';

        // Value label
        var label = unit === "Score" ? pct(d.value) : Math.round(d.value) + "ms";
        svg += '<text x="' + (x + barW / 2) + '" y="' + (y - 6) + '" text-anchor="middle" fill="currentColor" opacity="0.7" font-size="11" font-weight="600">' + label + '</text>';

        // X axis label
        var name = truncate(d.label, 12);
        svg += '<text x="' + (x + barW / 2) + '" y="' + (H - 10) + '" text-anchor="middle" fill="currentColor" opacity="0.5" font-size="10">' + esc(name) + '</text>';
      });

      svg += '</svg>';
      container.innerHTML = svg;
    }

    /* ------- Create benchmark ------- */
    function openCreateDialog() {
      var sel = document.getElementById("create-eval");
      sel.innerHTML = '<option value="">Select an evaluation...</option>';
      Object.keys(evaluations).forEach(function (id) {
        var opt = document.createElement("option");
        opt.value = id;
        opt.textContent = evaluations[id];
        sel.appendChild(opt);
      });
      document.getElementById("create-name").value = "";
      document.getElementById("create-desc").value = "";
      createDialog.showModal();
    }

    async function handleCreate() {
      var name = document.getElementById("create-name").value.trim();
      var desc = document.getElementById("create-desc").value.trim();
      var evalId = document.getElementById("create-eval").value;
      if (!name || !evalId) return;

      await api("/api/benchmarks", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name, description: desc, evaluation_id: evalId }),
      });
      await loadBenchmarks();
    }

    /* ------- Run benchmark ------- */
    function openRunDialog() {
      var wrap = document.getElementById("agent-checkboxes");
      wrap.innerHTML = "";
      Object.keys(agents).forEach(function (id) {
        var label = document.createElement("label");
        label.className = "flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-dark/[0.03] cursor-pointer";
        label.innerHTML =
          '<input type="checkbox" value="' + id + '" class="agent-cb rounded border-dark/20 text-coral focus:ring-coral/30" />' +
          '<span class="text-sm text-dark">' + esc(agents[id]) + '</span>';
        wrap.appendChild(label);
      });
      runDialog.showModal();
    }

    async function handleRun() {
      var checked = Array.from(document.querySelectorAll(".agent-cb:checked"));
      var agentIds = checked.map(function (cb) { return cb.value; });
      if (agentIds.length < 2) {
        alert("Please select at least 2 agents.");
        return;
      }
      runDialog.close();
      runningIndicator.classList.remove("hidden");

      try {
        await api("/api/benchmarks/" + currentBench.id + "/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ agent_ids: agentIds }),
        });
        // Refresh data
        await openDetail(currentBench);
      } finally {
        runningIndicator.classList.add("hidden");
      }
    }

    /* ------- Delete ------- */
    async function handleDelete() {
      if (!currentBench) return;
      await api("/api/benchmarks/" + currentBench.id, { method: "DELETE" });
      deleteDialog.close();
      closeDetail();
      await loadBenchmarks();
    }

    /* ------- Export ------- */
    function exportResults(fmt) {
      if (!currentBench || !currentRuns.length) return;
      var sel = document.getElementById("run-select");
      var runId = sel.value;
      if (!runId) return;
      window.open("/api/benchmarks/" + currentBench.id + "/runs/" + runId + "/export?fmt=" + fmt, "_blank");
    }

    /* ------- Utility ------- */
    function esc(s) {
      var d = document.createElement("div");
      d.textContent = s || "";
      return d.innerHTML;
    }

    function pct(v) { return Math.round((v || 0) * 100) + "%"; }

    function truncate(s, n) {
      return s && s.length > n ? s.slice(0, n) + "..." : s || "";
    }

    function scoreBadge(score) {
      var pctVal = Math.round(score * 100);
      var cls = score >= 0.8 ? "bg-zen-green/20 text-zen-green"
              : score >= 0.5 ? "bg-amber-100 text-amber-700"
              : "bg-coral/15 text-coral";
      return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ' + cls + '">' + pctVal + '%</span>';
    }

    function timeAgo(dateStr) {
      if (!dateStr) return "";
      var d = new Date(dateStr + "Z");
      var diff = (Date.now() - d.getTime()) / 1000;
      if (diff < 60) return "just now";
      if (diff < 3600) return Math.floor(diff / 60) + "m ago";
      if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
      return Math.floor(diff / 86400) + "d ago";
    }

    /* ------- Event listeners ------- */
    document.getElementById("create-btn").addEventListener("click", openCreateDialog);
    document.getElementById("empty-create-btn").addEventListener("click", openCreateDialog);
    document.getElementById("cancel-create-btn").addEventListener("click", function () { createDialog.close(); });
    createDialog.addEventListener("close", function () {
      if (createDialog.returnValue !== "") handleCreate();
    });

    document.getElementById("back-btn").addEventListener("click", closeDetail);
    document.getElementById("run-btn").addEventListener("click", openRunDialog);
    document.getElementById("cancel-run-btn").addEventListener("click", function () { runDialog.close(); });
    runDialog.addEventListener("close", function () {
      if (runDialog.returnValue !== "") handleRun();
    });

    document.getElementById("delete-bench-btn").addEventListener("click", function () { deleteDialog.showModal(); });
    document.getElementById("cancel-delete-btn").addEventListener("click", function () { deleteDialog.close(); });
    document.getElementById("confirm-delete-btn").addEventListener("click", handleDelete);

    document.querySelectorAll(".tab-btn").forEach(function (btn) {
      btn.addEventListener("click", function () { switchTab(btn.getAttribute("data-tab")); });
    });

    document.getElementById("run-select").addEventListener("change", async function () {
      var runId = this.value;
      if (runId && currentBench) {
        await loadRunResults(runId);
        renderComparison();
        renderCharts();
      }
    });

    document.getElementById("export-csv-btn").addEventListener("click", function () { exportResults("csv"); });
    document.getElementById("export-json-btn").addEventListener("click", function () { exportResults("json"); });

    // Close dialogs on backdrop click
    [createDialog, runDialog, deleteDialog].forEach(function (dialog) {
      dialog.addEventListener("click", function (e) {
        if (e.target === dialog) dialog.close();
      });
    });

    init();
  </script>
</PageLayout>
