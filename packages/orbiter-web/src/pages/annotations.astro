---
import PageLayout from "../layouts/PageLayout.astro";

const breadcrumbs = [{ label: "Annotations" }];

/* Icons */
const searchIcon = '<svg class="h-4 w-4 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const uploadIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>';
const emptyIcon = '<svg class="h-12 w-12 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
const dollarIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>';
const hashIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></svg>';
---

<PageLayout
  title="Annotations"
  description="Manage cached Q&A annotations"
  activeSection="annotations"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Stats cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="bg-paper border border-dark/[0.08] rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="p-2 rounded-lg bg-zen-blue/10 text-zen-blue">
            <span set:html={hashIcon} />
          </div>
          <div>
            <p class="text-xs text-muted">Total Annotations</p>
            <p id="stat-total" class="text-xl font-semibold text-dark">0</p>
          </div>
        </div>
      </div>
      <div class="bg-paper border border-dark/[0.08] rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="p-2 rounded-lg bg-zen-green/10 text-zen-green">
            <span set:html={hashIcon} />
          </div>
          <div>
            <p class="text-xs text-muted">Total Matches</p>
            <p id="stat-matches" class="text-xl font-semibold text-dark">0</p>
          </div>
        </div>
      </div>
      <div class="bg-paper border border-dark/[0.08] rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="p-2 rounded-lg bg-coral/10 text-coral">
            <span set:html={dollarIcon} />
          </div>
          <div>
            <p class="text-xs text-muted">Cost Saved vs LLM Calls</p>
            <p id="stat-cost" class="text-xl font-semibold text-dark">$0.00</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Annotations</h1>
        <p class="text-sm text-muted mt-1">Cached Q&A pairs served instead of LLM calls</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="import-btn" class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors cursor-pointer">
          <span set:html={uploadIcon} />
          Import CSV
        </button>
        <button id="create-btn" class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg bg-coral text-white hover:bg-coral/90 transition-colors cursor-pointer">
          <span set:html={plusIcon} />
          New Annotation
        </button>
      </div>
    </div>

    <!-- Search + Threshold -->
    <div class="flex items-center gap-4 mb-6 flex-wrap">
      <div class="relative flex-1 min-w-[200px] max-w-sm">
        <span class="absolute left-3 top-1/2 -translate-y-1/2" set:html={searchIcon} />
        <input
          type="text"
          id="search-input"
          placeholder="Search annotations..."
          class="w-full bg-paper border border-dark/[0.08] rounded-lg pl-9 pr-3 py-2 text-sm text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
        />
      </div>
      <div class="flex items-center gap-2">
        <label class="text-xs font-medium text-muted whitespace-nowrap">Match Threshold</label>
        <input
          type="range"
          id="threshold-slider"
          min="0"
          max="100"
          value="80"
          class="w-32 h-1.5 accent-coral cursor-pointer"
        />
        <span id="threshold-value" class="text-xs font-mono text-dark w-8">0.80</span>
      </div>
    </div>

    <!-- Annotations list -->
    <div id="annotations-list" class="flex flex-col gap-3"></div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <div class="mb-4" set:html={emptyIcon} />
      <h2 class="text-lg font-semibold text-dark mb-2">No annotations yet</h2>
      <p class="text-sm text-muted mb-6 max-w-sm">
        Annotations let you cache Q&A pairs to serve instead of LLM calls, saving time and cost.
      </p>
    </div>
  </div>

  <!-- Create/Edit dialog -->
  <dialog
    id="annotation-dialog"
    class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-lg w-full"
  >
    <div class="p-6">
      <h3 id="dialog-title" class="text-base font-medium text-dark mb-4">New Annotation</h3>
      <input type="hidden" id="edit-id" />
      <div class="space-y-3">
        <div>
          <label class="block text-xs font-medium text-muted mb-1">Query *</label>
          <textarea
            id="field-query"
            rows="2"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-y"
            placeholder="The user's question..."
          ></textarea>
        </div>
        <div>
          <label class="block text-xs font-medium text-muted mb-1">Original Response</label>
          <textarea
            id="field-original"
            rows="2"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-y"
            placeholder="The original LLM response (optional)..."
          ></textarea>
        </div>
        <div>
          <label class="block text-xs font-medium text-muted mb-1">Improved Response *</label>
          <textarea
            id="field-improved"
            rows="4"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-y"
            placeholder="The ideal cached response..."
          ></textarea>
        </div>
        <div>
          <label class="block text-xs font-medium text-muted mb-1">Similarity Threshold</label>
          <div class="flex items-center gap-2">
            <input
              type="range"
              id="field-threshold"
              min="0"
              max="100"
              value="80"
              class="flex-1 h-1.5 accent-coral cursor-pointer"
            />
            <span id="field-threshold-value" class="text-xs font-mono text-dark w-8">0.80</span>
          </div>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-4">
        <button
          id="dialog-cancel"
          class="px-4 py-2 text-sm text-muted hover:text-dark border border-dark/[0.08] rounded-lg hover:bg-subtle transition-colors"
        >Cancel</button>
        <button
          id="dialog-save"
          class="px-4 py-2 text-sm text-white bg-coral hover:bg-coral/90 rounded-lg transition-colors"
        >Save</button>
      </div>
    </div>
  </dialog>

  <!-- Delete confirmation dialog -->
  <dialog
    id="delete-dialog"
    class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-sm w-full"
  >
    <div class="p-6">
      <h3 class="text-base font-medium text-dark mb-2">Delete annotation?</h3>
      <p class="text-sm text-muted mb-6">This action cannot be undone.</p>
      <div class="flex justify-end gap-3">
        <button
          id="delete-cancel"
          class="px-4 py-2 text-sm text-muted hover:text-dark border border-dark/[0.08] rounded-lg hover:bg-subtle transition-colors"
        >Cancel</button>
        <button
          id="delete-confirm"
          class="px-4 py-2 text-sm text-white bg-coral hover:bg-coral/90 rounded-lg transition-colors"
        >Delete</button>
      </div>
    </div>
  </dialog>

  <!-- Import CSV dialog -->
  <dialog
    id="import-dialog"
    class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-md w-full"
  >
    <div class="p-6">
      <h3 class="text-base font-medium text-dark mb-2">Import CSV</h3>
      <p class="text-sm text-muted mb-4">Upload a CSV file with <code class="bg-subtle px-1 py-0.5 rounded text-xs">query</code> and <code class="bg-subtle px-1 py-0.5 rounded text-xs">response</code> columns.</p>
      <input
        type="file"
        id="csv-file"
        accept=".csv"
        class="block w-full text-sm text-dark file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-coral file:text-white hover:file:bg-coral/90 file:cursor-pointer cursor-pointer"
      />
      <div id="import-result" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
      <div class="flex justify-end gap-3 mt-4">
        <button
          id="import-cancel"
          class="px-4 py-2 text-sm text-muted hover:text-dark border border-dark/[0.08] rounded-lg hover:bg-subtle transition-colors"
        >Close</button>
        <button
          id="import-upload"
          class="px-4 py-2 text-sm text-white bg-coral hover:bg-coral/90 rounded-lg transition-colors"
        >Upload</button>
      </div>
    </div>
  </dialog>
</PageLayout>

<script>
interface Annotation {
  id: string;
  user_id: string;
  query: string;
  original_response: string | null;
  improved_response: string;
  similarity_threshold: number;
  usage_count: number;
  cost_saved: number;
  created_at: string;
  updated_at: string;
}

const listEl = document.getElementById("annotations-list")!;
const emptyState = document.getElementById("empty-state")!;
const searchInput = document.getElementById("search-input") as HTMLInputElement;
const thresholdSlider = document.getElementById("threshold-slider") as HTMLInputElement;
const thresholdValue = document.getElementById("threshold-value")!;
const createBtn = document.getElementById("create-btn")!;
const importBtn = document.getElementById("import-btn")!;

/* Stats */
const statTotal = document.getElementById("stat-total")!;
const statMatches = document.getElementById("stat-matches")!;
const statCost = document.getElementById("stat-cost")!;

/* Create/Edit dialog */
const annotationDialog = document.getElementById("annotation-dialog") as HTMLDialogElement;
const dialogTitle = document.getElementById("dialog-title")!;
const editId = document.getElementById("edit-id") as HTMLInputElement;
const fieldQuery = document.getElementById("field-query") as HTMLTextAreaElement;
const fieldOriginal = document.getElementById("field-original") as HTMLTextAreaElement;
const fieldImproved = document.getElementById("field-improved") as HTMLTextAreaElement;
const fieldThreshold = document.getElementById("field-threshold") as HTMLInputElement;
const fieldThresholdValue = document.getElementById("field-threshold-value")!;
const dialogCancel = document.getElementById("dialog-cancel")!;
const dialogSave = document.getElementById("dialog-save")!;

/* Delete dialog */
const deleteDialog = document.getElementById("delete-dialog") as HTMLDialogElement;
const deleteCancel = document.getElementById("delete-cancel")!;
const deleteConfirm = document.getElementById("delete-confirm")!;
let deleteTargetId = "";

/* Import dialog */
const importDialog = document.getElementById("import-dialog") as HTMLDialogElement;
const csvFile = document.getElementById("csv-file") as HTMLInputElement;
const importResult = document.getElementById("import-result")!;
const importCancel = document.getElementById("import-cancel")!;
const importUpload = document.getElementById("import-upload")!;

/* SVG icons as strings */
const editSvg = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
const trashSvg = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';

let annotations: Annotation[] = [];
let searchDebounce: ReturnType<typeof setTimeout> | null = null;

/* --- Load annotations --- */
async function loadAnnotations(search?: string) {
  try {
    let url = "/api/v1/annotations";
    if (search) url += "?search=" + encodeURIComponent(search);
    const res = await fetch(url, { credentials: "same-origin" });
    if (!res.ok) return;
    annotations = await res.json();
    renderList();
    updateStats();
  } catch (_e) { /* ignore */ }
}

/* --- Render list --- */
function renderList() {
  listEl.innerHTML = "";
  if (annotations.length === 0) {
    emptyState.classList.remove("hidden");
    return;
  }
  emptyState.classList.add("hidden");

  annotations.forEach(function(a) {
    const card = document.createElement("div");
    card.className = "bg-paper border border-dark/[0.08] rounded-xl p-4 hover:border-dark/[0.15] transition-colors";

    const header = document.createElement("div");
    header.className = "flex items-start justify-between gap-3 mb-2";

    const queryDiv = document.createElement("div");
    queryDiv.className = "flex-1 min-w-0";
    const queryLabel = document.createElement("p");
    queryLabel.className = "text-xs font-medium text-muted mb-0.5";
    queryLabel.textContent = "Query";
    const queryText = document.createElement("p");
    queryText.className = "text-sm text-dark truncate";
    queryText.textContent = a.query;
    queryText.title = a.query;
    queryDiv.appendChild(queryLabel);
    queryDiv.appendChild(queryText);

    const actions = document.createElement("div");
    actions.className = "flex items-center gap-1 flex-shrink-0";

    const editBtn = document.createElement("button");
    editBtn.className = "p-1.5 rounded text-muted hover:text-zen-blue hover:bg-zen-blue/10 transition-colors";
    editBtn.title = "Edit";
    editBtn.innerHTML = editSvg;
    editBtn.addEventListener("click", function() { openEditDialog(a); });

    const delBtn = document.createElement("button");
    delBtn.className = "p-1.5 rounded text-muted hover:text-coral hover:bg-coral/10 transition-colors";
    delBtn.title = "Delete";
    delBtn.innerHTML = trashSvg;
    delBtn.addEventListener("click", function() { openDeleteDialog(a.id); });

    actions.appendChild(editBtn);
    actions.appendChild(delBtn);
    header.appendChild(queryDiv);
    header.appendChild(actions);

    const responseDiv = document.createElement("div");
    responseDiv.className = "mb-3";
    const responseLabel = document.createElement("p");
    responseLabel.className = "text-xs font-medium text-muted mb-0.5";
    responseLabel.textContent = "Improved Response";
    const responseText = document.createElement("p");
    responseText.className = "text-sm text-dark line-clamp-2";
    responseText.textContent = a.improved_response;
    responseText.title = a.improved_response;
    responseDiv.appendChild(responseLabel);
    responseDiv.appendChild(responseText);

    if (a.original_response) {
      const origDiv = document.createElement("div");
      origDiv.className = "mb-3";
      const origLabel = document.createElement("p");
      origLabel.className = "text-xs font-medium text-muted mb-0.5";
      origLabel.textContent = "Original Response";
      const origText = document.createElement("p");
      origText.className = "text-xs text-muted line-clamp-1";
      origText.textContent = a.original_response;
      origText.title = a.original_response;
      origDiv.appendChild(origLabel);
      origDiv.appendChild(origText);
      card.appendChild(header);
      card.appendChild(origDiv);
      card.appendChild(responseDiv);
    } else {
      card.appendChild(header);
      card.appendChild(responseDiv);
    }

    const meta = document.createElement("div");
    meta.className = "flex items-center gap-4 text-xs text-muted";

    const thresh = document.createElement("span");
    thresh.textContent = "Threshold: " + a.similarity_threshold.toFixed(2);
    const usage = document.createElement("span");
    usage.textContent = "Used " + a.usage_count + " times";
    const cost = document.createElement("span");
    cost.className = "text-zen-green";
    cost.textContent = "Saved $" + a.cost_saved.toFixed(2);
    const date = document.createElement("span");
    date.textContent = new Date(a.created_at).toLocaleDateString();

    meta.appendChild(thresh);
    meta.appendChild(usage);
    meta.appendChild(cost);
    meta.appendChild(date);
    card.appendChild(meta);

    listEl.appendChild(card);
  });
}

/* --- Stats --- */
function updateStats() {
  statTotal.textContent = String(annotations.length);
  const totalMatches = annotations.reduce(function(sum, a) { return sum + a.usage_count; }, 0);
  statMatches.textContent = totalMatches.toLocaleString();
  const totalCost = annotations.reduce(function(sum, a) { return sum + a.cost_saved; }, 0);
  statCost.textContent = "$" + totalCost.toFixed(2);
}

/* --- Threshold slider --- */
thresholdSlider.addEventListener("input", function() {
  thresholdValue.textContent = (parseInt(thresholdSlider.value) / 100).toFixed(2);
});

/* --- Search --- */
searchInput.addEventListener("input", function() {
  if (searchDebounce) clearTimeout(searchDebounce);
  searchDebounce = setTimeout(function() {
    loadAnnotations(searchInput.value.trim() || undefined);
  }, 300);
});

/* --- Create/Edit dialog --- */
fieldThreshold.addEventListener("input", function() {
  fieldThresholdValue.textContent = (parseInt(fieldThreshold.value) / 100).toFixed(2);
});

createBtn.addEventListener("click", function() {
  dialogTitle.textContent = "New Annotation";
  editId.value = "";
  fieldQuery.value = "";
  fieldOriginal.value = "";
  fieldImproved.value = "";
  fieldThreshold.value = "80";
  fieldThresholdValue.textContent = "0.80";
  annotationDialog.showModal();
});

function openEditDialog(a: Annotation) {
  dialogTitle.textContent = "Edit Annotation";
  editId.value = a.id;
  fieldQuery.value = a.query;
  fieldOriginal.value = a.original_response || "";
  fieldImproved.value = a.improved_response;
  fieldThreshold.value = String(Math.round(a.similarity_threshold * 100));
  fieldThresholdValue.textContent = a.similarity_threshold.toFixed(2);
  annotationDialog.showModal();
}

dialogCancel.addEventListener("click", function() {
  annotationDialog.close();
});

annotationDialog.addEventListener("click", function(e) {
  if (e.target === annotationDialog) annotationDialog.close();
});

dialogSave.addEventListener("click", async function() {
  const query = fieldQuery.value.trim();
  const improved = fieldImproved.value.trim();
  if (!query || !improved) return;

  const body: Record<string, string | number | null> = {
    query: query,
    improved_response: improved,
    similarity_threshold: parseInt(fieldThreshold.value) / 100,
  };

  const original = fieldOriginal.value.trim();
  if (original) body.original_response = original;

  try {
    const id = editId.value;
    const url = id ? "/api/v1/annotations/" + id : "/api/v1/annotations";
    const method = id ? "PUT" : "POST";
    const res = await fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify(body),
    });
    if (res.ok) {
      annotationDialog.close();
      loadAnnotations(searchInput.value.trim() || undefined);
    }
  } catch (_e) { /* ignore */ }
});

/* --- Delete dialog --- */
function openDeleteDialog(id: string) {
  deleteTargetId = id;
  deleteDialog.showModal();
}

deleteCancel.addEventListener("click", function() {
  deleteDialog.close();
});

deleteDialog.addEventListener("click", function(e) {
  if (e.target === deleteDialog) deleteDialog.close();
});

deleteConfirm.addEventListener("click", async function() {
  if (!deleteTargetId) return;
  try {
    const res = await fetch("/api/v1/annotations/" + deleteTargetId, {
      method: "DELETE",
      credentials: "same-origin",
    });
    if (res.ok || res.status === 204) {
      deleteDialog.close();
      loadAnnotations(searchInput.value.trim() || undefined);
    }
  } catch (_e) { /* ignore */ }
});

/* --- Import dialog --- */
importBtn.addEventListener("click", function() {
  csvFile.value = "";
  importResult.classList.add("hidden");
  importDialog.showModal();
});

importCancel.addEventListener("click", function() {
  importDialog.close();
});

importDialog.addEventListener("click", function(e) {
  if (e.target === importDialog) importDialog.close();
});

importUpload.addEventListener("click", async function() {
  const file = csvFile.files?.[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  try {
    importUpload.textContent = "Uploading...";
    importUpload.setAttribute("disabled", "true");

    const res = await fetch("/api/v1/annotations/import", {
      method: "POST",
      credentials: "same-origin",
      body: formData,
    });

    const data = await res.json();
    importResult.classList.remove("hidden");

    if (res.ok) {
      importResult.className = "mt-4 p-3 rounded-lg text-sm bg-zen-green/10 text-zen-green";
      importResult.textContent = "Imported " + data.imported + " annotations" + (data.skipped ? ", skipped " + data.skipped : "");
      loadAnnotations();
    } else {
      importResult.className = "mt-4 p-3 rounded-lg text-sm bg-coral/10 text-coral";
      importResult.textContent = data.detail || "Import failed";
    }
  } catch (_e) {
    importResult.classList.remove("hidden");
    importResult.className = "mt-4 p-3 rounded-lg text-sm bg-coral/10 text-coral";
    importResult.textContent = "Upload failed";
  } finally {
    importUpload.textContent = "Upload";
    importUpload.removeAttribute("disabled");
  }
});

/* --- Init --- */
loadAnnotations();
</script>
