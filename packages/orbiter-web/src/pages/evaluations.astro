---
import PageLayout from "../layouts/PageLayout.astro";

const breadcrumbs = [{ label: "Evaluations" }];

/* Icons */
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const playIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
const trashIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
const emptyIcon = '<svg class="h-12 w-12 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>';
const checkIcon = '<svg class="h-4 w-4 text-zen-green" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
const xIcon = '<svg class="h-4 w-4 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const chartIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>';
const shieldIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>';
const alertIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
---

<PageLayout
  title="Evaluations"
  description="Test and score agent responses"
  activeSection="evaluations"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- ============= LIST VIEW ============= -->
    <div id="list-view">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
        <div>
          <h1 class="text-2xl font-semibold text-dark">Evaluations</h1>
          <p class="text-sm text-muted mt-1">Create test suites and evaluate agent performance</p>
        </div>
        <button id="create-btn" class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg bg-coral text-white hover:bg-coral/90 transition-colors cursor-pointer">
          <span set:html={plusIcon} />
          New Evaluation
        </button>
      </div>

      <!-- Evaluations list -->
      <div id="eval-list" class="flex flex-col gap-3"></div>

      <!-- Empty state -->
      <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
        <div class="mb-4" set:html={emptyIcon} />
        <h2 class="text-lg font-semibold text-dark mb-2">No evaluations yet</h2>
        <p class="text-sm text-muted mb-6 max-w-sm">
          Create an evaluation suite to test and score your agents' responses.
        </p>
        <button id="empty-create-btn" class="inline-flex items-center gap-1.5 px-4 py-2.5 text-sm font-medium rounded-lg bg-coral text-white hover:bg-coral/90 transition-colors cursor-pointer">
          <span set:html={plusIcon} />
          Create your first evaluation
        </button>
      </div>
    </div>

    <!-- ============= DETAIL VIEW ============= -->
    <div id="detail-view" class="hidden">
      <div class="flex items-center gap-3 mb-6">
        <button id="back-btn" class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors cursor-pointer">
          <span set:html={backIcon} />
          Back
        </button>
        <div class="flex-1 min-w-0">
          <h1 id="detail-name" class="text-xl font-semibold text-dark truncate"></h1>
          <p id="detail-agent" class="text-sm text-muted"></p>
        </div>
        <button id="run-btn" class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium rounded-lg bg-zen-green text-dark hover:bg-zen-green/80 transition-colors cursor-pointer">
          <span set:html={playIcon} />
          Run Evaluation
        </button>
        <button id="safety-run-btn" class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium rounded-lg bg-zen-blue text-white hover:bg-zen-blue/80 transition-colors cursor-pointer">
          <span set:html={shieldIcon} />
          Safety Test
        </button>
        <button id="delete-eval-btn" class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg border border-coral/30 text-coral hover:bg-coral/5 transition-colors cursor-pointer">
          <span set:html={trashIcon} />
          Delete
        </button>
      </div>

      <!-- Running indicator -->
      <div id="running-indicator" class="hidden mb-4 rounded-xl border border-zen-blue/20 bg-zen-blue/5 px-5 py-3">
        <div class="flex items-center gap-3">
          <div class="h-4 w-4 border-2 border-zen-blue border-t-transparent rounded-full animate-spin"></div>
          <p class="text-sm font-medium text-zen-blue">Running evaluation... This may take a moment.</p>
        </div>
      </div>

      <!-- Aggregate metrics -->
      <div id="metrics-section" class="hidden mb-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="bg-paper border border-dark/[0.08] rounded-xl p-4">
            <p class="text-xs text-muted mb-1">Overall Score</p>
            <p id="metric-score" class="text-2xl font-semibold text-dark">-</p>
          </div>
          <div class="bg-paper border border-dark/[0.08] rounded-xl p-4">
            <p class="text-xs text-muted mb-1">Pass Rate</p>
            <p id="metric-pass-rate" class="text-2xl font-semibold text-dark">-</p>
          </div>
          <div class="bg-paper border border-dark/[0.08] rounded-xl p-4">
            <p class="text-xs text-muted mb-1">Test Cases</p>
            <p id="metric-count" class="text-2xl font-semibold text-dark">-</p>
          </div>
        </div>
      </div>

      <!-- History chart -->
      <div id="history-section" class="hidden mb-6">
        <div class="bg-paper border border-dark/[0.08] rounded-xl p-4">
          <div class="flex items-center gap-2 mb-3">
            <span set:html={chartIcon} />
            <h3 class="text-sm font-semibold text-dark">Score History</h3>
          </div>
          <div id="history-chart" class="w-full" style="height: 180px;"></div>
        </div>
      </div>

      <!-- Test cases + results -->
      <div class="mb-4">
        <h3 class="text-sm font-semibold text-dark mb-3">Test Cases</h3>
        <div id="test-cases-container" class="flex flex-col gap-2"></div>
        <button id="add-case-btn" class="mt-3 inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors cursor-pointer">
          <span set:html={plusIcon} />
          Add Test Case
        </button>
      </div>

      <!-- Results table -->
      <div id="results-section" class="hidden">
        <h3 class="text-sm font-semibold text-dark mb-3">Latest Results</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-dark/[0.08]">
                <th class="text-left py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Input</th>
                <th class="text-left py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Expected</th>
                <th class="text-left py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Actual</th>
                <th class="text-left py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Evaluator</th>
                <th class="text-center py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Score</th>
                <th class="text-center py-2 px-3 text-xs font-semibold text-muted uppercase tracking-wide">Status</th>
              </tr>
            </thead>
            <tbody id="results-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Safety Results section -->
      <div id="safety-section" class="hidden mt-6">
        <div class="flex items-center gap-2 mb-3">
          <span set:html={shieldIcon} />
          <h3 class="text-sm font-semibold text-dark">Safety Evaluation</h3>
        </div>

        <!-- Safety running indicator -->
        <div id="safety-running" class="hidden mb-4 rounded-xl border border-zen-blue/20 bg-zen-blue/5 px-5 py-3">
          <div class="flex items-center gap-3">
            <div class="h-4 w-4 border-2 border-zen-blue border-t-transparent rounded-full animate-spin"></div>
            <p class="text-sm font-medium text-zen-blue">Running safety evaluation... Testing adversarial inputs.</p>
          </div>
        </div>

        <!-- Safety metrics -->
        <div id="safety-metrics" class="hidden mb-4">
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="bg-paper border border-dark/[0.08] rounded-xl p-3">
              <p class="text-xs text-muted mb-0.5">Safety Score</p>
              <p id="safety-score" class="text-xl font-semibold text-dark">-</p>
            </div>
            <div class="bg-paper border border-dark/[0.08] rounded-xl p-3">
              <p class="text-xs text-muted mb-0.5">Pass Rate</p>
              <p id="safety-pass-rate" class="text-xl font-semibold text-dark">-</p>
            </div>
            <div class="bg-paper border border-dark/[0.08] rounded-xl p-3">
              <p class="text-xs text-muted mb-0.5">Flagged</p>
              <p id="safety-flagged" class="text-xl font-semibold text-coral">-</p>
            </div>
            <div class="bg-paper border border-dark/[0.08] rounded-xl p-3">
              <p class="text-xs text-muted mb-0.5">Total Tests</p>
              <p id="safety-total" class="text-xl font-semibold text-dark">-</p>
            </div>
          </div>
        </div>

        <!-- Category scores -->
        <div id="safety-categories" class="hidden mb-4">
          <h4 class="text-xs font-semibold text-muted uppercase tracking-wide mb-2">Category Scores</h4>
          <div id="safety-cat-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </div>

        <!-- Flagged responses -->
        <div id="safety-flagged-section" class="hidden">
          <h4 class="text-xs font-semibold text-muted uppercase tracking-wide mb-2">Flagged Responses</h4>
          <div id="safety-flagged-list" class="flex flex-col gap-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============= CREATE DIALOG ============= -->
  <dialog
    id="create-dialog"
    class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-lg w-full"
  >
    <div class="p-6">
      <h3 class="text-base font-medium text-dark mb-4">New Evaluation Suite</h3>
      <div id="create-error" class="hidden mb-3 rounded-lg bg-coral/10 border border-coral/20 text-coral text-sm px-3 py-2"></div>
      <div class="space-y-3">
        <div>
          <label class="block text-xs font-medium text-muted mb-1">Name *</label>
          <input
            type="text"
            id="create-name"
            placeholder="e.g. Customer Support Quality"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
          />
        </div>
        <div>
          <label class="block text-xs font-medium text-muted mb-1">Agent *</label>
          <select
            id="create-agent"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
          >
            <option value="">Select an agent...</option>
          </select>
        </div>
      </div>
      <div class="flex items-center gap-2 justify-end mt-5">
        <button id="create-cancel" class="rounded-lg border border-dark/[0.08] px-4 py-2 text-sm font-medium text-muted hover:bg-dark/5 transition-colors cursor-pointer">Cancel</button>
        <button id="create-submit" class="rounded-lg bg-coral px-4 py-2 text-sm font-semibold text-white hover:bg-coral/90 transition-colors cursor-pointer">Create</button>
      </div>
    </div>
  </dialog>

  <!-- ============= SAFETY CONFIG DIALOG ============= -->
  <dialog
    id="safety-dialog"
    class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-lg w-full"
  >
    <div class="p-6">
      <h3 class="text-base font-medium text-dark mb-1">Safety Evaluation</h3>
      <p class="text-xs text-muted mb-4">Run adversarial tests to evaluate agent safety</p>
      <div id="safety-error" class="hidden mb-3 rounded-lg bg-coral/10 border border-coral/20 text-coral text-sm px-3 py-2"></div>
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-muted mb-1.5">Mode</label>
          <div class="flex gap-2">
            <label class="flex items-center gap-2 px-3 py-2 rounded-lg border border-dark/[0.08] cursor-pointer has-[:checked]:border-zen-blue has-[:checked]:bg-zen-blue/5 flex-1">
              <input type="radio" name="safety-mode" value="preset" checked class="accent-zen-blue" />
              <div>
                <span class="text-sm font-medium text-dark">Preset</span>
                <p class="text-[11px] text-muted">Built-in adversarial tests</p>
              </div>
            </label>
            <label class="flex items-center gap-2 px-3 py-2 rounded-lg border border-dark/[0.08] cursor-pointer has-[:checked]:border-zen-blue has-[:checked]:bg-zen-blue/5 flex-1">
              <input type="radio" name="safety-mode" value="redteam" class="accent-zen-blue" />
              <div>
                <span class="text-sm font-medium text-dark">Red Team</span>
                <p class="text-[11px] text-muted">AI-generated attacks</p>
              </div>
            </label>
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-muted mb-1.5">Categories</label>
          <div id="safety-cat-checkboxes" class="flex flex-col gap-1.5"></div>
        </div>
        <div>
          <label class="block text-xs font-medium text-muted mb-1.5">Pass Threshold</label>
          <input
            type="range"
            id="safety-threshold"
            min="0"
            max="100"
            value="70"
            class="w-full accent-zen-blue"
          />
          <div class="flex justify-between text-[11px] text-muted">
            <span>0%</span>
            <span id="safety-threshold-label">70%</span>
            <span>100%</span>
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-muted mb-1.5">Safety Rules</label>
          <textarea
            id="safety-rules"
            rows="4"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-xs text-dark placeholder:text-muted/60 outline-none focus:border-zen-blue focus:ring-2 focus:ring-zen-blue/20 font-mono"
            placeholder="One rule per line..."
          ></textarea>
        </div>
      </div>
      <div class="flex items-center gap-2 justify-end mt-5">
        <button id="safety-cancel" class="rounded-lg border border-dark/[0.08] px-4 py-2 text-sm font-medium text-muted hover:bg-dark/5 transition-colors cursor-pointer">Cancel</button>
        <button id="safety-submit" class="rounded-lg bg-zen-blue px-4 py-2 text-sm font-semibold text-white hover:bg-zen-blue/90 transition-colors cursor-pointer">Run Safety Test</button>
      </div>
    </div>
  </dialog>

  <!-- ============= DELETE CONFIRM DIALOG ============= -->
  <dialog
    id="delete-dialog"
    class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-sm w-full"
  >
    <div class="p-6">
      <h3 class="text-base font-medium text-dark mb-2">Delete Evaluation</h3>
      <p class="text-sm text-muted mb-5">This will permanently delete this evaluation suite and all its results. This cannot be undone.</p>
      <div class="flex items-center gap-2 justify-end">
        <button id="delete-cancel" class="rounded-lg border border-dark/[0.08] px-4 py-2 text-sm font-medium text-muted hover:bg-dark/5 transition-colors cursor-pointer">Cancel</button>
        <button id="delete-confirm" class="rounded-lg bg-coral px-4 py-2 text-sm font-semibold text-white hover:bg-coral/90 transition-colors cursor-pointer">Delete</button>
      </div>
    </div>
  </dialog>

  <script is:inline>
    (function () {
      /* ---------- State ---------- */
      var evaluations = [];
      var agents = {};
      var currentEval = null;
      var currentResults = [];
      var currentSafetyResults = [];
      var safetyCategories = {};

      /* ---------- DOM refs ---------- */
      var listView = document.getElementById("list-view");
      var detailView = document.getElementById("detail-view");
      var evalList = document.getElementById("eval-list");
      var emptyState = document.getElementById("empty-state");
      var createBtn = document.getElementById("create-btn");
      var emptyCreateBtn = document.getElementById("empty-create-btn");
      var createDialog = document.getElementById("create-dialog");
      var createName = document.getElementById("create-name");
      var createAgent = document.getElementById("create-agent");
      var createError = document.getElementById("create-error");
      var createCancel = document.getElementById("create-cancel");
      var createSubmit = document.getElementById("create-submit");
      var backBtn = document.getElementById("back-btn");
      var detailName = document.getElementById("detail-name");
      var detailAgent = document.getElementById("detail-agent");
      var runBtn = document.getElementById("run-btn");
      var runningIndicator = document.getElementById("running-indicator");
      var deleteEvalBtn = document.getElementById("delete-eval-btn");
      var deleteDialog = document.getElementById("delete-dialog");
      var deleteCancel = document.getElementById("delete-cancel");
      var deleteConfirm = document.getElementById("delete-confirm");
      var metricsSection = document.getElementById("metrics-section");
      var metricScore = document.getElementById("metric-score");
      var metricPassRate = document.getElementById("metric-pass-rate");
      var metricCount = document.getElementById("metric-count");
      var historySection = document.getElementById("history-section");
      var historyChart = document.getElementById("history-chart");
      var testCasesContainer = document.getElementById("test-cases-container");
      var addCaseBtn = document.getElementById("add-case-btn");
      var resultsSection = document.getElementById("results-section");
      var resultsBody = document.getElementById("results-body");

      /* Safety DOM refs */
      var safetyRunBtn = document.getElementById("safety-run-btn");
      var safetyDialog = document.getElementById("safety-dialog");
      var safetyError = document.getElementById("safety-error");
      var safetyCancel = document.getElementById("safety-cancel");
      var safetySubmit = document.getElementById("safety-submit");
      var safetyThreshold = document.getElementById("safety-threshold");
      var safetyThresholdLabel = document.getElementById("safety-threshold-label");
      var safetyRules = document.getElementById("safety-rules");
      var safetyCatCheckboxes = document.getElementById("safety-cat-checkboxes");
      var safetySection = document.getElementById("safety-section");
      var safetyRunning = document.getElementById("safety-running");
      var safetyMetrics = document.getElementById("safety-metrics");
      var safetyScoreEl = document.getElementById("safety-score");
      var safetyPassRateEl = document.getElementById("safety-pass-rate");
      var safetyFlaggedEl = document.getElementById("safety-flagged");
      var safetyTotalEl = document.getElementById("safety-total");
      var safetyCategoriesEl = document.getElementById("safety-categories");
      var safetyCatGrid = document.getElementById("safety-cat-grid");
      var safetyFlaggedSection = document.getElementById("safety-flagged-section");
      var safetyFlaggedList = document.getElementById("safety-flagged-list");

      var EVALUATOR_TYPES = ["exact_match", "contains", "regex_match", "semantic_similarity", "llm_as_judge"];

      /* ---------- Helpers ---------- */
      function escapeHtml(s) {
        var d = document.createElement("div");
        d.textContent = s || "";
        return d.innerHTML;
      }

      function truncate(s, len) {
        if (!s) return "";
        return s.length > len ? s.substring(0, len) + "..." : s;
      }

      function timeAgo(dateStr) {
        var now = new Date();
        var d = new Date(dateStr + (dateStr.indexOf("Z") === -1 ? "Z" : ""));
        var sec = Math.floor((now - d) / 1000);
        if (sec < 60) return "just now";
        var min = Math.floor(sec / 60);
        if (min < 60) return min + "m ago";
        var hr = Math.floor(min / 60);
        if (hr < 24) return hr + "h ago";
        var day = Math.floor(hr / 24);
        if (day < 7) return day + "d ago";
        return d.toLocaleDateString();
      }

      function pct(n) { return (n * 100).toFixed(1) + "%"; }

      /* ---------- API ---------- */
      function fetchEvaluations() {
        fetch("/api/v1/evaluations", { credentials: "same-origin" })
          .then(function (r) { return r.json(); })
          .then(function (body) {
            evaluations = body.data || body || [];
            renderList();
          })
          .catch(function () { evaluations = []; renderList(); });
      }

      function fetchAgents() {
        fetch("/api/v1/agents", { credentials: "same-origin" })
          .then(function (r) { return r.json(); })
          .then(function (body) {
            var list = body.data || body || [];
            agents = {};
            createAgent.innerHTML = '<option value="">Select an agent...</option>';
            list.forEach(function (a) {
              agents[a.id] = a.name || a.id;
              var opt = document.createElement("option");
              opt.value = a.id;
              opt.textContent = a.name || a.id;
              createAgent.appendChild(opt);
            });
          })
          .catch(function () {});
      }

      function fetchResults(evalId) {
        fetch("/api/v1/evaluations/" + evalId + "/results", { credentials: "same-origin" })
          .then(function (r) { return r.json(); })
          .then(function (results) {
            currentResults = results || [];
            renderResults();
            renderMetrics();
            renderHistoryChart();
          })
          .catch(function () { currentResults = []; renderResults(); });
      }

      function fetchSafetyCategories() {
        fetch("/api/v1/evaluations/safety/categories", { credentials: "same-origin" })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            safetyCategories = data.categories || {};
            var defaultPolicy = data.default_policy || {};
            /* Populate category checkboxes */
            safetyCatCheckboxes.innerHTML = "";
            Object.keys(safetyCategories).forEach(function (key) {
              var cat = safetyCategories[key];
              var label = document.createElement("label");
              label.className = "flex items-center gap-2 text-sm text-dark cursor-pointer";
              label.innerHTML = '<input type="checkbox" class="safety-cat-cb accent-zen-blue" value="' + key + '" checked />'
                + '<span>' + escapeHtml(cat.label) + '</span>'
                + '<span class="text-[11px] text-muted">(' + cat.case_count + ' tests)</span>';
              safetyCatCheckboxes.appendChild(label);
            });
            /* Populate default rules */
            var rules = defaultPolicy.rules || [];
            safetyRules.value = rules.join("\n");
          })
          .catch(function () {});
      }

      function fetchSafetyResults(evalId) {
        fetch("/api/v1/evaluations/" + evalId + "/safety-results", { credentials: "same-origin" })
          .then(function (r) { return r.json(); })
          .then(function (results) {
            currentSafetyResults = results || [];
            renderSafetyResults();
          })
          .catch(function () { currentSafetyResults = []; renderSafetyResults(); });
      }

      /* ---------- Safety Rendering ---------- */
      function renderSafetyResults() {
        if (currentSafetyResults.length === 0) {
          safetySection.classList.add("hidden");
          return;
        }
        safetySection.classList.remove("hidden");

        var latest = currentSafetyResults[0];
        /* Metrics */
        safetyMetrics.classList.remove("hidden");
        safetyScoreEl.textContent = pct(latest.overall_score);
        safetyPassRateEl.textContent = pct(latest.pass_rate);
        safetyFlaggedEl.textContent = String(latest.flagged_count);
        safetyTotalEl.textContent = String(latest.total_count);

        /* Category scores */
        var catScores = {};
        try { catScores = JSON.parse(latest.category_scores_json || "{}"); } catch (_) {}

        if (Object.keys(catScores).length > 0) {
          safetyCategoriesEl.classList.remove("hidden");
          safetyCatGrid.innerHTML = "";
          Object.keys(catScores).forEach(function (key) {
            var cs = catScores[key];
            var card = document.createElement("div");
            var borderColor = cs.passed ? "border-zen-green/30" : "border-coral/30";
            var bgColor = cs.passed ? "bg-zen-green/5" : "bg-coral/5";
            card.className = "rounded-xl border " + borderColor + " " + bgColor + " p-3";
            card.innerHTML =
              '<div class="flex items-center justify-between mb-1">'
              + '<span class="text-xs font-semibold text-dark">' + escapeHtml(cs.label) + '</span>'
              + '<span class="text-[11px] font-mono ' + (cs.passed ? 'text-zen-green' : 'text-coral') + '">' + pct(cs.score) + '</span>'
              + '</div>'
              + '<div class="w-full h-1.5 rounded-full bg-dark/[0.06]">'
              + '<div class="h-full rounded-full ' + (cs.passed ? 'bg-zen-green' : 'bg-coral') + '" style="width: ' + (cs.score * 100) + '%"></div>'
              + '</div>'
              + '<div class="flex justify-between mt-1">'
              + '<span class="text-[10px] text-muted">' + cs.passed_count + '/' + cs.total + ' passed</span>'
              + '<span class="text-[10px] text-muted">Threshold: ' + pct(cs.threshold) + '</span>'
              + '</div>';
            safetyCatGrid.appendChild(card);
          });
        } else {
          safetyCategoriesEl.classList.add("hidden");
        }

        /* Flagged responses */
        var results = [];
        try { results = JSON.parse(latest.results_json || "[]"); } catch (_) {}
        var flagged = results.filter(function (r) { return !r.passed; });

        if (flagged.length > 0) {
          safetyFlaggedSection.classList.remove("hidden");
          safetyFlaggedList.innerHTML = "";
          flagged.forEach(function (r) {
            var item = document.createElement("div");
            item.className = "bg-coral/5 border border-coral/20 rounded-lg p-3";
            item.innerHTML =
              '<div class="flex items-start gap-2">'
              + '<span class="shrink-0 mt-0.5 text-coral">' + '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>' + '</span>'
              + '<div class="flex-1 min-w-0">'
              + '<div class="flex items-center gap-2 mb-1">'
              + '<span class="inline-block rounded bg-coral/10 px-1.5 py-0.5 text-[11px] font-medium text-coral">' + escapeHtml(r.category_label) + '</span>'
              + '<span class="text-[11px] text-muted font-mono">' + pct(r.score) + '</span>'
              + '</div>'
              + '<p class="text-xs text-dark mb-1"><strong>Input:</strong> ' + escapeHtml(truncate(r.input, 120)) + '</p>'
              + '<p class="text-xs text-muted mb-1"><strong>Response:</strong> ' + escapeHtml(truncate(r.response, 120)) + '</p>'
              + '<p class="text-xs text-coral"><strong>Concern:</strong> ' + escapeHtml(r.explanation) + '</p>'
              + '</div>'
              + '</div>';
            safetyFlaggedList.appendChild(item);
          });
        } else {
          safetyFlaggedSection.classList.add("hidden");
        }
      }

      /* ---------- List Rendering ---------- */
      function renderList() {
        evalList.innerHTML = "";
        if (evaluations.length === 0) {
          emptyState.classList.remove("hidden");
          return;
        }
        emptyState.classList.add("hidden");

        evaluations.forEach(function (ev) {
          var testCases = [];
          try { testCases = JSON.parse(ev.test_cases_json || "[]"); } catch (_) {}
          var agentName = agents[ev.agent_id] || ev.agent_id;
          var card = document.createElement("div");
          card.className = "bg-paper border border-dark/[0.08] rounded-xl p-4 hover:border-coral/30 transition-colors cursor-pointer";
          card.setAttribute("data-eval-id", ev.id);
          card.innerHTML =
            '<div class="flex items-center justify-between">'
            + '<div class="min-w-0 flex-1">'
            + '<h3 class="text-sm font-semibold text-dark truncate">' + escapeHtml(ev.name) + '</h3>'
            + '<p class="text-xs text-muted mt-0.5">Agent: ' + escapeHtml(agentName) + ' &middot; ' + testCases.length + ' test case' + (testCases.length === 1 ? '' : 's') + ' &middot; ' + timeAgo(ev.created_at) + '</p>'
            + '</div>'
            + '</div>';
          evalList.appendChild(card);
        });
      }

      /* ---------- Detail View ---------- */
      function showDetail(evalId) {
        var ev = evaluations.find(function (e) { return e.id === evalId; });
        if (!ev) return;
        currentEval = ev;
        listView.classList.add("hidden");
        detailView.classList.remove("hidden");
        detailName.textContent = ev.name;
        detailAgent.textContent = "Agent: " + (agents[ev.agent_id] || ev.agent_id);
        renderTestCases();
        fetchResults(evalId);
        fetchSafetyResults(evalId);
      }

      function showList() {
        currentEval = null;
        currentResults = [];
        currentSafetyResults = [];
        detailView.classList.add("hidden");
        listView.classList.remove("hidden");
        resultsSection.classList.add("hidden");
        metricsSection.classList.add("hidden");
        historySection.classList.add("hidden");
        safetySection.classList.add("hidden");
        fetchEvaluations();
      }

      /* ---------- Test Cases Rendering ---------- */
      function renderTestCases() {
        testCasesContainer.innerHTML = "";
        var testCases = [];
        try { testCases = JSON.parse(currentEval.test_cases_json || "[]"); } catch (_) {}

        testCases.forEach(function (tc, idx) {
          var row = document.createElement("div");
          row.className = "bg-paper border border-dark/[0.08] rounded-lg p-3";
          row.innerHTML =
            '<div class="flex items-start gap-3">'
            + '<span class="text-xs font-mono text-muted mt-1">#' + (idx + 1) + '</span>'
            + '<div class="flex-1 grid grid-cols-1 sm:grid-cols-3 gap-2">'
            + '<div>'
            + '<label class="block text-[11px] font-medium text-muted mb-0.5">Input</label>'
            + '<input type="text" class="tc-input w-full bg-subtle/30 border border-dark/[0.06] rounded px-2 py-1.5 text-xs text-dark outline-none focus:border-coral" value="' + escapeHtml(tc.input) + '" data-idx="' + idx + '" data-field="input" />'
            + '</div>'
            + '<div>'
            + '<label class="block text-[11px] font-medium text-muted mb-0.5">Expected</label>'
            + '<input type="text" class="tc-input w-full bg-subtle/30 border border-dark/[0.06] rounded px-2 py-1.5 text-xs text-dark outline-none focus:border-coral" value="' + escapeHtml(tc.expected) + '" data-idx="' + idx + '" data-field="expected" />'
            + '</div>'
            + '<div class="flex gap-2">'
            + '<div class="flex-1">'
            + '<label class="block text-[11px] font-medium text-muted mb-0.5">Evaluator</label>'
            + '<select class="tc-input w-full bg-subtle/30 border border-dark/[0.06] rounded px-2 py-1.5 text-xs text-dark outline-none focus:border-coral" data-idx="' + idx + '" data-field="evaluator">'
            + EVALUATOR_TYPES.map(function (t) { return '<option value="' + t + '"' + (tc.evaluator === t ? ' selected' : '') + '>' + t.replace(/_/g, ' ') + '</option>'; }).join('')
            + '</select>'
            + '</div>'
            + '<button class="tc-remove self-end p-1.5 text-muted hover:text-coral transition-colors cursor-pointer" data-idx="' + idx + '" title="Remove">'
            + '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>'
            + '</button>'
            + '</div>'
            + '</div>'
            + '</div>';
          testCasesContainer.appendChild(row);
        });
      }

      /* ---------- Save test cases (debounced) ---------- */
      var saveTimer = null;
      function saveTestCases() {
        if (!currentEval) return;
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(function () {
          var testCases = collectTestCases();
          fetch("/api/v1/evaluations/" + currentEval.id, {
            method: "PUT",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ test_cases: testCases }),
          })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              currentEval.test_cases_json = data.test_cases_json;
            })
            .catch(function () {});
        }, 500);
      }

      function collectTestCases() {
        var cases = [];
        var inputs = testCasesContainer.querySelectorAll("[data-field='input']");
        var expected = testCasesContainer.querySelectorAll("[data-field='expected']");
        var evaluators = testCasesContainer.querySelectorAll("[data-field='evaluator']");
        for (var i = 0; i < inputs.length; i++) {
          cases.push({
            input: inputs[i].value,
            expected: expected[i].value,
            evaluator: evaluators[i].value,
          });
        }
        return cases;
      }

      /* ---------- Results Rendering ---------- */
      function renderResults() {
        if (currentResults.length === 0) {
          resultsSection.classList.add("hidden");
          return;
        }
        resultsSection.classList.remove("hidden");
        var latest = currentResults[0];
        var results = [];
        try { results = JSON.parse(latest.results_json || "[]"); } catch (_) {}
        resultsBody.innerHTML = "";

        results.forEach(function (r) {
          var tr = document.createElement("tr");
          tr.className = "border-b border-dark/[0.04]";
          tr.innerHTML =
            '<td class="py-2 px-3 text-dark max-w-[150px] truncate">' + escapeHtml(truncate(r.input, 60)) + '</td>'
            + '<td class="py-2 px-3 text-muted max-w-[150px] truncate">' + escapeHtml(truncate(r.expected, 60)) + '</td>'
            + '<td class="py-2 px-3 text-muted max-w-[150px] truncate">' + escapeHtml(truncate(r.actual, 60)) + '</td>'
            + '<td class="py-2 px-3"><span class="inline-block rounded bg-subtle/50 px-1.5 py-0.5 text-xs text-muted">' + escapeHtml(r.evaluator) + '</span></td>'
            + '<td class="py-2 px-3 text-center font-mono text-sm">' + (r.score * 100).toFixed(1) + '%</td>'
            + '<td class="py-2 px-3 text-center">' + (r.passed ? '<span class="inline-flex items-center gap-1 rounded-full bg-zen-green/10 px-2 py-0.5 text-xs font-medium text-zen-green">Pass</span>' : '<span class="inline-flex items-center gap-1 rounded-full bg-coral/10 px-2 py-0.5 text-xs font-medium text-coral">Fail</span>') + '</td>';
          resultsBody.appendChild(tr);
        });
      }

      function renderMetrics() {
        if (currentResults.length === 0) {
          metricsSection.classList.add("hidden");
          return;
        }
        metricsSection.classList.remove("hidden");
        var latest = currentResults[0];
        metricScore.textContent = pct(latest.overall_score);
        metricPassRate.textContent = pct(latest.pass_rate);
        var results = [];
        try { results = JSON.parse(latest.results_json || "[]"); } catch (_) {}
        metricCount.textContent = String(results.length);
      }

      /* ---------- History Chart (SVG) ---------- */
      function renderHistoryChart() {
        if (currentResults.length < 2) {
          historySection.classList.add("hidden");
          return;
        }
        historySection.classList.remove("hidden");

        var runs = currentResults.slice().reverse();
        var W = historyChart.clientWidth || 500;
        var H = 160;
        var padL = 40, padR = 20, padT = 10, padB = 30;
        var chartW = W - padL - padR;
        var chartH = H - padT - padB;

        var maxPts = Math.min(runs.length, 20);
        var pts = runs.slice(-maxPts);
        var stepX = pts.length > 1 ? chartW / (pts.length - 1) : chartW;

        var svg = '<svg width="' + W + '" height="' + H + '" viewBox="0 0 ' + W + ' ' + H + '">';

        /* Grid lines */
        for (var g = 0; g <= 4; g++) {
          var gy = padT + (chartH * (4 - g) / 4);
          svg += '<line x1="' + padL + '" y1="' + gy + '" x2="' + (W - padR) + '" y2="' + gy + '" stroke="currentColor" stroke-opacity="0.08" />';
          svg += '<text x="' + (padL - 5) + '" y="' + (gy + 4) + '" text-anchor="end" fill="currentColor" fill-opacity="0.4" font-size="10">' + (g * 25) + '%</text>';
        }

        /* Score line */
        var scorePts = pts.map(function (r, i) {
          return (padL + i * stepX) + "," + (padT + chartH - (r.overall_score * chartH));
        }).join(" ");
        svg += '<polyline points="' + scorePts + '" fill="none" stroke="#F76F53" stroke-width="2" stroke-linejoin="round" />';

        /* Pass rate line */
        var passPts = pts.map(function (r, i) {
          return (padL + i * stepX) + "," + (padT + chartH - (r.pass_rate * chartH));
        }).join(" ");
        svg += '<polyline points="' + passPts + '" fill="none" stroke="#63f78b" stroke-width="2" stroke-linejoin="round" stroke-dasharray="4 2" />';

        /* Dots */
        pts.forEach(function (r, i) {
          var x = padL + i * stepX;
          var yScore = padT + chartH - (r.overall_score * chartH);
          var yPass = padT + chartH - (r.pass_rate * chartH);
          svg += '<circle cx="' + x + '" cy="' + yScore + '" r="3" fill="#F76F53" />';
          svg += '<circle cx="' + x + '" cy="' + yPass + '" r="3" fill="#63f78b" />';
        });

        /* Legend */
        svg += '<rect x="' + padL + '" y="' + (H - 12) + '" width="10" height="3" fill="#F76F53" rx="1" />';
        svg += '<text x="' + (padL + 14) + '" y="' + (H - 8) + '" fill="currentColor" fill-opacity="0.5" font-size="10">Score</text>';
        svg += '<rect x="' + (padL + 55) + '" y="' + (H - 12) + '" width="10" height="3" fill="#63f78b" rx="1" />';
        svg += '<text x="' + (padL + 69) + '" y="' + (H - 8) + '" fill="currentColor" fill-opacity="0.5" font-size="10">Pass Rate</text>';

        svg += '</svg>';
        historyChart.innerHTML = svg;
      }

      /* ---------- Events: List view ---------- */
      evalList.addEventListener("click", function (e) {
        var card = e.target.closest("[data-eval-id]");
        if (!card) return;
        showDetail(card.getAttribute("data-eval-id"));
      });

      function openCreateDialog() {
        createName.value = "";
        createAgent.value = "";
        createError.classList.add("hidden");
        createDialog.showModal();
      }

      createBtn.addEventListener("click", openCreateDialog);
      emptyCreateBtn.addEventListener("click", openCreateDialog);
      createCancel.addEventListener("click", function () { createDialog.close(); });
      createDialog.addEventListener("click", function (e) { if (e.target === createDialog) createDialog.close(); });

      createSubmit.addEventListener("click", function () {
        var name = createName.value.trim();
        var agentId = createAgent.value;
        if (!name || !agentId) {
          createError.textContent = "Name and agent are required.";
          createError.classList.remove("hidden");
          return;
        }
        createSubmit.disabled = true;
        createSubmit.textContent = "Creating...";
        fetch("/api/v1/evaluations", {
          method: "POST",
          credentials: "same-origin",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: name, agent_id: agentId, test_cases: [] }),
        })
          .then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw new Error(d.detail || "Failed"); });
            return r.json();
          })
          .then(function (ev) {
            createDialog.close();
            evaluations.unshift(ev);
            renderList();
            showDetail(ev.id);
          })
          .catch(function (err) {
            createError.textContent = err.message;
            createError.classList.remove("hidden");
          })
          .finally(function () {
            createSubmit.disabled = false;
            createSubmit.textContent = "Create";
          });
      });

      /* ---------- Events: Detail view ---------- */
      backBtn.addEventListener("click", showList);

      /* Test case editing */
      testCasesContainer.addEventListener("input", function (e) {
        if (e.target.classList.contains("tc-input")) saveTestCases();
      });
      testCasesContainer.addEventListener("change", function (e) {
        if (e.target.classList.contains("tc-input")) saveTestCases();
      });
      testCasesContainer.addEventListener("click", function (e) {
        var removeBtn = e.target.closest(".tc-remove");
        if (!removeBtn) return;
        var idx = parseInt(removeBtn.getAttribute("data-idx"), 10);
        var testCases = collectTestCases();
        testCases.splice(idx, 1);
        currentEval.test_cases_json = JSON.stringify(testCases);
        renderTestCases();
        saveTestCases();
      });

      addCaseBtn.addEventListener("click", function () {
        var testCases = [];
        try { testCases = JSON.parse(currentEval.test_cases_json || "[]"); } catch (_) {}
        testCases.push({ input: "", expected: "", evaluator: "exact_match" });
        currentEval.test_cases_json = JSON.stringify(testCases);
        renderTestCases();
        saveTestCases();
        var lastInput = testCasesContainer.querySelector("[data-idx='" + (testCases.length - 1) + "'][data-field='input']");
        if (lastInput) lastInput.focus();
      });

      /* Run evaluation */
      runBtn.addEventListener("click", function () {
        if (!currentEval) return;
        var testCases = collectTestCases().filter(function (tc) { return tc.input.trim(); });
        if (testCases.length === 0) {
          alert("Add at least one test case with an input before running.");
          return;
        }
        runBtn.disabled = true;
        runningIndicator.classList.remove("hidden");
        fetch("/api/v1/evaluations/" + currentEval.id + "/run", {
          method: "POST",
          credentials: "same-origin",
        })
          .then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw new Error(d.detail || "Run failed"); });
            return r.json();
          })
          .then(function () {
            fetchResults(currentEval.id);
          })
          .catch(function (err) {
            alert("Error: " + err.message);
          })
          .finally(function () {
            runBtn.disabled = false;
            runningIndicator.classList.add("hidden");
          });
      });

      /* Delete */
      deleteEvalBtn.addEventListener("click", function () { deleteDialog.showModal(); });
      deleteCancel.addEventListener("click", function () { deleteDialog.close(); });
      deleteDialog.addEventListener("click", function (e) { if (e.target === deleteDialog) deleteDialog.close(); });
      deleteConfirm.addEventListener("click", function () {
        if (!currentEval) return;
        deleteConfirm.disabled = true;
        deleteConfirm.textContent = "Deleting...";
        fetch("/api/v1/evaluations/" + currentEval.id, {
          method: "DELETE",
          credentials: "same-origin",
        })
          .then(function (r) {
            if (!r.ok) throw new Error("Delete failed");
            deleteDialog.close();
            showList();
          })
          .catch(function (err) {
            alert("Error: " + err.message);
          })
          .finally(function () {
            deleteConfirm.disabled = false;
            deleteConfirm.textContent = "Delete";
          });
      });

      /* ---------- Safety dialog events ---------- */
      safetyRunBtn.addEventListener("click", function () {
        safetyError.classList.add("hidden");
        safetyDialog.showModal();
      });
      safetyCancel.addEventListener("click", function () { safetyDialog.close(); });
      safetyDialog.addEventListener("click", function (e) { if (e.target === safetyDialog) safetyDialog.close(); });

      safetyThreshold.addEventListener("input", function () {
        safetyThresholdLabel.textContent = safetyThreshold.value + "%";
      });

      safetySubmit.addEventListener("click", function () {
        if (!currentEval) return;

        /* Gather selected categories */
        var selectedCats = [];
        safetyCatCheckboxes.querySelectorAll(".safety-cat-cb:checked").forEach(function (cb) {
          selectedCats.push(cb.value);
        });
        if (selectedCats.length === 0) {
          safetyError.textContent = "Select at least one category.";
          safetyError.classList.remove("hidden");
          return;
        }

        /* Gather mode */
        var mode = "preset";
        var modeRadio = document.querySelector('input[name="safety-mode"]:checked');
        if (modeRadio) mode = modeRadio.value;

        /* Gather rules */
        var rulesArr = safetyRules.value.split("\n").map(function (l) { return l.trim(); }).filter(Boolean);

        /* Gather threshold */
        var threshold = parseInt(safetyThreshold.value, 10) / 100;

        safetyDialog.close();
        safetyRunBtn.disabled = true;
        safetySection.classList.remove("hidden");
        safetyRunning.classList.remove("hidden");

        fetch("/api/v1/evaluations/" + currentEval.id + "/safety-run", {
          method: "POST",
          credentials: "same-origin",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            categories: selectedCats,
            mode: mode,
            policy: { pass_threshold: threshold, rules: rulesArr },
          }),
        })
          .then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw new Error(d.detail || "Safety run failed"); });
            return r.json();
          })
          .then(function () {
            fetchSafetyResults(currentEval.id);
          })
          .catch(function (err) {
            alert("Safety test error: " + err.message);
          })
          .finally(function () {
            safetyRunBtn.disabled = false;
            safetyRunning.classList.add("hidden");
          });
      });

      /* ---------- Init ---------- */
      fetchAgents();
      fetchEvaluations();
      fetchSafetyCategories();
    })();
  </script>
</PageLayout>
