---
import PageLayout from "../layouts/PageLayout.astro";
import Button from "../components/Button.astro";
import Input from "../components/Input.astro";
import Select from "../components/Select.astro";
import Modal from "../components/Modal.astro";

const breadcrumbs = [{ label: "Settings" }];

const themeOptions = [
  { value: "light", label: "Light" },
  { value: "dark", label: "Dark" },
  { value: "system", label: "System" },
];

const providerOptions = [
  { value: "", label: "None" },
  { value: "openai", label: "OpenAI" },
  { value: "anthropic", label: "Anthropic" },
  { value: "gemini", label: "Google Gemini" },
  { value: "vertex", label: "Google Vertex AI" },
  { value: "ollama", label: "Ollama (local)" },
];

const providerTypeOptions = [
  { value: "openai", label: "OpenAI" },
  { value: "anthropic", label: "Anthropic" },
  { value: "gemini", label: "Google Gemini" },
  { value: "vertex", label: "Google Vertex AI" },
  { value: "ollama", label: "Ollama (local)" },
  { value: "custom", label: "Custom" },
];

/* Icons */
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
---

<PageLayout
  title="Settings"
  description="Configure your workspace"
  activeSection="settings"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-3xl mx-auto">
    <h1 class="text-2xl font-semibold text-dark mb-6">Settings</h1>

    <!-- Tab navigation -->
    <div class="flex border-b border-dark/[0.08] mb-8 gap-1 overflow-x-auto" role="tablist">
      <button
        role="tab"
        aria-selected="true"
        data-settings-tab="profile"
        class="settings-tab px-4 py-2.5 text-sm font-medium text-coral border-b-2 border-coral transition-colors duration-150 cursor-pointer whitespace-nowrap"
      >
        Profile
      </button>
      <button
        role="tab"
        aria-selected="false"
        data-settings-tab="appearance"
        class="settings-tab px-4 py-2.5 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors duration-150 cursor-pointer whitespace-nowrap"
      >
        Appearance
      </button>
      <button
        role="tab"
        aria-selected="false"
        data-settings-tab="models"
        class="settings-tab px-4 py-2.5 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors duration-150 cursor-pointer whitespace-nowrap"
      >
        Models
      </button>
      <button
        role="tab"
        aria-selected="false"
        data-settings-tab="workspace"
        class="settings-tab px-4 py-2.5 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors duration-150 cursor-pointer whitespace-nowrap"
      >
        Workspace
      </button>
    </div>

    <!-- Profile section -->
    <div id="panel-profile" class="settings-panel" role="tabpanel">
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6">
        <h2 class="text-lg font-semibold text-dark mb-1">Profile</h2>
        <p class="text-sm text-muted mb-6">Manage your account details</p>

        <div id="profile-loading" class="text-sm text-muted py-4">Loading profile...</div>

        <form id="profile-form" class="hidden flex flex-col gap-4">
          <Input
            label="Email"
            name="email"
            type="email"
            disabled
          />
          <Input
            label="Member since"
            name="created_at"
            disabled
          />
          <div class="flex justify-end mt-2">
            <Button variant="bordered" type="button" id="logout-btn">
              Sign out
            </Button>
          </div>
        </form>
      </div>
    </div>

    <!-- Appearance section -->
    <div id="panel-appearance" class="settings-panel hidden" role="tabpanel">
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6">
        <h2 class="text-lg font-semibold text-dark mb-1">Appearance</h2>
        <p class="text-sm text-muted mb-6">Customize how Orbiter looks</p>

        <form id="appearance-form" class="flex flex-col gap-4">
          <Select
            label="Theme"
            name="theme"
            options={themeOptions}
          />
          <p class="text-xs text-muted">
            System mode follows your operating system preference.
          </p>
          <div class="flex justify-end mt-2">
            <Button variant="primary" type="submit" id="appearance-save">
              Save
            </Button>
          </div>
        </form>
        <div id="appearance-saved" class="hidden text-sm text-zen-green mt-3">Theme preference saved.</div>
      </div>
    </div>

    <!-- Models section -->
    <div id="panel-models" class="settings-panel hidden" role="tabpanel">
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-lg font-semibold text-dark mb-1">Model Providers</h2>
            <p class="text-sm text-muted">Configure API keys and provider connections</p>
          </div>
          <Button variant="primary" id="add-provider-btn">
            <span set:html={plusIcon} />
            Add Provider
          </Button>
        </div>

        <!-- Loading state -->
        <div id="providers-loading" class="text-sm text-muted py-4">Loading providers...</div>

        <!-- Provider cards list -->
        <div id="providers-list" class="hidden flex flex-col gap-3"></div>

        <!-- Empty state -->
        <div id="providers-empty" class="hidden flex flex-col items-center py-8 text-center">
          <svg class="h-10 w-10 text-muted/40 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
            <line x1="8" y1="21" x2="16" y2="21" />
            <line x1="12" y1="17" x2="12" y2="21" />
          </svg>
          <p class="text-sm text-muted max-w-xs">
            No providers configured yet. Add a provider to start using AI models.
          </p>
        </div>
      </div>
    </div>

    <!-- Workspace section -->
    <div id="panel-workspace" class="settings-panel hidden" role="tabpanel">
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6">
        <h2 class="text-lg font-semibold text-dark mb-1">Workspace</h2>
        <p class="text-sm text-muted mb-6">Configure default workspace behavior</p>

        <form id="workspace-form" class="flex flex-col gap-4">
          <Select
            label="Default Model Provider"
            name="default_provider"
            options={providerOptions}
          />
          <div class="flex flex-col gap-1.5">
            <label for="workspace-default-model" class="text-sm font-medium text-dark">Default Model</label>
            <select
              id="workspace-default-model"
              name="default_model"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer"
            >
              <option value="">None</option>
            </select>
            <p class="text-xs text-muted">Default model for new agent runs across the workspace.</p>
          </div>
          <Input
            label="Concurrent Run Limit"
            name="concurrent_limit"
            type="number"
            min="1"
            max="20"
            value="5"
            placeholder="5"
          />
          <p class="text-xs text-muted">
            Maximum number of agent runs that can execute simultaneously.
          </p>
          <div class="flex justify-end mt-2">
            <Button variant="primary" type="submit" id="workspace-save">
              Save
            </Button>
          </div>
        </form>
        <div id="workspace-saved" class="hidden text-sm text-zen-green mt-3">Workspace settings saved.</div>
      </div>
    </div>
  </div>

  <!-- Add Provider Modal -->
  <Modal id="add-provider-modal" title="Add Provider">
    <form id="add-provider-form" class="flex flex-col gap-4">
      <Input
        label="Provider Name"
        name="name"
        placeholder="e.g. My OpenAI Account"
        required
      />
      <Select
        label="Provider Type"
        name="provider_type"
        options={providerTypeOptions}
        required
      />
      <Input
        label="API Key"
        name="api_key"
        type="password"
        placeholder="sk-..."
      />
      <Input
        label="Base URL (optional)"
        name="base_url"
        placeholder="https://api.example.com"
      />
      <div id="add-provider-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="add-provider-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="add-provider-submit">
          Add Provider
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Edit Provider Modal -->
  <Modal id="edit-provider-modal" title="Edit Provider">
    <form id="edit-provider-form" class="flex flex-col gap-4">
      <input type="hidden" name="provider_id" />
      <Input
        label="Provider Name"
        name="name"
        required
      />
      <Select
        label="Provider Type"
        name="provider_type"
        options={providerTypeOptions}
        required
      />
      <Input
        label="API Key"
        name="api_key"
        type="password"
        placeholder="Leave blank to keep current key"
      />
      <Input
        label="Base URL (optional)"
        name="base_url"
        placeholder="https://api.example.com"
      />
      <div id="edit-provider-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="edit-provider-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="edit-provider-submit">
          Save Changes
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Delete Confirmation Modal -->
  <Modal id="delete-provider-modal" title="Delete Provider">
    <p class="text-sm text-muted mb-1">Are you sure you want to delete <strong id="delete-provider-name" class="text-dark"></strong>?</p>
    <p class="text-sm text-muted mb-6">This action cannot be undone. All associated API keys will be removed.</p>
    <div class="flex justify-end gap-3">
      <Button variant="default" type="button" data-modal-close="delete-provider-modal">
        Cancel
      </Button>
      <Button variant="primary" type="button" id="confirm-delete-btn" class="!bg-coral !text-white">
        Delete Provider
      </Button>
    </div>
  </Modal>

  <!-- Delete Key Confirmation Modal -->
  <Modal id="delete-key-modal" title="Delete API Key">
    <p class="text-sm text-muted mb-1">Are you sure you want to delete key <strong id="delete-key-label" class="text-dark"></strong>?</p>
    <p class="text-sm text-muted mb-6">This action cannot be undone.</p>
    <div class="flex justify-end gap-3">
      <Button variant="default" type="button" data-modal-close="delete-key-modal">
        Cancel
      </Button>
      <Button variant="primary" type="button" id="confirm-delete-key-btn" class="!bg-coral !text-white">
        Delete Key
      </Button>
    </div>
  </Modal>
</PageLayout>

<!-- Provider card template -->
<template id="provider-card-template">
  <div class="rounded-lg border border-dark/[0.08] bg-paper p-4 transition-all duration-200 hover:border-dark/20">
    <div class="flex items-start justify-between">
      <div class="flex items-center gap-3 min-w-0">
        <div class="flex-shrink-0 h-10 w-10 rounded-lg bg-dark/5 flex items-center justify-center" data-field="icon"></div>
        <div class="min-w-0">
          <h3 class="font-medium text-dark text-sm truncate" data-field="name"></h3>
          <p class="text-xs text-muted" data-field="type"></p>
        </div>
      </div>
      <div class="flex items-center gap-1.5 flex-shrink-0">
        <span class="provider-status inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full" data-field="status"></span>
      </div>
    </div>
    <div class="flex items-center justify-between mt-3 pt-3 border-t border-dark/[0.06]">
      <div class="flex items-center gap-2">
        <span class="text-xs text-muted" data-field="key-info"></span>
      </div>
      <div class="flex items-center gap-1">
        <button type="button" class="provider-keys-btn inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-md text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer" title="Manage Keys">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
          Keys
        </button>
        <button type="button" class="provider-test-btn inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-md text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer" title="Test Connection">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          Test
        </button>
        <button type="button" class="provider-edit-btn inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-md text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer" title="Edit">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          Edit
        </button>
        <button type="button" class="provider-delete-btn inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-md text-muted hover:bg-coral/10 hover:text-coral transition-colors cursor-pointer" title="Delete">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          Delete
        </button>
      </div>
    </div>
    <!-- Test result row (hidden by default) -->
    <div class="provider-test-result hidden mt-3 pt-3 border-t border-dark/[0.06] text-xs"></div>
    <!-- Keys management section (hidden by default) -->
    <div class="provider-keys-section hidden mt-3 pt-3 border-t border-dark/[0.06]">
      <!-- Strategy selector -->
      <div class="flex items-center justify-between mb-3">
        <label class="text-xs font-medium text-dark">Load Balancing</label>
        <select class="keys-strategy-select text-xs bg-paper border border-dark/[0.08] rounded-md px-2 py-1 text-dark cursor-pointer focus:outline-none focus:ring-1 focus:ring-coral/30">
          <option value="round_robin">Round Robin</option>
          <option value="random">Random</option>
          <option value="least_recently_used">Least Recently Used</option>
        </select>
      </div>
      <!-- Key list -->
      <div class="keys-list flex flex-col gap-2 mb-3"></div>
      <!-- Keys empty state -->
      <div class="keys-empty hidden text-xs text-muted text-center py-3">No API keys configured for this provider.</div>
      <!-- Add key inline form -->
      <div class="flex gap-2 items-end">
        <div class="flex-1">
          <input type="password" class="key-input-value w-full text-xs bg-paper border border-dark/[0.08] rounded-md px-2.5 py-1.5 text-dark placeholder:text-muted/60 focus:outline-none focus:ring-1 focus:ring-coral/30" placeholder="sk-... or API key" />
        </div>
        <div class="w-28">
          <input type="text" class="key-input-label w-full text-xs bg-paper border border-dark/[0.08] rounded-md px-2.5 py-1.5 text-dark placeholder:text-muted/60 focus:outline-none focus:ring-1 focus:ring-coral/30" placeholder="Label" />
        </div>
        <button type="button" class="key-add-btn inline-flex items-center gap-1 text-xs px-2.5 py-1.5 rounded-md bg-dark text-paper hover:bg-dark/90 transition-colors cursor-pointer flex-shrink-0">
          <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add
        </button>
      </div>
      <div class="key-add-error hidden text-xs text-coral mt-1"></div>
    </div>
  </div>
</template>

<!-- Key row template -->
<template id="key-row-template">
  <div class="flex items-center justify-between rounded-md border border-dark/[0.06] px-3 py-2 bg-subtle/40">
    <div class="flex items-center gap-2 min-w-0">
      <span class="key-status-dot inline-block h-2 w-2 rounded-full flex-shrink-0"></span>
      <span class="key-label text-xs font-medium text-dark truncate"></span>
      <span class="key-status-text text-xs text-muted"></span>
    </div>
    <div class="flex items-center gap-3 flex-shrink-0">
      <div class="flex items-center gap-3 text-xs text-muted">
        <span class="key-stat-requests" title="Total requests"></span>
        <span class="key-stat-tokens" title="Total tokens"></span>
        <span class="key-stat-errors" title="Errors"></span>
        <span class="key-stat-last-used" title="Last used"></span>
      </div>
      <button type="button" class="key-delete-btn text-muted hover:text-coral transition-colors cursor-pointer" title="Delete key">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
      </button>
    </div>
  </div>
</template>

<script is:inline>
  (function () {
    // ------- Tab switching -------
    var tabs = document.querySelectorAll(".settings-tab");
    var panels = document.querySelectorAll(".settings-panel");

    tabs.forEach(function (tab) {
      tab.addEventListener("click", function () {
        var target = tab.getAttribute("data-settings-tab");

        // Update tab styles
        tabs.forEach(function (t) {
          t.classList.remove("text-coral", "border-coral");
          t.classList.add("text-muted", "border-transparent");
          t.setAttribute("aria-selected", "false");
        });
        tab.classList.remove("text-muted", "border-transparent");
        tab.classList.add("text-coral", "border-coral");
        tab.setAttribute("aria-selected", "true");

        // Show target panel, hide others
        panels.forEach(function (p) {
          p.classList.add("hidden");
        });
        var panel = document.getElementById("panel-" + target);
        if (panel) panel.classList.remove("hidden");

        // Load providers when Models tab is first shown
        if (target === "models" && !providersLoaded) {
          fetchProviders();
        }
      });
    });

    // ------- Profile -------
    var profileLoading = document.getElementById("profile-loading");
    var profileForm = document.getElementById("profile-form");
    var logoutBtn = document.getElementById("logout-btn");

    fetch("/api/auth/me", { credentials: "same-origin" })
      .then(function (res) {
        if (!res.ok) throw new Error("Not authenticated");
        return res.json();
      })
      .then(function (user) {
        if (profileLoading) profileLoading.classList.add("hidden");
        if (!profileForm) return;
        profileForm.classList.remove("hidden");

        var emailInput = profileForm.querySelector('[name="email"]');
        if (emailInput) emailInput.value = user.email;

        var createdInput = profileForm.querySelector('[name="created_at"]');
        if (createdInput) {
          try {
            var d = new Date(user.created_at + "Z");
            createdInput.value = d.toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });
          } catch (_e) {
            createdInput.value = user.created_at;
          }
        }
      })
      .catch(function () {
        if (profileLoading) profileLoading.textContent = "Could not load profile.";
      });

    if (logoutBtn) {
      logoutBtn.addEventListener("click", function () {
        fetch("/api/auth/logout", { method: "POST", credentials: "same-origin" })
          .then(function () {
            window.location.replace("/login");
          })
          .catch(function () {
            window.location.replace("/login");
          });
      });
    }

    // ------- Appearance -------
    var appearanceForm = document.getElementById("appearance-form");
    var appearanceSaved = document.getElementById("appearance-saved");

    // Initialise theme select from current preference
    var themeSelect = appearanceForm ? appearanceForm.querySelector('[name="theme"]') : null;
    if (themeSelect) {
      var stored = localStorage.getItem("theme");
      if (stored === "dark" || stored === "light") {
        themeSelect.value = stored;
      } else {
        themeSelect.value = "system";
      }
    }

    if (appearanceForm) {
      appearanceForm.addEventListener("submit", function (e) {
        e.preventDefault();
        var selected = themeSelect ? themeSelect.value : "system";

        if (selected === "system") {
          localStorage.removeItem("theme");
          var preferred = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
          document.documentElement.setAttribute("data-theme", preferred);
        } else {
          localStorage.setItem("theme", selected);
          document.documentElement.setAttribute("data-theme", selected);
        }

        // Update theme icons in PageLayout top bar
        var lightIcon = document.getElementById("theme-icon-light");
        var darkIcon = document.getElementById("theme-icon-dark");
        if (lightIcon && darkIcon) {
          var current = document.documentElement.getAttribute("data-theme");
          if (current === "dark") {
            lightIcon.classList.add("hidden");
            darkIcon.classList.remove("hidden");
          } else {
            lightIcon.classList.remove("hidden");
            darkIcon.classList.add("hidden");
          }
        }

        if (appearanceSaved) {
          appearanceSaved.classList.remove("hidden");
          setTimeout(function () {
            appearanceSaved.classList.add("hidden");
          }, 2000);
        }
      });
    }

    // ------- Models / Providers -------
    var providersLoaded = false;
    var providersData = [];
    var providersList = document.getElementById("providers-list");
    var providersLoading = document.getElementById("providers-loading");
    var providersEmpty = document.getElementById("providers-empty");
    var addProviderBtn = document.getElementById("add-provider-btn");
    var addModal = document.getElementById("add-provider-modal");
    var addForm = document.getElementById("add-provider-form");
    var addError = document.getElementById("add-provider-error");
    var addSubmit = document.getElementById("add-provider-submit");
    var editModal = document.getElementById("edit-provider-modal");
    var editForm = document.getElementById("edit-provider-form");
    var editError = document.getElementById("edit-provider-error");
    var editSubmit = document.getElementById("edit-provider-submit");
    var deleteModal = document.getElementById("delete-provider-modal");
    var deleteNameEl = document.getElementById("delete-provider-name");
    var confirmDeleteBtn = document.getElementById("confirm-delete-btn");
    var cardTemplate = document.getElementById("provider-card-template");

    var deleteTargetId = null;

    var providerIcons = {
      openai: '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494zM3.6 18.304a4.47 4.47 0 0 1-.535-3.014l.142.085 4.783 2.759a.771.771 0 0 0 .78 0l5.843-3.369v2.332a.08.08 0 0 1-.033.062L9.74 19.95a4.5 4.5 0 0 1-6.14-1.646zM2.34 7.896a4.485 4.485 0 0 1 2.366-1.973V11.6a.766.766 0 0 0 .388.676l5.815 3.355-2.02 1.168a.076.076 0 0 1-.071 0l-4.83-2.786A4.504 4.504 0 0 1 2.34 7.872zm16.597 3.855l-5.833-3.387L15.119 7.2a.076.076 0 0 1 .071 0l4.83 2.791a4.494 4.494 0 0 1-.676 8.105v-5.678a.79.79 0 0 0-.407-.667zm2.01-3.023l-.141-.085-4.774-2.782a.776.776 0 0 0-.785 0L9.409 9.23V6.897a.066.066 0 0 1 .028-.061l4.83-2.787a4.5 4.5 0 0 1 6.68 4.66zm-12.64 4.135l-2.02-1.164a.08.08 0 0 1-.038-.057V6.075a4.5 4.5 0 0 1 7.375-3.453l-.142.08L8.704 5.46a.795.795 0 0 0-.393.681zm1.097-2.365l2.602-1.5 2.607 1.5v2.999l-2.597 1.5-2.607-1.5z"/></svg>',
      anthropic: '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M13.827 3.52h3.603L24 20.48h-3.603l-6.57-16.96zm-7.258 0h3.767L16.906 20.48h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm1.21 5.175l-2.33 5.987h4.656l-2.326-5.987z"/></svg>',
      gemini: '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm0 3.6c4.638 0 8.4 3.762 8.4 8.4s-3.762 8.4-8.4 8.4-8.4-3.762-8.4-8.4S7.362 3.6 12 3.6z"/></svg>',
      vertex: '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm0 3.6c4.638 0 8.4 3.762 8.4 8.4s-3.762 8.4-8.4 8.4-8.4-3.762-8.4-8.4S7.362 3.6 12 3.6z"/></svg>',
      ollama: '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><circle cx="12" cy="12" r="4"/></svg>',
      custom: '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>'
    };

    var providerLabels = {
      openai: "OpenAI",
      anthropic: "Anthropic",
      gemini: "Google Gemini",
      vertex: "Google Vertex AI",
      ollama: "Ollama",
      custom: "Custom"
    };

    function fetchProviders() {
      fetch("/api/providers")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load providers");
          return res.json();
        })
        .then(function (data) {
          providersLoaded = true;
          providersData = data;
          renderProviders(data);
        })
        .catch(function () {
          if (providersLoading) providersLoading.textContent = "Failed to load providers. Is the API server running?";
        });
    }

    var keyRowTemplate = document.getElementById("key-row-template");
    var deleteKeyModal = document.getElementById("delete-key-modal");
    var deleteKeyLabel = document.getElementById("delete-key-label");
    var confirmDeleteKeyBtn = document.getElementById("confirm-delete-key-btn");
    var deleteKeyTargetId = null;
    var deleteKeyProviderId = null;
    var deleteKeyCardEl = null;

    // Cooldown timers - track intervals so we can clear them
    var cooldownIntervals = {};

    function renderProviders(providers) {
      if (providersLoading) providersLoading.classList.add("hidden");

      // Clear all cooldown intervals
      Object.keys(cooldownIntervals).forEach(function (k) {
        clearInterval(cooldownIntervals[k]);
        delete cooldownIntervals[k];
      });

      if (!providers || providers.length === 0) {
        providersList.classList.add("hidden");
        providersEmpty.classList.remove("hidden");
        return;
      }

      providersEmpty.classList.add("hidden");
      providersList.classList.remove("hidden");
      providersList.innerHTML = "";

      providers.forEach(function (provider) {
        var card = cardTemplate.content.cloneNode(true);
        var container = card.querySelector("div");
        container.setAttribute("data-provider-id", provider.id);

        // Icon
        var iconEl = card.querySelector('[data-field="icon"]');
        iconEl.innerHTML = providerIcons[provider.provider_type] || providerIcons.custom;

        // Name
        var nameEl = card.querySelector('[data-field="name"]');
        nameEl.textContent = provider.name;

        // Type label
        var typeEl = card.querySelector('[data-field="type"]');
        typeEl.textContent = providerLabels[provider.provider_type] || provider.provider_type;

        // Status
        var statusEl = card.querySelector('[data-field="status"]');
        if (provider.api_key_set) {
          statusEl.innerHTML = '<span class="inline-block h-1.5 w-1.5 rounded-full bg-zen-green"></span> Connected';
          statusEl.classList.add("bg-zen-green/10", "text-zen-green");
        } else {
          statusEl.innerHTML = '<span class="inline-block h-1.5 w-1.5 rounded-full bg-muted"></span> No Key';
          statusEl.classList.add("bg-dark/5", "text-muted");
        }

        // Key info
        var keyInfoEl = card.querySelector('[data-field="key-info"]');
        keyInfoEl.textContent = provider.api_key_set ? "API key configured" : "No API key set";

        // Button handlers
        var keysBtn = card.querySelector(".provider-keys-btn");
        keysBtn.addEventListener("click", function () {
          toggleKeysSection(provider.id, container);
        });

        var testBtn = card.querySelector(".provider-test-btn");
        testBtn.addEventListener("click", function () {
          testProvider(provider.id, container);
        });

        var editBtn = card.querySelector(".provider-edit-btn");
        editBtn.addEventListener("click", function () {
          openEditModal(provider);
        });

        var deleteBtn = card.querySelector(".provider-delete-btn");
        deleteBtn.addEventListener("click", function () {
          openDeleteModal(provider.id, provider.name);
        });

        // Keys section: add key button
        var keyAddBtn = card.querySelector(".key-add-btn");
        keyAddBtn.addEventListener("click", function () {
          addKeyToProvider(provider.id, container);
        });

        // Strategy change handler
        var strategySelect = card.querySelector(".keys-strategy-select");
        strategySelect.addEventListener("change", function () {
          updateStrategy(provider.id, strategySelect.value);
        });

        providersList.appendChild(card);
      });
    }

    // Test connection
    function testProvider(providerId, cardEl) {
      var resultEl = cardEl.querySelector(".provider-test-result");
      var testBtn = cardEl.querySelector(".provider-test-btn");

      resultEl.classList.remove("hidden");
      resultEl.innerHTML = '<span class="text-muted">Testing connection...</span>';
      testBtn.disabled = true;

      fetch("/api/providers/" + providerId + "/test", {
        method: "POST",
        credentials: "same-origin"
      })
        .then(function (res) {
          if (!res.ok) throw new Error("Test request failed");
          return res.json();
        })
        .then(function (result) {
          if (result.success) {
            resultEl.innerHTML = '<span class="text-zen-green flex items-center gap-1"><svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Connected (' + result.latency_ms.toFixed(0) + 'ms)</span>';
          } else {
            resultEl.innerHTML = '<span class="text-coral flex items-center gap-1"><svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> ' + (result.error || "Connection failed") + '</span>';
          }
        })
        .catch(function () {
          resultEl.innerHTML = '<span class="text-coral">Failed to test connection</span>';
        })
        .finally(function () {
          testBtn.disabled = false;
          // Auto-hide result after 8 seconds
          setTimeout(function () {
            resultEl.classList.add("hidden");
          }, 8000);
        });
    }

    // Add provider
    if (addProviderBtn) {
      addProviderBtn.addEventListener("click", function () {
        if (addForm) addForm.reset();
        if (addError) addError.classList.add("hidden");
        if (addModal) addModal.showModal();
      });
    }

    if (addForm) {
      addForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (addError) addError.classList.add("hidden");

        var formData = new FormData(addForm);
        var name = (formData.get("name") || "").toString().trim();
        var providerType = (formData.get("provider_type") || "").toString();
        var apiKey = (formData.get("api_key") || "").toString().trim();
        var baseUrl = (formData.get("base_url") || "").toString().trim();

        if (!name) {
          if (addError) {
            addError.textContent = "Provider name is required";
            addError.classList.remove("hidden");
          }
          return;
        }

        addSubmit.disabled = true;
        addSubmit.textContent = "Adding...";

        var body = { name: name, provider_type: providerType };
        if (apiKey) body.api_key = apiKey;
        if (baseUrl) body.base_url = baseUrl;

        fetch("/api/providers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to add provider"); });
            return res.json();
          })
          .then(function () {
            addForm.reset();
            addModal.close();
            fetchProviders();
          })
          .catch(function (err) {
            if (addError) {
              addError.textContent = err.message;
              addError.classList.remove("hidden");
            }
          })
          .finally(function () {
            addSubmit.disabled = false;
            addSubmit.textContent = "Add Provider";
          });
      });
    }

    // Edit provider
    function openEditModal(provider) {
      if (!editForm) return;
      editForm.querySelector('[name="provider_id"]').value = provider.id;
      editForm.querySelector('[name="name"]').value = provider.name;
      editForm.querySelector('[name="provider_type"]').value = provider.provider_type;
      editForm.querySelector('[name="api_key"]').value = "";
      editForm.querySelector('[name="base_url"]').value = provider.base_url || "";
      if (editError) editError.classList.add("hidden");
      if (editModal) editModal.showModal();
    }

    if (editForm) {
      editForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (editError) editError.classList.add("hidden");

        var formData = new FormData(editForm);
        var providerId = formData.get("provider_id");
        var name = (formData.get("name") || "").toString().trim();
        var providerType = (formData.get("provider_type") || "").toString();
        var apiKey = (formData.get("api_key") || "").toString().trim();
        var baseUrl = (formData.get("base_url") || "").toString().trim();

        if (!name) {
          if (editError) {
            editError.textContent = "Provider name is required";
            editError.classList.remove("hidden");
          }
          return;
        }

        editSubmit.disabled = true;
        editSubmit.textContent = "Saving...";

        var body = { name: name, provider_type: providerType };
        if (apiKey) body.api_key = apiKey;
        if (baseUrl) {
          body.base_url = baseUrl;
        }

        fetch("/api/providers/" + providerId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to update provider"); });
            return res.json();
          })
          .then(function () {
            editModal.close();
            fetchProviders();
          })
          .catch(function (err) {
            if (editError) {
              editError.textContent = err.message;
              editError.classList.remove("hidden");
            }
          })
          .finally(function () {
            editSubmit.disabled = false;
            editSubmit.textContent = "Save Changes";
          });
      });
    }

    // Delete provider
    function openDeleteModal(id, name) {
      deleteTargetId = id;
      if (deleteNameEl) deleteNameEl.textContent = name;
      if (deleteModal) deleteModal.showModal();
    }

    if (confirmDeleteBtn) {
      confirmDeleteBtn.addEventListener("click", function () {
        if (!deleteTargetId) return;

        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.textContent = "Deleting...";

        fetch("/api/providers/" + deleteTargetId, {
          method: "DELETE",
          credentials: "same-origin"
        })
          .then(function (res) {
            if (!res.ok) throw new Error("Failed to delete");
            deleteModal.close();
            deleteTargetId = null;
            fetchProviders();
          })
          .catch(function () {
            deleteModal.close();
          })
          .finally(function () {
            confirmDeleteBtn.disabled = false;
            confirmDeleteBtn.textContent = "Delete Provider";
          });
      });
    }

    // ------- Key Management -------
    function toggleKeysSection(providerId, cardEl) {
      var section = cardEl.querySelector(".provider-keys-section");
      if (section.classList.contains("hidden")) {
        section.classList.remove("hidden");
        fetchKeys(providerId, cardEl);
      } else {
        section.classList.add("hidden");
      }
    }

    function fetchKeys(providerId, cardEl) {
      var keysList = cardEl.querySelector(".keys-list");
      var keysEmpty = cardEl.querySelector(".keys-empty");
      var strategySelect = cardEl.querySelector(".keys-strategy-select");

      keysList.innerHTML = '<div class="text-xs text-muted py-2">Loading keys...</div>';
      keysEmpty.classList.add("hidden");

      // Fetch strategy and keys in parallel
      Promise.all([
        fetch("/api/providers/" + providerId + "/strategy").then(function (r) { return r.ok ? r.json() : { strategy: "round_robin" }; }),
        fetch("/api/providers/" + providerId + "/keys").then(function (r) { return r.ok ? r.json() : []; })
      ]).then(function (results) {
        var strategyData = results[0];
        var keys = results[1];

        strategySelect.value = strategyData.strategy || "round_robin";
        renderKeys(providerId, cardEl, keys);
      }).catch(function () {
        keysList.innerHTML = '<div class="text-xs text-coral py-2">Failed to load keys.</div>';
      });
    }

    function renderKeys(providerId, cardEl, keys) {
      var keysList = cardEl.querySelector(".keys-list");
      var keysEmpty = cardEl.querySelector(".keys-empty");

      keysList.innerHTML = "";

      if (!keys || keys.length === 0) {
        keysEmpty.classList.remove("hidden");
        return;
      }

      keysEmpty.classList.add("hidden");

      keys.forEach(function (key) {
        var row = keyRowTemplate.content.cloneNode(true);
        var container = row.querySelector("div");
        container.setAttribute("data-key-id", key.id);

        // Status dot
        var dot = row.querySelector(".key-status-dot");
        if (key.status === "active") {
          dot.classList.add("bg-zen-green");
        } else if (key.status === "rate_limited") {
          dot.classList.add("bg-yellow-400");
        } else {
          dot.classList.add("bg-coral");
        }

        // Label
        var labelEl = row.querySelector(".key-label");
        labelEl.textContent = key.label || "Key " + (key.strategy_position + 1);

        // Status text with cooldown
        var statusText = row.querySelector(".key-status-text");
        if (key.status === "active") {
          statusText.textContent = "";
        } else if (key.status === "rate_limited") {
          if (key.cooldown_until) {
            startCooldownTimer(key.id, key.cooldown_until, statusText);
          } else {
            statusText.textContent = "(rate limited)";
            statusText.classList.add("text-yellow-600");
          }
        } else if (key.status === "invalid") {
          statusText.textContent = "(invalid)";
          statusText.classList.add("text-coral");
        }

        // Stats
        var reqEl = row.querySelector(".key-stat-requests");
        reqEl.textContent = key.total_requests + " req";

        var tokensEl = row.querySelector(".key-stat-tokens");
        tokensEl.textContent = formatTokens(key.total_tokens);

        var errorsEl = row.querySelector(".key-stat-errors");
        if (key.error_count > 0) {
          errorsEl.textContent = key.error_count + " err";
          errorsEl.classList.add("text-coral");
        } else {
          errorsEl.textContent = "";
        }

        var lastUsedEl = row.querySelector(".key-stat-last-used");
        if (key.last_used) {
          lastUsedEl.textContent = formatRelativeTime(key.last_used);
        } else {
          lastUsedEl.textContent = "never";
        }

        // Delete handler
        var deleteBtn = row.querySelector(".key-delete-btn");
        deleteBtn.addEventListener("click", function () {
          openDeleteKeyModal(providerId, key.id, key.label || "Key " + (key.strategy_position + 1), cardEl);
        });

        keysList.appendChild(row);
      });

      // Update key-info on the provider card
      var keyInfoEl = cardEl.querySelector('[data-field="key-info"]');
      if (keyInfoEl) {
        keyInfoEl.textContent = keys.length + " key" + (keys.length !== 1 ? "s" : "") + " configured";
      }
    }

    function formatTokens(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + "M tok";
      if (num >= 1000) return (num / 1000).toFixed(1) + "K tok";
      return num + " tok";
    }

    function formatRelativeTime(dateStr) {
      try {
        var d = new Date(dateStr + "Z");
        var now = new Date();
        var diff = Math.floor((now - d) / 1000);
        if (diff < 60) return "just now";
        if (diff < 3600) return Math.floor(diff / 60) + "m ago";
        if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
        return Math.floor(diff / 86400) + "d ago";
      } catch (_e) {
        return dateStr;
      }
    }

    function startCooldownTimer(keyId, cooldownUntil, statusEl) {
      // Clear any existing timer for this key
      if (cooldownIntervals[keyId]) {
        clearInterval(cooldownIntervals[keyId]);
      }

      function updateTimer() {
        var now = new Date();
        var target = new Date(cooldownUntil + "Z");
        var remaining = Math.max(0, Math.floor((target - now) / 1000));

        if (remaining <= 0) {
          statusEl.textContent = "(cooldown expired)";
          statusEl.classList.remove("text-yellow-600");
          statusEl.classList.add("text-muted");
          clearInterval(cooldownIntervals[keyId]);
          delete cooldownIntervals[keyId];
          return;
        }

        var mins = Math.floor(remaining / 60);
        var secs = remaining % 60;
        statusEl.textContent = "(rate limited " + mins + ":" + (secs < 10 ? "0" : "") + secs + ")";
        statusEl.classList.add("text-yellow-600");
      }

      updateTimer();
      cooldownIntervals[keyId] = setInterval(updateTimer, 1000);
    }

    function addKeyToProvider(providerId, cardEl) {
      var keyInput = cardEl.querySelector(".key-input-value");
      var labelInput = cardEl.querySelector(".key-input-label");
      var addBtn = cardEl.querySelector(".key-add-btn");
      var errorEl = cardEl.querySelector(".key-add-error");

      var apiKey = (keyInput.value || "").trim();
      if (!apiKey) {
        errorEl.textContent = "API key is required";
        errorEl.classList.remove("hidden");
        return;
      }

      errorEl.classList.add("hidden");
      addBtn.disabled = true;
      addBtn.textContent = "Adding...";

      var body = { api_key: apiKey };
      var label = (labelInput.value || "").trim();
      if (label) body.label = label;

      fetch("/api/providers/" + providerId + "/keys", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to add key"); });
          return res.json();
        })
        .then(function () {
          keyInput.value = "";
          labelInput.value = "";
          fetchKeys(providerId, cardEl);
        })
        .catch(function (err) {
          errorEl.textContent = err.message;
          errorEl.classList.remove("hidden");
        })
        .finally(function () {
          addBtn.disabled = false;
          addBtn.innerHTML = '<svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add';
        });
    }

    function updateStrategy(providerId, strategy) {
      fetch("/api/providers/" + providerId + "/strategy", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ strategy: strategy })
      }).catch(function () {
        // Silently fail â€” strategy is not critical
      });
    }

    function openDeleteKeyModal(providerId, keyId, label, cardEl) {
      deleteKeyTargetId = keyId;
      deleteKeyProviderId = providerId;
      deleteKeyCardEl = cardEl;
      if (deleteKeyLabel) deleteKeyLabel.textContent = label;
      if (deleteKeyModal) deleteKeyModal.showModal();
    }

    if (confirmDeleteKeyBtn) {
      confirmDeleteKeyBtn.addEventListener("click", function () {
        if (!deleteKeyTargetId || !deleteKeyProviderId) return;

        confirmDeleteKeyBtn.disabled = true;
        confirmDeleteKeyBtn.textContent = "Deleting...";

        fetch("/api/providers/" + deleteKeyProviderId + "/keys/" + deleteKeyTargetId, {
          method: "DELETE",
          credentials: "same-origin"
        })
          .then(function (res) {
            if (!res.ok) throw new Error("Failed to delete");
            deleteKeyModal.close();
            if (deleteKeyCardEl) {
              fetchKeys(deleteKeyProviderId, deleteKeyCardEl);
            }
            deleteKeyTargetId = null;
            deleteKeyProviderId = null;
            deleteKeyCardEl = null;
          })
          .catch(function () {
            deleteKeyModal.close();
          })
          .finally(function () {
            confirmDeleteKeyBtn.disabled = false;
            confirmDeleteKeyBtn.textContent = "Delete Key";
          });
      });
    }

    // ------- Workspace -------
    var workspaceForm = document.getElementById("workspace-form");
    var workspaceSaved = document.getElementById("workspace-saved");
    var workspaceModelSelect = document.getElementById("workspace-default-model");

    // Populate model dropdown for workspace
    function fetchModelsForWorkspace() {
      fetch("/api/models")
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (models) {
          if (!workspaceModelSelect) return;
          workspaceModelSelect.innerHTML = '<option value="">None</option>';
          models.forEach(function (m) {
            var opt = document.createElement("option");
            opt.value = m.model_name;
            opt.textContent = m.model_name + " (" + (m.provider_name || m.provider_type) + ")";
            workspaceModelSelect.appendChild(opt);
          });
          // Restore saved value
          var savedModel = localStorage.getItem("orbiter_default_model") || "";
          workspaceModelSelect.value = savedModel;
        })
        .catch(function () {});
    }

    // Load workspace settings from localStorage
    if (workspaceForm) {
      var providerSelect = workspaceForm.querySelector('[name="default_provider"]');
      var limitInput = workspaceForm.querySelector('[name="concurrent_limit"]');
      var savedProvider = localStorage.getItem("orbiter_default_provider") || "";
      var savedLimit = localStorage.getItem("orbiter_concurrent_limit") || "5";
      if (providerSelect) providerSelect.value = savedProvider;
      if (limitInput) limitInput.value = savedLimit;

      fetchModelsForWorkspace();

      workspaceForm.addEventListener("submit", function (e) {
        e.preventDefault();
        var provider = providerSelect ? providerSelect.value : "";
        var limit = limitInput ? limitInput.value : "5";
        var model = workspaceModelSelect ? workspaceModelSelect.value : "";

        localStorage.setItem("orbiter_default_provider", provider);
        localStorage.setItem("orbiter_concurrent_limit", limit);
        localStorage.setItem("orbiter_default_model", model);

        if (workspaceSaved) {
          workspaceSaved.classList.remove("hidden");
          setTimeout(function () {
            workspaceSaved.classList.add("hidden");
          }, 2000);
        }
      });
    }
  })();
</script>
