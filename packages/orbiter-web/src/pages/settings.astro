---
import PageLayout from "../layouts/PageLayout.astro";
import Button from "../components/Button.astro";
import Input from "../components/Input.astro";
import Select from "../components/Select.astro";
import HelpTooltip from "../components/HelpTooltip.astro";
import Modal from "../components/Modal.astro";

const breadcrumbs = [{ label: "Settings" }];

const themeOptions = [
  { value: "light", label: "Light" },
  { value: "dark", label: "Dark" },
  { value: "system", label: "System" },
];

const providerOptions = [
  { value: "", label: "None" },
  { value: "openai", label: "OpenAI" },
  { value: "anthropic", label: "Anthropic" },
  { value: "gemini", label: "Google Gemini" },
  { value: "vertex", label: "Google Vertex AI" },
  { value: "ollama", label: "Ollama (local)" },
];

const providerTypeOptions = [
  { value: "openai", label: "OpenAI" },
  { value: "anthropic", label: "Anthropic" },
  { value: "gemini", label: "Google Gemini" },
  { value: "vertex", label: "Google Vertex AI" },
  { value: "ollama", label: "Ollama (local)" },
  { value: "custom", label: "Custom" },
];

/* Icons */
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
---

<PageLayout
  title="Settings"
  description="Configure your workspace"
  activeSection="settings"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-3xl mx-auto">
    <h1 class="text-2xl font-semibold text-dark mb-6">Settings</h1>

    <!-- Tab navigation -->
    <div class="flex border-b border-dark/[0.08] mb-8 gap-1 overflow-x-auto" role="tablist">
      <button
        role="tab"
        aria-selected="true"
        data-settings-tab="profile"
        class="settings-tab px-4 py-2.5 text-sm font-medium text-coral border-b-2 border-coral transition-colors duration-150 cursor-pointer whitespace-nowrap"
      >
        Profile
      </button>
      <button
        role="tab"
        aria-selected="false"
        data-settings-tab="appearance"
        class="settings-tab px-4 py-2.5 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors duration-150 cursor-pointer whitespace-nowrap"
      >
        Appearance
      </button>
      <button
        role="tab"
        aria-selected="false"
        data-settings-tab="models"
        class="settings-tab px-4 py-2.5 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors duration-150 cursor-pointer whitespace-nowrap"
      >
        Models
      </button>
      <button
        role="tab"
        aria-selected="false"
        data-settings-tab="knowledge"
        class="settings-tab px-4 py-2.5 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors duration-150 cursor-pointer whitespace-nowrap"
      >
        Knowledge
      </button>
      <button
        role="tab"
        aria-selected="false"
        data-settings-tab="pricing"
        class="settings-tab px-4 py-2.5 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors duration-150 cursor-pointer whitespace-nowrap"
      >
        Pricing
      </button>
      <button
        role="tab"
        aria-selected="false"
        data-settings-tab="workspace"
        class="settings-tab px-4 py-2.5 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors duration-150 cursor-pointer whitespace-nowrap"
      >
        Workspace
      </button>
      <button
        role="tab"
        aria-selected="false"
        data-settings-tab="integrations"
        class="settings-tab px-4 py-2.5 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors duration-150 cursor-pointer whitespace-nowrap"
      >
        Integrations
      </button>
      <button
        role="tab"
        aria-selected="false"
        data-settings-tab="team"
        id="team-tab"
        class="settings-tab px-4 py-2.5 text-sm font-medium text-muted border-b-2 border-transparent hover:text-dark transition-colors duration-150 cursor-pointer whitespace-nowrap hidden"
      >
        Team
      </button>
    </div>

    <!-- Profile section -->
    <div id="panel-profile" class="settings-panel" role="tabpanel">
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6">
        <h2 class="text-lg font-semibold text-dark mb-1">Profile</h2>
        <p class="text-sm text-muted mb-6">Manage your account details</p>

        <div id="profile-loading" class="text-sm text-muted py-4">Loading profile...</div>

        <div id="profile-section" class="hidden flex flex-col gap-6">
          <!-- Email row -->
          <div class="flex flex-col gap-1.5">
            <label class="text-sm font-medium text-dark">Email</label>
            <div id="email-display" class="flex items-center gap-3">
              <span id="email-value" class="text-sm text-dark"></span>
              <button type="button" id="email-edit-btn" class="text-xs text-coral hover:text-coral/80 cursor-pointer transition-colors">Edit</button>
            </div>
            <div id="email-edit-form" class="hidden flex items-center gap-2">
              <input
                type="email"
                id="email-edit-input"
                class="flex-1 bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              />
              <button type="button" id="email-save-btn" class="inline-flex items-center text-xs px-3 py-2 rounded-lg bg-coral text-white hover:bg-coral/90 transition-colors cursor-pointer font-medium">Save</button>
              <button type="button" id="email-cancel-btn" class="inline-flex items-center text-xs px-3 py-2 rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/5 transition-colors cursor-pointer">Cancel</button>
            </div>
          </div>

          <!-- Role badge -->
          <div class="flex flex-col gap-1.5">
            <label class="text-sm font-medium text-dark">Role</label>
            <div>
              <span id="role-badge" class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-medium"></span>
            </div>
          </div>

          <!-- Member since -->
          <div class="flex flex-col gap-1.5">
            <label class="text-sm font-medium text-dark">Member since</label>
            <span id="member-since" class="text-sm text-muted"></span>
          </div>

          <!-- Onboarding tour -->
          <div class="flex flex-col gap-1.5">
            <label class="text-sm font-medium text-dark">Onboarding Tour</label>
            <div>
              <button
                type="button"
                id="show-tour-btn"
                class="inline-flex items-center gap-2 text-sm font-medium text-coral hover:text-coral/80 transition-colors cursor-pointer"
              >
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                Show Tour Again
              </button>
            </div>
          </div>

          <!-- Sign out -->
          <div class="flex justify-end">
            <Button variant="bordered" type="button" id="logout-btn">
              Sign out
            </Button>
          </div>
        </div>
      </div>

      <!-- Change Password -->
      <div id="password-section" class="hidden rounded-xl bg-subtle/80 border border-dark/[0.08] p-6 mt-4">
        <h2 class="text-lg font-semibold text-dark mb-1">Change Password</h2>
        <p class="text-sm text-muted mb-6">Update your account password</p>

        <form id="password-form" class="flex flex-col gap-4">
          <div class="flex flex-col gap-1.5">
            <label for="current-password" class="text-sm font-medium text-dark">Current Password</label>
            <input
              type="password"
              id="current-password"
              name="current_password"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="Enter current password"
              required
            />
          </div>
          <div class="flex flex-col gap-1.5">
            <label for="new-password" class="text-sm font-medium text-dark">New Password</label>
            <input
              type="password"
              id="new-password"
              name="new_password"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="Min 8 characters"
              minlength="8"
              required
            />
          </div>
          <div class="flex flex-col gap-1.5">
            <label for="confirm-password" class="text-sm font-medium text-dark">Confirm New Password</label>
            <input
              type="password"
              id="confirm-password"
              name="confirm_password"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="Re-enter new password"
              required
            />
          </div>
          <div id="password-error" class="text-sm text-coral hidden"></div>
          <div class="flex justify-end mt-2">
            <Button variant="primary" type="submit" id="password-save-btn">
              Update Password
            </Button>
          </div>
        </form>
      </div>
    </div>

    <!-- Appearance section -->
    <div id="panel-appearance" class="settings-panel hidden" role="tabpanel">
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6">
        <h2 class="text-lg font-semibold text-dark mb-1">Appearance</h2>
        <p class="text-sm text-muted mb-6">Customize how Orbiter looks</p>

        <form id="appearance-form" class="flex flex-col gap-4">
          <Select
            label="Theme"
            name="theme"
            options={themeOptions}
          />
          <p class="text-xs text-muted">
            System mode follows your operating system preference.
          </p>
          <div class="flex justify-end mt-2">
            <Button variant="primary" type="submit" id="appearance-save">
              Save
            </Button>
          </div>
        </form>
        <div id="appearance-saved" class="hidden text-sm text-zen-green mt-3">Theme preference saved.</div>
      </div>
    </div>

    <!-- Models section -->
    <div id="panel-models" class="settings-panel hidden" role="tabpanel">
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-lg font-semibold text-dark mb-1 inline-flex items-center gap-2">Model Providers <HelpTooltip text="Add API keys for OpenAI, Anthropic, Gemini, etc. to use them in agents." href="/docs/agents" /></h2>
            <p class="text-sm text-muted">Configure API keys and provider connections</p>
          </div>
          <Button variant="primary" id="add-provider-btn">
            <span set:html={plusIcon} />
            Add Provider
          </Button>
        </div>

        <!-- Loading state -->
        <div id="providers-loading" class="text-sm text-muted py-4">Loading providers...</div>

        <!-- Provider cards list -->
        <div id="providers-list" class="hidden flex flex-col gap-3"></div>

        <!-- Empty state -->
        <div id="providers-empty" class="hidden flex flex-col items-center py-8 text-center">
          <svg class="h-10 w-10 text-muted/40 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
            <line x1="8" y1="21" x2="16" y2="21" />
            <line x1="12" y1="17" x2="12" y2="21" />
          </svg>
          <p class="text-sm text-muted max-w-xs">
            No providers configured yet. Add a provider to start using AI models.
          </p>
        </div>
      </div>
    </div>

    <!-- Knowledge / Vector Store section -->
    <div id="panel-knowledge" class="settings-panel hidden" role="tabpanel">
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-lg font-semibold text-dark mb-1">Vector Store</h2>
            <p class="text-sm text-muted">Configure the vector store backend used for embeddings and similarity search</p>
          </div>
          <!-- Status indicator -->
          <div id="vs-status" class="flex items-center gap-2">
            <span id="vs-status-dot" class="inline-block h-2.5 w-2.5 rounded-full bg-muted"></span>
            <span id="vs-status-text" class="text-xs text-muted">Loading...</span>
          </div>
        </div>

        <!-- Loading state -->
        <div id="vs-loading" class="text-sm text-muted py-4">Loading vector store configuration...</div>

        <!-- Config form -->
        <form id="vs-form" class="hidden flex flex-col gap-5">
          <!-- Backend selector -->
          <div class="flex flex-col gap-1.5">
            <label for="vs-backend" class="text-sm font-medium text-dark">Backend</label>
            <select
              id="vs-backend"
              name="backend"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer"
            >
              <option value="sqlite_vss">SQLite-VSS (default, built-in)</option>
              <option value="milvus">Milvus / Zilliz</option>
              <option value="qdrant">Qdrant</option>
              <option value="chromadb">ChromaDB</option>
              <option value="pinecone">Pinecone</option>
            </select>
            <p class="text-xs text-muted">SQLite-VSS requires no external service. Other backends need connection details.</p>
          </div>

          <!-- Connection fields (shown for external backends) -->
          <div id="vs-connection-fields" class="hidden flex flex-col gap-4 rounded-lg border border-dark/[0.06] bg-paper p-4">
            <h3 class="text-sm font-medium text-dark">Connection</h3>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="flex flex-col gap-1.5" id="vs-host-group">
                <label for="vs-host" class="text-xs font-medium text-dark">Host</label>
                <input
                  id="vs-host"
                  name="host"
                  type="text"
                  placeholder="localhost"
                  class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
                />
              </div>
              <div class="flex flex-col gap-1.5" id="vs-port-group">
                <label for="vs-port" class="text-xs font-medium text-dark">Port</label>
                <input
                  id="vs-port"
                  name="port"
                  type="number"
                  min="1"
                  max="65535"
                  placeholder="19530"
                  class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
                />
              </div>
            </div>

            <div class="flex flex-col gap-1.5" id="vs-apikey-group">
              <label for="vs-apikey" class="text-xs font-medium text-dark">API Key</label>
              <input
                id="vs-apikey"
                name="api_key"
                type="password"
                placeholder="Leave blank to keep current key"
                class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              />
            </div>

            <div class="flex flex-col gap-1.5" id="vs-collection-group">
              <label for="vs-collection" class="text-xs font-medium text-dark">Collection Name</label>
              <input
                id="vs-collection"
                name="collection_name"
                type="text"
                placeholder="orbiter"
                class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              />
            </div>
          </div>

          <!-- Error display -->
          <div id="vs-error" class="text-sm text-coral hidden"></div>

          <!-- Actions -->
          <div class="flex items-center justify-between">
            <button
              type="button"
              id="vs-test-btn"
              class="inline-flex items-center gap-1.5 text-sm px-3 py-1.5 rounded-lg text-muted border border-dark/[0.08] hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
            >
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              Test Connection
            </button>
            <button
              type="submit"
              id="vs-save-btn"
              class="inline-flex items-center gap-1.5 text-sm px-4 py-2 rounded-lg bg-coral text-white hover:bg-coral/90 transition-colors cursor-pointer font-medium"
            >
              Save
            </button>
          </div>

          <!-- Test result -->
          <div id="vs-test-result" class="hidden text-sm rounded-lg border px-4 py-3"></div>
        </form>

        <!-- Saved confirmation -->
        <div id="vs-saved" class="hidden text-sm text-zen-green mt-3">Vector store configuration saved.</div>
      </div>
    </div>

    <!-- Pricing section -->
    <div id="panel-pricing" class="settings-panel hidden" role="tabpanel">
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-lg font-semibold text-dark mb-1">Model Pricing</h2>
            <p class="text-sm text-muted">Configure per-token pricing for cost estimation</p>
          </div>
        </div>

        <div id="pricing-loading" class="text-sm text-muted py-4">Loading pricing data...</div>

        <div id="pricing-table-wrap" class="hidden">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-dark/[0.08]">
                <th class="text-left text-xs font-medium text-muted uppercase tracking-wide py-2 pr-4">Model</th>
                <th class="text-right text-xs font-medium text-muted uppercase tracking-wide py-2 px-4">Input (per 1K tokens)</th>
                <th class="text-right text-xs font-medium text-muted uppercase tracking-wide py-2 pl-4">Output (per 1K tokens)</th>
              </tr>
            </thead>
            <tbody id="pricing-tbody" class="divide-y divide-dark/[0.04]"></tbody>
          </table>
        </div>

        <div id="pricing-empty" class="hidden flex flex-col items-center py-8 text-center">
          <p class="text-sm text-muted">No pricing data available.</p>
        </div>

        <div id="pricing-saved" class="hidden text-sm text-zen-green mt-3">Pricing updated.</div>
      </div>
    </div>

    <!-- Workspace section -->
    <div id="panel-workspace" class="settings-panel hidden" role="tabpanel">
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6">
        <h2 class="text-lg font-semibold text-dark mb-1">Workspace</h2>
        <p class="text-sm text-muted mb-6">Configure default workspace behavior</p>

        <form id="workspace-form" class="flex flex-col gap-4">
          <Select
            label="Default Model Provider"
            name="default_provider"
            options={providerOptions}
          />
          <div class="flex flex-col gap-1.5">
            <label for="workspace-default-model" class="text-sm font-medium text-dark">Default Model</label>
            <select
              id="workspace-default-model"
              name="default_model"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer"
            >
              <option value="">None</option>
            </select>
            <p class="text-xs text-muted">Default model for new agent runs across the workspace.</p>
          </div>
          <Input
            label="Concurrent Run Limit"
            name="concurrent_limit"
            type="number"
            min="1"
            max="20"
            value="5"
            placeholder="5"
          />
          <p class="text-xs text-muted">
            Maximum number of agent runs that can execute simultaneously.
          </p>
          <div class="flex justify-end mt-2">
            <Button variant="primary" type="submit" id="workspace-save">
              Save
            </Button>
          </div>
        </form>
        <div id="workspace-saved" class="hidden text-sm text-zen-green mt-3">Workspace settings saved.</div>
      </div>
    </div>

    <!-- Team section (admin only) -->
    <div id="panel-team" class="settings-panel hidden" role="tabpanel">
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-lg font-semibold text-dark mb-1">Team</h2>
            <p class="text-sm text-muted">Manage team members and roles</p>
          </div>
          <Button variant="primary" id="invite-user-btn">
            <span set:html={plusIcon} />
            Invite User
          </Button>
        </div>

        <!-- Loading state -->
        <div id="team-loading" class="text-sm text-muted py-4">Loading team members...</div>

        <!-- Team table -->
        <div id="team-table-wrap" class="hidden">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-dark/[0.08]">
                <th class="text-left text-xs font-medium text-muted uppercase tracking-wide py-2 pr-4">Email</th>
                <th class="text-left text-xs font-medium text-muted uppercase tracking-wide py-2 px-4">Role</th>
                <th class="text-left text-xs font-medium text-muted uppercase tracking-wide py-2 px-4">Joined</th>
                <th class="text-right text-xs font-medium text-muted uppercase tracking-wide py-2 pl-4">Actions</th>
              </tr>
            </thead>
            <tbody id="team-tbody" class="divide-y divide-dark/[0.04]"></tbody>
          </table>
        </div>

        <!-- Empty state -->
        <div id="team-empty" class="hidden flex flex-col items-center py-8 text-center">
          <p class="text-sm text-muted">No team members found.</p>
        </div>
      </div>
    </div>

    <!-- Integrations section -->
    <div id="panel-integrations" class="settings-panel hidden" role="tabpanel">
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-lg font-semibold text-dark mb-1">MCP Servers</h2>
            <p class="text-sm text-muted">Connect to Model Context Protocol servers for external tool discovery</p>
          </div>
          <Button variant="primary" id="add-mcp-server-btn">
            <span set:html={plusIcon} />
            Add Server
          </Button>
        </div>

        <!-- Loading state -->
        <div id="mcp-loading" class="text-sm text-muted py-4">Loading MCP servers...</div>

        <!-- Server list -->
        <div id="mcp-server-list" class="hidden flex flex-col gap-3"></div>

        <!-- Empty state -->
        <div id="mcp-empty" class="hidden flex flex-col items-center py-8 text-center">
          <div class="w-12 h-12 rounded-full bg-muted/10 flex items-center justify-center mb-3">
            <svg class="h-6 w-6 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          </div>
          <p class="text-sm text-muted">No MCP servers connected.</p>
          <p class="text-xs text-muted/70 mt-1">Add a server to discover external tools.</p>
        </div>
      </div>

      <!-- Discovered Tools section -->
      <div id="mcp-tools-section" class="hidden rounded-xl bg-subtle/80 border border-dark/[0.08] p-6 mt-4">
        <h3 class="text-base font-semibold text-dark mb-1">Discovered Tools</h3>
        <p class="text-sm text-muted mb-4">Tools discovered from connected MCP servers</p>
        <div id="mcp-tools-list" class="flex flex-col gap-2"></div>
        <div id="mcp-tools-empty" class="hidden text-sm text-muted py-4 text-center">
          No tools discovered yet. Click "Discover Tools" on a connected server.
        </div>
      </div>

      <!-- Observability Integrations section -->
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6 mt-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-lg font-semibold text-dark mb-1">Observability</h2>
            <p class="text-sm text-muted">Export traces to external observability platforms</p>
          </div>
          <Button variant="primary" id="add-obs-btn">
            <span set:html={plusIcon} />
            Add Integration
          </Button>
        </div>

        <!-- Loading state -->
        <div id="obs-loading" class="text-sm text-muted py-4">Loading integrations...</div>

        <!-- Integration list -->
        <div id="obs-list" class="hidden flex flex-col gap-3"></div>

        <!-- Empty state -->
        <div id="obs-empty" class="hidden flex flex-col items-center py-8 text-center">
          <div class="w-12 h-12 rounded-full bg-muted/10 flex items-center justify-center mb-3">
            <svg class="h-6 w-6 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></svg>
          </div>
          <p class="text-sm text-muted">No observability integrations configured.</p>
          <p class="text-xs text-muted/70 mt-1">Add an integration to export traces to external platforms.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Add MCP Server Modal -->
  <Modal id="add-mcp-modal" title="Add MCP Server">
    <form id="add-mcp-form" class="flex flex-col gap-4">
      <Input
        label="Display Name"
        name="name"
        placeholder="e.g. My MCP Server"
        required
      />
      <Input
        label="Server URL"
        name="url"
        placeholder="https://mcp.example.com/rpc"
        required
      />
      <Select
        label="Authentication"
        name="auth_type"
        options={[
          { value: "none", label: "None" },
          { value: "bearer", label: "Bearer Token" },
          { value: "api_key", label: "API Key" },
        ]}
      />
      <div id="mcp-auth-bearer" class="hidden">
        <Input
          label="Bearer Token"
          name="auth_token"
          type="password"
          placeholder="Enter bearer token"
        />
      </div>
      <div id="mcp-auth-apikey" class="hidden flex flex-col gap-4">
        <Input
          label="API Key"
          name="auth_key"
          type="password"
          placeholder="Enter API key"
        />
        <Input
          label="Header Name"
          name="auth_header"
          placeholder="X-API-Key"
        />
      </div>
      <div id="add-mcp-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="add-mcp-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="add-mcp-submit">
          Add Server
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Edit MCP Server Modal -->
  <Modal id="edit-mcp-modal" title="Edit MCP Server">
    <form id="edit-mcp-form" class="flex flex-col gap-4">
      <input type="hidden" name="server_id" />
      <Input
        label="Display Name"
        name="name"
        placeholder="e.g. My MCP Server"
        required
      />
      <Input
        label="Server URL"
        name="url"
        placeholder="https://mcp.example.com/rpc"
        required
      />
      <Select
        label="Authentication"
        name="auth_type"
        options={[
          { value: "none", label: "None" },
          { value: "bearer", label: "Bearer Token" },
          { value: "api_key", label: "API Key" },
        ]}
      />
      <div id="edit-mcp-auth-bearer" class="hidden">
        <Input
          label="Bearer Token"
          name="auth_token"
          type="password"
          placeholder="Enter bearer token"
        />
      </div>
      <div id="edit-mcp-auth-apikey" class="hidden flex flex-col gap-4">
        <Input
          label="API Key"
          name="auth_key"
          type="password"
          placeholder="Enter API key"
        />
        <Input
          label="Header Name"
          name="auth_header"
          placeholder="X-API-Key"
        />
      </div>
      <div id="edit-mcp-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="edit-mcp-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="edit-mcp-submit">
          Save Changes
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Delete MCP Server Confirmation -->
  <Modal id="delete-mcp-modal" title="Delete MCP Server">
    <p class="text-sm text-muted mb-2">Are you sure you want to delete this MCP server? All discovered tools from this server will also be removed.</p>
    <p id="delete-mcp-name" class="text-sm font-medium text-dark mb-4"></p>
    <div class="flex justify-end gap-3">
      <Button variant="default" type="button" data-modal-close="delete-mcp-modal">
        Cancel
      </Button>
      <Button variant="primary" type="button" id="confirm-delete-mcp" class="!bg-coral hover:!bg-coral/90 text-white">
        Delete Server
      </Button>
    </div>
  </Modal>

  <!-- Add Observability Integration Modal -->
  <Modal id="add-obs-modal" title="Add Observability Integration">
    <form id="add-obs-form" class="flex flex-col gap-4">
      <Select
        label="Platform"
        name="platform"
        options={[
          { value: "langfuse", label: "Langfuse" },
          { value: "langsmith", label: "LangSmith" },
          { value: "datadog", label: "Datadog" },
          { value: "opik", label: "Opik" },
          { value: "custom_webhook", label: "Custom Webhook" },
        ]}
        required
      />
      <Input
        label="Display Name"
        name="display_name"
        placeholder="e.g. Production Langfuse"
        required
      />
      <Input
        label="Endpoint URL"
        name="endpoint_url"
        placeholder="Will use platform default if empty"
      />
      <Input
        label="API Key"
        name="api_key"
        type="password"
        placeholder="Enter API key"
      />
      <div id="obs-add-langfuse-extra" class="hidden">
        <Input
          label="Public Key (Langfuse)"
          name="public_key"
          placeholder="pk-lf-..."
        />
      </div>
      <Input
        label="Project / Dataset Name"
        name="project_name"
        placeholder="e.g. my-project"
      />
      <div id="add-obs-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="add-obs-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="add-obs-submit">
          Add Integration
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Edit Observability Integration Modal -->
  <Modal id="edit-obs-modal" title="Edit Observability Integration">
    <form id="edit-obs-form" class="flex flex-col gap-4">
      <input type="hidden" name="integration_id" />
      <Input
        label="Display Name"
        name="display_name"
        placeholder="e.g. Production Langfuse"
        required
      />
      <Input
        label="Endpoint URL"
        name="endpoint_url"
        placeholder="Endpoint URL"
      />
      <Input
        label="API Key (leave blank to keep current)"
        name="api_key"
        type="password"
        placeholder="Enter new API key"
      />
      <div id="obs-edit-langfuse-extra" class="hidden">
        <Input
          label="Public Key (Langfuse)"
          name="public_key"
          placeholder="pk-lf-..."
        />
      </div>
      <Input
        label="Project / Dataset Name"
        name="project_name"
        placeholder="e.g. my-project"
      />
      <div id="edit-obs-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="edit-obs-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="edit-obs-submit">
          Save Changes
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Delete Observability Integration Confirmation -->
  <Modal id="delete-obs-modal" title="Delete Integration">
    <p class="text-sm text-muted mb-2">Are you sure you want to delete this observability integration?</p>
    <p id="delete-obs-name" class="text-sm font-medium text-dark mb-4"></p>
    <div class="flex justify-end gap-3">
      <Button variant="default" type="button" data-modal-close="delete-obs-modal">
        Cancel
      </Button>
      <Button variant="primary" type="button" id="confirm-delete-obs" class="!bg-coral hover:!bg-coral/90 text-white">
        Delete Integration
      </Button>
    </div>
  </Modal>

  <!-- Add Provider Modal -->
  <Modal id="add-provider-modal" title="Add Provider">
    <form id="add-provider-form" class="flex flex-col gap-4">
      <Input
        label="Provider Name"
        name="name"
        placeholder="e.g. My OpenAI Account"
        required
      />
      <Select
        label="Provider Type"
        name="provider_type"
        options={providerTypeOptions}
        required
      />
      <Input
        label="API Key"
        name="api_key"
        type="password"
        placeholder="sk-..."
      />
      <Input
        label="Base URL (optional)"
        name="base_url"
        placeholder="https://api.example.com"
      />
      <div id="add-provider-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="add-provider-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="add-provider-submit">
          Add Provider
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Edit Provider Modal -->
  <Modal id="edit-provider-modal" title="Edit Provider">
    <form id="edit-provider-form" class="flex flex-col gap-4">
      <input type="hidden" name="provider_id" />
      <Input
        label="Provider Name"
        name="name"
        required
      />
      <Select
        label="Provider Type"
        name="provider_type"
        options={providerTypeOptions}
        required
      />
      <Input
        label="API Key"
        name="api_key"
        type="password"
        placeholder="Leave blank to keep current key"
      />
      <Input
        label="Base URL (optional)"
        name="base_url"
        placeholder="https://api.example.com"
      />
      <div id="edit-provider-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="edit-provider-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="edit-provider-submit">
          Save Changes
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Delete Confirmation Modal -->
  <Modal id="delete-provider-modal" title="Delete Provider">
    <p class="text-sm text-muted mb-1">Are you sure you want to delete <strong id="delete-provider-name" class="text-dark"></strong>?</p>
    <p class="text-sm text-muted mb-6">This action cannot be undone. All associated API keys will be removed.</p>
    <div class="flex justify-end gap-3">
      <Button variant="default" type="button" data-modal-close="delete-provider-modal">
        Cancel
      </Button>
      <Button variant="primary" type="button" id="confirm-delete-btn" class="!bg-coral !text-white">
        Delete Provider
      </Button>
    </div>
  </Modal>

  <!-- Delete Key Confirmation Modal -->
  <Modal id="delete-key-modal" title="Delete API Key">
    <p class="text-sm text-muted mb-1">Are you sure you want to delete key <strong id="delete-key-label" class="text-dark"></strong>?</p>
    <p class="text-sm text-muted mb-6">This action cannot be undone.</p>
    <div class="flex justify-end gap-3">
      <Button variant="default" type="button" data-modal-close="delete-key-modal">
        Cancel
      </Button>
      <Button variant="primary" type="button" id="confirm-delete-key-btn" class="!bg-coral !text-white">
        Delete Key
      </Button>
    </div>
  </Modal>

  <!-- Invite User Modal -->
  <Modal id="invite-user-modal" title="Invite User">
    <form id="invite-user-form" class="flex flex-col gap-4">
      <Input
        label="Email"
        name="email"
        type="email"
        placeholder="user@example.com"
        required
      />
      <Input
        label="Temporary Password"
        name="password"
        type="password"
        placeholder="Min 8 characters"
        required
      />
      <Select
        label="Role"
        name="role"
        options={[
          { value: "viewer", label: "Viewer" },
          { value: "developer", label: "Developer" },
          { value: "admin", label: "Admin" },
        ]}
      />
      <div id="invite-user-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="invite-user-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="invite-user-submit">
          Invite
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Remove User Confirmation Modal -->
  <Modal id="remove-user-modal" title="Remove User">
    <p class="text-sm text-muted mb-1">Are you sure you want to remove <strong id="remove-user-email" class="text-dark"></strong>?</p>
    <p class="text-sm text-muted mb-6">Their sessions will be revoked and they will no longer be able to log in.</p>
    <div class="flex justify-end gap-3">
      <Button variant="default" type="button" data-modal-close="remove-user-modal">
        Cancel
      </Button>
      <Button variant="primary" type="button" id="confirm-remove-user-btn" class="!bg-coral !text-white">
        Remove User
      </Button>
    </div>
  </Modal>
</PageLayout>

<!-- Provider card template -->
<template id="provider-card-template">
  <div class="rounded-lg border border-dark/[0.08] bg-paper p-4 transition-all duration-200 hover:border-dark/20">
    <div class="flex items-start justify-between">
      <div class="flex items-center gap-3 min-w-0">
        <div class="flex-shrink-0 h-10 w-10 rounded-lg bg-dark/5 flex items-center justify-center" data-field="icon"></div>
        <div class="min-w-0">
          <h3 class="font-medium text-dark text-sm truncate" data-field="name"></h3>
          <p class="text-xs text-muted" data-field="type"></p>
        </div>
      </div>
      <div class="flex items-center gap-1.5 flex-shrink-0">
        <span class="provider-status inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full" data-field="status"></span>
      </div>
    </div>
    <div class="flex items-center justify-between mt-3 pt-3 border-t border-dark/[0.06]">
      <div class="flex items-center gap-2">
        <span class="text-xs text-muted" data-field="key-info"></span>
      </div>
      <div class="flex items-center gap-1">
        <button type="button" class="provider-keys-btn inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-md text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer" title="Manage Keys">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
          Keys
        </button>
        <button type="button" class="provider-test-btn inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-md text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer" title="Test Connection">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          Test
        </button>
        <button type="button" class="provider-edit-btn inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-md text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer" title="Edit">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          Edit
        </button>
        <button type="button" class="provider-delete-btn inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-md text-muted hover:bg-coral/10 hover:text-coral transition-colors cursor-pointer" title="Delete">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          Delete
        </button>
      </div>
    </div>
    <!-- Test result row (hidden by default) -->
    <div class="provider-test-result hidden mt-3 pt-3 border-t border-dark/[0.06] text-xs"></div>
    <!-- Keys management section (hidden by default) -->
    <div class="provider-keys-section hidden mt-3 pt-3 border-t border-dark/[0.06]">
      <!-- Strategy selector -->
      <div class="flex items-center justify-between mb-3">
        <label class="text-xs font-medium text-dark">Load Balancing</label>
        <select class="keys-strategy-select text-xs bg-paper border border-dark/[0.08] rounded-md px-2 py-1 text-dark cursor-pointer focus:outline-none focus:ring-1 focus:ring-coral/30">
          <option value="round_robin">Round Robin</option>
          <option value="random">Random</option>
          <option value="least_recently_used">Least Recently Used</option>
        </select>
      </div>
      <!-- Key list -->
      <div class="keys-list flex flex-col gap-2 mb-3"></div>
      <!-- Keys empty state -->
      <div class="keys-empty hidden text-xs text-muted text-center py-3">No API keys configured for this provider.</div>
      <!-- Add key inline form -->
      <div class="flex gap-2 items-end">
        <div class="flex-1">
          <input type="password" class="key-input-value w-full text-xs bg-paper border border-dark/[0.08] rounded-md px-2.5 py-1.5 text-dark placeholder:text-muted/60 focus:outline-none focus:ring-1 focus:ring-coral/30" placeholder="sk-... or API key" />
        </div>
        <div class="w-28">
          <input type="text" class="key-input-label w-full text-xs bg-paper border border-dark/[0.08] rounded-md px-2.5 py-1.5 text-dark placeholder:text-muted/60 focus:outline-none focus:ring-1 focus:ring-coral/30" placeholder="Label" />
        </div>
        <button type="button" class="key-add-btn inline-flex items-center gap-1 text-xs px-2.5 py-1.5 rounded-md bg-dark text-paper hover:bg-dark/90 transition-colors cursor-pointer flex-shrink-0">
          <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add
        </button>
      </div>
      <div class="key-add-error hidden text-xs text-coral mt-1"></div>
    </div>
  </div>
</template>

<!-- Key row template -->
<template id="key-row-template">
  <div class="flex items-center justify-between rounded-md border border-dark/[0.06] px-3 py-2 bg-subtle/40">
    <div class="flex items-center gap-2 min-w-0">
      <span class="key-status-dot inline-block h-2 w-2 rounded-full flex-shrink-0"></span>
      <span class="key-label text-xs font-medium text-dark truncate"></span>
      <span class="key-status-text text-xs text-muted"></span>
    </div>
    <div class="flex items-center gap-3 flex-shrink-0">
      <div class="flex items-center gap-3 text-xs text-muted">
        <span class="key-stat-requests" title="Total requests"></span>
        <span class="key-stat-tokens" title="Total tokens"></span>
        <span class="key-stat-errors" title="Errors"></span>
        <span class="key-stat-last-used" title="Last used"></span>
      </div>
      <button type="button" class="key-delete-btn text-muted hover:text-coral transition-colors cursor-pointer" title="Delete key">
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
      </button>
    </div>
  </div>
</template>

<script is:inline>
  (function () {
    // ------- Tab switching -------
    var tabs = document.querySelectorAll(".settings-tab");
    var panels = document.querySelectorAll(".settings-panel");

    tabs.forEach(function (tab) {
      tab.addEventListener("click", function () {
        var target = tab.getAttribute("data-settings-tab");

        // Update tab styles
        tabs.forEach(function (t) {
          t.classList.remove("text-coral", "border-coral");
          t.classList.add("text-muted", "border-transparent");
          t.setAttribute("aria-selected", "false");
        });
        tab.classList.remove("text-muted", "border-transparent");
        tab.classList.add("text-coral", "border-coral");
        tab.setAttribute("aria-selected", "true");

        // Show target panel, hide others
        panels.forEach(function (p) {
          p.classList.add("hidden");
        });
        var panel = document.getElementById("panel-" + target);
        if (panel) panel.classList.remove("hidden");

        // Load providers when Models tab is first shown
        if (target === "models" && !providersLoaded) {
          fetchProviders();
        }

        // Load vector store config when Knowledge tab is first shown
        if (target === "knowledge" && !vsLoaded) {
          fetchVectorStoreConfig();
        }

        // Load pricing when Pricing tab is first shown
        if (target === "pricing" && !pricingLoaded) {
          fetchPricingData();
        }

        // Load team members when Team tab is first shown
        if (target === "team" && !teamLoaded) {
          fetchTeamMembers();
        }

        // Load MCP servers when Integrations tab is first shown
        if (target === "integrations" && !mcpLoaded) {
          fetchMcpServers();
        }

        // Load observability integrations when Integrations tab is first shown
        if (target === "integrations" && !obsLoaded) {
          fetchObsIntegrations();
        }
      });
    });

    // ------- Profile -------
    var profileLoading = document.getElementById("profile-loading");
    var profileSection = document.getElementById("profile-section");
    var passwordSection = document.getElementById("password-section");
    var logoutBtn = document.getElementById("logout-btn");
    var currentUserEmail = "";

    // Role badge colors
    var roleBadgeStyles = {
      admin: "bg-coral/15 text-coral border-coral/20",
      developer: "bg-zen-blue/15 text-zen-blue border-zen-blue/20",
      viewer: "bg-dark/10 text-dark border-dark/10"
    };

    fetch("/api/v1/auth/me", { credentials: "same-origin" })
      .then(function (res) {
        if (!res.ok) throw new Error("Not authenticated");
        return res.json();
      })
      .then(function (user) {
        if (profileLoading) profileLoading.classList.add("hidden");
        if (profileSection) profileSection.classList.remove("hidden");
        if (passwordSection) passwordSection.classList.remove("hidden");

        currentUserEmail = user.email;

        // Email
        var emailValue = document.getElementById("email-value");
        if (emailValue) emailValue.textContent = user.email;

        // Role badge
        var roleBadge = document.getElementById("role-badge");
        if (roleBadge) {
          var roleLabel = user.role.charAt(0).toUpperCase() + user.role.slice(1);
          roleBadge.textContent = roleLabel;
          var style = roleBadgeStyles[user.role] || roleBadgeStyles.viewer;
          roleBadge.className = "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-medium " + style;
        }

        // Member since
        var memberSince = document.getElementById("member-since");
        if (memberSince) {
          try {
            var d = new Date(user.created_at + "Z");
            memberSince.textContent = d.toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });
          } catch (_e) {
            memberSince.textContent = user.created_at;
          }
        }
      })
      .catch(function () {
        if (profileLoading) profileLoading.textContent = "Could not load profile.";
      });

    // Email editing
    var emailDisplay = document.getElementById("email-display");
    var emailEditForm = document.getElementById("email-edit-form");
    var emailEditInput = document.getElementById("email-edit-input");
    var emailEditBtn = document.getElementById("email-edit-btn");
    var emailSaveBtn = document.getElementById("email-save-btn");
    var emailCancelBtn = document.getElementById("email-cancel-btn");

    if (emailEditBtn) {
      emailEditBtn.addEventListener("click", function () {
        if (emailEditInput) emailEditInput.value = currentUserEmail;
        if (emailDisplay) emailDisplay.classList.add("hidden");
        if (emailEditForm) emailEditForm.classList.remove("hidden");
        if (emailEditInput) emailEditInput.focus();
      });
    }

    if (emailCancelBtn) {
      emailCancelBtn.addEventListener("click", function () {
        if (emailEditForm) emailEditForm.classList.add("hidden");
        if (emailDisplay) emailDisplay.classList.remove("hidden");
      });
    }

    if (emailSaveBtn) {
      emailSaveBtn.addEventListener("click", function () {
        var newEmail = emailEditInput ? emailEditInput.value.trim() : "";
        if (!newEmail) return;
        if (newEmail === currentUserEmail) {
          if (emailEditForm) emailEditForm.classList.add("hidden");
          if (emailDisplay) emailDisplay.classList.remove("hidden");
          return;
        }

        emailSaveBtn.disabled = true;
        fetch("/api/v1/auth/profile", {
          method: "PUT",
          credentials: "same-origin",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: newEmail })
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (b) { throw new Error(b.detail || "Failed to update email"); });
            return res.json();
          })
          .then(function (updated) {
            currentUserEmail = updated.email;
            var emailValue = document.getElementById("email-value");
            if (emailValue) emailValue.textContent = updated.email;
            if (emailEditForm) emailEditForm.classList.add("hidden");
            if (emailDisplay) emailDisplay.classList.remove("hidden");
            showToast("Email updated", "success");
          })
          .catch(function (err) {
            showToast(err.message, "error");
          })
          .finally(function () {
            emailSaveBtn.disabled = false;
          });
      });
    }

    // Change password
    var passwordForm = document.getElementById("password-form");
    var passwordError = document.getElementById("password-error");

    if (passwordForm) {
      passwordForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (passwordError) { passwordError.classList.add("hidden"); passwordError.textContent = ""; }

        var currentPw = document.getElementById("current-password").value;
        var newPw = document.getElementById("new-password").value;
        var confirmPw = document.getElementById("confirm-password").value;

        if (newPw.length < 8) {
          if (passwordError) { passwordError.textContent = "New password must be at least 8 characters"; passwordError.classList.remove("hidden"); }
          return;
        }
        if (newPw !== confirmPw) {
          if (passwordError) { passwordError.textContent = "Passwords do not match"; passwordError.classList.remove("hidden"); }
          return;
        }

        var saveBtn = document.getElementById("password-save-btn");
        if (saveBtn) saveBtn.disabled = true;

        fetch("/api/v1/auth/password", {
          method: "PUT",
          credentials: "same-origin",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ current_password: currentPw, new_password: newPw })
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (b) { throw new Error(b.detail || "Failed to change password"); });
            return res.json();
          })
          .then(function () {
            passwordForm.reset();
            showToast("Password updated", "success");
          })
          .catch(function (err) {
            showToast(err.message, "error");
          })
          .finally(function () {
            if (saveBtn) saveBtn.disabled = false;
          });
      });
    }

    // Logout
    if (logoutBtn) {
      logoutBtn.addEventListener("click", function () {
        fetch("/api/v1/auth/logout", { method: "POST", credentials: "same-origin" })
          .then(function () {
            if (window.clearCsrfToken) window.clearCsrfToken();
            window.location.replace("/login");
          })
          .catch(function () {
            if (window.clearCsrfToken) window.clearCsrfToken();
            window.location.replace("/login");
          });
      });
    }

    // Show Tour Again
    var showTourBtn = document.getElementById("show-tour-btn");
    if (showTourBtn) {
      showTourBtn.addEventListener("click", function () {
        if (window.__orbiterStartTour) {
          window.__orbiterStartTour();
        }
      });
    }

    // ------- Appearance -------
    var appearanceForm = document.getElementById("appearance-form");
    var appearanceSaved = document.getElementById("appearance-saved");

    // Initialise theme select from current preference
    var themeSelect = appearanceForm ? appearanceForm.querySelector('[name="theme"]') : null;
    if (themeSelect) {
      var stored = localStorage.getItem("theme");
      if (stored === "dark" || stored === "light") {
        themeSelect.value = stored;
      } else {
        themeSelect.value = "system";
      }
    }

    if (appearanceForm) {
      appearanceForm.addEventListener("submit", function (e) {
        e.preventDefault();
        var selected = themeSelect ? themeSelect.value : "system";

        if (selected === "system") {
          localStorage.removeItem("theme");
          var preferred = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
          document.documentElement.setAttribute("data-theme", preferred);
        } else {
          localStorage.setItem("theme", selected);
          document.documentElement.setAttribute("data-theme", selected);
        }

        // Update theme icons in PageLayout top bar
        var lightIcon = document.getElementById("theme-icon-light");
        var darkIcon = document.getElementById("theme-icon-dark");
        if (lightIcon && darkIcon) {
          var current = document.documentElement.getAttribute("data-theme");
          if (current === "dark") {
            lightIcon.classList.add("hidden");
            darkIcon.classList.remove("hidden");
          } else {
            lightIcon.classList.remove("hidden");
            darkIcon.classList.add("hidden");
          }
        }

        if (appearanceSaved) {
          appearanceSaved.classList.remove("hidden");
          setTimeout(function () {
            appearanceSaved.classList.add("hidden");
          }, 2000);
        }
      });
    }

    // ------- Models / Providers -------
    var providersLoaded = false;
    var providersData = [];
    var providersList = document.getElementById("providers-list");
    var providersLoading = document.getElementById("providers-loading");
    var providersEmpty = document.getElementById("providers-empty");
    var addProviderBtn = document.getElementById("add-provider-btn");
    var addModal = document.getElementById("add-provider-modal");
    var addForm = document.getElementById("add-provider-form");
    var addError = document.getElementById("add-provider-error");
    var addSubmit = document.getElementById("add-provider-submit");
    var editModal = document.getElementById("edit-provider-modal");
    var editForm = document.getElementById("edit-provider-form");
    var editError = document.getElementById("edit-provider-error");
    var editSubmit = document.getElementById("edit-provider-submit");
    var deleteModal = document.getElementById("delete-provider-modal");
    var deleteNameEl = document.getElementById("delete-provider-name");
    var confirmDeleteBtn = document.getElementById("confirm-delete-btn");
    var cardTemplate = document.getElementById("provider-card-template");

    var deleteTargetId = null;

    var providerIcons = {
      openai: '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494zM3.6 18.304a4.47 4.47 0 0 1-.535-3.014l.142.085 4.783 2.759a.771.771 0 0 0 .78 0l5.843-3.369v2.332a.08.08 0 0 1-.033.062L9.74 19.95a4.5 4.5 0 0 1-6.14-1.646zM2.34 7.896a4.485 4.485 0 0 1 2.366-1.973V11.6a.766.766 0 0 0 .388.676l5.815 3.355-2.02 1.168a.076.076 0 0 1-.071 0l-4.83-2.786A4.504 4.504 0 0 1 2.34 7.872zm16.597 3.855l-5.833-3.387L15.119 7.2a.076.076 0 0 1 .071 0l4.83 2.791a4.494 4.494 0 0 1-.676 8.105v-5.678a.79.79 0 0 0-.407-.667zm2.01-3.023l-.141-.085-4.774-2.782a.776.776 0 0 0-.785 0L9.409 9.23V6.897a.066.066 0 0 1 .028-.061l4.83-2.787a4.5 4.5 0 0 1 6.68 4.66zm-12.64 4.135l-2.02-1.164a.08.08 0 0 1-.038-.057V6.075a4.5 4.5 0 0 1 7.375-3.453l-.142.08L8.704 5.46a.795.795 0 0 0-.393.681zm1.097-2.365l2.602-1.5 2.607 1.5v2.999l-2.597 1.5-2.607-1.5z"/></svg>',
      anthropic: '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M13.827 3.52h3.603L24 20.48h-3.603l-6.57-16.96zm-7.258 0h3.767L16.906 20.48h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm1.21 5.175l-2.33 5.987h4.656l-2.326-5.987z"/></svg>',
      gemini: '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm0 3.6c4.638 0 8.4 3.762 8.4 8.4s-3.762 8.4-8.4 8.4-8.4-3.762-8.4-8.4S7.362 3.6 12 3.6z"/></svg>',
      vertex: '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm0 3.6c4.638 0 8.4 3.762 8.4 8.4s-3.762 8.4-8.4 8.4-8.4-3.762-8.4-8.4S7.362 3.6 12 3.6z"/></svg>',
      ollama: '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><circle cx="12" cy="12" r="4"/></svg>',
      custom: '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>'
    };

    var providerLabels = {
      openai: "OpenAI",
      anthropic: "Anthropic",
      gemini: "Google Gemini",
      vertex: "Google Vertex AI",
      ollama: "Ollama",
      custom: "Custom"
    };

    function fetchProviders() {
      fetch("/api/v1/providers")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load providers");
          return res.json();
        })
        .then(function (data) {
          providersLoaded = true;
          providersData = data;
          renderProviders(data);
        })
        .catch(function () {
          if (providersLoading) providersLoading.textContent = "Failed to load providers. Is the API server running?";
        });
    }

    var keyRowTemplate = document.getElementById("key-row-template");
    var deleteKeyModal = document.getElementById("delete-key-modal");
    var deleteKeyLabel = document.getElementById("delete-key-label");
    var confirmDeleteKeyBtn = document.getElementById("confirm-delete-key-btn");
    var deleteKeyTargetId = null;
    var deleteKeyProviderId = null;
    var deleteKeyCardEl = null;

    // Cooldown timers - track intervals so we can clear them
    var cooldownIntervals = {};

    function renderProviders(providers) {
      if (providersLoading) providersLoading.classList.add("hidden");

      // Clear all cooldown intervals
      Object.keys(cooldownIntervals).forEach(function (k) {
        clearInterval(cooldownIntervals[k]);
        delete cooldownIntervals[k];
      });

      if (!providers || providers.length === 0) {
        providersList.classList.add("hidden");
        providersEmpty.classList.remove("hidden");
        return;
      }

      providersEmpty.classList.add("hidden");
      providersList.classList.remove("hidden");
      providersList.innerHTML = "";

      providers.forEach(function (provider) {
        var card = cardTemplate.content.cloneNode(true);
        var container = card.querySelector("div");
        container.setAttribute("data-provider-id", provider.id);

        // Icon
        var iconEl = card.querySelector('[data-field="icon"]');
        iconEl.innerHTML = providerIcons[provider.provider_type] || providerIcons.custom;

        // Name
        var nameEl = card.querySelector('[data-field="name"]');
        nameEl.textContent = provider.name;

        // Type label
        var typeEl = card.querySelector('[data-field="type"]');
        typeEl.textContent = providerLabels[provider.provider_type] || provider.provider_type;

        // Status
        var statusEl = card.querySelector('[data-field="status"]');
        if (provider.api_key_set) {
          statusEl.innerHTML = '<span class="inline-block h-1.5 w-1.5 rounded-full bg-zen-green"></span> Connected';
          statusEl.classList.add("bg-zen-green/10", "text-zen-green");
        } else {
          statusEl.innerHTML = '<span class="inline-block h-1.5 w-1.5 rounded-full bg-muted"></span> No Key';
          statusEl.classList.add("bg-dark/5", "text-muted");
        }

        // Key info
        var keyInfoEl = card.querySelector('[data-field="key-info"]');
        keyInfoEl.textContent = provider.api_key_set ? "API key configured" : "No API key set";

        // Button handlers
        var keysBtn = card.querySelector(".provider-keys-btn");
        keysBtn.addEventListener("click", function () {
          toggleKeysSection(provider.id, container);
        });

        var testBtn = card.querySelector(".provider-test-btn");
        testBtn.addEventListener("click", function () {
          testProvider(provider.id, container);
        });

        var editBtn = card.querySelector(".provider-edit-btn");
        editBtn.addEventListener("click", function () {
          openEditModal(provider);
        });

        var deleteBtn = card.querySelector(".provider-delete-btn");
        deleteBtn.addEventListener("click", function () {
          openDeleteModal(provider.id, provider.name);
        });

        // Keys section: add key button
        var keyAddBtn = card.querySelector(".key-add-btn");
        keyAddBtn.addEventListener("click", function () {
          addKeyToProvider(provider.id, container);
        });

        // Strategy change handler
        var strategySelect = card.querySelector(".keys-strategy-select");
        strategySelect.addEventListener("change", function () {
          updateStrategy(provider.id, strategySelect.value);
        });

        providersList.appendChild(card);
      });
    }

    // Test connection
    function testProvider(providerId, cardEl) {
      var resultEl = cardEl.querySelector(".provider-test-result");
      var testBtn = cardEl.querySelector(".provider-test-btn");

      resultEl.classList.remove("hidden");
      resultEl.innerHTML = '<span class="text-muted">Testing connection...</span>';
      testBtn.disabled = true;

      fetch("/api/v1/providers/" + providerId + "/test", {
        method: "POST",
        credentials: "same-origin"
      })
        .then(function (res) {
          if (!res.ok) throw new Error("Test request failed");
          return res.json();
        })
        .then(function (result) {
          if (result.success) {
            resultEl.innerHTML = '<span class="text-zen-green flex items-center gap-1"><svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Connected (' + result.latency_ms.toFixed(0) + 'ms)</span>';
          } else {
            resultEl.innerHTML = '<span class="text-coral flex items-center gap-1"><svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> ' + (result.error || "Connection failed") + '</span>';
          }
        })
        .catch(function () {
          resultEl.innerHTML = '<span class="text-coral">Failed to test connection</span>';
        })
        .finally(function () {
          testBtn.disabled = false;
          // Auto-hide result after 8 seconds
          setTimeout(function () {
            resultEl.classList.add("hidden");
          }, 8000);
        });
    }

    // Add provider
    if (addProviderBtn) {
      addProviderBtn.addEventListener("click", function () {
        if (addForm) addForm.reset();
        if (addError) addError.classList.add("hidden");
        if (addModal) addModal.showModal();
      });
    }

    if (addForm) {
      addForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (addError) addError.classList.add("hidden");

        var formData = new FormData(addForm);
        var name = (formData.get("name") || "").toString().trim();
        var providerType = (formData.get("provider_type") || "").toString();
        var apiKey = (formData.get("api_key") || "").toString().trim();
        var baseUrl = (formData.get("base_url") || "").toString().trim();

        if (!name) {
          if (addError) {
            addError.textContent = "Provider name is required";
            addError.classList.remove("hidden");
          }
          return;
        }

        addSubmit.disabled = true;
        addSubmit.textContent = "Adding...";

        var body = { name: name, provider_type: providerType };
        if (apiKey) body.api_key = apiKey;
        if (baseUrl) body.base_url = baseUrl;

        fetch("/api/v1/providers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to add provider"); });
            return res.json();
          })
          .then(function () {
            addForm.reset();
            addModal.close();
            fetchProviders();
          })
          .catch(function (err) {
            if (addError) {
              addError.textContent = err.message;
              addError.classList.remove("hidden");
            }
          })
          .finally(function () {
            addSubmit.disabled = false;
            addSubmit.textContent = "Add Provider";
          });
      });
    }

    // Edit provider
    function openEditModal(provider) {
      if (!editForm) return;
      editForm.querySelector('[name="provider_id"]').value = provider.id;
      editForm.querySelector('[name="name"]').value = provider.name;
      editForm.querySelector('[name="provider_type"]').value = provider.provider_type;
      editForm.querySelector('[name="api_key"]').value = "";
      editForm.querySelector('[name="base_url"]').value = provider.base_url || "";
      if (editError) editError.classList.add("hidden");
      if (editModal) editModal.showModal();
    }

    if (editForm) {
      editForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (editError) editError.classList.add("hidden");

        var formData = new FormData(editForm);
        var providerId = formData.get("provider_id");
        var name = (formData.get("name") || "").toString().trim();
        var providerType = (formData.get("provider_type") || "").toString();
        var apiKey = (formData.get("api_key") || "").toString().trim();
        var baseUrl = (formData.get("base_url") || "").toString().trim();

        if (!name) {
          if (editError) {
            editError.textContent = "Provider name is required";
            editError.classList.remove("hidden");
          }
          return;
        }

        editSubmit.disabled = true;
        editSubmit.textContent = "Saving...";

        var body = { name: name, provider_type: providerType };
        if (apiKey) body.api_key = apiKey;
        if (baseUrl) {
          body.base_url = baseUrl;
        }

        fetch("/api/v1/providers/" + providerId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to update provider"); });
            return res.json();
          })
          .then(function () {
            editModal.close();
            fetchProviders();
          })
          .catch(function (err) {
            if (editError) {
              editError.textContent = err.message;
              editError.classList.remove("hidden");
            }
          })
          .finally(function () {
            editSubmit.disabled = false;
            editSubmit.textContent = "Save Changes";
          });
      });
    }

    // Delete provider
    function openDeleteModal(id, name) {
      deleteTargetId = id;
      if (deleteNameEl) deleteNameEl.textContent = name;
      if (deleteModal) deleteModal.showModal();
    }

    if (confirmDeleteBtn) {
      confirmDeleteBtn.addEventListener("click", function () {
        if (!deleteTargetId) return;

        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.textContent = "Deleting...";

        fetch("/api/v1/providers/" + deleteTargetId, {
          method: "DELETE",
          credentials: "same-origin"
        })
          .then(function (res) {
            if (!res.ok) throw new Error("Failed to delete");
            deleteModal.close();
            deleteTargetId = null;
            fetchProviders();
          })
          .catch(function () {
            deleteModal.close();
          })
          .finally(function () {
            confirmDeleteBtn.disabled = false;
            confirmDeleteBtn.textContent = "Delete Provider";
          });
      });
    }

    // ------- Key Management -------
    function toggleKeysSection(providerId, cardEl) {
      var section = cardEl.querySelector(".provider-keys-section");
      if (section.classList.contains("hidden")) {
        section.classList.remove("hidden");
        fetchKeys(providerId, cardEl);
      } else {
        section.classList.add("hidden");
      }
    }

    function fetchKeys(providerId, cardEl) {
      var keysList = cardEl.querySelector(".keys-list");
      var keysEmpty = cardEl.querySelector(".keys-empty");
      var strategySelect = cardEl.querySelector(".keys-strategy-select");

      keysList.innerHTML = '<div class="text-xs text-muted py-2">Loading keys...</div>';
      keysEmpty.classList.add("hidden");

      // Fetch strategy and keys in parallel
      Promise.all([
        fetch("/api/v1/providers/" + providerId + "/strategy").then(function (r) { return r.ok ? r.json() : { strategy: "round_robin" }; }),
        fetch("/api/v1/providers/" + providerId + "/keys").then(function (r) { return r.ok ? r.json() : []; })
      ]).then(function (results) {
        var strategyData = results[0];
        var keys = results[1];

        strategySelect.value = strategyData.strategy || "round_robin";
        renderKeys(providerId, cardEl, keys);
      }).catch(function () {
        keysList.innerHTML = '<div class="text-xs text-coral py-2">Failed to load keys.</div>';
      });
    }

    function renderKeys(providerId, cardEl, keys) {
      var keysList = cardEl.querySelector(".keys-list");
      var keysEmpty = cardEl.querySelector(".keys-empty");

      keysList.innerHTML = "";

      if (!keys || keys.length === 0) {
        keysEmpty.classList.remove("hidden");
        return;
      }

      keysEmpty.classList.add("hidden");

      keys.forEach(function (key) {
        var row = keyRowTemplate.content.cloneNode(true);
        var container = row.querySelector("div");
        container.setAttribute("data-key-id", key.id);

        // Status dot
        var dot = row.querySelector(".key-status-dot");
        if (key.status === "active") {
          dot.classList.add("bg-zen-green");
        } else if (key.status === "rate_limited") {
          dot.classList.add("bg-yellow-400");
        } else {
          dot.classList.add("bg-coral");
        }

        // Label
        var labelEl = row.querySelector(".key-label");
        labelEl.textContent = key.label || "Key " + (key.strategy_position + 1);

        // Status text with cooldown
        var statusText = row.querySelector(".key-status-text");
        if (key.status === "active") {
          statusText.textContent = "";
        } else if (key.status === "rate_limited") {
          if (key.cooldown_until) {
            startCooldownTimer(key.id, key.cooldown_until, statusText);
          } else {
            statusText.textContent = "(rate limited)";
            statusText.classList.add("text-yellow-600");
          }
        } else if (key.status === "invalid") {
          statusText.textContent = "(invalid)";
          statusText.classList.add("text-coral");
        }

        // Stats
        var reqEl = row.querySelector(".key-stat-requests");
        reqEl.textContent = key.total_requests + " req";

        var tokensEl = row.querySelector(".key-stat-tokens");
        tokensEl.textContent = formatTokens(key.total_tokens);

        var errorsEl = row.querySelector(".key-stat-errors");
        if (key.error_count > 0) {
          errorsEl.textContent = key.error_count + " err";
          errorsEl.classList.add("text-coral");
        } else {
          errorsEl.textContent = "";
        }

        var lastUsedEl = row.querySelector(".key-stat-last-used");
        if (key.last_used) {
          lastUsedEl.textContent = formatRelativeTime(key.last_used);
        } else {
          lastUsedEl.textContent = "never";
        }

        // Delete handler
        var deleteBtn = row.querySelector(".key-delete-btn");
        deleteBtn.addEventListener("click", function () {
          openDeleteKeyModal(providerId, key.id, key.label || "Key " + (key.strategy_position + 1), cardEl);
        });

        keysList.appendChild(row);
      });

      // Update key-info on the provider card
      var keyInfoEl = cardEl.querySelector('[data-field="key-info"]');
      if (keyInfoEl) {
        keyInfoEl.textContent = keys.length + " key" + (keys.length !== 1 ? "s" : "") + " configured";
      }
    }

    function formatTokens(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + "M tok";
      if (num >= 1000) return (num / 1000).toFixed(1) + "K tok";
      return num + " tok";
    }

    function formatRelativeTime(dateStr) {
      try {
        var d = new Date(dateStr + "Z");
        var now = new Date();
        var diff = Math.floor((now - d) / 1000);
        if (diff < 60) return "just now";
        if (diff < 3600) return Math.floor(diff / 60) + "m ago";
        if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
        return Math.floor(diff / 86400) + "d ago";
      } catch (_e) {
        return dateStr;
      }
    }

    function startCooldownTimer(keyId, cooldownUntil, statusEl) {
      // Clear any existing timer for this key
      if (cooldownIntervals[keyId]) {
        clearInterval(cooldownIntervals[keyId]);
      }

      function updateTimer() {
        var now = new Date();
        var target = new Date(cooldownUntil + "Z");
        var remaining = Math.max(0, Math.floor((target - now) / 1000));

        if (remaining <= 0) {
          statusEl.textContent = "(cooldown expired)";
          statusEl.classList.remove("text-yellow-600");
          statusEl.classList.add("text-muted");
          clearInterval(cooldownIntervals[keyId]);
          delete cooldownIntervals[keyId];
          return;
        }

        var mins = Math.floor(remaining / 60);
        var secs = remaining % 60;
        statusEl.textContent = "(rate limited " + mins + ":" + (secs < 10 ? "0" : "") + secs + ")";
        statusEl.classList.add("text-yellow-600");
      }

      updateTimer();
      cooldownIntervals[keyId] = setInterval(updateTimer, 1000);
    }

    function addKeyToProvider(providerId, cardEl) {
      var keyInput = cardEl.querySelector(".key-input-value");
      var labelInput = cardEl.querySelector(".key-input-label");
      var addBtn = cardEl.querySelector(".key-add-btn");
      var errorEl = cardEl.querySelector(".key-add-error");

      var apiKey = (keyInput.value || "").trim();
      if (!apiKey) {
        errorEl.textContent = "API key is required";
        errorEl.classList.remove("hidden");
        return;
      }

      errorEl.classList.add("hidden");
      addBtn.disabled = true;
      addBtn.textContent = "Adding...";

      var body = { api_key: apiKey };
      var label = (labelInput.value || "").trim();
      if (label) body.label = label;

      fetch("/api/v1/providers/" + providerId + "/keys", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to add key"); });
          return res.json();
        })
        .then(function () {
          keyInput.value = "";
          labelInput.value = "";
          fetchKeys(providerId, cardEl);
        })
        .catch(function (err) {
          errorEl.textContent = err.message;
          errorEl.classList.remove("hidden");
        })
        .finally(function () {
          addBtn.disabled = false;
          addBtn.innerHTML = '<svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add';
        });
    }

    function updateStrategy(providerId, strategy) {
      fetch("/api/v1/providers/" + providerId + "/strategy", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ strategy: strategy })
      }).catch(function () {
        // Silently fail  strategy is not critical
      });
    }

    function openDeleteKeyModal(providerId, keyId, label, cardEl) {
      deleteKeyTargetId = keyId;
      deleteKeyProviderId = providerId;
      deleteKeyCardEl = cardEl;
      if (deleteKeyLabel) deleteKeyLabel.textContent = label;
      if (deleteKeyModal) deleteKeyModal.showModal();
    }

    if (confirmDeleteKeyBtn) {
      confirmDeleteKeyBtn.addEventListener("click", function () {
        if (!deleteKeyTargetId || !deleteKeyProviderId) return;

        confirmDeleteKeyBtn.disabled = true;
        confirmDeleteKeyBtn.textContent = "Deleting...";

        fetch("/api/v1/providers/" + deleteKeyProviderId + "/keys/" + deleteKeyTargetId, {
          method: "DELETE",
          credentials: "same-origin"
        })
          .then(function (res) {
            if (!res.ok) throw new Error("Failed to delete");
            deleteKeyModal.close();
            if (deleteKeyCardEl) {
              fetchKeys(deleteKeyProviderId, deleteKeyCardEl);
            }
            deleteKeyTargetId = null;
            deleteKeyProviderId = null;
            deleteKeyCardEl = null;
          })
          .catch(function () {
            deleteKeyModal.close();
          })
          .finally(function () {
            confirmDeleteKeyBtn.disabled = false;
            confirmDeleteKeyBtn.textContent = "Delete Key";
          });
      });
    }

    // ------- Knowledge / Vector Store -------
    var vsLoaded = false;
    var vsForm = document.getElementById("vs-form");
    var vsLoading = document.getElementById("vs-loading");
    var vsBackendSelect = document.getElementById("vs-backend");
    var vsConnectionFields = document.getElementById("vs-connection-fields");
    var vsHostInput = document.getElementById("vs-host");
    var vsPortInput = document.getElementById("vs-port");
    var vsApiKeyInput = document.getElementById("vs-apikey");
    var vsCollectionInput = document.getElementById("vs-collection");
    var vsHostGroup = document.getElementById("vs-host-group");
    var vsPortGroup = document.getElementById("vs-port-group");
    var vsApiKeyGroup = document.getElementById("vs-apikey-group");
    var vsTestBtn = document.getElementById("vs-test-btn");
    var vsTestResult = document.getElementById("vs-test-result");
    var vsError = document.getElementById("vs-error");
    var vsSaved = document.getElementById("vs-saved");
    var vsStatusDot = document.getElementById("vs-status-dot");
    var vsStatusText = document.getElementById("vs-status-text");

    var vsPortDefaults = {
      milvus: 19530,
      qdrant: 6333,
      chromadb: 8000,
      pinecone: null,
      sqlite_vss: null
    };

    function updateVsFieldVisibility() {
      if (!vsBackendSelect) return;
      var backend = vsBackendSelect.value;
      var isExternal = backend !== "sqlite_vss";

      if (vsConnectionFields) {
        if (isExternal) {
          vsConnectionFields.classList.remove("hidden");
        } else {
          vsConnectionFields.classList.add("hidden");
        }
      }

      // Pinecone needs API key but not host/port
      if (backend === "pinecone") {
        if (vsHostGroup) vsHostGroup.classList.add("hidden");
        if (vsPortGroup) vsPortGroup.classList.add("hidden");
        if (vsApiKeyGroup) vsApiKeyGroup.classList.remove("hidden");
      } else if (isExternal) {
        if (vsHostGroup) vsHostGroup.classList.remove("hidden");
        if (vsPortGroup) vsPortGroup.classList.remove("hidden");
        if (vsApiKeyGroup) vsApiKeyGroup.classList.remove("hidden");
      }

      // Update port placeholder
      if (vsPortInput && vsPortDefaults[backend]) {
        vsPortInput.placeholder = String(vsPortDefaults[backend]);
      }
    }

    if (vsBackendSelect) {
      vsBackendSelect.addEventListener("change", updateVsFieldVisibility);
    }

    function fetchVectorStoreConfig() {
      fetch("/api/v1/vector-stores", { credentials: "same-origin" })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load config");
          return res.json();
        })
        .then(function (config) {
          vsLoaded = true;
          if (vsLoading) vsLoading.classList.add("hidden");
          if (vsForm) vsForm.classList.remove("hidden");

          // Populate form
          if (vsBackendSelect) vsBackendSelect.value = config.backend || "sqlite_vss";
          if (vsHostInput) vsHostInput.value = config.host || "";
          if (vsPortInput) vsPortInput.value = config.port || "";
          if (vsCollectionInput) vsCollectionInput.value = config.collection_name || "";
          if (vsApiKeyInput) vsApiKeyInput.placeholder = config.api_key_set ? "Key is set (leave blank to keep)" : "Enter API key";

          updateVsFieldVisibility();
          updateVsStatus(config.backend, config.backend_label, config.api_key_set);
        })
        .catch(function () {
          if (vsLoading) vsLoading.textContent = "Failed to load vector store configuration.";
        });
    }

    function updateVsStatus(backend, label, hasKey) {
      if (!vsStatusDot || !vsStatusText) return;
      if (backend === "sqlite_vss") {
        vsStatusDot.className = "inline-block h-2.5 w-2.5 rounded-full bg-zen-green";
        vsStatusText.textContent = label + " (built-in)";
        vsStatusText.className = "text-xs text-zen-green font-medium";
      } else if (hasKey || backend === "chromadb" || backend === "milvus" || backend === "qdrant") {
        vsStatusDot.className = "inline-block h-2.5 w-2.5 rounded-full bg-zen-blue";
        vsStatusText.textContent = label + " configured";
        vsStatusText.className = "text-xs text-zen-blue font-medium";
      } else {
        vsStatusDot.className = "inline-block h-2.5 w-2.5 rounded-full bg-muted";
        vsStatusText.textContent = label + " (not configured)";
        vsStatusText.className = "text-xs text-muted";
      }
    }

    // Save vector store config
    if (vsForm) {
      vsForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (vsError) vsError.classList.add("hidden");
        if (vsSaved) vsSaved.classList.add("hidden");

        var payload = {};
        if (vsBackendSelect) payload.backend = vsBackendSelect.value;
        if (vsHostInput && vsHostInput.value) payload.host = vsHostInput.value;
        if (vsPortInput && vsPortInput.value) payload.port = parseInt(vsPortInput.value, 10);
        if (vsApiKeyInput && vsApiKeyInput.value) payload.api_key = vsApiKeyInput.value;
        if (vsCollectionInput) payload.collection_name = vsCollectionInput.value;

        // If switching to sqlite_vss, clear connection fields
        if (payload.backend === "sqlite_vss") {
          payload.host = "";
          payload.port = null;
          payload.api_key = "";
          payload.collection_name = "";
        }

        fetch("/api/v1/vector-stores", {
          method: "PUT",
          credentials: "same-origin",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Save failed"); });
            return res.json();
          })
          .then(function (config) {
            if (vsApiKeyInput) {
              vsApiKeyInput.value = "";
              vsApiKeyInput.placeholder = config.api_key_set ? "Key is set (leave blank to keep)" : "Enter API key";
            }
            updateVsStatus(config.backend, config.backend_label, config.api_key_set);

            if (vsSaved) {
              vsSaved.classList.remove("hidden");
              setTimeout(function () { vsSaved.classList.add("hidden"); }, 2000);
            }
          })
          .catch(function (err) {
            if (vsError) {
              vsError.textContent = err.message || "Failed to save configuration";
              vsError.classList.remove("hidden");
            }
          });
      });
    }

    // Test connection
    if (vsTestBtn) {
      vsTestBtn.addEventListener("click", function () {
        if (vsTestResult) {
          vsTestResult.classList.remove("hidden");
          vsTestResult.className = "text-sm rounded-lg border px-4 py-3 border-dark/[0.08] text-muted";
          vsTestResult.textContent = "Testing connection...";
        }
        vsTestBtn.disabled = true;

        fetch("/api/v1/vector-stores/test", {
          method: "POST",
          credentials: "same-origin"
        })
          .then(function (res) { return res.json(); })
          .then(function (result) {
            if (!vsTestResult) return;
            vsTestResult.classList.remove("hidden");

            if (result.success) {
              vsTestResult.className = "text-sm rounded-lg border px-4 py-3 border-zen-green/30 bg-zen-green/5 text-zen-green";
              vsTestResult.innerHTML = '<div class="flex items-center gap-2"><svg class="h-4 w-4 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span>Connected to <strong>' + result.backend_label + '</strong> successfully</span></div>';
            } else {
              vsTestResult.className = "text-sm rounded-lg border px-4 py-3 border-coral/30 bg-coral/5 text-coral";
              vsTestResult.innerHTML = '<div class="flex items-center gap-2"><svg class="h-4 w-4 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><span>Failed: ' + (result.error || "Unknown error") + '</span></div>';
            }
          })
          .catch(function () {
            if (vsTestResult) {
              vsTestResult.className = "text-sm rounded-lg border px-4 py-3 border-coral/30 bg-coral/5 text-coral";
              vsTestResult.textContent = "Connection test failed. Is the API server running?";
              vsTestResult.classList.remove("hidden");
            }
          })
          .finally(function () {
            vsTestBtn.disabled = false;
          });
      });
    }

    // ------- Workspace -------
    var workspaceForm = document.getElementById("workspace-form");
    var workspaceSaved = document.getElementById("workspace-saved");
    var workspaceModelSelect = document.getElementById("workspace-default-model");

    // Populate model dropdown for workspace
    function fetchModelsForWorkspace() {
      fetch("/api/v1/models")
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (models) {
          if (!workspaceModelSelect) return;
          workspaceModelSelect.innerHTML = '<option value="">None</option>';
          models.forEach(function (m) {
            var opt = document.createElement("option");
            opt.value = m.model_name;
            opt.textContent = m.model_name + " (" + (m.provider_name || m.provider_type) + ")";
            workspaceModelSelect.appendChild(opt);
          });
          // Restore saved value
          var savedModel = localStorage.getItem("orbiter_default_model") || "";
          workspaceModelSelect.value = savedModel;
        })
        .catch(function () {});
    }

    // Load workspace settings from localStorage + DB
    if (workspaceForm) {
      var providerSelect = workspaceForm.querySelector('[name="default_provider"]');
      var limitInput = workspaceForm.querySelector('[name="concurrent_limit"]');
      var savedProvider = localStorage.getItem("orbiter_default_provider") || "";
      if (providerSelect) providerSelect.value = savedProvider;

      // Load concurrent limit from DB
      fetch("/api/v1/settings/workspace")
        .then(function (r) { return r.json(); })
        .then(function (data) {
          if (limitInput && data.concurrent_run_limit) {
            limitInput.value = data.concurrent_run_limit;
          }
        })
        .catch(function () {
          var savedLimit = localStorage.getItem("orbiter_concurrent_limit") || "5";
          if (limitInput) limitInput.value = savedLimit;
        });

      fetchModelsForWorkspace();

      workspaceForm.addEventListener("submit", function (e) {
        e.preventDefault();
        var provider = providerSelect ? providerSelect.value : "";
        var limit = limitInput ? limitInput.value : "5";
        var model = workspaceModelSelect ? workspaceModelSelect.value : "";

        localStorage.setItem("orbiter_default_provider", provider);
        localStorage.setItem("orbiter_default_model", model);

        // Save concurrent limit to DB
        fetch("/api/v1/settings/workspace/concurrent_run_limit", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ value: limit }),
        }).catch(function () {});

        if (workspaceSaved) {
          workspaceSaved.classList.remove("hidden");
          setTimeout(function () {
            workspaceSaved.classList.add("hidden");
          }, 2000);
        }
      });
    }
    // ------- Toast helper -------
    var toastTimer = null;
    function showToast(msg, type) {
      // Remove any existing toast
      var existing = document.getElementById("settings-toast");
      if (existing) existing.remove();

      var cls = type === "error"
        ? "border-coral/30 bg-coral/10 text-dark"
        : "border-zen-green/30 bg-zen-green/10 text-dark";
      var iconSvg = type === "error"
        ? '<svg class="h-4 w-4 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
        : '<svg class="h-4 w-4 text-zen-green" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';

      var toast = document.createElement("div");
      toast.id = "settings-toast";
      toast.className = "fixed bottom-4 right-4 z-[100] flex items-center gap-3 rounded-lg border px-4 py-3 shadow-lg max-w-sm w-full " + cls;
      toast.innerHTML = iconSvg + '<span class="flex-1 text-sm font-medium">' + msg + '</span>';
      document.body.appendChild(toast);

      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(function () {
        if (toast.parentNode) toast.remove();
      }, 4000);
    }

    // ------- Pricing -------
    var pricingLoaded = false;
    var pricingLoading = document.getElementById("pricing-loading");
    var pricingTableWrap = document.getElementById("pricing-table-wrap");
    var pricingTbody = document.getElementById("pricing-tbody");
    var pricingEmpty = document.getElementById("pricing-empty");
    var pricingSaved = document.getElementById("pricing-saved");

    function fetchPricingData() {
      fetch("/api/v1/costs/pricing", { credentials: "same-origin" })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load pricing");
          return res.json();
        })
        .then(function (data) {
          pricingLoaded = true;
          if (pricingLoading) pricingLoading.classList.add("hidden");

          if (!data.length) {
            if (pricingEmpty) pricingEmpty.classList.remove("hidden");
            return;
          }

          if (pricingTableWrap) pricingTableWrap.classList.remove("hidden");
          renderPricingTable(data);
        })
        .catch(function () {
          if (pricingLoading) pricingLoading.textContent = "Failed to load pricing data.";
        });
    }

    function renderPricingTable(data) {
      if (!pricingTbody) return;
      pricingTbody.innerHTML = data.map(function (item) {
        return '<tr data-pricing-id="' + item.id + '">'
          + '<td class="py-2.5 pr-4 text-dark font-medium">' + item.model_name + '</td>'
          + '<td class="py-2.5 px-4 text-right">'
          + '<input type="number" step="0.0001" min="0" class="pricing-input w-28 text-right bg-paper border border-dark/[0.08] rounded-lg px-2.5 py-1.5 text-sm text-dark tabular-nums outline-none focus:border-coral focus:ring-2 focus:ring-coral/20" data-field="input" value="' + item.input_price_per_1k + '" />'
          + '</td>'
          + '<td class="py-2.5 pl-4 text-right">'
          + '<input type="number" step="0.0001" min="0" class="pricing-input w-28 text-right bg-paper border border-dark/[0.08] rounded-lg px-2.5 py-1.5 text-sm text-dark tabular-nums outline-none focus:border-coral focus:ring-2 focus:ring-coral/20" data-field="output" value="' + item.output_price_per_1k + '" />'
          + '</td>'
          + '</tr>';
      }).join("");

      // Listen for changes on pricing inputs (auto-save on blur)
      pricingTbody.querySelectorAll(".pricing-input").forEach(function (input) {
        input.addEventListener("change", function () {
          var row = input.closest("tr");
          var pricingId = row.getAttribute("data-pricing-id");
          var inputPrice = row.querySelector('[data-field="input"]').value;
          var outputPrice = row.querySelector('[data-field="output"]').value;

          fetch("/api/v1/costs/pricing/" + pricingId, {
            method: "PUT",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              input_price_per_1k: parseFloat(inputPrice) || 0,
              output_price_per_1k: parseFloat(outputPrice) || 0,
            }),
          })
            .then(function (res) {
              if (!res.ok) throw new Error("Failed to update");
              if (pricingSaved) {
                pricingSaved.classList.remove("hidden");
                setTimeout(function () {
                  pricingSaved.classList.add("hidden");
                }, 2000);
              }
            })
            .catch(function () {
              input.classList.add("border-coral");
              setTimeout(function () {
                input.classList.remove("border-coral");
              }, 2000);
            });
        });
      });
    }

    // ------- Team Management (admin only) -------
    var teamLoaded = false;
    var teamData = [];
    var currentUserId = null;
    var currentUserRole = null;
    var teamTab = document.getElementById("team-tab");
    var teamLoading = document.getElementById("team-loading");
    var teamTableWrap = document.getElementById("team-table-wrap");
    var teamTbody = document.getElementById("team-tbody");
    var teamEmpty = document.getElementById("team-empty");
    var inviteUserBtn = document.getElementById("invite-user-btn");
    var inviteModal = document.getElementById("invite-user-modal");
    var inviteForm = document.getElementById("invite-user-form");
    var inviteError = document.getElementById("invite-user-error");
    var inviteSubmit = document.getElementById("invite-user-submit");
    var removeModal = document.getElementById("remove-user-modal");
    var removeEmailEl = document.getElementById("remove-user-email");
    var confirmRemoveBtn = document.getElementById("confirm-remove-user-btn");
    var removeTargetId = null;

    // Show Team tab only for admins  fetch current user info
    fetch("/api/v1/auth/me", { credentials: "same-origin" })
      .then(function (res) {
        if (!res.ok) throw new Error("Not authenticated");
        return res.json();
      })
      .then(function (user) {
        currentUserId = user.id;
        currentUserRole = user.role;
        if (user.role === "admin" && teamTab) {
          teamTab.classList.remove("hidden");
        }
      })
      .catch(function () {});

    var roleBadgeClasses = {
      admin: "bg-coral/10 text-coral",
      developer: "bg-zen-blue/10 text-zen-blue",
      viewer: "bg-dark/5 text-muted"
    };

    function fetchTeamMembers() {
      if (teamLoading) teamLoading.classList.remove("hidden");
      if (teamTableWrap) teamTableWrap.classList.add("hidden");
      if (teamEmpty) teamEmpty.classList.add("hidden");

      fetch("/api/v1/settings/team", { credentials: "same-origin" })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load team");
          return res.json();
        })
        .then(function (data) {
          teamLoaded = true;
          teamData = data;
          renderTeamTable(data);
        })
        .catch(function () {
          if (teamLoading) teamLoading.textContent = "Failed to load team members. You may not have permission.";
        });
    }

    function renderTeamTable(members) {
      if (teamLoading) teamLoading.classList.add("hidden");

      if (!members || members.length === 0) {
        if (teamEmpty) teamEmpty.classList.remove("hidden");
        return;
      }

      if (teamEmpty) teamEmpty.classList.add("hidden");
      if (teamTableWrap) teamTableWrap.classList.remove("hidden");
      if (!teamTbody) return;

      teamTbody.innerHTML = "";

      members.forEach(function (member) {
        var tr = document.createElement("tr");
        var isMe = member.id === currentUserId;

        // Email cell
        var emailTd = document.createElement("td");
        emailTd.className = "py-2.5 pr-4 text-dark font-medium";
        emailTd.textContent = member.email;
        if (isMe) {
          var youBadge = document.createElement("span");
          youBadge.className = "ml-2 text-xs text-muted";
          youBadge.textContent = "(you)";
          emailTd.appendChild(youBadge);
        }

        // Role cell with dropdown
        var roleTd = document.createElement("td");
        roleTd.className = "py-2.5 px-4";
        if (isMe) {
          // Cannot change own role  show badge only
          var badge = document.createElement("span");
          var badgeCls = roleBadgeClasses[member.role] || roleBadgeClasses.viewer;
          badge.className = "inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium " + badgeCls;
          badge.textContent = member.role;
          roleTd.appendChild(badge);
        } else {
          var roleSelect = document.createElement("select");
          roleSelect.className = "text-xs bg-paper border border-dark/[0.08] rounded-md px-2 py-1 text-dark cursor-pointer focus:outline-none focus:ring-1 focus:ring-coral/30";
          ["viewer", "developer", "admin"].forEach(function (r) {
            var opt = document.createElement("option");
            opt.value = r;
            opt.textContent = r;
            if (r === member.role) opt.selected = true;
            roleSelect.appendChild(opt);
          });
          roleSelect.addEventListener("change", function () {
            updateMemberRole(member.id, roleSelect.value, roleSelect);
          });
          roleTd.appendChild(roleSelect);
        }

        // Joined cell
        var joinedTd = document.createElement("td");
        joinedTd.className = "py-2.5 px-4 text-muted text-xs";
        try {
          var d = new Date(member.created_at + "Z");
          joinedTd.textContent = d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
        } catch (_e) {
          joinedTd.textContent = member.created_at;
        }

        // Actions cell
        var actionsTd = document.createElement("td");
        actionsTd.className = "py-2.5 pl-4 text-right";
        if (!isMe) {
          var removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-md text-muted hover:bg-coral/10 hover:text-coral transition-colors cursor-pointer";
          removeBtn.innerHTML = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Remove';
          removeBtn.addEventListener("click", function () {
            openRemoveModal(member.id, member.email);
          });
          actionsTd.appendChild(removeBtn);
        }

        tr.appendChild(emailTd);
        tr.appendChild(roleTd);
        tr.appendChild(joinedTd);
        tr.appendChild(actionsTd);
        teamTbody.appendChild(tr);
      });
    }

    function updateMemberRole(userId, newRole, selectEl) {
      selectEl.disabled = true;

      fetch("/api/v1/settings/team/" + userId, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ role: newRole })
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to update role"); });
          return res.json();
        })
        .then(function () {
          showToast("Role updated to " + newRole, "success");
        })
        .catch(function (err) {
          showToast(err.message, "error");
          // Revert dropdown to previous value
          fetchTeamMembers();
        })
        .finally(function () {
          selectEl.disabled = false;
        });
    }

    // Invite user
    if (inviteUserBtn) {
      inviteUserBtn.addEventListener("click", function () {
        if (inviteForm) inviteForm.reset();
        if (inviteError) inviteError.classList.add("hidden");
        if (inviteModal) inviteModal.showModal();
      });
    }

    if (inviteForm) {
      inviteForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (inviteError) inviteError.classList.add("hidden");

        var formData = new FormData(inviteForm);
        var email = (formData.get("email") || "").toString().trim();
        var password = (formData.get("password") || "").toString();
        var role = (formData.get("role") || "developer").toString();

        if (!email) {
          if (inviteError) {
            inviteError.textContent = "Email is required";
            inviteError.classList.remove("hidden");
          }
          return;
        }
        if (password.length < 8) {
          if (inviteError) {
            inviteError.textContent = "Password must be at least 8 characters";
            inviteError.classList.remove("hidden");
          }
          return;
        }

        inviteSubmit.disabled = true;
        inviteSubmit.textContent = "Inviting...";

        fetch("/api/v1/settings/team/invite", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify({ email: email, password: password, role: role })
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to invite user"); });
            return res.json();
          })
          .then(function () {
            inviteForm.reset();
            inviteModal.close();
            showToast("Team member invited", "success");
            fetchTeamMembers();
          })
          .catch(function (err) {
            if (inviteError) {
              inviteError.textContent = err.message;
              inviteError.classList.remove("hidden");
            }
          })
          .finally(function () {
            inviteSubmit.disabled = false;
            inviteSubmit.textContent = "Invite";
          });
      });
    }

    // Remove user
    function openRemoveModal(id, email) {
      removeTargetId = id;
      if (removeEmailEl) removeEmailEl.textContent = email;
      if (removeModal) removeModal.showModal();
    }

    if (confirmRemoveBtn) {
      confirmRemoveBtn.addEventListener("click", function () {
        if (!removeTargetId) return;

        confirmRemoveBtn.disabled = true;
        confirmRemoveBtn.textContent = "Removing...";

        fetch("/api/v1/settings/team/" + removeTargetId, {
          method: "DELETE",
          credentials: "same-origin"
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to remove user"); });
            removeModal.close();
            removeTargetId = null;
            showToast("Team member removed", "success");
            fetchTeamMembers();
          })
          .catch(function (err) {
            showToast(err.message, "error");
            removeModal.close();
          })
          .finally(function () {
            confirmRemoveBtn.disabled = false;
            confirmRemoveBtn.textContent = "Remove User";
          });
      });
    }

    // ------- MCP Integrations -------
    var mcpLoaded = false;
    var mcpServers = [];
    var mcpServerList = document.getElementById("mcp-server-list");
    var mcpLoading = document.getElementById("mcp-loading");
    var mcpEmpty = document.getElementById("mcp-empty");
    var mcpToolsSection = document.getElementById("mcp-tools-section");
    var mcpToolsList = document.getElementById("mcp-tools-list");
    var mcpToolsEmpty = document.getElementById("mcp-tools-empty");

    // Add MCP modal
    var addMcpModal = document.getElementById("add-mcp-modal");
    var addMcpForm = document.getElementById("add-mcp-form");
    var addMcpError = document.getElementById("add-mcp-error");
    var addMcpSubmit = document.getElementById("add-mcp-submit");
    var addMcpBtn = document.getElementById("add-mcp-server-btn");

    // Edit MCP modal
    var editMcpModal = document.getElementById("edit-mcp-modal");
    var editMcpForm = document.getElementById("edit-mcp-form");
    var editMcpError = document.getElementById("edit-mcp-error");
    var editMcpSubmit = document.getElementById("edit-mcp-submit");

    // Delete MCP modal
    var deleteMcpModal = document.getElementById("delete-mcp-modal");
    var deleteMcpName = document.getElementById("delete-mcp-name");
    var confirmDeleteMcp = document.getElementById("confirm-delete-mcp");
    var deleteTargetId = null;

    // Auth type toggle for add modal
    var addAuthSelect = addMcpForm ? addMcpForm.querySelector('[name="auth_type"]') : null;
    if (addAuthSelect) {
      addAuthSelect.addEventListener("change", function () {
        var bearer = document.getElementById("mcp-auth-bearer");
        var apikey = document.getElementById("mcp-auth-apikey");
        if (bearer) bearer.classList.toggle("hidden", addAuthSelect.value !== "bearer");
        if (apikey) apikey.classList.toggle("hidden", addAuthSelect.value !== "api_key");
      });
    }

    // Auth type toggle for edit modal
    var editAuthSelect = editMcpForm ? editMcpForm.querySelector('[name="auth_type"]') : null;
    if (editAuthSelect) {
      editAuthSelect.addEventListener("change", function () {
        var bearer = document.getElementById("edit-mcp-auth-bearer");
        var apikey = document.getElementById("edit-mcp-auth-apikey");
        if (bearer) bearer.classList.toggle("hidden", editAuthSelect.value !== "bearer");
        if (apikey) apikey.classList.toggle("hidden", editAuthSelect.value !== "api_key");
      });
    }

    function getStatusDot(status) {
      if (status === "connected") return '<span class="inline-block h-2.5 w-2.5 rounded-full bg-zen-green flex-shrink-0" title="Connected"></span>';
      if (status === "error") return '<span class="inline-block h-2.5 w-2.5 rounded-full bg-coral flex-shrink-0" title="Error"></span>';
      return '<span class="inline-block h-2.5 w-2.5 rounded-full bg-muted/40 flex-shrink-0" title="Disconnected"></span>';
    }

    function renderMcpServers() {
      if (!mcpServerList) return;
      mcpServerList.innerHTML = "";

      if (mcpServers.length === 0) {
        if (mcpEmpty) mcpEmpty.classList.remove("hidden");
        mcpServerList.classList.add("hidden");
        if (mcpToolsSection) mcpToolsSection.classList.add("hidden");
        return;
      }

      if (mcpEmpty) mcpEmpty.classList.add("hidden");
      mcpServerList.classList.remove("hidden");

      mcpServers.forEach(function (server) {
        var card = document.createElement("div");
        card.className = "rounded-lg border border-dark/[0.08] bg-paper p-4";

        var lastCheck = server.last_check_at
          ? new Date(server.last_check_at + "Z").toLocaleString()
          : "Never";

        card.innerHTML =
          '<div class="flex items-start justify-between gap-3">' +
            '<div class="flex items-center gap-3 min-w-0">' +
              getStatusDot(server.status) +
              '<div class="min-w-0">' +
                '<h4 class="text-sm font-medium text-dark truncate">' + server.name + '</h4>' +
                '<p class="text-xs text-muted truncate">' + server.url + '</p>' +
              '</div>' +
            '</div>' +
            '<div class="flex items-center gap-2 flex-shrink-0">' +
              '<button type="button" class="mcp-discover-btn inline-flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-lg border border-dark/[0.08] text-dark hover:bg-dark/5 transition-colors cursor-pointer font-medium" data-server-id="' + server.id + '">' +
                '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>' +
                'Discover Tools' +
              '</button>' +
              '<button type="button" class="mcp-edit-btn text-muted hover:text-dark transition-colors cursor-pointer p-1" data-server-id="' + server.id + '" title="Edit">' +
                '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' +
              '</button>' +
              '<button type="button" class="mcp-delete-btn text-muted hover:text-coral transition-colors cursor-pointer p-1" data-server-id="' + server.id + '" title="Delete">' +
                '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>' +
              '</button>' +
            '</div>' +
          '</div>' +
          (server.error_message
            ? '<p class="text-xs text-coral mt-2">' + server.error_message + '</p>'
            : '') +
          '<div class="flex items-center gap-4 mt-2 text-xs text-muted">' +
            '<span>Status: ' + server.status + '</span>' +
            '<span>Last checked: ' + lastCheck + '</span>' +
          '</div>';

        mcpServerList.appendChild(card);
      });

      // Bind action buttons
      mcpServerList.querySelectorAll(".mcp-discover-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          discoverTools(btn.getAttribute("data-server-id"), btn);
        });
      });

      mcpServerList.querySelectorAll(".mcp-edit-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          openEditMcpModal(btn.getAttribute("data-server-id"));
        });
      });

      mcpServerList.querySelectorAll(".mcp-delete-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          openDeleteMcpModal(btn.getAttribute("data-server-id"));
        });
      });
    }

    function fetchMcpServers() {
      if (mcpLoading) { mcpLoading.classList.remove("hidden"); }
      if (mcpServerList) mcpServerList.classList.add("hidden");
      if (mcpEmpty) mcpEmpty.classList.add("hidden");

      fetch("/api/v1/integrations/mcp", { credentials: "same-origin" })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load MCP servers");
          return res.json();
        })
        .then(function (servers) {
          mcpLoaded = true;
          mcpServers = servers;
          if (mcpLoading) mcpLoading.classList.add("hidden");
          renderMcpServers();
          fetchMcpTools();
        })
        .catch(function (err) {
          if (mcpLoading) mcpLoading.classList.add("hidden");
          showToast(err.message, "error");
        });
    }

    function fetchMcpTools() {
      // Fetch all tools with tool_type='mcp' by fetching regular tools and filtering
      fetch("/api/v1/tools", { credentials: "same-origin" })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load tools");
          return res.json();
        })
        .then(function (body) {
          var tools = body.data || body;
          var mcpTools = tools.filter(function (t) { return t.tool_type === "mcp"; });
          renderMcpTools(mcpTools);
        })
        .catch(function () {
          // Silently ignore  tools section is supplementary
        });
    }

    function renderMcpTools(tools) {
      if (!mcpToolsList || !mcpToolsSection) return;

      if (tools.length === 0) {
        if (mcpServers.length > 0) {
          mcpToolsSection.classList.remove("hidden");
          mcpToolsList.classList.add("hidden");
          if (mcpToolsEmpty) mcpToolsEmpty.classList.remove("hidden");
        } else {
          mcpToolsSection.classList.add("hidden");
        }
        return;
      }

      mcpToolsSection.classList.remove("hidden");
      mcpToolsList.classList.remove("hidden");
      if (mcpToolsEmpty) mcpToolsEmpty.classList.add("hidden");
      mcpToolsList.innerHTML = "";

      tools.forEach(function (tool) {
        // Find source server name
        var serverName = "Unknown";
        mcpServers.forEach(function (s) {
          if (s.id === tool.code) serverName = s.name;
        });

        var el = document.createElement("div");
        el.className = "flex items-center justify-between rounded-md border border-dark/[0.06] px-3 py-2.5 bg-paper";
        el.innerHTML =
          '<div class="flex items-center gap-3 min-w-0">' +
            '<div class="flex-shrink-0 w-7 h-7 rounded-lg bg-zen-blue/10 flex items-center justify-center">' +
              '<svg class="h-3.5 w-3.5 text-zen-blue" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>' +
            '</div>' +
            '<div class="min-w-0">' +
              '<div class="flex items-center gap-2">' +
                '<span class="text-sm font-medium text-dark truncate">' + tool.name + '</span>' +
                '<span class="inline-flex items-center rounded-full bg-zen-blue/10 text-zen-blue px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide">MCP</span>' +
              '</div>' +
              '<p class="text-xs text-muted truncate">' + (tool.description || "No description") + '</p>' +
            '</div>' +
          '</div>' +
          '<span class="text-xs text-muted flex-shrink-0">from ' + serverName + '</span>';

        mcpToolsList.appendChild(el);
      });
    }

    function buildAuthConfig(form) {
      var authType = form.querySelector('[name="auth_type"]').value;
      if (authType === "bearer") {
        return { type: "bearer", token: form.querySelector('[name="auth_token"]').value };
      }
      if (authType === "api_key") {
        return {
          type: "api_key",
          key: form.querySelector('[name="auth_key"]').value,
          header: form.querySelector('[name="auth_header"]').value || "X-API-Key"
        };
      }
      return {};
    }

    function discoverTools(serverId, btn) {
      var origText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<svg class="h-3.5 w-3.5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Discovering...';

      fetch("/api/v1/integrations/mcp/" + serverId + "/discover", {
        method: "POST",
        credentials: "same-origin"
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Discovery failed"); });
          return res.json();
        })
        .then(function (tools) {
          showToast("Discovered " + tools.length + " tool" + (tools.length !== 1 ? "s" : ""), "success");
          fetchMcpServers(); // Refresh to update status
        })
        .catch(function (err) {
          showToast(err.message, "error");
        })
        .finally(function () {
          btn.disabled = false;
          btn.innerHTML = origText;
        });
    }

    // Open add modal
    if (addMcpBtn && addMcpModal) {
      addMcpBtn.addEventListener("click", function () {
        if (addMcpForm) addMcpForm.reset();
        if (addMcpError) addMcpError.classList.add("hidden");
        var bearer = document.getElementById("mcp-auth-bearer");
        var apikey = document.getElementById("mcp-auth-apikey");
        if (bearer) bearer.classList.add("hidden");
        if (apikey) apikey.classList.add("hidden");
        addMcpModal.showModal();
      });
    }

    // Submit add form
    if (addMcpForm) {
      addMcpForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (addMcpError) addMcpError.classList.add("hidden");

        var name = addMcpForm.querySelector('[name="name"]').value.trim();
        var url = addMcpForm.querySelector('[name="url"]').value.trim();
        if (!name || !url) {
          if (addMcpError) {
            addMcpError.textContent = "Name and URL are required.";
            addMcpError.classList.remove("hidden");
          }
          return;
        }

        if (addMcpSubmit) { addMcpSubmit.disabled = true; addMcpSubmit.textContent = "Adding..."; }

        // Get current project_id from URL or use default
        var projectId = new URLSearchParams(window.location.search).get("project_id") || "default";

        fetch("/api/v1/integrations/mcp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify({
            name: name,
            url: url,
            project_id: projectId,
            auth_config: buildAuthConfig(addMcpForm)
          })
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to add server"); });
            return res.json();
          })
          .then(function () {
            addMcpModal.close();
            showToast("MCP server added", "success");
            fetchMcpServers();
          })
          .catch(function (err) {
            if (addMcpError) {
              addMcpError.textContent = err.message;
              addMcpError.classList.remove("hidden");
            }
          })
          .finally(function () {
            if (addMcpSubmit) { addMcpSubmit.disabled = false; addMcpSubmit.textContent = "Add Server"; }
          });
      });
    }

    // Open edit modal
    function openEditMcpModal(serverId) {
      var server = mcpServers.find(function (s) { return s.id === serverId; });
      if (!server || !editMcpModal || !editMcpForm) return;

      editMcpForm.querySelector('[name="server_id"]').value = serverId;
      editMcpForm.querySelector('[name="name"]').value = server.name;
      editMcpForm.querySelector('[name="url"]').value = server.url;

      // Reset auth fields
      var authSelect = editMcpForm.querySelector('[name="auth_type"]');
      authSelect.value = "none";
      var bearer = document.getElementById("edit-mcp-auth-bearer");
      var apikey = document.getElementById("edit-mcp-auth-apikey");
      if (bearer) bearer.classList.add("hidden");
      if (apikey) apikey.classList.add("hidden");

      if (editMcpError) editMcpError.classList.add("hidden");
      editMcpModal.showModal();
    }

    // Submit edit form
    if (editMcpForm) {
      editMcpForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (editMcpError) editMcpError.classList.add("hidden");

        var serverId = editMcpForm.querySelector('[name="server_id"]').value;
        var name = editMcpForm.querySelector('[name="name"]').value.trim();
        var url = editMcpForm.querySelector('[name="url"]').value.trim();

        var body = {};
        if (name) body.name = name;
        if (url) body.url = url;
        var authConfig = buildAuthConfig(editMcpForm);
        if (Object.keys(authConfig).length > 0) body.auth_config = authConfig;

        if (editMcpSubmit) { editMcpSubmit.disabled = true; editMcpSubmit.textContent = "Saving..."; }

        fetch("/api/v1/integrations/mcp/" + serverId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify(body)
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to update server"); });
            return res.json();
          })
          .then(function () {
            editMcpModal.close();
            showToast("MCP server updated", "success");
            fetchMcpServers();
          })
          .catch(function (err) {
            if (editMcpError) {
              editMcpError.textContent = err.message;
              editMcpError.classList.remove("hidden");
            }
          })
          .finally(function () {
            if (editMcpSubmit) { editMcpSubmit.disabled = false; editMcpSubmit.textContent = "Save Changes"; }
          });
      });
    }

    // Open delete confirmation
    function openDeleteMcpModal(serverId) {
      var server = mcpServers.find(function (s) { return s.id === serverId; });
      if (!server || !deleteMcpModal) return;
      deleteTargetId = serverId;
      if (deleteMcpName) deleteMcpName.textContent = server.name + " (" + server.url + ")";
      deleteMcpModal.showModal();
    }

    // Confirm delete
    if (confirmDeleteMcp) {
      confirmDeleteMcp.addEventListener("click", function () {
        if (!deleteTargetId) return;

        confirmDeleteMcp.disabled = true;
        confirmDeleteMcp.textContent = "Deleting...";

        fetch("/api/v1/integrations/mcp/" + deleteTargetId, {
          method: "DELETE",
          credentials: "same-origin"
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to delete server"); });
            deleteMcpModal.close();
            deleteTargetId = null;
            showToast("MCP server deleted", "success");
            fetchMcpServers();
          })
          .catch(function (err) {
            showToast(err.message, "error");
            deleteMcpModal.close();
          })
          .finally(function () {
            confirmDeleteMcp.disabled = false;
            confirmDeleteMcp.textContent = "Delete Server";
          });
      });
    }

    // ------- Observability Integrations -------
    var obsLoaded = false;
    var obsIntegrations = [];
    var obsList = document.getElementById("obs-list");
    var obsLoading = document.getElementById("obs-loading");
    var obsEmpty = document.getElementById("obs-empty");

    // Platform display metadata
    var obsPlatforms = {
      langfuse: { label: "Langfuse", color: "zen-blue" },
      langsmith: { label: "LangSmith", color: "zen-green" },
      datadog: { label: "Datadog", color: "coral" },
      opik: { label: "Opik", color: "zen-blue" },
      custom_webhook: { label: "Custom Webhook", color: "muted" }
    };

    // Add modal elements
    var addObsModal = document.getElementById("add-obs-modal");
    var addObsForm = document.getElementById("add-obs-form");
    var addObsError = document.getElementById("add-obs-error");
    var addObsSubmit = document.getElementById("add-obs-submit");
    var addObsBtn = document.getElementById("add-obs-btn");

    // Edit modal elements
    var editObsModal = document.getElementById("edit-obs-modal");
    var editObsForm = document.getElementById("edit-obs-form");
    var editObsError = document.getElementById("edit-obs-error");
    var editObsSubmit = document.getElementById("edit-obs-submit");

    // Delete modal elements
    var deleteObsModal = document.getElementById("delete-obs-modal");
    var deleteObsName = document.getElementById("delete-obs-name");
    var confirmDeleteObs = document.getElementById("confirm-delete-obs");
    var deleteObsTargetId = null;

    // Show/hide Langfuse public key field in add modal
    var addObsPlatformSelect = addObsForm ? addObsForm.querySelector('[name="platform"]') : null;
    if (addObsPlatformSelect) {
      addObsPlatformSelect.addEventListener("change", function () {
        var extra = document.getElementById("obs-add-langfuse-extra");
        if (extra) extra.classList.toggle("hidden", addObsPlatformSelect.value !== "langfuse");
      });
    }

    function getObsStatusDot(integration) {
      if (!integration.enabled) return '<span class="inline-block h-2.5 w-2.5 rounded-full bg-muted/40 flex-shrink-0" title="Disabled"></span>';
      if (integration.last_test_status === "success") return '<span class="inline-block h-2.5 w-2.5 rounded-full bg-zen-green flex-shrink-0" title="Connected"></span>';
      if (integration.last_test_status === "error") return '<span class="inline-block h-2.5 w-2.5 rounded-full bg-coral flex-shrink-0" title="Error"></span>';
      return '<span class="inline-block h-2.5 w-2.5 rounded-full bg-amber-400 flex-shrink-0" title="Untested"></span>';
    }

    function renderObsIntegrations() {
      if (!obsList) return;
      obsList.innerHTML = "";

      if (obsIntegrations.length === 0) {
        if (obsEmpty) obsEmpty.classList.remove("hidden");
        obsList.classList.add("hidden");
        return;
      }

      if (obsEmpty) obsEmpty.classList.add("hidden");
      obsList.classList.remove("hidden");

      obsIntegrations.forEach(function (intg) {
        var info = obsPlatforms[intg.platform] || { label: intg.platform, color: "muted" };
        var lastTest = intg.last_test_at
          ? new Date(intg.last_test_at + "Z").toLocaleString()
          : "Never";

        var card = document.createElement("div");
        card.className = "rounded-lg border border-dark/[0.08] bg-paper p-4";

        card.innerHTML =
          '<div class="flex items-start justify-between gap-3">' +
            '<div class="flex items-center gap-3 min-w-0">' +
              getObsStatusDot(intg) +
              '<div class="min-w-0">' +
                '<div class="flex items-center gap-2">' +
                  '<h4 class="text-sm font-medium text-dark truncate">' + intg.display_name + '</h4>' +
                  '<span class="inline-flex items-center rounded-full bg-' + info.color + '/10 text-' + info.color + ' px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide">' + info.label + '</span>' +
                '</div>' +
                '<p class="text-xs text-muted truncate">' + (intg.endpoint_url || "Default endpoint") + '</p>' +
              '</div>' +
            '</div>' +
            '<div class="flex items-center gap-2 flex-shrink-0">' +
              '<button type="button" class="obs-test-btn inline-flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-lg border border-dark/[0.08] text-dark hover:bg-dark/5 transition-colors cursor-pointer font-medium" data-id="' + intg.id + '">' +
                '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>' +
                'Test' +
              '</button>' +
              '<label class="relative inline-flex items-center cursor-pointer">' +
                '<input type="checkbox" class="obs-toggle sr-only peer" data-id="' + intg.id + '"' + (intg.enabled ? " checked" : "") + '>' +
                '<div class="w-9 h-5 bg-muted/30 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[\'\'] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-zen-green"></div>' +
              '</label>' +
              '<button type="button" class="obs-edit-btn text-muted hover:text-dark transition-colors cursor-pointer p-1" data-id="' + intg.id + '" title="Edit">' +
                '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' +
              '</button>' +
              '<button type="button" class="obs-delete-btn text-muted hover:text-coral transition-colors cursor-pointer p-1" data-id="' + intg.id + '" title="Delete">' +
                '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>' +
              '</button>' +
            '</div>' +
          '</div>' +
          (intg.last_test_error
            ? '<p class="text-xs text-coral mt-2">' + intg.last_test_error + '</p>'
            : '') +
          '<div class="flex items-center gap-4 mt-2 text-xs text-muted">' +
            '<span>Key: ' + (intg.api_key_set ? "configured" : "not set") + '</span>' +
            (intg.project_name ? '<span>Project: ' + intg.project_name + '</span>' : '') +
            '<span>Last test: ' + lastTest + '</span>' +
          '</div>';

        obsList.appendChild(card);
      });

      // Bind action buttons
      obsList.querySelectorAll(".obs-test-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          testObsIntegration(btn.getAttribute("data-id"), btn);
        });
      });

      obsList.querySelectorAll(".obs-toggle").forEach(function (toggle) {
        toggle.addEventListener("change", function () {
          toggleObsIntegration(toggle.getAttribute("data-id"), toggle.checked);
        });
      });

      obsList.querySelectorAll(".obs-edit-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          openEditObsModal(btn.getAttribute("data-id"));
        });
      });

      obsList.querySelectorAll(".obs-delete-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          openDeleteObsModal(btn.getAttribute("data-id"));
        });
      });
    }

    function fetchObsIntegrations() {
      if (obsLoading) obsLoading.classList.remove("hidden");
      if (obsList) obsList.classList.add("hidden");
      if (obsEmpty) obsEmpty.classList.add("hidden");

      fetch("/api/v1/observability", { credentials: "same-origin" })
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load observability integrations");
          return res.json();
        })
        .then(function (data) {
          obsLoaded = true;
          obsIntegrations = data;
          if (obsLoading) obsLoading.classList.add("hidden");
          renderObsIntegrations();
        })
        .catch(function (err) {
          if (obsLoading) obsLoading.classList.add("hidden");
          showToast(err.message, "error");
        });
    }

    function testObsIntegration(id, btn) {
      var origText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<svg class="h-3.5 w-3.5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Testing...';

      fetch("/api/v1/observability/" + id + "/test", {
        method: "POST",
        credentials: "same-origin"
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Test failed"); });
          return res.json();
        })
        .then(function (result) {
          if (result.status === "success") {
            showToast("Integration test passed!", "success");
          } else {
            showToast("Test failed: " + (result.error || "Unknown error"), "error");
          }
          fetchObsIntegrations();
        })
        .catch(function (err) {
          showToast(err.message, "error");
        })
        .finally(function () {
          btn.disabled = false;
          btn.innerHTML = origText;
        });
    }

    function toggleObsIntegration(id, enabled) {
      fetch("/api/v1/observability/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ enabled: enabled })
      })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Toggle failed"); });
          showToast(enabled ? "Integration enabled" : "Integration disabled", "success");
          return res.json();
        })
        .then(function () {
          fetchObsIntegrations();
        })
        .catch(function (err) {
          showToast(err.message, "error");
          fetchObsIntegrations(); // Re-render to reset toggle
        });
    }

    // Open add modal
    if (addObsBtn && addObsModal) {
      addObsBtn.addEventListener("click", function () {
        if (addObsForm) addObsForm.reset();
        if (addObsError) addObsError.classList.add("hidden");
        var extra = document.getElementById("obs-add-langfuse-extra");
        if (extra) extra.classList.add("hidden");
        addObsModal.showModal();
      });
    }

    // Submit add form
    if (addObsForm) {
      addObsForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (addObsError) addObsError.classList.add("hidden");

        var platform = addObsForm.querySelector('[name="platform"]').value;
        var displayName = addObsForm.querySelector('[name="display_name"]').value.trim();
        if (!platform || !displayName) {
          if (addObsError) {
            addObsError.textContent = "Platform and display name are required.";
            addObsError.classList.remove("hidden");
          }
          return;
        }

        var extraConfig = {};
        if (platform === "langfuse") {
          var pubKey = addObsForm.querySelector('[name="public_key"]');
          if (pubKey && pubKey.value.trim()) {
            extraConfig.public_key = pubKey.value.trim();
          }
        }

        if (addObsSubmit) { addObsSubmit.disabled = true; addObsSubmit.textContent = "Adding..."; }

        fetch("/api/v1/observability", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify({
            platform: platform,
            display_name: displayName,
            endpoint_url: addObsForm.querySelector('[name="endpoint_url"]').value.trim(),
            api_key: addObsForm.querySelector('[name="api_key"]').value,
            project_name: addObsForm.querySelector('[name="project_name"]').value.trim(),
            extra_config: extraConfig
          })
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to add integration"); });
            return res.json();
          })
          .then(function () {
            addObsModal.close();
            showToast("Observability integration added", "success");
            fetchObsIntegrations();
          })
          .catch(function (err) {
            if (addObsError) {
              addObsError.textContent = err.message;
              addObsError.classList.remove("hidden");
            }
          })
          .finally(function () {
            if (addObsSubmit) { addObsSubmit.disabled = false; addObsSubmit.textContent = "Add Integration"; }
          });
      });
    }

    // Open edit modal
    function openEditObsModal(id) {
      var intg = obsIntegrations.find(function (i) { return i.id === id; });
      if (!intg || !editObsModal || !editObsForm) return;

      editObsForm.querySelector('[name="integration_id"]').value = id;
      editObsForm.querySelector('[name="display_name"]').value = intg.display_name;
      editObsForm.querySelector('[name="endpoint_url"]').value = intg.endpoint_url || "";
      editObsForm.querySelector('[name="api_key"]').value = "";
      editObsForm.querySelector('[name="project_name"]').value = intg.project_name || "";

      // Show Langfuse extra field if applicable
      var extra = document.getElementById("obs-edit-langfuse-extra");
      if (extra) {
        extra.classList.toggle("hidden", intg.platform !== "langfuse");
        var pubKeyInput = editObsForm.querySelector('[name="public_key"]');
        if (pubKeyInput) {
          pubKeyInput.value = (intg.extra_config && intg.extra_config.public_key) || "";
        }
      }

      if (editObsError) editObsError.classList.add("hidden");
      editObsModal.showModal();
    }

    // Submit edit form
    if (editObsForm) {
      editObsForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (editObsError) editObsError.classList.add("hidden");

        var id = editObsForm.querySelector('[name="integration_id"]').value;
        var intg = obsIntegrations.find(function (i) { return i.id === id; });
        var body = {};

        var displayName = editObsForm.querySelector('[name="display_name"]').value.trim();
        if (displayName) body.display_name = displayName;
        var endpointUrl = editObsForm.querySelector('[name="endpoint_url"]').value.trim();
        if (endpointUrl) body.endpoint_url = endpointUrl;
        var apiKey = editObsForm.querySelector('[name="api_key"]').value;
        if (apiKey) body.api_key = apiKey;
        var projectName = editObsForm.querySelector('[name="project_name"]').value.trim();
        body.project_name = projectName;

        // Handle Langfuse public key
        if (intg && intg.platform === "langfuse") {
          var pubKeyInput = editObsForm.querySelector('[name="public_key"]');
          var existing = (intg.extra_config && intg.extra_config.public_key) || "";
          var newPub = pubKeyInput ? pubKeyInput.value.trim() : "";
          if (newPub !== existing) {
            body.extra_config = Object.assign({}, intg.extra_config || {}, { public_key: newPub });
          }
        }

        if (Object.keys(body).length === 0) {
          if (editObsError) {
            editObsError.textContent = "No changes to save.";
            editObsError.classList.remove("hidden");
          }
          return;
        }

        if (editObsSubmit) { editObsSubmit.disabled = true; editObsSubmit.textContent = "Saving..."; }

        fetch("/api/v1/observability/" + id, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify(body)
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to update integration"); });
            return res.json();
          })
          .then(function () {
            editObsModal.close();
            showToast("Integration updated", "success");
            fetchObsIntegrations();
          })
          .catch(function (err) {
            if (editObsError) {
              editObsError.textContent = err.message;
              editObsError.classList.remove("hidden");
            }
          })
          .finally(function () {
            if (editObsSubmit) { editObsSubmit.disabled = false; editObsSubmit.textContent = "Save Changes"; }
          });
      });
    }

    // Open delete confirmation
    function openDeleteObsModal(id) {
      var intg = obsIntegrations.find(function (i) { return i.id === id; });
      if (!intg || !deleteObsModal) return;
      deleteObsTargetId = id;
      if (deleteObsName) deleteObsName.textContent = intg.display_name + " (" + (obsPlatforms[intg.platform] || {}).label + ")";
      deleteObsModal.showModal();
    }

    // Confirm delete
    if (confirmDeleteObs) {
      confirmDeleteObs.addEventListener("click", function () {
        if (!deleteObsTargetId) return;

        confirmDeleteObs.disabled = true;
        confirmDeleteObs.textContent = "Deleting...";

        fetch("/api/v1/observability/" + deleteObsTargetId, {
          method: "DELETE",
          credentials: "same-origin"
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to delete integration"); });
            deleteObsModal.close();
            deleteObsTargetId = null;
            showToast("Integration deleted", "success");
            fetchObsIntegrations();
          })
          .catch(function (err) {
            showToast(err.message, "error");
            deleteObsModal.close();
          })
          .finally(function () {
            confirmDeleteObs.disabled = false;
            confirmDeleteObs.textContent = "Delete Integration";
          });
      });
    }

  })();
</script>
