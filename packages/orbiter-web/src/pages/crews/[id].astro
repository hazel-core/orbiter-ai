---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Agents", href: "/agents" },
  { label: "Crew Detail" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const playIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
const checkIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
const xIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
const clockIcon = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';
const userIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
const layersIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>';
---

<PageLayout
  title="Crew Detail"
  description="View and execute crew"
  activeSection="agents"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-5xl mx-auto">
    <!-- Back link -->
    <a href="/agents" class="inline-flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors mb-6">
      <span set:html={backIcon} />
      Back to Agents
    </a>

    <!-- Crew header (populated by JS) -->
    <div id="crew-header" class="mb-8">
      <div class="flex items-start justify-between gap-4 mb-2">
        <div>
          <h1 id="crew-name" class="text-2xl font-semibold text-dark">Loading...</h1>
          <p id="crew-description" class="text-sm text-muted mt-1"></p>
        </div>
        <div class="flex items-center gap-3">
          <span id="crew-process-badge" class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium border border-dark/[0.08] bg-paper text-muted">
            <span set:html={layersIcon} />
            <span id="crew-process-type">—</span>
          </span>
          <Button variant="primary" id="run-btn">
            <span set:html={playIcon} />
            Run Crew
          </Button>
        </div>
      </div>
    </div>

    <!-- Input section -->
    <div id="input-section" class="rounded-xl border border-dark/[0.08] bg-paper p-5 mb-6">
      <label class="block text-sm font-medium text-dark mb-1.5" for="crew-input">
        Crew Input <span class="text-muted font-normal">(optional)</span>
      </label>
      <textarea
        id="crew-input"
        rows="3"
        placeholder="Provide context or instructions for the crew..."
        class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all resize-y"
      ></textarea>
    </div>

    <!-- Task list (crew definition) -->
    <div id="tasks-section" class="rounded-xl border border-dark/[0.08] bg-paper p-5 mb-6">
      <h2 class="text-lg font-semibold text-dark mb-1">Tasks</h2>
      <p class="text-sm text-muted mb-4">Agents assigned to this crew and their tasks.</p>
      <div id="tasks-list" class="space-y-3">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Execution timeline -->
    <div id="execution-section" class="hidden">
      <div class="rounded-xl border border-dark/[0.08] bg-paper p-5 mb-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-lg font-semibold text-dark">Execution Timeline</h2>
            <p id="execution-status" class="text-sm text-muted mt-0.5">Waiting to start...</p>
          </div>
          <div id="execution-timer" class="text-sm font-mono text-muted">00:00</div>
        </div>

        <!-- Timeline container -->
        <div id="timeline-container" class="relative">
          <!-- Horizontal timeline bar -->
          <div class="relative overflow-x-auto pb-4">
            <div id="timeline-track" class="relative min-h-[120px]">
              <!-- Task nodes rendered by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- Task output panels -->
      <div id="task-outputs" class="space-y-4">
        <!-- Rendered by JS on task completion -->
      </div>
    </div>

    <!-- Run history -->
    <div id="history-section" class="rounded-xl border border-dark/[0.08] bg-paper p-5">
      <h2 class="text-lg font-semibold text-dark mb-1">Run History</h2>
      <p class="text-sm text-muted mb-4">Previous crew executions.</p>
      <div id="history-list" class="space-y-2">
        <p class="text-sm text-muted italic">Loading...</p>
      </div>
    </div>
  </div>
</PageLayout>

<style>
  /* Timeline styles */
  .timeline-node {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 160px;
    flex: 1;
  }
  .timeline-dot {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--zen-dark);
    opacity: 0.15;
    transition: all 0.3s ease;
    position: relative;
    z-index: 2;
  }
  .timeline-dot.pending {
    opacity: 0.15;
    border-color: var(--zen-dark);
    background: transparent;
  }
  .timeline-dot.running {
    opacity: 1;
    border-color: var(--zen-blue);
    background: var(--zen-blue);
    color: white;
    animation: pulse-ring 1.5s ease-in-out infinite;
  }
  .timeline-dot.completed {
    opacity: 1;
    border-color: var(--zen-green);
    background: var(--zen-green);
    color: white;
  }
  .timeline-dot.failed {
    opacity: 1;
    border-color: var(--zen-coral);
    background: var(--zen-coral);
    color: white;
  }
  .timeline-connector {
    position: absolute;
    top: 18px;
    height: 2px;
    background: var(--zen-dark);
    opacity: 0.1;
    transition: all 0.3s ease;
    z-index: 1;
  }
  .timeline-connector.active {
    opacity: 1;
    background: var(--zen-green);
  }
  @keyframes pulse-ring {
    0% { box-shadow: 0 0 0 0 rgba(98, 135, 245, 0.4); }
    70% { box-shadow: 0 0 0 8px rgba(98, 135, 245, 0); }
    100% { box-shadow: 0 0 0 0 rgba(98, 135, 245, 0); }
  }
  .output-panel {
    max-height: 200px;
    overflow-y: auto;
  }
</style>

<script is:inline define:vars={{ id, checkIcon, xIcon, clockIcon, userIcon, playIcon }}>
(function() {
  const crewId = id;
  let crew = null;
  let currentRunId = null;
  let ws = null;
  let timerInterval = null;
  let timerStart = null;
  let taskStates = {};

  // -----------------------------------------------------------------------
  // Load crew data
  // -----------------------------------------------------------------------
  async function loadCrew() {
    try {
      const resp = await fetch(`/api/crews/${crewId}`);
      if (!resp.ok) { window.location.href = "/agents"; return; }
      crew = await resp.json();

      document.getElementById("crew-name").textContent = crew.name;
      document.getElementById("crew-description").textContent = crew.description || "No description";
      document.getElementById("crew-process-type").textContent = crew.process_type === "parallel" ? "Parallel" : "Sequential";

      renderTasks(crew.tasks);
      loadHistory();
    } catch (e) {
      console.error("Failed to load crew:", e);
    }
  }

  function renderTasks(tasks) {
    const container = document.getElementById("tasks-list");
    if (!tasks || tasks.length === 0) {
      container.innerHTML = '<p class="text-sm text-muted italic">No tasks defined.</p>';
      return;
    }
    container.innerHTML = tasks.map((t, i) => `
      <div class="flex items-start gap-3 p-3 rounded-lg border border-dark/[0.06] bg-dark/[0.02]">
        <div class="flex items-center justify-center w-7 h-7 rounded-full bg-dark/[0.06] text-xs font-semibold text-dark shrink-0 mt-0.5">${i + 1}</div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-0.5">
            <span class="text-sm font-medium text-dark">${t.task_description || 'Unnamed task'}</span>
          </div>
          ${t.expected_output ? `<p class="text-xs text-muted truncate">Expected: ${t.expected_output}</p>` : ''}
        </div>
      </div>
    `).join('');
  }

  // -----------------------------------------------------------------------
  // Run crew
  // -----------------------------------------------------------------------
  async function runCrew() {
    if (!crew) return;

    const input = document.getElementById("crew-input").value.trim();
    const runBtn = document.getElementById("run-btn");
    runBtn.disabled = true;
    runBtn.style.opacity = "0.5";

    try {
      const resp = await fetch(`/api/crews/${crewId}/run`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ input }),
      });
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        alert(err.detail || "Failed to start crew execution");
        runBtn.disabled = false;
        runBtn.style.opacity = "1";
        return;
      }

      const data = await resp.json();
      currentRunId = data.run_id;
      taskStates = {};

      showExecution();
      connectWebSocket();
    } catch (e) {
      console.error("Run crew error:", e);
      runBtn.disabled = false;
      runBtn.style.opacity = "1";
    }
  }

  // -----------------------------------------------------------------------
  // Execution UI
  // -----------------------------------------------------------------------
  function showExecution() {
    document.getElementById("execution-section").classList.remove("hidden");
    document.getElementById("execution-status").textContent = "Starting...";
    document.getElementById("task-outputs").innerHTML = "";

    // Build timeline nodes
    const track = document.getElementById("timeline-track");
    const tasks = crew.tasks || [];
    track.innerHTML = "";

    // Container for nodes
    const nodesRow = document.createElement("div");
    nodesRow.className = "flex items-start gap-0 relative";
    nodesRow.style.minWidth = (tasks.length * 180) + "px";

    tasks.forEach((t, i) => {
      const node = document.createElement("div");
      node.className = "timeline-node";
      node.id = `tnode-${i}`;

      // Connector (before each node except first)
      if (i > 0) {
        const connector = document.createElement("div");
        connector.className = "timeline-connector";
        connector.id = `tconn-${i}`;
        connector.style.left = ((i - 1) * 180 + 90 + 18) + "px";
        connector.style.width = (180 - 36) + "px";
        track.appendChild(connector);
      }

      node.innerHTML = `
        <div class="timeline-dot pending" id="tdot-${i}">
          <span class="text-xs font-semibold">${i + 1}</span>
        </div>
        <div class="mt-2 text-center px-2">
          <p class="text-xs font-medium text-dark truncate max-w-[140px]">${t.task_description ? t.task_description.slice(0, 30) : 'Task ' + (i + 1)}</p>
          <p class="text-[10px] text-muted mt-0.5" id="tdur-${i}">Pending</p>
        </div>
      `;
      nodesRow.appendChild(node);
    });

    track.appendChild(nodesRow);

    // Start timer
    timerStart = Date.now();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 1000);
  }

  function updateTimer() {
    if (!timerStart) return;
    const elapsed = Math.floor((Date.now() - timerStart) / 1000);
    const mins = String(Math.floor(elapsed / 60)).padStart(2, "0");
    const secs = String(elapsed % 60).padStart(2, "0");
    document.getElementById("execution-timer").textContent = `${mins}:${secs}`;
  }

  function updateTaskNode(taskIndex, status, durationMs) {
    const dot = document.getElementById(`tdot-${taskIndex}`);
    const dur = document.getElementById(`tdur-${taskIndex}`);
    if (!dot) return;

    dot.className = `timeline-dot ${status}`;
    if (status === "running") {
      dot.innerHTML = '<span class="animate-spin text-xs">&#9696;</span>';
      if (dur) dur.textContent = "Running...";
    } else if (status === "completed") {
      dot.innerHTML = checkIcon;
      if (dur && durationMs !== undefined) {
        dur.textContent = formatDuration(durationMs);
      }
      // Activate connector
      const conn = document.getElementById(`tconn-${taskIndex + 1}`);
      if (conn) conn.className = "timeline-connector active";
      // Also mark the connector before this node
      const prevConn = document.getElementById(`tconn-${taskIndex}`);
      if (prevConn) prevConn.className = "timeline-connector active";
    } else if (status === "failed") {
      dot.innerHTML = xIcon;
      if (dur && durationMs !== undefined) {
        dur.textContent = formatDuration(durationMs);
      }
    }
  }

  function formatDuration(ms) {
    if (ms < 1000) return ms + "ms";
    const secs = (ms / 1000).toFixed(1);
    return secs + "s";
  }

  function addTaskOutput(agentName, status, output, error, durationMs) {
    const container = document.getElementById("task-outputs");
    const panel = document.createElement("div");
    const isError = status === "failed";
    const borderColor = isError ? "border-coral/30" : "border-zen-green/30";
    const badgeBg = isError ? "bg-coral/10 text-coral" : "bg-zen-green/10 text-zen-green";
    const badgeText = isError ? "Failed" : "Completed";

    panel.className = `rounded-xl border ${borderColor} bg-paper p-5`;
    panel.innerHTML = `
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center gap-1 text-sm font-medium text-dark">${userIcon} ${agentName}</span>
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium ${badgeBg}">${badgeText}</span>
        </div>
        <span class="inline-flex items-center gap-1 text-xs text-muted">${clockIcon} ${formatDuration(durationMs || 0)}</span>
      </div>
      ${error ? `<div class="text-sm text-coral bg-coral/5 rounded-lg p-3 mb-2">${escapeHtml(error)}</div>` : ''}
      ${output ? `<div class="output-panel text-sm text-dark bg-dark/[0.02] rounded-lg p-3 whitespace-pre-wrap font-mono text-xs leading-relaxed">${escapeHtml(output)}</div>` : '<p class="text-sm text-muted italic">No output</p>'}
    `;
    container.appendChild(panel);
  }

  function escapeHtml(str) {
    const div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  // -----------------------------------------------------------------------
  // WebSocket
  // -----------------------------------------------------------------------
  function connectWebSocket() {
    if (ws) { ws.close(); ws = null; }

    const protocol = location.protocol === "https:" ? "wss:" : "ws:";
    const url = `${protocol}//${location.host}/api/crews/${crewId}/runs/${currentRunId}/stream`;
    ws = new WebSocket(url);

    let taskIndexMap = {};
    let nextIndex = 0;

    ws.onmessage = function(evt) {
      const event = JSON.parse(evt.data);

      if (event.type === "execution_started") {
        document.getElementById("execution-status").textContent = `Running (${event.process_type})...`;
      }

      if (event.type === "task_started") {
        const idx = event.task_order !== undefined ? event.task_order : nextIndex;
        taskIndexMap[event.task_id] = idx;
        nextIndex = Math.max(nextIndex, idx + 1);
        taskStates[event.task_id] = { status: "running", agentName: event.agent_name };
        updateTaskNode(idx, "running");
      }

      if (event.type === "task_completed") {
        const idx = taskIndexMap[event.task_id] !== undefined ? taskIndexMap[event.task_id] : Object.keys(taskIndexMap).length;
        taskStates[event.task_id] = { status: event.status, agentName: event.agent_name };
        updateTaskNode(idx, event.status, event.duration_ms);
        addTaskOutput(event.agent_name, event.status, event.output, event.error, event.duration_ms);
      }

      if (event.type === "execution_completed") {
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        const statusText = event.status === "completed" ? "All tasks completed successfully" :
                          event.status === "partial" ? "Some tasks failed" : "Execution failed";
        const statusColor = event.status === "completed" ? "text-zen-green" : "text-coral";
        document.getElementById("execution-status").innerHTML = `<span class="${statusColor} font-medium">${statusText}</span>`;

        const runBtn = document.getElementById("run-btn");
        runBtn.disabled = false;
        runBtn.style.opacity = "1";

        ws.close();
        ws = null;
        loadHistory();
      }
    };

    ws.onerror = function() {
      console.error("WebSocket error");
    };

    ws.onclose = function() {
      ws = null;
    };
  }

  // -----------------------------------------------------------------------
  // Run history
  // -----------------------------------------------------------------------
  async function loadHistory() {
    try {
      const resp = await fetch(`/api/crews/${crewId}/runs?limit=10`);
      if (!resp.ok) return;
      const data = await resp.json();

      const container = document.getElementById("history-list");
      if (!data.runs || data.runs.length === 0) {
        container.innerHTML = '<p class="text-sm text-muted italic">No previous runs.</p>';
        return;
      }

      container.innerHTML = data.runs.map(r => {
        const statusColors = {
          completed: "bg-zen-green/10 text-zen-green",
          partial: "bg-amber-100 text-amber-700",
          failed: "bg-coral/10 text-coral",
          running: "bg-zen-blue/10 text-zen-blue",
          pending: "bg-dark/5 text-muted",
        };
        const badgeClass = statusColors[r.status] || statusColors.pending;
        const date = r.created_at ? new Date(r.created_at + "Z").toLocaleString() : "—";

        return `
          <div class="flex items-center justify-between p-3 rounded-lg border border-dark/[0.06] hover:bg-dark/[0.02] transition-colors">
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium ${badgeClass}">${r.status}</span>
              <span class="text-xs text-muted">${r.process_type}</span>
            </div>
            <span class="text-xs text-muted">${date}</span>
          </div>
        `;
      }).join('');
    } catch (e) {
      console.error("Failed to load history:", e);
    }
  }

  // -----------------------------------------------------------------------
  // Init
  // -----------------------------------------------------------------------
  document.getElementById("run-btn").addEventListener("click", runCrew);
  loadCrew();
})();
</script>
