---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";

const breadcrumbs = [
  { label: "Agents", href: "/agents" },
  { label: "New Crew" },
];

/* Icons */
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const removeIcon = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
const dragIcon = '<svg class="h-4 w-4 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="6" r="1"/><circle cx="15" cy="6" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="9" cy="18" r="1"/><circle cx="15" cy="18" r="1"/></svg>';
const searchIcon = '<svg class="h-4 w-4 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
const chevronDown = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';
const chevronUp = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>';
---

<PageLayout
  title="Create Crew"
  description="Build a crew of agents with defined tasks"
  activeSection="agents"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Back link -->
    <a href="/agents" class="inline-flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors mb-6">
      <span set:html={backIcon} />
      Back to Agents
    </a>

    <h1 class="text-2xl font-semibold text-dark mb-2">Create Crew</h1>
    <p class="text-sm text-muted mb-8">Organize agents into a crew with defined tasks and execution order.</p>

    <!-- Crew details section -->
    <div class="rounded-xl border border-dark/[0.08] bg-paper p-6 mb-6">
      <h2 class="text-lg font-semibold text-dark mb-1">Crew Details</h2>
      <p class="text-sm text-muted mb-6">Basic information about the crew.</p>

      <!-- Crew name -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-dark mb-1.5" for="crew-name">
          Name <span class="text-coral">*</span>
        </label>
        <input
          type="text"
          id="crew-name"
          placeholder="e.g. Research Team, Content Pipeline"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all"
        />
      </div>

      <!-- Description -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-dark mb-1.5" for="crew-description">
          Description
        </label>
        <textarea
          id="crew-description"
          placeholder="Describe the crew's purpose and goals..."
          rows="3"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all resize-y"
        ></textarea>
      </div>

      <!-- Project selector -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-dark mb-1.5" for="crew-project">
          Project <span class="text-coral">*</span>
        </label>
        <select
          id="crew-project"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-8 cursor-pointer transition-all"
        >
          <option value="">Select a project...</option>
        </select>
      </div>

      <!-- Process type selector -->
      <div class="mb-2">
        <label class="block text-sm font-medium text-dark mb-1.5">
          Process Type <span class="text-coral">*</span>
        </label>
        <div class="flex gap-3">
          <label class="flex-1 relative cursor-pointer">
            <input type="radio" name="process-type" value="sequential" checked class="peer sr-only" />
            <div class="rounded-lg border-2 border-dark/[0.08] p-4 transition-all peer-checked:border-coral peer-checked:bg-coral/5">
              <div class="flex items-center gap-2 mb-1">
                <svg class="h-5 w-5 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                <span class="text-sm font-semibold text-dark">Sequential</span>
              </div>
              <p class="text-xs text-muted">Tasks execute in order. Output of one feeds into the next.</p>
            </div>
          </label>
          <label class="flex-1 relative cursor-pointer">
            <input type="radio" name="process-type" value="parallel" class="peer sr-only" />
            <div class="rounded-lg border-2 border-dark/[0.08] p-4 transition-all peer-checked:border-coral peer-checked:bg-coral/5">
              <div class="flex items-center gap-2 mb-1">
                <svg class="h-5 w-5 text-zen-blue" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                <span class="text-sm font-semibold text-dark">Parallel</span>
              </div>
              <p class="text-xs text-muted">Independent tasks run simultaneously. No chaining.</p>
            </div>
          </label>
        </div>
      </div>

      <!-- Delegation toggle -->
      <div class="mt-5 flex items-center gap-3 p-3 rounded-lg bg-subtle">
        <div class="flex-1">
          <div class="text-sm font-medium text-dark">Allow Delegation</div>
          <div class="text-xs text-muted">Agents can create sub-tasks for other crew members</div>
        </div>
        <button
          type="button"
          id="delegation-toggle"
          class="relative inline-flex h-5 w-9 items-center rounded-full bg-dark/20 transition-colors cursor-pointer"
          aria-checked="false"
          role="switch"
        >
          <span class="inline-block h-4 w-4 rounded-full bg-paper shadow-sm transition-transform translate-x-0.5"></span>
        </button>
      </div>
    </div>

    <!-- Agent tasks section -->
    <div class="rounded-xl border border-dark/[0.08] bg-paper p-6 mb-6">
      <div class="flex items-center justify-between mb-1">
        <h2 class="text-lg font-semibold text-dark">Tasks</h2>
        <span id="task-count" class="text-xs text-muted px-2 py-0.5 rounded-full bg-subtle">0 tasks</span>
      </div>
      <p class="text-sm text-muted mb-6">Add agents and define their tasks. Drag to reorder in sequential mode.</p>

      <!-- Add agent selector -->
      <div class="flex items-center gap-2 mb-4">
        <div class="relative flex-1">
          <span class="absolute left-3 top-1/2 -translate-y-1/2" set:html={searchIcon}></span>
          <select
            id="agent-selector"
            class="w-full bg-paper border border-dark/[0.08] rounded-lg pl-9 pr-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none cursor-pointer transition-all"
          >
            <option value="">Select an agent to add...</option>
          </select>
        </div>
        <button
          type="button"
          id="add-agent-btn"
          class="inline-flex items-center gap-1.5 px-4 py-2 rounded-lg bg-coral text-paper text-sm font-medium hover:bg-coral/90 transition-colors cursor-pointer"
        >
          <span set:html={plusIcon} />
          Add
        </button>
      </div>

      <!-- Task list (drag-reorderable) -->
      <div id="task-list" class="flex flex-col gap-3">
        <!-- Tasks inserted here dynamically -->
      </div>

      <!-- Empty state -->
      <div id="task-empty" class="flex flex-col items-center py-12 text-center">
        <svg class="h-10 w-10 text-muted/30 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>
        <p class="text-sm text-muted">No tasks yet. Select an agent above to add a task.</p>
      </div>
    </div>

    <!-- Action bar -->
    <div class="flex items-center justify-between">
      <a href="/agents" class="text-sm text-muted hover:text-dark transition-colors">Cancel</a>
      <div class="flex items-center gap-3">
        <button
          type="button"
          id="save-btn"
          class="inline-flex items-center gap-2 px-6 py-2.5 rounded-lg bg-dark text-paper text-sm font-medium hover:scale-[1.02] active:scale-[0.98] transition-all cursor-pointer"
        >
          Create Crew
        </button>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 z-50 hidden">
      <div class="px-4 py-3 rounded-lg shadow-lg text-sm font-medium flex items-center gap-2">
        <span id="toast-text"></span>
      </div>
    </div>
  </div>
</PageLayout>

<script is:inline>
(function() {
  /* ---- Icons ---- */
  const DRAG_ICON = '<svg class="h-4 w-4 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="6" r="1"/><circle cx="15" cy="6" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="9" cy="18" r="1"/><circle cx="15" cy="18" r="1"/></svg>';
  const REMOVE_ICON = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
  const CHEVRON_DOWN = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';
  const CHEVRON_UP = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>';

  /* ---- State ---- */
  var agents = [];
  var tasks = []; // {id, agent_id, agent_name, task_description, expected_output, dependencies_json, expanded}
  var projects = [];
  var delegation = false;

  /* ---- DOM refs ---- */
  var nameInput = document.getElementById('crew-name');
  var descInput = document.getElementById('crew-description');
  var projectSelect = document.getElementById('crew-project');
  var agentSelect = document.getElementById('agent-selector');
  var addBtn = document.getElementById('add-agent-btn');
  var taskList = document.getElementById('task-list');
  var taskEmpty = document.getElementById('task-empty');
  var taskCount = document.getElementById('task-count');
  var saveBtn = document.getElementById('save-btn');
  var delegationToggle = document.getElementById('delegation-toggle');

  /* ---- Toast ---- */
  var toastTimer;
  function showToast(msg, type) {
    var el = document.getElementById('toast');
    var text = document.getElementById('toast-text');
    text.textContent = msg;
    var inner = el.firstElementChild;
    inner.className = 'px-4 py-3 rounded-lg shadow-lg text-sm font-medium flex items-center gap-2 ';
    if (type === 'error') inner.className += 'bg-red-600 text-white';
    else if (type === 'warning') inner.className += 'bg-amber-500 text-white';
    else inner.className += 'bg-zen-green text-dark';
    el.classList.remove('hidden');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(function() { el.classList.add('hidden'); }, 3000);
  }

  /* ---- Data loading ---- */
  async function loadProjects() {
    try {
      var resp = await fetch('/api/projects');
      if (!resp.ok) return;
      var body = await resp.json();
      projects = body.data || body;
      projectSelect.innerHTML = '<option value="">Select a project...</option>';
      projects.forEach(function(p) {
        var opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        projectSelect.appendChild(opt);
      });
    } catch(e) { /* graceful fallback */ }
  }

  async function loadAgents() {
    try {
      var resp = await fetch('/api/agents');
      if (!resp.ok) return;
      var body = await resp.json();
      agents = body.data || body;
      populateAgentSelect();
    } catch(e) { /* graceful fallback */ }
  }

  function populateAgentSelect() {
    agentSelect.innerHTML = '<option value="">Select an agent to add...</option>';
    agents.forEach(function(a) {
      var opt = document.createElement('option');
      opt.value = a.id;
      opt.textContent = a.name + (a.model_name ? ' (' + a.model_name + ')' : '');
      agentSelect.appendChild(opt);
    });
  }

  /* ---- Delegation toggle ---- */
  delegationToggle.addEventListener('click', function() {
    delegation = !delegation;
    var circle = delegationToggle.querySelector('span');
    if (delegation) {
      delegationToggle.classList.remove('bg-dark/20');
      delegationToggle.classList.add('bg-zen-green');
      circle.classList.remove('translate-x-0.5');
      circle.classList.add('translate-x-5');
      delegationToggle.setAttribute('aria-checked', 'true');
    } else {
      delegationToggle.classList.add('bg-dark/20');
      delegationToggle.classList.remove('bg-zen-green');
      circle.classList.add('translate-x-0.5');
      circle.classList.remove('translate-x-5');
      delegationToggle.setAttribute('aria-checked', 'false');
    }
  });

  /* ---- Process type ---- */
  function getProcessType() {
    var radios = document.querySelectorAll('input[name="process-type"]');
    for (var i = 0; i < radios.length; i++) {
      if (radios[i].checked) return radios[i].value;
    }
    return 'sequential';
  }

  /* Show/hide drag handles based on process type */
  function updateDragHandles() {
    var isSeq = getProcessType() === 'sequential';
    var handles = taskList.querySelectorAll('.drag-handle');
    handles.forEach(function(h) {
      h.style.display = isSeq ? '' : 'none';
    });
  }

  document.querySelectorAll('input[name="process-type"]').forEach(function(radio) {
    radio.addEventListener('change', updateDragHandles);
  });

  /* ---- Task rendering ---- */
  function renderTasks() {
    taskList.innerHTML = '';
    taskEmpty.style.display = tasks.length === 0 ? '' : 'none';
    taskCount.textContent = tasks.length + ' task' + (tasks.length !== 1 ? 's' : '');

    tasks.forEach(function(task, idx) {
      var card = document.createElement('div');
      card.className = 'task-card rounded-lg border border-dark/[0.08] bg-paper transition-all';
      card.dataset.taskIdx = idx;
      card.setAttribute('draggable', getProcessType() === 'sequential' ? 'true' : 'false');

      // Header row
      var header = document.createElement('div');
      header.className = 'flex items-center gap-2 px-4 py-3 cursor-pointer';
      header.addEventListener('click', function(e) {
        // Don't toggle if clicking remove button
        if (e.target.closest('.remove-task-btn')) return;
        task.expanded = !task.expanded;
        renderTasks();
      });

      // Drag handle
      var dragHandle = document.createElement('span');
      dragHandle.className = 'drag-handle cursor-grab active:cursor-grabbing';
      dragHandle.innerHTML = DRAG_ICON;
      dragHandle.style.display = getProcessType() === 'sequential' ? '' : 'none';
      header.appendChild(dragHandle);

      // Order badge
      var badge = document.createElement('span');
      badge.className = 'flex h-5 w-5 items-center justify-center rounded-full bg-coral/10 text-coral text-[10px] font-bold flex-shrink-0';
      badge.textContent = (idx + 1).toString();
      header.appendChild(badge);

      // Agent name
      var nameSpan = document.createElement('span');
      nameSpan.className = 'text-sm font-medium text-dark flex-1 truncate';
      nameSpan.textContent = task.agent_name;
      header.appendChild(nameSpan);

      // Task preview
      if (task.task_description && !task.expanded) {
        var preview = document.createElement('span');
        preview.className = 'text-xs text-muted truncate max-w-[200px]';
        preview.textContent = task.task_description.substring(0, 60) + (task.task_description.length > 60 ? '...' : '');
        header.appendChild(preview);
      }

      // Chevron
      var chevron = document.createElement('span');
      chevron.className = 'text-muted flex-shrink-0';
      chevron.innerHTML = task.expanded ? CHEVRON_UP : CHEVRON_DOWN;
      header.appendChild(chevron);

      // Remove button
      var removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove-task-btn flex h-6 w-6 items-center justify-center rounded text-muted hover:text-red-500 hover:bg-red-50 transition-colors flex-shrink-0 cursor-pointer';
      removeBtn.innerHTML = REMOVE_ICON;
      removeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        tasks.splice(idx, 1);
        renderTasks();
      });
      header.appendChild(removeBtn);

      card.appendChild(header);

      // Expanded content
      if (task.expanded) {
        var body = document.createElement('div');
        body.className = 'px-4 pb-4 border-t border-dark/[0.06] pt-4';

        // Task description
        var descLabel = document.createElement('label');
        descLabel.className = 'block text-xs font-medium text-dark mb-1';
        descLabel.textContent = 'Task Description';
        body.appendChild(descLabel);

        var descArea = document.createElement('textarea');
        descArea.className = 'w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all resize-y mb-3';
        descArea.placeholder = 'What should this agent accomplish?';
        descArea.rows = 2;
        descArea.value = task.task_description;
        descArea.addEventListener('input', function(e) { task.task_description = e.target.value; });
        body.appendChild(descArea);

        // Expected output
        var outLabel = document.createElement('label');
        outLabel.className = 'block text-xs font-medium text-dark mb-1';
        outLabel.textContent = 'Expected Output Format';
        body.appendChild(outLabel);

        var outArea = document.createElement('textarea');
        outArea.className = 'w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark placeholder:text-muted/60 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all resize-y mb-3';
        outArea.placeholder = 'Describe the expected format of this task\'s output...';
        outArea.rows = 2;
        outArea.value = task.expected_output;
        outArea.addEventListener('input', function(e) { task.expected_output = e.target.value; });
        body.appendChild(outArea);

        // Dependencies (only show for sequential)
        if (getProcessType() === 'sequential' && idx > 0) {
          var depLabel = document.createElement('label');
          depLabel.className = 'block text-xs font-medium text-dark mb-1';
          depLabel.textContent = 'Dependencies';
          body.appendChild(depLabel);

          var depDesc = document.createElement('p');
          depDesc.className = 'text-xs text-muted mb-2';
          depDesc.textContent = 'Select tasks that must complete before this one starts.';
          body.appendChild(depDesc);

          var depContainer = document.createElement('div');
          depContainer.className = 'flex flex-wrap gap-2 mb-2';

          var deps = [];
          try { deps = JSON.parse(task.dependencies_json); } catch(e) { deps = []; }

          tasks.forEach(function(otherTask, otherIdx) {
            if (otherIdx >= idx) return; // Can only depend on earlier tasks
            var isDependent = deps.indexOf(otherIdx) >= 0;
            var chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'px-2 py-1 rounded text-xs font-medium transition-colors cursor-pointer ' +
              (isDependent
                ? 'bg-coral/10 text-coral border border-coral/20'
                : 'bg-subtle text-muted border border-transparent hover:border-dark/[0.08]');
            chip.textContent = '#' + (otherIdx + 1) + ' ' + otherTask.agent_name;
            chip.addEventListener('click', function() {
              var pos = deps.indexOf(otherIdx);
              if (pos >= 0) deps.splice(pos, 1);
              else deps.push(otherIdx);
              task.dependencies_json = JSON.stringify(deps);
              renderTasks();
            });
            depContainer.appendChild(chip);
          });

          body.appendChild(depContainer);
        }

        card.appendChild(body);
      }

      taskList.appendChild(card);
    });

    // Re-attach drag listeners
    if (getProcessType() === 'sequential') {
      initDragAndDrop();
    }
  }

  /* ---- Drag and drop ---- */
  var dragSrcIdx = null;

  function initDragAndDrop() {
    var cards = taskList.querySelectorAll('.task-card');
    cards.forEach(function(card) {
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragover', handleDragOver);
      card.addEventListener('dragenter', handleDragEnter);
      card.addEventListener('dragleave', handleDragLeave);
      card.addEventListener('drop', handleDrop);
      card.addEventListener('dragend', handleDragEnd);
    });
  }

  function handleDragStart(e) {
    dragSrcIdx = parseInt(this.dataset.taskIdx);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', dragSrcIdx.toString());
    this.style.opacity = '0.5';
  }

  function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  }

  function handleDragEnter(e) {
    e.preventDefault();
    this.classList.add('border-coral', 'bg-coral/5');
  }

  function handleDragLeave(e) {
    this.classList.remove('border-coral', 'bg-coral/5');
  }

  function handleDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    this.classList.remove('border-coral', 'bg-coral/5');

    var targetIdx = parseInt(this.dataset.taskIdx);
    if (dragSrcIdx === null || dragSrcIdx === targetIdx) return;

    // Reorder tasks
    var moved = tasks.splice(dragSrcIdx, 1)[0];
    tasks.splice(targetIdx, 0, moved);

    // Reset dependencies since order changed
    tasks.forEach(function(t) { t.dependencies_json = '[]'; });

    renderTasks();
  }

  function handleDragEnd(e) {
    this.style.opacity = '1';
    var cards = taskList.querySelectorAll('.task-card');
    cards.forEach(function(c) {
      c.classList.remove('border-coral', 'bg-coral/5');
    });
  }

  /* ---- Add agent ---- */
  addBtn.addEventListener('click', function() {
    var agentId = agentSelect.value;
    if (!agentId) return;

    var agent = agents.find(function(a) { return a.id === agentId; });
    if (!agent) return;

    tasks.push({
      id: crypto.randomUUID(),
      agent_id: agentId,
      agent_name: agent.name,
      task_description: '',
      expected_output: '',
      dependencies_json: '[]',
      expanded: true,
    });

    agentSelect.value = '';
    renderTasks();
  });

  /* ---- Save ---- */
  saveBtn.addEventListener('click', async function() {
    var name = nameInput.value.trim();
    var projectId = projectSelect.value;
    var processType = getProcessType();

    if (!name) { showToast('Crew name is required', 'error'); nameInput.focus(); return; }
    if (!projectId) { showToast('Please select a project', 'error'); projectSelect.focus(); return; }
    if (tasks.length === 0) { showToast('Add at least one task', 'error'); return; }

    // Check all tasks have descriptions
    for (var i = 0; i < tasks.length; i++) {
      if (!tasks[i].task_description.trim()) {
        showToast('Task #' + (i + 1) + ' needs a description', 'warning');
        tasks[i].expanded = true;
        renderTasks();
        return;
      }
    }

    saveBtn.disabled = true;
    saveBtn.textContent = 'Creating...';

    try {
      var configJson = JSON.stringify({ delegation_enabled: delegation });

      // 1. Create the crew
      var crewResp = await fetch('/api/crews', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: name,
          description: descInput.value.trim(),
          project_id: projectId,
          process_type: processType,
          config_json: configJson,
        }),
      });

      if (!crewResp.ok) {
        var err = await crewResp.json().catch(function() { return { detail: 'Failed to create crew' }; });
        throw new Error(err.detail || 'Failed to create crew');
      }

      var crew = await crewResp.json();

      // 2. Add tasks
      for (var i = 0; i < tasks.length; i++) {
        var t = tasks[i];
        var taskResp = await fetch('/api/crews/' + crew.id + '/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            agent_id: t.agent_id,
            task_description: t.task_description.trim(),
            expected_output: t.expected_output.trim(),
            task_order: i,
            dependencies_json: t.dependencies_json,
          }),
        });

        if (!taskResp.ok) {
          showToast('Crew created but failed to add task #' + (i + 1), 'warning');
        }
      }

      showToast('Crew created successfully!', 'success');
      setTimeout(function() { window.location.href = '/crews/' + crew.id; }, 1000);

    } catch(e) {
      showToast(e.message || 'Failed to create crew', 'error');
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = 'Create Crew';
    }
  });

  /* ---- Init ---- */
  loadProjects();
  loadAgents();
  renderTasks();
})();
</script>
