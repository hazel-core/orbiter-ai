---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";
import Modal from "../../components/Modal.astro";
import Input from "../../components/Input.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Projects", href: "/projects" },
  { label: "Loading..." },
];

/* Icons */
const editIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
const trashIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
---

<PageLayout
  title="Project"
  description="Project details"
  activeSection="projects"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading project...</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <p class="text-lg font-semibold text-dark mb-2">Project not found</p>
      <p class="text-sm text-muted mb-6">This project may have been deleted.</p>
      <Button href="/projects" variant="bordered">
        <span set:html={backIcon} />
        Back to Projects
      </Button>
    </div>

    <!-- Project content (hidden until loaded) -->
    <div id="project-content" class="hidden">
      <!-- Back link + actions row -->
      <div class="flex items-center justify-between mb-6">
        <a href="/projects" class="flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          All Projects
        </a>
        <div class="flex items-center gap-2">
          <Button variant="default" id="rename-btn" class="text-sm">
            <span set:html={editIcon} />
            Rename
          </Button>
          <Button variant="default" id="delete-btn" class="text-sm text-coral hover:bg-coral/5">
            <span set:html={trashIcon} />
            Delete
          </Button>
        </div>
      </div>

      <!-- Project header -->
      <div class="mb-8">
        <h1 id="project-name" class="text-2xl font-semibold text-dark mb-2"></h1>
        <p id="project-description" class="text-sm text-muted"></p>
      </div>

      <!-- Project metadata -->
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5 mb-8">
        <h2 class="text-sm font-semibold text-dark mb-4">Details</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
          <div>
            <span class="text-muted">Created</span>
            <p id="project-created" class="text-dark font-medium mt-0.5"></p>
          </div>
          <div>
            <span class="text-muted">Last Modified</span>
            <p id="project-updated" class="text-dark font-medium mt-0.5"></p>
          </div>
          <div>
            <span class="text-muted">Default Model</span>
            <p id="project-model" class="text-dark font-medium mt-0.5"></p>
          </div>
          <div>
            <span class="text-muted">Default Provider</span>
            <p id="project-provider" class="text-dark font-medium mt-0.5"></p>
          </div>
        </div>
      </div>

      <!-- Placeholder sections -->
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5">
        <h2 class="text-sm font-semibold text-dark mb-2">Agents</h2>
        <p class="text-sm text-muted">No agents configured yet. Agents will appear here once set up.</p>
      </div>
    </div>
  </div>

  <!-- Rename Modal -->
  <Modal id="rename-modal" title="Rename Project">
    <form id="rename-form" class="flex flex-col gap-4">
      <Input
        label="Project Name"
        name="name"
        id="rename-name-input"
        required
      />
      <div class="flex flex-col gap-1.5">
        <label for="rename-description" class="text-sm font-medium text-dark">Description</label>
        <textarea
          id="rename-description"
          name="description"
          rows="3"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-none"
        ></textarea>
      </div>
      <div id="rename-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="rename-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="rename-submit-btn">
          Save Changes
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Delete Confirmation Modal -->
  <Modal id="delete-modal" title="Delete Project">
    <div class="flex flex-col gap-4">
      <p class="text-sm text-muted">
        Are you sure you want to delete <strong id="delete-project-name" class="text-dark"></strong>?
        This action cannot be undone.
      </p>
      <div id="delete-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="delete-modal">
          Cancel
        </Button>
        <Button variant="primary" id="delete-confirm-btn" class="bg-coral hover:bg-coral/90 text-paper">
          Delete Project
        </Button>
      </div>
    </div>
  </Modal>
</PageLayout>

<script is:inline define:vars={{ projectId: id }}>
  (function () {
    var loadingState = document.getElementById("loading-state");
    var errorState = document.getElementById("error-state");
    var content = document.getElementById("project-content");
    var nameEl = document.getElementById("project-name");
    var descEl = document.getElementById("project-description");
    var createdEl = document.getElementById("project-created");
    var updatedEl = document.getElementById("project-updated");
    var modelEl = document.getElementById("project-model");
    var providerEl = document.getElementById("project-provider");

    var renameBtn = document.getElementById("rename-btn");
    var deleteBtn = document.getElementById("delete-btn");
    var renameModal = document.getElementById("rename-modal");
    var deleteModal = document.getElementById("delete-modal");
    var renameForm = document.getElementById("rename-form");
    var renameNameInput = document.getElementById("rename-name-input");
    var renameDescription = document.getElementById("rename-description");
    var renameError = document.getElementById("rename-error");
    var renameSubmitBtn = document.getElementById("rename-submit-btn");
    var deleteProjectName = document.getElementById("delete-project-name");
    var deleteError = document.getElementById("delete-error");
    var deleteConfirmBtn = document.getElementById("delete-confirm-btn");

    var currentProject = null;

    function formatDate(dateStr) {
      try {
        var d = new Date(dateStr + "Z");
        return d.toLocaleDateString(undefined, {
          month: "long",
          day: "numeric",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      } catch (_e) {
        return dateStr;
      }
    }

    function showProject(project) {
      currentProject = project;
      loadingState.classList.add("hidden");
      content.classList.remove("hidden");

      nameEl.textContent = project.name;
      descEl.textContent = project.description || "No description";
      if (!project.description) descEl.classList.add("italic", "text-muted/50");

      createdEl.textContent = formatDate(project.created_at);
      updatedEl.textContent = formatDate(project.updated_at);
      modelEl.textContent = project.default_model || "Not set";
      providerEl.textContent = project.default_provider || "Not set";

      /* Update breadcrumb with project name */
      var allSpans = document.querySelectorAll("nav span");
      allSpans.forEach(function (span) {
        if (span.textContent.trim() === "Loading...") {
          span.textContent = project.name;
        }
      });
    }

    function showError() {
      loadingState.classList.add("hidden");
      errorState.classList.remove("hidden");
    }

    function fetchProject() {
      fetch("/api/projects/" + projectId)
        .then(function (res) {
          if (!res.ok) throw new Error("Not found");
          return res.json();
        })
        .then(showProject)
        .catch(showError);
    }

    /* Rename */
    if (renameBtn) {
      renameBtn.addEventListener("click", function () {
        if (!currentProject) return;
        renameNameInput.value = currentProject.name;
        renameDescription.value = currentProject.description || "";
        renameError.classList.add("hidden");
        renameModal.showModal();
      });
    }

    if (renameForm) {
      renameForm.addEventListener("submit", function (e) {
        e.preventDefault();
        renameError.classList.add("hidden");

        var name = renameNameInput.value.trim();
        var description = renameDescription.value.trim();

        if (!name) {
          renameError.textContent = "Project name is required";
          renameError.classList.remove("hidden");
          return;
        }

        renameSubmitBtn.disabled = true;
        renameSubmitBtn.textContent = "Saving...";

        fetch("/api/projects/" + projectId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: name, description: description }),
        })
          .then(function (res) {
            if (!res.ok)
              return res.json().then(function (d) {
                throw new Error(d.detail || "Failed to rename");
              });
            return res.json();
          })
          .then(function (project) {
            renameModal.close();
            showProject(project);
          })
          .catch(function (err) {
            renameError.textContent = err.message;
            renameError.classList.remove("hidden");
          })
          .finally(function () {
            renameSubmitBtn.disabled = false;
            renameSubmitBtn.textContent = "Save Changes";
          });
      });
    }

    /* Delete */
    if (deleteBtn) {
      deleteBtn.addEventListener("click", function () {
        if (!currentProject) return;
        deleteProjectName.textContent = currentProject.name;
        deleteError.classList.add("hidden");
        deleteModal.showModal();
      });
    }

    if (deleteConfirmBtn) {
      deleteConfirmBtn.addEventListener("click", function () {
        deleteError.classList.add("hidden");
        deleteConfirmBtn.disabled = true;
        deleteConfirmBtn.textContent = "Deleting...";

        fetch("/api/projects/" + projectId, { method: "DELETE" })
          .then(function (res) {
            if (!res.ok && res.status !== 204)
              throw new Error("Failed to delete project");
            window.location.href = "/projects";
          })
          .catch(function (err) {
            deleteError.textContent = err.message;
            deleteError.classList.remove("hidden");
            deleteConfirmBtn.disabled = false;
            deleteConfirmBtn.textContent = "Delete Project";
          });
      });
    }

    // Initial load
    fetchProject();
  })();
</script>
