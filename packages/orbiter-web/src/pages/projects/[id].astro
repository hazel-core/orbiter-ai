---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";
import Modal from "../../components/Modal.astro";
import Input from "../../components/Input.astro";

const { id } = Astro.params;

const breadcrumbs = [
  { label: "Projects", href: "/projects" },
  { label: "Loading..." },
];

/* Icons */
const editIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
const trashIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';
const backIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>';
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const aiIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l2.09 6.26L20 10l-5.91 1.74L12 18l-2.09-6.26L4 10l5.91-1.74L12 2z"/><path d="M5 19l1.5-3L10 15" opacity="0.5"/><path d="M19 19l-1.5-3L14 15" opacity="0.5"/></svg>';
---

<PageLayout
  title="Project"
  description="Project details"
  activeSection="projects"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading project...</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <p class="text-lg font-semibold text-dark mb-2">Project not found</p>
      <p class="text-sm text-muted mb-6">This project may have been deleted.</p>
      <Button href="/projects" variant="bordered">
        <span set:html={backIcon} />
        Back to Projects
      </Button>
    </div>

    <!-- Project content (hidden until loaded) -->
    <div id="project-content" class="hidden">
      <!-- Back link + actions row -->
      <div class="flex items-center justify-between mb-6">
        <a href="/projects" class="flex items-center gap-2 text-sm text-muted hover:text-dark transition-colors">
          <span set:html={backIcon} />
          All Projects
        </a>
        <div class="flex items-center gap-2">
          <Button variant="primary" id="new-app-btn" class="text-sm">
            <span set:html={plusIcon} />
            New Application
          </Button>
          <Button variant="bordered" id="ai-agent-btn" class="text-sm">
            <span set:html={aiIcon} />
            AI Builder
          </Button>
          <Button variant="default" id="rename-btn" class="text-sm">
            <span set:html={editIcon} />
            Rename
          </Button>
          <Button variant="default" id="delete-btn" class="text-sm text-coral hover:bg-coral/5">
            <span set:html={trashIcon} />
            Delete
          </Button>
        </div>
      </div>

      <!-- Project header -->
      <div class="mb-8">
        <h1 id="project-name" class="text-2xl font-semibold text-dark mb-2"></h1>
        <p id="project-description" class="text-sm text-muted"></p>
      </div>

      <!-- Project metadata -->
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5 mb-8">
        <h2 class="text-sm font-semibold text-dark mb-4">Details</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
          <div>
            <span class="text-muted">Created</span>
            <p id="project-created" class="text-dark font-medium mt-0.5"></p>
          </div>
          <div>
            <span class="text-muted">Last Modified</span>
            <p id="project-updated" class="text-dark font-medium mt-0.5"></p>
          </div>
          <div>
            <span class="text-muted">Default Model</span>
            <div class="flex items-center gap-2 mt-0.5">
              <select
                id="project-model-select"
                class="bg-paper border border-dark/[0.08] rounded-lg px-2.5 py-1.5 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 appearance-none pr-7 cursor-pointer flex-1 max-w-xs"
              >
                <option value="">Not set</option>
              </select>
              <button id="save-model-btn" class="text-xs px-2.5 py-1.5 rounded-md bg-dark text-paper hover:bg-dark/90 transition-colors cursor-pointer hidden">Save</button>
              <span id="model-saved-msg" class="text-xs text-zen-green hidden">Saved</span>
            </div>
          </div>
          <div>
            <span class="text-muted">Default Provider</span>
            <p id="project-provider" class="text-dark font-medium mt-0.5"></p>
          </div>
        </div>
      </div>

      <!-- Placeholder sections -->
      <div class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-5">
        <h2 class="text-sm font-semibold text-dark mb-2">Agents</h2>
        <p class="text-sm text-muted">No agents configured yet. Agents will appear here once set up.</p>
      </div>
    </div>
  </div>

  <!-- Rename Modal -->
  <Modal id="rename-modal" title="Rename Project">
    <form id="rename-form" class="flex flex-col gap-4">
      <Input
        label="Project Name"
        name="name"
        id="rename-name-input"
        required
      />
      <div class="flex flex-col gap-1.5">
        <label for="rename-description" class="text-sm font-medium text-dark">Description</label>
        <textarea
          id="rename-description"
          name="description"
          rows="3"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-none"
        ></textarea>
      </div>
      <div id="rename-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="rename-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="rename-submit-btn">
          Save Changes
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Delete Confirmation Modal -->
  <Modal id="delete-modal" title="Delete Project">
    <div class="flex flex-col gap-4">
      <p class="text-sm text-muted">
        Are you sure you want to delete <strong id="delete-project-name" class="text-dark"></strong>?
        This action cannot be undone.
      </p>
      <div id="delete-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="delete-modal">
          Cancel
        </Button>
        <Button variant="primary" id="delete-confirm-btn" class="bg-coral hover:bg-coral/90 text-paper">
          Delete Project
        </Button>
      </div>
    </div>
  </Modal>

  <!-- AI Agent Builder Modal -->
  <Modal id="ai-builder-modal" title="AI Agent Builder" class="max-w-2xl">
    <div class="flex flex-col gap-5">
      <!-- Step 1: Description input -->
      <div id="ai-step-describe">
        <p class="text-sm text-muted mb-3">Describe the agent you need in plain language. The AI will generate a full configuration you can review and edit.</p>
        <textarea
          id="ai-description-input"
          rows="4"
          placeholder="Describe the agent you need..."
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-none text-sm"
        ></textarea>
        <div id="ai-describe-error" class="text-sm text-coral hidden mt-1"></div>
        <div class="flex justify-end gap-3 mt-4">
          <Button variant="default" type="button" data-modal-close="ai-builder-modal">
            Cancel
          </Button>
          <button
            type="button"
            id="ai-generate-btn"
            class="inline-flex items-center gap-2 rounded-lg bg-dark text-paper px-4 py-2 text-sm font-medium hover:bg-dark/90 transition-colors cursor-pointer"
          >
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l2.09 6.26L20 10l-5.91 1.74L12 18l-2.09-6.26L4 10l5.91-1.74L12 2z"/></svg>
            Generate
          </button>
        </div>
      </div>

      <!-- Loading state -->
      <div id="ai-step-loading" class="hidden flex flex-col items-center justify-center py-12">
        <div class="flex items-center gap-3">
          <svg class="h-5 w-5 text-coral animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-dasharray="31.4" stroke-dashoffset="10" stroke-linecap="round"/></svg>
          <p class="text-sm text-muted">Generating agent configuration...</p>
        </div>
        <p class="text-xs text-muted/60 mt-2">This may take a few seconds</p>
      </div>

      <!-- Step 2: Review & edit generated config -->
      <div id="ai-step-review" class="hidden">
        <p class="text-sm text-muted mb-4">Review the generated configuration below. Edit any field before creating the agent.</p>

        <div class="flex flex-col gap-4">
          <!-- Name -->
          <div class="flex flex-col gap-1.5">
            <label for="ai-review-name" class="text-xs font-medium text-muted">Name</label>
            <input
              type="text"
              id="ai-review-name"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
            />
          </div>

          <!-- Role (Persona) -->
          <div class="flex flex-col gap-1.5">
            <label for="ai-review-role" class="text-xs font-medium text-muted">Role</label>
            <input
              type="text"
              id="ai-review-role"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="e.g., Senior Research Analyst"
            />
          </div>

          <!-- Instructions (Prompt) -->
          <div class="flex flex-col gap-1.5">
            <label for="ai-review-instructions" class="text-xs font-medium text-muted">Prompt / Instructions</label>
            <textarea
              id="ai-review-instructions"
              rows="5"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-y"
            ></textarea>
          </div>

          <!-- Tools -->
          <div class="flex flex-col gap-1.5">
            <label class="text-xs font-medium text-muted">Tools</label>
            <div id="ai-review-tools" class="flex flex-wrap gap-1.5">
              <span class="text-xs text-muted italic">None suggested</span>
            </div>
          </div>

          <!-- Model -->
          <div class="flex flex-col gap-1.5">
            <label for="ai-review-model" class="text-xs font-medium text-muted">Suggested Model</label>
            <input
              type="text"
              id="ai-review-model"
              class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20"
              placeholder="e.g., gpt-4o"
            />
          </div>
        </div>

        <div id="ai-review-error" class="text-sm text-coral hidden mt-3"></div>
        <div class="flex items-center justify-between mt-5">
          <button
            type="button"
            id="ai-back-btn"
            class="text-sm text-muted hover:text-dark transition-colors cursor-pointer"
          >
            &larr; Back to description
          </button>
          <div class="flex items-center gap-3">
            <Button variant="default" type="button" data-modal-close="ai-builder-modal">
              Cancel
            </Button>
            <button
              type="button"
              id="ai-confirm-btn"
              class="inline-flex items-center gap-2 rounded-lg bg-dark text-paper px-4 py-2 text-sm font-medium hover:bg-dark/90 transition-colors cursor-pointer"
            >
              Create Agent
            </button>
          </div>
        </div>
      </div>
    </div>
  </Modal>

  <!-- New Application Dialog -->
  <Modal id="new-app-modal" title="New Application" class="max-w-2xl">
    <div class="flex flex-col gap-5">
      <p class="text-sm text-muted">Choose an application type to get started.</p>

      <!-- Application type cards grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="app-type-grid">
        <!-- Chatbot -->
        <button
          type="button"
          data-app-type="chatbot"
          class="app-type-card group text-left rounded-xl border-2 border-dark/[0.08] p-4 transition-all duration-200 hover:border-coral/40 hover:bg-coral/[0.03] cursor-pointer"
        >
          <div class="flex items-start gap-3">
            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-coral/10 text-coral">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
            </div>
            <div class="min-w-0">
              <h3 class="text-sm font-semibold text-dark">Chatbot</h3>
              <p class="text-xs text-muted mt-0.5 leading-relaxed">Single-agent conversational app with memory</p>
              <p class="text-xs text-muted/60 mt-1.5 italic">Customer support, Q&A bot, personal assistant</p>
            </div>
          </div>
        </button>

        <!-- Chatflow -->
        <button
          type="button"
          data-app-type="chatflow"
          class="app-type-card group text-left rounded-xl border-2 border-dark/[0.08] p-4 transition-all duration-200 hover:border-zen-blue/40 hover:bg-zen-blue/[0.03] cursor-pointer"
        >
          <div class="flex items-start gap-3">
            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-zen-blue/10 text-zen-blue">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
              </svg>
            </div>
            <div class="min-w-0">
              <h3 class="text-sm font-semibold text-dark">Chatflow</h3>
              <p class="text-xs text-muted mt-0.5 leading-relaxed">Multi-turn conversational workflow with branching</p>
              <p class="text-xs text-muted/60 mt-1.5 italic">Lead qualification, onboarding flows, guided troubleshooting</p>
            </div>
          </div>
        </button>

        <!-- Workflow -->
        <button
          type="button"
          data-app-type="workflow"
          class="app-type-card group text-left rounded-xl border-2 border-dark/[0.08] p-4 transition-all duration-200 hover:border-zen-green/40 hover:bg-zen-green/[0.03] cursor-pointer"
        >
          <div class="flex items-start gap-3">
            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-zen-green/10 text-zen-green">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
              </svg>
            </div>
            <div class="min-w-0">
              <h3 class="text-sm font-semibold text-dark">Workflow</h3>
              <p class="text-xs text-muted mt-0.5 leading-relaxed">DAG-based automation pipeline (no chat interface)</p>
              <p class="text-xs text-muted/60 mt-1.5 italic">Data processing, ETL pipelines, batch operations</p>
            </div>
          </div>
        </button>

        <!-- Agent -->
        <button
          type="button"
          data-app-type="agent"
          class="app-type-card group text-left rounded-xl border-2 border-dark/[0.08] p-4 transition-all duration-200 hover:border-purple-500/40 hover:bg-purple-500/[0.03] cursor-pointer"
        >
          <div class="flex items-start gap-3">
            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-purple-500/10 text-purple-500">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2a4 4 0 0 1 4 4c0 1.95-1.4 3.58-3.25 3.93L12 22"/>
                <path d="M12 2a4 4 0 0 0-4 4c0 1.95 1.4 3.58 3.25 3.93"/>
                <path d="M5 15a2.5 2.5 0 1 0 0-5"/>
                <path d="M19 15a2.5 2.5 0 1 1 0-5"/>
              </svg>
            </div>
            <div class="min-w-0">
              <h3 class="text-sm font-semibold text-dark">Agent</h3>
              <p class="text-xs text-muted mt-0.5 leading-relaxed">Autonomous agent with tools and reasoning</p>
              <p class="text-xs text-muted/60 mt-1.5 italic">Research assistant, code review, task automation</p>
            </div>
          </div>
        </button>

        <!-- Text Generator (full width) -->
        <button
          type="button"
          data-app-type="text_generator"
          class="app-type-card group text-left rounded-xl border-2 border-dark/[0.08] p-4 transition-all duration-200 hover:border-amber-500/40 hover:bg-amber-500/[0.03] cursor-pointer sm:col-span-2"
        >
          <div class="flex items-start gap-3">
            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-amber-500/10 text-amber-500">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
            </div>
            <div class="min-w-0">
              <h3 class="text-sm font-semibold text-dark">Text Generator</h3>
              <p class="text-xs text-muted mt-0.5 leading-relaxed">Single-shot text generation with templates</p>
              <p class="text-xs text-muted/60 mt-1.5 italic">Email drafting, content generation, report summaries</p>
            </div>
          </div>
        </button>
      </div>

      <!-- Application name input (shown after type selection) -->
      <div id="app-name-section" class="hidden">
        <div class="flex items-center gap-2 mb-3">
          <span id="selected-type-badge" class="text-xs font-medium px-2 py-0.5 rounded-full"></span>
          <button type="button" id="change-type-btn" class="text-xs text-muted hover:text-dark transition-colors cursor-pointer">Change</button>
        </div>
        <Input
          label="Application Name"
          name="app_name"
          id="new-app-name"
          placeholder="My Application"
          required
        />
      </div>

      <div id="new-app-error" class="text-sm text-coral hidden"></div>

      <div class="flex justify-end gap-3 mt-1">
        <Button variant="default" type="button" data-modal-close="new-app-modal">
          Cancel
        </Button>
        <Button variant="primary" id="create-app-btn" class="hidden">
          Create Application
        </Button>
      </div>
    </div>
  </Modal>
</PageLayout>

<script is:inline define:vars={{ projectId: id }}>
  (function () {
    var loadingState = document.getElementById("loading-state");
    var errorState = document.getElementById("error-state");
    var content = document.getElementById("project-content");
    var nameEl = document.getElementById("project-name");
    var descEl = document.getElementById("project-description");
    var createdEl = document.getElementById("project-created");
    var updatedEl = document.getElementById("project-updated");
    var modelSelect = document.getElementById("project-model-select");
    var saveModelBtn = document.getElementById("save-model-btn");
    var modelSavedMsg = document.getElementById("model-saved-msg");
    var providerEl = document.getElementById("project-provider");

    var renameBtn = document.getElementById("rename-btn");
    var deleteBtn = document.getElementById("delete-btn");
    var renameModal = document.getElementById("rename-modal");
    var deleteModal = document.getElementById("delete-modal");
    var renameForm = document.getElementById("rename-form");
    var renameNameInput = document.getElementById("rename-name-input");
    var renameDescription = document.getElementById("rename-description");
    var renameError = document.getElementById("rename-error");
    var renameSubmitBtn = document.getElementById("rename-submit-btn");
    var deleteProjectName = document.getElementById("delete-project-name");
    var deleteError = document.getElementById("delete-error");
    var deleteConfirmBtn = document.getElementById("delete-confirm-btn");

    var currentProject = null;

    function formatDate(dateStr) {
      try {
        var d = new Date(dateStr + "Z");
        return d.toLocaleDateString(undefined, {
          month: "long",
          day: "numeric",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      } catch (_e) {
        return dateStr;
      }
    }

    function showProject(project) {
      currentProject = project;
      loadingState.classList.add("hidden");
      content.classList.remove("hidden");

      nameEl.textContent = project.name;
      descEl.textContent = project.description || "No description";
      if (!project.description) descEl.classList.add("italic", "text-muted/50");

      createdEl.textContent = formatDate(project.created_at);
      updatedEl.textContent = formatDate(project.updated_at);
      providerEl.textContent = project.default_provider || "Not set";

      /* Populate model dropdown */
      fetchModelsForProject(project.default_model);

      /* Update breadcrumb with project name */
      var allSpans = document.querySelectorAll("nav span");
      allSpans.forEach(function (span) {
        if (span.textContent.trim() === "Loading...") {
          span.textContent = project.name;
        }
      });
    }

    function showError() {
      loadingState.classList.add("hidden");
      errorState.classList.remove("hidden");
    }

    /* Default model dropdown */
    var originalModelValue = "";

    function fetchModelsForProject(currentModel) {
      fetch("/api/v1/models")
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (models) {
          if (!modelSelect) return;
          modelSelect.innerHTML = '<option value="">Not set</option>';
          models.forEach(function (m) {
            var opt = document.createElement("option");
            opt.value = m.model_name;
            opt.textContent = m.model_name + " (" + (m.provider_name || m.provider_type) + ")";
            modelSelect.appendChild(opt);
          });
          modelSelect.value = currentModel || "";
          originalModelValue = modelSelect.value;
        })
        .catch(function () {});
    }

    if (modelSelect) {
      modelSelect.addEventListener("change", function () {
        if (modelSelect.value !== originalModelValue) {
          saveModelBtn.classList.remove("hidden");
          modelSavedMsg.classList.add("hidden");
        } else {
          saveModelBtn.classList.add("hidden");
        }
      });
    }

    if (saveModelBtn) {
      saveModelBtn.addEventListener("click", function () {
        var newModel = modelSelect.value || null;
        saveModelBtn.disabled = true;
        saveModelBtn.textContent = "...";

        fetch("/api/v1/projects/" + projectId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ default_model: newModel })
        })
          .then(function (res) {
            if (!res.ok) throw new Error("Failed");
            return res.json();
          })
          .then(function () {
            originalModelValue = modelSelect.value;
            saveModelBtn.classList.add("hidden");
            modelSavedMsg.classList.remove("hidden");
            setTimeout(function () { modelSavedMsg.classList.add("hidden"); }, 2000);
          })
          .catch(function () {
            modelSavedMsg.classList.add("hidden");
          })
          .finally(function () {
            saveModelBtn.disabled = false;
            saveModelBtn.textContent = "Save";
          });
      });
    }

    function fetchProject() {
      fetch("/api/v1/projects/" + projectId)
        .then(function (res) {
          if (!res.ok) throw new Error("Not found");
          return res.json();
        })
        .then(showProject)
        .catch(showError);
    }

    /* Rename */
    if (renameBtn) {
      renameBtn.addEventListener("click", function () {
        if (!currentProject) return;
        renameNameInput.value = currentProject.name;
        renameDescription.value = currentProject.description || "";
        renameError.classList.add("hidden");
        renameModal.showModal();
      });
    }

    if (renameForm) {
      renameForm.addEventListener("submit", function (e) {
        e.preventDefault();
        renameError.classList.add("hidden");

        var name = renameNameInput.value.trim();
        var description = renameDescription.value.trim();

        if (!name) {
          renameError.textContent = "Project name is required";
          renameError.classList.remove("hidden");
          return;
        }

        renameSubmitBtn.disabled = true;
        renameSubmitBtn.textContent = "Saving...";

        fetch("/api/v1/projects/" + projectId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: name, description: description }),
        })
          .then(function (res) {
            if (!res.ok)
              return res.json().then(function (d) {
                throw new Error(d.detail || "Failed to rename");
              });
            return res.json();
          })
          .then(function (project) {
            renameModal.close();
            showProject(project);
          })
          .catch(function (err) {
            renameError.textContent = err.message;
            renameError.classList.remove("hidden");
          })
          .finally(function () {
            renameSubmitBtn.disabled = false;
            renameSubmitBtn.textContent = "Save Changes";
          });
      });
    }

    /* Delete */
    if (deleteBtn) {
      deleteBtn.addEventListener("click", function () {
        if (!currentProject) return;
        deleteProjectName.textContent = currentProject.name;
        deleteError.classList.add("hidden");
        deleteModal.showModal();
      });
    }

    if (deleteConfirmBtn) {
      deleteConfirmBtn.addEventListener("click", function () {
        deleteError.classList.add("hidden");
        deleteConfirmBtn.disabled = true;
        deleteConfirmBtn.textContent = "Deleting...";

        fetch("/api/v1/projects/" + projectId, { method: "DELETE" })
          .then(function (res) {
            if (!res.ok && res.status !== 204)
              throw new Error("Failed to delete project");
            window.location.href = "/projects";
          })
          .catch(function (err) {
            deleteError.textContent = err.message;
            deleteError.classList.remove("hidden");
            deleteConfirmBtn.disabled = false;
            deleteConfirmBtn.textContent = "Delete Project";
          });
      });
    }

    /* --- New Application Dialog --- */
    var newAppBtn = document.getElementById("new-app-btn");
    var newAppModal = document.getElementById("new-app-modal");
    var appTypeGrid = document.getElementById("app-type-grid");
    var appNameSection = document.getElementById("app-name-section");
    var newAppNameInput = document.getElementById("new-app-name");
    var selectedTypeBadge = document.getElementById("selected-type-badge");
    var changeTypeBtn = document.getElementById("change-type-btn");
    var createAppBtn = document.getElementById("create-app-btn");
    var newAppError = document.getElementById("new-app-error");

    var selectedAppType = null;

    var typeColors = {
      chatbot: { bg: "bg-coral/10", text: "text-coral", label: "Chatbot" },
      chatflow: { bg: "bg-zen-blue/10", text: "text-zen-blue", label: "Chatflow" },
      workflow: { bg: "bg-zen-green/10", text: "text-zen-green", label: "Workflow" },
      agent: { bg: "bg-purple-500/10", text: "text-purple-500", label: "Agent" },
      text_generator: { bg: "bg-amber-500/10", text: "text-amber-500", label: "Text Generator" },
    };

    function resetNewAppDialog() {
      selectedAppType = null;
      if (appTypeGrid) appTypeGrid.classList.remove("hidden");
      if (appNameSection) appNameSection.classList.add("hidden");
      if (createAppBtn) createAppBtn.classList.add("hidden");
      if (newAppError) newAppError.classList.add("hidden");
      if (newAppNameInput) newAppNameInput.value = "";

      // Remove selection ring from all cards
      document.querySelectorAll(".app-type-card").forEach(function (card) {
        card.classList.remove("border-coral", "border-zen-blue", "border-zen-green", "border-purple-500", "border-amber-500", "bg-coral/[0.03]", "bg-zen-blue/[0.03]", "bg-zen-green/[0.03]", "bg-purple-500/[0.03]", "bg-amber-500/[0.03]");
      });
    }

    if (newAppBtn) {
      newAppBtn.addEventListener("click", function () {
        if (!currentProject) return;
        resetNewAppDialog();
        newAppModal.showModal();
      });
    }

    // Type card selection
    document.querySelectorAll(".app-type-card").forEach(function (card) {
      card.addEventListener("click", function () {
        var type = card.getAttribute("data-app-type");
        selectedAppType = type;

        // Show name input, hide grid
        appTypeGrid.classList.add("hidden");
        appNameSection.classList.remove("hidden");
        createAppBtn.classList.remove("hidden");

        // Update badge
        var tc = typeColors[type] || { bg: "bg-dark/10", text: "text-dark", label: type };
        selectedTypeBadge.className = "text-xs font-medium px-2 py-0.5 rounded-full " + tc.bg + " " + tc.text;
        selectedTypeBadge.textContent = tc.label;

        // Focus name input
        setTimeout(function () { newAppNameInput.focus(); }, 100);
      });
    });

    // Change type button
    if (changeTypeBtn) {
      changeTypeBtn.addEventListener("click", function () {
        resetNewAppDialog();
        appTypeGrid.classList.remove("hidden");
      });
    }

    // Create application
    if (createAppBtn) {
      createAppBtn.addEventListener("click", function () {
        newAppError.classList.add("hidden");

        var name = newAppNameInput.value.trim();
        if (!name) {
          newAppError.textContent = "Application name is required";
          newAppError.classList.remove("hidden");
          return;
        }

        if (!selectedAppType) {
          newAppError.textContent = "Please select an application type";
          newAppError.classList.remove("hidden");
          return;
        }

        createAppBtn.disabled = true;
        createAppBtn.textContent = "Creating...";

        /* Workflow type goes to the workflows table + canvas editor */
        var isWorkflow = selectedAppType === "workflow";
        var endpoint = isWorkflow ? "/api/v1/workflows" : "/api/v1/applications";
        var payload = isWorkflow
          ? { name: name, project_id: projectId }
          : { name: name, type: selectedAppType, project_id: projectId };

        fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to create"); });
            return res.json();
          })
          .then(function (item) {
            newAppModal.close();
            window.location.href = isWorkflow
              ? "/workflows/" + item.id
              : "/applications/" + item.id;
          })
          .catch(function (err) {
            newAppError.textContent = err.message;
            newAppError.classList.remove("hidden");
          })
          .finally(function () {
            createAppBtn.disabled = false;
            createAppBtn.textContent = "Create Application";
          });
      });
    }

    // Handle Enter key in name input
    if (newAppNameInput) {
      newAppNameInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          createAppBtn.click();
        }
      });
    }

    // Reset dialog when closed
    if (newAppModal) {
      newAppModal.addEventListener("close", resetNewAppDialog);
    }

    /* --- AI Agent Builder --- */
    var aiBuilderBtn = document.getElementById("ai-agent-btn");
    var aiBuilderModal = document.getElementById("ai-builder-modal");
    var aiDescriptionInput = document.getElementById("ai-description-input");
    var aiGenerateBtn = document.getElementById("ai-generate-btn");
    var aiDescribeError = document.getElementById("ai-describe-error");
    var aiStepDescribe = document.getElementById("ai-step-describe");
    var aiStepLoading = document.getElementById("ai-step-loading");
    var aiStepReview = document.getElementById("ai-step-review");

    var aiReviewName = document.getElementById("ai-review-name");
    var aiReviewRole = document.getElementById("ai-review-role");
    var aiReviewInstructions = document.getElementById("ai-review-instructions");
    var aiReviewTools = document.getElementById("ai-review-tools");
    var aiReviewModel = document.getElementById("ai-review-model");
    var aiReviewError = document.getElementById("ai-review-error");
    var aiBackBtn = document.getElementById("ai-back-btn");
    var aiConfirmBtn = document.getElementById("ai-confirm-btn");

    var generatedTools = [];

    function resetAiBuilder() {
      aiStepDescribe.classList.remove("hidden");
      aiStepLoading.classList.add("hidden");
      aiStepReview.classList.add("hidden");
      aiDescribeError.classList.add("hidden");
      aiReviewError.classList.add("hidden");
      aiDescriptionInput.value = "";
      generatedTools = [];
    }

    if (aiBuilderBtn) {
      aiBuilderBtn.addEventListener("click", function () {
        if (!currentProject) return;
        resetAiBuilder();
        aiBuilderModal.showModal();
        setTimeout(function () { aiDescriptionInput.focus(); }, 100);
      });
    }

    if (aiBuilderModal) {
      aiBuilderModal.addEventListener("close", resetAiBuilder);
    }

    // Generate button
    if (aiGenerateBtn) {
      aiGenerateBtn.addEventListener("click", function () {
        aiDescribeError.classList.add("hidden");
        var desc = aiDescriptionInput.value.trim();
        if (!desc) {
          aiDescribeError.textContent = "Please describe the agent you need";
          aiDescribeError.classList.remove("hidden");
          return;
        }

        // Show loading
        aiStepDescribe.classList.add("hidden");
        aiStepLoading.classList.remove("hidden");

        fetch("/api/v1/agents/ai-generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ description: desc }),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to generate"); });
            return res.json();
          })
          .then(function (data) {
            if (!data.agents || data.agents.length === 0) {
              throw new Error("No agent configuration generated");
            }
            var agent = data.agents[0];

            // Populate review form
            aiReviewName.value = agent.name || "";
            aiReviewRole.value = agent.persona_role || "";
            aiReviewInstructions.value = agent.instructions || "";
            aiReviewModel.value = agent.suggested_model || "";

            // Render tools as removable pills
            generatedTools = (agent.suggested_tools || []).slice();
            renderAiTools();

            // Show review step
            aiStepLoading.classList.add("hidden");
            aiStepReview.classList.remove("hidden");
          })
          .catch(function (err) {
            aiStepLoading.classList.add("hidden");
            aiStepDescribe.classList.remove("hidden");
            aiDescribeError.textContent = err.message;
            aiDescribeError.classList.remove("hidden");
          });
      });
    }

    function renderAiTools() {
      if (!aiReviewTools) return;
      if (generatedTools.length === 0) {
        aiReviewTools.innerHTML = '<span class="text-xs text-muted italic">None suggested</span>';
        return;
      }
      aiReviewTools.innerHTML = "";
      generatedTools.forEach(function (tool, idx) {
        var pill = document.createElement("span");
        pill.className = "inline-flex items-center gap-1 text-xs bg-zen-blue/10 text-zen-blue rounded-full px-2.5 py-1 font-medium";
        pill.innerHTML = tool + ' <button type="button" data-remove-tool="' + idx + '" class="ml-0.5 hover:text-coral transition-colors cursor-pointer">&times;</button>';
        aiReviewTools.appendChild(pill);
      });
    }

    // Remove tool pill
    if (aiReviewTools) {
      aiReviewTools.addEventListener("click", function (e) {
        var btn = e.target.closest("[data-remove-tool]");
        if (!btn) return;
        var idx = parseInt(btn.getAttribute("data-remove-tool"), 10);
        generatedTools.splice(idx, 1);
        renderAiTools();
      });
    }

    // Back to description
    if (aiBackBtn) {
      aiBackBtn.addEventListener("click", function () {
        aiStepReview.classList.add("hidden");
        aiStepDescribe.classList.remove("hidden");
      });
    }

    // Confirm and create agent
    if (aiConfirmBtn) {
      aiConfirmBtn.addEventListener("click", function () {
        aiReviewError.classList.add("hidden");
        var name = aiReviewName.value.trim();
        if (!name) {
          aiReviewError.textContent = "Agent name is required";
          aiReviewError.classList.remove("hidden");
          aiReviewName.focus();
          return;
        }

        aiConfirmBtn.disabled = true;
        aiConfirmBtn.textContent = "Creating...";

        var body = {
          name: name,
          project_id: projectId,
          description: aiReviewRole.value.trim(),
          instructions: aiReviewInstructions.value,
          persona_role: aiReviewRole.value.trim(),
          model_name: aiReviewModel.value.trim(),
          tools_json: JSON.stringify(generatedTools.map(function (t) {
            return { id: t, name: t, description: "", category: "" };
          })),
        };

        fetch("/api/v1/agents", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to create agent"); });
            return res.json();
          })
          .then(function (agent) {
            aiBuilderModal.close();
            window.location.href = "/agents/" + agent.id + "/edit";
          })
          .catch(function (err) {
            aiReviewError.textContent = err.message;
            aiReviewError.classList.remove("hidden");
          })
          .finally(function () {
            aiConfirmBtn.disabled = false;
            aiConfirmBtn.textContent = "Create Agent";
          });
      });
    }

    // Enter key in description input triggers generate
    if (aiDescriptionInput) {
      aiDescriptionInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          aiGenerateBtn.click();
        }
      });
    }

    // Initial load
    fetchProject();
  })();
</script>
