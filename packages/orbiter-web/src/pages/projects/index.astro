---
import PageLayout from "../../layouts/PageLayout.astro";
import Button from "../../components/Button.astro";
import Modal from "../../components/Modal.astro";
import Input from "../../components/Input.astro";

const breadcrumbs = [{ label: "Projects" }];

/* Icons used in this page */
const plusIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
const folderIcon = '<svg class="h-12 w-12 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>';
---

<PageLayout
  title="Projects"
  description="Manage your AI agent projects"
  activeSection="projects"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Projects</h1>
        <p class="text-sm text-muted mt-1">Organize your AI agents and workflows</p>
      </div>
      <Button
        variant="primary"
        id="create-project-btn"
      >
        <span set:html={plusIcon} />
        New Project
      </Button>
    </div>

    <!-- Projects grid (populated by JS) -->
    <div id="projects-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    </div>

    <!-- Empty state (hidden by default, shown when no projects) -->
    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <div class="mb-4" set:html={folderIcon} />
      <h2 class="text-lg font-semibold text-dark mb-2">No projects yet</h2>
      <p class="text-sm text-muted mb-6 max-w-sm">
        Projects help you organize your AI agents, workflows, and configurations in one place.
      </p>
      <Button variant="primary" id="create-project-cta">
        <span set:html={plusIcon} />
        Create your first project
      </Button>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="flex items-center justify-center py-20">
      <p class="text-sm text-muted">Loading projects...</p>
    </div>
  </div>

  <!-- Create Project Modal -->
  <Modal id="create-project-modal" title="Create Project">
    <form id="create-project-form" class="flex flex-col gap-4">
      <Input
        label="Project Name"
        name="name"
        placeholder="My awesome project"
        required
      />
      <div class="flex flex-col gap-1.5">
        <label for="project-description" class="text-sm font-medium text-dark">Description</label>
        <textarea
          id="project-description"
          name="description"
          rows="3"
          placeholder="What is this project about?"
          class="w-full bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-dark placeholder:text-muted/60 transition-all duration-200 outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 resize-none"
        ></textarea>
      </div>
      <div id="create-error" class="text-sm text-coral hidden"></div>
      <div class="flex justify-end gap-3 mt-2">
        <Button variant="default" type="button" data-modal-close="create-project-modal">
          Cancel
        </Button>
        <Button variant="primary" type="submit" id="create-submit-btn">
          Create Project
        </Button>
      </div>
    </form>
  </Modal>
</PageLayout>

<!-- Project card template (used by JS) -->
<template id="project-card-template">
  <a class="block rounded-xl bg-subtle/80 border border-dark/[0.08] transition-all duration-300 hover:-translate-y-0.5 hover:border-dark/20 hover:shadow-lg p-5">
    <div class="flex items-start justify-between mb-3">
      <h3 class="font-semibold text-dark text-base truncate pr-2" data-field="name"></h3>
    </div>
    <p class="text-sm text-muted line-clamp-2 mb-4 min-h-[2.5rem]" data-field="description"></p>
    <div class="flex items-center gap-3 text-xs text-muted">
      <span class="flex items-center gap-1" data-field="date">
      </span>
    </div>
  </a>
</template>

<script is:inline>
  (function () {
    var grid = document.getElementById("projects-grid");
    var emptyState = document.getElementById("empty-state");
    var loadingState = document.getElementById("loading-state");
    var createBtn = document.getElementById("create-project-btn");
    var createCta = document.getElementById("create-project-cta");
    var modal = document.getElementById("create-project-modal");
    var form = document.getElementById("create-project-form");
    var createError = document.getElementById("create-error");
    var submitBtn = document.getElementById("create-submit-btn");
    var template = document.getElementById("project-card-template");

    var clockSvg = '<svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';

    function formatDate(dateStr) {
      try {
        var d = new Date(dateStr + "Z");
        var now = new Date();
        var diff = now - d;
        if (diff < 60000) return "Just now";
        if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
        if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
      } catch (_e) {
        return dateStr;
      }
    }

    function renderProjects(projects) {
      if (loadingState) loadingState.classList.add("hidden");

      if (!projects || projects.length === 0) {
        grid.classList.add("hidden");
        emptyState.classList.remove("hidden");
        return;
      }

      grid.classList.remove("hidden");
      emptyState.classList.add("hidden");
      grid.innerHTML = "";

      projects.forEach(function (project) {
        var card = template.content.cloneNode(true);
        var link = card.querySelector("a");
        link.href = "/projects/" + project.id;

        var nameEl = card.querySelector('[data-field="name"]');
        nameEl.textContent = project.name;

        var descEl = card.querySelector('[data-field="description"]');
        descEl.textContent = project.description || "No description";
        if (!project.description) descEl.classList.add("italic", "text-muted/50");

        var dateEl = card.querySelector('[data-field="date"]');
        dateEl.innerHTML = clockSvg + " " + formatDate(project.updated_at);

        grid.appendChild(card);
      });
    }

    function fetchProjects() {
      fetch("/api/v1/projects")
        .then(function (res) {
          if (!res.ok) throw new Error("Failed to load projects");
          return res.json();
        })
        .then(function (body) { return body.data || body; })
        .then(renderProjects)
        .catch(function () {
          if (loadingState) loadingState.classList.add("hidden");
          grid.innerHTML = '<p class="text-sm text-coral col-span-full text-center py-10">Failed to load projects. Is the API server running?</p>';
          grid.classList.remove("hidden");
        });
    }

    function openCreateModal() {
      if (modal) modal.showModal();
    }

    if (createBtn) createBtn.addEventListener("click", openCreateModal);
    if (createCta) createCta.addEventListener("click", openCreateModal);

    if (form) {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        createError.classList.add("hidden");

        var formData = new FormData(form);
        var name = (formData.get("name") || "").toString().trim();
        var description = (formData.get("description") || "").toString().trim();

        if (!name) {
          createError.textContent = "Project name is required";
          createError.classList.remove("hidden");
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "Creating...";

        fetch("/api/v1/projects", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: name, description: description }),
        })
          .then(function (res) {
            if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || "Failed to create project"); });
            return res.json();
          })
          .then(function (project) {
            form.reset();
            modal.close();
            window.location.href = "/projects/" + project.id;
          })
          .catch(function (err) {
            createError.textContent = err.message;
            createError.classList.remove("hidden");
          })
          .finally(function () {
            submitBtn.disabled = false;
            submitBtn.textContent = "Create Project";
          });
      });
    }

    // Initial load
    fetchProjects();
  })();
</script>
