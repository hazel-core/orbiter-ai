---
import BaseLayout from "../layouts/BaseLayout.astro";
import Button from "../components/Button.astro";
import Input from "../components/Input.astro";
---

<BaseLayout title="Reset Password - Orbiter">
  <div class="min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-sm">
      <!-- Logo + heading -->
      <div class="text-center mb-8">
        <div class="flex items-center justify-center gap-3 mb-4">
          <svg class="h-10 w-10 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" />
            <path d="M2 12h20" />
          </svg>
          <span class="text-2xl font-semibold text-dark font-junicode">Orbiter</span>
        </div>
        <p class="text-sm text-muted">Reset your password</p>
      </div>

      <!-- Reset password form -->
      <form id="reset-form" class="rounded-xl bg-subtle/80 border border-dark/[0.08] p-6 flex flex-col gap-4">
        <Input
          label="New Password"
          name="new_password"
          type="password"
          placeholder="Minimum 8 characters"
          required
          autocomplete="new-password"
        />
        <Input
          label="Confirm Password"
          name="confirm_password"
          type="password"
          placeholder="Re-enter your password"
          required
          autocomplete="new-password"
        />

        <div id="reset-error" class="text-sm text-coral hidden"></div>
        <div id="reset-success" class="text-sm text-zen-green hidden"></div>

        <Button variant="primary" type="submit" id="reset-submit" class="w-full mt-2">
          Reset Password
        </Button>

        <a href="/login" class="text-sm text-center text-muted hover:text-dark transition-colors">
          Back to login
        </a>
      </form>
    </div>
  </div>
</BaseLayout>

<script is:inline>
  (function () {
    var params = new URLSearchParams(window.location.search);
    var token = params.get("token");

    var form = document.getElementById("reset-form");
    var errorEl = document.getElementById("reset-error");
    var successEl = document.getElementById("reset-success");
    var submitBtn = document.getElementById("reset-submit");
    if (!form || !errorEl || !successEl || !submitBtn) return;

    if (!token) {
      errorEl.textContent = "Missing reset token. Please use the link from your email.";
      errorEl.classList.remove("hidden");
      submitBtn.disabled = true;
      return;
    }

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      errorEl.classList.add("hidden");
      successEl.classList.add("hidden");

      var formData = new FormData(form);
      var newPassword = (formData.get("new_password") || "").toString();
      var confirmPassword = (formData.get("confirm_password") || "").toString();

      if (newPassword.length < 8) {
        errorEl.textContent = "Password must be at least 8 characters";
        errorEl.classList.remove("hidden");
        return;
      }

      if (newPassword !== confirmPassword) {
        errorEl.textContent = "Passwords do not match";
        errorEl.classList.remove("hidden");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Resetting...";

      fetch("/api/v1/auth/reset-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: token, new_password: newPassword }),
      })
        .then(function (res) {
          if (!res.ok) {
            return res.json().then(function (d) {
              throw new Error(d.detail || "Reset failed");
            });
          }
          return res.json();
        })
        .then(function () {
          successEl.textContent = "Password reset successfully. Redirecting to login...";
          successEl.classList.remove("hidden");
          form.querySelectorAll("input").forEach(function (input) {
            input.disabled = true;
          });
          setTimeout(function () {
            window.location.replace("/login");
          }, 2000);
        })
        .catch(function (err) {
          errorEl.textContent = err.message;
          errorEl.classList.remove("hidden");
        })
        .finally(function () {
          submitBtn.disabled = false;
          submitBtn.textContent = "Reset Password";
        });
    });
  })();
</script>
