---
import PageLayout from "../layouts/PageLayout.astro";

const breadcrumbs = [
  { label: "Artifacts" },
];

/* Icons */
const refreshIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>';
const gridIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>';
const listIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>';
const downloadIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
const trashIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
const chevronLeft = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>';
const chevronRight = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>';
const fileIcon = '<svg class="h-8 w-8 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>';
const imageIcon = '<svg class="h-8 w-8 text-zen-blue" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>';
const codeIcon = '<svg class="h-8 w-8 text-zen-green" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>';
const pdfIcon = '<svg class="h-8 w-8 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>';
---

<PageLayout
  title="Artifacts"
  description="Agent-generated file library"
  activeSection="artifacts"
  breadcrumbs={breadcrumbs}
>
  <div class="p-6 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-dark">Artifacts</h1>
        <p class="text-sm text-muted mt-0.5">All agent-generated files in one place</p>
      </div>
      <div class="flex items-center gap-2">
        <!-- Bulk download -->
        <button id="bulk-download-btn" class="hidden items-center gap-1.5 px-3 py-2 text-sm font-medium text-dark bg-paper border border-dark/[0.08] rounded-lg hover:bg-dark/[0.05] transition-colors cursor-pointer" title="Download selected as ZIP">
          <span set:html={downloadIcon} />
          Download ZIP
        </button>
        <!-- View toggle -->
        <div class="flex items-center border border-dark/[0.08] rounded-lg overflow-hidden">
          <button id="view-grid" class="p-2 bg-dark/[0.05] text-dark transition-colors cursor-pointer" title="Grid view">
            <span set:html={gridIcon} />
          </button>
          <button id="view-list" class="p-2 text-muted hover:text-dark transition-colors cursor-pointer" title="List view">
            <span set:html={listIcon} />
          </button>
        </div>
        <button id="refresh-btn" class="p-2 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors cursor-pointer" title="Refresh">
          <span set:html={refreshIcon} />
        </button>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap items-center gap-3 mb-6">
      <!-- File type -->
      <select id="filter-type" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer">
        <option value="">All Types</option>
        <option value="image">Images</option>
        <option value="text">Text Files</option>
        <option value="pdf">PDF</option>
        <option value="json">JSON</option>
        <option value="csv">CSV</option>
        <option value="code">Code</option>
      </select>

      <!-- Agent -->
      <select id="filter-agent" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer">
        <option value="">All Agents</option>
      </select>

      <!-- Date from -->
      <input type="date" id="filter-date-from" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer" placeholder="From date" />

      <!-- Date to -->
      <input type="date" id="filter-date-to" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all cursor-pointer" placeholder="To date" />

      <!-- Run ID -->
      <input type="text" id="filter-run" class="bg-paper border border-dark/[0.08] rounded-lg px-3 py-2 text-sm text-dark outline-none focus:border-coral focus:ring-2 focus:ring-coral/20 transition-all placeholder:text-muted/60 w-48" placeholder="Run ID..." />

      <!-- Clear filters -->
      <button id="clear-filters" class="hidden text-sm text-coral hover:text-coral/80 transition-colors cursor-pointer">Clear filters</button>
    </div>

    <!-- Grid view (default) -->
    <div id="artifacts-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
      <div class="col-span-full py-12 text-center text-muted">Loading...</div>
    </div>

    <!-- List view (hidden by default) -->
    <div id="artifacts-list" class="hidden bg-white rounded-xl border border-dark/[0.06] shadow-sm overflow-hidden mb-6">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-dark/[0.06] text-left">
              <th class="px-4 py-3 w-8"><input type="checkbox" id="select-all" class="rounded border-dark/20 cursor-pointer" /></th>
              <th class="px-4 py-3 font-medium text-muted text-xs uppercase tracking-wide">File</th>
              <th class="px-4 py-3 font-medium text-muted text-xs uppercase tracking-wide">Type</th>
              <th class="px-4 py-3 font-medium text-muted text-xs uppercase tracking-wide">Size</th>
              <th class="px-4 py-3 font-medium text-muted text-xs uppercase tracking-wide">Agent</th>
              <th class="px-4 py-3 font-medium text-muted text-xs uppercase tracking-wide">Run</th>
              <th class="px-4 py-3 font-medium text-muted text-xs uppercase tracking-wide">Created</th>
              <th class="px-4 py-3 font-medium text-muted text-xs uppercase tracking-wide text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="artifacts-tbody">
            <tr><td colspan="8" class="px-4 py-12 text-center text-muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div class="flex items-center justify-between">
      <p id="pagination-info" class="text-sm text-muted"></p>
      <div class="flex items-center gap-2">
        <button id="prev-btn" disabled class="p-2 rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors disabled:opacity-30 disabled:cursor-not-allowed cursor-pointer">
          <span set:html={chevronLeft} />
        </button>
        <button id="next-btn" disabled class="p-2 rounded-lg border border-dark/[0.08] text-muted hover:text-dark hover:bg-dark/[0.03] transition-colors disabled:opacity-30 disabled:cursor-not-allowed cursor-pointer">
          <span set:html={chevronRight} />
        </button>
      </div>
    </div>
  </div>

  <!-- Delete confirmation dialog -->
  <dialog id="delete-dialog" class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-sm w-full">
    <div class="p-6">
      <h3 class="text-lg font-semibold text-dark mb-2">Delete Artifact</h3>
      <p class="text-sm text-muted mb-6">Are you sure you want to delete this artifact? This action cannot be undone.</p>
      <div class="flex justify-end gap-3">
        <button id="delete-cancel" class="px-4 py-2 text-sm font-medium text-muted hover:text-dark border border-dark/[0.08] rounded-lg transition-colors cursor-pointer">Cancel</button>
        <button id="delete-confirm" class="px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-lg transition-colors cursor-pointer">Delete</button>
      </div>
    </div>
  </dialog>

  <!-- File preview dialog -->
  <dialog id="preview-dialog" class="rounded-xl border border-dark/[0.08] shadow-xl p-0 backdrop:bg-dark/40 max-w-4xl w-full max-h-[85vh]">
    <div class="p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 id="preview-title" class="text-lg font-semibold text-dark truncate mr-4"></h3>
        <button id="preview-close" class="p-1.5 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors cursor-pointer">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div id="preview-content" class="overflow-auto max-h-[70vh]"></div>
    </div>
  </dialog>
</PageLayout>

<script is:inline>
(function () {
  // State
  var artifacts = [];
  var agents = {};
  var selectedIds = new Set();
  var viewMode = "grid";
  var pendingDeleteId = null;

  // DOM refs
  var gridContainer = document.getElementById("artifacts-grid");
  var listContainer = document.getElementById("artifacts-list");
  var tbody = document.getElementById("artifacts-tbody");
  var filterType = document.getElementById("filter-type");
  var filterAgent = document.getElementById("filter-agent");
  var filterDateFrom = document.getElementById("filter-date-from");
  var filterDateTo = document.getElementById("filter-date-to");
  var filterRun = document.getElementById("filter-run");
  var clearFiltersBtn = document.getElementById("clear-filters");
  var refreshBtn = document.getElementById("refresh-btn");
  var viewGridBtn = document.getElementById("view-grid");
  var viewListBtn = document.getElementById("view-list");
  var bulkDownloadBtn = document.getElementById("bulk-download-btn");
  var selectAllCheckbox = document.getElementById("select-all");
  var prevBtn = document.getElementById("prev-btn");
  var nextBtn = document.getElementById("next-btn");
  var paginationInfo = document.getElementById("pagination-info");
  var deleteDialog = document.getElementById("delete-dialog");
  var deleteCancelBtn = document.getElementById("delete-cancel");
  var deleteConfirmBtn = document.getElementById("delete-confirm");
  var previewDialog = document.getElementById("preview-dialog");
  var previewTitle = document.getElementById("preview-title");
  var previewContent = document.getElementById("preview-content");
  var previewCloseBtn = document.getElementById("preview-close");

  // Pagination state
  var currentPage = 0;
  var pageSize = 24;

  // ------ Helpers ------

  function escapeHtml(str) {
    var div = document.createElement("div");
    div.textContent = str || "";
    return div.innerHTML;
  }

  function fmtSize(bytes) {
    if (bytes == null || bytes === 0) return "—";
    if (bytes < 1024) return bytes + " B";
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
    if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + " MB";
    return (bytes / 1073741824).toFixed(1) + " GB";
  }

  function fmtTime(t) {
    if (!t) return "—";
    var d = new Date(t + "Z");
    var now = new Date();
    var diff = now - d;
    if (diff < 60000) return "just now";
    if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
    if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
    return d.toLocaleDateString(undefined, { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
  }

  var IMAGE_EXTS = ["png", "jpg", "jpeg", "gif", "webp", "svg", "bmp", "ico"];
  var TEXT_EXTS = ["txt", "md", "log", "csv", "tsv", "xml", "yaml", "yml", "toml", "ini", "cfg", "env"];
  var CODE_EXTS = ["py", "js", "ts", "jsx", "tsx", "html", "css", "scss", "json", "sql", "sh", "bash", "go", "rs", "java", "c", "cpp", "h", "rb", "php"];
  var PDF_EXTS = ["pdf"];

  function getFileCategory(filename) {
    var ext = (filename || "").split(".").pop().toLowerCase();
    if (IMAGE_EXTS.indexOf(ext) !== -1) return "image";
    if (PDF_EXTS.indexOf(ext) !== -1) return "pdf";
    if (CODE_EXTS.indexOf(ext) !== -1) return "code";
    if (TEXT_EXTS.indexOf(ext) !== -1) return "text";
    if (ext === "json") return "json";
    if (ext === "csv") return "csv";
    return "other";
  }

  function isTextArtifact(filename) {
    var cat = getFileCategory(filename);
    return cat === "text" || cat === "code" || cat === "json" || cat === "csv";
  }

  function matchesTypeFilter(artifact, filterVal) {
    if (!filterVal) return true;
    var cat = getFileCategory(artifact.filename);
    if (filterVal === "text") return cat === "text";
    if (filterVal === "code") return cat === "code";
    return cat === filterVal;
  }

  function getFileIconHtml(filename) {
    var cat = getFileCategory(filename);
    if (cat === "image") return '<svg class="h-8 w-8 text-zen-blue" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>';
    if (cat === "pdf") return '<svg class="h-8 w-8 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>';
    if (cat === "code" || cat === "json") return '<svg class="h-8 w-8 text-zen-green" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>';
    return '<svg class="h-8 w-8 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>';
  }

  function getFileExt(filename) {
    return (filename || "").split(".").pop().toLowerCase();
  }

  function typeBadge(filename) {
    var ext = getFileExt(filename);
    var colors = {
      image: "bg-blue-100 text-blue-700 border-blue-200",
      pdf: "bg-red-100 text-red-700 border-red-200",
      code: "bg-green-100 text-green-700 border-green-200",
      json: "bg-green-100 text-green-700 border-green-200",
      text: "bg-gray-100 text-gray-600 border-gray-200",
      csv: "bg-yellow-100 text-yellow-700 border-yellow-200",
      other: "bg-gray-100 text-gray-600 border-gray-200",
    };
    var cat = getFileCategory(filename);
    var cls = colors[cat] || colors.other;
    return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ' + cls + '">' + escapeHtml(ext.toUpperCase()) + '</span>';
  }

  // ------ Selection ------

  function updateBulkActions() {
    if (selectedIds.size > 0) {
      bulkDownloadBtn.classList.remove("hidden");
      bulkDownloadBtn.classList.add("inline-flex");
    } else {
      bulkDownloadBtn.classList.add("hidden");
      bulkDownloadBtn.classList.remove("inline-flex");
    }
  }

  function toggleSelect(id) {
    if (selectedIds.has(id)) {
      selectedIds.delete(id);
    } else {
      selectedIds.add(id);
    }
    updateBulkActions();
    syncCheckboxes();
  }

  function syncCheckboxes() {
    document.querySelectorAll("[data-artifact-check]").forEach(function (cb) {
      cb.checked = selectedIds.has(cb.dataset.artifactCheck);
    });
    if (selectAllCheckbox) {
      selectAllCheckbox.checked = artifacts.length > 0 && selectedIds.size === artifacts.length;
    }
  }

  // ------ Data loading ------

  async function loadAgents() {
    try {
      var res = await fetch("/api/agents?limit=100");
      if (!res.ok) return;
      var body = await res.json();
      var list = body.data || body;
      if (Array.isArray(list)) {
        list.forEach(function (a) {
          agents[a.id] = a.name || a.id;
        });
        // Populate agent filter
        var frag = document.createDocumentFragment();
        list.forEach(function (a) {
          var opt = document.createElement("option");
          opt.value = a.id;
          opt.textContent = a.name || a.id;
          frag.appendChild(opt);
        });
        filterAgent.appendChild(frag);
      }
    } catch (_) { /* ignore */ }
  }

  async function loadArtifacts() {
    var params = new URLSearchParams();

    var agentVal = filterAgent.value;
    if (agentVal) params.set("agent_id", agentVal);

    var runVal = filterRun.value.trim();
    if (runVal) params.set("run_id", runVal);

    var dateFrom = filterDateFrom.value;
    if (dateFrom) params.set("date_from", dateFrom);

    var dateTo = filterDateTo.value;
    if (dateTo) params.set("date_to", dateTo);

    // file_type filter is client-side since the API filters by exact file_type string
    // and we want category-based filtering (e.g., "image" matches png, jpg, etc.)

    try {
      var res = await fetch("/api/artifacts?" + params.toString());
      if (!res.ok) throw new Error("API error " + res.status);
      var data = await res.json();

      // Client-side type filter
      var typeVal = filterType.value;
      if (typeVal) {
        data = data.filter(function (a) { return matchesTypeFilter(a, typeVal); });
      }

      artifacts = data;
      selectedIds.clear();
      currentPage = 0;
      render();
    } catch (err) {
      gridContainer.innerHTML = '<div class="col-span-full py-12 text-center text-muted">Failed to load artifacts</div>';
      tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-12 text-center text-muted">Failed to load artifacts</td></tr>';
    }
  }

  // ------ Rendering ------

  function getPagedArtifacts() {
    var start = currentPage * pageSize;
    return artifacts.slice(start, start + pageSize);
  }

  function render() {
    var paged = getPagedArtifacts();
    if (viewMode === "grid") {
      renderGrid(paged);
    } else {
      renderList(paged);
    }
    updatePagination();
    updateBulkActions();
    updateClearFilters();
  }

  function renderGrid(items) {
    if (!items.length) {
      gridContainer.innerHTML = '<div class="col-span-full py-12 text-center text-muted">No artifacts found</div>';
      return;
    }

    gridContainer.innerHTML = items.map(function (a) {
      var agentName = a.agent_id ? escapeHtml(agents[a.agent_id] || a.agent_id.slice(0, 8)) : "—";
      var isImage = getFileCategory(a.filename) === "image";
      var previewUrl = "/api/artifacts/" + encodeURIComponent(a.id) + "/download";

      var thumbnail = isImage
        ? '<div class="h-32 w-full bg-dark/[0.03] rounded-lg mb-3 overflow-hidden flex items-center justify-center"><img src="' + previewUrl + '" alt="' + escapeHtml(a.filename) + '" class="max-h-full max-w-full object-contain" loading="lazy" /></div>'
        : '<div class="h-32 w-full bg-dark/[0.03] rounded-lg mb-3 flex items-center justify-center">' + getFileIconHtml(a.filename) + '</div>';

      return '<div class="bg-white rounded-xl border border-dark/[0.06] shadow-sm p-4 hover:shadow-md transition-shadow group" data-artifact-id="' + a.id + '">'
        + '<div class="cursor-pointer" data-preview="' + a.id + '">' + thumbnail + '</div>'
        + '<div class="flex items-start justify-between gap-2">'
        + '<div class="min-w-0 flex-1">'
        + '<p class="text-sm font-medium text-dark truncate cursor-pointer hover:text-coral transition-colors" data-preview="' + a.id + '" title="' + escapeHtml(a.filename) + '">' + escapeHtml(a.filename) + '</p>'
        + '<div class="flex items-center gap-2 mt-1">' + typeBadge(a.filename) + '<span class="text-xs text-muted">' + fmtSize(a.file_size) + '</span></div>'
        + '<p class="text-xs text-muted mt-1">Agent: ' + agentName + '</p>'
        + (a.run_id ? '<p class="text-xs text-muted"><a href="/monitoring/runs/' + encodeURIComponent(a.run_id) + '" class="hover:text-coral transition-colors">Run ' + escapeHtml(a.run_id.slice(0, 8)) + '…</a></p>' : '')
        + '<p class="text-xs text-muted">' + fmtTime(a.created_at) + '</p>'
        + '</div>'
        + '<div class="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">'
        + (isTextArtifact(a.filename) ? '<a href="/artifacts/' + encodeURIComponent(a.id) + '" class="p-1.5 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors" title="Edit"><svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></a>' : '')
        + '<a href="' + previewUrl + '" download class="p-1.5 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors" title="Download">'
        + '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>'
        + '</a>'
        + '<button class="p-1.5 rounded-lg hover:bg-red-50 text-muted hover:text-red-500 transition-colors cursor-pointer" data-delete="' + a.id + '" title="Delete">'
        + '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>'
        + '</button>'
        + '</div>'
        + '</div>'
        + '</div>';
    }).join("");

    attachGridListeners();
  }

  function renderList(items) {
    if (!items.length) {
      tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-12 text-center text-muted">No artifacts found</td></tr>';
      return;
    }

    tbody.innerHTML = items.map(function (a) {
      var agentName = a.agent_id ? escapeHtml(agents[a.agent_id] || a.agent_id.slice(0, 8)) : "—";
      var previewUrl = "/api/artifacts/" + encodeURIComponent(a.id) + "/download";
      var checked = selectedIds.has(a.id) ? " checked" : "";

      return '<tr class="border-b border-dark/[0.04] hover:bg-dark/[0.02] transition-colors">'
        + '<td class="px-4 py-3"><input type="checkbox" data-artifact-check="' + a.id + '" class="rounded border-dark/20 cursor-pointer"' + checked + ' /></td>'
        + '<td class="px-4 py-3"><span class="text-dark font-medium cursor-pointer hover:text-coral transition-colors" data-preview="' + a.id + '">' + escapeHtml(a.filename) + '</span></td>'
        + '<td class="px-4 py-3">' + typeBadge(a.filename) + '</td>'
        + '<td class="px-4 py-3 text-dark tabular-nums">' + fmtSize(a.file_size) + '</td>'
        + '<td class="px-4 py-3 text-dark">' + agentName + '</td>'
        + '<td class="px-4 py-3">' + (a.run_id ? '<a href="/monitoring/runs/' + encodeURIComponent(a.run_id) + '" class="text-dark hover:text-coral transition-colors">' + escapeHtml(a.run_id.slice(0, 8)) + '…</a>' : '—') + '</td>'
        + '<td class="px-4 py-3 text-muted">' + fmtTime(a.created_at) + '</td>'
        + '<td class="px-4 py-3 text-right"><div class="flex items-center justify-end gap-1">'
        + (isTextArtifact(a.filename) ? '<a href="/artifacts/' + encodeURIComponent(a.id) + '" class="p-1.5 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors" title="Edit"><svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></a>' : '')
        + '<a href="' + previewUrl + '" download class="p-1.5 rounded-lg hover:bg-dark/[0.05] text-muted hover:text-dark transition-colors" title="Download"><svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></a>'
        + '<button class="p-1.5 rounded-lg hover:bg-red-50 text-muted hover:text-red-500 transition-colors cursor-pointer" data-delete="' + a.id + '" title="Delete"><svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>'
        + '</div></td>'
        + '</tr>';
    }).join("");

    attachListListeners();
  }

  function attachGridListeners() {
    gridContainer.querySelectorAll("[data-delete]").forEach(function (btn) {
      btn.addEventListener("click", function (e) {
        e.stopPropagation();
        promptDelete(btn.dataset.delete);
      });
    });
    gridContainer.querySelectorAll("[data-preview]").forEach(function (el) {
      el.addEventListener("click", function () {
        openPreview(el.dataset.preview);
      });
    });
  }

  function attachListListeners() {
    tbody.querySelectorAll("[data-artifact-check]").forEach(function (cb) {
      cb.addEventListener("change", function () {
        toggleSelect(cb.dataset.artifactCheck);
      });
    });
    tbody.querySelectorAll("[data-delete]").forEach(function (btn) {
      btn.addEventListener("click", function (e) {
        e.stopPropagation();
        promptDelete(btn.dataset.delete);
      });
    });
    tbody.querySelectorAll("[data-preview]").forEach(function (el) {
      el.addEventListener("click", function () {
        openPreview(el.dataset.preview);
      });
    });
  }

  // ------ Preview ------

  function openPreview(id) {
    var artifact = artifacts.find(function (a) { return a.id === id; });
    if (!artifact) return;

    previewTitle.textContent = artifact.filename;
    var url = "/api/artifacts/" + encodeURIComponent(id) + "/download";
    var cat = getFileCategory(artifact.filename);

    if (cat === "image") {
      previewContent.innerHTML = '<div class="flex items-center justify-center"><img src="' + url + '" alt="' + escapeHtml(artifact.filename) + '" class="max-w-full max-h-[65vh] object-contain rounded-lg" /></div>';
    } else if (cat === "pdf") {
      previewContent.innerHTML = '<iframe src="' + url + '" class="w-full h-[65vh] rounded-lg border border-dark/[0.06]" title="PDF Preview"></iframe>';
    } else if (cat === "code" || cat === "json" || cat === "text" || cat === "csv") {
      previewContent.innerHTML = '<div class="flex items-center justify-center py-8 text-muted">Loading…</div>';
      fetch(url).then(function (r) { return r.text(); }).then(function (text) {
        previewContent.innerHTML = '<pre class="bg-dark/[0.03] rounded-lg p-4 text-sm text-dark overflow-auto max-h-[65vh] whitespace-pre-wrap break-words font-mono"><code>' + escapeHtml(text) + '</code></pre>';
      }).catch(function () {
        previewContent.innerHTML = '<div class="text-center py-8 text-muted">Failed to load preview</div>';
      });
    } else {
      previewContent.innerHTML = '<div class="text-center py-8"><p class="text-muted mb-4">Preview not available for this file type</p><a href="' + url + '" download class="inline-flex items-center gap-2 px-4 py-2 bg-coral text-white rounded-lg hover:bg-coral/90 transition-colors text-sm font-medium">Download File</a></div>';
    }

    previewDialog.showModal();
  }

  // ------ Delete ------

  function promptDelete(id) {
    pendingDeleteId = id;
    deleteDialog.showModal();
  }

  async function confirmDelete() {
    if (!pendingDeleteId) return;
    try {
      var res = await fetch("/api/artifacts/" + encodeURIComponent(pendingDeleteId), { method: "DELETE" });
      if (!res.ok && res.status !== 204) throw new Error("Delete failed");
      deleteDialog.close();
      pendingDeleteId = null;
      loadArtifacts();
    } catch (_) {
      deleteDialog.close();
      pendingDeleteId = null;
    }
  }

  // ------ Bulk download ------

  function bulkDownload() {
    // Download each selected artifact individually (server doesn't support ZIP)
    selectedIds.forEach(function (id) {
      var link = document.createElement("a");
      link.href = "/api/artifacts/" + encodeURIComponent(id) + "/download";
      link.download = "";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  }

  // ------ Pagination ------

  function updatePagination() {
    var total = artifacts.length;
    var start = total === 0 ? 0 : currentPage * pageSize + 1;
    var end = Math.min((currentPage + 1) * pageSize, total);
    paginationInfo.textContent = start + "–" + end + " of " + total + " artifacts";
    prevBtn.disabled = currentPage === 0;
    nextBtn.disabled = (currentPage + 1) * pageSize >= total;
  }

  // ------ View toggle ------

  function setView(mode) {
    viewMode = mode;
    if (mode === "grid") {
      gridContainer.classList.remove("hidden");
      listContainer.classList.add("hidden");
      viewGridBtn.classList.add("bg-dark/[0.05]", "text-dark");
      viewGridBtn.classList.remove("text-muted");
      viewListBtn.classList.remove("bg-dark/[0.05]", "text-dark");
      viewListBtn.classList.add("text-muted");
    } else {
      gridContainer.classList.add("hidden");
      listContainer.classList.remove("hidden");
      viewListBtn.classList.add("bg-dark/[0.05]", "text-dark");
      viewListBtn.classList.remove("text-muted");
      viewGridBtn.classList.remove("bg-dark/[0.05]", "text-dark");
      viewGridBtn.classList.add("text-muted");
    }
    render();
  }

  function updateClearFilters() {
    var hasFilter = filterType.value || filterAgent.value || filterDateFrom.value || filterDateTo.value || filterRun.value.trim();
    if (hasFilter) {
      clearFiltersBtn.classList.remove("hidden");
    } else {
      clearFiltersBtn.classList.add("hidden");
    }
  }

  // ------ Events ------

  viewGridBtn.addEventListener("click", function () { setView("grid"); });
  viewListBtn.addEventListener("click", function () { setView("list"); });
  refreshBtn.addEventListener("click", function () { loadArtifacts(); });
  bulkDownloadBtn.addEventListener("click", bulkDownload);

  filterType.addEventListener("change", function () { currentPage = 0; loadArtifacts(); });
  filterAgent.addEventListener("change", function () { currentPage = 0; loadArtifacts(); });
  filterDateFrom.addEventListener("change", function () { currentPage = 0; loadArtifacts(); });
  filterDateTo.addEventListener("change", function () { currentPage = 0; loadArtifacts(); });

  var runDebounce = null;
  filterRun.addEventListener("input", function () {
    clearTimeout(runDebounce);
    runDebounce = setTimeout(function () { currentPage = 0; loadArtifacts(); }, 400);
  });

  clearFiltersBtn.addEventListener("click", function () {
    filterType.value = "";
    filterAgent.value = "";
    filterDateFrom.value = "";
    filterDateTo.value = "";
    filterRun.value = "";
    currentPage = 0;
    loadArtifacts();
  });

  prevBtn.addEventListener("click", function () {
    if (currentPage > 0) { currentPage--; render(); }
  });
  nextBtn.addEventListener("click", function () {
    if ((currentPage + 1) * pageSize < artifacts.length) { currentPage++; render(); }
  });

  selectAllCheckbox.addEventListener("change", function () {
    if (selectAllCheckbox.checked) {
      artifacts.forEach(function (a) { selectedIds.add(a.id); });
    } else {
      selectedIds.clear();
    }
    updateBulkActions();
    syncCheckboxes();
  });

  deleteCancelBtn.addEventListener("click", function () { deleteDialog.close(); pendingDeleteId = null; });
  deleteConfirmBtn.addEventListener("click", confirmDelete);
  deleteDialog.addEventListener("click", function (e) {
    if (e.target === deleteDialog) { deleteDialog.close(); pendingDeleteId = null; }
  });

  previewCloseBtn.addEventListener("click", function () { previewDialog.close(); });
  previewDialog.addEventListener("click", function (e) {
    if (e.target === previewDialog) { previewDialog.close(); }
  });

  // ------ Init ------

  loadAgents();
  loadArtifacts();
})();
</script>
