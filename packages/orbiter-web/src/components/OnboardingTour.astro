---
/**
 * Interactive onboarding tour component.
 * Guides new users through platform features with step-by-step highlights.
 * Triggered on first login (localStorage check) or via "Show Tour Again" in Settings.
 */
---

<!-- Tour overlay + tooltip container -->
<div id="onboarding-tour" class="hidden fixed inset-0 z-[100]" aria-label="Onboarding tour">
  <!-- Semi-transparent backdrop -->
  <div id="tour-backdrop" class="absolute inset-0 bg-dark/50 transition-opacity duration-300"></div>

  <!-- Spotlight cutout (positioned dynamically) -->
  <div
    id="tour-spotlight"
    class="absolute rounded-xl ring-4 ring-coral/40 transition-all duration-400 ease-out pointer-events-none"
    style="box-shadow: 0 0 0 9999px rgba(46,46,46,0.5);"
  ></div>

  <!-- Tooltip card -->
  <div
    id="tour-tooltip"
    class="absolute z-10 w-80 rounded-xl bg-paper border border-dark/[0.08] shadow-xl p-5 transition-all duration-300 ease-out"
    style="opacity: 0; transform: translateY(8px);"
  >
    <!-- Step indicator -->
    <div class="flex items-center justify-between mb-3">
      <span id="tour-step-label" class="text-xs font-medium text-muted"></span>
      <button
        id="tour-skip-btn"
        type="button"
        class="text-xs text-muted hover:text-dark transition-colors cursor-pointer"
      >
        Skip tour
      </button>
    </div>

    <!-- Content -->
    <h3 id="tour-title" class="text-base font-semibold text-dark mb-1.5"></h3>
    <p id="tour-description" class="text-sm text-muted leading-relaxed mb-4"></p>

    <!-- Navigation -->
    <div class="flex items-center justify-between">
      <button
        id="tour-prev-btn"
        type="button"
        class="inline-flex items-center gap-1.5 text-sm font-medium text-muted hover:text-dark transition-colors cursor-pointer"
      >
        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        Back
      </button>
      <div class="flex items-center gap-3">
        <!-- Step dots -->
        <div id="tour-dots" class="flex items-center gap-1.5"></div>
        <button
          id="tour-next-btn"
          type="button"
          class="inline-flex items-center gap-1.5 px-4 py-2 rounded-lg bg-dark text-paper text-sm font-medium hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 cursor-pointer"
        >
          Next
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Welcome prompt dialog (shown before tour starts) -->
<dialog
  id="tour-welcome-dialog"
  class="fixed inset-0 z-[101] m-0 h-full w-full max-h-full max-w-full bg-transparent p-0 backdrop:bg-dark/40 backdrop:backdrop-blur-sm open:flex open:items-center open:justify-center"
>
  <div class="modal-backdrop fixed inset-0" id="tour-welcome-backdrop"></div>
  <div class="relative z-10 w-full max-w-md rounded-xl bg-paper border border-dark/[0.08] shadow-xl mx-4 p-6 animate-[modalSlideIn_200ms_ease-out]">
    <div class="text-center">
      <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-coral/10 mb-4">
        <svg class="h-7 w-7 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
          <line x1="9" y1="9" x2="9.01" y2="9"/>
          <line x1="15" y1="9" x2="15.01" y2="9"/>
        </svg>
      </div>
      <h2 class="text-xl font-semibold text-dark mb-2">Welcome to Orbiter!</h2>
      <p class="text-sm text-muted leading-relaxed mb-6">
        Let us show you around. This quick tour will walk you through the key features to get you started.
      </p>
      <div class="flex flex-col gap-2">
        <button
          id="tour-start-btn"
          type="button"
          class="w-full inline-flex items-center justify-center gap-2 px-5 py-2.5 rounded-lg bg-dark text-paper text-sm font-medium hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 cursor-pointer"
        >
          Start tour
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
        <button
          id="tour-dismiss-btn"
          type="button"
          class="w-full inline-flex items-center justify-center px-5 py-2.5 rounded-lg border border-dark/[0.08] text-sm font-medium text-muted hover:text-dark hover:bg-dark/5 transition-all duration-200 cursor-pointer"
        >
          Maybe later
        </button>
      </div>
    </div>
  </div>
</dialog>

<style>
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(8px) scale(0.98);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
</style>

<script is:inline>
  (function () {
    var STORAGE_KEY = "orbiter-tour-completed";
    var tourContainer = document.getElementById("onboarding-tour");
    var backdrop = document.getElementById("tour-backdrop");
    var spotlight = document.getElementById("tour-spotlight");
    var tooltip = document.getElementById("tour-tooltip");
    var stepLabel = document.getElementById("tour-step-label");
    var titleEl = document.getElementById("tour-title");
    var descEl = document.getElementById("tour-description");
    var dotsContainer = document.getElementById("tour-dots");
    var prevBtn = document.getElementById("tour-prev-btn");
    var nextBtn = document.getElementById("tour-next-btn");
    var skipBtn = document.getElementById("tour-skip-btn");
    var welcomeDialog = document.getElementById("tour-welcome-dialog");
    var startBtn = document.getElementById("tour-start-btn");
    var dismissBtn = document.getElementById("tour-dismiss-btn");
    var welcomeBackdrop = document.getElementById("tour-welcome-backdrop");

    if (!tourContainer || !welcomeDialog) return;

    // ---------------------------------------------------------------
    // Tour steps
    // ---------------------------------------------------------------
    var steps = [
      {
        target: "[data-nav='projects']",
        title: "Projects",
        description: "Organize your work into projects. Each project groups agents, workflows, and other resources together.",
        position: "right",
      },
      {
        target: "[data-nav='agents']",
        title: "Agents",
        description: "Create and configure AI agents with custom system prompts, tools, and model providers.",
        position: "right",
      },
      {
        target: "[data-nav='workflows']",
        title: "Workflows",
        description: "Build visual workflows by connecting nodes on a canvas. Chain agents, tools, and logic together.",
        position: "right",
      },
      {
        target: "[data-nav='playground']",
        title: "Playground",
        description: "Test your agents in real-time. Chat with them, compare models side-by-side, and inspect execution traces.",
        position: "right",
      },
      {
        target: "[data-nav='settings']",
        title: "Settings",
        description: "Configure model providers, API keys, and workspace preferences. You'll need to add a model provider to get started.",
        position: "right",
      },
      {
        target: "[data-nav='docs']",
        title: "Documentation",
        description: 'Read the <a href="/docs/getting-started" style="color:var(--zen-coral);text-decoration:underline">Getting Started Guide</a> for detailed setup instructions, troubleshooting tips, and environment variable reference.',
        position: "right",
      },
    ];

    var currentStep = 0;

    // ---------------------------------------------------------------
    // Welcome dialog
    // ---------------------------------------------------------------
    function showWelcome() {
      welcomeDialog.showModal();
    }

    function closeWelcome() {
      welcomeDialog.close();
    }

    startBtn.addEventListener("click", function () {
      closeWelcome();
      startTour();
    });

    dismissBtn.addEventListener("click", function () {
      closeWelcome();
      completeTour();
    });

    welcomeBackdrop.addEventListener("click", function () {
      closeWelcome();
      completeTour();
    });

    // ---------------------------------------------------------------
    // Tour engine
    // ---------------------------------------------------------------
    function startTour() {
      currentStep = 0;
      tourContainer.classList.remove("hidden");
      renderStep();
    }

    function renderStep() {
      var step = steps[currentStep];

      // Update text
      stepLabel.textContent = "Step " + (currentStep + 1) + " of " + steps.length;
      titleEl.textContent = step.title;
      descEl.innerHTML = step.description;

      // Update dots
      dotsContainer.innerHTML = "";
      for (var i = 0; i < steps.length; i++) {
        var dot = document.createElement("span");
        dot.className = i === currentStep
          ? "w-2 h-2 rounded-full bg-coral"
          : "w-1.5 h-1.5 rounded-full bg-dark/20";
        dotsContainer.appendChild(dot);
      }

      // Update buttons
      prevBtn.style.visibility = currentStep === 0 ? "hidden" : "visible";
      if (currentStep === steps.length - 1) {
        nextBtn.innerHTML = 'Done <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
      } else {
        nextBtn.innerHTML = 'Next <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>';
      }

      // Position spotlight + tooltip
      positionElements(step);
    }

    function positionElements(step) {
      var target = document.querySelector(step.target);

      if (!target) {
        // Fallback: center tooltip without spotlight
        spotlight.style.display = "none";
        tooltip.style.left = "50%";
        tooltip.style.top = "50%";
        tooltip.style.transform = "translate(-50%, -50%)";
        tooltip.style.opacity = "1";
        return;
      }

      spotlight.style.display = "block";

      var rect = target.getBoundingClientRect();
      var pad = 6;

      // Position spotlight over target element
      spotlight.style.left = (rect.left - pad) + "px";
      spotlight.style.top = (rect.top - pad) + "px";
      spotlight.style.width = (rect.width + pad * 2) + "px";
      spotlight.style.height = (rect.height + pad * 2) + "px";

      // Position tooltip relative to target
      var tooltipWidth = 320;
      var tooltipHeight = tooltip.offsetHeight || 200;
      var vw = window.innerWidth;
      var vh = window.innerHeight;
      var tx, ty;

      if (step.position === "right" && rect.right + 16 + tooltipWidth < vw) {
        tx = rect.right + 16;
        ty = rect.top + (rect.height / 2) - (tooltipHeight / 2);
      } else if (step.position === "left" && rect.left - 16 - tooltipWidth > 0) {
        tx = rect.left - 16 - tooltipWidth;
        ty = rect.top + (rect.height / 2) - (tooltipHeight / 2);
      } else if (step.position === "bottom" || rect.bottom + 16 + tooltipHeight < vh) {
        tx = rect.left + (rect.width / 2) - (tooltipWidth / 2);
        ty = rect.bottom + 16;
      } else {
        tx = rect.left + (rect.width / 2) - (tooltipWidth / 2);
        ty = rect.top - 16 - tooltipHeight;
      }

      // Clamp to viewport
      tx = Math.max(12, Math.min(tx, vw - tooltipWidth - 12));
      ty = Math.max(12, Math.min(ty, vh - tooltipHeight - 12));

      tooltip.style.left = tx + "px";
      tooltip.style.top = ty + "px";
      tooltip.style.transform = "none";
      tooltip.style.opacity = "1";
    }

    function nextStep() {
      if (currentStep >= steps.length - 1) {
        completeTour();
        return;
      }
      currentStep++;
      renderStep();
    }

    function prevStep() {
      if (currentStep <= 0) return;
      currentStep--;
      renderStep();
    }

    function completeTour() {
      tourContainer.classList.add("hidden");
      localStorage.setItem(STORAGE_KEY, "true");
    }

    // ---------------------------------------------------------------
    // Event listeners
    // ---------------------------------------------------------------
    nextBtn.addEventListener("click", nextStep);
    prevBtn.addEventListener("click", prevStep);
    skipBtn.addEventListener("click", function () {
      completeTour();
    });

    // Close on Escape
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && !tourContainer.classList.contains("hidden")) {
        completeTour();
      }
    });

    // Reposition on resize
    window.addEventListener("resize", function () {
      if (!tourContainer.classList.contains("hidden")) {
        positionElements(steps[currentStep]);
      }
    });

    // ---------------------------------------------------------------
    // Global trigger for "Show Tour Again" button
    // ---------------------------------------------------------------
    window.__orbiterStartTour = function () {
      localStorage.removeItem(STORAGE_KEY);
      showWelcome();
    };

    // ---------------------------------------------------------------
    // Auto-trigger on first login
    // ---------------------------------------------------------------
    function checkFirstLogin() {
      if (localStorage.getItem(STORAGE_KEY)) return;
      // Small delay so the page layout has rendered fully
      setTimeout(function () {
        showWelcome();
      }, 800);
    }

    // Run after auth check succeeds (listen for the CSRF token fetch which signals auth is done)
    var origGetCsrf = window.getCsrfToken;
    if (origGetCsrf) {
      window.getCsrfToken = function () {
        var result = origGetCsrf.apply(this, arguments);
        // Auth succeeded â€” check if we need to show the tour
        checkFirstLogin();
        // Restore original so we only trigger once
        window.getCsrfToken = origGetCsrf;
        return result;
      };
    } else {
      // Fallback: just check after DOMContentLoaded
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", checkFirstLogin);
      } else {
        setTimeout(checkFirstLogin, 1000);
      }
    }
  })();
</script>
