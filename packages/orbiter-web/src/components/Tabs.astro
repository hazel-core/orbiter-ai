---
import { cn } from "../utils/merge";

interface Tab {
  id: string;
  label: string;
}

interface Props {
  tabs: Tab[];
  activeTab?: string;
  class?: string;
  [key: string]: any;
}

const { tabs, activeTab, class: className, ...rest } = Astro.props;
const defaultActive = activeTab || (tabs.length > 0 ? tabs[0].id : "");
---

<div
  class={cn("w-full", className)}
  data-tabs
  {...rest}
>
  <div
    class="flex border-b border-dark/[0.08]"
    role="tablist"
  >
    {tabs.map((tab) => (
      <button
        type="button"
        role="tab"
        aria-selected={tab.id === defaultActive ? "true" : "false"}
        aria-controls={`panel-${tab.id}`}
        data-tab={tab.id}
        class={cn(
          "relative px-4 py-2.5 text-sm font-medium transition-colors cursor-pointer",
          "hover:text-dark",
          "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-coral/30 focus-visible:ring-offset-2 focus-visible:ring-offset-paper rounded-t-md",
          tab.id === defaultActive
            ? "text-dark"
            : "text-muted",
        )}
      >
        {tab.label}
        <span
          class={cn(
            "absolute bottom-0 left-0 right-0 h-0.5 rounded-full transition-all duration-200",
            tab.id === defaultActive
              ? "bg-coral scale-x-100"
              : "bg-transparent scale-x-0",
          )}
          data-tab-indicator
        />
      </button>
    ))}
  </div>

  {tabs.map((tab) => (
    <div
      id={`panel-${tab.id}`}
      role="tabpanel"
      data-tab-panel={tab.id}
      class={cn(
        tab.id === defaultActive ? "" : "hidden",
      )}
    >
      <slot name={tab.id} />
    </div>
  ))}
</div>

<script>
  function initTabs() {
    document.querySelectorAll("[data-tabs]").forEach((container) => {
      const buttons = container.querySelectorAll<HTMLButtonElement>("[data-tab]");
      const panels = container.querySelectorAll<HTMLElement>("[data-tab-panel]");

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const tabId = btn.dataset.tab!;

          // Update buttons
          buttons.forEach((b) => {
            const isActive = b.dataset.tab === tabId;
            b.setAttribute("aria-selected", isActive ? "true" : "false");
            b.classList.toggle("text-dark", isActive);
            b.classList.toggle("text-muted", !isActive);

            const indicator = b.querySelector("[data-tab-indicator]");
            if (indicator) {
              indicator.classList.toggle("bg-coral", isActive);
              indicator.classList.toggle("scale-x-100", isActive);
              indicator.classList.toggle("bg-transparent", !isActive);
              indicator.classList.toggle("scale-x-0", !isActive);
            }
          });

          // Update panels
          panels.forEach((p) => {
            p.classList.toggle("hidden", p.dataset.tabPanel !== tabId);
          });
        });
      });
    });
  }

  initTabs();
  document.addEventListener("astro:after-swap", initTabs);
</script>
