---
import BaseLayout from "./BaseLayout.astro";
import { cn } from "../utils/merge";

interface Props {
  title?: string;
  description?: string;
  activeSection?: string;
  class?: string;
}

const { title, description, activeSection, class: className } = Astro.props;

const navSections = [
  { id: "projects", label: "Projects", href: "/projects", icon: "folder" },
  { id: "agents", label: "Agents", href: "/agents", icon: "bot" },
  { id: "workflows", label: "Workflows", href: "/workflows", icon: "workflow" },
  { id: "playground", label: "Playground", href: "/playground", icon: "play" },
  { id: "tools", label: "Tools", href: "/tools", icon: "wrench" },
  { id: "models", label: "Models", href: "/models", icon: "cube" },
  { id: "knowledge", label: "Knowledge Base", href: "/knowledge", icon: "book" },
  { id: "monitoring", label: "Monitoring", href: "/monitoring", icon: "chart" },
  { id: "plugins", label: "Plugins", href: "/plugins", icon: "puzzle" },
  { id: "settings", label: "Settings", href: "/settings", icon: "gear" },
];

const icons: Record<string, string> = {
  folder: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
  bot: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>',
  workflow: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="6" height="6" rx="1"/><rect x="15" y="3" width="6" height="6" rx="1"/><rect x="9" y="15" width="6" height="6" rx="1"/><path d="M6 9v3a1 1 0 0 0 1 1h4"/><path d="M18 9v3a1 1 0 0 1-1 1h-4"/><path d="M12 13v2"/></svg>',
  play: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
  wrench: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
  cube: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
  book: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
  chart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
  puzzle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19.439 7.85c-.049.322.059.648.289.878l1.568 1.568c.47.47.706 1.087.706 1.704s-.235 1.233-.706 1.704l-1.611 1.611a.98.98 0 0 1-.837.276c-.47-.07-.802-.48-.968-.925a2.501 2.501 0 1 0-3.214 3.214c.446.166.855.497.925.968a.979.979 0 0 1-.276.837l-1.61 1.61a2.404 2.404 0 0 1-1.705.707 2.402 2.402 0 0 1-1.704-.706l-1.568-1.568a1.026 1.026 0 0 0-.877-.29c-.493.074-.84.504-1.02.968a2.5 2.5 0 1 1-3.237-3.237c.464-.18.894-.527.967-1.02a1.026 1.026 0 0 0-.289-.877l-1.568-1.568A2.402 2.402 0 0 1 1.998 12c0-.617.236-1.234.706-1.704L4.315 8.685a.98.98 0 0 1 .837-.276c.47.07.802.48.968.925a2.501 2.501 0 1 0 3.214-3.214c-.446-.166-.855-.497-.925-.968a.979.979 0 0 1 .276-.837l1.61-1.61a2.404 2.404 0 0 1 1.705-.707c.618 0 1.234.236 1.704.706l1.568 1.568c.23.23.556.338.877.29.493-.074.84-.504 1.02-.968a2.5 2.5 0 1 1 3.237 3.237c-.464.18-.894.527-.967 1.02z"/></svg>',
  gear: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
};

function getIcon(name: string): string {
  return icons[name] || "";
}
---

<BaseLayout title={title} description={description}>
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="group/sidebar flex flex-col border-r border-dark/[0.08] bg-paper transition-all duration-300 lg:w-60 w-16"
      data-collapsed="true"
    >
      <!-- Logo / Brand -->
      <div class="flex h-14 items-center border-b border-dark/[0.08] px-4 overflow-hidden">
        <div class="flex items-center gap-3 min-w-0">
          <svg class="h-7 w-7 shrink-0 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" />
            <path d="M2 12h20" />
          </svg>
          <span class="font-semibold text-dark text-sm whitespace-nowrap sidebar-label hidden lg:block">
            Orbiter
          </span>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 overflow-y-auto py-3 px-2 space-y-1">
        {navSections.map((section) => {
          const isActive = activeSection === section.id;
          return (
            <a
              href={section.href}
              class={cn(
                "flex items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium transition-colors duration-150",
                isActive
                  ? "bg-coral/10 text-coral"
                  : "text-muted hover:bg-dark/5 hover:text-dark"
              )}
              title={section.label}
            >
              <span class="shrink-0 w-5 h-5" set:html={getIcon(section.icon)} />
              <span class="whitespace-nowrap sidebar-label hidden lg:block">{section.label}</span>
            </a>
          );
        })}
      </nav>

      <!-- Collapse toggle (visible on lg+) -->
      <div class="hidden lg:flex border-t border-dark/[0.08] p-2">
        <button
          id="sidebar-toggle"
          class="flex w-full items-center justify-center gap-2 rounded-lg px-3 py-2 text-sm text-muted hover:bg-dark/5 hover:text-dark transition-colors duration-150 cursor-pointer"
          title="Toggle sidebar"
        >
          <svg id="collapse-icon" class="h-5 w-5 shrink-0 transition-transform duration-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="11 17 6 12 11 7" />
            <polyline points="18 17 13 12 18 7" />
          </svg>
          <span class="whitespace-nowrap sidebar-label hidden lg:block">Collapse</span>
        </button>
      </div>
    </aside>

    <!-- Main content area -->
    <main class={cn("flex-1 overflow-y-auto", className)}>
      <slot />
    </main>
  </div>

  <!-- Sidebar collapse/expand script -->
  <script is:inline>
    (function () {
      var sidebar = document.getElementById("sidebar");
      var toggle = document.getElementById("sidebar-toggle");
      var collapseIcon = document.getElementById("collapse-icon");
      if (!sidebar || !toggle) return;

      var STORAGE_KEY = "sidebar-collapsed";
      var labels = sidebar.querySelectorAll(".sidebar-label");

      function collapse() {
        sidebar.classList.remove("lg:w-60");
        sidebar.classList.add("lg:w-16");
        labels.forEach(function (el) {
          el.classList.add("lg:hidden");
        });
        if (collapseIcon) collapseIcon.style.transform = "rotate(180deg)";
        sidebar.setAttribute("data-collapsed", "true");
        localStorage.setItem(STORAGE_KEY, "true");
      }

      function expand() {
        sidebar.classList.remove("lg:w-16");
        sidebar.classList.add("lg:w-60");
        labels.forEach(function (el) {
          el.classList.remove("lg:hidden");
        });
        if (collapseIcon) collapseIcon.style.transform = "";
        sidebar.setAttribute("data-collapsed", "false");
        localStorage.setItem(STORAGE_KEY, "false");
      }

      // Restore state from localStorage
      var stored = localStorage.getItem(STORAGE_KEY);
      if (stored === "true") {
        collapse();
      } else if (stored === "false") {
        expand();
      }

      toggle.addEventListener("click", function () {
        var isCollapsed = sidebar.getAttribute("data-collapsed") === "true";
        if (isCollapsed) {
          expand();
        } else {
          collapse();
        }
      });

      // Cmd+B / Ctrl+B keyboard shortcut
      document.addEventListener("keydown", function (e) {
        if ((e.metaKey || e.ctrlKey) && e.key === "b") {
          e.preventDefault();
          toggle.click();
        }
      });
    })();
  </script>
</BaseLayout>
