---
import BaseLayout from "./BaseLayout.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import OnboardingTour from "../components/OnboardingTour.astro";
import { cn } from "../utils/merge";

interface BreadcrumbItem {
  label: string;
  href?: string;
}

interface Props {
  title?: string;
  description?: string;
  activeSection?: string;
  breadcrumbs?: BreadcrumbItem[];
  projectName?: string;
  class?: string;
}

const {
  title,
  description,
  activeSection,
  breadcrumbs = [],
  projectName = "Orbiter",
  class: className,
} = Astro.props;

const navSections = [
  { id: "projects", label: "Projects", href: "/projects", icon: "folder" },
  { id: "agents", label: "Agents", href: "/agents", icon: "bot" },
  { id: "workflows", label: "Workflows", href: "/workflows", icon: "workflow" },
  { id: "playground", label: "Playground", href: "/playground", icon: "play" },
  { id: "tools", label: "Tools", href: "/tools", icon: "wrench" },
  { id: "models", label: "Models", href: "/models", icon: "cube" },
  { id: "knowledge", label: "Knowledge Base", href: "/knowledge", icon: "book" },
  { id: "deployments", label: "Deployments", href: "/deployments", icon: "rocket" },
  { id: "monitoring", label: "Monitoring", href: "/monitoring", icon: "chart" },
  { id: "artifacts", label: "Artifacts", href: "/artifacts", icon: "file" },
  { id: "evaluations", label: "Evaluations", href: "/evaluations", icon: "checklist" },
  { id: "benchmarks", label: "Benchmarks", href: "/benchmarks", icon: "trophy" },
  { id: "annotations", label: "Annotations", href: "/annotations", icon: "pen" },
  { id: "templates", label: "Templates", href: "/templates", icon: "template" },
  { id: "plugins", label: "Plugins", href: "/plugins", icon: "puzzle" },
  { id: "docs", label: "Docs", href: "/docs", icon: "help" },
  { id: "settings", label: "Settings", href: "/settings", icon: "gear" },
];

/* Key sections shown in the mobile bottom tab bar */
const mobileTabSections = navSections.filter((s) =>
  ["projects", "agents", "workflows", "playground", "settings"].includes(s.id)
);

const icons: Record<string, string> = {
  folder: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
  bot: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>',
  workflow: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="6" height="6" rx="1"/><rect x="15" y="3" width="6" height="6" rx="1"/><rect x="9" y="15" width="6" height="6" rx="1"/><path d="M6 9v3a1 1 0 0 0 1 1h4"/><path d="M18 9v3a1 1 0 0 1-1 1h-4"/><path d="M12 13v2"/></svg>',
  play: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
  wrench: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
  cube: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
  book: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
  chart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
  file: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
  checklist: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
  trophy: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>',
  pen: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
  template: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>',
  puzzle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19.439 7.85c-.049.322.059.648.289.878l1.568 1.568c.47.47.706 1.087.706 1.704s-.235 1.233-.706 1.704l-1.611 1.611a.98.98 0 0 1-.837.276c-.47-.07-.802-.48-.968-.925a2.501 2.501 0 1 0-3.214 3.214c.446.166.855.497.925.968a.979.979 0 0 1-.276.837l-1.61 1.61a2.404 2.404 0 0 1-1.705.707 2.402 2.402 0 0 1-1.704-.706l-1.568-1.568a1.026 1.026 0 0 0-.877-.29c-.493.074-.84.504-1.02.968a2.5 2.5 0 1 1-3.237-3.237c.464-.18.894-.527.967-1.02a1.026 1.026 0 0 0-.289-.877l-1.568-1.568A2.402 2.402 0 0 1 1.998 12c0-.617.236-1.234.706-1.704L4.315 8.685a.98.98 0 0 1 .837-.276c.47.07.802.48.968.925a2.501 2.501 0 1 0 3.214-3.214c-.446-.166-.855-.497-.925-.968a.979.979 0 0 1 .276-.837l1.61-1.61a2.404 2.404 0 0 1 1.705-.707c.618 0 1.234.236 1.704.706l1.568 1.568c.23.23.556.338.877.29.493-.074.84-.504 1.02-.968a2.5 2.5 0 1 1 3.237 3.237c-.464.18-.894.527-.967 1.02z"/></svg>',
  rocket: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 4 0 4 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-4 0-4"/></svg>',
  help: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
  gear: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
};

function getIcon(name: string): string {
  return icons[name] || "";
}

/* Top bar icon SVGs */
const searchIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
const sunIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
const moonIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
const userIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
const hamburgerIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>';
const closeIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
const bellIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>';
---

<BaseLayout title={title} description={description}>
  <div class="flex h-screen overflow-hidden">
    <!-- Desktop sidebar (hidden on < md) -->
    <aside
      id="sidebar"
      class="hidden md:flex flex-col border-r border-dark/[0.08] bg-paper transition-all duration-300 lg:w-60 w-16"
      data-collapsed="true"
    >
      <!-- Logo / Brand -->
      <div class="flex h-14 items-center border-b border-dark/[0.08] px-4 overflow-hidden">
        <div class="flex items-center gap-3 min-w-0">
          <svg class="h-7 w-7 shrink-0 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" />
            <path d="M2 12h20" />
          </svg>
          <span class="font-semibold text-dark text-sm whitespace-nowrap sidebar-label hidden lg:block">
            Orbiter
          </span>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 overflow-y-auto py-3 px-2 space-y-1">
        {navSections.map((section) => {
          const isActive = activeSection === section.id;
          return (
            <a
              href={section.href}
              data-nav={section.id}
              class={cn(
                "flex items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium transition-colors duration-150",
                isActive
                  ? "bg-coral/10 text-coral"
                  : "text-muted hover:bg-dark/5 hover:text-dark"
              )}
              title={section.label}
            >
              <span class="shrink-0 w-5 h-5" set:html={getIcon(section.icon)} />
              <span class="whitespace-nowrap sidebar-label hidden lg:block">{section.label}</span>
            </a>
          );
        })}
      </nav>

      <!-- Collapse toggle (visible on lg+) -->
      <div class="hidden lg:flex border-t border-dark/[0.08] p-2">
        <button
          id="sidebar-toggle"
          class="flex w-full items-center justify-center gap-2 rounded-lg px-3 py-2 text-sm text-muted hover:bg-dark/5 hover:text-dark transition-colors duration-150 cursor-pointer"
          title="Toggle sidebar"
        >
          <svg id="collapse-icon" class="h-5 w-5 shrink-0 transition-transform duration-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="11 17 6 12 11 7" />
            <polyline points="18 17 13 12 18 7" />
          </svg>
          <span class="whitespace-nowrap sidebar-label hidden lg:block">Collapse</span>
        </button>
      </div>
    </aside>

    <!-- Right side: top bar + content -->
    <div class="flex flex-1 flex-col overflow-hidden">
      <!-- Top bar -->
      <header class="flex h-14 shrink-0 items-center justify-between border-b border-dark/[0.08] bg-paper px-4 gap-4">
        <!-- Left: hamburger (mobile) + project name + breadcrumbs -->
        <div class="flex items-center gap-3 min-w-0">
          <!-- Hamburger menu (visible on < md) -->
          <button
            id="mobile-menu-toggle"
            class="md:hidden flex items-center justify-center rounded-lg p-1.5 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
            title="Open menu"
          >
            <span set:html={hamburgerIcon} />
          </button>

          <span class="text-sm font-semibold text-dark truncate">{projectName}</span>

          {breadcrumbs.length > 0 && (
            <>
              <span class="hidden sm:block text-muted/40">|</span>
              <Breadcrumbs items={breadcrumbs} class="hidden sm:flex" />
            </>
          )}
        </div>

        <!-- Right: search, theme toggle, user menu -->
        <div class="flex items-center gap-1">
          <!-- Search trigger (Cmd+K) -->
          <button
            id="search-trigger"
            class="flex items-center gap-2 rounded-lg border border-dark/[0.08] px-3 py-1.5 text-sm text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
            title="Search (Cmd+K)"
          >
            <span set:html={searchIcon} />
            <span class="hidden sm:inline">Search</span>
            <kbd class="hidden sm:inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-1.5 py-0.5 text-[10px] font-medium text-muted">
              <span class="text-xs">&#8984;</span>K
            </kbd>
          </button>

          <!-- Theme toggle -->
          <button
            id="theme-toggle"
            class="flex items-center justify-center rounded-lg p-2 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
            title="Toggle theme"
          >
            <span id="theme-icon-light" set:html={sunIcon} />
            <span id="theme-icon-dark" class="hidden" set:html={moonIcon} />
          </button>

          <!-- Help button (?) -->
          <button
            id="help-trigger"
            class="flex items-center justify-center rounded-lg p-2 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
            title="Help & Documentation"
          >
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          </button>

          <!-- Approvals notification bell -->
          <button
            id="approvals-bell"
            class="relative flex items-center justify-center rounded-lg p-2 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
            title="Pending approvals"
          >
            <span set:html={bellIcon} />
            <span
              id="approvals-badge"
              class="hidden absolute -top-0.5 -right-0.5 flex items-center justify-center min-w-[18px] h-[18px] rounded-full bg-coral text-white text-[10px] font-bold leading-none px-1"
            ></span>
          </button>

          <!-- Notifications bell -->
          <div class="relative" id="notif-container">
            <button
              id="notif-bell"
              class="relative flex items-center justify-center rounded-lg p-2 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
              title="Notifications"
            >
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
              <span
                id="notif-badge"
                class="hidden absolute -top-0.5 -right-0.5 flex items-center justify-center min-w-[18px] h-[18px] rounded-full bg-coral text-white text-[10px] font-bold leading-none px-1"
              ></span>
            </button>

            <!-- Notifications dropdown -->
            <div
              id="notif-dropdown"
              class="hidden absolute right-0 top-full mt-2 w-80 max-h-[420px] rounded-xl border border-dark/[0.08] bg-paper shadow-xl z-50 flex flex-col overflow-hidden"
            >
              <!-- Header -->
              <div class="flex items-center justify-between border-b border-dark/[0.08] px-4 py-3">
                <span class="text-sm font-semibold text-dark">Notifications</span>
                <button
                  id="notif-mark-all"
                  class="text-xs text-coral hover:underline cursor-pointer"
                >Mark all as read</button>
              </div>
              <!-- Notification list -->
              <div id="notif-list" class="flex-1 overflow-y-auto">
                <div id="notif-empty" class="px-4 py-8 text-center text-sm text-muted">
                  No notifications
                </div>
              </div>
            </div>
          </div>

          <!-- User menu -->
          <button
            id="user-menu-trigger"
            class="flex items-center justify-center rounded-lg p-2 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
            title="User menu"
          >
            <span set:html={userIcon} />
          </button>
        </div>
      </header>

      <!-- Main content area -->
      <main class={cn("flex-1 overflow-y-auto pb-16 md:pb-0", className)}>
        <!-- Global budget warning banner -->
        <div id="global-budget-banner" class="hidden mx-4 mt-4 rounded-xl border px-5 py-3">
          <div class="flex items-center gap-3">
            <svg class="h-4 w-4 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            <p id="global-budget-text" class="text-xs font-medium flex-1"></p>
            <a href="/monitoring/costs" class="text-xs underline hover:no-underline flex-shrink-0">View costs</a>
          </div>
        </div>
        <slot />
      </main>
    </div>
  </div>

  <!-- Mobile bottom tab bar (visible on < md) -->
  <nav
    id="mobile-tab-bar"
    class="md:hidden fixed bottom-0 left-0 right-0 z-40 flex items-center justify-around border-t border-dark/[0.08] bg-paper px-2 py-1"
  >
    {mobileTabSections.map((section) => {
      const isActive = activeSection === section.id;
      return (
        <a
          href={section.href}
          class={cn(
            "flex flex-col items-center gap-0.5 rounded-lg px-3 py-1.5 text-[10px] font-medium transition-colors duration-150",
            isActive ? "text-coral" : "text-muted"
          )}
        >
          <span class="w-5 h-5" set:html={getIcon(section.icon)} />
          <span>{section.label}</span>
        </a>
      );
    })}
  </nav>

  <!-- Mobile slide-out menu overlay -->
  <div
    id="mobile-menu-overlay"
    class="fixed inset-0 z-50 hidden"
  >
    <!-- Backdrop -->
    <div
      id="mobile-menu-backdrop"
      class="absolute inset-0 bg-dark/40 backdrop-blur-sm"
    ></div>

    <!-- Slide-out panel -->
    <aside
      id="mobile-menu-panel"
      class="absolute top-0 left-0 bottom-0 w-72 bg-paper shadow-xl flex flex-col"
      style="transform: translateX(-100%); transition: transform 200ms ease-out;"
    >
      <!-- Header with close button -->
      <div class="flex h-14 items-center justify-between border-b border-dark/[0.08] px-4">
        <div class="flex items-center gap-3">
          <svg class="h-7 w-7 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" />
            <path d="M2 12h20" />
          </svg>
          <span class="font-semibold text-dark text-sm">Orbiter</span>
        </div>
        <button
          id="mobile-menu-close"
          class="flex items-center justify-center rounded-lg p-1.5 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
          title="Close menu"
        >
          <span set:html={closeIcon} />
        </button>
      </div>

      <!-- Full navigation list -->
      <nav class="flex-1 overflow-y-auto py-3 px-3 space-y-1">
        {navSections.map((section) => {
          const isActive = activeSection === section.id;
          return (
            <a
              href={section.href}
              class={cn(
                "flex items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors duration-150",
                isActive
                  ? "bg-coral/10 text-coral"
                  : "text-muted hover:bg-dark/5 hover:text-dark"
              )}
            >
              <span class="shrink-0 w-5 h-5" set:html={getIcon(section.icon)} />
              <span>{section.label}</span>
            </a>
          );
        })}
      </nav>
    </aside>
  </div>

  <!-- Connection status banner (shown on WebSocket auth failure / disconnect) -->
  <div
    id="connection-banner"
    class="hidden fixed top-0 left-0 right-0 z-[90] flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium bg-coral/10 border-b border-coral/20 text-coral"
  >
    <svg class="h-4 w-4 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="1" y1="1" x2="23" y2="23"/>
      <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/>
      <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/>
      <path d="M10.71 5.05A16 16 0 0 1 22.56 9"/>
      <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/>
      <path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
      <line x1="12" y1="20" x2="12.01" y2="20"/>
    </svg>
    <span id="connection-banner-text">Connection lost. Reconnecting...</span>
  </div>

  <!-- Auth check: redirect unauthenticated users to /login -->
  <script is:inline>
    (function () {
      /* ---------- Session expiry state ---------- */
      var _sessionExpired = false;
      var _pendingControllers = [];

      /** Cancel all in-flight requests and redirect to login. */
      window.__orbiterExpireSession = function () {
        if (_sessionExpired) return;
        _sessionExpired = true;
        // Abort all tracked requests to prevent cascading error toasts.
        for (var i = 0; i < _pendingControllers.length; i++) {
          try { _pendingControllers[i].abort(); } catch (_) {}
        }
        _pendingControllers = [];
        window.location.replace("/login?expired=true");
      };

      /* ---------- CSRF auto-include ---------- */
      var _csrfToken = null;
      var _csrfPromise = null;
      var _unsafeMethods = { POST: 1, PUT: 1, DELETE: 1, PATCH: 1 };
      var _origFetch = window.fetch;

      /** Fetch and cache the CSRF token for the current session. */
      window.getCsrfToken = function () {
        if (_csrfToken) return Promise.resolve(_csrfToken);
        if (_csrfPromise) return _csrfPromise;
        _csrfPromise = _origFetch("/api/v1/auth/csrf", { credentials: "same-origin" })
          .then(function (r) {
            if (!r.ok) return "";
            return r.json().then(function (d) { _csrfToken = d.token; return _csrfToken; });
          })
          .catch(function () { return ""; })
          .finally(function () { _csrfPromise = null; });
        return _csrfPromise;
      };

      /** Clear cached CSRF token (call on logout). */
      window.clearCsrfToken = function () { _csrfToken = null; };

      /**
       * Patched fetch: auto-includes X-CSRF-Token on unsafe same-origin requests
       * AND intercepts 401 responses to trigger session expiry.
       */
      window.fetch = function (input, init) {
        if (_sessionExpired) {
          return Promise.reject(new DOMException("Session expired", "AbortError"));
        }

        init = init || {};
        var method = (init.method || "GET").toUpperCase();

        // Determine if this is a same-origin API request.
        var url = typeof input === "string" ? input : (input.url || "");
        var isSameOrigin = url.indexOf("://") === -1 || url.indexOf(location.origin) === 0;
        var isApiRequest = isSameOrigin && url.indexOf("/api/v1/") !== -1;

        // Track request with AbortController for cancellation on expiry.
        var controller = null;
        if (isApiRequest && !init.signal) {
          controller = new AbortController();
          _pendingControllers.push(controller);
          init.signal = controller.signal;
        }

        function removeController() {
          if (controller) {
            var idx = _pendingControllers.indexOf(controller);
            if (idx !== -1) _pendingControllers.splice(idx, 1);
          }
        }

        // For non-unsafe or non-same-origin requests, skip CSRF but still intercept 401.
        var fetchPromise;
        if (!_unsafeMethods[method] || !isSameOrigin) {
          fetchPromise = _origFetch(input, init);
        } else {
          fetchPromise = window.getCsrfToken().then(function (token) {
            if (token) {
              init.headers = init.headers || {};
              if (typeof init.headers.set === "function") {
                init.headers.set("X-CSRF-Token", token);
              } else {
                init.headers["X-CSRF-Token"] = token;
              }
            }
            return _origFetch(input, init);
          });
        }

        return fetchPromise.then(function (res) {
          removeController();
          // Intercept 401 on API requests (skip /api/v1/auth/login to avoid redirect loops).
          if (isApiRequest && res.status === 401 && url.indexOf("/api/v1/auth/login") === -1) {
            window.__orbiterExpireSession();
            return Promise.reject(new DOMException("Session expired", "AbortError"));
          }
          return res;
        }).catch(function (err) {
          removeController();
          throw err;
        });
      };

      /* ---------- Auth check ---------- */
      _origFetch("/api/v1/auth/me", { credentials: "same-origin" })
        .then(function (res) {
          if (!res.ok) window.location.replace("/login");
          else window.getCsrfToken(); // Prefetch CSRF token.
        })
        .catch(function () {
          window.location.replace("/login");
        });
    })();
  </script>

  <!-- Sidebar collapse/expand script -->
  <script is:inline>
    (function () {
      var sidebar = document.getElementById("sidebar");
      var toggle = document.getElementById("sidebar-toggle");
      var collapseIcon = document.getElementById("collapse-icon");
      if (!sidebar || !toggle) return;

      var STORAGE_KEY = "sidebar-collapsed";
      var labels = sidebar.querySelectorAll(".sidebar-label");

      function collapse() {
        sidebar.classList.remove("lg:w-60");
        sidebar.classList.add("lg:w-16");
        labels.forEach(function (el) {
          el.classList.add("lg:hidden");
        });
        if (collapseIcon) collapseIcon.style.transform = "rotate(180deg)";
        sidebar.setAttribute("data-collapsed", "true");
        localStorage.setItem(STORAGE_KEY, "true");
      }

      function expand() {
        sidebar.classList.remove("lg:w-16");
        sidebar.classList.add("lg:w-60");
        labels.forEach(function (el) {
          el.classList.remove("lg:hidden");
        });
        if (collapseIcon) collapseIcon.style.transform = "";
        sidebar.setAttribute("data-collapsed", "false");
        localStorage.setItem(STORAGE_KEY, "false");
      }

      // Restore state from localStorage
      var stored = localStorage.getItem(STORAGE_KEY);
      if (stored === "true") {
        collapse();
      } else if (stored === "false") {
        expand();
      }

      toggle.addEventListener("click", function () {
        var isCollapsed = sidebar.getAttribute("data-collapsed") === "true";
        if (isCollapsed) {
          expand();
        } else {
          collapse();
        }
      });

      // Cmd+B / Ctrl+B keyboard shortcut
      document.addEventListener("keydown", function (e) {
        if ((e.metaKey || e.ctrlKey) && e.key === "b") {
          e.preventDefault();
          toggle.click();
        }
      });
    })();
  </script>

  <!-- Theme toggle script -->
  <script is:inline>
    (function () {
      var themeToggle = document.getElementById("theme-toggle");
      var lightIcon = document.getElementById("theme-icon-light");
      var darkIcon = document.getElementById("theme-icon-dark");
      if (!themeToggle || !lightIcon || !darkIcon) return;

      function updateIcons() {
        var current = document.documentElement.getAttribute("data-theme");
        if (current === "dark") {
          lightIcon.classList.add("hidden");
          darkIcon.classList.remove("hidden");
        } else {
          lightIcon.classList.remove("hidden");
          darkIcon.classList.add("hidden");
        }
      }

      updateIcons();

      themeToggle.addEventListener("click", function () {
        var current = document.documentElement.getAttribute("data-theme");
        var next = current === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
        updateIcons();
      });
    })();
  </script>

  <!-- Search modal (Cmd+K) -->
  <script is:inline>
    (function () {
      var searchTrigger = document.getElementById("search-trigger");
      var modal = document.getElementById("search-modal");
      var input = document.getElementById("search-input");
      var resultsContainer = document.getElementById("search-results");
      var emptyState = document.getElementById("search-empty");
      if (!searchTrigger || !modal || !input || !resultsContainer) return;

      var STORAGE_KEY = "orbiter-recent-searches";
      var MAX_RECENT = 5;
      var debounceTimer = null;
      var selectedIdx = -1;
      var flatResults = []; // All selectable results in order

      /* ---- Type config ---- */
      var typeLabels = {
        agents: "Agents",
        workflows: "Workflows",
        tools: "Tools",
        knowledge_bases: "Knowledge Bases",
      };
      var typeIcons = {
        agents: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>',
        workflows: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="6" height="6" rx="1"/><rect x="15" y="3" width="6" height="6" rx="1"/><rect x="9" y="15" width="6" height="6" rx="1"/><path d="M6 9v3a1 1 0 0 0 1 1h4"/><path d="M18 9v3a1 1 0 0 1-1 1h-4"/><path d="M12 13v2"/></svg>',
        tools: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
        knowledge_bases: '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
      };

      /* ---- Recent searches (localStorage) ---- */
      function getRecent() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        } catch (_) {
          return [];
        }
      }

      function addRecent(query) {
        var q = query.trim();
        if (!q) return;
        var recent = getRecent().filter(function (r) { return r !== q; });
        recent.unshift(q);
        if (recent.length > MAX_RECENT) recent = recent.slice(0, MAX_RECENT);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(recent));
      }

      /* ---- Rendering ---- */
      function escapeHtml(s) {
        var div = document.createElement("div");
        div.textContent = s || "";
        return div.innerHTML;
      }

      function renderRecent() {
        var recent = getRecent();
        flatResults = [];
        selectedIdx = -1;

        if (recent.length === 0) {
          emptyState.textContent = "Start typing to search...";
          emptyState.classList.remove("hidden");
          // Remove everything except emptyState
          while (resultsContainer.firstChild && resultsContainer.firstChild !== emptyState) {
            resultsContainer.removeChild(resultsContainer.firstChild);
          }
          while (emptyState.nextSibling) {
            resultsContainer.removeChild(emptyState.nextSibling);
          }
          return;
        }

        var html = '<div class="px-2 py-1.5 text-[11px] font-semibold text-muted uppercase tracking-wide">Recent searches</div>';
        recent.forEach(function (q, i) {
          flatResults.push({ type: "recent", query: q });
          html += '<div class="search-result flex items-center gap-3 rounded-lg px-3 py-2 cursor-pointer hover:bg-dark/5 transition-colors" data-idx="' + i + '" data-recent="' + escapeHtml(q) + '">'
            + '<svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>'
            + '<span class="text-sm text-dark truncate">' + escapeHtml(q) + '</span>'
            + '</div>';
        });

        // Replace content but keep emptyState hidden
        emptyState.classList.add("hidden");
        // Remove all children except emptyState
        var children = Array.from(resultsContainer.children);
        children.forEach(function (c) {
          if (c !== emptyState) resultsContainer.removeChild(c);
        });
        // Insert before emptyState
        var wrapper = document.createElement("div");
        wrapper.innerHTML = html;
        while (wrapper.firstChild) {
          resultsContainer.insertBefore(wrapper.firstChild, emptyState);
        }
      }

      function renderResults(data) {
        flatResults = [];
        selectedIdx = -1;
        var hasAny = false;
        var html = "";
        var idx = 0;

        var typeOrder = ["agents", "workflows", "tools", "knowledge_bases"];
        typeOrder.forEach(function (type) {
          var items = data[type];
          if (!items || items.length === 0) return;
          hasAny = true;

          html += '<div class="px-2 py-1.5 text-[11px] font-semibold text-muted uppercase tracking-wide">' + escapeHtml(typeLabels[type] || type) + '</div>';

          items.forEach(function (item) {
            flatResults.push({ type: "result", url: item.url, name: item.name });
            var snippet = (item.snippet || "").replace(/<b>/g, '<mark class="bg-coral/20 text-dark rounded px-0.5">').replace(/<\/b>/g, "</mark>");
            if (snippet.length > 80) snippet = snippet.substring(0, 80) + "...";

            html += '<a class="search-result flex items-center gap-3 rounded-lg px-3 py-2 no-underline cursor-pointer hover:bg-dark/5 transition-colors" data-idx="' + idx + '" href="' + escapeHtml(item.url) + '">'
              + '<span class="shrink-0 text-muted">' + (typeIcons[type] || '') + '</span>'
              + '<div class="min-w-0 flex-1">'
              + '<div class="text-sm font-medium text-dark truncate">' + escapeHtml(item.name) + '</div>'
              + (snippet ? '<div class="text-xs text-muted truncate">' + snippet + '</div>' : '')
              + '</div>'
              + '</a>';
            idx++;
          });
        });

        emptyState.classList.add("hidden");
        var children = Array.from(resultsContainer.children);
        children.forEach(function (c) {
          if (c !== emptyState) resultsContainer.removeChild(c);
        });

        if (!hasAny) {
          emptyState.textContent = "No results found";
          emptyState.classList.remove("hidden");
          return;
        }

        var wrapper = document.createElement("div");
        wrapper.innerHTML = html;
        while (wrapper.firstChild) {
          resultsContainer.insertBefore(wrapper.firstChild, emptyState);
        }
      }

      function updateSelection() {
        var items = resultsContainer.querySelectorAll(".search-result");
        items.forEach(function (el, i) {
          if (i === selectedIdx) {
            el.classList.add("bg-dark/5");
            el.scrollIntoView({ block: "nearest" });
          } else {
            el.classList.remove("bg-dark/5");
          }
        });
      }

      /* ---- Search ---- */
      function doSearch(query) {
        if (!query.trim()) {
          renderRecent();
          return;
        }
        fetch("/api/v1/search?q=" + encodeURIComponent(query.trim()), { credentials: "same-origin" })
          .then(function (r) { return r.ok ? r.json() : {}; })
          .then(function (data) {
            // Only render if input still matches (debounce guard)
            if (input.value.trim() === query.trim()) {
              renderResults(data);
            }
          })
          .catch(function () {
            renderResults({});
          });
      }

      /* ---- Event handlers ---- */
      function openModal() {
        modal.showModal();
        input.value = "";
        renderRecent();
        input.focus();
      }

      function closeModal() {
        modal.close();
        if (debounceTimer) clearTimeout(debounceTimer);
      }

      searchTrigger.addEventListener("click", openModal);

      // Cmd+K / Ctrl+K
      document.addEventListener("keydown", function (e) {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
          e.preventDefault();
          if (modal.open) {
            closeModal();
          } else {
            openModal();
          }
        }
      });

      // Close on backdrop click
      modal.addEventListener("click", function (e) {
        if (e.target === modal) closeModal();
      });

      // Debounced input
      input.addEventListener("input", function () {
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function () {
          doSearch(input.value);
        }, 300);
      });

      // Keyboard navigation
      input.addEventListener("keydown", function (e) {
        var items = resultsContainer.querySelectorAll(".search-result");
        var count = items.length;

        if (e.key === "ArrowDown") {
          e.preventDefault();
          selectedIdx = selectedIdx < count - 1 ? selectedIdx + 1 : 0;
          updateSelection();
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          selectedIdx = selectedIdx > 0 ? selectedIdx - 1 : count - 1;
          updateSelection();
        } else if (e.key === "Enter") {
          e.preventDefault();
          if (selectedIdx >= 0 && selectedIdx < flatResults.length) {
            var selected = flatResults[selectedIdx];
            if (selected.type === "recent") {
              // Fill input with recent search and re-search
              input.value = selected.query;
              doSearch(selected.query);
              addRecent(selected.query);
            } else if (selected.url) {
              addRecent(input.value.trim());
              closeModal();
              window.location.href = selected.url;
            }
          }
        }
      });

      // Click handlers for results (delegated)
      resultsContainer.addEventListener("click", function (e) {
        // Recent search click
        var recentEl = e.target.closest("[data-recent]");
        if (recentEl) {
          var q = recentEl.getAttribute("data-recent");
          input.value = q;
          doSearch(q);
          addRecent(q);
          return;
        }
        // Result link click — save search
        var linkEl = e.target.closest("a.search-result");
        if (linkEl && input.value.trim()) {
          addRecent(input.value.trim());
        }
      });
    })();
  </script>

  <!-- Mobile menu script -->
  <script is:inline>
    (function () {
      var overlay = document.getElementById("mobile-menu-overlay");
      var panel = document.getElementById("mobile-menu-panel");
      var menuToggle = document.getElementById("mobile-menu-toggle");
      var menuClose = document.getElementById("mobile-menu-close");
      var backdrop = document.getElementById("mobile-menu-backdrop");
      if (!overlay || !panel || !menuToggle) return;

      function openMenu() {
        overlay.classList.remove("hidden");
        // Trigger reflow before animating
        void panel.offsetWidth;
        panel.style.transform = "translateX(0)";
      }

      function closeMenu() {
        panel.style.transform = "translateX(-100%)";
        setTimeout(function () {
          overlay.classList.add("hidden");
        }, 200);
      }

      menuToggle.addEventListener("click", openMenu);
      if (menuClose) menuClose.addEventListener("click", closeMenu);
      if (backdrop) backdrop.addEventListener("click", closeMenu);

      // Close on Escape
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && !overlay.classList.contains("hidden")) {
          closeMenu();
        }
      });
    })();
  </script>

  <!-- Global budget check -->
  <script is:inline>
    (function () {
      fetch("/api/v1/costs/budget-check", { credentials: "same-origin" })
        .then(function (res) { return res.ok ? res.json() : null; })
        .then(function (data) {
          if (!data) return;
          var banner = document.getElementById("global-budget-banner");
          var text = document.getElementById("global-budget-text");
          if (!banner || !text) return;

          function fc(n) { return "$" + (n < 0.01 ? n.toFixed(4) : n.toFixed(2)); }

          if (data.status === "exceeded") {
            banner.className = "mx-4 mt-4 rounded-xl border border-coral/30 bg-coral/5 text-coral px-5 py-3";
            text.textContent = "Budget exceeded — spent " + fc(data.spent) + " of " + fc(data.budget_amount) + " (" + data.percent_used.toFixed(0) + "%)";
          } else if (data.status === "warning") {
            banner.className = "mx-4 mt-4 rounded-xl border border-amber-400/30 bg-amber-50 text-amber-800 px-5 py-3";
            text.textContent = "Approaching budget — spent " + fc(data.spent) + " of " + fc(data.budget_amount) + " (" + data.percent_used.toFixed(0) + "%)";
          }
        })
        .catch(function () {});
    })();
  </script>

  <!-- Search modal (Cmd+K) -->
  <dialog id="search-modal" class="backdrop:bg-dark/40 rounded-xl border border-dark/[0.08] bg-paper shadow-xl p-0 w-full max-w-lg mt-[15vh]">
    <div class="flex flex-col max-h-[60vh]">
      <!-- Search input -->
      <div class="flex items-center gap-3 border-b border-dark/[0.08] px-4 py-3">
        <svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input
          id="search-input"
          type="text"
          placeholder="Search agents, workflows, tools..."
          class="flex-1 bg-transparent text-sm text-dark placeholder-muted/60 outline-none"
          autocomplete="off"
          spellcheck="false"
        />
        <kbd class="hidden sm:inline-flex items-center rounded border border-dark/[0.08] bg-subtle/50 px-1.5 py-0.5 text-[10px] font-medium text-muted">
          esc
        </kbd>
      </div>

      <!-- Results container -->
      <div id="search-results" class="overflow-y-auto px-2 py-2" style="max-height: calc(60vh - 52px);">
        <div id="search-empty" class="px-3 py-8 text-center text-sm text-muted">
          Start typing to search...
        </div>
      </div>
    </div>
  </dialog>

  <!-- Approval gate modal -->
  <dialog id="approval-modal" class="backdrop:bg-dark/40 rounded-xl border border-dark/[0.08] bg-paper shadow-xl p-0 w-full max-w-md">
    <div class="p-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-amber-100 text-amber-600">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 11 14 15 10"/></svg>
        </div>
        <div>
          <h3 class="text-sm font-semibold text-dark">Approval Required</h3>
          <p id="approval-modal-node" class="text-xs text-muted"></p>
        </div>
      </div>

      <div id="approval-modal-context" class="mb-4 rounded-lg bg-subtle/50 border border-dark/[0.06] p-3 text-xs text-muted hidden">
      </div>

      <div class="mb-4">
        <label for="approval-comment" class="block text-[11px] font-semibold text-muted uppercase tracking-wide mb-1">Comment</label>
        <textarea id="approval-comment" rows="3" placeholder="Optional for approve, required for reject..." class="w-full rounded-lg border border-dark/[0.08] bg-paper px-3 py-2 text-sm text-dark placeholder-muted/60 outline-none focus:border-coral transition-colors resize-none"></textarea>
      </div>

      <div class="flex items-center gap-2 justify-end">
        <button id="approval-reject-btn" class="rounded-lg border border-dark/[0.08] px-4 py-2 text-sm font-medium text-muted hover:bg-dark/5 transition-colors cursor-pointer">Reject</button>
        <button id="approval-approve-btn" class="rounded-lg bg-zen-green px-4 py-2 text-sm font-semibold text-dark hover:opacity-90 transition-opacity cursor-pointer">Approve</button>
      </div>
    </div>
  </dialog>

  <!-- Approval notification badge + modal script -->
  <script is:inline>
    (function () {
      var bell = document.getElementById("approvals-bell");
      var badge = document.getElementById("approvals-badge");
      var modal = document.getElementById("approval-modal");
      var modalNode = document.getElementById("approval-modal-node");
      var modalContext = document.getElementById("approval-modal-context");
      var commentEl = document.getElementById("approval-comment");
      var approveBtn = document.getElementById("approval-approve-btn");
      var rejectBtn = document.getElementById("approval-reject-btn");
      if (!bell || !badge || !modal) return;

      var pendingApprovals = [];
      var currentApprovalIdx = 0;

      function updateBadge(count) {
        if (count > 0) {
          badge.textContent = count > 99 ? "99+" : String(count);
          badge.classList.remove("hidden");
          badge.classList.add("flex");
        } else {
          badge.classList.add("hidden");
          badge.classList.remove("flex");
        }
      }

      function fetchPending() {
        fetch("/api/v1/approvals/pending?limit=20", { credentials: "same-origin" })
          .then(function (r) { return r.ok ? r.json() : []; })
          .then(function (data) {
            pendingApprovals = data || [];
            updateBadge(pendingApprovals.length);
          })
          .catch(function () {});
      }

      function showApproval(idx) {
        if (idx >= pendingApprovals.length) {
          modal.close();
          return;
        }
        currentApprovalIdx = idx;
        var a = pendingApprovals[idx];
        modalNode.textContent = "Node: " + a.node_id + " | Run: " + a.run_id.slice(0, 8) + "...";
        if (a.approval_message) {
          modalContext.textContent = a.approval_message;
          modalContext.classList.remove("hidden");
        } else {
          modalContext.classList.add("hidden");
        }
        commentEl.value = "";
        modal.showModal();
      }

      function respondToApproval(approved) {
        var a = pendingApprovals[currentApprovalIdx];
        if (!a) return;
        var comment = commentEl.value.trim();
        if (!approved && !comment) {
          commentEl.style.borderColor = "#F76F53";
          commentEl.setAttribute("placeholder", "Comment required for rejection");
          commentEl.focus();
          return;
        }
        var body = { approved: approved };
        if (comment) body.comment = comment;

        fetch("/api/v1/approvals/" + a.id + "/respond", {
          method: "POST",
          credentials: "same-origin",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        })
          .then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw new Error(d.detail || "Failed"); });
            // Remove from list and show next or close
            pendingApprovals.splice(currentApprovalIdx, 1);
            updateBadge(pendingApprovals.length);
            if (pendingApprovals.length > 0) {
              showApproval(0);
            } else {
              modal.close();
            }
          })
          .catch(function (err) {
            alert("Error: " + err.message);
          });
      }

      bell.addEventListener("click", function () {
        if (pendingApprovals.length > 0) {
          showApproval(0);
        }
      });

      if (approveBtn) approveBtn.addEventListener("click", function () { respondToApproval(true); });
      if (rejectBtn) rejectBtn.addEventListener("click", function () { respondToApproval(false); });

      // Close on backdrop click
      modal.addEventListener("click", function (e) {
        if (e.target === modal) modal.close();
      });

      // Reset comment border on focus
      if (commentEl) commentEl.addEventListener("focus", function () {
        commentEl.style.borderColor = "";
      });

      // Initial fetch + poll every 30s
      fetchPending();
      setInterval(fetchPending, 30000);
    })();
  </script>

  <!-- Notifications bell + dropdown script -->
  <script is:inline>
    (function () {
      var bell = document.getElementById("notif-bell");
      var badge = document.getElementById("notif-badge");
      var dropdown = document.getElementById("notif-dropdown");
      var container = document.getElementById("notif-container");
      var listEl = document.getElementById("notif-list");
      var emptyEl = document.getElementById("notif-empty");
      var markAllBtn = document.getElementById("notif-mark-all");
      if (!bell || !badge || !dropdown || !listEl) return;

      var notifications = [];
      var unreadCount = 0;
      var isOpen = false;

      /* --- Type icons --- */
      var typeIcons = {
        approval: '<svg class="h-4 w-4 text-amber-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
        alert: '<svg class="h-4 w-4 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
        budget: '<svg class="h-4 w-4 text-zen-green" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
        info: '<svg class="h-4 w-4 text-zen-blue" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
      };
      var defaultIcon = typeIcons.info;

      /* --- Entity navigation URLs --- */
      function entityUrl(entityType, entityId) {
        if (!entityType || !entityId) return null;
        var map = {
          agent: "/agents/" + entityId,
          workflow: "/workflows/" + entityId + "/canvas",
          project: "/projects/" + entityId,
          knowledge_base: "/knowledge/" + entityId,
          tool: "/tools",
          run: "/monitoring"
        };
        return map[entityType] || null;
      }

      /* --- Time ago helper --- */
      function timeAgo(dateStr) {
        var now = new Date();
        var d = new Date(dateStr + (dateStr.indexOf("Z") === -1 ? "Z" : ""));
        var sec = Math.floor((now - d) / 1000);
        if (sec < 60) return "just now";
        var min = Math.floor(sec / 60);
        if (min < 60) return min + "m ago";
        var hr = Math.floor(min / 60);
        if (hr < 24) return hr + "h ago";
        var day = Math.floor(hr / 24);
        if (day < 7) return day + "d ago";
        return d.toLocaleDateString();
      }

      /* --- Badge --- */
      function updateBadge() {
        if (unreadCount > 0) {
          badge.textContent = unreadCount > 99 ? "99+" : String(unreadCount);
          badge.classList.remove("hidden");
          badge.classList.add("flex");
        } else {
          badge.classList.add("hidden");
          badge.classList.remove("flex");
        }
      }

      /* --- Render list --- */
      function renderList() {
        if (notifications.length === 0) {
          emptyEl.classList.remove("hidden");
          // Remove items but keep emptyEl
          var children = Array.from(listEl.children);
          children.forEach(function (c) { if (c !== emptyEl) listEl.removeChild(c); });
          return;
        }
        emptyEl.classList.add("hidden");
        var children = Array.from(listEl.children);
        children.forEach(function (c) { if (c !== emptyEl) listEl.removeChild(c); });

        notifications.forEach(function (n) {
          var icon = typeIcons[n.type] || defaultIcon;
          var url = entityUrl(n.entity_type, n.entity_id);
          var tag = url ? "a" : "div";
          var item = document.createElement(tag);
          item.className = "flex items-start gap-3 px-4 py-3 border-b border-dark/[0.04] cursor-pointer transition-colors hover:bg-dark/[0.03]"
            + (n.read ? "" : " bg-coral/[0.04]");
          if (url) item.setAttribute("href", url);
          item.setAttribute("data-notif-id", n.id);
          item.innerHTML =
            '<div class="shrink-0 mt-0.5">' + icon + '</div>'
            + '<div class="flex-1 min-w-0">'
            + '<div class="flex items-center gap-2">'
            + '<span class="text-sm font-medium text-dark truncate' + (n.read ? '' : ' font-semibold') + '">' + escapeHtml(n.title) + '</span>'
            + (n.read ? '' : '<span class="shrink-0 w-2 h-2 rounded-full bg-coral"></span>')
            + '</div>'
            + '<p class="text-xs text-muted truncate mt-0.5">' + escapeHtml(n.message) + '</p>'
            + '<span class="text-[11px] text-muted/60 mt-0.5 block">' + timeAgo(n.created_at) + '</span>'
            + '</div>';
          listEl.insertBefore(item, emptyEl);
        });
      }

      function escapeHtml(s) {
        var d = document.createElement("div");
        d.textContent = s || "";
        return d.innerHTML;
      }

      /* --- Fetch notifications --- */
      function fetchNotifications() {
        fetch("/api/v1/notifications?limit=20", { credentials: "same-origin" })
          .then(function (r) { return r.ok ? r.json() : { data: [] }; })
          .then(function (body) {
            notifications = (body.data || body || []).map(function (n) {
              n.read = !!n.read;
              return n;
            });
            renderList();
          })
          .catch(function () {});
      }

      function fetchUnreadCount() {
        fetch("/api/v1/notifications/unread-count", { credentials: "same-origin" })
          .then(function (r) { return r.ok ? r.json() : { count: 0 }; })
          .then(function (data) {
            unreadCount = data.count || 0;
            updateBadge();
          })
          .catch(function () {});
      }

      /* --- Toggle dropdown --- */
      function openDropdown() {
        dropdown.classList.remove("hidden");
        isOpen = true;
        fetchNotifications();
      }

      function closeDropdown() {
        dropdown.classList.add("hidden");
        isOpen = false;
      }

      bell.addEventListener("click", function (e) {
        e.stopPropagation();
        if (isOpen) {
          closeDropdown();
        } else {
          openDropdown();
        }
      });

      // Close on outside click
      document.addEventListener("click", function (e) {
        if (isOpen && container && !container.contains(e.target)) {
          closeDropdown();
        }
      });

      // Close on Escape
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && isOpen) closeDropdown();
      });

      /* --- Click notification: navigate + mark read --- */
      listEl.addEventListener("click", function (e) {
        var item = e.target.closest("[data-notif-id]");
        if (!item) return;
        var notifId = item.getAttribute("data-notif-id");
        // Mark as read
        fetch("/api/v1/notifications/" + notifId + "/read", {
          method: "PUT",
          credentials: "same-origin"
        }).then(function () {
          // Update local state
          for (var i = 0; i < notifications.length; i++) {
            if (notifications[i].id === notifId && !notifications[i].read) {
              notifications[i].read = true;
              unreadCount = Math.max(0, unreadCount - 1);
              break;
            }
          }
          updateBadge();
          renderList();
        }).catch(function () {});

        // Navigate if <a> tag — browser handles it
        // For non-link items, just mark as read
      });

      /* --- Mark all as read --- */
      if (markAllBtn) {
        markAllBtn.addEventListener("click", function () {
          fetch("/api/v1/notifications/read-all", {
            method: "POST",
            credentials: "same-origin"
          }).then(function () {
            notifications.forEach(function (n) { n.read = true; });
            unreadCount = 0;
            updateBadge();
            renderList();
          }).catch(function () {});
        });
      }

      /* --- WebSocket real-time updates --- */
      var _wsHasConnected = false;
      var _wsBannerTimeout = null;

      function setupWebSocket() {
        // Don't attempt WS on login/auth pages
        var path = window.location.pathname;
        if (path === "/login" || path === "/reset-password" || path === "/register") return;

        try {
          var proto = window.location.protocol === "https:" ? "wss:" : "ws:";
          var wsUrl = proto + "//" + window.location.host + "/api/v1/ws";
          var ws = new WebSocket(wsUrl);
          var banner = document.getElementById("connection-banner");
          var bannerText = document.getElementById("connection-banner-text");

          function showBanner(msg) {
            if (banner && bannerText) {
              bannerText.textContent = msg;
              banner.classList.remove("hidden");
            }
          }

          function showBannerDelayed(msg) {
            // Only show after a successful connection has dropped, with a delay
            // to avoid flashing during page transitions
            if (!_wsHasConnected) return;
            clearTimeout(_wsBannerTimeout);
            _wsBannerTimeout = setTimeout(function () {
              showBanner(msg);
            }, 2000);
          }

          function hideBanner() {
            clearTimeout(_wsBannerTimeout);
            if (banner) banner.classList.add("hidden");
          }

          ws.addEventListener("open", function () {
            _wsHasConnected = true;
            hideBanner();
            ws.send(JSON.stringify({ type: "subscribe", channel: "notifications" }));
          });

          ws.addEventListener("message", function (event) {
            try {
              var msg = JSON.parse(event.data);

              // Handle auth_error from server (session expired over WS).
              if (msg.type === "auth_error" || (msg.channel === "system" && msg.type === "auth_error")) {
                showBanner("Session expired. Redirecting to login...");
                if (window.__orbiterExpireSession) window.__orbiterExpireSession();
                return;
              }

              if (msg.channel === "notifications" && msg.type === "notification_created") {
                var p = msg.payload || msg;
                var newNotif = {
                  id: p.id,
                  type: p.notification_type || p.type,
                  title: p.title,
                  message: p.message,
                  entity_type: p.entity_type,
                  entity_id: p.entity_id,
                  read: false,
                  created_at: p.created_at
                };
                notifications.unshift(newNotif);
                if (notifications.length > 20) notifications = notifications.slice(0, 20);
                unreadCount++;
                updateBadge();
                if (isOpen) renderList();
              }
            } catch (_) {}
          });

          ws.addEventListener("close", function (event) {
            // Close codes 4401/4403 = auth failure → expire session.
            if (event.code === 4401 || event.code === 4403) {
              showBanner("Session expired. Redirecting to login...");
              if (window.__orbiterExpireSession) window.__orbiterExpireSession();
              return;
            }

            // Only show reconnecting banner if WS had previously connected
            showBannerDelayed("Connection lost. Reconnecting...");
            setTimeout(function () {
              setupWebSocket();
            }, 5000);
          });

          ws.addEventListener("error", function () {
            ws.close();
          });
        } catch (_) {
          // WebSocket not available, fall back to polling
        }
      }

      /* --- Init --- */
      fetchUnreadCount();
      setupWebSocket();
      // Poll unread count as fallback every 30s
      setInterval(fetchUnreadCount, 30000);
    })();
  </script>

  <!-- Keyboard shortcuts reference panel (Cmd+/) -->
  <dialog id="shortcuts-modal" class="backdrop:bg-dark/40 rounded-xl border border-dark/[0.08] bg-paper shadow-xl p-0 w-full max-w-md mt-[10vh]">
    <div class="flex flex-col max-h-[70vh]">
      <div class="flex items-center justify-between border-b border-dark/[0.08] px-5 py-3.5">
        <h2 class="text-sm font-semibold text-dark">Keyboard Shortcuts</h2>
        <button id="shortcuts-close" class="flex items-center justify-center rounded-lg p-1 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="overflow-y-auto p-5 space-y-5">
        <!-- General -->
        <div>
          <h3 class="text-[11px] font-semibold text-muted uppercase tracking-wide mb-2">General</h3>
          <div class="space-y-1.5">
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Search</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted"><span class="text-xs">&#8984;</span>K</kbd>
            </div>
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Toggle sidebar</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted"><span class="text-xs">&#8984;</span>B</kbd>
            </div>
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Keyboard shortcuts</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted"><span class="text-xs">&#8984;</span>/</kbd>
            </div>
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Toggle theme</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted"><span class="text-xs">&#8984;</span>Shift+T</kbd>
            </div>
          </div>
        </div>
        <!-- Navigation -->
        <div>
          <h3 class="text-[11px] font-semibold text-muted uppercase tracking-wide mb-2">Navigation</h3>
          <div class="space-y-1.5">
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Go to Projects</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted">G then P</kbd>
            </div>
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Go to Agents</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted">G then A</kbd>
            </div>
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Go to Workflows</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted">G then W</kbd>
            </div>
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Go to Playground</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted">G then L</kbd>
            </div>
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Go to Docs</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted">G then D</kbd>
            </div>
          </div>
        </div>
        <!-- Workflow Canvas -->
        <div>
          <h3 class="text-[11px] font-semibold text-muted uppercase tracking-wide mb-2">Workflow Canvas</h3>
          <div class="space-y-1.5">
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Run workflow</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted"><span class="text-xs">&#8984;</span>Enter</kbd>
            </div>
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Debug mode</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted">F5</kbd>
            </div>
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Step over</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted">F10</kbd>
            </div>
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Continue</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted">F8</kbd>
            </div>
            <div class="flex items-center justify-between py-1">
              <span class="text-sm text-dark">Toggle variable panel</span>
              <kbd class="inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-2 py-0.5 text-xs font-medium text-muted"><span class="text-xs">&#8984;</span>J</kbd>
            </div>
          </div>
        </div>
      </div>
      <div class="border-t border-dark/[0.08] px-5 py-3 text-center">
        <a href="/docs" class="text-xs text-coral hover:underline no-underline">View full documentation</a>
      </div>
    </div>
  </dialog>

  <!-- Keyboard shortcuts panel script (Cmd+/) -->
  <script is:inline>
    (function () {
      var modal = document.getElementById("shortcuts-modal");
      var closeBtn = document.getElementById("shortcuts-close");
      if (!modal) return;

      function openShortcuts() {
        modal.showModal();
      }

      function closeShortcuts() {
        modal.close();
      }

      // Cmd+/ or Ctrl+/ to toggle
      document.addEventListener("keydown", function (e) {
        if ((e.metaKey || e.ctrlKey) && e.key === "/") {
          e.preventDefault();
          if (modal.open) {
            closeShortcuts();
          } else {
            openShortcuts();
          }
        }
      });

      if (closeBtn) closeBtn.addEventListener("click", closeShortcuts);

      // Close on backdrop click
      modal.addEventListener("click", function (e) {
        if (e.target === modal) closeShortcuts();
      });

      /* ---- "G then X" navigation shortcuts ---- */
      var gPressed = false;
      var gTimer = null;
      var gRoutes = {
        p: "/projects",
        a: "/agents",
        w: "/workflows",
        l: "/playground",
        d: "/docs",
      };

      document.addEventListener("keydown", function (e) {
        // Don't trigger inside inputs/textareas
        var tag = (e.target.tagName || "").toLowerCase();
        if (tag === "input" || tag === "textarea" || tag === "select" || e.target.isContentEditable) return;
        if (e.metaKey || e.ctrlKey || e.altKey) return;

        if (e.key === "g" && !gPressed) {
          gPressed = true;
          if (gTimer) clearTimeout(gTimer);
          gTimer = setTimeout(function () { gPressed = false; }, 1000);
          return;
        }

        if (gPressed) {
          gPressed = false;
          if (gTimer) clearTimeout(gTimer);
          var route = gRoutes[e.key];
          if (route) {
            e.preventDefault();
            window.location.href = route;
          }
        }
      });
    })();
  </script>

  <!-- Help panel (slide-out from right) -->
  <div id="help-panel-overlay" class="fixed inset-0 z-[80] hidden">
    <div id="help-panel-backdrop" class="absolute inset-0 bg-dark/40 backdrop-blur-sm"></div>
    <aside
      id="help-panel"
      class="absolute top-0 right-0 bottom-0 w-80 sm:w-96 bg-paper shadow-xl flex flex-col"
      style="transform: translateX(100%); transition: transform 200ms ease-out;"
    >
      <div class="flex h-14 items-center justify-between border-b border-dark/[0.08] px-4">
        <div class="flex items-center gap-2">
          <svg class="h-5 w-5 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          <span class="text-sm font-semibold text-dark">Help</span>
        </div>
        <button
          id="help-panel-close"
          class="flex items-center justify-center rounded-lg p-1.5 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
        >
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>

      <!-- Search within help -->
      <div class="border-b border-dark/[0.08] px-4 py-3">
        <div class="flex items-center gap-2 rounded-lg border border-dark/[0.08] bg-subtle/30 px-3 py-2">
          <svg class="h-3.5 w-3.5 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input
            id="help-search-input"
            type="text"
            placeholder="Search help..."
            class="flex-1 bg-transparent text-xs text-dark placeholder-muted/60 outline-none"
            autocomplete="off"
          />
        </div>
      </div>

      <!-- Help links -->
      <div id="help-panel-content" class="flex-1 overflow-y-auto py-3 px-3 space-y-4">
        <!-- Quick actions -->
        <div>
          <h3 class="text-[11px] font-semibold text-muted uppercase tracking-wide px-2 mb-1.5">Quick Actions</h3>
          <div class="space-y-0.5">
            <a href="/docs/getting-started" class="help-link flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-dark hover:bg-dark/5 transition-colors no-underline" data-keywords="getting started first agent tutorial">
              <svg class="h-4 w-4 shrink-0 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 4 0 4 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-4 0-4"/></svg>
              Getting Started Guide
            </a>
            <button id="help-open-shortcuts" class="help-link w-full flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-dark hover:bg-dark/5 transition-colors cursor-pointer text-left" data-keywords="keyboard shortcuts hotkeys keybindings">
              <svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.001"/><path d="M10 8h.001"/><path d="M14 8h.001"/><path d="M18 8h.001"/><path d="M6 12h.001"/><path d="M10 12h.001"/><path d="M14 12h.001"/><path d="M18 12h.001"/><path d="M8 16h8"/></svg>
              Keyboard Shortcuts
              <span class="ml-auto text-[10px] text-muted">&#8984;/</span>
            </button>
          </div>
        </div>

        <!-- Documentation sections -->
        <div>
          <h3 class="text-[11px] font-semibold text-muted uppercase tracking-wide px-2 mb-1.5">Documentation</h3>
          <div class="space-y-0.5">
            <a href="/docs/agents" class="help-link flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-dark hover:bg-dark/5 transition-colors no-underline" data-keywords="agents models prompts tools multi-agent">
              <svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/></svg>
              Agents
            </a>
            <a href="/docs/workflows" class="help-link flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-dark hover:bg-dark/5 transition-colors no-underline" data-keywords="workflows canvas nodes edges automation">
              <svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="6" height="6" rx="1"/><rect x="15" y="3" width="6" height="6" rx="1"/><rect x="9" y="15" width="6" height="6" rx="1"/><path d="M6 9v3a1 1 0 0 0 1 1h4"/><path d="M18 9v3a1 1 0 0 1-1 1h-4"/><path d="M12 13v2"/></svg>
              Workflows
            </a>
            <a href="/docs/tools" class="help-link flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-dark hover:bg-dark/5 transition-colors no-underline" data-keywords="tools functions custom built-in schema">
              <svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
              Tools
            </a>
            <a href="/docs/knowledge-base" class="help-link flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-dark hover:bg-dark/5 transition-colors no-underline" data-keywords="knowledge base documents rag retrieval upload">
              <svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
              Knowledge Base
            </a>
            <a href="/docs/monitoring" class="help-link flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-dark hover:bg-dark/5 transition-colors no-underline" data-keywords="monitoring runs costs metrics alerts logs">
              <svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
              Monitoring
            </a>
            <a href="/docs/deployments" class="help-link flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-dark hover:bg-dark/5 transition-colors no-underline" data-keywords="deployments api widget embed endpoint">
              <svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/></svg>
              Deployments
            </a>
            <a href="/docs/api-reference" class="help-link flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-dark hover:bg-dark/5 transition-colors no-underline" data-keywords="api reference rest endpoints http">
              <svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
              API Reference
            </a>
            <a href="/docs" class="help-link flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-dark hover:bg-dark/5 transition-colors no-underline" data-keywords="swagger openapi interactive try endpoints">
              <svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
              Interactive API Docs (Swagger)
            </a>
            <a href="/redoc" class="help-link flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-dark hover:bg-dark/5 transition-colors no-underline" data-keywords="redoc api documentation reference">
              <svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
              API Docs (ReDoc)
            </a>
          </div>
        </div>

        <!-- Contextual help -->
        <div>
          <h3 class="text-[11px] font-semibold text-muted uppercase tracking-wide px-2 mb-1.5">Help</h3>
          <div class="space-y-0.5">
            <a href="/docs" class="help-link flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-dark hover:bg-dark/5 transition-colors no-underline" data-keywords="all documentation browse">
              <svg class="h-4 w-4 shrink-0 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
              Browse all docs
            </a>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Help panel script -->
  <script is:inline>
    (function () {
      var overlay = document.getElementById("help-panel-overlay");
      var panel = document.getElementById("help-panel");
      var closeBtn = document.getElementById("help-panel-close");
      var backdrop = document.getElementById("help-panel-backdrop");
      var searchInput = document.getElementById("help-search-input");
      var shortcutsBtn = document.getElementById("help-open-shortcuts");
      var shortcutsModal = document.getElementById("shortcuts-modal");
      if (!overlay || !panel) return;

      var links = overlay.querySelectorAll(".help-link");

      function openHelp() {
        overlay.classList.remove("hidden");
        void panel.offsetWidth;
        panel.style.transform = "translateX(0)";
        if (searchInput) searchInput.focus();
      }

      function closeHelp() {
        panel.style.transform = "translateX(100%)";
        setTimeout(function () {
          overlay.classList.add("hidden");
        }, 200);
      }

      if (closeBtn) closeBtn.addEventListener("click", closeHelp);
      if (backdrop) backdrop.addEventListener("click", closeHelp);

      // Esc to close help panel
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && !overlay.classList.contains("hidden")) {
          closeHelp();
        }
      });

      // Open shortcuts from help panel
      if (shortcutsBtn && shortcutsModal) {
        shortcutsBtn.addEventListener("click", function () {
          closeHelp();
          setTimeout(function () {
            shortcutsModal.showModal();
          }, 220);
        });
      }

      // Filter help links by search
      if (searchInput) {
        searchInput.addEventListener("input", function () {
          var q = searchInput.value.toLowerCase().trim();
          links.forEach(function (link) {
            if (!q) {
              link.classList.remove("hidden");
              return;
            }
            var text = (link.textContent || "").toLowerCase();
            var keywords = (link.getAttribute("data-keywords") || "").toLowerCase();
            var matches = text.indexOf(q) !== -1 || keywords.indexOf(q) !== -1;
            link.classList.toggle("hidden", !matches);
          });
        });
      }

      // Wire the help trigger button
      var helpTrigger = document.getElementById("help-trigger");
      if (helpTrigger) {
        helpTrigger.addEventListener("click", function () {
          if (overlay.classList.contains("hidden")) {
            openHelp();
          } else {
            closeHelp();
          }
        });
      }

      // Make help panel openable via a global function
      window.__orbiterOpenHelp = openHelp;
    })();
  </script>

  <!-- Onboarding tour (auto-triggers for first-time users) -->
  <OnboardingTour />
</BaseLayout>
