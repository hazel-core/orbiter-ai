---
import BaseLayout from "./BaseLayout.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import { cn } from "../utils/merge";

interface BreadcrumbItem {
  label: string;
  href?: string;
}

interface Props {
  title?: string;
  description?: string;
  activeSection?: string;
  breadcrumbs?: BreadcrumbItem[];
  projectName?: string;
  class?: string;
}

const {
  title,
  description,
  activeSection,
  breadcrumbs = [],
  projectName = "Orbiter",
  class: className,
} = Astro.props;

const navSections = [
  { id: "projects", label: "Projects", href: "/projects", icon: "folder" },
  { id: "agents", label: "Agents", href: "/agents", icon: "bot" },
  { id: "workflows", label: "Workflows", href: "/workflows", icon: "workflow" },
  { id: "playground", label: "Playground", href: "/playground", icon: "play" },
  { id: "tools", label: "Tools", href: "/tools", icon: "wrench" },
  { id: "models", label: "Models", href: "/models", icon: "cube" },
  { id: "knowledge", label: "Knowledge Base", href: "/knowledge", icon: "book" },
  { id: "monitoring", label: "Monitoring", href: "/monitoring", icon: "chart" },
  { id: "plugins", label: "Plugins", href: "/plugins", icon: "puzzle" },
  { id: "settings", label: "Settings", href: "/settings", icon: "gear" },
];

/* Key sections shown in the mobile bottom tab bar */
const mobileTabSections = navSections.filter((s) =>
  ["projects", "agents", "workflows", "playground", "settings"].includes(s.id)
);

const icons: Record<string, string> = {
  folder: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
  bot: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>',
  workflow: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="6" height="6" rx="1"/><rect x="15" y="3" width="6" height="6" rx="1"/><rect x="9" y="15" width="6" height="6" rx="1"/><path d="M6 9v3a1 1 0 0 0 1 1h4"/><path d="M18 9v3a1 1 0 0 1-1 1h-4"/><path d="M12 13v2"/></svg>',
  play: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
  wrench: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
  cube: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
  book: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
  chart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
  puzzle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19.439 7.85c-.049.322.059.648.289.878l1.568 1.568c.47.47.706 1.087.706 1.704s-.235 1.233-.706 1.704l-1.611 1.611a.98.98 0 0 1-.837.276c-.47-.07-.802-.48-.968-.925a2.501 2.501 0 1 0-3.214 3.214c.446.166.855.497.925.968a.979.979 0 0 1-.276.837l-1.61 1.61a2.404 2.404 0 0 1-1.705.707 2.402 2.402 0 0 1-1.704-.706l-1.568-1.568a1.026 1.026 0 0 0-.877-.29c-.493.074-.84.504-1.02.968a2.5 2.5 0 1 1-3.237-3.237c.464-.18.894-.527.967-1.02a1.026 1.026 0 0 0-.289-.877l-1.568-1.568A2.402 2.402 0 0 1 1.998 12c0-.617.236-1.234.706-1.704L4.315 8.685a.98.98 0 0 1 .837-.276c.47.07.802.48.968.925a2.501 2.501 0 1 0 3.214-3.214c-.446-.166-.855-.497-.925-.968a.979.979 0 0 1 .276-.837l1.61-1.61a2.404 2.404 0 0 1 1.705-.707c.618 0 1.234.236 1.704.706l1.568 1.568c.23.23.556.338.877.29.493-.074.84-.504 1.02-.968a2.5 2.5 0 1 1 3.237 3.237c-.464.18-.894.527-.967 1.02z"/></svg>',
  gear: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
};

function getIcon(name: string): string {
  return icons[name] || "";
}

/* Top bar icon SVGs */
const searchIcon = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
const sunIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
const moonIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
const userIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
const hamburgerIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>';
const closeIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
const bellIcon = '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>';
---

<BaseLayout title={title} description={description}>
  <div class="flex h-screen overflow-hidden">
    <!-- Desktop sidebar (hidden on < md) -->
    <aside
      id="sidebar"
      class="hidden md:flex flex-col border-r border-dark/[0.08] bg-paper transition-all duration-300 lg:w-60 w-16"
      data-collapsed="true"
    >
      <!-- Logo / Brand -->
      <div class="flex h-14 items-center border-b border-dark/[0.08] px-4 overflow-hidden">
        <div class="flex items-center gap-3 min-w-0">
          <svg class="h-7 w-7 shrink-0 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" />
            <path d="M2 12h20" />
          </svg>
          <span class="font-semibold text-dark text-sm whitespace-nowrap sidebar-label hidden lg:block">
            Orbiter
          </span>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 overflow-y-auto py-3 px-2 space-y-1">
        {navSections.map((section) => {
          const isActive = activeSection === section.id;
          return (
            <a
              href={section.href}
              class={cn(
                "flex items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium transition-colors duration-150",
                isActive
                  ? "bg-coral/10 text-coral"
                  : "text-muted hover:bg-dark/5 hover:text-dark"
              )}
              title={section.label}
            >
              <span class="shrink-0 w-5 h-5" set:html={getIcon(section.icon)} />
              <span class="whitespace-nowrap sidebar-label hidden lg:block">{section.label}</span>
            </a>
          );
        })}
      </nav>

      <!-- Collapse toggle (visible on lg+) -->
      <div class="hidden lg:flex border-t border-dark/[0.08] p-2">
        <button
          id="sidebar-toggle"
          class="flex w-full items-center justify-center gap-2 rounded-lg px-3 py-2 text-sm text-muted hover:bg-dark/5 hover:text-dark transition-colors duration-150 cursor-pointer"
          title="Toggle sidebar"
        >
          <svg id="collapse-icon" class="h-5 w-5 shrink-0 transition-transform duration-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="11 17 6 12 11 7" />
            <polyline points="18 17 13 12 18 7" />
          </svg>
          <span class="whitespace-nowrap sidebar-label hidden lg:block">Collapse</span>
        </button>
      </div>
    </aside>

    <!-- Right side: top bar + content -->
    <div class="flex flex-1 flex-col overflow-hidden">
      <!-- Top bar -->
      <header class="flex h-14 shrink-0 items-center justify-between border-b border-dark/[0.08] bg-paper px-4 gap-4">
        <!-- Left: hamburger (mobile) + project name + breadcrumbs -->
        <div class="flex items-center gap-3 min-w-0">
          <!-- Hamburger menu (visible on < md) -->
          <button
            id="mobile-menu-toggle"
            class="md:hidden flex items-center justify-center rounded-lg p-1.5 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
            title="Open menu"
          >
            <span set:html={hamburgerIcon} />
          </button>

          <span class="text-sm font-semibold text-dark truncate">{projectName}</span>

          {breadcrumbs.length > 0 && (
            <>
              <span class="hidden sm:block text-muted/40">|</span>
              <Breadcrumbs items={breadcrumbs} class="hidden sm:flex" />
            </>
          )}
        </div>

        <!-- Right: search, theme toggle, user menu -->
        <div class="flex items-center gap-1">
          <!-- Search trigger (Cmd+K) -->
          <button
            id="search-trigger"
            class="flex items-center gap-2 rounded-lg border border-dark/[0.08] px-3 py-1.5 text-sm text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
            title="Search (Cmd+K)"
          >
            <span set:html={searchIcon} />
            <span class="hidden sm:inline">Search</span>
            <kbd class="hidden sm:inline-flex items-center gap-0.5 rounded border border-dark/[0.08] bg-subtle/50 px-1.5 py-0.5 text-[10px] font-medium text-muted">
              <span class="text-xs">&#8984;</span>K
            </kbd>
          </button>

          <!-- Theme toggle -->
          <button
            id="theme-toggle"
            class="flex items-center justify-center rounded-lg p-2 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
            title="Toggle theme"
          >
            <span id="theme-icon-light" set:html={sunIcon} />
            <span id="theme-icon-dark" class="hidden" set:html={moonIcon} />
          </button>

          <!-- Approvals notification bell -->
          <button
            id="approvals-bell"
            class="relative flex items-center justify-center rounded-lg p-2 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
            title="Pending approvals"
          >
            <span set:html={bellIcon} />
            <span
              id="approvals-badge"
              class="hidden absolute -top-0.5 -right-0.5 flex items-center justify-center min-w-[18px] h-[18px] rounded-full bg-coral text-white text-[10px] font-bold leading-none px-1"
            ></span>
          </button>

          <!-- User menu -->
          <button
            id="user-menu-trigger"
            class="flex items-center justify-center rounded-lg p-2 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
            title="User menu"
          >
            <span set:html={userIcon} />
          </button>
        </div>
      </header>

      <!-- Main content area -->
      <main class={cn("flex-1 overflow-y-auto pb-16 md:pb-0", className)}>
        <!-- Global budget warning banner -->
        <div id="global-budget-banner" class="hidden mx-4 mt-4 rounded-xl border px-5 py-3">
          <div class="flex items-center gap-3">
            <svg class="h-4 w-4 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            <p id="global-budget-text" class="text-xs font-medium flex-1"></p>
            <a href="/monitoring/costs" class="text-xs underline hover:no-underline flex-shrink-0">View costs</a>
          </div>
        </div>
        <slot />
      </main>
    </div>
  </div>

  <!-- Mobile bottom tab bar (visible on < md) -->
  <nav
    id="mobile-tab-bar"
    class="md:hidden fixed bottom-0 left-0 right-0 z-40 flex items-center justify-around border-t border-dark/[0.08] bg-paper px-2 py-1"
  >
    {mobileTabSections.map((section) => {
      const isActive = activeSection === section.id;
      return (
        <a
          href={section.href}
          class={cn(
            "flex flex-col items-center gap-0.5 rounded-lg px-3 py-1.5 text-[10px] font-medium transition-colors duration-150",
            isActive ? "text-coral" : "text-muted"
          )}
        >
          <span class="w-5 h-5" set:html={getIcon(section.icon)} />
          <span>{section.label}</span>
        </a>
      );
    })}
  </nav>

  <!-- Mobile slide-out menu overlay -->
  <div
    id="mobile-menu-overlay"
    class="fixed inset-0 z-50 hidden"
  >
    <!-- Backdrop -->
    <div
      id="mobile-menu-backdrop"
      class="absolute inset-0 bg-dark/40 backdrop-blur-sm"
    ></div>

    <!-- Slide-out panel -->
    <aside
      id="mobile-menu-panel"
      class="absolute top-0 left-0 bottom-0 w-72 bg-paper shadow-xl flex flex-col"
      style="transform: translateX(-100%); transition: transform 200ms ease-out;"
    >
      <!-- Header with close button -->
      <div class="flex h-14 items-center justify-between border-b border-dark/[0.08] px-4">
        <div class="flex items-center gap-3">
          <svg class="h-7 w-7 text-coral" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" />
            <path d="M2 12h20" />
          </svg>
          <span class="font-semibold text-dark text-sm">Orbiter</span>
        </div>
        <button
          id="mobile-menu-close"
          class="flex items-center justify-center rounded-lg p-1.5 text-muted hover:bg-dark/5 hover:text-dark transition-colors cursor-pointer"
          title="Close menu"
        >
          <span set:html={closeIcon} />
        </button>
      </div>

      <!-- Full navigation list -->
      <nav class="flex-1 overflow-y-auto py-3 px-3 space-y-1">
        {navSections.map((section) => {
          const isActive = activeSection === section.id;
          return (
            <a
              href={section.href}
              class={cn(
                "flex items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors duration-150",
                isActive
                  ? "bg-coral/10 text-coral"
                  : "text-muted hover:bg-dark/5 hover:text-dark"
              )}
            >
              <span class="shrink-0 w-5 h-5" set:html={getIcon(section.icon)} />
              <span>{section.label}</span>
            </a>
          );
        })}
      </nav>
    </aside>
  </div>

  <!-- Auth check: redirect unauthenticated users to /login -->
  <script is:inline>
    (function () {
      /* ---------- CSRF auto-include ---------- */
      var _csrfToken = null;
      var _csrfPromise = null;
      var _unsafeMethods = { POST: 1, PUT: 1, DELETE: 1, PATCH: 1 };
      var _origFetch = window.fetch;

      /** Fetch and cache the CSRF token for the current session. */
      window.getCsrfToken = function () {
        if (_csrfToken) return Promise.resolve(_csrfToken);
        if (_csrfPromise) return _csrfPromise;
        _csrfPromise = _origFetch("/api/auth/csrf", { credentials: "same-origin" })
          .then(function (r) {
            if (!r.ok) return "";
            return r.json().then(function (d) { _csrfToken = d.token; return _csrfToken; });
          })
          .catch(function () { return ""; })
          .finally(function () { _csrfPromise = null; });
        return _csrfPromise;
      };

      /** Clear cached CSRF token (call on logout). */
      window.clearCsrfToken = function () { _csrfToken = null; };

      /** Patched fetch: auto-includes X-CSRF-Token on unsafe same-origin requests. */
      window.fetch = function (input, init) {
        init = init || {};
        var method = (init.method || "GET").toUpperCase();
        if (!_unsafeMethods[method]) return _origFetch(input, init);

        // Only patch same-origin requests.
        var url = typeof input === "string" ? input : (input.url || "");
        if (url.indexOf("://") !== -1 && url.indexOf(location.origin) !== 0) {
          return _origFetch(input, init);
        }

        return window.getCsrfToken().then(function (token) {
          if (token) {
            init.headers = init.headers || {};
            if (typeof init.headers.set === "function") {
              init.headers.set("X-CSRF-Token", token);
            } else {
              init.headers["X-CSRF-Token"] = token;
            }
          }
          return _origFetch(input, init);
        });
      };

      /* ---------- Auth check ---------- */
      _origFetch("/api/auth/me", { credentials: "same-origin" })
        .then(function (res) {
          if (!res.ok) window.location.replace("/login");
          else window.getCsrfToken(); // Prefetch CSRF token.
        })
        .catch(function () {
          window.location.replace("/login");
        });
    })();
  </script>

  <!-- Sidebar collapse/expand script -->
  <script is:inline>
    (function () {
      var sidebar = document.getElementById("sidebar");
      var toggle = document.getElementById("sidebar-toggle");
      var collapseIcon = document.getElementById("collapse-icon");
      if (!sidebar || !toggle) return;

      var STORAGE_KEY = "sidebar-collapsed";
      var labels = sidebar.querySelectorAll(".sidebar-label");

      function collapse() {
        sidebar.classList.remove("lg:w-60");
        sidebar.classList.add("lg:w-16");
        labels.forEach(function (el) {
          el.classList.add("lg:hidden");
        });
        if (collapseIcon) collapseIcon.style.transform = "rotate(180deg)";
        sidebar.setAttribute("data-collapsed", "true");
        localStorage.setItem(STORAGE_KEY, "true");
      }

      function expand() {
        sidebar.classList.remove("lg:w-16");
        sidebar.classList.add("lg:w-60");
        labels.forEach(function (el) {
          el.classList.remove("lg:hidden");
        });
        if (collapseIcon) collapseIcon.style.transform = "";
        sidebar.setAttribute("data-collapsed", "false");
        localStorage.setItem(STORAGE_KEY, "false");
      }

      // Restore state from localStorage
      var stored = localStorage.getItem(STORAGE_KEY);
      if (stored === "true") {
        collapse();
      } else if (stored === "false") {
        expand();
      }

      toggle.addEventListener("click", function () {
        var isCollapsed = sidebar.getAttribute("data-collapsed") === "true";
        if (isCollapsed) {
          expand();
        } else {
          collapse();
        }
      });

      // Cmd+B / Ctrl+B keyboard shortcut
      document.addEventListener("keydown", function (e) {
        if ((e.metaKey || e.ctrlKey) && e.key === "b") {
          e.preventDefault();
          toggle.click();
        }
      });
    })();
  </script>

  <!-- Theme toggle script -->
  <script is:inline>
    (function () {
      var themeToggle = document.getElementById("theme-toggle");
      var lightIcon = document.getElementById("theme-icon-light");
      var darkIcon = document.getElementById("theme-icon-dark");
      if (!themeToggle || !lightIcon || !darkIcon) return;

      function updateIcons() {
        var current = document.documentElement.getAttribute("data-theme");
        if (current === "dark") {
          lightIcon.classList.add("hidden");
          darkIcon.classList.remove("hidden");
        } else {
          lightIcon.classList.remove("hidden");
          darkIcon.classList.add("hidden");
        }
      }

      updateIcons();

      themeToggle.addEventListener("click", function () {
        var current = document.documentElement.getAttribute("data-theme");
        var next = current === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
        updateIcons();
      });
    })();
  </script>

  <!-- Search shortcut (Cmd+K) -->
  <script is:inline>
    (function () {
      var searchTrigger = document.getElementById("search-trigger");
      if (!searchTrigger) return;

      document.addEventListener("keydown", function (e) {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
          e.preventDefault();
          searchTrigger.click();
        }
      });
    })();
  </script>

  <!-- Mobile menu script -->
  <script is:inline>
    (function () {
      var overlay = document.getElementById("mobile-menu-overlay");
      var panel = document.getElementById("mobile-menu-panel");
      var menuToggle = document.getElementById("mobile-menu-toggle");
      var menuClose = document.getElementById("mobile-menu-close");
      var backdrop = document.getElementById("mobile-menu-backdrop");
      if (!overlay || !panel || !menuToggle) return;

      function openMenu() {
        overlay.classList.remove("hidden");
        // Trigger reflow before animating
        void panel.offsetWidth;
        panel.style.transform = "translateX(0)";
      }

      function closeMenu() {
        panel.style.transform = "translateX(-100%)";
        setTimeout(function () {
          overlay.classList.add("hidden");
        }, 200);
      }

      menuToggle.addEventListener("click", openMenu);
      if (menuClose) menuClose.addEventListener("click", closeMenu);
      if (backdrop) backdrop.addEventListener("click", closeMenu);

      // Close on Escape
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && !overlay.classList.contains("hidden")) {
          closeMenu();
        }
      });
    })();
  </script>

  <!-- Global budget check -->
  <script is:inline>
    (function () {
      fetch("/api/costs/budget-check", { credentials: "same-origin" })
        .then(function (res) { return res.ok ? res.json() : null; })
        .then(function (data) {
          if (!data) return;
          var banner = document.getElementById("global-budget-banner");
          var text = document.getElementById("global-budget-text");
          if (!banner || !text) return;

          function fc(n) { return "$" + (n < 0.01 ? n.toFixed(4) : n.toFixed(2)); }

          if (data.status === "exceeded") {
            banner.className = "mx-4 mt-4 rounded-xl border border-coral/30 bg-coral/5 text-coral px-5 py-3";
            text.textContent = "Budget exceeded — spent " + fc(data.spent) + " of " + fc(data.budget_amount) + " (" + data.percent_used.toFixed(0) + "%)";
          } else if (data.status === "warning") {
            banner.className = "mx-4 mt-4 rounded-xl border border-amber-400/30 bg-amber-50 text-amber-800 px-5 py-3";
            text.textContent = "Approaching budget — spent " + fc(data.spent) + " of " + fc(data.budget_amount) + " (" + data.percent_used.toFixed(0) + "%)";
          }
        })
        .catch(function () {});
    })();
  </script>

  <!-- Approval gate modal -->
  <dialog id="approval-modal" class="backdrop:bg-dark/40 rounded-xl border border-dark/[0.08] bg-paper shadow-xl p-0 w-full max-w-md">
    <div class="p-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-amber-100 text-amber-600">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 11 14 15 10"/></svg>
        </div>
        <div>
          <h3 class="text-sm font-semibold text-dark">Approval Required</h3>
          <p id="approval-modal-node" class="text-xs text-muted"></p>
        </div>
      </div>

      <div id="approval-modal-context" class="mb-4 rounded-lg bg-subtle/50 border border-dark/[0.06] p-3 text-xs text-muted hidden">
      </div>

      <div class="mb-4">
        <label for="approval-comment" class="block text-[11px] font-semibold text-muted uppercase tracking-wide mb-1">Comment</label>
        <textarea id="approval-comment" rows="3" placeholder="Optional for approve, required for reject..." class="w-full rounded-lg border border-dark/[0.08] bg-paper px-3 py-2 text-sm text-dark placeholder-muted/60 outline-none focus:border-coral transition-colors resize-none"></textarea>
      </div>

      <div class="flex items-center gap-2 justify-end">
        <button id="approval-reject-btn" class="rounded-lg border border-dark/[0.08] px-4 py-2 text-sm font-medium text-muted hover:bg-dark/5 transition-colors cursor-pointer">Reject</button>
        <button id="approval-approve-btn" class="rounded-lg bg-zen-green px-4 py-2 text-sm font-semibold text-dark hover:opacity-90 transition-opacity cursor-pointer">Approve</button>
      </div>
    </div>
  </dialog>

  <!-- Approval notification badge + modal script -->
  <script is:inline>
    (function () {
      var bell = document.getElementById("approvals-bell");
      var badge = document.getElementById("approvals-badge");
      var modal = document.getElementById("approval-modal");
      var modalNode = document.getElementById("approval-modal-node");
      var modalContext = document.getElementById("approval-modal-context");
      var commentEl = document.getElementById("approval-comment");
      var approveBtn = document.getElementById("approval-approve-btn");
      var rejectBtn = document.getElementById("approval-reject-btn");
      if (!bell || !badge || !modal) return;

      var pendingApprovals = [];
      var currentApprovalIdx = 0;

      function updateBadge(count) {
        if (count > 0) {
          badge.textContent = count > 99 ? "99+" : String(count);
          badge.classList.remove("hidden");
          badge.classList.add("flex");
        } else {
          badge.classList.add("hidden");
          badge.classList.remove("flex");
        }
      }

      function fetchPending() {
        fetch("/api/approvals/pending?limit=20", { credentials: "same-origin" })
          .then(function (r) { return r.ok ? r.json() : []; })
          .then(function (data) {
            pendingApprovals = data || [];
            updateBadge(pendingApprovals.length);
          })
          .catch(function () {});
      }

      function showApproval(idx) {
        if (idx >= pendingApprovals.length) {
          modal.close();
          return;
        }
        currentApprovalIdx = idx;
        var a = pendingApprovals[idx];
        modalNode.textContent = "Node: " + a.node_id + " | Run: " + a.run_id.slice(0, 8) + "...";
        if (a.approval_message) {
          modalContext.textContent = a.approval_message;
          modalContext.classList.remove("hidden");
        } else {
          modalContext.classList.add("hidden");
        }
        commentEl.value = "";
        modal.showModal();
      }

      function respondToApproval(approved) {
        var a = pendingApprovals[currentApprovalIdx];
        if (!a) return;
        var comment = commentEl.value.trim();
        if (!approved && !comment) {
          commentEl.style.borderColor = "#F76F53";
          commentEl.setAttribute("placeholder", "Comment required for rejection");
          commentEl.focus();
          return;
        }
        var body = { approved: approved };
        if (comment) body.comment = comment;

        fetch("/api/approvals/" + a.id + "/respond", {
          method: "POST",
          credentials: "same-origin",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        })
          .then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw new Error(d.detail || "Failed"); });
            // Remove from list and show next or close
            pendingApprovals.splice(currentApprovalIdx, 1);
            updateBadge(pendingApprovals.length);
            if (pendingApprovals.length > 0) {
              showApproval(0);
            } else {
              modal.close();
            }
          })
          .catch(function (err) {
            alert("Error: " + err.message);
          });
      }

      bell.addEventListener("click", function () {
        if (pendingApprovals.length > 0) {
          showApproval(0);
        }
      });

      if (approveBtn) approveBtn.addEventListener("click", function () { respondToApproval(true); });
      if (rejectBtn) rejectBtn.addEventListener("click", function () { respondToApproval(false); });

      // Close on backdrop click
      modal.addEventListener("click", function (e) {
        if (e.target === modal) modal.close();
      });

      // Reset comment border on focus
      if (commentEl) commentEl.addEventListener("focus", function () {
        commentEl.style.borderColor = "";
      });

      // Initial fetch + poll every 30s
      fetchPending();
      setInterval(fetchPending, 30000);
    })();
  </script>
</BaseLayout>
